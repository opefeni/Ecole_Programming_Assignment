,url,repository_url,labels_url,comments_url,events_url,html_url,id,node_id,number,title,labels,state,locked,assignee,assignees,milestone,comments,created_at,updated_at,closed_at,author_association,active_lock_reason,body,timeline_url,performed_via_github_app,user.login,user.id,user.node_id,user.avatar_url,user.gravatar_id,user.url,user.html_url,user.followers_url,user.following_url,user.gists_url,user.starred_url,user.subscriptions_url,user.organizations_url,user.repos_url,user.events_url,user.received_events_url,user.type,user.site_admin,reactions.url,reactions.total_count,reactions.+1,reactions.-1,reactions.laugh,reactions.hooray,reactions.confused,reactions.heart,reactions.rocket,reactions.eyes,draft,pull_request.url,pull_request.html_url,pull_request.diff_url,pull_request.patch_url,pull_request.merged_at,assignee.login,assignee.id,assignee.node_id,assignee.avatar_url,assignee.gravatar_id,assignee.url,assignee.html_url,assignee.followers_url,assignee.following_url,assignee.gists_url,assignee.starred_url,assignee.subscriptions_url,assignee.organizations_url,assignee.repos_url,assignee.events_url,assignee.received_events_url,assignee.type,assignee.site_admin,milestone.url,milestone.html_url,milestone.labels_url,milestone.id,milestone.node_id,milestone.number,milestone.title,milestone.description,milestone.creator.login,milestone.creator.id,milestone.creator.node_id,milestone.creator.avatar_url,milestone.creator.gravatar_id,milestone.creator.url,milestone.creator.html_url,milestone.creator.followers_url,milestone.creator.following_url,milestone.creator.gists_url,milestone.creator.starred_url,milestone.creator.subscriptions_url,milestone.creator.organizations_url,milestone.creator.repos_url,milestone.creator.events_url,milestone.creator.received_events_url,milestone.creator.type,milestone.creator.site_admin,milestone.open_issues,milestone.closed_issues,milestone.state,milestone.created_at,milestone.updated_at,milestone.due_on,milestone.closed_at
111,https://api.github.com/repos/rails/rails/issues/44652,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44652/labels{/name},https://api.github.com/repos/rails/rails/issues/44652/comments,https://api.github.com/repos/rails/rails/issues/44652/events,https://github.com/rails/rails/issues/44652,1164729661,I_kwDNIULORWxdPQ,44652,ActionCable: Repeated subscription attempts,"[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,4,2022-03-10T04:12:53Z,2022-04-14T05:22:32Z,,CONTRIBUTOR,,"### Steps to reproduce

1. Create an actioncable subscription.
2. Await subscription confirmation.
3. Create another subscription with the same identifier.
4. Observe websocket showing subscription attempts every second.

I tried creating a small reproduction script, but involving views and action cable got too complicated. Instead, here's an app which replicates it:

https://github.com/sj26/action_cable_test

It creates two subscriptions with the same identifier, with a timeout to be sure that the first subscription has already been confirmed:

```erb
<div id=""count""></div>
<%= javascript_tag do %>
  window.App.consumer.subscriptions.create({channel: ""TestChannel""}, {
    received({ count }) {
      document.getElementById(""count"").innerText = count;
    }
  });
<% end %>

<div id=""contents""></div>
<%= javascript_tag do %>
  setTimeout(function() {
    window.App.consumer.subscriptions.create({channel: ""TestChannel""}, {
      received({ contents }) {
        document.getElementById(""contents"").innerText = contents;
      }
    });
  }, 1000)
<% end %>
```

Then a stream of subscription messages can be seen in the websocket traffic:

<img width=""1193"" alt=""image"" src=""https://user-images.githubusercontent.com/14028/157585817-14b2546d-0601-4faf-9334-e2615127be77.png"">

because the guarantor considers the second subscription pending:

<img width=""1440"" alt=""image"" src=""https://user-images.githubusercontent.com/14028/157586067-5ce7d08d-263a-4ea7-bfe4-9ab581f589b1.png"">

because actioncable short circuits existing subscriptions, and so doesn't submit multiple confirmations:

https://github.com/rails/rails/blob/v7.0.2/actioncable/lib/action_cable/connection/subscriptions.rb#L32

### Use case

We have a react frontend, and we want to subscribe to channels in each of the leaf components which require dynamic updates directly. Sometimes this means multiple components will be interested in the same updates, and subscribe to the same identifiers. Trying to deduplicate these subscriptions somehow requires a lot more state management which seems more fragile and uneccessary. Previous versions of actioncable before the guarantor seem to work great for this use case, and the actioncable implemenation seems to consider subscription duplication in all operations. It's the addition of the subscription guarantor in #41581 to fix #38668 which seems to have created this issue. I think it would continue to work great with some gentle adjustment.

### Expected behavior

Subscribing to the same channel identifier multiple times should not constantly send subscription messages.

### Actual behavior

A continuous stream of subscription messages are sent from the browser and arrive and are squashed at the server without any confirmation message returning. This taxes both the browser client and the action cable server unnecessarily.

### System configuration
**Rails version**: 7.0.2

**Ruby version**: 3.1.0

### Potential solution

The simplest solution seems to be to follow the pattern established in the rest of Subscriptions and avoid re-subscribing subscriptions which already exist:

https://github.com/rails/rails/pull/44653

It's also a little confusing. The ""subscription"" in the javascript environment does not necessarily have a 1:1 relationship with the ""subscription"" on the server. This is a good thing! But it'd be nice if they had different names.",https://api.github.com/repos/rails/rails/issues/44652/timeline,,sj26,14028,MDQ6VXNlcjE0MDI4,https://avatars.githubusercontent.com/u/14028?v=4,,https://api.github.com/users/sj26,https://github.com/sj26,https://api.github.com/users/sj26/followers,https://api.github.com/users/sj26/following{/other_user},https://api.github.com/users/sj26/gists{/gist_id},https://api.github.com/users/sj26/starred{/owner}{/repo},https://api.github.com/users/sj26/subscriptions,https://api.github.com/users/sj26/orgs,https://api.github.com/users/sj26/repos,https://api.github.com/users/sj26/events{/privacy},https://api.github.com/users/sj26/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44652/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
112,https://api.github.com/repos/rails/rails/issues/44638,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44638/labels{/name},https://api.github.com/repos/rails/rails/issues/44638/comments,https://api.github.com/repos/rails/rails/issues/44638/events,https://github.com/rails/rails/pull/44638,1162783229,PR_kwDNIULONBy8zA,44638,Adds `#interceptors` method to ActionMailer::Base,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,7,2022-03-08T15:18:25Z,2022-04-04T23:38:55Z,,CONTRIBUTOR,,"### Summary

Added `interceptors` as a class attribute in ActionMailer::Base, so that `ActionMailer::Base.interceptors` returns the registered interceptors.

Also changed the test cases in railties where `::Mail.class_variable_get(:@@delivery_interceptors)` was used to verify the registered interceptors. Instead it can be done like `ActionMailer::Base.interceptors`, just like how preview interceptors are fetched like -> `ActionMailer::Base.preview_interceptors`
",https://api.github.com/repos/rails/rails/issues/44638/timeline,,ghousemohamed,56545288,MDQ6VXNlcjU2NTQ1Mjg4,https://avatars.githubusercontent.com/u/56545288?v=4,,https://api.github.com/users/ghousemohamed,https://github.com/ghousemohamed,https://api.github.com/users/ghousemohamed/followers,https://api.github.com/users/ghousemohamed/following{/other_user},https://api.github.com/users/ghousemohamed/gists{/gist_id},https://api.github.com/users/ghousemohamed/starred{/owner}{/repo},https://api.github.com/users/ghousemohamed/subscriptions,https://api.github.com/users/ghousemohamed/orgs,https://api.github.com/users/ghousemohamed/repos,https://api.github.com/users/ghousemohamed/events{/privacy},https://api.github.com/users/ghousemohamed/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44638/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44638,https://github.com/rails/rails/pull/44638,https://github.com/rails/rails/pull/44638.diff,https://github.com/rails/rails/pull/44638.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
113,https://api.github.com/repos/rails/rails/issues/44629,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44629/labels{/name},https://api.github.com/repos/rails/rails/issues/44629/comments,https://api.github.com/repos/rails/rails/issues/44629/events,https://github.com/rails/rails/pull/44629,1161580864,PR_kwDNIULONAzegw,44629,Refer to number_field_tag in range_field documentation,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-03-07T15:37:34Z,2022-03-07T15:39:57Z,,CONTRIBUTOR,,"### Summary

When a user is looking for the options of range_field, they are referred to range_field_tag, which then refers them to number_field_tag. Referring the user directly to number_field_tag is better.

### Other Information

Before:
![before](https://user-images.githubusercontent.com/1102934/157065579-b4ed7ce5-7fc0-40a2-ba8e-63ff0f2f290f.png)

After:
![after](https://user-images.githubusercontent.com/1102934/157065576-7b5b8db5-278d-44cd-9485-7e8c7fbd1493.png)",https://api.github.com/repos/rails/rails/issues/44629/timeline,,dmarcoux,1102934,MDQ6VXNlcjExMDI5MzQ=,https://avatars.githubusercontent.com/u/1102934?v=4,,https://api.github.com/users/dmarcoux,https://github.com/dmarcoux,https://api.github.com/users/dmarcoux/followers,https://api.github.com/users/dmarcoux/following{/other_user},https://api.github.com/users/dmarcoux/gists{/gist_id},https://api.github.com/users/dmarcoux/starred{/owner}{/repo},https://api.github.com/users/dmarcoux/subscriptions,https://api.github.com/users/dmarcoux/orgs,https://api.github.com/users/dmarcoux/repos,https://api.github.com/users/dmarcoux/events{/privacy},https://api.github.com/users/dmarcoux/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44629/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44629,https://github.com/rails/rails/pull/44629,https://github.com/rails/rails/pull/44629.diff,https://github.com/rails/rails/pull/44629.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
114,https://api.github.com/repos/rails/rails/issues/44626,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44626/labels{/name},https://api.github.com/repos/rails/rails/issues/44626/comments,https://api.github.com/repos/rails/rails/issues/44626/events,https://github.com/rails/rails/pull/44626,1160790017,PR_kwDNIULONALPRg,44626,Restart Action Cable when Redis disconnects,"[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,1,2022-03-07T01:23:51Z,2022-03-22T09:11:33Z,,NONE,,"### Summary

Prevents the web service process from aborting when there is a Redis
connection error. Instead, we restart Action Cable so that all clients
are disconnected and we would reconnect to Redis when the next Action
Cable request comes in.

Closes https://github.com/rails/rails/issues/27659

From https://gitlab.com/gitlab-org/gitlab/-/merge_requests/80822

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44626/timeline,,engwan,300588,MDQ6VXNlcjMwMDU4OA==,https://avatars.githubusercontent.com/u/300588?v=4,,https://api.github.com/users/engwan,https://github.com/engwan,https://api.github.com/users/engwan/followers,https://api.github.com/users/engwan/following{/other_user},https://api.github.com/users/engwan/gists{/gist_id},https://api.github.com/users/engwan/starred{/owner}{/repo},https://api.github.com/users/engwan/subscriptions,https://api.github.com/users/engwan/orgs,https://api.github.com/users/engwan/repos,https://api.github.com/users/engwan/events{/privacy},https://api.github.com/users/engwan/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44626/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44626,https://github.com/rails/rails/pull/44626,https://github.com/rails/rails/pull/44626.diff,https://github.com/rails/rails/pull/44626.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
115,https://api.github.com/repos/rails/rails/issues/44625,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44625/labels{/name},https://api.github.com/repos/rails/rails/issues/44625/comments,https://api.github.com/repos/rails/rails/issues/44625/events,https://github.com/rails/rails/pull/44625,1160692008,PR_kwDNIULONAGa0g,44625,Avoid double type cast when serializing attributes,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-03-06T19:15:50Z,2022-03-15T20:29:23Z,,MEMBER,,"Most model attribute types try to cast a given value before serializing it.  This allows uncast values to be passed to finder methods, and still be serialized appropriately.  However, when persisting a model, this cast is unnecessary because the value will have already been cast by [`ActiveModel::Attribute#value`](https://github.com/rails/rails/blob/645239817d15c36ff008ccb5b6c8887e3b2c8f4b/activemodel/lib/active_model/attribute.rb#L41-L45).

To eliminate the overhead of a 2nd cast, this commit introduces `ActiveModel::Type::SerializeCastValue`.  Types can include this module, and their `serialize_cast_value` method will be called instead of `serialize` when serializing an already-cast value.

To preserve existing behavior of any user types that subclass Rails' types, `serialize_after_cast` will only be called if the type itself (not a superclass) includes `ActiveModel::Type::SerializeCastValue`.  This also applies to type decorators implemented via `DelegateClass`.

<details>
  <summary><strong>Benchmark script</strong></summary>

  ```ruby
  require ""active_model""
  require ""benchmark/ips""

  class ActiveModel::Attribute
    alias baseline_value_for_database value_for_database
  end

  VALUES = {
    my_big_integer: ""123456"",
    my_boolean: ""true"",
    my_date: ""1999-12-31"",
    my_datetime: ""1999-12-31 12:34:56 UTC"",
    my_decimal: ""123.456"",
    my_float: ""123.456"",
    my_immutable_string: ""abcdef"",
    my_integer: ""123456"",
    my_string: ""abcdef"",
    my_time: ""1999-12-31T12:34:56.789-10:00"",
  }

  TYPES = VALUES.to_h { |name, value| [name, name.to_s.delete_prefix(""my_"").to_sym] }

  class MyModel
    include ActiveModel::API
    include ActiveModel::Attributes

    TYPES.each do |name, type|
      attribute name, type
    end
  end

  TYPES.each do |name, type|
    $attribute_set ||= MyModel.new(VALUES).instance_variable_get(:@attributes)
    attribute = $attribute_set[name.to_s]

    puts ""="" * 72
    Benchmark.ips do |x|
      x.report(""#{type} before"") { attribute.baseline_value_for_database }
      x.report(""#{type} after"") { attribute.value_for_database }
      x.compare!
    end
  end
  ```
</details>

**Benchmark results:**

```
========================================================================
Warming up --------------------------------------
  big_integer before    73.579k i/100ms
   big_integer after   231.173k i/100ms
Calculating -------------------------------------
  big_integer before    743.753k (± 0.3%) i/s -      3.753M in   5.045448s
   big_integer after      2.303M (± 0.3%) i/s -     11.559M in   5.019952s

Comparison:
   big_integer after:  2302567.0 i/s
  big_integer before:   743752.7 i/s - 3.10x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
      boolean before   167.953k i/100ms
       boolean after   241.789k i/100ms
Calculating -------------------------------------
      boolean before      1.667M (± 0.2%) i/s -      8.398M in   5.036769s
       boolean after      2.423M (± 0.1%) i/s -     12.331M in   5.089230s

Comparison:
       boolean after:  2423010.7 i/s
      boolean before:  1667273.6 i/s - 1.45x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
         date before    91.338k i/100ms
          date after   235.154k i/100ms
Calculating -------------------------------------
         date before    910.185k (± 0.1%) i/s -      4.567M in   5.017563s
          date after      2.322M (± 0.2%) i/s -     11.758M in   5.064586s

Comparison:
          date after:  2321560.5 i/s
         date before:   910184.8 i/s - 2.55x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
     datetime before    56.801k i/100ms
      datetime after    73.883k i/100ms
Calculating -------------------------------------
     datetime before    573.367k (± 0.5%) i/s -      2.897M in   5.052502s
      datetime after    735.782k (± 0.5%) i/s -      3.694M in   5.020825s

Comparison:
      datetime after:   735782.0 i/s
     datetime before:   573366.9 i/s - 1.28x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
      decimal before    31.121k i/100ms
       decimal after   237.325k i/100ms
Calculating -------------------------------------
      decimal before    309.814k (± 0.6%) i/s -      1.556M in   5.022698s
       decimal after      2.416M (± 0.3%) i/s -     12.104M in   5.009995s

Comparison:
       decimal after:  2415906.8 i/s
      decimal before:   309813.9 i/s - 7.80x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
        float before   131.003k i/100ms
         float after   241.972k i/100ms
Calculating -------------------------------------
        float before      1.295M (± 0.4%) i/s -      6.550M in   5.058110s
         float after      2.417M (± 0.2%) i/s -     12.099M in   5.005623s

Comparison:
         float after:  2417015.4 i/s
        float before:  1295005.1 i/s - 1.87x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
immutable_string before
                        68.900k i/100ms
immutable_string after
                       241.287k i/100ms
Calculating -------------------------------------
immutable_string before
                        678.826k (± 0.8%) i/s -      3.445M in   5.075258s
immutable_string after
                          2.392M (± 0.2%) i/s -     12.064M in   5.043683s

Comparison:
immutable_string after:  2391978.0 i/s
immutable_string before:   678826.3 i/s - 3.52x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
      integer before    76.608k i/100ms
       integer after   109.599k i/100ms
Calculating -------------------------------------
      integer before    759.752k (± 0.7%) i/s -      3.830M in   5.041861s
       integer after      1.089M (± 0.3%) i/s -      5.480M in   5.032105s

Comparison:
       integer after:  1089007.1 i/s
      integer before:   759751.8 i/s - 1.43x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
       string before    66.985k i/100ms
        string after   239.413k i/100ms
Calculating -------------------------------------
       string before    678.021k (± 0.5%) i/s -      3.416M in   5.038674s
        string after      2.374M (± 0.2%) i/s -     11.971M in   5.043439s

Comparison:
        string after:  2373515.8 i/s
       string before:   678021.1 i/s - 3.50x  (± 0.00) slower

========================================================================
Warming up --------------------------------------
         time before    55.543k i/100ms
          time after    71.107k i/100ms
Calculating -------------------------------------
         time before    549.988k (± 0.4%) i/s -      2.777M in   5.049560s
          time after    711.526k (± 0.3%) i/s -      3.626M in   5.096784s

Comparison:
          time after:   711525.5 i/s
         time before:   549987.5 i/s - 1.29x  (± 0.00) slower
```

---

For context, this originally came up in https://github.com/rails/rails/pull/43945#issuecomment-999926978.

",https://api.github.com/repos/rails/rails/issues/44625/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44625/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44625,https://github.com/rails/rails/pull/44625,https://github.com/rails/rails/pull/44625.diff,https://github.com/rails/rails/pull/44625.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
116,https://api.github.com/repos/rails/rails/issues/44624,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44624/labels{/name},https://api.github.com/repos/rails/rails/issues/44624/comments,https://api.github.com/repos/rails/rails/issues/44624/events,https://github.com/rails/rails/issues/44624,1160614719,I_kwDNIULORS2TPw,44624,"System tests screenshots - include path in test result message, backtrace or separate metadata",[],open,False,,[],,2,2022-03-06T13:44:40Z,2022-03-08T06:12:02Z,,NONE,,"While parsing test results from system tests, it would be very useful to include the paths to taken screenshots in the metadata.

In the [`ScreenshotHelper`](https://github.com/rails/rails/blob/main/actionpack/lib/action_dispatch/system_testing/test_helpers/screenshot_helper.rb#L37) the path will be output with `puts`, but then it can only be accessed in logs and not in for example a [`Minitest::Reporter`](https://github.com/seattlerb/minitest/blob/master/lib/minitest.rb#L602).

While looking through [`ActiveSupport::TestCase`](https://github.com/rails/rails/blob/main/activesupport/lib/active_support/test_case.rb)  and [`Minitest::Test`](https://github.com/seattlerb/minitest/blob/master/lib/minitest/test.rb#L10) I could not find a good place to add more metadata.

It would be useful if the failure screenshot path (or paths to all screenshots in the test case):

- are added to the `ActiveSupport::TestCase` failure message.
- are added to some custom metadata of the test case, that could be accessed in e.g. a reporter.

## Rspec

In Rspec it adds screenshot output as [`extra_failure_lines`](https://github.com/rspec/rspec-rails/blob/3e7d8d0391cbd6355eca7d6259fd5547e07d8277/spec/rspec/rails/example/system_example_group_spec.rb#L91) which is included in the spec result message of a failure.

------------

I would love to make a try at a PR, but I would need some guidance if it is possible or not.",https://api.github.com/repos/rails/rails/issues/44624/timeline,,davidwessman,6763624,MDQ6VXNlcjY3NjM2MjQ=,https://avatars.githubusercontent.com/u/6763624?v=4,,https://api.github.com/users/davidwessman,https://github.com/davidwessman,https://api.github.com/users/davidwessman/followers,https://api.github.com/users/davidwessman/following{/other_user},https://api.github.com/users/davidwessman/gists{/gist_id},https://api.github.com/users/davidwessman/starred{/owner}{/repo},https://api.github.com/users/davidwessman/subscriptions,https://api.github.com/users/davidwessman/orgs,https://api.github.com/users/davidwessman/repos,https://api.github.com/users/davidwessman/events{/privacy},https://api.github.com/users/davidwessman/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44624/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
117,https://api.github.com/repos/rails/rails/issues/44616,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44616/labels{/name},https://api.github.com/repos/rails/rails/issues/44616/comments,https://api.github.com/repos/rails/rails/issues/44616/events,https://github.com/rails/rails/pull/44616,1159903813,PR_kwDNIULOM_fsnQ,44616,Always preload if using proc with multifetch cache,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-03-04T17:55:29Z,2022-03-08T01:12:46Z,,MEMBER,,"### Summary

https://github.com/rails/rails/pull/31250 optimised rendering a collection with `cached: true`, but also with `cached: proc {}`. The problem is the proc may reference associations that should be preloaded to avoid n+1s in generating the cache key.

For example:

```ruby
@posts = Post.preload(:author)

@view.render partial: ""test/partial"", collection: @post, cached: proc { |post| [post, post.author] }
```

This will n+1 on `post.author`.

To fix this, this PR will always preload the collection if there's a proc given for `cached`. `cached: true` will still not preload unless it renders, as it did in https://github.com/rails/rails/pull/31250.

### Other Information

There's an issue with the tests that I need to work out; currently they are order dependent. Seems like `Topic.preload(:replies)` is persisting between tests and I'm not sure why. (I don't *think* it's a bug in the implementation - the records should never preload across tests.)",https://api.github.com/repos/rails/rails/issues/44616/timeline,,ghiculescu,509837,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44616/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44616,https://github.com/rails/rails/pull/44616,https://github.com/rails/rails/pull/44616.diff,https://github.com/rails/rails/pull/44616.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
118,https://api.github.com/repos/rails/rails/issues/44614,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44614/labels{/name},https://api.github.com/repos/rails/rails/issues/44614/comments,https://api.github.com/repos/rails/rails/issues/44614/events,https://github.com/rails/rails/pull/44614,1159838401,PR_kwDNIULOM_cXtw,44614,Add :renderable to the list of rendering keys supported by ActionView::Renderer#render,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-03-04T16:42:49Z,2022-03-16T23:44:01Z,,NONE,,"### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

Add `:renderable` to the list of rendering keys supported by `ActionView::Renderer#render` that are listed on `ArgumentError`. Also, alphabetize the list of keys.

### Other Information

N/A

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44614/timeline,,voraciousdev,922012,MDQ6VXNlcjkyMjAxMg==,https://avatars.githubusercontent.com/u/922012?v=4,,https://api.github.com/users/voraciousdev,https://github.com/voraciousdev,https://api.github.com/users/voraciousdev/followers,https://api.github.com/users/voraciousdev/following{/other_user},https://api.github.com/users/voraciousdev/gists{/gist_id},https://api.github.com/users/voraciousdev/starred{/owner}{/repo},https://api.github.com/users/voraciousdev/subscriptions,https://api.github.com/users/voraciousdev/orgs,https://api.github.com/users/voraciousdev/repos,https://api.github.com/users/voraciousdev/events{/privacy},https://api.github.com/users/voraciousdev/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44614/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44614,https://github.com/rails/rails/pull/44614,https://github.com/rails/rails/pull/44614.diff,https://github.com/rails/rails/pull/44614.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
119,https://api.github.com/repos/rails/rails/issues/44605,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44605/labels{/name},https://api.github.com/repos/rails/rails/issues/44605/comments,https://api.github.com/repos/rails/rails/issues/44605/events,https://github.com/rails/rails/pull/44605,1158163113,PR_kwDNIULOM-Djww,44605,Add Module#eager_load! to trigger the loading of autoloaded constants,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2022-03-03T09:20:49Z,2022-03-03T09:20:53Z,,CONTRIBUTOR,,"It's not uncommon to have gems that are largely autoloaded, which can be a problem for Rails application in production.

For instance: https://github.com/weppos/whois/pull/644

If the autoloaded constants are not referenced as part of boot the first request to actually use it will pay the loading cost. This is what tend to cause ""shark fin"" looking latency graphs around deploy.

Additionally to the cost of loading the code, defining constants cause the Ruby global constant cache to be busted, causing most inline caches and JITed code to be invalidated.

It also prevent this memory from being shared through the parent process in forking setups.

`Module#eager_load!` would make it easy to eagerly load some third party namespaces:

```ruby
config.eager_load_namespaces << Whois::Server::Adapters
```
",https://api.github.com/repos/rails/rails/issues/44605/timeline,,casperisfine,19192189,MDQ6VXNlcjE5MTkyMTg5,https://avatars.githubusercontent.com/u/19192189?v=4,,https://api.github.com/users/casperisfine,https://github.com/casperisfine,https://api.github.com/users/casperisfine/followers,https://api.github.com/users/casperisfine/following{/other_user},https://api.github.com/users/casperisfine/gists{/gist_id},https://api.github.com/users/casperisfine/starred{/owner}{/repo},https://api.github.com/users/casperisfine/subscriptions,https://api.github.com/users/casperisfine/orgs,https://api.github.com/users/casperisfine/repos,https://api.github.com/users/casperisfine/events{/privacy},https://api.github.com/users/casperisfine/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44605/reactions,1,0,0,0,0,0,0,0,1,False,https://api.github.com/repos/rails/rails/pulls/44605,https://github.com/rails/rails/pull/44605,https://github.com/rails/rails/pull/44605.diff,https://github.com/rails/rails/pull/44605.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
120,https://api.github.com/repos/rails/rails/issues/44601,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44601/labels{/name},https://api.github.com/repos/rails/rails/issues/44601/comments,https://api.github.com/repos/rails/rails/issues/44601/events,https://github.com/rails/rails/pull/44601,1157622253,PR_kwDNIULOM9ngQA,44601,Make `timestamptz` a time zone aware type for Postgres,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2022-03-02T19:53:12Z,2022-03-04T17:58:43Z,,MEMBER,,"https://github.com/rails/rails/pull/41395 added support for the `timestamptz` type on the Postgres adapter.

As we found [here](https://github.com/rails/rails/pull/41084#issuecomment-1056430921) this causes issues because in some scenarios the new type is not considered a time zone aware attribute, meaning values of this type in the DB are presented as a `Time`, not an `ActiveSupport::TimeWithZone`.

This PR fixes that by ensuring that `timestamptz` is always a time zone aware type, for Postgres users. A workaround is to do this in an initializer:

```ruby
ActiveRecord::Base.time_zone_aware_types += [:timestamptz]
```

I'm not sure if this is the right way to fix it so putting up a PR for review. I also need to update the changelog if this approach is sound, and I think this should backport to `7-0-stable`.",https://api.github.com/repos/rails/rails/issues/44601/timeline,,ghiculescu,509837,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44601/reactions,3,0,0,0,0,0,2,1,0,False,https://api.github.com/repos/rails/rails/pulls/44601,https://github.com/rails/rails/pull/44601,https://github.com/rails/rails/pull/44601.diff,https://github.com/rails/rails/pull/44601.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
121,https://api.github.com/repos/rails/rails/issues/44599,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44599/labels{/name},https://api.github.com/repos/rails/rails/issues/44599/comments,https://api.github.com/repos/rails/rails/issues/44599/events,https://github.com/rails/rails/pull/44599,1157444988,PR_kwDNIULOM9eI0A,44599,Document behaviour when `:touch` is used with `:counter_cache`,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-03-02T16:50:09Z,2022-03-02T16:50:12Z,,NONE,,Related to this issue: #44479 ,https://api.github.com/repos/rails/rails/issues/44599/timeline,,mansakondo,47113995,MDQ6VXNlcjQ3MTEzOTk1,https://avatars.githubusercontent.com/u/47113995?v=4,,https://api.github.com/users/mansakondo,https://github.com/mansakondo,https://api.github.com/users/mansakondo/followers,https://api.github.com/users/mansakondo/following{/other_user},https://api.github.com/users/mansakondo/gists{/gist_id},https://api.github.com/users/mansakondo/starred{/owner}{/repo},https://api.github.com/users/mansakondo/subscriptions,https://api.github.com/users/mansakondo/orgs,https://api.github.com/users/mansakondo/repos,https://api.github.com/users/mansakondo/events{/privacy},https://api.github.com/users/mansakondo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44599/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44599,https://github.com/rails/rails/pull/44599,https://github.com/rails/rails/pull/44599.diff,https://github.com/rails/rails/pull/44599.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
122,https://api.github.com/repos/rails/rails/issues/44595,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44595/labels{/name},https://api.github.com/repos/rails/rails/issues/44595/comments,https://api.github.com/repos/rails/rails/issues/44595/events,https://github.com/rails/rails/pull/44595,1157057672,PR_kwDNIULOM9JcQA,44595,fix hash from_xml missing tag error,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,3,2022-03-02T11:23:02Z,2022-03-18T03:47:59Z,,NONE,,"### Summary

Sometimes the XML has tag and content, there will missing tag when using Hash.from_xml
the XML like this:
```ruby
xml = <<-XML
      <blog name=""bacon is the best"">
        ""Have a nice day""
      </blog>
    XML

hash = Hash.from_xml(xml)
puts hash
```

the result is below:
before:
```
{""blog""=>""\n        \""Have a nice day\""\n      ""}
```
after:
```
{""blog""=>{""name""=>""bacon is the best"", ""__content__""=>""\n        \""Have a nice day\""\n      ""}}
```

",https://api.github.com/repos/rails/rails/issues/44595/timeline,,hxx,4384971,MDQ6VXNlcjQzODQ5NzE=,https://avatars.githubusercontent.com/u/4384971?v=4,,https://api.github.com/users/hxx,https://github.com/hxx,https://api.github.com/users/hxx/followers,https://api.github.com/users/hxx/following{/other_user},https://api.github.com/users/hxx/gists{/gist_id},https://api.github.com/users/hxx/starred{/owner}{/repo},https://api.github.com/users/hxx/subscriptions,https://api.github.com/users/hxx/orgs,https://api.github.com/users/hxx/repos,https://api.github.com/users/hxx/events{/privacy},https://api.github.com/users/hxx/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44595/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44595,https://github.com/rails/rails/pull/44595,https://github.com/rails/rails/pull/44595.diff,https://github.com/rails/rails/pull/44595.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
123,https://api.github.com/repos/rails/rails/issues/44594,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44594/labels{/name},https://api.github.com/repos/rails/rails/issues/44594/comments,https://api.github.com/repos/rails/rails/issues/44594/events,https://github.com/rails/rails/issues/44594,1156841158,I_kwDNIULORPP-xg,44594,STI foreign key auto detection regression,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2022-03-02T09:03:58Z,2022-04-14T19:08:03Z,,CONTRIBUTOR,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""
  gem ""sqlite3"", ""~> 1.3.0""
  # Activate the gem you are reporting the issue against.
  gem ""rails"", ""5.1.6""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# Ensure backward compatibility with Minitest 4
Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
end

class ChildPost < Post
  has_one :foo, class_name: 'Comment', inverse_of: :bar, foreign_key: :post_id
end

class Comment < ActiveRecord::Base
  belongs_to :bar, class_name: 'ChildPost', inverse_of: :foo
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = ChildPost.create!

    post.build_foo
  end
end

```

### Expected behavior
<!-- Tell us what should happen -->
exit without error in Rails 5.1.6, 5.2.0 and 6.1.0

### Actual behavior
<!-- Tell us what happens instead -->
exit without error in Rails 5.1.6
exit with following error in Rails 5.2.0 and 6.1.0
```
Error:
BugTest#test_association_stuff:
ActiveModel::MissingAttributeError: can't write unknown attribute `bar_id`
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activemodel-5.2.0/lib/active_model/attribute.rb:207:in `with_value_from_database'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activemodel-5.2.0/lib/active_model/attribute_set.rb:57:in `write_from_user'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/attribute_methods/write.rb:51:in `_write_attribute'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/attribute_methods/write.rb:45:in `write_attribute'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/attribute_methods.rb:410:in `[]='
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/belongs_to_association.rb:92:in `replace_keys'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/belongs_to_association.rb:33:in `target='
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:103:in `set_inverse_instance'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:178:in `initialize_attributes'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:271:in `block in build_record'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/core.rb:316:in `initialize'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/inheritance.rb:66:in `new'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/inheritance.rb:66:in `new'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/reflection.rb:154:in `build_association'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/association.rb:270:in `build_record'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/singular_association.rb:21:in `build'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/activerecord-5.2.0/lib/active_record/associations/builder/singular_association.rb:29:in `build_foo'
    active_record_gem.rb:50:in `test_association_stuff'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:98:in `block (3 levels) in run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:195:in `capture_exceptions'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:95:in `block (2 levels) in run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:281:in `time_it'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:94:in `block in run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:376:in `on_signal'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:221:in `with_info_handler'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest/test.rb:93:in `run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:1042:in `run_one_method'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:350:in `run_one_method'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:337:in `block (2 levels) in run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:336:in `each'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:336:in `block in run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:376:in `on_signal'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:363:in `with_info_handler'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:335:in `run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:169:in `block in __run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:169:in `map'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:169:in `__run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:146:in `run'
    /Users/xxxx/.rbenv/versions/2.7.3/lib/ruby/gems/2.7.0/gems/minitest-5.15.0/lib/minitest.rb:73:in `block in autorun'
```

### System configuration
**Rails version**:

**Ruby version**: 2.7.3
",https://api.github.com/repos/rails/rails/issues/44594/timeline,,yskkin,5965113,MDQ6VXNlcjU5NjUxMTM=,https://avatars.githubusercontent.com/u/5965113?v=4,,https://api.github.com/users/yskkin,https://github.com/yskkin,https://api.github.com/users/yskkin/followers,https://api.github.com/users/yskkin/following{/other_user},https://api.github.com/users/yskkin/gists{/gist_id},https://api.github.com/users/yskkin/starred{/owner}{/repo},https://api.github.com/users/yskkin/subscriptions,https://api.github.com/users/yskkin/orgs,https://api.github.com/users/yskkin/repos,https://api.github.com/users/yskkin/events{/privacy},https://api.github.com/users/yskkin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44594/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
124,https://api.github.com/repos/rails/rails/issues/44591,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44591/labels{/name},https://api.github.com/repos/rails/rails/issues/44591/comments,https://api.github.com/repos/rails/rails/issues/44591/events,https://github.com/rails/rails/pull/44591,1155775285,PR_kwDNIULOM8BaCw,44591,Simplify adapter construction; defer connect until first use,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-03-01T20:18:32Z,2022-04-05T16:48:27Z,,MEMBER,,"Building on from #44576, we no longer need to connect to the database in order to construct an adapter instance: we instead supply just the config hash, and it will connect on demand, in the same way it already knows to handle later reconnections.

This cleans up a weird API overlap, where we previously needed to know how to connect in two different places.",https://api.github.com/repos/rails/rails/issues/44591/timeline,,matthewd,1034,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,https://api.github.com/repos/rails/rails/issues/44591/reactions,0,0,0,0,0,0,0,0,0,True,https://api.github.com/repos/rails/rails/pulls/44591,https://github.com/rails/rails/pull/44591,https://github.com/rails/rails/pull/44591.diff,https://github.com/rails/rails/pull/44591.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
125,https://api.github.com/repos/rails/rails/issues/44590,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44590/labels{/name},https://api.github.com/repos/rails/rails/issues/44590/comments,https://api.github.com/repos/rails/rails/issues/44590/events,https://github.com/rails/rails/issues/44590,1155720378,I_kwDNIULOROLkug,44590,Configure ActiveStorage with AzureStorage given SAS token,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,3,2022-03-01T19:22:50Z,2022-03-22T23:51:25Z,,NONE,,"Based on ActiveStorage document, we're only presented with the option to pass a storage_access_key in `config/storage.yml`. 

e.g.
```
azuretest:
  service: AzureStorage
  storage_account_name: ""[account_name]""
  storage_access_key: ""[storage_access_key]""
  container: ""[container_name]""
```

I've been provided a SAS (storage access signature), is there a way to configure storage such that I make use of the SAS token, or will I have to request a storage access key to make use of ActiveStorage with Azure

### System configuration
**Rails version**:  6.0.4.6

**Ruby version**: 2.6.5
",https://api.github.com/repos/rails/rails/issues/44590/timeline,,BrandonBalala,15928313,MDQ6VXNlcjE1OTI4MzEz,https://avatars.githubusercontent.com/u/15928313?v=4,,https://api.github.com/users/BrandonBalala,https://github.com/BrandonBalala,https://api.github.com/users/BrandonBalala/followers,https://api.github.com/users/BrandonBalala/following{/other_user},https://api.github.com/users/BrandonBalala/gists{/gist_id},https://api.github.com/users/BrandonBalala/starred{/owner}{/repo},https://api.github.com/users/BrandonBalala/subscriptions,https://api.github.com/users/BrandonBalala/orgs,https://api.github.com/users/BrandonBalala/repos,https://api.github.com/users/BrandonBalala/events{/privacy},https://api.github.com/users/BrandonBalala/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44590/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
126,https://api.github.com/repos/rails/rails/issues/44588,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44588/labels{/name},https://api.github.com/repos/rails/rails/issues/44588/comments,https://api.github.com/repos/rails/rails/issues/44588/events,https://github.com/rails/rails/pull/44588,1155473235,PR_kwDNIULOM7xb1g,44588,Deprecate the Flash Middleware. ,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,9,2022-03-01T15:24:34Z,2022-03-16T23:51:06Z,,MEMBER,,"Deprecate the Flash middleware:

- I originally created this PR to fix a bug where deleting the Flash Middleware wasn't doing anything, but after some discussions we realised that this middleware wasn't really one so we decided that it'd be better to just remove it (see https://github.com/rails/rails/pull/44588#issuecomment-1055845413)

  What that ""flash.rb"" file was doing was just monkeypatching the `ActionDispatch::Request` method once it was loaded, but it was very implicit. The goal of this PR is to:

 - Make things more explicit when monkeypatching
 - Move everything from the `middleware/flash.rb` file in a more appropriate locations (because it's not a middleware)
 - Deprecate the `ActionDispatch::Flash` middleware. We need to deprecate it because that middleware was documented as being part of the default middleware stack and thus users could legitimately reference it in their app when inserting other middlewares (i.e. `config.middleware.insert_after(ActionDispatch::Flash, MyMiddleware)`)

The first commit is the largest one and just moves everything from the `flash.rb` file. The main changes are in the other commits",https://api.github.com/repos/rails/rails/issues/44588/timeline,,Edouard-chin,8122246,MDQ6VXNlcjgxMjIyNDY=,https://avatars.githubusercontent.com/u/8122246?v=4,,https://api.github.com/users/Edouard-chin,https://github.com/Edouard-chin,https://api.github.com/users/Edouard-chin/followers,https://api.github.com/users/Edouard-chin/following{/other_user},https://api.github.com/users/Edouard-chin/gists{/gist_id},https://api.github.com/users/Edouard-chin/starred{/owner}{/repo},https://api.github.com/users/Edouard-chin/subscriptions,https://api.github.com/users/Edouard-chin/orgs,https://api.github.com/users/Edouard-chin/repos,https://api.github.com/users/Edouard-chin/events{/privacy},https://api.github.com/users/Edouard-chin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44588/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44588,https://github.com/rails/rails/pull/44588,https://github.com/rails/rails/pull/44588.diff,https://github.com/rails/rails/pull/44588.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
127,https://api.github.com/repos/rails/rails/issues/44576,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44576/labels{/name},https://api.github.com/repos/rails/rails/issues/44576/comments,https://api.github.com/repos/rails/rails/issues/44576/events,https://github.com/rails/rails/pull/44576,1154273875,PR_kwDNIULOM6yQNQ,44576,Defer verification of database connections,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-28T16:08:38Z,2022-03-31T13:34:03Z,,MEMBER,,"Instead of verifying upon checkout, wait until we run a query.

If the query we need to run is safely retryable (including schema inspection, and most notably `BEGIN`), we don't need to explicitly verify, and can just recover if the query fails.

By extension, we can apply the same connection-recovery logic to _every_ retryable query we run -- so e.g. the beginning of any top-level transaction is a safe transparent DB-reconnection point.",https://api.github.com/repos/rails/rails/issues/44576/timeline,,matthewd,1034,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,https://api.github.com/repos/rails/rails/issues/44576/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44576,https://github.com/rails/rails/pull/44576,https://github.com/rails/rails/pull/44576.diff,https://github.com/rails/rails/pull/44576.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
128,https://api.github.com/repos/rails/rails/issues/44571,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44571/labels{/name},https://api.github.com/repos/rails/rails/issues/44571/comments,https://api.github.com/repos/rails/rails/issues/44571/events,https://github.com/rails/rails/issues/44571,1154146874,I_kwDNIULORMriOg,44571,`precision: nil` added to datetime columns in `schema.rb` in 7.0.2 causes a change in value,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,15,2022-02-28T14:16:37Z,2022-03-23T12:27:13Z,,NONE,,"### Steps to reproduce

Running `db:migrate` in `7.0.2` adds `precision: nil` to datetime columns using postgres (a change from `7.0.1` discussed here https://github.com/rails/rails/issues/43909).

After this, one of our spec comparing dates is failing because of what looks like a precision related error:
```
Diff:
       @@ -1 +1 @@
       -Mon, 21 Feb 2022 14:10:49.640199500 CET +01:00
       +Mon, 21 Feb 2022 14:10:49.640199000 CET +01:00
```

The test basically asserts:

```
period = create(:period)
user = create(:user, period: period)

expect(period.start_at).to eq(user.period.start_at)
```

More importantly, this leads me to think there's an actual precision change that would not be reflected on production, only locally. I'm not sure how to rectify this.

In addition, it's unclear what `nil` means in this case. I liked the explicit `6` or no mention for default, but a change to `nil` was confusing. I assume it stands for the default.

### Expected behavior

No DB/value change

### Actual behavior

DB change

### System configuration
**Rails version**: 7.0.2.2

**Ruby version**: 3.0.3

**postgres version**: 13.4",https://api.github.com/repos/rails/rails/issues/44571/timeline,,thisismydesign,3299948,MDQ6VXNlcjMyOTk5NDg=,https://avatars.githubusercontent.com/u/3299948?v=4,,https://api.github.com/users/thisismydesign,https://github.com/thisismydesign,https://api.github.com/users/thisismydesign/followers,https://api.github.com/users/thisismydesign/following{/other_user},https://api.github.com/users/thisismydesign/gists{/gist_id},https://api.github.com/users/thisismydesign/starred{/owner}{/repo},https://api.github.com/users/thisismydesign/subscriptions,https://api.github.com/users/thisismydesign/orgs,https://api.github.com/users/thisismydesign/repos,https://api.github.com/users/thisismydesign/events{/privacy},https://api.github.com/users/thisismydesign/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44571/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
129,https://api.github.com/repos/rails/rails/issues/44564,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44564/labels{/name},https://api.github.com/repos/rails/rails/issues/44564/comments,https://api.github.com/repos/rails/rails/issues/44564/events,https://github.com/rails/rails/pull/44564,1153380300,PR_kwDNIULOM6CuUg,44564,Make ActionView::Helpers::Tags::CheckBox convert object's array values to strings so it works the same way as ActionView::Helpers::Tags::CollectionSelect.,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-27T20:07:52Z,2022-03-07T15:11:13Z,,CONTRIBUTOR,,"### Summary

So something like this

```ruby
@user.date = [Date.parse('2018-01-01')]

<%= form_with model: @user do |f| %>
  <%= f.check_box :date, {}, checked: '2018-01-01' %>
<% end %>
```
works. 

### Other Information

That's how CollectionSelect works https://github.com/rails/rails/blob/cece8077d4a6add9857013bd6463cf0797bdf3fa/actionview/lib/action_view/helpers/form_options_helper.rb#L361
",https://api.github.com/repos/rails/rails/issues/44564/timeline,,nashby,200500,MDQ6VXNlcjIwMDUwMA==,https://avatars.githubusercontent.com/u/200500?v=4,,https://api.github.com/users/nashby,https://github.com/nashby,https://api.github.com/users/nashby/followers,https://api.github.com/users/nashby/following{/other_user},https://api.github.com/users/nashby/gists{/gist_id},https://api.github.com/users/nashby/starred{/owner}{/repo},https://api.github.com/users/nashby/subscriptions,https://api.github.com/users/nashby/orgs,https://api.github.com/users/nashby/repos,https://api.github.com/users/nashby/events{/privacy},https://api.github.com/users/nashby/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44564/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44564,https://github.com/rails/rails/pull/44564,https://github.com/rails/rails/pull/44564.diff,https://github.com/rails/rails/pull/44564.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
130,https://api.github.com/repos/rails/rails/issues/44560,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44560/labels{/name},https://api.github.com/repos/rails/rails/issues/44560/comments,https://api.github.com/repos/rails/rails/issues/44560/events,https://github.com/rails/rails/pull/44560,1151866347,PR_kwDNIULOM4q9aA,44560,Re-raise unexpected errors in MemCacheStore tests,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-26T15:16:45Z,2022-02-26T15:16:48Z,,MEMBER,,"We've been seeing a lot of MemCacheStore test failures lately in CI.

This isn't going to change that, but at least will mean that whatever intermittent memcached issues we're experiencing get reported as the actual exception, rather than being silently swallowed into nil (which is of course the correct default ""broken cache shouldn't break the app"" behaviour).",https://api.github.com/repos/rails/rails/issues/44560/timeline,,matthewd,1034,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,https://api.github.com/repos/rails/rails/issues/44560/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44560,https://github.com/rails/rails/pull/44560,https://github.com/rails/rails/pull/44560.diff,https://github.com/rails/rails/pull/44560.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
131,https://api.github.com/repos/rails/rails/issues/44558,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44558/labels{/name},https://api.github.com/repos/rails/rails/issues/44558/comments,https://api.github.com/repos/rails/rails/issues/44558/events,https://github.com/rails/rails/pull/44558,1151234448,PR_kwDNIULOM4GAqg,44558,Adds test coverage for the `#attach` method behaviour in activestorage,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-26T05:25:45Z,2022-02-28T10:34:45Z,,CONTRIBUTOR,,"### Summary

This PR adds test coverage for the PR https://github.com/rails/rails/pull/44439 which modified the behavior of the `#attach` method.

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->
",https://api.github.com/repos/rails/rails/issues/44558/timeline,,ghousemohamed,56545288,MDQ6VXNlcjU2NTQ1Mjg4,https://avatars.githubusercontent.com/u/56545288?v=4,,https://api.github.com/users/ghousemohamed,https://github.com/ghousemohamed,https://api.github.com/users/ghousemohamed/followers,https://api.github.com/users/ghousemohamed/following{/other_user},https://api.github.com/users/ghousemohamed/gists{/gist_id},https://api.github.com/users/ghousemohamed/starred{/owner}{/repo},https://api.github.com/users/ghousemohamed/subscriptions,https://api.github.com/users/ghousemohamed/orgs,https://api.github.com/users/ghousemohamed/repos,https://api.github.com/users/ghousemohamed/events{/privacy},https://api.github.com/users/ghousemohamed/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44558/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44558,https://github.com/rails/rails/pull/44558,https://github.com/rails/rails/pull/44558.diff,https://github.com/rails/rails/pull/44558.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
132,https://api.github.com/repos/rails/rails/issues/44556,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44556/labels{/name},https://api.github.com/repos/rails/rails/issues/44556/comments,https://api.github.com/repos/rails/rails/issues/44556/events,https://github.com/rails/rails/pull/44556,1151001845,PR_kwDNIULOM34jOw,44556,Remove Rack::Sendfile from the default middleware stack,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,0,2022-02-26T00:56:38Z,2022-02-26T00:56:42Z,,CONTRIBUTOR,,"### Summary
Discussions: #41148, #42635 

*  `Rack::Sendfile` is replaced by a dummy `FakeSendfile` middleware, which cannot be used in middleware operations
*   Using `Rack::Sendfile` in middleware operations (`insert_after`, `insert_before`, etc.) throws a deprecation warning and uses `FakeSendfile` as asserting index instead
*   If an application adds `Rack::Sendfile` explicitly (`use`, etc.), then the deprecation warning is not raised and `FakeSendfile` is ignored
*   Removed configuration option for specifying the header used for sending files:
    ```
    config.action_dispatch.x_sendfile_header = 'X-Sendfile'
    ```
*   Docs are updated. Some examples are updated as well.

",https://api.github.com/repos/rails/rails/issues/44556/timeline,,SValkanov,8790422,MDQ6VXNlcjg3OTA0MjI=,https://avatars.githubusercontent.com/u/8790422?v=4,,https://api.github.com/users/SValkanov,https://github.com/SValkanov,https://api.github.com/users/SValkanov/followers,https://api.github.com/users/SValkanov/following{/other_user},https://api.github.com/users/SValkanov/gists{/gist_id},https://api.github.com/users/SValkanov/starred{/owner}{/repo},https://api.github.com/users/SValkanov/subscriptions,https://api.github.com/users/SValkanov/orgs,https://api.github.com/users/SValkanov/repos,https://api.github.com/users/SValkanov/events{/privacy},https://api.github.com/users/SValkanov/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44556/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44556,https://github.com/rails/rails/pull/44556,https://github.com/rails/rails/pull/44556.diff,https://github.com/rails/rails/pull/44556.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
133,https://api.github.com/repos/rails/rails/issues/44553,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44553/labels{/name},https://api.github.com/repos/rails/rails/issues/44553/comments,https://api.github.com/repos/rails/rails/issues/44553/events,https://github.com/rails/rails/issues/44553,1150651367,I_kwDNIULORJWL5w,44553,ActiveSupport::Deprecation does not fallback to configured disallowed_behavior,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,10,2022-02-25T16:43:41Z,2022-03-29T14:02:35Z,,CONTRIBUTOR,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activesupport"", ""~> 7.0.0""
end

require ""active_support""
require ""active_support/core_ext/object/blank""
require ""minitest/autorun""

class BugTest < Minitest::Test
  def test_stuff
    warnings = []

    ActiveSupport::Deprecation.disallowed_warnings << /my_gem soon/
    ActiveSupport::Deprecation.disallowed_behavior = ->(msg, callstack, horizon, gem_name) {
      warnings << msg
    }

    deprecator = ActiveSupport::Deprecation.new('soon', 'my_gem')
    deprecator.deprecation_warning(:some_method)

    refute warnings.empty?
  end
end
```

### Expected behavior

I expect the custom `disallowed_behavior` to be called by `#deprecation_warning`.

### Actual behavior

The gem-default behaviour (`:raise`) is called instead.

### System configuration

**Rails version**:

6.1.4.4 (but this problem affects all versions of Rails from 6.1 onwards)

**Ruby version**:

Ruby 3.1 (but this problem also occurs in earlier Ruby versions).

### More information

I _think_ this could be fixed by prepending a fallback to `ActiveSupport::Deprecation.disallowed_behavior` here: https://github.com/rails/rails/blob/87d4d0f4126f64d991d40a1827de50935ddfdbff/activesupport/lib/active_support/deprecation/behaviors.rb#L71-L73

However, because this class is using a singleton and [InstanceDelegator](https://github.com/rails/rails/blob/87d4d0f4126f64d991d40a1827de50935ddfdbff/activesupport/lib/active_support/deprecation/instance_delegator.rb) the method might need two definitions, one on the class-level (that falls back to DEFAULT_BEHAVIORS) and one on the instance level (that falls back to the class-level behavior).",https://api.github.com/repos/rails/rails/issues/44553/timeline,,grncdr,82634,MDQ6VXNlcjgyNjM0,https://avatars.githubusercontent.com/u/82634?v=4,,https://api.github.com/users/grncdr,https://github.com/grncdr,https://api.github.com/users/grncdr/followers,https://api.github.com/users/grncdr/following{/other_user},https://api.github.com/users/grncdr/gists{/gist_id},https://api.github.com/users/grncdr/starred{/owner}{/repo},https://api.github.com/users/grncdr/subscriptions,https://api.github.com/users/grncdr/orgs,https://api.github.com/users/grncdr/repos,https://api.github.com/users/grncdr/events{/privacy},https://api.github.com/users/grncdr/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44553/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
134,https://api.github.com/repos/rails/rails/issues/44549,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44549/labels{/name},https://api.github.com/repos/rails/rails/issues/44549/comments,https://api.github.com/repos/rails/rails/issues/44549/events,https://github.com/rails/rails/issues/44549,1150164625,I_kwDNIULORI4ekQ,44549,before_type_cast not work when it called by an object through association mapping and index,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-02-25T08:16:14Z,2022-03-23T16:20:26Z,,NONE,,"### Steps to reproduce
```ruby
# db/schema.rb
ActiveRecord::Schema[7.0].define(version: 2022_02_25_061737) do
  create_table ""boxes"", force: :cascade do |t|
    t.datetime ""created_at"", null: false
    t.datetime ""updated_at"", null: false
  end

  create_table ""chocolates"", force: :cascade do |t|
    t.string ""flavor""
    t.integer ""box_id"", null: false
    t.datetime ""created_at"", null: false
    t.datetime ""updated_at"", null: false
    t.index [""box_id""], name: ""index_chocolates_on_box_id""
  end

  add_foreign_key ""chocolates"", ""boxes""
end
```
```ruby
# app/models/box.rb
class Box < ApplicationRecord
  has_many :chocolates, dependent: :destroy

  def got_chocolate(flavor)
    chocolates.create!(flavor:)
  end
end
```
```ruby
# app/models/chocolate.rb
class Chocolate < ApplicationRecord
  enum flavor: { matcha: '녹차', strawberry: '딸기' }
  belongs_to :box
end
```
``` ruby
# spec/models/chocolate_spec.rb
require 'rails_helper'

RSpec.describe Chocolate, type: :model do
  let(:box) { create(:box) }

  before do
    box.got_chocolate(Chocolate.flavors[:matcha])
    box.got_chocolate(Chocolate.flavors[:strawberry])
  end

  it do
    chocolates = box.chocolates
    p chocolates.first.flavor_before_type_cast
    p chocolates[0].flavor_before_type_cast

    chocolates = Chocolate.where(box:)
    p chocolates.first.flavor_before_type_cast
    p chocolates[0].flavor_before_type_cast

    should belong_to(:box)
  end
end
```

### Expected behavior
""녹차"" is the value and ""matcha"" is the key of the enum hash

```ruby
""녹차""
""녹차""
""녹차""
""녹차""
```

### Actual behavior
```ruby
""녹차""
""matcha""      # ????
""녹차""
""녹차""
```

### System configuration
**Rails version**: 7.0.2

**Ruby version**: 3.1.0

### repository
https://github.com/jiso0jung/sample-proj
",https://api.github.com/repos/rails/rails/issues/44549/timeline,,jiso0jung,99234289,U_kgDOBeox8Q,https://avatars.githubusercontent.com/u/99234289?v=4,,https://api.github.com/users/jiso0jung,https://github.com/jiso0jung,https://api.github.com/users/jiso0jung/followers,https://api.github.com/users/jiso0jung/following{/other_user},https://api.github.com/users/jiso0jung/gists{/gist_id},https://api.github.com/users/jiso0jung/starred{/owner}{/repo},https://api.github.com/users/jiso0jung/subscriptions,https://api.github.com/users/jiso0jung/orgs,https://api.github.com/users/jiso0jung/repos,https://api.github.com/users/jiso0jung/events{/privacy},https://api.github.com/users/jiso0jung/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44549/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
135,https://api.github.com/repos/rails/rails/issues/44547,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44547/labels{/name},https://api.github.com/repos/rails/rails/issues/44547/comments,https://api.github.com/repos/rails/rails/issues/44547/events,https://github.com/rails/rails/pull/44547,1150043182,PR_kwDNIULOM3HJBQ,44547,fix remaining asserts that should be assert_equal,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,3,2022-02-25T04:57:16Z,2022-03-30T16:14:31Z,,MEMBER,,"### Summary

Found using `Minitest/AssertWithExpectedArgument`.

Also enabled the rule per feedback and fixed 21 additional violations

### Original Description

Found using `Minitest/AssertWithExpectedArgument`. There were about 20
more warnings raised by this rule that looked correct, so I'm not sure
if it would be a good idea to enable it by default.",https://api.github.com/repos/rails/rails/issues/44547/timeline,,SkipKayhil,6014046,MDQ6VXNlcjYwMTQwNDY=,https://avatars.githubusercontent.com/u/6014046?v=4,,https://api.github.com/users/SkipKayhil,https://github.com/SkipKayhil,https://api.github.com/users/SkipKayhil/followers,https://api.github.com/users/SkipKayhil/following{/other_user},https://api.github.com/users/SkipKayhil/gists{/gist_id},https://api.github.com/users/SkipKayhil/starred{/owner}{/repo},https://api.github.com/users/SkipKayhil/subscriptions,https://api.github.com/users/SkipKayhil/orgs,https://api.github.com/users/SkipKayhil/repos,https://api.github.com/users/SkipKayhil/events{/privacy},https://api.github.com/users/SkipKayhil/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44547/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44547,https://github.com/rails/rails/pull/44547,https://github.com/rails/rails/pull/44547.diff,https://github.com/rails/rails/pull/44547.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
136,https://api.github.com/repos/rails/rails/issues/44542,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44542/labels{/name},https://api.github.com/repos/rails/rails/issues/44542/comments,https://api.github.com/repos/rails/rails/issues/44542/events,https://github.com/rails/rails/pull/44542,1149285900,PR_kwDNIULOM2e-lw,44542,Added assertions for testing unicode characters in `to_fs` method on `Numeric` for `:currency`,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,4,2022-02-24T13:24:00Z,2022-02-24T19:08:11Z,,CONTRIBUTOR,,"### Summary

I think the `#test_to_fs__currency` test should also test for Unicode characters when numbers are converted to currency readable format.

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->",https://api.github.com/repos/rails/rails/issues/44542/timeline,,ghousemohamed,56545288,MDQ6VXNlcjU2NTQ1Mjg4,https://avatars.githubusercontent.com/u/56545288?v=4,,https://api.github.com/users/ghousemohamed,https://github.com/ghousemohamed,https://api.github.com/users/ghousemohamed/followers,https://api.github.com/users/ghousemohamed/following{/other_user},https://api.github.com/users/ghousemohamed/gists{/gist_id},https://api.github.com/users/ghousemohamed/starred{/owner}{/repo},https://api.github.com/users/ghousemohamed/subscriptions,https://api.github.com/users/ghousemohamed/orgs,https://api.github.com/users/ghousemohamed/repos,https://api.github.com/users/ghousemohamed/events{/privacy},https://api.github.com/users/ghousemohamed/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44542/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44542,https://github.com/rails/rails/pull/44542,https://github.com/rails/rails/pull/44542.diff,https://github.com/rails/rails/pull/44542.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
137,https://api.github.com/repos/rails/rails/issues/44534,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44534/labels{/name},https://api.github.com/repos/rails/rails/issues/44534/comments,https://api.github.com/repos/rails/rails/issues/44534/events,https://github.com/rails/rails/pull/44534,1148410182,PR_kwDNIULOM1xFnA,44534,Port `BeforeTypeCast` to Active Model,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-23T17:57:55Z,2022-02-28T18:10:14Z,,MEMBER,,"`ActiveModel::Attributes` was made public in #44306. As a follow-up to that, this commit ports `ActiveRecord::AttributeMethods::BeforeTypeCast` to Active Model, so that classes which include `ActiveModel::Attributes` will automatically define e.g. `*_before_type_cast` methods.

---

This PR removes `ActiveRecord::AttributeMethods::BeforeTypeCast`, but keeps its tests, because some of them assert behavior that is specific to Active Record.
",https://api.github.com/repos/rails/rails/issues/44534/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44534/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44534,https://github.com/rails/rails/pull/44534,https://github.com/rails/rails/pull/44534.diff,https://github.com/rails/rails/pull/44534.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
138,https://api.github.com/repos/rails/rails/issues/44533,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44533/labels{/name},https://api.github.com/repos/rails/rails/issues/44533/comments,https://api.github.com/repos/rails/rails/issues/44533/events,https://github.com/rails/rails/issues/44533,1148290667,I_kwDNIULORHGGaw,44533,"PR #36210 solved only for `save!`, but not for `save` neither `valid?`.","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2022-02-23T16:11:08Z,2022-02-24T23:07:15Z,,NONE,,"Related PR: https://github.com/rails/rails/pull/36210

```ruby
class List < ApplicationRecord
  has_many :items, class_name: ""ListItem"", dependent: :destroy
end

class ListItem < ApplicationRecord
  belongs_to :list

  validates_uniqueness_of :name, scope: :list_id
end

l = List.create name: 'TestList'
l.items.build name: 'Item'
l.items.build name: 'Item'
l.valid? # this returns true instead of false
l.save # this returns false correctly, but with a rollback exception
```

Confirmed on Rails 7.0.2.2",https://api.github.com/repos/rails/rails/issues/44533/timeline,,cgimenes,2816976,MDQ6VXNlcjI4MTY5NzY=,https://avatars.githubusercontent.com/u/2816976?v=4,,https://api.github.com/users/cgimenes,https://github.com/cgimenes,https://api.github.com/users/cgimenes/followers,https://api.github.com/users/cgimenes/following{/other_user},https://api.github.com/users/cgimenes/gists{/gist_id},https://api.github.com/users/cgimenes/starred{/owner}{/repo},https://api.github.com/users/cgimenes/subscriptions,https://api.github.com/users/cgimenes/orgs,https://api.github.com/users/cgimenes/repos,https://api.github.com/users/cgimenes/events{/privacy},https://api.github.com/users/cgimenes/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44533/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
139,https://api.github.com/repos/rails/rails/issues/44518,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44518/labels{/name},https://api.github.com/repos/rails/rails/issues/44518/comments,https://api.github.com/repos/rails/rails/issues/44518/events,https://github.com/rails/rails/pull/44518,1146704862,PR_kwDNIULOM0ZcWw,44518,Make ActiveRecord::Rollback bubble to outer transactions,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,15,2022-02-22T10:08:34Z,2022-04-04T11:54:27Z,,CONTRIBUTOR,,"### Summary

Re-raise the error till it reaches a savepoint or the top transaction.
The reason to stop at savepoint / requires_new transactions is that
they are actual nested transactions so are the smallest unit the
database can rollback.

### Other Information

This is a breaking change but the current behaviour is documented as
being ""surprising"".",https://api.github.com/repos/rails/rails/issues/44518/timeline,,nikolai-b,6289830,MDQ6VXNlcjYyODk4MzA=,https://avatars.githubusercontent.com/u/6289830?v=4,,https://api.github.com/users/nikolai-b,https://github.com/nikolai-b,https://api.github.com/users/nikolai-b/followers,https://api.github.com/users/nikolai-b/following{/other_user},https://api.github.com/users/nikolai-b/gists{/gist_id},https://api.github.com/users/nikolai-b/starred{/owner}{/repo},https://api.github.com/users/nikolai-b/subscriptions,https://api.github.com/users/nikolai-b/orgs,https://api.github.com/users/nikolai-b/repos,https://api.github.com/users/nikolai-b/events{/privacy},https://api.github.com/users/nikolai-b/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44518/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44518,https://github.com/rails/rails/pull/44518,https://github.com/rails/rails/pull/44518.diff,https://github.com/rails/rails/pull/44518.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
140,https://api.github.com/repos/rails/rails/issues/44506,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44506/labels{/name},https://api.github.com/repos/rails/rails/issues/44506/comments,https://api.github.com/repos/rails/rails/issues/44506/events,https://github.com/rails/rails/pull/44506,1146085166,PR_kwDNIULOMz5MmA,44506,Apply `:nodoc:` to nested classes and modules [ci-skip],"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'jonathanhefner', 'id': 771968, 'node_id': 'MDQ6VXNlcjc3MTk2OA==', 'avatar_url': 'https://avatars.githubusercontent.com/u/771968?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jonathanhefner', 'html_url': 'https://github.com/jonathanhefner', 'followers_url': 'https://api.github.com/users/jonathanhefner/followers', 'following_url': 'https://api.github.com/users/jonathanhefner/following{/other_user}', 'gists_url': 'https://api.github.com/users/jonathanhefner/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jonathanhefner/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jonathanhefner/subscriptions', 'organizations_url': 'https://api.github.com/users/jonathanhefner/orgs', 'repos_url': 'https://api.github.com/users/jonathanhefner/repos', 'events_url': 'https://api.github.com/users/jonathanhefner/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jonathanhefner/received_events', 'type': 'User', 'site_admin': False}]",,4,2022-02-21T17:52:25Z,2022-02-21T22:04:37Z,,MEMBER,,"When `:nodoc:` is applied to a class / module, RDoc will still document nested classes / modules, unless `:nodoc:` is applied to them as well.  Additionally, if `:nodoc: all` is applied to a class / module that contains nested classes / modules, like so:

```ruby
class Foo # :nodoc: all
  def foo_method; end

  class Bar
    def bar_method; end
  end
end
```

RDoc will still include the outer class / module (e.g. `Foo`) in the doc index, albeit as an empty namespace.  Furthermore, SDoc will include both outer and inner (e.g. `Foo` and `Bar`) in the index as empty namespaces.

However, when `:nodoc:` is applied at all levels, like so:

```ruby
class Foo # :nodoc:
  def foo_method; end

  class Bar # :nodoc:
    def bar_method; end
  end
end
```

Both RDoc and SDoc include neither outer nor inner in the index.
",https://api.github.com/repos/rails/rails/issues/44506/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44506/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44506,https://github.com/rails/rails/pull/44506,https://github.com/rails/rails/pull/44506.diff,https://github.com/rails/rails/pull/44506.patch,,jonathanhefner,771968.0,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
141,https://api.github.com/repos/rails/rails/issues/44490,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44490/labels{/name},https://api.github.com/repos/rails/rails/issues/44490/comments,https://api.github.com/repos/rails/rails/issues/44490/events,https://github.com/rails/rails/pull/44490,1144857825,PR_kwDNIULOMy6zmg,44490,Rails Guides - Fix incorrect generator example [ci-skip],"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-19T22:06:49Z,2022-02-21T23:14:17Z,,NONE,,"Description says ""stop generating stylesheet and test fixtures"" but example doesn't stop stylesheet generation.
(we can also change the description instead of the example, but it's reused a few lines below)
",https://api.github.com/repos/rails/rails/issues/44490/timeline,,gfauredumont,505226,MDQ6VXNlcjUwNTIyNg==,https://avatars.githubusercontent.com/u/505226?v=4,,https://api.github.com/users/gfauredumont,https://github.com/gfauredumont,https://api.github.com/users/gfauredumont/followers,https://api.github.com/users/gfauredumont/following{/other_user},https://api.github.com/users/gfauredumont/gists{/gist_id},https://api.github.com/users/gfauredumont/starred{/owner}{/repo},https://api.github.com/users/gfauredumont/subscriptions,https://api.github.com/users/gfauredumont/orgs,https://api.github.com/users/gfauredumont/repos,https://api.github.com/users/gfauredumont/events{/privacy},https://api.github.com/users/gfauredumont/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44490/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44490,https://github.com/rails/rails/pull/44490,https://github.com/rails/rails/pull/44490.diff,https://github.com/rails/rails/pull/44490.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
142,https://api.github.com/repos/rails/rails/issues/44489,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44489/labels{/name},https://api.github.com/repos/rails/rails/issues/44489/comments,https://api.github.com/repos/rails/rails/issues/44489/events,https://github.com/rails/rails/issues/44489,1144857548,I_kwDNIULORD0jzA,44489,connection.sanitize_limit is no longer needed when building limit clause,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2022-02-19T22:05:30Z,2022-04-04T16:59:31Z,,NONE,,"connection.sanitize_limit [is currently called](https://github.com/rails/rails/blob/de7c495209811f8f918fa9f915e64df61a6080c1/activerecord/lib/active_record/relation/query_methods.rb#L1347) when building limit clause in Arel. 

It doesn't seem necessary any more for the following reasons:
1. build_cast_value results in  ActiveModel::Attribute type, which binds the value, and thus prevents SQLi
2. there is little reason to pass in an argument of Arel::Nodes::SqlLiteral type to +limit+ API

Current:
 arel.take(build_cast_value(""LIMIT"", connection.sanitize_limit(limit_value))) if limit_value
Expected:
 arel.take(build_cast_value(""LIMIT"", limit_value.to_i)) if limit_value",https://api.github.com/repos/rails/rails/issues/44489/timeline,,harrycis,4240939,MDQ6VXNlcjQyNDA5Mzk=,https://avatars.githubusercontent.com/u/4240939?v=4,,https://api.github.com/users/harrycis,https://github.com/harrycis,https://api.github.com/users/harrycis/followers,https://api.github.com/users/harrycis/following{/other_user},https://api.github.com/users/harrycis/gists{/gist_id},https://api.github.com/users/harrycis/starred{/owner}{/repo},https://api.github.com/users/harrycis/subscriptions,https://api.github.com/users/harrycis/orgs,https://api.github.com/users/harrycis/repos,https://api.github.com/users/harrycis/events{/privacy},https://api.github.com/users/harrycis/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44489/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
143,https://api.github.com/repos/rails/rails/issues/44479,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44479/labels{/name},https://api.github.com/repos/rails/rails/issues/44479/comments,https://api.github.com/repos/rails/rails/issues/44479/events,https://github.com/rails/rails/issues/44479,1143343989,I_kwDNIULORCYLdQ,44479,"When using both touch and counter_cache on a belongs_to association, updated_at on the associated object instance is not updated","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,13,2022-02-18T16:17:36Z,2022-02-25T13:13:26Z,,NONE,,"Hi everyone!
I ran into an issue with a counter cached `belongs_to` association.

In short, when I have an association with only `touch: true`, it works as expected:
```ruby
class Comment < ActiveRecord::Base
  belongs_to :post, touch: true
end
# updated_at is updated on the Post instance after doing this
post.comments.create!
```
But when I add `counter_cache: true` to the same association, it stops working as expected:
```ruby
class Comment < ActiveRecord::Base
  belongs_to :post, touch: true, counter_cache: true
end
# updated_at is NOT updated on the Post instance after doing this (it has been updated in the DB however)
post.comments.create!
```

### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  #gem ""rails"", ""6.0.4.6""
  #gem ""rails"", ""6.1.4.6""
  #gem ""rails"", ""7.0.2.2""
  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.integer :comments_count, null: false, default: 0
    t.timestamps
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  # works as expected
  #belongs_to :post, touch: true

  # does not work as expected
  belongs_to :post, touch: true, counter_cache: true
end

class BugTest < Minitest::Test
  def test_post_instance_updated
    post = Post.create!
    previous_updated_at = post.updated_at.to_f.to_s

    post.comments.create!

    # expecting post.updated_at to be different from the previous value
    # after creating a new comment on this post
    assert previous_updated_at != post.updated_at.to_f.to_s
  end
end

```

### Expected behavior
Updated `updated_at` should be reflected on the `Post` instance in addition to being updated in the database.

### Actual behavior
Updated `updated_at` is not reflected on the `Post` instance. It is however correctly updated in the database.

### System configuration
**Rails version**:
* 6.0.4.6
* 6.1.4.6
* 7.0.2.2
* main

**Ruby version**: 2.7.5
",https://api.github.com/repos/rails/rails/issues/44479/timeline,,yan-hoose,1543171,MDQ6VXNlcjE1NDMxNzE=,https://avatars.githubusercontent.com/u/1543171?v=4,,https://api.github.com/users/yan-hoose,https://github.com/yan-hoose,https://api.github.com/users/yan-hoose/followers,https://api.github.com/users/yan-hoose/following{/other_user},https://api.github.com/users/yan-hoose/gists{/gist_id},https://api.github.com/users/yan-hoose/starred{/owner}{/repo},https://api.github.com/users/yan-hoose/subscriptions,https://api.github.com/users/yan-hoose/orgs,https://api.github.com/users/yan-hoose/repos,https://api.github.com/users/yan-hoose/events{/privacy},https://api.github.com/users/yan-hoose/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44479/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
144,https://api.github.com/repos/rails/rails/issues/44478,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44478/labels{/name},https://api.github.com/repos/rails/rails/issues/44478/comments,https://api.github.com/repos/rails/rails/issues/44478/events,https://github.com/rails/rails/pull/44478,1143081297,PR_kwDNIULOMxWakw,44478,PG: Schema cache with TypeMap,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-02-18T13:39:17Z,2022-04-05T08:39:29Z,,NONE,,"### Summary

In our project, we are using PG and Resque.
Right now, for every Resque job processed and new connection spawned, we are executing this method in Rails that run a costly query :

```ruby
def load_additional_types(oids = nil)
  initializer = OID::TypeMapInitializer.new(type_map)

  query = <<~SQL
    SELECT t.oid, t.typname, t.typelem, t.typdelim, t.typinput, r.rngsubtype, t.typtype, t.typbasetype
    FROM pg_type as t
    LEFT JOIN pg_range as r ON oid = rngtypid
  SQL
     
  if oids
    query += ""WHERE t.oid IN (%s)"" % oids.join("", "")
  else
    query += initializer.query_conditions_for_initial_load
  end
      
  execute_and_clear(query, ""SCHEMA"", []) do |records|
    initializer.run(records)
  end
end
```

To fix this issue we have done a monkey patch, basically, the connection pool stores a cache of the `type_map`, and a new connection will inherit from this cache, instead of querying it.

```ruby
module ActiveRecord
  module ConnectionAdapters
    class PoolManager
      attr_accessor :type_map
    end
  end

  class ConnectionAdapters::ConnectionPool
    def adopt_connection(conn)
      ....
      pool_manager = ConnectionAdapters::ConnectionPool.get_pool_manager

      pool_manager.type_map ||= conn.type_map
      ....
    end
  end

  class ConnectionAdapters::PostgreSQLAdapter
    attr_reader :type_map

    def initialize(connection, logger, connection_parameters, config)
      ....

      pool_manager = ConnectionAdapters::ConnectionPool.get_pool_manager
      type_map = pool_manager.type_map

      if type_map
        @type_map = type_map
      else
        @type_map = Type::HashLookupTypeMap.new
        initialize_type_map
      end
 
      ....
    end
  end
end
```

In order not to have monkey patches we want to solve it on a Rails side which could be useful for other developers too.

It also affects every Rails upgrade.

* First of all, we have dug in relevant PRs done in Rails and took some ideas.
* The solutions to deal with issues maybe:
    * Store `TypeMap` into `SchemaCache` (relevant for PG only)
    * Switch off `TypeMap` if there is no usage of PG custom types
    * Introduce the monkey patch as the solution for Rails
* We have selected the first one and would like to have feedback from Rails maintainers and complete this topic.
* If there is something we have missed we are also ready to fix it shortly.

Base PRs for this PR:

https://github.com/rails/rails/issues/35311
https://github.com/rails/rails/pull/39821/files
https://github.com/rails/rails/pull/39077/files
https://github.com/rails/rails/pull/41288/files

I would like to tag also @piecehealth and @ted-hanson",https://api.github.com/repos/rails/rails/issues/44478/timeline,,mochnatiy,843601,MDQ6VXNlcjg0MzYwMQ==,https://avatars.githubusercontent.com/u/843601?v=4,,https://api.github.com/users/mochnatiy,https://github.com/mochnatiy,https://api.github.com/users/mochnatiy/followers,https://api.github.com/users/mochnatiy/following{/other_user},https://api.github.com/users/mochnatiy/gists{/gist_id},https://api.github.com/users/mochnatiy/starred{/owner}{/repo},https://api.github.com/users/mochnatiy/subscriptions,https://api.github.com/users/mochnatiy/orgs,https://api.github.com/users/mochnatiy/repos,https://api.github.com/users/mochnatiy/events{/privacy},https://api.github.com/users/mochnatiy/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44478/reactions,4,2,0,0,0,0,2,0,0,False,https://api.github.com/repos/rails/rails/pulls/44478,https://github.com/rails/rails/pull/44478,https://github.com/rails/rails/pull/44478.diff,https://github.com/rails/rails/pull/44478.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
145,https://api.github.com/repos/rails/rails/issues/44476,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44476/labels{/name},https://api.github.com/repos/rails/rails/issues/44476/comments,https://api.github.com/repos/rails/rails/issues/44476/events,https://github.com/rails/rails/pull/44476,1142575196,PR_kwDNIULOMw6UYg,44476,Fix `ActiveModel::EachValidator` options hash handling,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-18T07:54:57Z,2022-02-23T13:40:13Z,,NONE,,"### Summary

This PR is relates to https://github.com/rails/rails/issues/44460.
It changes `ActiveModel::EachValidator` options hash handling in order to work better with `validates_with`.

Until now the `:attributes` key was directly deleted from the underlying options hash.
This did raise a ArgumentError when multiple `ActiveModel::EachValidator` have been
chained within a `validates_with` call.
    
Now the options hash gets duplicated.
",https://api.github.com/repos/rails/rails/issues/44476/timeline,,dspaeth-lp,94361863,U_kgDOBZ_ZBw,https://avatars.githubusercontent.com/u/94361863?v=4,,https://api.github.com/users/dspaeth-lp,https://github.com/dspaeth-lp,https://api.github.com/users/dspaeth-lp/followers,https://api.github.com/users/dspaeth-lp/following{/other_user},https://api.github.com/users/dspaeth-lp/gists{/gist_id},https://api.github.com/users/dspaeth-lp/starred{/owner}{/repo},https://api.github.com/users/dspaeth-lp/subscriptions,https://api.github.com/users/dspaeth-lp/orgs,https://api.github.com/users/dspaeth-lp/repos,https://api.github.com/users/dspaeth-lp/events{/privacy},https://api.github.com/users/dspaeth-lp/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44476/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44476,https://github.com/rails/rails/pull/44476,https://github.com/rails/rails/pull/44476.diff,https://github.com/rails/rails/pull/44476.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
146,https://api.github.com/repos/rails/rails/issues/44472,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44472/labels{/name},https://api.github.com/repos/rails/rails/issues/44472/comments,https://api.github.com/repos/rails/rails/issues/44472/events,https://github.com/rails/rails/pull/44472,1142019829,PR_kwDNIULOMwbE5A,44472,Add additional content injection prevention to form HTML,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,9,2022-02-17T22:55:46Z,2022-04-04T17:59:46Z,,NONE,,"### Summary

GitHub has some additional protections in place that are automatically added in front of all our form tags to mitigate XSS-style content exfiltration. The following matter is included before all `<form>` tags:

```
<!-- '""` --><!-- </textarea></xmp> --></option></form>
```

I'm proposing upstreaming the additional protections into Rails. Since this change will often produce technically invalid HTML, I've put it behind a configuration option. It's worth noting that, as far as I am aware, GitHub has not experienced any problems in the browsers we support as a result of the invalid HTML.",https://api.github.com/repos/rails/rails/issues/44472/timeline,,camertron,575280,MDQ6VXNlcjU3NTI4MA==,https://avatars.githubusercontent.com/u/575280?v=4,,https://api.github.com/users/camertron,https://github.com/camertron,https://api.github.com/users/camertron/followers,https://api.github.com/users/camertron/following{/other_user},https://api.github.com/users/camertron/gists{/gist_id},https://api.github.com/users/camertron/starred{/owner}{/repo},https://api.github.com/users/camertron/subscriptions,https://api.github.com/users/camertron/orgs,https://api.github.com/users/camertron/repos,https://api.github.com/users/camertron/events{/privacy},https://api.github.com/users/camertron/received_events,User,True,https://api.github.com/repos/rails/rails/issues/44472/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44472,https://github.com/rails/rails/pull/44472,https://github.com/rails/rails/pull/44472.diff,https://github.com/rails/rails/pull/44472.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
147,https://api.github.com/repos/rails/rails/issues/44469,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44469/labels{/name},https://api.github.com/repos/rails/rails/issues/44469/comments,https://api.github.com/repos/rails/rails/issues/44469/events,https://github.com/rails/rails/pull/44469,1141875314,PR_kwDNIULOMwS9OA,44469,Make Notifications::Fanout faster and safer,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-17T20:59:50Z,2022-02-18T23:45:32Z,,MEMBER,,"@seejohnrun and I wrote this on his Twitch stream Tuesday night. Thanks those who helped us in chat 😁

This commit aims to improve `ActiveSupport::Notifications::Fanout`. There are three main goals here: backwards compatibility, safety, and performance.

## Backwards compatibility

`ActiveSupport::Notifications` is an old and well used interface. Over time it has collected a lot of features and flexibility, much of which I suspect is not used anywhere by anyone, but it is hard to know specifics and we would at minimum need a deprecation cycle to remove any of them.

For this reason this aims to fully maintain compatibility. This includes both the ability to use an alternate notification implementation instead of `Fanout`, the signatures received by all types of listeners, and the interface used on the `Instrumenter` and `Fanout` itself (including the sometimes problematic `start`/`finish`).

## Safety

There have been issues (both recent and past, ex. #44167 #21873) with the ""timestacks"" becoming invalid, particularly when subscribing and unsubscribing within events. This is an issue when topics are subscribed/unsubscribed to while they are in flight.

The previous implementation would record a separate timestamp or event object for each listener in a thread local stack. This meant that it was essential that the listeners to start and finish were identical.

This issue is avoided by passing the listeners used to `start` the event to `finish` (`finish_with_state` in the Instrumenter), to ensure they are the same set in `start`/`finish`.

This commit further avoids this issue. Instead of pushing individual times onto a stack, we now push a single object, `Handle`, onto the stack for an event. This object holds all the subscribers (recorded at start time) and all their associated data. This means that as long as start/stop calls are not interleaved they too are now safe. When `Instrumenter#instrument` is used we can avoid using thread-locals entirely!

This commit also exposes `build_handle` as a public interface. This returns the Handle object which can have start/stop called at any time and any order safely. The one reservation I have with making this public is that existing ""evented"" listeners (those receiving start/stop) may not be ready for that (ex. if they maintain an internal thread-local stack).

## Performance

This aims to be faster and make fewer allocations then the existing implementation.

For time-based and event-object-based listeners, the previous implementation created a separate object for each listener, pushing and popping it on a thread-local stack. This is slower both because we need to access the thread local repeatedly (hash lookups) and because we're allocating duplicate objects.

The new implementation works by grouping similar types of listeners together and shares either the `Event` or start/stop times between all of them. The grouping was done so that we didn't need to allocate Events or Times for topics which did have a listener of that type.

This implementation is significantly faster for all cases, except for evented, which is slower.

For topics with 10 subscriptions:

<details>
<summary>benchmark</summary>

```
# frozen_string_literal: true

require 'benchmark/ips'
require 'active_support/all'

class EventedSubscriber
  def start(name, id, payload); end
  def finish(name, id, payload); end
end

10.times do
  ActiveSupport::Notifications.subscribe(""timed"") do |name, started, ended, id, payload|
  end

  ActiveSupport::Notifications.monotonic_subscribe(""timed_monotonic"") do |name, started, ended, id, payload|
  end

  ActiveSupport::Notifications.subscribe(""event_object"") do |event|
  end

  ActiveSupport::Notifications.subscribe(""evented"", EventedSubscriber.new)
end

Benchmark.ips do |x|
  x.report(""timed"") do
    ActiveSupport::Notifications.instrument(""timed""){}
  end
  x.report(""timed_monotonic"") do
    ActiveSupport::Notifications.instrument(""timed_monotonic""){}
  end
  x.report(""event_object"") do
    ActiveSupport::Notifications.instrument(""event_object""){}
  end
  x.report(""evented"") do
    ActiveSupport::Notifications.instrument(""evented""){}
  end
  x.report(""unsubscribed"") do
    ActiveSupport::Notifications.instrument(""unsubscribed""){}
  end
end
```

</details>

*main*:

               timed     66.739k (± 2.5%) i/s -    338.800k in   5.079883s
     timed_monotonic    138.265k (± 0.6%) i/s -    699.261k in   5.057575s
        event_object     48.650k (± 0.2%) i/s -    244.250k in   5.020614s
             evented    366.559k (± 1.0%) i/s -      1.851M in   5.049727s
        unsubscribed      3.696M (± 0.5%) i/s -     18.497M in   5.005335s

*This branch*:

               timed    259.031k (± 0.6%) i/s -      1.302M in   5.025612s
     timed_monotonic    327.439k (± 1.7%) i/s -      1.665M in   5.086815s
        event_object    228.991k (± 0.3%) i/s -      1.164M in   5.083539s
             evented    296.057k (± 0.3%) i/s -      1.501M in   5.070315s
        unsubscribed      3.670M (± 0.3%) i/s -     18.376M in   5.007095s",https://api.github.com/repos/rails/rails/issues/44469/timeline,,jhawthorn,131752,MDQ6VXNlcjEzMTc1Mg==,https://avatars.githubusercontent.com/u/131752?v=4,,https://api.github.com/users/jhawthorn,https://github.com/jhawthorn,https://api.github.com/users/jhawthorn/followers,https://api.github.com/users/jhawthorn/following{/other_user},https://api.github.com/users/jhawthorn/gists{/gist_id},https://api.github.com/users/jhawthorn/starred{/owner}{/repo},https://api.github.com/users/jhawthorn/subscriptions,https://api.github.com/users/jhawthorn/orgs,https://api.github.com/users/jhawthorn/repos,https://api.github.com/users/jhawthorn/events{/privacy},https://api.github.com/users/jhawthorn/received_events,User,True,https://api.github.com/repos/rails/rails/issues/44469/reactions,5,0,0,0,0,0,5,0,0,False,https://api.github.com/repos/rails/rails/pulls/44469,https://github.com/rails/rails/pull/44469,https://github.com/rails/rails/pull/44469.diff,https://github.com/rails/rails/pull/44469.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
148,https://api.github.com/repos/rails/rails/issues/44468,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44468/labels{/name},https://api.github.com/repos/rails/rails/issues/44468/comments,https://api.github.com/repos/rails/rails/issues/44468/events,https://github.com/rails/rails/pull/44468,1141873120,PR_kwDNIULOMwS1bg,44468,`form_with`: Attempt to call to_model on `model:`,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2022-02-17T20:58:10Z,2022-02-17T21:28:02Z,,CONTRIBUTOR,,"### Summary

Ensure models passed to `form_with` attempt to call `to_model`.

This is a separate follow-up change proposed in [rails/rails#44328][].
The original change to restore old behavior _deliberately_ excluded
applying the same logic to `form_with`, since it would be a breaking
change from how `form_with` behaved previously.

This commit proposed making that breaking change.

[rails/rails#44328]: https://github.com/rails/rails/pull/44328#discussion_r808475585
",https://api.github.com/repos/rails/rails/issues/44468/timeline,,seanpdoyle,2575027,MDQ6VXNlcjI1NzUwMjc=,https://avatars.githubusercontent.com/u/2575027?v=4,,https://api.github.com/users/seanpdoyle,https://github.com/seanpdoyle,https://api.github.com/users/seanpdoyle/followers,https://api.github.com/users/seanpdoyle/following{/other_user},https://api.github.com/users/seanpdoyle/gists{/gist_id},https://api.github.com/users/seanpdoyle/starred{/owner}{/repo},https://api.github.com/users/seanpdoyle/subscriptions,https://api.github.com/users/seanpdoyle/orgs,https://api.github.com/users/seanpdoyle/repos,https://api.github.com/users/seanpdoyle/events{/privacy},https://api.github.com/users/seanpdoyle/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44468/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44468,https://github.com/rails/rails/pull/44468,https://github.com/rails/rails/pull/44468.diff,https://github.com/rails/rails/pull/44468.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
149,https://api.github.com/repos/rails/rails/issues/44467,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44467/labels{/name},https://api.github.com/repos/rails/rails/issues/44467/comments,https://api.github.com/repos/rails/rails/issues/44467/events,https://github.com/rails/rails/pull/44467,1141840701,PR_kwDNIULOMwRBJA,44467,Use clusivity for numericality with :in or :within,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-17T20:33:40Z,2022-02-17T20:33:43Z,,MEMBER,,"### Summary

Previously, only ranges were allowed, but this change uses the existing
Clusivity module to validate against anything with an include? method.

### Other Information

Fixes #44465 
",https://api.github.com/repos/rails/rails/issues/44467/timeline,,SkipKayhil,6014046,MDQ6VXNlcjYwMTQwNDY=,https://avatars.githubusercontent.com/u/6014046?v=4,,https://api.github.com/users/SkipKayhil,https://github.com/SkipKayhil,https://api.github.com/users/SkipKayhil/followers,https://api.github.com/users/SkipKayhil/following{/other_user},https://api.github.com/users/SkipKayhil/gists{/gist_id},https://api.github.com/users/SkipKayhil/starred{/owner}{/repo},https://api.github.com/users/SkipKayhil/subscriptions,https://api.github.com/users/SkipKayhil/orgs,https://api.github.com/users/SkipKayhil/repos,https://api.github.com/users/SkipKayhil/events{/privacy},https://api.github.com/users/SkipKayhil/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44467/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44467,https://github.com/rails/rails/pull/44467,https://github.com/rails/rails/pull/44467.diff,https://github.com/rails/rails/pull/44467.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
150,https://api.github.com/repos/rails/rails/issues/44466,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44466/labels{/name},https://api.github.com/repos/rails/rails/issues/44466/comments,https://api.github.com/repos/rails/rails/issues/44466/events,https://github.com/rails/rails/pull/44466,1141826217,PR_kwDNIULOMwQN6g,44466,Document some Application::Configuration as accessors [ci-skip],"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-17T20:21:14Z,2022-02-17T21:05:05Z,,MEMBER,,"### Summary

A lot of the undocumented methods in Application::Configuration are
already documented in the configuration guides. Some of these methods
are basically `attr_accessors` so we should document them as such.

This can be done using the `+attr_*+` directives.

As we mark the original method as `:nodoc:` a documentation line above
the original method is required. Otherwise the `+attr_*+` directive is
ingored:

      # :attr_writer: some_attr

      # Required documentation line
      def some_attr=(value) # :nodoc:

In the following example `colorize_logging` is marked as an attribute and
not present in the methods section.

<img width=""554"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/154564753-49c1f204-14b8-4828-b280-2a2eff7e0f64.png"">
",https://api.github.com/repos/rails/rails/issues/44466/timeline,,p8,28561,MDQ6VXNlcjI4NTYx,https://avatars.githubusercontent.com/u/28561?v=4,,https://api.github.com/users/p8,https://github.com/p8,https://api.github.com/users/p8/followers,https://api.github.com/users/p8/following{/other_user},https://api.github.com/users/p8/gists{/gist_id},https://api.github.com/users/p8/starred{/owner}{/repo},https://api.github.com/users/p8/subscriptions,https://api.github.com/users/p8/orgs,https://api.github.com/users/p8/repos,https://api.github.com/users/p8/events{/privacy},https://api.github.com/users/p8/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44466/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44466,https://github.com/rails/rails/pull/44466,https://github.com/rails/rails/pull/44466.diff,https://github.com/rails/rails/pull/44466.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
151,https://api.github.com/repos/rails/rails/issues/44465,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44465/labels{/name},https://api.github.com/repos/rails/rails/issues/44465/comments,https://api.github.com/repos/rails/rails/issues/44465/events,https://github.com/rails/rails/issues/44465,1141712918,I_kwDNIULORA0oFg,44465,[activerecord] `numericality: {in: ...}` should accept an Array or Set of explicit values,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-02-17T18:38:38Z,2022-02-25T22:19:57Z,,CONTRIBUTOR,,"In order to be consistent with `inclusion: {in: ...}`, it should be possible to pass an Array or Set of literal Integer values to `numericality: {in: ...}`, instead of only a Range.

### Steps to reproduce

#### Gemfile

```ruby
source 'https://rubygems.org/'

gem 'activerecord', '~> 7.0'
gem 'sqlite3'
```

#### test.rb

```ruby
require 'bundler/setup'
require 'active_record'

class CreateTestModelTable < ActiveRecord::Migration[7.0]

  def change
    create_table :test_models do |t|
      t.integer :ip_version
    end
  end

end

ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')

CreateTestModelTable.migrate(:up)

class TestModel < ActiveRecord::Base

  attribute :ip_version, :integer
  validates :ip_version, numericality: {in: [4,6]}

end
TestModel.connection

record = TestModel.new(ip_version: 4)
p record.valid?
p record.errors
```

### Expected behavior

`numericality: {in: ...}` accepts an Array of literal Integer values and validates against them.

### Actual behavior

```
==  CreateTestModelTable: migrating ===========================================
-- create_table(:test_models)
   -> 0.0007s
==  CreateTestModelTable: migrated (0.0008s) ==================================

/home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/numericality.rb:29:in `block in check_validity!': :in must be a range (ArgumentError)
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/numericality.rb:27:in `each'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/numericality.rb:27:in `check_validity!'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validator.rb:142:in `initialize'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:86:in `new'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:86:in `block in validates_with'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:85:in `each'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/with.rb:85:in `validates_with'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/validates.rb:126:in `block in validates'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/validates.rb:115:in `each'
	from /home/postmodern/test/ruby/active_record/vendor/bundle/ruby/3.0.0/gems/activemodel-7.0.2.2/lib/active_model/validations/validates.rb:115:in `validates'
	from test.rb:21:in `<class:TestModel>'
	from test.rb:18:in `<main>'
```

### System configuration

* activerecord 7.0.2.2
* ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]",https://api.github.com/repos/rails/rails/issues/44465/timeline,,postmodern,12671,MDQ6VXNlcjEyNjcx,https://avatars.githubusercontent.com/u/12671?v=4,,https://api.github.com/users/postmodern,https://github.com/postmodern,https://api.github.com/users/postmodern/followers,https://api.github.com/users/postmodern/following{/other_user},https://api.github.com/users/postmodern/gists{/gist_id},https://api.github.com/users/postmodern/starred{/owner}{/repo},https://api.github.com/users/postmodern/subscriptions,https://api.github.com/users/postmodern/orgs,https://api.github.com/users/postmodern/repos,https://api.github.com/users/postmodern/events{/privacy},https://api.github.com/users/postmodern/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44465/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
152,https://api.github.com/repos/rails/rails/issues/44460,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44460/labels{/name},https://api.github.com/repos/rails/rails/issues/44460/comments,https://api.github.com/repos/rails/rails/issues/44460/events,https://github.com/rails/rails/issues/44460,1141397868,I_kwDNIULORAhZbA,44460,validates_with can't be used with multiple Validators when the options hash must contain :attributes,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-17T14:17:53Z,2022-02-18T21:51:11Z,,NONE,,"The `ActiveModel::EachValidator`
[deletes](https://github.com/rails/rails/blob/7-0-stable/activemodel/lib/active_model/validator.rb#L139) the `:attributes` key from the provided options hash.

When I use `validates_with` with multiple validators that require an `:attribute` options, I get an exception,
because the `options` hash is [reused](https://github.com/rails/rails/blob/7-0-stable/activemodel/lib/active_model/validations/with.rb#L142) and altered under the hood.

### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string :name
  end
end

class Post < ActiveRecord::Base
  validate :my_validations

  def my_validations
     validates_with ActiveRecord::Validations::UniquenessValidator, ActiveRecord::Validations::PresenceValidator, { attributes: [:name], allow_nil: true }
  end
end

class BugTest < Minitest::Test
  def test_validations
    post = Post.new name: 'a' 

    assert post.valid?
  end
end
```

### Expected behavior

This test should pass. `validates_with` should pass a duplicate of the option hash to the validators or 
`ActiveModel::EachValidator` should duplicate the options hash before modifying it.

### Actual behavior

An `ArgumentError`: `:attributes` cannot be blank

### System configuration
**Rails version**: 6.1, 7.0

**Ruby version**:  2.7.5
",https://api.github.com/repos/rails/rails/issues/44460/timeline,,dspaeth-lp,94361863,U_kgDOBZ_ZBw,https://avatars.githubusercontent.com/u/94361863?v=4,,https://api.github.com/users/dspaeth-lp,https://github.com/dspaeth-lp,https://api.github.com/users/dspaeth-lp/followers,https://api.github.com/users/dspaeth-lp/following{/other_user},https://api.github.com/users/dspaeth-lp/gists{/gist_id},https://api.github.com/users/dspaeth-lp/starred{/owner}{/repo},https://api.github.com/users/dspaeth-lp/subscriptions,https://api.github.com/users/dspaeth-lp/orgs,https://api.github.com/users/dspaeth-lp/repos,https://api.github.com/users/dspaeth-lp/events{/privacy},https://api.github.com/users/dspaeth-lp/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44460/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
153,https://api.github.com/repos/rails/rails/issues/44453,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44453/labels{/name},https://api.github.com/repos/rails/rails/issues/44453/comments,https://api.github.com/repos/rails/rails/issues/44453/events,https://github.com/rails/rails/issues/44453,1140682767,I_kwDNIULOQ_1wDw,44453,`# :nodoc:` on ActiveModel::Errors#copy!,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-16T23:13:05Z,2022-02-17T21:26:29Z,,NONE,,"`ActiveModel::Errors#copy!` is a useful method, but it does not appear in the documentation.

Is there some reason this is marked with `# :nodoc:`?

https://github.com/rails/rails/blob/0dbe699d5cd2b57a4a253283a7d7b7ffdd74db28/activemodel/lib/active_model/errors.rb#L102-L115",https://api.github.com/repos/rails/rails/issues/44453/timeline,,jameno,25379576,MDQ6VXNlcjI1Mzc5NTc2,https://avatars.githubusercontent.com/u/25379576?v=4,,https://api.github.com/users/jameno,https://github.com/jameno,https://api.github.com/users/jameno/followers,https://api.github.com/users/jameno/following{/other_user},https://api.github.com/users/jameno/gists{/gist_id},https://api.github.com/users/jameno/starred{/owner}{/repo},https://api.github.com/users/jameno/subscriptions,https://api.github.com/users/jameno/orgs,https://api.github.com/users/jameno/repos,https://api.github.com/users/jameno/events{/privacy},https://api.github.com/users/jameno/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44453/reactions,1,0,0,0,0,0,0,0,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
154,https://api.github.com/repos/rails/rails/issues/44446,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44446/labels{/name},https://api.github.com/repos/rails/rails/issues/44446/comments,https://api.github.com/repos/rails/rails/issues/44446/events,https://github.com/rails/rails/pull/44446,1139837139,PR_kwDNIULOMuq0_A,44446,Active Record API for general async queries,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,13,2022-02-16T10:38:20Z,2022-04-14T16:21:26Z,,CONTRIBUTOR,,"Followup: https://github.com/rails/rails/pull/41372
Fix: https://github.com/rails/rails/issues/44169

Something we knew we'd need when we implemented `Relation#load_async` but that we chose to delay to have time to think about it.

Right now, Active Record async support is limited to ""collection results"", but among the not so fast queries that would benefit from asynchronicity you often find aggregates (e.g. `count`, `sum`, etc) as well as hand crafted `find_by_sql` queries.

`load_async` was easy to add as an API, because `Relation` acts as a collection so it was trivial to simply block whenever it was iterated while retaining total API compatibility.

For aggregates and `find_by_sql`, we have no other choice but to return something different in async mode, with its own API.

This proof of concept showcase what this API looks like for `Relation#count`:

```ruby
Post.where(published: true).count # => 2
promise = Post.where(published: true).async_count # => #<ActiveRecord::Promise status=pending>
promise.value # => 2
```

But this API should be applicable to all aggregate methods, as well as all methods returning a single record, or anything other than a `Relation`.
",https://api.github.com/repos/rails/rails/issues/44446/timeline,,casperisfine,19192189,MDQ6VXNlcjE5MTkyMTg5,https://avatars.githubusercontent.com/u/19192189?v=4,,https://api.github.com/users/casperisfine,https://github.com/casperisfine,https://api.github.com/users/casperisfine/followers,https://api.github.com/users/casperisfine/following{/other_user},https://api.github.com/users/casperisfine/gists{/gist_id},https://api.github.com/users/casperisfine/starred{/owner}{/repo},https://api.github.com/users/casperisfine/subscriptions,https://api.github.com/users/casperisfine/orgs,https://api.github.com/users/casperisfine/repos,https://api.github.com/users/casperisfine/events{/privacy},https://api.github.com/users/casperisfine/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44446/reactions,17,0,0,0,0,0,12,5,0,False,https://api.github.com/repos/rails/rails/pulls/44446,https://github.com/rails/rails/pull/44446,https://github.com/rails/rails/pull/44446.diff,https://github.com/rails/rails/pull/44446.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
155,https://api.github.com/repos/rails/rails/issues/44438,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44438/labels{/name},https://api.github.com/repos/rails/rails/issues/44438/comments,https://api.github.com/repos/rails/rails/issues/44438/events,https://github.com/rails/rails/pull/44438,1138973641,PR_kwDNIULOMt9thQ,44438,Cast `ActiveSupport::Duration` to postgres interval (#44341),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}]",open,False,,[],,10,2022-02-15T17:06:52Z,2022-04-12T23:14:36Z,,NONE,,"### Summary

When passing an `ActiveSupport::Duration` as a bind in an array condition, the postgres adapter will now cast it to an ISO 8601 string. Previously it would be cast to an integer, which can't be used as an interval input.

```rb
Video.where('duration = ?', 1.hour) # ... WHERE duration = 'PT1H'
```

Note that this will break any code that depends on the previous behavior of a duration being cast to an integer number of seconds, for example assuming `duration_seconds` is an integer column: 
```rb
# previous behavior
Video.where('duration_seconds = ?', 1.hour) # ... WHERE duration_seconds = 3600

# new behavior
Video.where('duration_seconds = ?', 1.hour) # ... WHERE duration_seconds = 'PT1H'
# ActiveRecord::StatementInvalid (PG::InvalidTextRepresentation: ERROR:  invalid input syntax for integer: ""PT1H"")

```",https://api.github.com/repos/rails/rails/issues/44438/timeline,,aramgre,10539627,MDQ6VXNlcjEwNTM5NjI3,https://avatars.githubusercontent.com/u/10539627?v=4,,https://api.github.com/users/aramgre,https://github.com/aramgre,https://api.github.com/users/aramgre/followers,https://api.github.com/users/aramgre/following{/other_user},https://api.github.com/users/aramgre/gists{/gist_id},https://api.github.com/users/aramgre/starred{/owner}{/repo},https://api.github.com/users/aramgre/subscriptions,https://api.github.com/users/aramgre/orgs,https://api.github.com/users/aramgre/repos,https://api.github.com/users/aramgre/events{/privacy},https://api.github.com/users/aramgre/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44438/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44438,https://github.com/rails/rails/pull/44438,https://github.com/rails/rails/pull/44438.diff,https://github.com/rails/rails/pull/44438.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
156,https://api.github.com/repos/rails/rails/issues/44429,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44429/labels{/name},https://api.github.com/repos/rails/rails/issues/44429/comments,https://api.github.com/repos/rails/rails/issues/44429/events,https://github.com/rails/rails/pull/44429,1137705858,PR_kwDNIULOMs6f7w,44429,Update tests and docs for ActiveRecord::Sanitization,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-14T18:52:24Z,2022-02-16T09:24:10Z,,CONTRIBUTOR,,"## Summary

In trying to write some failing test cases for #44312, I found that most of [`ActiveRecord::Sanitization`](https://github.com/rails/rails/blob/7ac90d9ad75c50129850572ed6c7dcd42fecbf3b/activerecord/lib/active_record/sanitization.rb) is untested. [Only a subset of it has test coverage](https://github.com/rails/rails/blob/7ac90d9ad75c50129850572ed6c7dcd42fecbf3b/activerecord/test/cases/sanitize_test.rb), and much of that coverage is agnostic to the underlying connection adapter.

And that last part is the interesting part. The result of all but one of the public sanitization methods in this module **depend on the current `ActiveRecord::Base.connection` to decide how to escape the string**, and that is not reflected in docs or in tests.

I have added comprehensive test coverage local to each adapter. The tests use all the examples in the inline docs, many of which were wrong. 

Next, I will use the tests to work on #44404, and they also would have caught the regression in #44312. I updated the docs to reflect the connection dependent behaviour, and updated the cases where the output shown was not what is actually output. I have opted to use the SQLite3/PostgreSQL behaviour in docs as they are both (currently) the same, and presumably SQLite3 is the simplest use case.

I understand that typically PRs of just tests are not merged. Feedback welcome.

@rafaelfranca @byroot ",https://api.github.com/repos/rails/rails/issues/44429/timeline,,kmcphillips,84159,MDQ6VXNlcjg0MTU5,https://avatars.githubusercontent.com/u/84159?v=4,,https://api.github.com/users/kmcphillips,https://github.com/kmcphillips,https://api.github.com/users/kmcphillips/followers,https://api.github.com/users/kmcphillips/following{/other_user},https://api.github.com/users/kmcphillips/gists{/gist_id},https://api.github.com/users/kmcphillips/starred{/owner}{/repo},https://api.github.com/users/kmcphillips/subscriptions,https://api.github.com/users/kmcphillips/orgs,https://api.github.com/users/kmcphillips/repos,https://api.github.com/users/kmcphillips/events{/privacy},https://api.github.com/users/kmcphillips/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44429/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44429,https://github.com/rails/rails/pull/44429,https://github.com/rails/rails/pull/44429.diff,https://github.com/rails/rails/pull/44429.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
157,https://api.github.com/repos/rails/rails/issues/44416,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44416/labels{/name},https://api.github.com/repos/rails/rails/issues/44416/comments,https://api.github.com/repos/rails/rails/issues/44416/events,https://github.com/rails/rails/issues/44416,1134846205,I_kwDNIULOQ6Rg_Q,44416,ActionCable ignores WebSocket protocol making the connection close with status 1066,"[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-13T00:13:22Z,2022-02-14T20:40:04Z,,CONTRIBUTOR,,"## Proof of Concept
http://action-cable-protocol.herokuapp.com/

## Context
Some firmwares communicate using WebSockets specifying the WebSocket protocol argument. If the protocol is specified, the `/cable` endpoint should upgrade the connection instead of closing it with status 1066.

### Connect WebSocket to ActionCable without a protocol header
It works if the websocket receive no protocol param
```
websocket = new WebSocket('http://localhost/cable');
```
### WebSocket to ActionCable passing null protocol header
This code fails with status error = 1066
```
websocket = new WebSocket('http://localhost/cable', null);
```
### WebSocket to ActionCable passing custom protocol header
This code fails with status error = 1066
```
websocket = new WebSocket('http://localhost/cable', 'custom');
```
### Possible Cause
The `ActionCable::Connection::WebSocket` constructor defines a named argument `protocols` https://github.com/rails/rails/blob/f9a1671c182eb2ed5fb159f154bc03195bcb7238/actioncable/lib/action_cable/connection/web_socket.rb#L8-L11
which default is `ActionCable::INTERNAL[:protocols]`:
```
irb(main):001:0> ActionCable::INTERNAL[:protocols]
=> [""actioncable-v1-json"", ""actioncable-unsupported""]
```
However, the WebSocket protocol header is not passed when the object is instantiated https://github.com/rails/rails/blob/f9a1671c182eb2ed5fb159f154bc03195bcb7238/actioncable/lib/action_cable/connection/base.rb#L61

### Monkey Patch
The following monkey patch (proof of concept) overrides the `Action::Cable::Connection::Base` constructor to initialize the WebSocket with the proper protocols argument.
```
  module ActionCable
    module Connection
      class Base
        def initialize(server, env, coder: ActiveSupport::JSON)
          @server, @env, @coder = server, env, coder

          @worker_pool = server.worker_pool
          @logger = new_tagged_logger

          if Rack::Request.new(env).params['patch_action_cable']
            @websocket    = ActionCable::Connection::WebSocket.new env,
              self, event_loop, protocols: @env['HTTP_SEC_WEBSOCKET_PROTOCOL']
          else
            @websocket    = ActionCable::Connection::WebSocket.new(env, self, event_loop)
          end
          @subscriptions  = ActionCable::Connection::Subscriptions.new(self)
          @message_buffer = ActionCable::Connection::MessageBuffer.new(self)

          @_internal_subscriptions = nil
          @started_at = Time.now
        end
      end
    end
  end
```",https://api.github.com/repos/rails/rails/issues/44416/timeline,,fabiolnm,508671,MDQ6VXNlcjUwODY3MQ==,https://avatars.githubusercontent.com/u/508671?v=4,,https://api.github.com/users/fabiolnm,https://github.com/fabiolnm,https://api.github.com/users/fabiolnm/followers,https://api.github.com/users/fabiolnm/following{/other_user},https://api.github.com/users/fabiolnm/gists{/gist_id},https://api.github.com/users/fabiolnm/starred{/owner}{/repo},https://api.github.com/users/fabiolnm/subscriptions,https://api.github.com/users/fabiolnm/orgs,https://api.github.com/users/fabiolnm/repos,https://api.github.com/users/fabiolnm/events{/privacy},https://api.github.com/users/fabiolnm/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44416/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
158,https://api.github.com/repos/rails/rails/issues/44412,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44412/labels{/name},https://api.github.com/repos/rails/rails/issues/44412/comments,https://api.github.com/repos/rails/rails/issues/44412/events,https://github.com/rails/rails/pull/44412,1133878809,PR_kwDNIULOMpfiBQ,44412,Update action_text/index.js,"[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,0,2022-02-12T11:06:22Z,2022-02-12T11:06:25Z,,NONE,,"For webpack 6, it should be changed this way.

### Summary

I'm trying to use Shakapacker in my Webpack application. Everything works, but Actiontext collapses because of this line. ",https://api.github.com/repos/rails/rails/issues/44412/timeline,,Tarbetu,40325625,MDQ6VXNlcjQwMzI1NjI1,https://avatars.githubusercontent.com/u/40325625?v=4,,https://api.github.com/users/Tarbetu,https://github.com/Tarbetu,https://api.github.com/users/Tarbetu/followers,https://api.github.com/users/Tarbetu/following{/other_user},https://api.github.com/users/Tarbetu/gists{/gist_id},https://api.github.com/users/Tarbetu/starred{/owner}{/repo},https://api.github.com/users/Tarbetu/subscriptions,https://api.github.com/users/Tarbetu/orgs,https://api.github.com/users/Tarbetu/repos,https://api.github.com/users/Tarbetu/events{/privacy},https://api.github.com/users/Tarbetu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44412/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44412,https://github.com/rails/rails/pull/44412,https://github.com/rails/rails/pull/44412.diff,https://github.com/rails/rails/pull/44412.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
159,https://api.github.com/repos/rails/rails/issues/44401,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44401/labels{/name},https://api.github.com/repos/rails/rails/issues/44401/comments,https://api.github.com/repos/rails/rails/issues/44401/events,https://github.com/rails/rails/issues/44401,1132643031,I_kwDNIULOQ4LC1w,44401,Arel::UpdateManager with join statement on a sqlite and postgres database are invalid,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,1,2022-02-11T14:00:28Z,2022-03-12T02:07:26Z,,NONE,,"### Steps to reproduce
complex update with joins produce invalid sql syntax with sqlite and postgres.
the following test [it ""generates an update statement with joins""](https://github.com/rails/rails/blob/b961af3345fe2f9e492ba1e5424c2ceb75ac6ead/activerecord/test/cases/arel/update_manager_test.rb#L122-L133) is checking an sql query that is invalid in sqlite and postgres.

this is how [postgres update syntax](https://www.postgresql.org/docs/current/sql-update.html) can be and how [sqlite update syntax
](https://sqlite.org/lang_update.html) is defined. To join table during an update we should use the `FROM`.
it seems that it's a [syntax only valid in mysql](https://dev.mysql.com/doc/refman/8.0/en/update.html).

```ruby
# frozen_string_literal: true

require 'bundler/inline'

gemfile(true) do
  source 'https://rubygems.org'

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem 'rails', github: 'rails/rails', branch: 'main'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
    t.integer :posts_count
  end

  create_table :posts, force: true do |t|
    t.integer :user_id
  end
end

class BugTest < ActiveSupport::TestCase
  def test_update_with_joins
    um = Arel::UpdateManager.new

    table = Arel::Table.new(:users)
    join_table = Arel::Table.new(:posts)
    join_source = Arel::Nodes::JoinSource.new(
      table,
      [table.create_join(join_table)]
    )

    um.table join_source
    um.set [[table[:posts_count], join_table[:id].count]]
    assert_nothing_raised { ActiveRecord::Base.connection.update(um) }
  end
end
```

### Expected behavior
it should be possible to set the `FROM` to join other tables. and at the end generate the following sql `UPDATE ""users"" SET  ""posts_count"" = COUNT(""posts"".""id"") FROM ""posts"" WHERE ""users"".""id"" = ""posts"".""user_id""`.

for example with the following syntax:
```ruby
table = Arel::Table.new(:users)
join_table = Arel::Table.new(:posts)

um.table table
um.from join_table
um.set [[table[:posts_count], join_table[:id].count]]
um.where table[:id].eq(join_table[:user_id])
ActiveRecord::Base.connection.update(um)
```

### Actual behavior
for now, it generate the following sql `UPDATE ""users"" INNER JOIN ""posts"" SET ""posts_count"" = COUNT(""posts"".""id"")` that is an invalid syntax

### System configuration
**Rails version**: 7.0.1

**Ruby version**: 3.1
",https://api.github.com/repos/rails/rails/issues/44401/timeline,,gagalago,519226,MDQ6VXNlcjUxOTIyNg==,https://avatars.githubusercontent.com/u/519226?v=4,,https://api.github.com/users/gagalago,https://github.com/gagalago,https://api.github.com/users/gagalago/followers,https://api.github.com/users/gagalago/following{/other_user},https://api.github.com/users/gagalago/gists{/gist_id},https://api.github.com/users/gagalago/starred{/owner}{/repo},https://api.github.com/users/gagalago/subscriptions,https://api.github.com/users/gagalago/orgs,https://api.github.com/users/gagalago/repos,https://api.github.com/users/gagalago/events{/privacy},https://api.github.com/users/gagalago/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44401/reactions,1,0,0,0,0,0,0,0,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
160,https://api.github.com/repos/rails/rails/issues/44400,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44400/labels{/name},https://api.github.com/repos/rails/rails/issues/44400/comments,https://api.github.com/repos/rails/rails/issues/44400/events,https://github.com/rails/rails/issues/44400,1132642872,I_kwDNIULOQ4LCOA,44400,ActiveRecord::RecordNotFound error in fixture array when deleting or destroying objects through model callbacks during test execution,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-02-11T14:00:22Z,2022-02-11T23:10:58Z,,NONE,,"I wrote a test case which verifies if children(B model) objects are deleted from database after their parent(A model) is deleted. The parent object is always deleted successfully, but for some reason the children fixtures array ends up being broken and failing the test with an unexpected error. The error message is as follows:

```
Error:
ATest#test_destroying_A_should_delete_all_associated_B:
ActiveRecord::RecordNotFound: Couldn't find B with 'id'=980190962
    test/models/a_test.rb:6:in `block in <class:ATest>'

```

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
##### Creating project
```ruby
rails new testing-fixtures
cd testing-fixtures
rails g model A
rails g model B
```
##### Migrations
```ruby
class CreateAs < ActiveRecord::Migration[7.0]
  def change
    create_table :as do |t|
      t.string :name
      t.timestamps
    end
  end
end
```
```ruby
class CreateBs < ActiveRecord::Migration[7.0]
  def change
    create_table :bs do |t|
      t.integer :a_id
      t.string :description
      t.timestamps
    end
  end
end
```
##### Fixtures

```yml
# A objects
one: {
  id: 1,
  name: 'A-object number 1'
}
```

```yml
# B objects
one: {
  a_id: 1,
  description: 'Belongs to A#1'
}
two: {
  a_id: 2,
  description: 'Belongs to A#2'
}
```
##### app/models/a.rb

```ruby
class A < ApplicationRecord
	after_destroy :delete_all_associated_bs

	def delete_all_associated_bs
		B.where(a_id: self.id).destroy_all
	end

end
```
##### test/models/a_test.rb

```ruby
require ""test_helper""

class ATest < ActiveSupport::TestCase
  test ""destroying A should delete all associated B"" do
    as(:one).destroy
    refute B.find(bs(:one)[:id]).present?
  end
end
```
##### Running migrations
`rails db:migrate`

##### Running test

`rails test test/models/a_test.rb`


### Expected behavior
<!-- Tell us what should happen -->

`bs` array should still contain both entries, while `B.all` should return an array containing only the `:two` object. The test case should pass.

### Actual behavior
<!-- Tell us what happens instead -->

Any interaction with `bs` array  (ex: executing `puts bs`,`bs.class`,`bs.nil?` on console ) triggers:
```
Error:
ATest#test_destroying_A_should_delete_all_associated_B:
ActiveRecord::RecordNotFound: Couldn't find B with 'id'=980190962
    test/models/a_test.rb:6:in `block in <class:ATest>'

```


### System configuration
**Rails version**: 7.0.2

**Ruby version**: ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-linux]
",https://api.github.com/repos/rails/rails/issues/44400/timeline,,jlucartc,18648391,MDQ6VXNlcjE4NjQ4Mzkx,https://avatars.githubusercontent.com/u/18648391?v=4,,https://api.github.com/users/jlucartc,https://github.com/jlucartc,https://api.github.com/users/jlucartc/followers,https://api.github.com/users/jlucartc/following{/other_user},https://api.github.com/users/jlucartc/gists{/gist_id},https://api.github.com/users/jlucartc/starred{/owner}{/repo},https://api.github.com/users/jlucartc/subscriptions,https://api.github.com/users/jlucartc/orgs,https://api.github.com/users/jlucartc/repos,https://api.github.com/users/jlucartc/events{/privacy},https://api.github.com/users/jlucartc/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44400/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
161,https://api.github.com/repos/rails/rails/issues/44398,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44398/labels{/name},https://api.github.com/repos/rails/rails/issues/44398/comments,https://api.github.com/repos/rails/rails/issues/44398/events,https://github.com/rails/rails/pull/44398,1132060374,PR_kwDNIULOMn43Bg,44398,Remove LIMIT and OFFSET on relations when batch iterating,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-11T08:25:01Z,2022-02-11T08:25:04Z,,CONTRIBUTOR,,"When using `find_each`, `find_in_batches`, or `in_batches` on a relation with a specified limit, the batch relation yielded no longer propagates those values.

Other than being being useless or potentially problematic, the removal also eliminates a subquery under certain conditions when using `JOIN` with MySQL.

In the test cases I added, the queries executed go from: 

```sql
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL ORDER BY `posts`.`id` ASC LIMIT 3
DELETE FROM `posts` WHERE `posts`.`id` IN (SELECT `id` FROM (SELECT `posts`.`id` FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` IN (3, 6, 8) LIMIT 5) AS __active_record_temp)
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` > 8 ORDER BY `posts`.`id` ASC LIMIT 2
DELETE FROM `posts` WHERE `posts`.`id` IN (SELECT `id` FROM (SELECT `posts`.`id` FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` IN (9, 10) LIMIT 5) AS __active_record_temp)
```

To:

```sql
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL ORDER BY `posts`.`id` ASC LIMIT 3
DELETE `posts` FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` IN (3, 6, 8)
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` > 8 ORDER BY `posts`.`id` ASC LIMIT 2
DELETE `posts` FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` IN (9, 10).
```

And from:

```sql
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL ORDER BY `posts`.`id` ASC LIMIT 3 OFFSET 2
UPDATE `posts` SET `posts`.`legacy_comments_count` = 0 WHERE `posts`.`id` IN (SELECT `id` FROM (SELECT `posts`.`id` FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` IN (8, 9, 10) LIMIT 18446744073709551615 OFFSET 2) AS __active_record_temp)
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` > 10 ORDER BY `posts`.`id` ASC LIMIT 3 OFFSET 2
```

To: 

```sql
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL ORDER BY `posts`.`id` ASC LIMIT 3 OFFSET 2
UPDATE `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` SET `posts`.`legacy_comments_count` = 0 WHERE `comments`.`id` IS NULL AND `posts`.`id` IN (8, 9, 10)
SELECT `posts`.* FROM `posts` LEFT OUTER JOIN `comments` ON `comments`.`post_id` = `posts`.`id` WHERE `comments`.`id` IS NULL AND `posts`.`id` > 10 ORDER BY `posts`.`id` ASC LIMIT 3 OFFSET 2.
```

While both can cause improper query execution, the test cases shows the usage of `OFFSET` is much easier to trigger this issue compared to `LIMIT`.

I believe the subquery behavior with Postgres and SQLite is as expected, but I'm not as familiar with their internals.",https://api.github.com/repos/rails/rails/issues/44398/timeline,,drcapulet,50848,MDQ6VXNlcjUwODQ4,https://avatars.githubusercontent.com/u/50848?v=4,,https://api.github.com/users/drcapulet,https://github.com/drcapulet,https://api.github.com/users/drcapulet/followers,https://api.github.com/users/drcapulet/following{/other_user},https://api.github.com/users/drcapulet/gists{/gist_id},https://api.github.com/users/drcapulet/starred{/owner}{/repo},https://api.github.com/users/drcapulet/subscriptions,https://api.github.com/users/drcapulet/orgs,https://api.github.com/users/drcapulet/repos,https://api.github.com/users/drcapulet/events{/privacy},https://api.github.com/users/drcapulet/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44398/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44398,https://github.com/rails/rails/pull/44398,https://github.com/rails/rails/pull/44398.diff,https://github.com/rails/rails/pull/44398.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
162,https://api.github.com/repos/rails/rails/issues/44395,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44395/labels{/name},https://api.github.com/repos/rails/rails/issues/44395/comments,https://api.github.com/repos/rails/rails/issues/44395/events,https://github.com/rails/rails/issues/44395,1131126743,I_kwDNIULOQ2uf1w,44395,Tests related do #40226 fail.,"[{'id': 131864, 'node_id': 'MDU6TGFiZWwxMzE4NjQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/third%20party%20issue', 'name': 'third party issue', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-10T22:26:44Z,2022-02-16T23:39:47Z,,CONTRIBUTOR,,"### Steps to reproduce
Hello,

when creating an update for Fedora, the following 4 tests fail. 

Probably related to #40226.

### Actual behavior

```
Error:
ActiveStorage::VariantTest#test_optimized_variation_of_GIF_blob:
Vips::Error: VipsForeignSave: ""/tmp/image_processing20220210-1778-cjj2xp.gif"" is not a known file format
VipsForeignSave: ""/tmp/image_processing20220210-1778-cjj2xp.gif"" is not a known file format

    /usr/share/gems/gems/ruby-vips-2.1.4/lib/vips/image.rb:590:in `write_to_file'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/vips.rb:63:in `save_image'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/processor.rb:23:in `call'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:50:in `call_processor'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:28:in `block in call'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:64:in `create_tempfile'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/pipeline.rb:27:in `call'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/builder.rb:14:in `block in call!'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/builder.rb:21:in `instrument'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/builder.rb:13:in `call!'
    /usr/share/gems/gems/image_processing-1.12.1/lib/image_processing/chainable.rb:58:in `call'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/transformers/image_processing_transformer.rb:22:in `process'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/transformers/transformer.rb:22:in `transform'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variation.rb:56:in `block in transform'
    /usr/share/gems/gems/activesupport-7.0.2/lib/active_support/notifications.rb:208:in `instrument'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variation.rb:55:in `transform'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variant.rb:110:in `block in process'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/downloader.rb:15:in `block in open'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/downloader.rb:24:in `open_tempfile'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/downloader.rb:12:in `open'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/lib/active_storage/service.rb:90:in `open'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/blob.rb:301:in `open'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variant.rb:109:in `process'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/app/models/active_storage/variant.rb:64:in `processed'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:122:in `block (3 levels) in <class:VariantTest>'
    /usr/share/gems/gems/activesupport-7.0.2/lib/active_support/testing/assertions.rb:34:in assert_nothing_raised'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:121:in `block (2 levels) in <class:VariantTest>'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:218:in `process_variants_with'
    /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:120:in `block in <class:VariantTest>'

rails test /builddir/build/BUILD/activestorage-7.0.2/usr/share/gems/gems/activestorage-7.0.2/test/models/variant_test.rb:117
```
Same failures also for BMP, ICO and PSD.

I've also filed https://github.com/janko/image_processing/issues/98, but I'm not sure it's related in any way.

### System configuration
**Rails version**:
7.0.2

**Ruby version**:
3.1
",https://api.github.com/repos/rails/rails/issues/44395/timeline,,pvalena,15652483,MDQ6VXNlcjE1NjUyNDgz,https://avatars.githubusercontent.com/u/15652483?v=4,,https://api.github.com/users/pvalena,https://github.com/pvalena,https://api.github.com/users/pvalena/followers,https://api.github.com/users/pvalena/following{/other_user},https://api.github.com/users/pvalena/gists{/gist_id},https://api.github.com/users/pvalena/starred{/owner}{/repo},https://api.github.com/users/pvalena/subscriptions,https://api.github.com/users/pvalena/orgs,https://api.github.com/users/pvalena/repos,https://api.github.com/users/pvalena/events{/privacy},https://api.github.com/users/pvalena/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44395/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
163,https://api.github.com/repos/rails/rails/issues/44389,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44389/labels{/name},https://api.github.com/repos/rails/rails/issues/44389/comments,https://api.github.com/repos/rails/rails/issues/44389/events,https://github.com/rails/rails/pull/44389,1130308189,PR_kwDNIULOMmUW8w,44389,f.submit: Set the the value of the explicit `:value` option to the value of `data-disable-with` ,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-10T15:30:34Z,2022-03-04T10:50:32Z,,NONE,,"### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

When you give the value to `f.submit`, the same value sets to the value of `data-disable-with`.

```slim
= f.submit 'Submit', class: 'btn btn-primary'
```
```html
<input type=""submit"" name=""commit"" value=""Submit"" class=""btn btn-primary"" data-disable-with=""Submit"">
```

But when you give the `:value` option, two values are not the same.

```slim
= f.submit value: 'Submit', class: 'btn btn-primary'
```

```html
<input type=""submit"" name=""commit"" value=""Submit"" class=""btn btn-primary"" data-disable-with=""Create"">
```

`Create` seems to come from i18n as the default value. https://github.com/svenfuchs/rails-i18n/blob/99cfa35268ad20ec1193c670a7ee2a4705140a3d/rails/locale/en.yml#L151

This PR sets the value of `:value` option to the value of `data-disable-with`
",https://api.github.com/repos/rails/rails/issues/44389/timeline,,noriyotcp,5820754,MDQ6VXNlcjU4MjA3NTQ=,https://avatars.githubusercontent.com/u/5820754?v=4,,https://api.github.com/users/noriyotcp,https://github.com/noriyotcp,https://api.github.com/users/noriyotcp/followers,https://api.github.com/users/noriyotcp/following{/other_user},https://api.github.com/users/noriyotcp/gists{/gist_id},https://api.github.com/users/noriyotcp/starred{/owner}{/repo},https://api.github.com/users/noriyotcp/subscriptions,https://api.github.com/users/noriyotcp/orgs,https://api.github.com/users/noriyotcp/repos,https://api.github.com/users/noriyotcp/events{/privacy},https://api.github.com/users/noriyotcp/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44389/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44389,https://github.com/rails/rails/pull/44389,https://github.com/rails/rails/pull/44389.diff,https://github.com/rails/rails/pull/44389.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
164,https://api.github.com/repos/rails/rails/issues/44385,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44385/labels{/name},https://api.github.com/repos/rails/rails/issues/44385/comments,https://api.github.com/repos/rails/rails/issues/44385/events,https://github.com/rails/rails/pull/44385,1129627052,PR_kwDNIULOMluZAw,44385,Load activestorage services after the config has been initialised,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-10T08:26:03Z,2022-02-12T09:49:56Z,,CONTRIBUTOR,,"### Summary

This PR makes sure the services and service for `ActiveStorage::Blob` are set after the rails application has finished initializing. I've made these changes since I noticed the module attributes for ActiveStorage as well are set after the rails application has finished initializing. And I found it confusing as to why class attributes of `ActiveStorage::Blob` are not following the same pattern here.

(Apologies, if this PR does not help to add anything. I had noticed this, thought it needed a PR 😅)

Thanks!

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->",https://api.github.com/repos/rails/rails/issues/44385/timeline,,ghousemohamed,56545288,MDQ6VXNlcjU2NTQ1Mjg4,https://avatars.githubusercontent.com/u/56545288?v=4,,https://api.github.com/users/ghousemohamed,https://github.com/ghousemohamed,https://api.github.com/users/ghousemohamed/followers,https://api.github.com/users/ghousemohamed/following{/other_user},https://api.github.com/users/ghousemohamed/gists{/gist_id},https://api.github.com/users/ghousemohamed/starred{/owner}{/repo},https://api.github.com/users/ghousemohamed/subscriptions,https://api.github.com/users/ghousemohamed/orgs,https://api.github.com/users/ghousemohamed/repos,https://api.github.com/users/ghousemohamed/events{/privacy},https://api.github.com/users/ghousemohamed/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44385/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44385,https://github.com/rails/rails/pull/44385,https://github.com/rails/rails/pull/44385.diff,https://github.com/rails/rails/pull/44385.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
165,https://api.github.com/repos/rails/rails/issues/44380,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44380/labels{/name},https://api.github.com/repos/rails/rails/issues/44380/comments,https://api.github.com/repos/rails/rails/issues/44380/events,https://github.com/rails/rails/pull/44380,1129062924,PR_kwDNIULOMlPdmg,44380,Add `Model` type to Active Model attributes,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,1,2022-02-09T21:59:07Z,2022-02-18T22:53:53Z,,CONTRIBUTOR,,"
### Summary

The new Model type handles all operations on conversion around model representations, from POROs to hashes and database string/JSON columns.

Attributes that are specified as the Model type are required to also specify a class name, which will be used to cast the given values into model instances. On the database serialization side, the model is represented as a JSON, with its `AttributeSet` being serialized by the types of each respective attribute.



### Docs:

`type`: returns the :model symbol.

`serializable?`: checks if the given value is an instance of the model class that this type was initialized with, returning false otherwise.

`serialize`: returns a string with the JSON representation of the given model attributes. It achieves that by calling values_for_database in the model’s AttributeSet, and converts the hash received into a JSON string.

`deserialize`: this method expects a JSON string, supposed to be a serialized set of attributes of a model instance. It proceeds to convert the JSON into a Ruby hash, and then instantiates a new model of the appropriate class name with the Ruby hash as its attributes. The mass assignment will allow each attribute to be deserialized accordingly and stored in the instance’s attribute set.

`cast`: receives a value that is either a hash of attributes or a model instance. It then instantiates a new model based on the class name with the given attributes. This means that if a model is passed, a new instance with the same attribute values will be returned, but not the exact same object.

`changed_in_place?`: Accepts a raw serialized attribute set, deserializes it and compares it with the given model instance. If the deserialized model’s attribute set is equal to the given model’s attribute set, returns true, or false otherwise.

`assert_valid_value`: this method checks if the given value can be cast to the model class. It takes either a model or a hash of attributes. If the model is not the same class as the type’s class name, or if the given hash contains keys that do not belong to the class's attribute set, it raises an error.

### Other Information

`attributes_for_database` was copied from 
https://github.com/rails/rails/blob/caced273937cf61c9ed2056877e0c3cd6a6b6577/activerecord/lib/active_record/attribute_methods/before_type_cast.rb#L70
with an intention to only exist in Active Model, but kept in both places for simplicity of this PR

",https://api.github.com/repos/rails/rails/issues/44380/timeline,,nvasilevski,5512772,MDQ6VXNlcjU1MTI3NzI=,https://avatars.githubusercontent.com/u/5512772?v=4,,https://api.github.com/users/nvasilevski,https://github.com/nvasilevski,https://api.github.com/users/nvasilevski/followers,https://api.github.com/users/nvasilevski/following{/other_user},https://api.github.com/users/nvasilevski/gists{/gist_id},https://api.github.com/users/nvasilevski/starred{/owner}{/repo},https://api.github.com/users/nvasilevski/subscriptions,https://api.github.com/users/nvasilevski/orgs,https://api.github.com/users/nvasilevski/repos,https://api.github.com/users/nvasilevski/events{/privacy},https://api.github.com/users/nvasilevski/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44380/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44380,https://github.com/rails/rails/pull/44380,https://github.com/rails/rails/pull/44380.diff,https://github.com/rails/rails/pull/44380.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
166,https://api.github.com/repos/rails/rails/issues/44379,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44379/labels{/name},https://api.github.com/repos/rails/rails/issues/44379/comments,https://api.github.com/repos/rails/rails/issues/44379/events,https://github.com/rails/rails/pull/44379,1129034454,PR_kwDNIULOMlN-eA,44379,Add assertion to ensure `ActiveRecord::Migration::MIGRATOR_SALT` isn't changed,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-09T21:22:42Z,2022-02-11T15:47:54Z,,CONTRIBUTOR,,"### Summary
This PR introduces a single test assertion in 390ddf62fab1df06d6d0f1e5b364b1d95d746e54, which ensures that the constant `ActiveRecord::Migration::MIGRATOR_SALT` cannot be changed without a test also failing.

#### Context

This PR https://github.com/rails/rails/pull/22122 introduced a mechanism to prevent migrations from being run concurrently, using advisory locks. The lock is generated by multiplying a CRC32 hash (8 bit) with this salt (31 bit unsigned), to produce an advisory lock string.

**It is critical that this constant isn't changed across versions, as this would break backwards compatibility between migration versions.**



The second commit, ff8f7d753bdc267696aa43815f44a51412f7d738, simply prefers `assert_equal` and `assert_operator` over the basic `assert` usage, though I don't believe that change to be as important.

### Other Information

This information is encapsulated in the [original commit message](https://github.com/rails/rails/pull/22122/commits/2c2a8755460ec3d32ece91c9766dbd0304ece028), but I believe encoding it in the test specification offers more confidence.

It's a small change, but I believe its non trivial and makes Rails more robust to possible breakages. Because the salt is arbitrary, it could appear changeable, but this isn't really the case.


<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44379/timeline,,paarthmadan,8986140,MDQ6VXNlcjg5ODYxNDA=,https://avatars.githubusercontent.com/u/8986140?v=4,,https://api.github.com/users/paarthmadan,https://github.com/paarthmadan,https://api.github.com/users/paarthmadan/followers,https://api.github.com/users/paarthmadan/following{/other_user},https://api.github.com/users/paarthmadan/gists{/gist_id},https://api.github.com/users/paarthmadan/starred{/owner}{/repo},https://api.github.com/users/paarthmadan/subscriptions,https://api.github.com/users/paarthmadan/orgs,https://api.github.com/users/paarthmadan/repos,https://api.github.com/users/paarthmadan/events{/privacy},https://api.github.com/users/paarthmadan/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44379/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44379,https://github.com/rails/rails/pull/44379,https://github.com/rails/rails/pull/44379.diff,https://github.com/rails/rails/pull/44379.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
167,https://api.github.com/repos/rails/rails/issues/44378,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44378/labels{/name},https://api.github.com/repos/rails/rails/issues/44378/comments,https://api.github.com/repos/rails/rails/issues/44378/events,https://github.com/rails/rails/pull/44378,1128990506,PR_kwDNIULOMlLs7A,44378,Support all `:dependent` options for `has_one_attached` and `has_many_attached`,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-09T20:28:37Z,2022-02-09T20:28:41Z,,CONTRIBUTOR,,"Closes #44362

Originally, `dependent: false` was supported. Now this should be done as `dependent: nil` (as supported on `has_one`/`has_many`). Should we still support the `false` case?
 
cc @rafaelfranca ",https://api.github.com/repos/rails/rails/issues/44378/timeline,,fatkodima,5657035,MDQ6VXNlcjU2NTcwMzU=,https://avatars.githubusercontent.com/u/5657035?v=4,,https://api.github.com/users/fatkodima,https://github.com/fatkodima,https://api.github.com/users/fatkodima/followers,https://api.github.com/users/fatkodima/following{/other_user},https://api.github.com/users/fatkodima/gists{/gist_id},https://api.github.com/users/fatkodima/starred{/owner}{/repo},https://api.github.com/users/fatkodima/subscriptions,https://api.github.com/users/fatkodima/orgs,https://api.github.com/users/fatkodima/repos,https://api.github.com/users/fatkodima/events{/privacy},https://api.github.com/users/fatkodima/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44378/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44378,https://github.com/rails/rails/pull/44378,https://github.com/rails/rails/pull/44378.diff,https://github.com/rails/rails/pull/44378.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
168,https://api.github.com/repos/rails/rails/issues/44372,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44372/labels{/name},https://api.github.com/repos/rails/rails/issues/44372/comments,https://api.github.com/repos/rails/rails/issues/44372/events,https://github.com/rails/rails/pull/44372,1128480860,PR_kwDNIULOMkw9vA,44372,Raise exception if Active Storage is configured and `config.active_storage.service` is not explicitly set,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2022-02-09T12:30:40Z,2022-02-25T21:31:52Z,,CONTRIBUTOR,,"### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

If `config.active_storage.service` has not been explicitly set in the respective environment's configuration file, then trying to use active storage throws a vague error message, which makes it harder to debug. This was the following error I had gotten:

```
Failed to replace attachments_attachments because one or more of the new records could not be saved.
```

Turned out I had forgotten to explicitly specify `config.active_storage.service` in my configuration file. Specifying it resolved the issue.

I had spent a considerable amount of time trying to debug this, and I would have immediately known what the fix was if the error message had been clearer. So, I'm turning in this PR so that anyone facing this in the future will know what to do at a quick glance.

Thanks 😁!
### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44372/timeline,,ghousemohamed,56545288,MDQ6VXNlcjU2NTQ1Mjg4,https://avatars.githubusercontent.com/u/56545288?v=4,,https://api.github.com/users/ghousemohamed,https://github.com/ghousemohamed,https://api.github.com/users/ghousemohamed/followers,https://api.github.com/users/ghousemohamed/following{/other_user},https://api.github.com/users/ghousemohamed/gists{/gist_id},https://api.github.com/users/ghousemohamed/starred{/owner}{/repo},https://api.github.com/users/ghousemohamed/subscriptions,https://api.github.com/users/ghousemohamed/orgs,https://api.github.com/users/ghousemohamed/repos,https://api.github.com/users/ghousemohamed/events{/privacy},https://api.github.com/users/ghousemohamed/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44372/reactions,2,1,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/44372,https://github.com/rails/rails/pull/44372,https://github.com/rails/rails/pull/44372.diff,https://github.com/rails/rails/pull/44372.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
169,https://api.github.com/repos/rails/rails/issues/44370,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44370/labels{/name},https://api.github.com/repos/rails/rails/issues/44370/comments,https://api.github.com/repos/rails/rails/issues/44370/events,https://github.com/rails/rails/pull/44370,1128363017,PR_kwDNIULOMkqrlg,44370,Provide change summary before details for all gems,[],open,False,,[],,0,2022-02-09T10:43:52Z,2022-02-09T10:43:52Z,,NONE,,"Update announcement template to have summary of changes since previous release before the details for each gem.

### Summary

The release announcement includes the details for each gem first and then only the summary of changes. I think it's better to have the summary first so that someone can scan changes since last release more quickly and at one shot, see which items have not been changed at all. This reorders it in the template.
",https://api.github.com/repos/rails/rails/issues/44370/timeline,,mohits,56816,MDQ6VXNlcjU2ODE2,https://avatars.githubusercontent.com/u/56816?v=4,,https://api.github.com/users/mohits,https://github.com/mohits,https://api.github.com/users/mohits/followers,https://api.github.com/users/mohits/following{/other_user},https://api.github.com/users/mohits/gists{/gist_id},https://api.github.com/users/mohits/starred{/owner}{/repo},https://api.github.com/users/mohits/subscriptions,https://api.github.com/users/mohits/orgs,https://api.github.com/users/mohits/repos,https://api.github.com/users/mohits/events{/privacy},https://api.github.com/users/mohits/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44370/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44370,https://github.com/rails/rails/pull/44370,https://github.com/rails/rails/pull/44370.diff,https://github.com/rails/rails/pull/44370.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
170,https://api.github.com/repos/rails/rails/issues/44362,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44362/labels{/name},https://api.github.com/repos/rails/rails/issues/44362/comments,https://api.github.com/repos/rails/rails/issues/44362/events,https://github.com/rails/rails/issues/44362,1127534361,I_kwDNIULOQzTPGQ,44362,Handle dependent: nil on ActiveStorage attachments,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,5,2022-02-08T17:13:44Z,2022-02-08T22:50:42Z,,NONE,,"### Steps to reproduce

Setting `has_one_attached :content, dependent: nil` on an ActiveRecord model does not work as expected.

### Expected behavior

When calling destroy on the record which has `has_one_attached :content, dependent: nil` set, I would expect the attachment and blob to not be destroyed.

### Actual behavior

The attachment does get destroyed. 

### System configuration
**Rails version**: 6.1

**Ruby version**: 2.7.5
",https://api.github.com/repos/rails/rails/issues/44362/timeline,,ryanseys,163873,MDQ6VXNlcjE2Mzg3Mw==,https://avatars.githubusercontent.com/u/163873?v=4,,https://api.github.com/users/ryanseys,https://github.com/ryanseys,https://api.github.com/users/ryanseys/followers,https://api.github.com/users/ryanseys/following{/other_user},https://api.github.com/users/ryanseys/gists{/gist_id},https://api.github.com/users/ryanseys/starred{/owner}{/repo},https://api.github.com/users/ryanseys/subscriptions,https://api.github.com/users/ryanseys/orgs,https://api.github.com/users/ryanseys/repos,https://api.github.com/users/ryanseys/events{/privacy},https://api.github.com/users/ryanseys/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44362/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
171,https://api.github.com/repos/rails/rails/issues/44353,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44353/labels{/name},https://api.github.com/repos/rails/rails/issues/44353/comments,https://api.github.com/repos/rails/rails/issues/44353/events,https://github.com/rails/rails/pull/44353,1125679906,PR_kwDNIULOMiey2A,44353,Mention Shakapacker for the updated Webpacker.,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,3,2022-02-07T08:42:56Z,2022-02-14T11:18:20Z,,CONTRIBUTOR,,"### Summary

Doc update for mentioning Shakapacker for the updated Webpacker.

",https://api.github.com/repos/rails/rails/issues/44353/timeline,,justin808,1118459,MDQ6VXNlcjExMTg0NTk=,https://avatars.githubusercontent.com/u/1118459?v=4,,https://api.github.com/users/justin808,https://github.com/justin808,https://api.github.com/users/justin808/followers,https://api.github.com/users/justin808/following{/other_user},https://api.github.com/users/justin808/gists{/gist_id},https://api.github.com/users/justin808/starred{/owner}{/repo},https://api.github.com/users/justin808/subscriptions,https://api.github.com/users/justin808/orgs,https://api.github.com/users/justin808/repos,https://api.github.com/users/justin808/events{/privacy},https://api.github.com/users/justin808/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44353/reactions,2,2,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44353,https://github.com/rails/rails/pull/44353,https://github.com/rails/rails/pull/44353.diff,https://github.com/rails/rails/pull/44353.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
172,https://api.github.com/repos/rails/rails/issues/44351,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44351/labels{/name},https://api.github.com/repos/rails/rails/issues/44351/comments,https://api.github.com/repos/rails/rails/issues/44351/events,https://github.com/rails/rails/issues/44351,1125413794,I_kwDNIULOQxRzog,44351,Add an index to the guides,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-07T01:53:30Z,2022-03-18T18:24:52Z,,NONE,,"I wanted to know how to deal with file uploads in the controller, and a bit of googling finally turned up the `form.file_field` tag, which made me realise the docs would be under form helpers. Perhaps obvious in retrospect, but as someone learning rails I didn't think of it at the time. It would be super useful to have a flat alphabetical index of everything in the guides, so that e.g. the link to `form.file_field` would be there under ""File uploads"" and ""Uploads"".",https://api.github.com/repos/rails/rails/issues/44351/timeline,,martindemello,16215,MDQ6VXNlcjE2MjE1,https://avatars.githubusercontent.com/u/16215?v=4,,https://api.github.com/users/martindemello,https://github.com/martindemello,https://api.github.com/users/martindemello/followers,https://api.github.com/users/martindemello/following{/other_user},https://api.github.com/users/martindemello/gists{/gist_id},https://api.github.com/users/martindemello/starred{/owner}{/repo},https://api.github.com/users/martindemello/subscriptions,https://api.github.com/users/martindemello/orgs,https://api.github.com/users/martindemello/repos,https://api.github.com/users/martindemello/events{/privacy},https://api.github.com/users/martindemello/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44351/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
173,https://api.github.com/repos/rails/rails/issues/44349,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44349/labels{/name},https://api.github.com/repos/rails/rails/issues/44349/comments,https://api.github.com/repos/rails/rails/issues/44349/events,https://github.com/rails/rails/pull/44349,1125336223,PR_kwDNIULOMiM54Q,44349,Improve handling of overlapping events,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,"[{'login': 'jhawthorn', 'id': 131752, 'node_id': 'MDQ6VXNlcjEzMTc1Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/131752?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jhawthorn', 'html_url': 'https://github.com/jhawthorn', 'followers_url': 'https://api.github.com/users/jhawthorn/followers', 'following_url': 'https://api.github.com/users/jhawthorn/following{/other_user}', 'gists_url': 'https://api.github.com/users/jhawthorn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jhawthorn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jhawthorn/subscriptions', 'organizations_url': 'https://api.github.com/users/jhawthorn/orgs', 'repos_url': 'https://api.github.com/users/jhawthorn/repos', 'events_url': 'https://api.github.com/users/jhawthorn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jhawthorn/received_events', 'type': 'User', 'site_admin': True}]",,1,2022-02-06T22:27:51Z,2022-02-17T00:55:48Z,,CONTRIBUTOR,,"fixes #44167 and #44348.

note that this does not fix every problem with this code, though.

one remaining (moderate?) issue is that events with the same name can still have incorrect data after this PR, if multiple of them overlap. e.g. the start times of `request.action_dispatch` will still be mixed up on a multi-threaded server. within the current framework, i think this could only be fixed by introducing something like an ""event UUID"" or ""event token"" (maybe just an `Object.new`). such a token could be passed to `#start` and `#finish`, and in `Fanout` we could use it for further isolating events from each other.

however, the amount of indirection and multi-dispatching in the `Notification` module is already pretty crazy for what it accomplishes, and i'm not sure how much more should be added.

it seems like a good candidate for refactoring, but i don't use it and don't know it well enough to do that.

so this is primarily a quickfix to get dev env less buggy again.

@jhawthorn adding you because you looked at a related PR, #43241",https://api.github.com/repos/rails/rails/issues/44349/timeline,,jaynetics,10758879,MDQ6VXNlcjEwNzU4ODc5,https://avatars.githubusercontent.com/u/10758879?v=4,,https://api.github.com/users/jaynetics,https://github.com/jaynetics,https://api.github.com/users/jaynetics/followers,https://api.github.com/users/jaynetics/following{/other_user},https://api.github.com/users/jaynetics/gists{/gist_id},https://api.github.com/users/jaynetics/starred{/owner}{/repo},https://api.github.com/users/jaynetics/subscriptions,https://api.github.com/users/jaynetics/orgs,https://api.github.com/users/jaynetics/repos,https://api.github.com/users/jaynetics/events{/privacy},https://api.github.com/users/jaynetics/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44349/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44349,https://github.com/rails/rails/pull/44349,https://github.com/rails/rails/pull/44349.diff,https://github.com/rails/rails/pull/44349.patch,,jhawthorn,131752.0,MDQ6VXNlcjEzMTc1Mg==,https://avatars.githubusercontent.com/u/131752?v=4,,https://api.github.com/users/jhawthorn,https://github.com/jhawthorn,https://api.github.com/users/jhawthorn/followers,https://api.github.com/users/jhawthorn/following{/other_user},https://api.github.com/users/jhawthorn/gists{/gist_id},https://api.github.com/users/jhawthorn/starred{/owner}{/repo},https://api.github.com/users/jhawthorn/subscriptions,https://api.github.com/users/jhawthorn/orgs,https://api.github.com/users/jhawthorn/repos,https://api.github.com/users/jhawthorn/events{/privacy},https://api.github.com/users/jhawthorn/received_events,User,True,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
174,https://api.github.com/repos/rails/rails/issues/44348,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44348/labels{/name},https://api.github.com/repos/rails/rails/issues/44348/comments,https://api.github.com/repos/rails/rails/issues/44348/events,https://github.com/rails/rails/issues/44348,1125333213,I_kwDNIULOQxM43Q,44348,`ActiveSupport::Notification`: bugs with overlapping events and subscriptions,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,"[{'login': 'jhawthorn', 'id': 131752, 'node_id': 'MDQ6VXNlcjEzMTc1Mg==', 'avatar_url': 'https://avatars.githubusercontent.com/u/131752?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jhawthorn', 'html_url': 'https://github.com/jhawthorn', 'followers_url': 'https://api.github.com/users/jhawthorn/followers', 'following_url': 'https://api.github.com/users/jhawthorn/following{/other_user}', 'gists_url': 'https://api.github.com/users/jhawthorn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jhawthorn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jhawthorn/subscriptions', 'organizations_url': 'https://api.github.com/users/jhawthorn/orgs', 'repos_url': 'https://api.github.com/users/jhawthorn/repos', 'events_url': 'https://api.github.com/users/jhawthorn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jhawthorn/received_events', 'type': 'User', 'site_admin': True}]",,2,2022-02-06T22:15:19Z,2022-02-17T09:33:40Z,,CONTRIBUTOR,,"this is a bunch of bugs i found while investigating https://github.com/rails/rails/issues/44167.

## bug 1: subscribing during an event causes errors

there is no handling for subscriptions/instrumentations that happen between the start and the end of an event. i've described the control flow in some detail [here]( https://github.com/rails/rails/issues/44167#issuecomment-1029015048 ).

- if the listeners internal stack is not initialized, i.e. an `instrumenter#finish` call happens after subscribing, but before the first `instrumenter#start` call, the stack is `nil` and there is a `NoMethodError`
- else, if at least one event starts before any event finishes, the stack will be initialized but depleted
  - for `EventObject` subscribers, this will cause a `NoMethodError`
  - for `Timed` subscribers, this will cause `Event#start` to be `nil`, which causes https://github.com/rails/rails/issues/44167

### example

```ruby
ActiveSupport::Notifications.instrumenter.start('bar', {})
ActiveSupport::Notifications.subscribe('bar') { |*args| }
ActiveSupport::Notifications.instrumenter.finish('bar', {})
# => undefined method `pop' for nil:NilClass (NoMethodError)

ActiveSupport::Notifications.instrumenter.start('bar', {})  # initialize stack
ActiveSupport::Notifications.instrumenter.finish('bar', {}) # OK
ActiveSupport::Notifications.instrumenter.finish('bar', {}) # start == nil
```

## bug 2: event data (times, payloads) leaks between multiple subscribers

because multiple subscribers (`Evented` instances) of the same type share a stack for all events that they match, they mishandle events with an overlapping duration.

this particular bug was also described in the abandoned PR https://github.com/rails/rails/pull/43241, but AFAICT that PR would have fixed only this one bug and only for a specific use case.

### example

```ruby
foo_events = []
bar_events = []
ActiveSupport::Notifications.subscribe('foo') { |e| foo_events << e }
ActiveSupport::Notifications.subscribe('bar') { |e| bar_events << e }

# puts foo data on shared stack
ActiveSupport::Notifications.instrumenter.start('foo', { name: 'FOO' })

# fetches foo data from shared stack
ActiveSupport::Notifications.instrumenter.finish('bar', { name: 'BAR' })

# resulting event is a mix of both events
foo_events.count      # => 0
bar_events.count      # => 1
bar_events[0].name    # => 'foo'            # name from foo event
bar_events[0].payload # => {:name => ""BAR""} # payload from bar event
bar_events[0].time    # => 1650862655       # start time from foo event
bar_events[0].end     # => 1650862656       # end time from bar event
```

## bug 3: event data leaks between events of a single subscriber

this is because individual subscribers use a shared stack for all types of events that they match.

### example

```ruby
events = []
ActiveSupport::Notifications.subscribe(/.*/) { |e| events << e }

ActiveSupport::Notifications.instrumenter.start('foo', { name: 'FOO' })
ActiveSupport::Notifications.instrumenter.finish('bar', { name: 'BAR' })

# resulting event is a mix of both events
events.count      # => 1
events[0].name    # => 'foo'            # name from foo event
events[0].payload # => {:name => ""BAR""} # payload from bar event
events[0].time    # => 1650862655       # start time from foo event
events[0].end     # => 1650862656       # end time from bar event
```",https://api.github.com/repos/rails/rails/issues/44348/timeline,,jaynetics,10758879,MDQ6VXNlcjEwNzU4ODc5,https://avatars.githubusercontent.com/u/10758879?v=4,,https://api.github.com/users/jaynetics,https://github.com/jaynetics,https://api.github.com/users/jaynetics/followers,https://api.github.com/users/jaynetics/following{/other_user},https://api.github.com/users/jaynetics/gists{/gist_id},https://api.github.com/users/jaynetics/starred{/owner}{/repo},https://api.github.com/users/jaynetics/subscriptions,https://api.github.com/users/jaynetics/orgs,https://api.github.com/users/jaynetics/repos,https://api.github.com/users/jaynetics/events{/privacy},https://api.github.com/users/jaynetics/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44348/reactions,0,0,0,0,0,0,0,0,0,,,,,,,jhawthorn,131752.0,MDQ6VXNlcjEzMTc1Mg==,https://avatars.githubusercontent.com/u/131752?v=4,,https://api.github.com/users/jhawthorn,https://github.com/jhawthorn,https://api.github.com/users/jhawthorn/followers,https://api.github.com/users/jhawthorn/following{/other_user},https://api.github.com/users/jhawthorn/gists{/gist_id},https://api.github.com/users/jhawthorn/starred{/owner}{/repo},https://api.github.com/users/jhawthorn/subscriptions,https://api.github.com/users/jhawthorn/orgs,https://api.github.com/users/jhawthorn/repos,https://api.github.com/users/jhawthorn/events{/privacy},https://api.github.com/users/jhawthorn/received_events,User,True,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
175,https://api.github.com/repos/rails/rails/issues/44341,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44341/labels{/name},https://api.github.com/repos/rails/rails/issues/44341/comments,https://api.github.com/repos/rails/rails/issues/44341/events,https://github.com/rails/rails/issues/44341,1125051948,I_kwDNIULOQw7uLA,44341,Postgres adapter does not cast ActiveSupport::Duration to interval in array condition,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}]",open,False,,[],,2,2022-02-05T23:06:22Z,2022-02-15T17:15:56Z,,NONE,,"When passing an `ActiveSupport::Duration` to an Active Record `where` query on Postgres, it will be converted to an ISO 8601 string in a hash condition on an `interval` column, but not in an array condition. 

For `interval` columns, it would be convenient to be able to pass `ActiveSupport::Duration` in either hash or array conditions. However, some applications probably depend on the existing behavior to pass `ActiveSupport::Duration` as a numeric type so any change might have to be opt-in.

### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""pg""
  gem ""byebug""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# docker run --rm -e POSTGRES_PASSWORD=postgres -p 9999:5432 postgres
ActiveRecord::Base.establish_connection(""postgres://postgres:postgres@localhost:9999/postgres"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :movies, force: true do |t|
    t.interval :runtime
  end
end

class Movie < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_duration
    Movie.create!(runtime: 2.hours)
    Movie.create!(runtime: 90.minutes)
    Movie.create!(runtime: 3.hours + 30.minutes)

    # SELECT COUNT(*) FROM ""movies"" WHERE ""movies"".""runtime"" < $1  [[""runtime"", ""PT3H""]]
    assert_equal 2, Movie.where(runtime: ...3.hours).count

    # SELECT COUNT(*) FROM ""movies"" WHERE (runtime < 10800)
    # ActiveRecord::StatementInvalid: PG::UndefinedFunction: ERROR:  operator does not exist: interval < integer
    assert_equal 2, Movie.where('runtime < ?', 3.hours).count
  end
end
```

### Expected behavior

When passing a duration in an array condition, it should be converted to a valid interval input (e.g., ISO 8601)

https://www.postgresql.org/docs/current/datatype-datetime.html#DATATYPE-INTERVAL-INPUT
 
### Actual behavior

The duration get converted to an integer seconds which Postgres can't cast to an interval.  

### System configuration
**Rails version**:
Using rails 7.1.0.alpha from https://github.com/rails/rails.git (at main@6a55aff)
**Ruby version**:
ruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x86_64-darwin19]",https://api.github.com/repos/rails/rails/issues/44341/timeline,,aramgre,10539627,MDQ6VXNlcjEwNTM5NjI3,https://avatars.githubusercontent.com/u/10539627?v=4,,https://api.github.com/users/aramgre,https://github.com/aramgre,https://api.github.com/users/aramgre/followers,https://api.github.com/users/aramgre/following{/other_user},https://api.github.com/users/aramgre/gists{/gist_id},https://api.github.com/users/aramgre/starred{/owner}{/repo},https://api.github.com/users/aramgre/subscriptions,https://api.github.com/users/aramgre/orgs,https://api.github.com/users/aramgre/repos,https://api.github.com/users/aramgre/events{/privacy},https://api.github.com/users/aramgre/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44341/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
176,https://api.github.com/repos/rails/rails/issues/44335,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44335/labels{/name},https://api.github.com/repos/rails/rails/issues/44335/comments,https://api.github.com/repos/rails/rails/issues/44335/events,https://github.com/rails/rails/pull/44335,1124511040,PR_kwDNIULOMhlYqQ,44335,Unify select tag helpers nil value handling,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-04T18:49:26Z,2022-02-04T18:49:29Z,,MEMBER,,"Follow-up to #34809 and #40522.

This extends the `select` helper's `nil` handling behavior to `collection_select` and `grouped_collection_select`, for consistency.
",https://api.github.com/repos/rails/rails/issues/44335/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44335/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44335,https://github.com/rails/rails/pull/44335,https://github.com/rails/rails/pull/44335.diff,https://github.com/rails/rails/pull/44335.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
177,https://api.github.com/repos/rails/rails/issues/44333,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44333/labels{/name},https://api.github.com/repos/rails/rails/issues/44333/comments,https://api.github.com/repos/rails/rails/issues/44333/events,https://github.com/rails/rails/pull/44333,1124490926,PR_kwDNIULOMhkVYw,44333,Prefer value before type cast in form tag helpers,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-04T18:25:17Z,2022-02-04T18:25:21Z,,MEMBER,,"Many form tag helpers, such as `text_field`, [populate their fields using `value_before_type_cast`](https://github.com/rails/rails/blob/91f80a899f448b44e79937ae6972bd0f46b280d9/actionview/lib/action_view/helpers/tags/text_field.rb#L15).  However, a few helpers use `value`, the value after type cast.  When `value.to_s` != `value_before_type_cast`, those helpers may populate their fields incorrectly or not at all.

For example, when building a model with a custom attribute type such as:

```ruby
class ColorQuery
  include ActiveModel::API
  include ActiveModel::Attributes
  include ActiveRecord::AttributeMethods::BeforeTypeCast

  class RGB < ActiveModel::Type::Value
    def cast(value)
      # converts e.g. ""#00ff00"" to [0, 255, 0]
      value.is_a?(String) ? [value[-6..].hex].pack(""N"").unpack(""xCCC"") : value
    end
  end

  attribute :rgb, RGB.new
end
```

All of the following form fields will fail to re-populate between form submissions:

```erb
<%= form.color_field :rgb %>

<%= form.select :rgb,
      { red: ""#ff0000"", green: ""#00ff00"" },
      include_blank: true %>

<%= form.collection_select :rgb,
      { red: ""#ff0000"", green: ""#00ff00"" },
      :last, :first,
      include_blank: true %>

<%= form.radio_button :rgb, ""#ff0000"" %>
<%= form.label :rgb, ""red"", value: ""#ff0000"" %>
<%= form.radio_button :rgb, ""#00ff00"" %>
<%= form.label :rgb, ""green"", value: ""#00ff00"" %>

<%= form.collection_radio_buttons :rgb,
      { red: ""#ff0000"", green: ""#00ff00"" },
      :last, :first %>
```

This commit changes the relevant helpers to use the value before type cast when possible, just as the `text_field` helper does.
",https://api.github.com/repos/rails/rails/issues/44333/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44333/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44333,https://github.com/rails/rails/pull/44333,https://github.com/rails/rails/pull/44333.diff,https://github.com/rails/rails/pull/44333.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
178,https://api.github.com/repos/rails/rails/issues/44325,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44325/labels{/name},https://api.github.com/repos/rails/rails/issues/44325/comments,https://api.github.com/repos/rails/rails/issues/44325/events,https://github.com/rails/rails/issues/44325,1123251637,I_kwDNIULOQvN1tQ,44325,Better Documentation for rails new,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,5,2022-02-03T15:51:28Z,2022-04-18T08:07:33Z,,CONTRIBUTOR,,"### Description
`rails new` is the definitive start for any project, and it's important to get it right, but documentation on the available options are spread throughout the Rails Guides.

The [Command Line](https://guides.rubyonrails.org/command_line.html#rails-new) guide says you can skip modules. The [API-only](https://guides.rubyonrails.org/api_app.html#creating-a-new-application) guide offers the option of adding `--api`. I could only find information about `--database=` from [Digital Ocean's guide on working with postgres](https://www.digitalocean.com/community/tutorials/how-to-set-up-ruby-on-rails-with-postgres). `--webpacker` being an option is 
just a side-note in this guide on [webpacker in rails](https://guides.rubyonrails.org/webpacker.html#installing-webpacker).

The CLI documentation helps, but there's not much room for elaboration, and no space to link to additional documentation.
```
rails new --help
Usage:
  rails new APP_PATH [options]

Options:
      [--skip-namespace], [--no-skip-namespace]              # Skip namespace (affects only isolated engines)
      [--skip-collision-check], [--no-skip-collision-check]  # Skip collision check
  -r, [--ruby=PATH]                                          # Path to the Ruby binary of your choice
                                                             # Default: /Users/rachael.wrightmunn/.rbenv/versions/3.1.0/bin/ruby
  -m, [--template=TEMPLATE]                                  # Path to some application template (can be a filesystem path or URL)
  -d, [--database=DATABASE]                                  # Preconfigure for selected database (options: mysql/postgresql/sqlite3/oracle/sqlserver/jdbcmysql/jdbcsqlite3/jdbcpostgresql/jdbc)
                                                             # Default: sqlite3
  -G, [--skip-git], [--no-skip-git]                          # Skip .gitignore file
      [--skip-keeps], [--no-skip-keeps]                      # Skip source control .keep files
  -M, [--skip-action-mailer], [--no-skip-action-mailer]      # Skip Action Mailer files
      [--skip-action-mailbox], [--no-skip-action-mailbox]    # Skip Action Mailbox gem
      [--skip-action-text], [--no-skip-action-text]          # Skip Action Text gem
  -O, [--skip-active-record], [--no-skip-active-record]      # Skip Active Record files
      [--skip-active-job], [--no-skip-active-job]            # Skip Active Job
      [--skip-active-storage], [--no-skip-active-storage]    # Skip Active Storage files
  -C, [--skip-action-cable], [--no-skip-action-cable]        # Skip Action Cable files
  -A, [--skip-asset-pipeline], [--no-skip-asset-pipeline]    # Indicates when to generate skip asset pipeline
  -a, [--asset-pipeline=ASSET_PIPELINE]                      # Choose your asset pipeline [options: sprockets (default), propshaft]
                                                             # Default: sprockets
  -J, [--skip-javascript], [--no-skip-javascript]            # Skip JavaScript files
      [--skip-hotwire], [--no-skip-hotwire]                  # Skip Hotwire integration
      [--skip-jbuilder], [--no-skip-jbuilder]                # Skip jbuilder gem
  -T, [--skip-test], [--no-skip-test]                        # Skip test files
      [--skip-system-test], [--no-skip-system-test]          # Skip system test files
      [--skip-bootsnap], [--no-skip-bootsnap]                # Skip bootsnap gem
      [--dev], [--no-dev]                                    # Set up the application with Gemfile pointing to your Rails checkout
      [--edge], [--no-edge]                                  # Set up the application with Gemfile pointing to Rails repository
  --master, [--main], [--no-main]                            # Set up the application with Gemfile pointing to Rails repository main branch
      [--rc=RC]                                              # Path to file containing extra configuration options for rails command
      [--no-rc], [--no-no-rc]                                # Skip loading of extra configuration options from .railsrc file
      [--api], [--no-api]                                    # Preconfigure smaller stack for API only apps
      [--minimal], [--no-minimal]                            # Preconfigure a minimal rails app
  -j, [--javascript=JAVASCRIPT]                              # Choose JavaScript approach [options: importmap (default), webpack, esbuild, rollup]
                                                             # Default: importmap
  -c, [--css=CSS]                                            # Choose CSS processor [options: tailwind, bootstrap, bulma, postcss, sass... check https://github.com/rails/cssbundling-rails]
  -B, [--skip-bundle], [--no-skip-bundle]                    # Don't run bundle install

Runtime options:
  -f, [--force]                    # Overwrite files that already exist
  -p, [--pretend], [--no-pretend]  # Run but do not make any changes
  -q, [--quiet], [--no-quiet]      # Suppress status output
  -s, [--skip], [--no-skip]        # Skip files that already exist

Rails options:
  -h, [--help], [--no-help]        # Show this help message and quit
  -v, [--version], [--no-version]  # Show Rails version number and quit

Description:
    The 'rails new' command creates a new Rails application with a default
    directory structure and configuration at the path you specify.

    You can specify extra command-line arguments to be used every time
    'rails new' runs in the .railsrc configuration file in your home directory,
    or in $XDG_CONFIG_HOME/rails/railsrc if XDG_CONFIG_HOME is set.

    Note that the arguments specified in the .railsrc file don't affect the
    defaults values shown above in this help message.

Example:
    rails new ~/Code/Ruby/weblog

    This generates a skeletal Rails installation in ~/Code/Ruby/weblog.
```
It'd be really helpful to have a home for all of these options, and then be able to link to specific pages to support them. Like the aforementioned API-only guide. Also, some people, like myself, like to link to the resources that we used to make decisions, and that's much harder if the information only exists in the CLI.",https://api.github.com/repos/rails/rails/issues/44325/timeline,,ChaelCodes,8124558,MDQ6VXNlcjgxMjQ1NTg=,https://avatars.githubusercontent.com/u/8124558?v=4,,https://api.github.com/users/ChaelCodes,https://github.com/ChaelCodes,https://api.github.com/users/ChaelCodes/followers,https://api.github.com/users/ChaelCodes/following{/other_user},https://api.github.com/users/ChaelCodes/gists{/gist_id},https://api.github.com/users/ChaelCodes/starred{/owner}{/repo},https://api.github.com/users/ChaelCodes/subscriptions,https://api.github.com/users/ChaelCodes/orgs,https://api.github.com/users/ChaelCodes/repos,https://api.github.com/users/ChaelCodes/events{/privacy},https://api.github.com/users/ChaelCodes/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44325/reactions,3,3,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
179,https://api.github.com/repos/rails/rails/issues/44324,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44324/labels{/name},https://api.github.com/repos/rails/rails/issues/44324/comments,https://api.github.com/repos/rails/rails/issues/44324/events,https://github.com/rails/rails/pull/44324,1123212164,PR_kwDNIULOMghf6g,44324,Add Active Model `Collection` attribute type,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,3,2022-02-03T15:18:06Z,2022-03-29T04:29:05Z,,CONTRIBUTOR,,"### Summary

One case that is not yet covered by the current standard types is for attributes that represent a collection of multiple values. For example, one might need to represent a subset of strings as a list in a single attribute; or even an entire group of associated models that are all embedded in a named collection. 


This PR aims to implement a new Collection type.
It subclasses the base Value class and overrides the necessary methods so casting and serialization work for an array of objects that are themselves valid for one of the types in the Registry. This ensures that each element of the collection can be cast and serialized individually by delegating the operation to the appropriate type instance.

Collection serializes itself as a JSON array on the database. For casting, it attempts to convert values to a Ruby array.

Methods:

- `type`: returns the :collection symbol.
- `serializable?`: checks if the given value is an array containing only elements in which are all serializable for the collection type. It will instantiate the type passed during its own initialization and call serializable? for each element.
- `serialize`: returns a JSON string of an array with all elements serialized by the collection type.
- `deserialize`: expects a JSON array string and converts it into a Ruby array with each element deserialized by the collection type.
- `cast`: converts the given array into a normalized collection of cast values. It will map the given array to a new one in which each element is cast into a new value by the collection type.
- `changed_in_place?`: Accepts raw serialized value, deserializes it and checks if any of the elements of the collections were mutated according to the collection type method of the same name.
- `assert_valid_value`: checks if all elements of the given array are accepted by the collection type method of the same name.



### Other Information

This change also introduces additional `Value#valid_value?` method that is supposed to separate the assertion, which raises an exception from a boolean check that can be reused in other places. This way new types won't have to override the whole `assert_valid_value` method if they want to keep the default error message.

Let me know if this change should be implemented in a separate PR. I decided to keep it in this PR for better readability of the change but definitely willing to extract it and have a discussion is a different PR. Thanks!

### Documentation

Currently only the class itself is covered with documentation. But we have plans to cover public methods as well.
Either in this PR, in a separate one or perhaps as part of the https://github.com/rails/rails/pull/44306
",https://api.github.com/repos/rails/rails/issues/44324/timeline,,nvasilevski,5512772,MDQ6VXNlcjU1MTI3NzI=,https://avatars.githubusercontent.com/u/5512772?v=4,,https://api.github.com/users/nvasilevski,https://github.com/nvasilevski,https://api.github.com/users/nvasilevski/followers,https://api.github.com/users/nvasilevski/following{/other_user},https://api.github.com/users/nvasilevski/gists{/gist_id},https://api.github.com/users/nvasilevski/starred{/owner}{/repo},https://api.github.com/users/nvasilevski/subscriptions,https://api.github.com/users/nvasilevski/orgs,https://api.github.com/users/nvasilevski/repos,https://api.github.com/users/nvasilevski/events{/privacy},https://api.github.com/users/nvasilevski/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44324/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44324,https://github.com/rails/rails/pull/44324,https://github.com/rails/rails/pull/44324.diff,https://github.com/rails/rails/pull/44324.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
180,https://api.github.com/repos/rails/rails/issues/44320,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44320/labels{/name},https://api.github.com/repos/rails/rails/issues/44320/comments,https://api.github.com/repos/rails/rails/issues/44320/events,https://github.com/rails/rails/issues/44320,1122655860,I_kwDNIULOQupedA,44320,"Lazy iterator, interlock deadlock","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-03T04:58:32Z,2022-02-07T07:24:58Z,,NONE,,"### Steps to reproduce

In rails console:

```
MyModel.transaction { MyModel.find_each.next }
```

The call to `transaction` enters load interlock monitor. The call to `next` then switches to the iterator's fiber and also tries to enter load interlock monitor. Deadlocks.

### Expected behavior
Not sure - maybe it should do this? I thought it might be helpful for others trying to figure this out.

### Actual behavior
Statement never returns.

### System configuration
**Rails version**: 6.1.4.4

**Ruby version**: 3.1.0

I'm updating my application from 2.7.5. This didn't happen before, may be related to https://bugs.ruby-lang.org/issues/17827",https://api.github.com/repos/rails/rails/issues/44320/timeline,,mthorn,408744,MDQ6VXNlcjQwODc0NA==,https://avatars.githubusercontent.com/u/408744?v=4,,https://api.github.com/users/mthorn,https://github.com/mthorn,https://api.github.com/users/mthorn/followers,https://api.github.com/users/mthorn/following{/other_user},https://api.github.com/users/mthorn/gists{/gist_id},https://api.github.com/users/mthorn/starred{/owner}{/repo},https://api.github.com/users/mthorn/subscriptions,https://api.github.com/users/mthorn/orgs,https://api.github.com/users/mthorn/repos,https://api.github.com/users/mthorn/events{/privacy},https://api.github.com/users/mthorn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44320/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
181,https://api.github.com/repos/rails/rails/issues/44317,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44317/labels{/name},https://api.github.com/repos/rails/rails/issues/44317/comments,https://api.github.com/repos/rails/rails/issues/44317/events,https://github.com/rails/rails/issues/44317,1122457618,I_kwDNIULOQudYEg,44317,Model#save! should not update instance attributes that are already set,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-02T22:36:01Z,2022-03-02T12:12:51Z,,CONTRIBUTOR,,"### Steps to reproduce

I notice that `Model#save!` and `Model#create!` perform an extra unnecessary in my understanding deserialization.

When saving instance to database, the attributes are rightfully serialized. But then `ActiveModel::ActiveModel#forget_attribute_assignments` replaces all attributes stored in the model instance with deserialized values of the just serialized values.

This is first an unnecessary performance hit. And also a problem for database types that need serialization when storing into the database, but at the same time values returned from database do not need deserialization. This behavior I noticed when dealing with oracle-enhanced raw data type. But issue is easily demonstrable with the default sqlite database and a custom type. I generated a basic rails project with a model and a custom type, see below.

P.S. yes, I understand that after `Model#reload` it is expected to see `what I don't want`, but before reloading from database it is only a performance hit and unexpected to do a deserialization cycle. 

<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# just a minimal project created with `rails new` and added custom type and model
git clone https://github.com/akostadinov/rails-attr-on-save.git
cd rails-attr-on-save
rails db:reset
rails c
> a = Article.create!(title: ""test"", body: ""test body"", custom: ""what I want"")
> a.custom
```

### Expected behavior
<!-- Tell us what should happen -->
```
=> ""what I want""
```

### Actual behavior
<!-- Tell us what happens instead -->
```
=> ""what I don't want""
```

### System configuration
Rails version:
Rails 7.0.1

Ruby version:
ruby 2.7.3p183 (2021-04-05 revision 6847ee089d) [x86_64-linux]",https://api.github.com/repos/rails/rails/issues/44317/timeline,,akostadinov,1408661,MDQ6VXNlcjE0MDg2NjE=,https://avatars.githubusercontent.com/u/1408661?v=4,,https://api.github.com/users/akostadinov,https://github.com/akostadinov,https://api.github.com/users/akostadinov/followers,https://api.github.com/users/akostadinov/following{/other_user},https://api.github.com/users/akostadinov/gists{/gist_id},https://api.github.com/users/akostadinov/starred{/owner}{/repo},https://api.github.com/users/akostadinov/subscriptions,https://api.github.com/users/akostadinov/orgs,https://api.github.com/users/akostadinov/repos,https://api.github.com/users/akostadinov/events{/privacy},https://api.github.com/users/akostadinov/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44317/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
182,https://api.github.com/repos/rails/rails/issues/44316,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44316/labels{/name},https://api.github.com/repos/rails/rails/issues/44316/comments,https://api.github.com/repos/rails/rails/issues/44316/events,https://github.com/rails/rails/pull/44316,1122432927,PR_kwDNIULOMf4pCw,44316,Reversed attribute precedence in insert_all,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-02-02T22:03:01Z,2022-02-06T02:55:08Z,,CONTRIBUTOR,,"### Summary

Rails 6.1 (via #38899) introduced incorporating relationship scopes into the attributes inserted when using `insert_all`/`upsert_all`. This allowed `author.books.insert_all({ title: ""Out of the Silent Planet"" })` to work as expected. Neat!

However, the attributes from the scope were combined with attributes passed in as arguments with `merge!`. This meant that attributes on the scope would overwrite those passed in, which can be surprising in some cases, especially when using default scopes.

The example in the test for attribute precedence prior to this PR was a bit contrived:
```ruby
assert_difference ""author.books.count"", +1 do
  author.books.insert_all({ title: ""Out of the Silent Planet"", isbn: ""XXX"", author_id: second_author.id })
end
```

... but one could perhaps see the logic of it: `author.books` as the scope is a strong contender for what should win out when inserting the new record.

However, I believe it's more surprising that the attributes explicitly passed in to `insert_all` don't ultimately take precedence; these seem to be the stronger indicator of intent, more even than the scope. A different example illustrates what I mean:

```ruby
class Book < ActiveRecord
  default_scope where(archived_at: nil)

  def archived?
    archived_at.nil?
  end

end

book = Book.insert_all({ title: ""Perelandra"", archived_at: Time.now })
book.archived?
# => false
```

In this example, books may be archived using a timestamp. By default, we only ever want to work with un-archived books, and so we've set up a `default_scope` to accomplish this (it could just as easily be a scope on a relationship as well, e.g., an Author `has_many :books, ->{ where(archived_at: nil) }`). But should we want to insert a book as already archived, passing in a timestamp for `archived_at` is not enough! We also have to remember to also call `unscope(where: :archived_at)` before `insert_all`. That's surprising.

What I suggest is reversing the precedence and deferring to the attributes passed into the method over what we get from the scope (i.e., using `reverse_merge!` instead of `merge!`); the attributes passed in are stronger signals of intent than the scope on which one calls `insert_all`.

This would be a reversal from current behavior, though I don't believe the current behavior is noted in the documentation (cf. #41639). It would, however, make other attributes more consistent with the automatically-added timestamps, which already use `reverse_merge!` to defer to the passed-in attributes over the default values (cf. #43003).

Thanks for your thoughts and consideration!

",https://api.github.com/repos/rails/rails/issues/44316/timeline,,kobsy,11465945,MDQ6VXNlcjExNDY1OTQ1,https://avatars.githubusercontent.com/u/11465945?v=4,,https://api.github.com/users/kobsy,https://github.com/kobsy,https://api.github.com/users/kobsy/followers,https://api.github.com/users/kobsy/following{/other_user},https://api.github.com/users/kobsy/gists{/gist_id},https://api.github.com/users/kobsy/starred{/owner}{/repo},https://api.github.com/users/kobsy/subscriptions,https://api.github.com/users/kobsy/orgs,https://api.github.com/users/kobsy/repos,https://api.github.com/users/kobsy/events{/privacy},https://api.github.com/users/kobsy/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44316/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44316,https://github.com/rails/rails/pull/44316,https://github.com/rails/rails/pull/44316.diff,https://github.com/rails/rails/pull/44316.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
183,https://api.github.com/repos/rails/rails/issues/44314,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44314/labels{/name},https://api.github.com/repos/rails/rails/issues/44314/comments,https://api.github.com/repos/rails/rails/issues/44314/events,https://github.com/rails/rails/issues/44314,1122252694,I_kwDNIULOQuQ3lg,44314,Non-nullable field with default value raises ActiveRecord::Encryption::Errors::Decryption when absent,[],open,False,,[],,3,2022-02-02T18:23:40Z,2022-02-20T10:28:09Z,,NONE,,"### Steps to reproduce
Migration:
```ruby
class CreateAccounts < ActiveRecord::Migration[7.0]
  def change
    create_table :accounts do |t|
      t.text :email, null: false, default: ''
      t.timestamps
    end
  end
end
``` 
Model:
```ruby
class Account < ApplicationRecord
  encrypts :email, deterministic: true, downcase: true
end
```
### Expected behavior
I expect that `Account.create!()` creates a new account and email field has either encrypted empty string or just empty string.

### Actual behavior
```
irb(main):002:0> Account.create!()
/home/air/.asdf/installs/ruby/3.1.0/lib/ruby/gems/3.1.0/gems/activerecord-7.0.1/lib/active_record/encryption/encryptor.rb:58:in `rescue in decrypt': ActiveRecord::Encryption::Errors::Decryption (ActiveRecord::Encryption::Errors::Decryption)
/home/air/.asdf/installs/ruby/3.1.0/lib/ruby/gems/3.1.0/gems/activerecord-7.0.1/lib/active_record/encryption/message_serializer.rb:26:in `rescue in load': ActiveRecord::Encryption::Errors::Encoding (ActiveRecord::Encryption::Errors::Encoding)
/home/air/.asdf/installs/ruby/3.1.0/lib/ruby/3.1.0/json/common.rb:216:in `parse': 859: unexpected token at '' (JSON::ParserError)
/home/air/.asdf/installs/ruby/3.1.0/lib/ruby/gems/3.1.0/gems/activerecord-7.0.1/lib/active_record/encryption/encryptor.rb:58:in `rescue in decrypt': ActiveRecord::Encryption::Errors::Decryption (ActiveRecord::Encryption::Errors::Decryption)
/home/air/.asdf/installs/ruby/3.1.0/lib/ruby/gems/3.1.0/gems/activerecord-7.0.1/lib/active_record/encryption/message_serializer.rb:26:in `rescue in load': ActiveRecord::Encryption::Errors::Encoding (ActiveRecord::Encryption::Errors::Encoding)
/home/air/.asdf/installs/ruby/3.1.0/lib/ruby/3.1.0/json/common.rb:216:in `parse': 859: unexpected token at '' (JSON::ParserError)
irb(main):003:0>
```
If I remove `null: false, default: ''` in the migration file it works ok.

### System configuration
**Rails version**: 7.0.1

**Ruby version**: 3.1.0
",https://api.github.com/repos/rails/rails/issues/44314/timeline,,airled,10863999,MDQ6VXNlcjEwODYzOTk5,https://avatars.githubusercontent.com/u/10863999?v=4,,https://api.github.com/users/airled,https://github.com/airled,https://api.github.com/users/airled/followers,https://api.github.com/users/airled/following{/other_user},https://api.github.com/users/airled/gists{/gist_id},https://api.github.com/users/airled/starred{/owner}{/repo},https://api.github.com/users/airled/subscriptions,https://api.github.com/users/airled/orgs,https://api.github.com/users/airled/repos,https://api.github.com/users/airled/events{/privacy},https://api.github.com/users/airled/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44314/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
184,https://api.github.com/repos/rails/rails/issues/44313,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44313/labels{/name},https://api.github.com/repos/rails/rails/issues/44313/comments,https://api.github.com/repos/rails/rails/issues/44313/events,https://github.com/rails/rails/issues/44313,1122146585,I_kwDNIULOQuKZGQ,44313,css:install:bootstrap doesn't complete successfully,[],open,False,,[],,4,2022-02-02T16:35:34Z,2022-02-25T00:05:01Z,,NONE,,"### Steps to reproduce

1. `$ rails new MyApp --css bootstrap`
2. when `css:install:bootstrap` is executed, it fails to make some necessary changes:

```
       rails  css:install:bootstrap
Build into app/assets/builds
       exist  app/assets/builds
   identical  app/assets/builds/.keep
File unchanged! The supplied flag value not found!  app/assets/config/manifest.js
Stop linking stylesheets automatically
        gsub  app/assets/config/manifest.js
File unchanged! The supplied flag value not found!  .gitignore
File unchanged! The supplied flag value not found!  .gitignore
Remove app/assets/stylesheets/application.css so build output can take over
      remove  app/assets/stylesheets/application.css
Add stylesheet link tag in application layout
File unchanged! The supplied flag value not found!  app/views/layouts/application.html.erb
      append  Procfile.dev
Add bin/dev to start foreman
```

### Expected behavior
The install should update these files with the appropriate changes when installing bootstrap:

- app/assets/config/manifest.js
- .gitignore
- app/views/layouts/application.html.erb

### Actual behavior
The files remain unchanged and `File unchanged! The supplied flag value not found!` appears 4x

To confirm: Bootstrap does seem to work just fine even with these 4 unchanged files.

### System configuration
**Rails version**:
7.0.1

**Ruby version**:
3.1.0",https://api.github.com/repos/rails/rails/issues/44313/timeline,,MattBudz,46340573,MDQ6VXNlcjQ2MzQwNTcz,https://avatars.githubusercontent.com/u/46340573?v=4,,https://api.github.com/users/MattBudz,https://github.com/MattBudz,https://api.github.com/users/MattBudz/followers,https://api.github.com/users/MattBudz/following{/other_user},https://api.github.com/users/MattBudz/gists{/gist_id},https://api.github.com/users/MattBudz/starred{/owner}{/repo},https://api.github.com/users/MattBudz/subscriptions,https://api.github.com/users/MattBudz/orgs,https://api.github.com/users/MattBudz/repos,https://api.github.com/users/MattBudz/events{/privacy},https://api.github.com/users/MattBudz/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44313/reactions,3,3,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
185,https://api.github.com/repos/rails/rails/issues/44312,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44312/labels{/name},https://api.github.com/repos/rails/rails/issues/44312/comments,https://api.github.com/repos/rails/rails/issues/44312/events,https://github.com/rails/rails/issues/44312,1121972818,I_kwDNIULOQt_yUg,44312,ActiveRecord::Sanitization::ClassMethods#sanitize_sql surrounds Numerics with quotes,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,9,2022-02-02T14:09:51Z,2022-04-09T08:49:20Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

In a rails app that uses the mysql2 connection adapter run the following snippet.

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
ActiveRecord::Base.sanitize_sql([""LIMIT :offset, :per_page"", { offset: 12, per_page: 32 }])
```

### Expected behavior
<!-- Tell us what should happen -->

It should generate the following:

```ruby
""LIMIT 12, 32""
```

Which is a valid MySQL `LIMIT` clause. 

### Actual behavior
<!-- Tell us what happens instead -->
It generates the following:

```ruby
""LIMIT '12', '32'""
```

Which is not a valid MySQL `LIMIT` clause.

### System configuration
**Rails version**: 7.0.1

**Ruby version**: MRI 3.0.3
",https://api.github.com/repos/rails/rails/issues/44312/timeline,,rbgrouleff,60459,MDQ6VXNlcjYwNDU5,https://avatars.githubusercontent.com/u/60459?v=4,,https://api.github.com/users/rbgrouleff,https://github.com/rbgrouleff,https://api.github.com/users/rbgrouleff/followers,https://api.github.com/users/rbgrouleff/following{/other_user},https://api.github.com/users/rbgrouleff/gists{/gist_id},https://api.github.com/users/rbgrouleff/starred{/owner}{/repo},https://api.github.com/users/rbgrouleff/subscriptions,https://api.github.com/users/rbgrouleff/orgs,https://api.github.com/users/rbgrouleff/repos,https://api.github.com/users/rbgrouleff/events{/privacy},https://api.github.com/users/rbgrouleff/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44312/reactions,2,1,0,0,0,0,0,1,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
186,https://api.github.com/repos/rails/rails/issues/44298,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44298/labels{/name},https://api.github.com/repos/rails/rails/issues/44298/comments,https://api.github.com/repos/rails/rails/issues/44298/events,https://github.com/rails/rails/pull/44298,1119846723,PR_kwDNIULOMdv8Pw,44298,Always heed `ActiveModel::Name#human` `:count` option,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,0,2022-01-31T19:29:30Z,2022-02-04T19:14:23Z,,MEMBER,,"Prior to this commit, when the model class did not extend `ActiveModel::Translation` or the relevant I18n keys were missing, `ActiveModel::Name#human` would effectively ignore the `:count` option.

This commit makes `ActiveModel::Name#human` heed the `:count` option in either scenario.
",https://api.github.com/repos/rails/rails/issues/44298/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44298/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44298,https://github.com/rails/rails/pull/44298,https://github.com/rails/rails/pull/44298.diff,https://github.com/rails/rails/pull/44298.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
187,https://api.github.com/repos/rails/rails/issues/44297,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44297/labels{/name},https://api.github.com/repos/rails/rails/issues/44297/comments,https://api.github.com/repos/rails/rails/issues/44297/events,https://github.com/rails/rails/pull/44297,1119769318,PR_kwDNIULOMdr2uA,44297,Improve requiring of scalar parameters,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,0,2022-01-31T18:12:23Z,2022-02-06T15:18:51Z,,MEMBER,,"### Summary

The usage of `ActionController::Parameters#require` is a bit ambiguous.
It can be called for hashes, arrays and scalar values.
When a scalar value is expected but a hash is passed you might get
unexpected results:

```ruby
ActionController::Parameters.new(name: { first: ""Francesco"" }).require(:name).downcase
# => NoMethodError (undefined method `downcase' for #<ActionController::Parameters:0x00007f8c631264b0>)
```

Similarly, when a hash is expected but a scalar value is passed:

```ruby
ActionController::Parameters.new(person: ""Francesco"").require(:person).permit(:name)
# => NoMethodError (undefined method `permit' for ""Francesco"":String)
```

This requires developers to handle these unexpected exceptions instead
of just rescuing/ignoring `ActionController::ParameterMissing`.

There even is a [warning documented](https://github.com/rails/rails/blob/abde74c118a2391c90f4c8ac197a9628ef2acf9b/actionpack/lib/action_controller/metal/strong_parameters.rb#L474-L488) in the rdoc of `require` to be
careful when requiring terminal values. For example, calling require
without permit can have unexpected results if unpermitted values are
passed:

```ruby
ActionController::Parameters.new(name: Object.new).require(:name)
# => #<Object:0x00007f8c58637180>
```

### Separate `require` methods for scalar and non scalar params

By restricting `require` to arrays and hashes, and adding a
`require_scalar` method for scalar values we can prevent these problems.

This allows us to raise an `ActionController::ParameterMissing` if a
required param doesn't have the expected type:

```ruby
# when a hash is passed but a scalar value is expected
ActionController::Parameters.new(name: { first: ""Francesco"" }).require_scalar(:name).downcase
# => ActionController::ParameterMissing (param is missing or the value is empty: name)

# when a scalar value is passed but a hash is expected
ActionController::Parameters.new(person: ""Francesco"").require(:person).permit(:name)
# => ActionController::ParameterMissing (param is missing or the value is empty: person)
```

`require_scalar` also restricts the required values to permitted
scalar values.

```ruby
ActionController::Parameters.new(name: Object.new).require_scalar(:name)
# => ActionController::ParameterMissing (param is missing or the value is empty: name)
```

Fixes: #42953

### Other Information

This would be a breaking change requiring deprecation warnings.

Maybe we should make it even stricter and introduce methods
for each permited scalar type. This allows us to have stricter
checks and maybe even coerce to the proper type:

```ruby
params = ActionController::Parameters.new(name: ""Francesco"", age: ""22"", active: ""true"")
params.require_string(:name) # => ""Francesco""
params.require_integer(:age) # => 22
params.require_boolean(:active) # => true
```",https://api.github.com/repos/rails/rails/issues/44297/timeline,,p8,28561,MDQ6VXNlcjI4NTYx,https://avatars.githubusercontent.com/u/28561?v=4,,https://api.github.com/users/p8,https://github.com/p8,https://api.github.com/users/p8/followers,https://api.github.com/users/p8/following{/other_user},https://api.github.com/users/p8/gists{/gist_id},https://api.github.com/users/p8/starred{/owner}{/repo},https://api.github.com/users/p8/subscriptions,https://api.github.com/users/p8/orgs,https://api.github.com/users/p8/repos,https://api.github.com/users/p8/events{/privacy},https://api.github.com/users/p8/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44297/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44297,https://github.com/rails/rails/pull/44297,https://github.com/rails/rails/pull/44297.diff,https://github.com/rails/rails/pull/44297.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
188,https://api.github.com/repos/rails/rails/issues/44295,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44295/labels{/name},https://api.github.com/repos/rails/rails/issues/44295/comments,https://api.github.com/repos/rails/rails/issues/44295/events,https://github.com/rails/rails/pull/44295,1119494631,PR_kwDNIULOMddVuw,44295,Update RDoc comments for #redirect,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,0,2022-01-31T14:24:09Z,2022-01-31T14:24:12Z,,NONE,,"Add the default status code returned by `ActionDispatch::Routing::Redirection#redirect` in the RDoc comment.

### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44295/timeline,,guillaumecabanel,2414369,MDQ6VXNlcjI0MTQzNjk=,https://avatars.githubusercontent.com/u/2414369?v=4,,https://api.github.com/users/guillaumecabanel,https://github.com/guillaumecabanel,https://api.github.com/users/guillaumecabanel/followers,https://api.github.com/users/guillaumecabanel/following{/other_user},https://api.github.com/users/guillaumecabanel/gists{/gist_id},https://api.github.com/users/guillaumecabanel/starred{/owner}{/repo},https://api.github.com/users/guillaumecabanel/subscriptions,https://api.github.com/users/guillaumecabanel/orgs,https://api.github.com/users/guillaumecabanel/repos,https://api.github.com/users/guillaumecabanel/events{/privacy},https://api.github.com/users/guillaumecabanel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44295/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44295,https://github.com/rails/rails/pull/44295,https://github.com/rails/rails/pull/44295.diff,https://github.com/rails/rails/pull/44295.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
189,https://api.github.com/repos/rails/rails/issues/44292,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44292/labels{/name},https://api.github.com/repos/rails/rails/issues/44292/comments,https://api.github.com/repos/rails/rails/issues/44292/events,https://github.com/rails/rails/issues/44292,1118701335,I_kwDNIULOQq4HFw,44292,Not depending on unmaintained dependencies,"[{'id': 128693, 'node_id': 'MDU6TGFiZWwxMjg2OTM=', 'url': 'https://api.github.com/repos/rails/rails/labels/asset%20pipeline', 'name': 'asset pipeline', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,3,2022-01-30T20:52:32Z,2022-02-14T23:52:47Z,,NONE,,"Hello,

according to https://github.com/rails/sprockets/issues/661#issuecomment-906666544 sprockets is unmaintained. It hasn't seen new releases in almost 2 years and it relies on a bunch of outdated dependencies (babel, yui-compressor...).

Such outdated dependencies shouldn't be moved and make it very hard to package this for linux distributions like Archlinux.

Best regards",https://api.github.com/repos/rails/rails/issues/44292/timeline,,Segaja,586672,MDQ6VXNlcjU4NjY3Mg==,https://avatars.githubusercontent.com/u/586672?v=4,,https://api.github.com/users/Segaja,https://github.com/Segaja,https://api.github.com/users/Segaja/followers,https://api.github.com/users/Segaja/following{/other_user},https://api.github.com/users/Segaja/gists{/gist_id},https://api.github.com/users/Segaja/starred{/owner}{/repo},https://api.github.com/users/Segaja/subscriptions,https://api.github.com/users/Segaja/orgs,https://api.github.com/users/Segaja/repos,https://api.github.com/users/Segaja/events{/privacy},https://api.github.com/users/Segaja/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44292/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
190,https://api.github.com/repos/rails/rails/issues/44290,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44290/labels{/name},https://api.github.com/repos/rails/rails/issues/44290/comments,https://api.github.com/repos/rails/rails/issues/44290/events,https://github.com/rails/rails/pull/44290,1118335197,PR_kwDNIULOMchn6A,44290,Support declarative-style test name filters,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-01-29T21:49:39Z,2022-01-30T17:55:19Z,,MEMBER,,"This makes it possible to run a specific test such as:

```ruby
class MyTest < ActiveSupport::TestCase
  test ""does something"" do
    # ...
  end
end
```

Using its declared name:

```bash
$ rails test test/my_test.rb -n ""does something""
```

Instead of having to specify the expanded method name:

```bash
$ rails test test/my_test.rb -n test_does_something
```
",https://api.github.com/repos/rails/rails/issues/44290/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44290/reactions,1,0,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/44290,https://github.com/rails/rails/pull/44290,https://github.com/rails/rails/pull/44290.diff,https://github.com/rails/rails/pull/44290.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
191,https://api.github.com/repos/rails/rails/issues/44289,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44289/labels{/name},https://api.github.com/repos/rails/rails/issues/44289/comments,https://api.github.com/repos/rails/rails/issues/44289/events,https://github.com/rails/rails/issues/44289,1118293752,I_kwDNIULOQqfO-A,44289,Action mailbox migration does not respect the active record's primary_key_type,"[{'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,1,2022-01-29T18:28:24Z,2022-02-01T16:27:30Z,,CONTRIBUTOR,,"### Steps to reproduce

Configure your app to generate tables with UUID primary keys:
config/application.rb:

```ruby
  config.generators do |g|
    g.orm :active_record, primary_key_type: :uuid
  end
```

Run the ActiveMailer installer and migrations
```sh
bin/rails action_mailbox:install
bin/rails db:migrate
```

### Expected behavior

The `action_mailbox_inbound_emails` should have ids with type UUID.

Creating emails fails with the error: `null value in column ""record_id"" of relation ""active_storage_attachments""'

### Actual behavior

The `action_mailbox_inbound_emails` should have ids with type integer.
 
### System configuration
**Rails version**: 7.0.1

**Ruby version**: 3.0.3p157
",https://api.github.com/repos/rails/rails/issues/44289/timeline,,ExMember,4929877,MDQ6VXNlcjQ5Mjk4Nzc=,https://avatars.githubusercontent.com/u/4929877?v=4,,https://api.github.com/users/ExMember,https://github.com/ExMember,https://api.github.com/users/ExMember/followers,https://api.github.com/users/ExMember/following{/other_user},https://api.github.com/users/ExMember/gists{/gist_id},https://api.github.com/users/ExMember/starred{/owner}{/repo},https://api.github.com/users/ExMember/subscriptions,https://api.github.com/users/ExMember/orgs,https://api.github.com/users/ExMember/repos,https://api.github.com/users/ExMember/events{/privacy},https://api.github.com/users/ExMember/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44289/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
192,https://api.github.com/repos/rails/rails/issues/44278,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44278/labels{/name},https://api.github.com/repos/rails/rails/issues/44278/comments,https://api.github.com/repos/rails/rails/issues/44278/events,https://github.com/rails/rails/pull/44278,1116848144,PR_kwDNIULOMbVqAg,44278,Support reading `FormBuilder#id` from `id:` option,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,0,2022-01-27T23:40:09Z,2022-01-29T16:38:55Z,,CONTRIBUTOR,,"### Summary


When `FormBuilder#id` was introduced in [59ca21c][], it only read the
value passed in as `html: { id: ""..."" }` and ignored any top-level `id:`
options.

In spite of that fact, since the `<form>` element's is rendered separate
from the builder's block argument, the element still consistently
rendered with an `[id]` attribute. That value is read from the nested
`html: { id: ""..."" }` option and falling back to any provided `id:
""...""` option.

This commit adds test suite coverage to retain the previous behavior,
along with new tests to support reading `FormBuilder#id` from the `id:`
option.

[59ca21c]: https://github.com/rails/rails/commit/59ca21c0119fff803e75e78d800c0c98aee7fd4c",https://api.github.com/repos/rails/rails/issues/44278/timeline,,seanpdoyle,2575027,MDQ6VXNlcjI1NzUwMjc=,https://avatars.githubusercontent.com/u/2575027?v=4,,https://api.github.com/users/seanpdoyle,https://github.com/seanpdoyle,https://api.github.com/users/seanpdoyle/followers,https://api.github.com/users/seanpdoyle/following{/other_user},https://api.github.com/users/seanpdoyle/gists{/gist_id},https://api.github.com/users/seanpdoyle/starred{/owner}{/repo},https://api.github.com/users/seanpdoyle/subscriptions,https://api.github.com/users/seanpdoyle/orgs,https://api.github.com/users/seanpdoyle/repos,https://api.github.com/users/seanpdoyle/events{/privacy},https://api.github.com/users/seanpdoyle/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44278/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44278,https://github.com/rails/rails/pull/44278,https://github.com/rails/rails/pull/44278.diff,https://github.com/rails/rails/pull/44278.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
193,https://api.github.com/repos/rails/rails/issues/44275,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44275/labels{/name},https://api.github.com/repos/rails/rails/issues/44275/comments,https://api.github.com/repos/rails/rails/issues/44275/events,https://github.com/rails/rails/pull/44275,1116593700,PR_kwDNIULOMbIhSA,44275,form_with: ensure closing tag when omitting block,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,3,2022-01-27T18:12:57Z,2022-02-07T16:46:12Z,,CONTRIBUTOR,,"### Summary

Prior to this change, calling a `form_with` without passing a block
generates a `<form>` element without a closing `</form>` tag.

The [form_for][] version of building a `<form>` element requires a block
to execute, so omitting the closing `</form>` element isn't a
possibility.

A current work-around to achieve the desired behavior is to declare the `form_with` call with an empty block:

```erb
<%= form_with url: ""https://example.com"" do %>
<% end %>
```

Unfortunately, being unaware of this issue will likely yield HTML that is silently invalid, which can cause surprising nesting and behavior, such as elements declared after the `<form>` becoming descendants instead of siblings.

[form_for]: https://github.com/rails/rails/blob/efae65d005ee298207d720fb4f61c28a38973e8e/actionview/test/template/form_helper_test.rb#L1555-L1560",https://api.github.com/repos/rails/rails/issues/44275/timeline,,seanpdoyle,2575027,MDQ6VXNlcjI1NzUwMjc=,https://avatars.githubusercontent.com/u/2575027?v=4,,https://api.github.com/users/seanpdoyle,https://github.com/seanpdoyle,https://api.github.com/users/seanpdoyle/followers,https://api.github.com/users/seanpdoyle/following{/other_user},https://api.github.com/users/seanpdoyle/gists{/gist_id},https://api.github.com/users/seanpdoyle/starred{/owner}{/repo},https://api.github.com/users/seanpdoyle/subscriptions,https://api.github.com/users/seanpdoyle/orgs,https://api.github.com/users/seanpdoyle/repos,https://api.github.com/users/seanpdoyle/events{/privacy},https://api.github.com/users/seanpdoyle/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44275/reactions,2,2,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44275,https://github.com/rails/rails/pull/44275,https://github.com/rails/rails/pull/44275.diff,https://github.com/rails/rails/pull/44275.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
194,https://api.github.com/repos/rails/rails/issues/44264,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44264/labels{/name},https://api.github.com/repos/rails/rails/issues/44264/comments,https://api.github.com/repos/rails/rails/issues/44264/events,https://github.com/rails/rails/issues/44264,1115195006,I_kwDNIULOQniGfg,44264,Missing zeitwerk synchronization in rails 7.0.2.2 and ruby 3.1.0,[],open,False,,[],,5,2022-01-26T16:07:45Z,2022-02-25T14:41:42Z,,NONE,,"Originally reported at https://github.com/fxn/zeitwerk/issues/207

It seems that rails is not synchronizing zeitwerk when it autoload classes, causing a `RuntimeError`: `can't add a new key into hash during iteration`. The constant loading is aborted and only restarting the rails server causes it to retry loading the constant.",https://api.github.com/repos/rails/rails/issues/44264/timeline,,mildred,33804,MDQ6VXNlcjMzODA0,https://avatars.githubusercontent.com/u/33804?v=4,,https://api.github.com/users/mildred,https://github.com/mildred,https://api.github.com/users/mildred/followers,https://api.github.com/users/mildred/following{/other_user},https://api.github.com/users/mildred/gists{/gist_id},https://api.github.com/users/mildred/starred{/owner}{/repo},https://api.github.com/users/mildred/subscriptions,https://api.github.com/users/mildred/orgs,https://api.github.com/users/mildred/repos,https://api.github.com/users/mildred/events{/privacy},https://api.github.com/users/mildred/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44264/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
195,https://api.github.com/repos/rails/rails/issues/44263,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44263/labels{/name},https://api.github.com/repos/rails/rails/issues/44263/comments,https://api.github.com/repos/rails/rails/issues/44263/events,https://github.com/rails/rails/issues/44263,1115190450,I_kwDNIULOQnh0sg,44263,deadlock in activesupport 7.0.1 (ruby 3.1.0),"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,6,2022-01-26T16:03:42Z,2022-02-27T09:21:46Z,,NONE,,"After upgrading to rails 7 I occasionally get deadlocks. I enabled puma control server and could get the thread stack traces, and it seems that the theads are all waiting on a lock to be available

The following is the backtraces of the rails process obtained using puma control status server: [thread-backtraces.txt](https://github.com/rails/rails/files/7943135/thread-backtraces.txt)

The blocking thread seems to be **Thread: TID-2omw puma server threadpool 009**:

```
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `sleep'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `wait'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `wait_for_cond'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `wait'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:116:in `wait_while'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/share_lock.rb:220:in `wait_for'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/share_lock.rb:190:in `block in yield_shares'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:202:in `synchronize'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:202:in `mon_synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/share_lock.rb:189:in `yield_shares'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/postgresql/database_statements.rb:18:in `block in query'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract_adapter.rb:765:in `block in log'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/notifications/instrumenter.rb:24:in `instrument'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract_adapter.rb:756:in `log'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/postgresql/database_statements.rb:17:in `query'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:99:in `query_values'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/schema_statements.rb:35:in `data_sources'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/schema_cache.rb:199:in `tables_to_cache'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/schema_cache.rb:236:in `prepare_data_sources'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/schema_cache.rb:90:in `data_source_exists?'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/model_schema.rb:395:in `table_exists?'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/core.rb:406:in `inspect'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/rack-2.2.3/lib/rack/lint.rb:81:in `inspect'"",
```

There is also **Thread: TID-2oo0 puma server threadpool 008** which holds a shared lock:

```
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `enter'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `block in mon_enter'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:17:in `mon_enter'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:22:in `block in synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:350:in `checkin'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:304:in `block (3 levels) in clear_reloadable_connections'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:301:in `each'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:301:in `block (2 levels) in clear_reloadable_connections'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:202:in `synchronize'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:202:in `mon_synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:300:in `block in clear_reloadable_connections'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:523:in `block in with_exclusively_acquired_all_connections'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:598:in `with_new_connections_blocked'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:521:in `with_exclusively_acquired_all_connections'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:299:in `clear_reloadable_connections'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_pool.rb:323:in `clear_reloadable_connections!'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_handler.rb:176:in `each'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/connection_handler.rb:176:in `clear_reloadable_connections!'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_handling.rb:337:in `clear_reloadable_connections!'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/railtie.rb:295:in `block (3 levels) in <class:Railtie>'"",
```

and **Thread: TID-2nb4 puma server threadpool 003** with the same shared lock:

```
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `sleep'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `wait'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `wait_for_cond'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:108:in `wait'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:116:in `wait_while'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/share_lock.rb:220:in `wait_for'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/share_lock.rb:190:in `block in yield_shares'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:202:in `synchronize'"",
      ""/usr/local/rvm/rubies/ruby-3.1.0/lib/ruby/3.1.0/monitor.rb:202:in `mon_synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/share_lock.rb:189:in `yield_shares'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/dependencies/interlock.rb:41:in `permit_concurrent_loads'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/postgresql/database_statements.rb:18:in `block in query'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `handle_interrupt'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:25:in `block in synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `handle_interrupt'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/concurrency/load_interlock_aware_monitor.rb:21:in `synchronize'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract_adapter.rb:765:in `block in log'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activesupport-7.0.1/lib/active_support/notifications/instrumenter.rb:24:in `instrument'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract_adapter.rb:756:in `log'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/postgresql/database_statements.rb:17:in `query'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/database_statements.rb:99:in `query_values'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/abstract/schema_statements.rb:35:in `data_sources'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/schema_cache.rb:199:in `tables_to_cache'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/schema_cache.rb:236:in `prepare_data_sources'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/connection_adapters/schema_cache.rb:90:in `data_source_exists?'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/model_schema.rb:395:in `table_exists?'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/activerecord-7.0.1/lib/active_record/core.rb:406:in `inspect'"",
      ""/usr/local/rvm/gems/ruby-3.1.0@lcas/gems/rack-2.2.3/lib/rack/lint.rb:81:in `inspect'"",
```

I also experience occasional synchronizing issues with zeitwerk reported in https://github.com/fxn/zeitwerk/issues/207",https://api.github.com/repos/rails/rails/issues/44263/timeline,,mildred,33804,MDQ6VXNlcjMzODA0,https://avatars.githubusercontent.com/u/33804?v=4,,https://api.github.com/users/mildred,https://github.com/mildred,https://api.github.com/users/mildred/followers,https://api.github.com/users/mildred/following{/other_user},https://api.github.com/users/mildred/gists{/gist_id},https://api.github.com/users/mildred/starred{/owner}{/repo},https://api.github.com/users/mildred/subscriptions,https://api.github.com/users/mildred/orgs,https://api.github.com/users/mildred/repos,https://api.github.com/users/mildred/events{/privacy},https://api.github.com/users/mildred/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44263/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
196,https://api.github.com/repos/rails/rails/issues/44262,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44262/labels{/name},https://api.github.com/repos/rails/rails/issues/44262/comments,https://api.github.com/repos/rails/rails/issues/44262/events,https://github.com/rails/rails/pull/44262,1115155862,PR_kwDNIULOMZ-TRA,44262,Fix invalid durations with ActiveJob deserialization,"[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,0,2022-01-26T15:32:19Z,2022-01-27T09:23:47Z,,CONTRIBUTOR,,"### Summary

Durations that were round-tripped through ActiveJob::Arguments.serialize
would appear fine at a first glance, but trying to perform
duration-math on them would fail:

```
irb(main):001:0> d = ActiveJob::Arguments.deserialize(ActiveJob::Arguments.serialize([1.year]))[0]
=> 1 year
irb(main):002:0> d + 1.day
activesupport-6.1.4.4/lib/active_support/duration.rb:242:in `+': undefined method `merge' for [[:years, 1]]:Array (NoMethodError)
```

In [DurationSerializer](https://github.com/rails/rails/blob/bd41655d17ff85c3118a4c69d19bad47b6a2890f/activejob/lib/active_job/serializers/duration_serializer.rb#L7), `Arguments.serialize(duration.parts)` is silently converting the parts hash to an array (due to [arguments.map](https://github.com/rails/rails/blob/bd41655d17ff85c3118a4c69d19bad47b6a2890f/activejob/lib/active_job/arguments.rb#L34)).

I've fixed this in DurationSerializer, and also added a raise in Arguments.serialize if the provided `arguments` aren't an array, since that seems like it would always be user-error.


",https://api.github.com/repos/rails/rails/issues/44262/timeline,,jdelStrother,2377,MDQ6VXNlcjIzNzc=,https://avatars.githubusercontent.com/u/2377?v=4,,https://api.github.com/users/jdelStrother,https://github.com/jdelStrother,https://api.github.com/users/jdelStrother/followers,https://api.github.com/users/jdelStrother/following{/other_user},https://api.github.com/users/jdelStrother/gists{/gist_id},https://api.github.com/users/jdelStrother/starred{/owner}{/repo},https://api.github.com/users/jdelStrother/subscriptions,https://api.github.com/users/jdelStrother/orgs,https://api.github.com/users/jdelStrother/repos,https://api.github.com/users/jdelStrother/events{/privacy},https://api.github.com/users/jdelStrother/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44262/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44262,https://github.com/rails/rails/pull/44262,https://github.com/rails/rails/pull/44262.diff,https://github.com/rails/rails/pull/44262.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
197,https://api.github.com/repos/rails/rails/issues/44260,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44260/labels{/name},https://api.github.com/repos/rails/rails/issues/44260/comments,https://api.github.com/repos/rails/rails/issues/44260/events,https://github.com/rails/rails/issues/44260,1114848728,I_kwDNIULOQnM92A,44260,"ActionController::RoutingError (No route matches [GET] ""/assets/application.js....) ",[],open,False,,[],,1,2022-01-26T10:15:39Z,2022-02-03T16:00:42Z,,NONE,,"I'm suddenly faced with 

```
ActionController::RoutingError (No route matches [GET] ""/assets/application.js-920efc795bbe74efc45b09c59b03e18109155fbdf62b008ca8d094aed269d334.map"")
```
in a fresh rails 7 application using tailwind and esbuild. I cannot seem to locate where this is originating from. What might be causing this? 

Removing

```
<%= javascript_include_tag ""application"", ""data-turbo-track"": ""reload"", defer: true %>
```
from the application.htlm.erb file removes the issue.",https://api.github.com/repos/rails/rails/issues/44260/timeline,,simonsapiel,61185966,MDQ6VXNlcjYxMTg1OTY2,https://avatars.githubusercontent.com/u/61185966?v=4,,https://api.github.com/users/simonsapiel,https://github.com/simonsapiel,https://api.github.com/users/simonsapiel/followers,https://api.github.com/users/simonsapiel/following{/other_user},https://api.github.com/users/simonsapiel/gists{/gist_id},https://api.github.com/users/simonsapiel/starred{/owner}{/repo},https://api.github.com/users/simonsapiel/subscriptions,https://api.github.com/users/simonsapiel/orgs,https://api.github.com/users/simonsapiel/repos,https://api.github.com/users/simonsapiel/events{/privacy},https://api.github.com/users/simonsapiel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44260/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
198,https://api.github.com/repos/rails/rails/issues/44252,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44252/labels{/name},https://api.github.com/repos/rails/rails/issues/44252/comments,https://api.github.com/repos/rails/rails/issues/44252/events,https://github.com/rails/rails/issues/44252,1114318658,I_kwDNIULOQmsnQg,44252,StiPreload implementation from Rails Guides results in uninitialized constant errors on Rails 7,[],open,False,,"[{'login': 'byroot', 'id': 44640, 'node_id': 'MDQ6VXNlcjQ0NjQw', 'avatar_url': 'https://avatars.githubusercontent.com/u/44640?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/byroot', 'html_url': 'https://github.com/byroot', 'followers_url': 'https://api.github.com/users/byroot/followers', 'following_url': 'https://api.github.com/users/byroot/following{/other_user}', 'gists_url': 'https://api.github.com/users/byroot/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/byroot/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/byroot/subscriptions', 'organizations_url': 'https://api.github.com/users/byroot/orgs', 'repos_url': 'https://api.github.com/users/byroot/repos', 'events_url': 'https://api.github.com/users/byroot/events{/privacy}', 'received_events_url': 'https://api.github.com/users/byroot/received_events', 'type': 'User', 'site_admin': False}]",,17,2022-01-25T20:14:30Z,2022-01-31T12:28:18Z,,NONE,,"When using the [StiPreload module implementation](https://guides.rubyonrails.org/autoloading_and_reloading_constants.html#single-table-inheritance) suggested in the Rails Guides it results in `NameError: uninitialized constant` for typical use cases with existing STI `type` data.

I believe the fact that this issue pops up with Rails 7 stems from the changes here: https://github.com/rails/rails/commit/ffae3bd8d69f9ed1ae185e960d7a38ec17118a4d .

### Steps to reproduce
I've added a repo to demonstrate the problem here: [@dwillett/rails_7_sti_preload](https://github.com/dwillett/rails_7_sti_preload)

```shell
$ bin/rails db:create
Created database 'db/development.sqlite3'
Created database 'db/test.sqlite3'
$ bin/rails db:migrate
== 20220124235533 AddUsers: migrating =========================================
-- create_table(:users)
   -> 0.0022s
== 20220124235533 AddUsers: migrated (0.0023s) ================================

$ bin/rails r ""Member.create(name: 'Foo')""
$ bin/rails r ""puts Member""
Member
$ SHOWCASE_BUG=true bin/rails r ""puts Member""
Please specify a valid ruby command or the path of a script to run.
Run 'rails runner -h' for help.

uninitialized constant Member
```

When the environment variable is present, `self.descendants` will be invoked as part of requiring the `User` base STI class. It appears that invoking `Class.descendants` while the class is being loaded has implicitly been a circular problem with the `StiPreload` module (In this example: `Member` autoloads `User`, which invokes `.descendants` which tries to constantize `Member`), but with the changes in Rails 7 it now invokes that method directly when setting up association callbacks instead of `ActiveSupport::DescendantsTracker.descendants(self)`.

### Expected behavior
Class should be autoloaded correctly without error.

### Actual behavior
Class encounters unitialized constant error when attempting to autoload and preload class.

### System configuration
**Rails version**: 7.0.1

**Ruby version**: 3.0.3
",https://api.github.com/repos/rails/rails/issues/44252/timeline,,dwillett,39199,MDQ6VXNlcjM5MTk5,https://avatars.githubusercontent.com/u/39199?v=4,,https://api.github.com/users/dwillett,https://github.com/dwillett,https://api.github.com/users/dwillett/followers,https://api.github.com/users/dwillett/following{/other_user},https://api.github.com/users/dwillett/gists{/gist_id},https://api.github.com/users/dwillett/starred{/owner}{/repo},https://api.github.com/users/dwillett/subscriptions,https://api.github.com/users/dwillett/orgs,https://api.github.com/users/dwillett/repos,https://api.github.com/users/dwillett/events{/privacy},https://api.github.com/users/dwillett/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44252/reactions,4,4,0,0,0,0,0,0,0,,,,,,,byroot,44640.0,MDQ6VXNlcjQ0NjQw,https://avatars.githubusercontent.com/u/44640?v=4,,https://api.github.com/users/byroot,https://github.com/byroot,https://api.github.com/users/byroot/followers,https://api.github.com/users/byroot/following{/other_user},https://api.github.com/users/byroot/gists{/gist_id},https://api.github.com/users/byroot/starred{/owner}{/repo},https://api.github.com/users/byroot/subscriptions,https://api.github.com/users/byroot/orgs,https://api.github.com/users/byroot/repos,https://api.github.com/users/byroot/events{/privacy},https://api.github.com/users/byroot/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
199,https://api.github.com/repos/rails/rails/issues/44242,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44242/labels{/name},https://api.github.com/repos/rails/rails/issues/44242/comments,https://api.github.com/repos/rails/rails/issues/44242/events,https://github.com/rails/rails/issues/44242,1112792801,I_kwDNIULOQlPe4Q,44242,ActiveStorage controllers leak ActiveRecord database connections,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,"[{'login': 'byroot', 'id': 44640, 'node_id': 'MDQ6VXNlcjQ0NjQw', 'avatar_url': 'https://avatars.githubusercontent.com/u/44640?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/byroot', 'html_url': 'https://github.com/byroot', 'followers_url': 'https://api.github.com/users/byroot/followers', 'following_url': 'https://api.github.com/users/byroot/following{/other_user}', 'gists_url': 'https://api.github.com/users/byroot/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/byroot/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/byroot/subscriptions', 'organizations_url': 'https://api.github.com/users/byroot/orgs', 'repos_url': 'https://api.github.com/users/byroot/repos', 'events_url': 'https://api.github.com/users/byroot/events{/privacy}', 'received_events_url': 'https://api.github.com/users/byroot/received_events', 'type': 'User', 'site_admin': False}]",,13,2022-01-24T15:26:19Z,2022-04-16T11:50:01Z,,CONTRIBUTOR,,"We've been noticing a lot of connection pool timeout errors in our application as of recent, all being thrown from the active storage controllers. I.e., the notorious `could not obtain a connection from the pool within 5.000 seconds (waited 5.000 seconds); all pooled connections were in use`.

After a bit of debugging we've noticed that every time the timeout occurs, the connection pool is bunged up with dead threads spawned by ActionController::Live:

```
{:size=>5, :connections=>5, :busy=>0, :dead=>5, :idle=>0, :waiting=>0, :checkout_timeout=>5.0}
#<Thread:0x00007f5d80ad97d0 /var/www/minm/shared/bundle/ruby/3.0.0/gems/actionpack-7.0.0/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007f5d8811c208 /var/www/minm/shared/bundle/ruby/3.0.0/gems/actionpack-7.0.0/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x0000558b8891b838 /var/www/minm/shared/bundle/ruby/3.0.0/gems/actionpack-7.0.0/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007f5d80b488d8 /var/www/minm/shared/bundle/ruby/3.0.0/gems/actionpack-7.0.0/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007f5d80811520 /var/www/minm/shared/bundle/ruby/3.0.0/gems/actionpack-7.0.0/lib/action_controller/metal/live.rb:340 dead>
```

Our connection pool is set to five and our puma workers are capped at five as well, and we aren't using any multithreaded code in our app or gems: Except for ActiveStorage, which spins up a thread to stream blobs back.

Should ActiveStorage/ActionController be checking in these threads before its thread dies?

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

Here's an test file script that logs the connection pool every time a blob is requested. You can see it fill up over time with dead threads:

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""rails"", ""~> 7.0.0""
  gem ""sqlite3""
end

require ""rack/test""
require ""active_record/railtie""
require ""action_controller/railtie""
require ""active_storage/engine""
require ""tmpdir""

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""example.org""
  config.eager_load = false
  config.session_store :cookie_store, key: ""cookie_store_key""
  # config.active_record.legacy_connection_handling = false
  secrets.secret_key_base = ""secret_key_base""

  # config.logger = Logger.new($stdout)
  # Rails.logger  = config.logger

  config.active_storage.service = :local
  config.active_storage.service_configurations = {
    local: {
      root: Dir.tmpdir,
      service: ""Disk""
    }
  }
end


db_path = Rails.root.join('test.sqlite3')
File.delete(db_path) if File.exists? db_path
ENV[""DATABASE_URL""] = ""sqlite3:#{db_path}""

Rails.application.initialize!

Rails.application.routes.disable_clear_and_finalize = true  #add this line
Rails.application.routes.draw do
  get ""/log_connections/:signed_id/*filename"" => 'log_connections#show'
end

require ActiveStorage::Engine.root.join(""db/migrate/20170806125915_create_active_storage_tables.rb"").to_s

ActiveRecord::Schema.define do
  CreateActiveStorageTables.new.change

  create_table :users, force: true
end

class User < ActiveRecord::Base
  has_one_attached :profile
end

class TestController < ActionController::Base
  include Rails.application.routes.url_helpers

  def index
    render plain: ""Home""
  end
end

class LogConnectionsController < ActiveStorage::Blobs::RedirectController
  skip_before_action :verify_authenticity_token
  include Rails.application.routes.url_helpers
  def show
    s = """"
    ActiveRecord::Base.connection_pool.connections.each { |c|
      if c.owner.nil?
        s += ""---\n""
      else
        s += ""#{c.owner.inspect}\n""
      end
    }
    s += ""Current thread: #{Thread.current.inspect}\n""
    puts s
    super
  end
end

require ""minitest/autorun""

class BugTest < Minitest::Test
  include Rack::Test::Methods
  def test_upload_and_download
    user = User.create!(
      profile: {
        content_type: ""text/plain"",
        filename: ""dummy.txt"",
        io: ::StringIO.new(""dummy""),
      }
    )

    10.times do
      get ""/log_connections/#{user.profile.signed_id}/#{user.profile.filename}""
    end
  end

  private
  def app
    Rails.application
  end
end

```

### Actual behavior
```
---
---
---
---
#<Thread:0x00007fac8de0a3a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
Current thread: #<Thread:0x00007fac8de0a3a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
---
---
---
#<Thread:0x00007fac8de714b8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
#<Thread:0x00007fac8de0a3a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
Current thread: #<Thread:0x00007fac8de714b8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
---
---
#<Thread:0x00007fac8de41678 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
#<Thread:0x00007fac8de714b8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007fac8de0a3a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
Current thread: #<Thread:0x00007fac8de41678 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
---
#<Thread:0x00007fac8deaaf38 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
#<Thread:0x00007fac8de41678 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007fac8de714b8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007fac8de0a3a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
Current thread: #<Thread:0x00007fac8deaaf38 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
#<Thread:0x00007fac8df115a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
#<Thread:0x00007fac8deaaf38 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007fac8de41678 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007fac8de714b8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
#<Thread:0x00007fac8de0a3a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 dead>
Current thread: #<Thread:0x00007fac8df115a8 /usr/local/lib/ruby/gems/3.0.0/gems/actionpack-7.0.1/lib/action_controller/metal/live.rb:340 run>
```
<!-- Tell us what happens instead -->


### Expected behavior
I would expect the threads to check back in their connection to the thread pool.
I presume this is happening because active storage is accessing some information on the blob records, which creates an implicit checkout.

### System configuration
**Rails version**:
7.0.0
**Ruby version**:
3.0.3",https://api.github.com/repos/rails/rails/issues/44242/timeline,,bubba,2488460,MDQ6VXNlcjI0ODg0NjA=,https://avatars.githubusercontent.com/u/2488460?v=4,,https://api.github.com/users/bubba,https://github.com/bubba,https://api.github.com/users/bubba/followers,https://api.github.com/users/bubba/following{/other_user},https://api.github.com/users/bubba/gists{/gist_id},https://api.github.com/users/bubba/starred{/owner}{/repo},https://api.github.com/users/bubba/subscriptions,https://api.github.com/users/bubba/orgs,https://api.github.com/users/bubba/repos,https://api.github.com/users/bubba/events{/privacy},https://api.github.com/users/bubba/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44242/reactions,5,5,0,0,0,0,0,0,0,,,,,,,byroot,44640.0,MDQ6VXNlcjQ0NjQw,https://avatars.githubusercontent.com/u/44640?v=4,,https://api.github.com/users/byroot,https://github.com/byroot,https://api.github.com/users/byroot/followers,https://api.github.com/users/byroot/following{/other_user},https://api.github.com/users/byroot/gists{/gist_id},https://api.github.com/users/byroot/starred{/owner}{/repo},https://api.github.com/users/byroot/subscriptions,https://api.github.com/users/byroot/orgs,https://api.github.com/users/byroot/repos,https://api.github.com/users/byroot/events{/privacy},https://api.github.com/users/byroot/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
200,https://api.github.com/repos/rails/rails/issues/44239,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44239/labels{/name},https://api.github.com/repos/rails/rails/issues/44239/comments,https://api.github.com/repos/rails/rails/issues/44239/events,https://github.com/rails/rails/issues/44239,1112080147,I_kwDNIULOQkj_Ew,44239,conflicts between css and js file,"[{'id': 128693, 'node_id': 'MDU6TGFiZWwxMjg2OTM=', 'url': 'https://api.github.com/repos/rails/rails/labels/asset%20pipeline', 'name': 'asset pipeline', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2022-01-24T02:04:20Z,2022-02-01T16:51:07Z,,NONE,,"### Steps to reproduce

I have assets `app/assets/stylesheets/exolve-m.css` and `app/javascript/exolve-m.js`. If I try `import ./exolve-m` in my `application.js` it tries to load `exolve-m.css` and throws an error. I need to explicitly import `./exolve-m.js`

### System configuration
**Rails version**: 7.0.1

**Ruby version**: 3.0.2p107
",https://api.github.com/repos/rails/rails/issues/44239/timeline,,martindemello,16215,MDQ6VXNlcjE2MjE1,https://avatars.githubusercontent.com/u/16215?v=4,,https://api.github.com/users/martindemello,https://github.com/martindemello,https://api.github.com/users/martindemello/followers,https://api.github.com/users/martindemello/following{/other_user},https://api.github.com/users/martindemello/gists{/gist_id},https://api.github.com/users/martindemello/starred{/owner}{/repo},https://api.github.com/users/martindemello/subscriptions,https://api.github.com/users/martindemello/orgs,https://api.github.com/users/martindemello/repos,https://api.github.com/users/martindemello/events{/privacy},https://api.github.com/users/martindemello/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44239/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
201,https://api.github.com/repos/rails/rails/issues/44236,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44236/labels{/name},https://api.github.com/repos/rails/rails/issues/44236/comments,https://api.github.com/repos/rails/rails/issues/44236/events,https://github.com/rails/rails/pull/44236,1111937265,PR_kwDNIULOMXW7Ew,44236,Warn on instantiating records w/ ambiguous columns,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,1,2022-01-23T17:41:18Z,2022-04-23T17:55:57Z,,CONTRIBUTOR,,"### Summary

It is possible to query for models with a result that has duplicate
columns. For example:

```ruby
Post.joins(:author).select(""*"").first
```

will have at least two `id` columns (and possibly more).

Loading record matches the column names and will overwrite
the resulting column several times on duplicates which might
lead to unexpected query results.

Fixes #41151


### Other Information

I'd love to have a better warning message and some feedback if this is the right place to issue this warning.

I've decided to check for duplicates in-line instead of adding another method as it seems `ActiveRecord::Querying` is intentionally slim. I also decided against any clever way of finding duplicate names faster than O(n^2) since the number of columns isn't usually large.
",https://api.github.com/repos/rails/rails/issues/44236/timeline,,khasinski,702380,MDQ6VXNlcjcwMjM4MA==,https://avatars.githubusercontent.com/u/702380?v=4,,https://api.github.com/users/khasinski,https://github.com/khasinski,https://api.github.com/users/khasinski/followers,https://api.github.com/users/khasinski/following{/other_user},https://api.github.com/users/khasinski/gists{/gist_id},https://api.github.com/users/khasinski/starred{/owner}{/repo},https://api.github.com/users/khasinski/subscriptions,https://api.github.com/users/khasinski/orgs,https://api.github.com/users/khasinski/repos,https://api.github.com/users/khasinski/events{/privacy},https://api.github.com/users/khasinski/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44236/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44236,https://github.com/rails/rails/pull/44236,https://github.com/rails/rails/pull/44236.diff,https://github.com/rails/rails/pull/44236.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
202,https://api.github.com/repos/rails/rails/issues/44231,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44231/labels{/name},https://api.github.com/repos/rails/rails/issues/44231/comments,https://api.github.com/repos/rails/rails/issues/44231/events,https://github.com/rails/rails/pull/44231,1110948801,PR_kwDNIULOMWi3qQ,44231,Speed up missing query ,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,0,2022-01-21T21:15:25Z,2022-01-31T23:28:29Z,,CONTRIBUTOR,,"Doing the WHERE on the `join_primary_key` allows postgresql to use an Anti Join:

```
activerecord_unittest=# EXPLAIN SELECT ""posts"".* FROM ""posts"" LEFT OUTER JOIN ""comments"" ON ""comments"".""post_id"" = ""posts"".""id"" WHERE ""comments"".""post_id"" IS NULL;
                              QUERY PLAN
-----------------------------------------------------------------------
 Hash Anti Join  (cost=16.30..42.53 rows=240 width=140)
   Hash Cond: (posts.id = comments.post_id)
   ->  Seq Scan on posts  (cost=0.00..14.80 rows=480 width=140)
   ->  Hash  (cost=12.80..12.80 rows=280 width=4)
         ->  Seq Scan on comments  (cost=0.00..12.80 rows=280 width=4)
```

Previously postgresql would use a Right Join (with a filter):

```
activerecord_unittest=# EXPLAIN SELECT ""posts"".* FROM ""posts"" LEFT OUTER JOIN ""comments"" ON ""comments"".""post_id"" = ""posts"".""id"" WHERE ""comments"".""id"" IS NULL;
                              QUERY PLAN
----------------------------------------------------------------------
 Hash Right Join  (cost=20.80..34.35 rows=2 width=140)
   Hash Cond: (comments.post_id = posts.id)
   Filter: (comments.id IS NULL)
   ->  Seq Scan on comments  (cost=0.00..12.80 rows=280 width=12)
   ->  Hash  (cost=14.80..14.80 rows=480 width=140)
         ->  Seq Scan on posts  (cost=0.00..14.80 rows=480 width=140)
```
This is true for all postgresql versions 9.3 upwards.

On mysql 8.x, MS Server and Oracle 11 there is no difference in query plans (http://sqlfiddle.com/#!9/42c92d2/1):

```
mysql> EXPLAIN SELECT posts.* FROM posts LEFT OUTER JOIN comments ON comments.post_id = posts.id WHERE comments.post_id IS NULL;
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------------------+
| id | select_type | table    | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                                          |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------------------+
|  1 | SIMPLE      | posts    | NULL       | ALL  | NULL          | NULL | NULL    | NULL |   11 |   100.00 | NULL                                                           |
|  1 | SIMPLE      | comments | NULL       | ALL  | NULL          | NULL | NULL    | NULL |   12 |    10.00 | Using where; Not exists; Using join buffer (Block Nested Loop) |
+----+-------------+----------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------------------+
```

On mysql 5.6 with `WHERE comments.id IS NULL` (i.e. using the primary key so before this change) has the same query plan as above.
With this change the query plan is worse:
`WHERE comments.post_id IS NULL` uses ""Using where; Using join buffer (Block Nested Loop)""

If users are expecting missing to be using the primary key and overriding with a rewhere,
as in the specs, then this is not backwards compatiable.  That seems a strange case to
support.",https://api.github.com/repos/rails/rails/issues/44231/timeline,,nikolai-b,6289830,MDQ6VXNlcjYyODk4MzA=,https://avatars.githubusercontent.com/u/6289830?v=4,,https://api.github.com/users/nikolai-b,https://github.com/nikolai-b,https://api.github.com/users/nikolai-b/followers,https://api.github.com/users/nikolai-b/following{/other_user},https://api.github.com/users/nikolai-b/gists{/gist_id},https://api.github.com/users/nikolai-b/starred{/owner}{/repo},https://api.github.com/users/nikolai-b/subscriptions,https://api.github.com/users/nikolai-b/orgs,https://api.github.com/users/nikolai-b/repos,https://api.github.com/users/nikolai-b/events{/privacy},https://api.github.com/users/nikolai-b/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44231/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44231,https://github.com/rails/rails/pull/44231,https://github.com/rails/rails/pull/44231.diff,https://github.com/rails/rails/pull/44231.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
203,https://api.github.com/repos/rails/rails/issues/44226,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44226/labels{/name},https://api.github.com/repos/rails/rails/issues/44226/comments,https://api.github.com/repos/rails/rails/issues/44226/events,https://github.com/rails/rails/issues/44226,1110328333,I_kwDNIULOQi5EDQ,44226,DateTime calculation functions use other timezone offset than the original time,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,5,2022-01-21T10:50:00Z,2022-02-02T16:04:47Z,,NONE,,"
### Steps to reproduce
```ruby
brisbane = TZInfo::Timezone.get('Australia/Brisbane')

local_time_in_brisbane = brisbane.now
local_time_in_brisbane # returns: 2022-01-21 20:32:39.878438 +1000

# actual
local_time_in_brisbane.beginning_of_day # returns: 2022-01-21 00:00:00 +0100

# expected for the beginning of day
local_time_in_brisbane.change(hour: 0, offset: local_time_in_brisbane.timezone_offset.base_utc_offset) # returns: 2022-01-21 00:00:00 +1000
```

### Expected behavior
When trying to get the beginning of the day of a time in a specific timezone, the offset is taken into account 
```ruby
local_time_in_brisbane.beginning_of_day == local_time_in_brisbane.change(hour: 0, offset: local_time_in_brisbane.timezone_offset.base_utc_offset)
```

### Actual behavior
When trying to get the beginning of the day of a time in a specific timezone, the offset is not taken into account and it creates a new DateTime with the local system timezone
```ruby
local_time_in_brisbane.beginning_of_day == local_time_in_brisbane.change(hour: 0)
```

This is the case for all calculations like `beginning_of_day`, `beginning_of_week`, `beginning_of_month`, etc

### System configuration
**Rails version**: 7.0.1
**Ruby version**: 2.7.2
",https://api.github.com/repos/rails/rails/issues/44226/timeline,,emilkappert,7135337,MDQ6VXNlcjcxMzUzMzc=,https://avatars.githubusercontent.com/u/7135337?v=4,,https://api.github.com/users/emilkappert,https://github.com/emilkappert,https://api.github.com/users/emilkappert/followers,https://api.github.com/users/emilkappert/following{/other_user},https://api.github.com/users/emilkappert/gists{/gist_id},https://api.github.com/users/emilkappert/starred{/owner}{/repo},https://api.github.com/users/emilkappert/subscriptions,https://api.github.com/users/emilkappert/orgs,https://api.github.com/users/emilkappert/repos,https://api.github.com/users/emilkappert/events{/privacy},https://api.github.com/users/emilkappert/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44226/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
204,https://api.github.com/repos/rails/rails/issues/44225,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44225/labels{/name},https://api.github.com/repos/rails/rails/issues/44225/comments,https://api.github.com/repos/rails/rails/issues/44225/events,https://github.com/rails/rails/issues/44225,1110284340,I_kwDNIULOQi2YNA,44225,ActionController defaulting response to turbo_stream,[],open,False,,[],,7,2022-01-21T10:07:04Z,2022-02-01T17:52:44Z,,NONE,,"Logging:
```
Started POST ""/messages/sms_post"" for 127.0.0.1 at 2022-01-21 10:50:18 +0100
Processing by MessagesController#sms_post as TURBO_STREAM
  Parameters: {""authenticity_token""=>""[FILTERED]"", ""message""=>{""room_id""=>""1"", ""content""=>""sdfkjsndflwdfsdfksdfk. ~éùìòÇØøÅåΔ^€{}[]~""}, ""commit""=>""Create Message""}
49
1
No template found for MessagesController#sms_post, rendering head :no_content
Completed 204 No Content in 3ms (ActiveRecord: 0.0ms | Allocations: 1108)
```
### Steps to reproduce
where routes define:
```
  resources :messages do
    collection do
      get   :sms_pre
      post  :sms_post
    end
  end
```
these are controller actions (not pertinent to issue) to count SMS characters :
```
  def sms_pre
    @message = Message.new
  end
  
  def sms_post
    sms_count(params[:message][:content])
  end
```
Note: there is a view `<%# turbo_stream.append 'messages', @message %>
<% #return handled by cable %>` but that should not have any impact here.
### Expected behavior

Expecting a posting as 'HTML'

### Actual behavior

`Processing by MessagesController#sms_post as TURBO_STREAM`  was unexpected, as   the only reference to turbo_stream is on the messages_create action
```
  message = Message.create!(message_params)
    respond_to do |format|
      if message.save
        format.turbo_stream
        format.html { redirect_to message_url(@message), notice: ""Message was successfully created."" }
      else
        format.html { render :new, status: :unprocessable_entity }
      end
    end
```
It appears as the POST on an object `.new` is processing via the **first** respond command for the create action *in absence of such a definition in the action itself*

To my recollection Rails < 7 would attempt to render to html by default.   But this could also have been a direction to the first create action rendering definition & I had only experienced HTML.  Just trying to clarify...  
Has this changed in Rails 7? if so, I have not seen the information documented (and my have missed it)

### System configuration
**Rails version**:  7.0.1

**Ruby version**: 3.1
",https://api.github.com/repos/rails/rails/issues/44225/timeline,,dvodvo,716130,MDQ6VXNlcjcxNjEzMA==,https://avatars.githubusercontent.com/u/716130?v=4,,https://api.github.com/users/dvodvo,https://github.com/dvodvo,https://api.github.com/users/dvodvo/followers,https://api.github.com/users/dvodvo/following{/other_user},https://api.github.com/users/dvodvo/gists{/gist_id},https://api.github.com/users/dvodvo/starred{/owner}{/repo},https://api.github.com/users/dvodvo/subscriptions,https://api.github.com/users/dvodvo/orgs,https://api.github.com/users/dvodvo/repos,https://api.github.com/users/dvodvo/events{/privacy},https://api.github.com/users/dvodvo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44225/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
205,https://api.github.com/repos/rails/rails/issues/44203,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44203/labels{/name},https://api.github.com/repos/rails/rails/issues/44203/comments,https://api.github.com/repos/rails/rails/issues/44203/events,https://github.com/rails/rails/pull/44203,1107559131,PR_kwDNIULOMTxkJA,44203,Update and rename getting_started.md to 0-0-0-0-0_getting_started.md,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,1,2022-01-19T02:14:08Z,2022-04-20T02:36:19Z,,NONE,,"Edited for grammar (US English) and readability.  Proposing rename to allow for listing in order.

### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44203/timeline,,Matteo85,2432595,MDQ6VXNlcjI0MzI1OTU=,https://avatars.githubusercontent.com/u/2432595?v=4,,https://api.github.com/users/Matteo85,https://github.com/Matteo85,https://api.github.com/users/Matteo85/followers,https://api.github.com/users/Matteo85/following{/other_user},https://api.github.com/users/Matteo85/gists{/gist_id},https://api.github.com/users/Matteo85/starred{/owner}{/repo},https://api.github.com/users/Matteo85/subscriptions,https://api.github.com/users/Matteo85/orgs,https://api.github.com/users/Matteo85/repos,https://api.github.com/users/Matteo85/events{/privacy},https://api.github.com/users/Matteo85/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44203/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44203,https://github.com/rails/rails/pull/44203,https://github.com/rails/rails/pull/44203.diff,https://github.com/rails/rails/pull/44203.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
206,https://api.github.com/repos/rails/rails/issues/44197,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44197/labels{/name},https://api.github.com/repos/rails/rails/issues/44197/comments,https://api.github.com/repos/rails/rails/issues/44197/events,https://github.com/rails/rails/pull/44197,1107347793,PR_kwDNIULOMTmv2w,44197,"Add Rails configurations to ""about"" command and page.","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,3,2022-01-18T20:47:25Z,2022-04-20T19:47:14Z,,MEMBER,,"### Summary

The `rails about` command and the rails info page (http://localhost:3000//rails/info/properties)
currently show some information like the Rails version, Ruby version,
Application root, etc.

We can expand the information with the framework configurations.
This can help with:
- fixing issues by asking for the configuration;
- debugging configuration changes by examining what changed;
- showing users what configurations are available;
- maybe later showing which configurations diverge from the framework
  defaults;

With this change the `rails about` output would look something like (an excerpt):
```
$ bin/rails about
Rails version             7.1.0.alpha
Ruby version              ruby 2.7.5p203 (2021-11-24 revision f69aeb8314) [x86_64-darwin20]
RubyGems version          3.3.5
Rack version              2.2.3
Middleware                Webpacker::DevServerProxy, ActionDispatch::HostAuthorization, Rack::Sendfile, ActionDispatch::Static, ActionDispatch::Executor, ActiveSupport::Cache::Strategy::LocalCache::Middleware, Rack::Runtime, Rack::MethodOverride, ActionDispatch::RequestId, ActionDispatch::RemoteIp, Sprockets::Rails::QuietAssets, Rails::Rack::Logger, ActionDispatch::ShowExceptions, ActionDispatch::DebugExceptions, ActionDispatch::ActionableExceptions, ActionDispatch::Reloader, ActionDispatch::Callbacks, ActiveRecord::Migration::CheckPending, ActionDispatch::Cookies, ActionDispatch::Session::CookieStore, ActionDispatch::Flash, ActionDispatch::ContentSecurityPolicy::Middleware, ActionDispatch::PermissionsPolicy::Middleware, Rack::Head, Rack::ConditionalGet, Rack::ETag, Rack::TempfileReaper
Application root          /tmp/rails
Environment               development
Database adapter          sqlite3
Database schema version   20210710084447
Configuration             action_controller.asset_host                                     nil
                          action_controller.assets_dir                                     ""/tmp/rails/public""
                          action_controller.cache_store                                    #<ActiveSupport::Cache::NullStore:0x00007fcb47c77d00 @options={:compress=>true, :compress_threshold=>1024}, @coder=ActiveSupport::Cache::Coders::Rails61Coder, @coder_supports_compression=true, @loc...
                          action_controller.default_protect_from_forgery                   true
                          action_controller.forgery_protection_origin_check                true
                          action_controller.javascripts_dir                                ""/tmp/rails/public/javascripts""
                          action_controller.log_query_tags_around_actions                  true
                          action_controller.logger                                         #<ActiveSupport::Logger:0x00007fcb48e46388 @level=0, @progname=nil, @default_formatter=#<Logger::Formatter:0x00007fcb48e46540 @datetime_format=nil>, @formatter=#<ActiveSupport::Logger::SimpleFormat...
                          action_controller.per_form_csrf_tokens                           true
                          action_controller.perform_caching                                false
                          action_controller.raise_on_open_redirects                        false
                          action_controller.relative_url_root                              nil
....
```

The about page could look something like:
<img width=""905"" alt=""image"" src=""https://user-images.githubusercontent.com/28561/150015618-0b402ee8-26f4-492e-8ce3-c8fecc2f0042.png"">

I can work on improving the layout/formatting if this PR is something we want in Rails.",https://api.github.com/repos/rails/rails/issues/44197/timeline,,p8,28561,MDQ6VXNlcjI4NTYx,https://avatars.githubusercontent.com/u/28561?v=4,,https://api.github.com/users/p8,https://github.com/p8,https://api.github.com/users/p8/followers,https://api.github.com/users/p8/following{/other_user},https://api.github.com/users/p8/gists{/gist_id},https://api.github.com/users/p8/starred{/owner}{/repo},https://api.github.com/users/p8/subscriptions,https://api.github.com/users/p8/orgs,https://api.github.com/users/p8/repos,https://api.github.com/users/p8/events{/privacy},https://api.github.com/users/p8/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44197/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44197,https://github.com/rails/rails/pull/44197,https://github.com/rails/rails/pull/44197.diff,https://github.com/rails/rails/pull/44197.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
207,https://api.github.com/repos/rails/rails/issues/44195,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44195/labels{/name},https://api.github.com/repos/rails/rails/issues/44195/comments,https://api.github.com/repos/rails/rails/issues/44195/events,https://github.com/rails/rails/pull/44195,1107081370,PR_kwDNIULOMTY35Q,44195,Fix exception on EtagWithFlash when api_only,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,1,2022-01-18T16:01:42Z,2022-04-19T10:11:50Z,,CONTRIBUTOR,,"### Summary

Fixes https://github.com/rails/rails/issues/44181

### Other Information

It seems that `combine_etags` from https://github.com/rails/rails/blob/main/actionpack/lib/action_controller/metal/conditional_get.rb#L322 adds the flash content on Etag https://github.com/rails/rails/blob/main/actionpack/lib/action_controller/metal/etag_with_flash.rb without considering that Flash might not be defined in api_only applications.",https://api.github.com/repos/rails/rails/issues/44195/timeline,,mihaic195,34626017,MDQ6VXNlcjM0NjI2MDE3,https://avatars.githubusercontent.com/u/34626017?v=4,,https://api.github.com/users/mihaic195,https://github.com/mihaic195,https://api.github.com/users/mihaic195/followers,https://api.github.com/users/mihaic195/following{/other_user},https://api.github.com/users/mihaic195/gists{/gist_id},https://api.github.com/users/mihaic195/starred{/owner}{/repo},https://api.github.com/users/mihaic195/subscriptions,https://api.github.com/users/mihaic195/orgs,https://api.github.com/users/mihaic195/repos,https://api.github.com/users/mihaic195/events{/privacy},https://api.github.com/users/mihaic195/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44195/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44195,https://github.com/rails/rails/pull/44195,https://github.com/rails/rails/pull/44195.diff,https://github.com/rails/rails/pull/44195.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
208,https://api.github.com/repos/rails/rails/issues/44194,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44194/labels{/name},https://api.github.com/repos/rails/rails/issues/44194/comments,https://api.github.com/repos/rails/rails/issues/44194/events,https://github.com/rails/rails/pull/44194,1106646635,PR_kwDNIULOMTCBEw,44194,Move abstract_mysql_adapter_test to mysql2 directory,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,3,2022-01-18T09:06:55Z,2022-04-18T12:11:49Z,,MEMBER,,"### Summary

The test was not being run by the CI as it was outside adapter directories.

This was reported by @yahonda in https://github.com/rails/rails/pull/44094#issuecomment-1007499697

This commit moves the test into `mysql2` directory so it would get run alongside other `mysql2` tests.

/cc @rafaelfranca ",https://api.github.com/repos/rails/rails/issues/44194/timeline,,sikachu,4912,MDQ6VXNlcjQ5MTI=,https://avatars.githubusercontent.com/u/4912?v=4,,https://api.github.com/users/sikachu,https://github.com/sikachu,https://api.github.com/users/sikachu/followers,https://api.github.com/users/sikachu/following{/other_user},https://api.github.com/users/sikachu/gists{/gist_id},https://api.github.com/users/sikachu/starred{/owner}{/repo},https://api.github.com/users/sikachu/subscriptions,https://api.github.com/users/sikachu/orgs,https://api.github.com/users/sikachu/repos,https://api.github.com/users/sikachu/events{/privacy},https://api.github.com/users/sikachu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44194/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44194,https://github.com/rails/rails/pull/44194,https://github.com/rails/rails/pull/44194.diff,https://github.com/rails/rails/pull/44194.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
209,https://api.github.com/repos/rails/rails/issues/44189,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44189/labels{/name},https://api.github.com/repos/rails/rails/issues/44189/comments,https://api.github.com/repos/rails/rails/issues/44189/events,https://github.com/rails/rails/pull/44189,1106141142,PR_kwDNIULOMSoALw,44189,Add `ActiveRecord::Base::generates_token_for`,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2022-01-17T18:10:20Z,2022-04-18T09:41:55Z,,MEMBER,,"Currently, `signed_id` fulfills the role of generating tokens for e.g. resetting a password.  However, signed IDs cannot reflect record state, so if a token is intended to be single-use, it must be tracked in a database at least until it expires.

With `generates_token_for`, a token can embed data from a record.  When using the token to fetch the record, the data from the token and the data from the record will be compared.  If the two do not match, the token will be treated as invalid, the same as if it had expired.  For example:

```ruby
class User < ActiveRecord::Base
  has_secure_password

  generates_token_for :password_reset do
    # BCrypt salt changes when password is updated
    BCrypt::Password.new(password_digest).salt[-10..]
  end
end

user = User.first
token = user.generate_token_for(:password_reset)

User.find_by_token_for(:password_reset, token) # => user

user.update!(password: ""new password"")
User.find_by_token_for(:password_reset, token) # => nil
```

---

This fleshes out https://github.com/rails/rails/pull/43620#issuecomment-975766450.  Closes #43620.

Possible follow-ups:

- Support an `unsigned: true` option to avoid message signing overhead for non-public tokens (e.g. session tokens).
- Enhance `has_secure_password` to also generate a `password_salt` method.
- Add options to `MessageVerfier` to embed ""created at"" time instead of ""expires at"" time in the message.  This would allow `generates_token_for` to precisely expire only tokens that were generated before the current `expires_in` time window, rather than invalidate all tokens that were generated with a different `expires_in`.  (Perhaps this could look something like `verifier.generate(..., expires_later: true)` and `verifier.verify(..., max_age: 15.minutes)`.)
",https://api.github.com/repos/rails/rails/issues/44189/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44189/reactions,3,3,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44189,https://github.com/rails/rails/pull/44189,https://github.com/rails/rails/pull/44189.diff,https://github.com/rails/rails/pull/44189.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
210,https://api.github.com/repos/rails/rails/issues/44187,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44187/labels{/name},https://api.github.com/repos/rails/rails/issues/44187/comments,https://api.github.com/repos/rails/rails/issues/44187/events,https://github.com/rails/rails/pull/44187,1106048399,PR_kwDNIULOMSjJbA,44187,Fix ActiveSupport::Instrumenter: nil can't be coerced into Float,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,2,2022-01-17T16:20:31Z,2022-04-19T14:36:19Z,,CONTRIBUTOR,,"### Summary

- Fixes: https://github.com/rails/rails/issues/44167

",https://api.github.com/repos/rails/rails/issues/44187/timeline,,mihaic195,34626017,MDQ6VXNlcjM0NjI2MDE3,https://avatars.githubusercontent.com/u/34626017?v=4,,https://api.github.com/users/mihaic195,https://github.com/mihaic195,https://api.github.com/users/mihaic195/followers,https://api.github.com/users/mihaic195/following{/other_user},https://api.github.com/users/mihaic195/gists{/gist_id},https://api.github.com/users/mihaic195/starred{/owner}{/repo},https://api.github.com/users/mihaic195/subscriptions,https://api.github.com/users/mihaic195/orgs,https://api.github.com/users/mihaic195/repos,https://api.github.com/users/mihaic195/events{/privacy},https://api.github.com/users/mihaic195/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44187/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44187,https://github.com/rails/rails/pull/44187,https://github.com/rails/rails/pull/44187.diff,https://github.com/rails/rails/pull/44187.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
211,https://api.github.com/repos/rails/rails/issues/44183,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44183/labels{/name},https://api.github.com/repos/rails/rails/issues/44183/comments,https://api.github.com/repos/rails/rails/issues/44183/events,https://github.com/rails/rails/issues/44183,1105177404,I_kwDNIULOQd-rPA,44183,Rails reload! (both in console and using the reloader.reload!) hangs with multi-threaded applications,[],open,False,,[],,2,2022-01-16T20:19:00Z,2022-04-17T18:05:17Z,,NONE,,"### Steps to reproduce

```bash
rails new testme
cd testme
bundle exec rails generate scaffold User
bundle exec rake db:create
bundle exec rake db:migrate
bundle exec rails console
# in the console:
require 'benchmark'
Thread.new { User.create!; sleep(100) }
# wait for 1 second and run reload - it will hang for around 10 seconds
puts Benchmark.measure { reload! }
# 0.019528   0.000312   0.019840 ( 10.028938)
```

### Expected behavior
Since the thread is sleeping after user creation and does nothing, I would expect not to hang for such a long time.

### Actual behavior

It hangs for 10 seconds. Same happens when reloading from within a process that includes Rails. It hangs for 10 seconds despite the fact that the thread is sleeping more. Even if thread is sleeping shorted period of time (lets say 5s), the reload takes 10.

This is in particular problematic for processes running with Rails in a dev mode, where threads are long living (worker polls for example) and blocked on a `Queue#pop`.

I confirmed this problem affects `sqlite` as well as `pg`.

### System configuration

**Rails & Ruby version**:
```
About your application's environment
Rails version             7.0.1
Ruby version              ruby 3.0.3p157 (2021-11-24 revision 3fb7d2cadc) [x86_64-linux]
RubyGems version          3.2.32
Rack version              2.2.3
Middleware                ActionDispatch::HostAuthorization, Rack::Sendfile, ActionDispatch::Static, ActionDispatch::Executor, ActionDispatch::ServerTiming, ActiveSupport::Cache::Strategy::LocalCache::Middleware, Rack::Runtime, Rack::MethodOverride, ActionDispatch::RequestId, ActionDispatch::RemoteIp, Sprockets::Rails::QuietAssets, Rails::Rack::Logger, ActionDispatch::ShowExceptions, WebConsole::Middleware, ActionDispatch::DebugExceptions, ActionDispatch::ActionableExceptions, ActionDispatch::Reloader, ActionDispatch::Callbacks, ActiveRecord::Migration::CheckPending, ActionDispatch::Cookies, ActionDispatch::Session::CookieStore, ActionDispatch::Flash, ActionDispatch::ContentSecurityPolicy::Middleware, ActionDispatch::PermissionsPolicy::Middleware, Rack::Head, Rack::ConditionalGet, Rack::ETag, Rack::TempfileReaper
Application root          /home/mencio/Software/testme
Environment               development
Database adapter          sqlite3
Database schema version   20220116201051
```",https://api.github.com/repos/rails/rails/issues/44183/timeline,,mensfeld,392754,MDQ6VXNlcjM5Mjc1NA==,https://avatars.githubusercontent.com/u/392754?v=4,,https://api.github.com/users/mensfeld,https://github.com/mensfeld,https://api.github.com/users/mensfeld/followers,https://api.github.com/users/mensfeld/following{/other_user},https://api.github.com/users/mensfeld/gists{/gist_id},https://api.github.com/users/mensfeld/starred{/owner}{/repo},https://api.github.com/users/mensfeld/subscriptions,https://api.github.com/users/mensfeld/orgs,https://api.github.com/users/mensfeld/repos,https://api.github.com/users/mensfeld/events{/privacy},https://api.github.com/users/mensfeld/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44183/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
212,https://api.github.com/repos/rails/rails/issues/44182,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44182/labels{/name},https://api.github.com/repos/rails/rails/issues/44182/comments,https://api.github.com/repos/rails/rails/issues/44182/events,https://github.com/rails/rails/issues/44182,1105033853,I_kwDNIULOQd16fQ,44182,Basic Rails 7 project with Bootstrap fails,[],open,False,,[],,11,2022-01-16T12:05:31Z,2022-02-20T19:56:49Z,,NONE,,"### Steps to reproduce
```
rails new testapp -d postgresql -c bootstrap
cd testapp
bin/dev
```

### Expected behavior
App should launch and automatically include the bootstrap/hotwired/stimulus javascript packages

### Actual behavior
the yarn build stage reports these errors:
```
22:01:44 js.1   | ✘ [ERROR] Could not resolve ""@hotwired/turbo-rails""
22:01:44 js.1   |
22:01:44 js.1   |     app/javascript/application.js:2:7:
22:01:44 js.1   |       2 │ import ""@hotwired/turbo-rails""
22:01:44 js.1   |         ╵        ~~~~~~~~~~~~~~~~~~~~~~~
22:01:44 js.1   |
22:01:44 js.1   |   You can mark the path ""@hotwired/turbo-rails"" as external to exclude it from the bundle, which will remove this error.
22:01:44 js.1   |
22:01:44 js.1   | ✘ [ERROR] Could not resolve ""bootstrap""
22:01:44 js.1   |
22:01:44 js.1   |     app/javascript/application.js:4:27:
22:01:44 js.1   |       4 │ import * as bootstrap from ""bootstrap""
22:01:44 js.1   |         ╵                            ~~~~~~~~~~~
22:01:44 js.1   |
22:01:44 js.1   |   You can mark the path ""bootstrap"" as external to exclude it from the bundle, which will remove this error.
22:01:44 js.1   |
22:01:44 js.1   | ✘ [ERROR] Could not resolve ""@hotwired/stimulus""
22:01:44 js.1   |
22:01:44 js.1   |     app/javascript/controllers/hello_controller.js:1:27:
22:01:44 js.1   |       1 │ import { Controller } from ""@hotwired/stimulus""
22:01:44 js.1   |         ╵                            ~~~~~~~~~~~~~~~~~~~~
22:01:44 js.1   |
22:01:44 js.1   |   You can mark the path ""@hotwired/stimulus"" as external to exclude it from the bundle, which will remove this error.
22:01:44 js.1   |
22:01:44 js.1   | ✘ [ERROR] Could not resolve ""@hotwired/stimulus""
22:01:44 js.1   |
22:01:44 js.1   |     app/javascript/controllers/application.js:1:28:
22:01:44 js.1   |       1 │ import { Application } from ""@hotwired/stimulus""
22:01:44 js.1   |         ╵                             ~~~~~~~~~~~~~~~~~~~~
22:01:44 js.1   |
22:01:44 js.1   |   You can mark the path ""@hotwired/stimulus"" as external to exclude it from the bundle, which will remove this error.
22:01:44 js.1   |
22:01:44 js.1   | 4 errors
22:01:44 js.1   | [watch] build finished, watching for **changes...**
```

and the yarn build-css stage reports this error:
```
22:01:45 css.1  | Error: Can't find stylesheet to import.
22:01:45 css.1  |   ╷
22:01:45 css.1  | 1 │ @import 'bootstrap/scss/bootstrap';
22:01:45 css.1  |   │         ^^^^^^^^^^^^^^^^^^^^^^^^^^
22:01:45 css.1  |   ╵
22:01:45 css.1  |   app/assets/stylesheets/application.bootstrap.scss 1:9  root stylesheet
22:01:45 css.1  |
22:01:45 css.1  | Sass is watching for changes. Press Ctrl-C to stop.
```

### System configuration
```
testapp$ rails -v
Rails 7.0.1
```
```
testapp$ ruby -v
ruby 3.1.0p0 (2021-12-25 revision fb4df44d16) [x86_64-linux]
```
```
testapp$ node -v
v17.3.1
```
```
testapp$ yarn -v
3.1.1
```",https://api.github.com/repos/rails/rails/issues/44182/timeline,,LukevanTricht,910161,MDQ6VXNlcjkxMDE2MQ==,https://avatars.githubusercontent.com/u/910161?v=4,,https://api.github.com/users/LukevanTricht,https://github.com/LukevanTricht,https://api.github.com/users/LukevanTricht/followers,https://api.github.com/users/LukevanTricht/following{/other_user},https://api.github.com/users/LukevanTricht/gists{/gist_id},https://api.github.com/users/LukevanTricht/starred{/owner}{/repo},https://api.github.com/users/LukevanTricht/subscriptions,https://api.github.com/users/LukevanTricht/orgs,https://api.github.com/users/LukevanTricht/repos,https://api.github.com/users/LukevanTricht/events{/privacy},https://api.github.com/users/LukevanTricht/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44182/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
213,https://api.github.com/repos/rails/rails/issues/44181,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44181/labels{/name},https://api.github.com/repos/rails/rails/issues/44181/comments,https://api.github.com/repos/rails/rails/issues/44181/events,https://github.com/rails/rails/issues/44181,1105001559,I_kwDNIULOQdz8Vw,44181,ActiveStorage proxy with rails api only requiring Flash middleware,"[{'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,7,2022-01-16T09:32:55Z,2022-04-19T07:11:53Z,,CONTRIBUTOR,,"### Steps to reproduce
When using activestorage proxy model with a rails api only project, the generated proxy urls crashes because they internally rely on Flash middleware which is not needed in an api only project.

Demo Source Code: https://github.com/uxxman/rails_api_activestorage_proxy

Reproduction steps can be easily followed by following commits: https://github.com/uxxman/rails_api_activestorage_proxy/commits/main

```shell
git clone git@github.com:uxxman/rails_api_activestorage_proxy.git
cd rails_api_activestorage_proxy
bundle
rails db:create
rails db:migrate
rails db:seed

rails c
Rails.application.routes.url_helpers.rails_storage_proxy_url(Post.first.image)  # => ""http://localhost:3000/rails/active_storage/blobs/proxy/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBCZz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--2bbf8adb6c6562438e67001421f572551360c8c6/image.png""
```

Now, with rails server running, if we open the above proxied url, we get

```json
{""status"":500,""error"":""Internal Server Error"",""exception"":""#\u003cNoMethodError: undefined method `flash' for #\u003cActionDispatch::Request GET \""http://localhost:3000/rails/active_storage/blobs/proxy/eyJfcmFpbHMiOnsibWVzc2FnZSI6IkJBaHBCZz09IiwiZXhwIjpudWxsLCJwdXIiOiJibG9iX2lkIn19--2bbf8adb6c6562438e67001421f572551360c8c6/image.png\"" for ::1\u003e\u003e"",""traces"":{""Application Trace"":[],""Framework Trace"":[{""exception_object_id"":17580,""id"":0,""trace"":""actionpack (7.0.1) lib/action_controller/metal/flash.rb:10:in `flash'""},{""exception_object_id"":17580,""id"":1,""trace"":""actionpack (7.0.1) lib/action_controller/metal/etag_with_flash.rb:15:in `block (2 levels) in \u003cmodule:EtagWithFlash\u003e'""},{""exception_object_id"":17580,""id"":2,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `instance_exec'""},{""exception_object_id"":17580,""id"":3,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `block in combine_etags'""},{""exception_object_id"":17580,""id"":4,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `map'""},{""exception_object_id"":17580,""id"":5,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `combine_etags'""},{""exception_object_id"":17580,""id"":6,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:126:in `fresh_when'""},{""exception_object_id"":17580,""id"":7,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:250:in `stale?'""},{""exception_object_id"":17580,""id"":8,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:309:in `http_cache_forever'""},{""exception_object_id"":17580,""id"":9,""trace"":""activestorage (7.0.1) app/controllers/active_storage/blobs/proxy_controller.rb:16:in `show'""},{""exception_object_id"":17580,""id"":10,""trace"":""actionpack (7.0.1) lib/action_controller/metal/basic_implicit_render.rb:6:in `send_action'""},{""exception_object_id"":17580,""id"":11,""trace"":""actionpack (7.0.1) lib/abstract_controller/base.rb:214:in `process_action'""},{""exception_object_id"":17580,""id"":12,""trace"":""actionpack (7.0.1) lib/action_controller/metal/rendering.rb:53:in `process_action'""},{""exception_object_id"":17580,""id"":13,""trace"":""actionpack (7.0.1) lib/abstract_controller/callbacks.rb:234:in `block in process_action'""},{""exception_object_id"":17580,""id"":14,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:118:in `block in run_callbacks'""},{""exception_object_id"":17580,""id"":15,""trace"":""actiontext (7.0.1) lib/action_text/rendering.rb:20:in `with_renderer'""},{""exception_object_id"":17580,""id"":16,""trace"":""actiontext (7.0.1) lib/action_text/engine.rb:69:in `block (4 levels) in \u003cclass:Engine\u003e'""},{""exception_object_id"":17580,""id"":17,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:127:in `instance_exec'""},{""exception_object_id"":17580,""id"":18,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:127:in `block in run_callbacks'""},{""exception_object_id"":17580,""id"":19,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:138:in `run_callbacks'""},{""exception_object_id"":17580,""id"":20,""trace"":""actionpack (7.0.1) lib/abstract_controller/callbacks.rb:233:in `process_action'""},{""exception_object_id"":17580,""id"":21,""trace"":""actionpack (7.0.1) lib/action_controller/metal/rescue.rb:22:in `process_action'""},{""exception_object_id"":17580,""id"":22,""trace"":""actionpack (7.0.1) lib/action_controller/metal/instrumentation.rb:67:in `block in process_action'""},{""exception_object_id"":17580,""id"":23,""trace"":""activesupport (7.0.1) lib/active_support/notifications.rb:206:in `block in instrument'""},{""exception_object_id"":17580,""id"":24,""trace"":""activesupport (7.0.1) lib/active_support/notifications/instrumenter.rb:24:in `instrument'""},{""exception_object_id"":17580,""id"":25,""trace"":""activesupport (7.0.1) lib/active_support/notifications.rb:206:in `instrument'""},{""exception_object_id"":17580,""id"":26,""trace"":""actionpack (7.0.1) lib/action_controller/metal/instrumentation.rb:66:in `process_action'""},{""exception_object_id"":17580,""id"":27,""trace"":""actionpack (7.0.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'""},{""exception_object_id"":17580,""id"":28,""trace"":""activerecord (7.0.1) lib/active_record/railties/controller_runtime.rb:27:in `process_action'""},{""exception_object_id"":17580,""id"":29,""trace"":""actionpack (7.0.1) lib/abstract_controller/base.rb:151:in `process'""},{""exception_object_id"":17580,""id"":30,""trace"":""actionview (7.0.1) lib/action_view/rendering.rb:39:in `process'""},{""exception_object_id"":17580,""id"":31,""trace"":""actionpack (7.0.1) lib/action_controller/metal/live.rb:266:in `block (2 levels) in process'""},{""exception_object_id"":17580,""id"":32,""trace"":""activesupport (7.0.1) lib/active_support/concurrency/share_lock.rb:162:in `sharing'""},{""exception_object_id"":17580,""id"":33,""trace"":""activesupport (7.0.1) lib/active_support/dependencies/interlock.rb:37:in `running'""},{""exception_object_id"":17580,""id"":34,""trace"":""actionpack (7.0.1) lib/action_controller/metal/live.rb:258:in `block in process'""},{""exception_object_id"":17580,""id"":35,""trace"":""actionpack (7.0.1) lib/action_controller/metal/live.rb:343:in `block in new_controller_thread'""}],""Full Trace"":[{""exception_object_id"":17580,""id"":0,""trace"":""actionpack (7.0.1) lib/action_controller/metal/flash.rb:10:in `flash'""},{""exception_object_id"":17580,""id"":1,""trace"":""actionpack (7.0.1) lib/action_controller/metal/etag_with_flash.rb:15:in `block (2 levels) in \u003cmodule:EtagWithFlash\u003e'""},{""exception_object_id"":17580,""id"":2,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `instance_exec'""},{""exception_object_id"":17580,""id"":3,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `block in combine_etags'""},{""exception_object_id"":17580,""id"":4,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `map'""},{""exception_object_id"":17580,""id"":5,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:322:in `combine_etags'""},{""exception_object_id"":17580,""id"":6,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:126:in `fresh_when'""},{""exception_object_id"":17580,""id"":7,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:250:in `stale?'""},{""exception_object_id"":17580,""id"":8,""trace"":""actionpack (7.0.1) lib/action_controller/metal/conditional_get.rb:309:in `http_cache_forever'""},{""exception_object_id"":17580,""id"":9,""trace"":""activestorage (7.0.1) app/controllers/active_storage/blobs/proxy_controller.rb:16:in `show'""},{""exception_object_id"":17580,""id"":10,""trace"":""actionpack (7.0.1) lib/action_controller/metal/basic_implicit_render.rb:6:in `send_action'""},{""exception_object_id"":17580,""id"":11,""trace"":""actionpack (7.0.1) lib/abstract_controller/base.rb:214:in `process_action'""},{""exception_object_id"":17580,""id"":12,""trace"":""actionpack (7.0.1) lib/action_controller/metal/rendering.rb:53:in `process_action'""},{""exception_object_id"":17580,""id"":13,""trace"":""actionpack (7.0.1) lib/abstract_controller/callbacks.rb:234:in `block in process_action'""},{""exception_object_id"":17580,""id"":14,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:118:in `block in run_callbacks'""},{""exception_object_id"":17580,""id"":15,""trace"":""actiontext (7.0.1) lib/action_text/rendering.rb:20:in `with_renderer'""},{""exception_object_id"":17580,""id"":16,""trace"":""actiontext (7.0.1) lib/action_text/engine.rb:69:in `block (4 levels) in \u003cclass:Engine\u003e'""},{""exception_object_id"":17580,""id"":17,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:127:in `instance_exec'""},{""exception_object_id"":17580,""id"":18,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:127:in `block in run_callbacks'""},{""exception_object_id"":17580,""id"":19,""trace"":""activesupport (7.0.1) lib/active_support/callbacks.rb:138:in `run_callbacks'""},{""exception_object_id"":17580,""id"":20,""trace"":""actionpack (7.0.1) lib/abstract_controller/callbacks.rb:233:in `process_action'""},{""exception_object_id"":17580,""id"":21,""trace"":""actionpack (7.0.1) lib/action_controller/metal/rescue.rb:22:in `process_action'""},{""exception_object_id"":17580,""id"":22,""trace"":""actionpack (7.0.1) lib/action_controller/metal/instrumentation.rb:67:in `block in process_action'""},{""exception_object_id"":17580,""id"":23,""trace"":""activesupport (7.0.1) lib/active_support/notifications.rb:206:in `block in instrument'""},{""exception_object_id"":17580,""id"":24,""trace"":""activesupport (7.0.1) lib/active_support/notifications/instrumenter.rb:24:in `instrument'""},{""exception_object_id"":17580,""id"":25,""trace"":""activesupport (7.0.1) lib/active_support/notifications.rb:206:in `instrument'""},{""exception_object_id"":17580,""id"":26,""trace"":""actionpack (7.0.1) lib/action_controller/metal/instrumentation.rb:66:in `process_action'""},{""exception_object_id"":17580,""id"":27,""trace"":""actionpack (7.0.1) lib/action_controller/metal/params_wrapper.rb:259:in `process_action'""},{""exception_object_id"":17580,""id"":28,""trace"":""activerecord (7.0.1) lib/active_record/railties/controller_runtime.rb:27:in `process_action'""},{""exception_object_id"":17580,""id"":29,""trace"":""actionpack (7.0.1) lib/abstract_controller/base.rb:151:in `process'""},{""exception_object_id"":17580,""id"":30,""trace"":""actionview (7.0.1) lib/action_view/rendering.rb:39:in `process'""},{""exception_object_id"":17580,""id"":31,""trace"":""actionpack (7.0.1) lib/action_controller/metal/live.rb:266:in `block (2 levels) in process'""},{""exception_object_id"":17580,""id"":32,""trace"":""activesupport (7.0.1) lib/active_support/concurrency/share_lock.rb:162:in `sharing'""},{""exception_object_id"":17580,""id"":33,""trace"":""activesupport (7.0.1) lib/active_support/dependencies/interlock.rb:37:in `running'""},{""exception_object_id"":17580,""id"":34,""trace"":""actionpack (7.0.1) lib/action_controller/metal/live.rb:258:in `block in process'""},{""exception_object_id"":17580,""id"":35,""trace"":""actionpack (7.0.1) lib/action_controller/metal/live.rb:343:in `block in new_controller_thread'""}]}}
```

### Expected behavior
It should not rely on Flash middleware

### Actual behavior
It relies in Flash middleware

### System configuration
**Rails version**: 7.0.1

**Ruby version**: 3.1.0
",https://api.github.com/repos/rails/rails/issues/44181/timeline,,uxxman,3153380,MDQ6VXNlcjMxNTMzODA=,https://avatars.githubusercontent.com/u/3153380?v=4,,https://api.github.com/users/uxxman,https://github.com/uxxman,https://api.github.com/users/uxxman/followers,https://api.github.com/users/uxxman/following{/other_user},https://api.github.com/users/uxxman/gists{/gist_id},https://api.github.com/users/uxxman/starred{/owner}{/repo},https://api.github.com/users/uxxman/subscriptions,https://api.github.com/users/uxxman/orgs,https://api.github.com/users/uxxman/repos,https://api.github.com/users/uxxman/events{/privacy},https://api.github.com/users/uxxman/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44181/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
214,https://api.github.com/repos/rails/rails/issues/44179,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44179/labels{/name},https://api.github.com/repos/rails/rails/issues/44179/comments,https://api.github.com/repos/rails/rails/issues/44179/events,https://github.com/rails/rails/pull/44179,1104841087,PR_kwDNIULOMRlEow,44179,Add `MessageVerifiers` and `MessageEncryptors` classes,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,0,2022-01-15T20:27:09Z,2022-02-05T17:11:05Z,,MEMBER,,"Currently, `Rails.application.message_verifier(name)` returns a `MessageVerifier` instance using a secret derived from the given `name`.  Instances created this way always generate messages using the default options for `MessageVerifier.new`.  Also, if there are older options to rotate when verifying messages, each instance must be configured individually with those options.  In cases where Rails itself uses `Rails.application.message_verifier` (e.g. [in Active Storage](https://github.com/rails/rails/blob/83a4fa414bc9e5008825f47857fdd80e85c82033/activestorage/lib/active_storage/engine.rb#L121)), discovering the name of the instance may require digging through Rails' source code.

To alleviate these issues, `MessageVerifiers` acts as a central point for configuring and creating `MessageVerifier` instances.  Options passed to `MessageVerifiers#rotate` will be applied to `MessageVerifier` instances that `MessageVerifiers#[]` creates.  So the following:

```ruby
foo_verifier = Rails.application.message_verifier(""foo"")
foo_verifier.rotate(old_options)
bar_verifier = Rails.application.message_verifier(""bar"")
bar_verifier.rotate(old_options)
```

Can be rewritten as:

```ruby
Rails.application.message_verifiers.rotate(old_options)
foo_verifier = Rails.application.message_verifiers[""foo""]
bar_verifier = Rails.application.message_verifiers[""bar""]
```

Additionally, `MessageVerifiers` memoizes `MessageVerifier` instances.  This also allows `MessageVerifier` instances to be overridden entirely:

```ruby
Rails.application.message_verifiers[""foo""] = ActiveSupport::MessageVerifier.new(other_secret)
```

For parity, `MessageEncryptors` fulfills the same role for `MessageEncryptor` instances.
",https://api.github.com/repos/rails/rails/issues/44179/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44179/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44179,https://github.com/rails/rails/pull/44179,https://github.com/rails/rails/pull/44179.diff,https://github.com/rails/rails/pull/44179.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
215,https://api.github.com/repos/rails/rails/issues/44175,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44175/labels{/name},https://api.github.com/repos/rails/rails/issues/44175/comments,https://api.github.com/repos/rails/rails/issues/44175/events,https://github.com/rails/rails/pull/44175,1104064625,PR_kwDNIULOMQ6hxw,44175,Add net-http dependency to frameworks using mail,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,7,2022-01-14T19:45:38Z,2022-01-27T20:07:54Z,,MEMBER,,"In [5dd292f5][] we added net- gems as dependencies of actionmailbox  and
actionmailer.

That caused warnings in our Ruby 2.7 builds, where `net-protocol` is
getting loaded twice—both as a gem and as a Ruby library. These warnings
are visible in [buildkite][].

```
/usr/local/lib/ruby/2.7.0/net/protocol.rb:66: warning: already initialized constant Net::ProtocRetryError
/usr/local/bundle/gems/net-protocol-0.1.2/lib/net/protocol.rb:68: warning: previous definition of ProtocRetryError was here
```

[5dd292f5]: https://github.com/rails/rails/commit/5dd292f5511fedd91833dc8482baf696cb821af6
[buildkite]: https://buildkite.com/rails/rails/builds/84010#60f6c08a-f35d-4b87-a56d-2d06d43e8ee3

It's getting loaded twice because the net-http that ships with Ruby 2.7
has a [`require_relative ""protocol""`][ruby lib] that causes it to always
load the library in Ruby instead of the gem. By using the `net-http` gem
as well, we [avoid this problem][gem].

[ruby lib]: https://github.com/ruby/ruby/blob/v2_7_3/lib/net/http.rb#L23
[gem]: https://github.com/ruby/net-http/blob/38d8a19454faa74d892380846a2ba4d3e86487b9/lib/net/http.rb#L23

These warnings are also visibile in brand new rails apps created off
main, for example by running:

```
ruby -v
=> 2.7.3
rails new my_app --main
cd my_app
rails test
```

Loading multiple versions of the same gem can also cause cryptic
warnings. For example if you install [webmock][] and enable it before
loading any Rails application files (something we do at GitHub), you can
end up with an error:

```
`<module:Net>': superclass mismatch for class InternetMessageIO (TypeError)
```

[webmock]: https://github.com/bblimke/webmock

This commit does pull in URI, which can cause warnings when using
versions of bundler older than 2.2.33. But we've already got warnings
related to the digest gem when using bundler versions older than 2.3.0:
before this [PR removing digest as a bundler dependency][digest] we end
up loading two version and getting the warnings:

```
ruby/2.7.3/lib/ruby/gems/2.7.0/gems/digest-3.1.0/lib/digest.rb:20: warning: already initialized constant Digest::REQUIRE_MUTEX
ruby/2.7.3/lib/ruby/2.7.0/digest.rb:6: warning: previous definition of REQUIRE_MUTEX was here
```

[digest]: https://github.com/rubygems/rubygems/pull/4989/commits/c19a9f2ff71e91387eca88708910bb6e99f54db6

With or without this commit, we may need to either drop Ruby 2.7 support
or bump the minimum version of bundler if we want the warnings to go
away entirely.

Co-authored-by: Nick Holden",https://api.github.com/repos/rails/rails/issues/44175/timeline,,composerinteralia,13696143,MDQ6VXNlcjEzNjk2MTQz,https://avatars.githubusercontent.com/u/13696143?v=4,,https://api.github.com/users/composerinteralia,https://github.com/composerinteralia,https://api.github.com/users/composerinteralia/followers,https://api.github.com/users/composerinteralia/following{/other_user},https://api.github.com/users/composerinteralia/gists{/gist_id},https://api.github.com/users/composerinteralia/starred{/owner}{/repo},https://api.github.com/users/composerinteralia/subscriptions,https://api.github.com/users/composerinteralia/orgs,https://api.github.com/users/composerinteralia/repos,https://api.github.com/users/composerinteralia/events{/privacy},https://api.github.com/users/composerinteralia/received_events,User,True,https://api.github.com/repos/rails/rails/issues/44175/reactions,6,6,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44175,https://github.com/rails/rails/pull/44175,https://github.com/rails/rails/pull/44175.diff,https://github.com/rails/rails/pull/44175.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
216,https://api.github.com/repos/rails/rails/issues/44169,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44169/labels{/name},https://api.github.com/repos/rails/rails/issues/44169/comments,https://api.github.com/repos/rails/rails/issues/44169/events,https://github.com/rails/rails/issues/44169,1102212962,I_kwDNIULOQbJvYg,44169,[Rails 7] load_async for find_by_sql & Base.connection.execute,[],open,False,,"[{'login': 'byroot', 'id': 44640, 'node_id': 'MDQ6VXNlcjQ0NjQw', 'avatar_url': 'https://avatars.githubusercontent.com/u/44640?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/byroot', 'html_url': 'https://github.com/byroot', 'followers_url': 'https://api.github.com/users/byroot/followers', 'following_url': 'https://api.github.com/users/byroot/following{/other_user}', 'gists_url': 'https://api.github.com/users/byroot/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/byroot/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/byroot/subscriptions', 'organizations_url': 'https://api.github.com/users/byroot/orgs', 'repos_url': 'https://api.github.com/users/byroot/repos', 'events_url': 'https://api.github.com/users/byroot/events{/privacy}', 'received_events_url': 'https://api.github.com/users/byroot/received_events', 'type': 'User', 'site_admin': False}]",,5,2022-01-13T19:20:38Z,2022-03-27T06:31:46Z,,NONE,,"Hey guys,

Is it possible to use load_async to asynchronously execute .find_by_sql or ActiveRecord::Base.connection.execute(sql) methods?

We are using a lot of custom SQL and would love to run multiple queries at once in order to speed up our application.

Please let me know if this is possible via load_async of if there are good alternatives.
",https://api.github.com/repos/rails/rails/issues/44169/timeline,,OskarEichler,62393985,MDQ6VXNlcjYyMzkzOTg1,https://avatars.githubusercontent.com/u/62393985?v=4,,https://api.github.com/users/OskarEichler,https://github.com/OskarEichler,https://api.github.com/users/OskarEichler/followers,https://api.github.com/users/OskarEichler/following{/other_user},https://api.github.com/users/OskarEichler/gists{/gist_id},https://api.github.com/users/OskarEichler/starred{/owner}{/repo},https://api.github.com/users/OskarEichler/subscriptions,https://api.github.com/users/OskarEichler/orgs,https://api.github.com/users/OskarEichler/repos,https://api.github.com/users/OskarEichler/events{/privacy},https://api.github.com/users/OskarEichler/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44169/reactions,4,0,0,0,0,0,2,2,0,,,,,,,byroot,44640.0,MDQ6VXNlcjQ0NjQw,https://avatars.githubusercontent.com/u/44640?v=4,,https://api.github.com/users/byroot,https://github.com/byroot,https://api.github.com/users/byroot/followers,https://api.github.com/users/byroot/following{/other_user},https://api.github.com/users/byroot/gists{/gist_id},https://api.github.com/users/byroot/starred{/owner}{/repo},https://api.github.com/users/byroot/subscriptions,https://api.github.com/users/byroot/orgs,https://api.github.com/users/byroot/repos,https://api.github.com/users/byroot/events{/privacy},https://api.github.com/users/byroot/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
217,https://api.github.com/repos/rails/rails/issues/44165,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44165/labels{/name},https://api.github.com/repos/rails/rails/issues/44165/comments,https://api.github.com/repos/rails/rails/issues/44165/events,https://github.com/rails/rails/issues/44165,1101852288,I_kwDNIULOQazugA,44165,[ActiveStorage::Variant] Calling `variant.key` on a preloaded object should not trigger a database `Load`,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,1,2022-01-13T14:30:46Z,2022-02-01T17:21:58Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
user = user.avatar.includes(avatar_attachment: [blob: variation_records])

variant = user.avatar.variant({ format: :webp, resize_to_fill: [200, 200] })

# works without load
variant.blob.key
# works without load
variant.variation.key

# triggers database load of ActiveRecord::Attachment and ActiveRecord::Blob
variant.key
```

### Expected behavior
When I call `ActiveStorage::Variant.key` on a preloaded database object `ActiveRecord::Attachment` and `ActiveRecord::Blob` should not be loaded from the database again. 

The method `key` according to the code calls `blob.key` and `variation.key` 
```ruby
  def key
    ""variants/#{blob.key}/#{OpenSSL::Digest::SHA256.hexdigest(variation.key)}""
  end
```
Both attributes can be called directly from the object without triggering a load.

### Actual behavior
Calling `variant.key` on a preloaded database object triggers a database load.

### System configuration
**Ruby version**: `2.7.5`

**Rails version**: `6.1.4` - tested on `7.0.1` as well
",https://api.github.com/repos/rails/rails/issues/44165/timeline,,nduitz,42961155,MDQ6VXNlcjQyOTYxMTU1,https://avatars.githubusercontent.com/u/42961155?v=4,,https://api.github.com/users/nduitz,https://github.com/nduitz,https://api.github.com/users/nduitz/followers,https://api.github.com/users/nduitz/following{/other_user},https://api.github.com/users/nduitz/gists{/gist_id},https://api.github.com/users/nduitz/starred{/owner}{/repo},https://api.github.com/users/nduitz/subscriptions,https://api.github.com/users/nduitz/orgs,https://api.github.com/users/nduitz/repos,https://api.github.com/users/nduitz/events{/privacy},https://api.github.com/users/nduitz/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44165/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
218,https://api.github.com/repos/rails/rails/issues/44160,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44160/labels{/name},https://api.github.com/repos/rails/rails/issues/44160/comments,https://api.github.com/repos/rails/rails/issues/44160/events,https://github.com/rails/rails/issues/44160,1100740034,I_kwDNIULOQZv1wg,44160,field_error_proc does not trigger on belongs_to association without explicit validation on <association>_id,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2022-01-12T20:03:36Z,2022-02-01T17:47:30Z,,NONE,,"### Steps to reproduce
1. add `belongs_to :association` to model
2. add form element with `:association_id` property
3. submit form without assignment

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", '~> 7.0.0'
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post, optional: false
end

class BugTest < Minitest::Test
  def test_error_on_field
    comment = Comment.new

    assert_equal false, comment.valid?
    assert_equal true, comment.errors[:post_id].present?
  end
end
```

### Expected behavior
`#field_error_proc` should trigger and wrap form element in `.field_with_errors` element.

### Actual behavior
`#field_error_proc` does _not_ trigger and wrap form element in `.field_with_errors` element because `#object_has_errors?` returns false.

### System configuration
**Rails version**: Rails 7.0.1

**Ruby version**: Ruby 3.1",https://api.github.com/repos/rails/rails/issues/44160/timeline,,guaguasi,1447611,MDQ6VXNlcjE0NDc2MTE=,https://avatars.githubusercontent.com/u/1447611?v=4,,https://api.github.com/users/guaguasi,https://github.com/guaguasi,https://api.github.com/users/guaguasi/followers,https://api.github.com/users/guaguasi/following{/other_user},https://api.github.com/users/guaguasi/gists{/gist_id},https://api.github.com/users/guaguasi/starred{/owner}{/repo},https://api.github.com/users/guaguasi/subscriptions,https://api.github.com/users/guaguasi/orgs,https://api.github.com/users/guaguasi/repos,https://api.github.com/users/guaguasi/events{/privacy},https://api.github.com/users/guaguasi/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44160/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
219,https://api.github.com/repos/rails/rails/issues/44134,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44134/labels{/name},https://api.github.com/repos/rails/rails/issues/44134/comments,https://api.github.com/repos/rails/rails/issues/44134/events,https://github.com/rails/rails/issues/44134,1097740170,I_kwDNIULOQW4vig,44134,Configured email interceptors not accessible from the config hash,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2022-01-10T10:56:06Z,2022-02-01T17:46:30Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
1. Register the interceptor through the `action_mailer.interceptors` config
2. `bundle exec rails c`
3. Try to print the registered interceptor using `Rails.application.config.action_mailer.interceptors`

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# config/environments/staging.rb
Rails.application.configure do
  config.action_mailer.interceptors = %w[SandboxEmailInterceptor]
end

# From the console
irb(main):001:0> Rails.env
=> ""staging""
irb(main):002:0> Rails.application.config.action_mailer.interceptors
=> nil
```

### Expected behavior
<!-- Tell us what should happen -->
I'd expect the `interceptors` config option to be populated with the given `%w[SandboxEmailInterceptor]` array

### Actual behavior
<!-- Tell us what happens instead -->
It outputs the `nil` value

### System configuration
**Rails version**: 6.1.4.4

**Ruby version**: 3.0.2
",https://api.github.com/repos/rails/rails/issues/44134/timeline,,matteo-rossi-wise,60428992,MDQ6VXNlcjYwNDI4OTky,https://avatars.githubusercontent.com/u/60428992?v=4,,https://api.github.com/users/matteo-rossi-wise,https://github.com/matteo-rossi-wise,https://api.github.com/users/matteo-rossi-wise/followers,https://api.github.com/users/matteo-rossi-wise/following{/other_user},https://api.github.com/users/matteo-rossi-wise/gists{/gist_id},https://api.github.com/users/matteo-rossi-wise/starred{/owner}{/repo},https://api.github.com/users/matteo-rossi-wise/subscriptions,https://api.github.com/users/matteo-rossi-wise/orgs,https://api.github.com/users/matteo-rossi-wise/repos,https://api.github.com/users/matteo-rossi-wise/events{/privacy},https://api.github.com/users/matteo-rossi-wise/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44134/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
220,https://api.github.com/repos/rails/rails/issues/44131,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44131/labels{/name},https://api.github.com/repos/rails/rails/issues/44131/comments,https://api.github.com/repos/rails/rails/issues/44131/events,https://github.com/rails/rails/pull/44131,1097530953,PR_kwDNIULOMLcPxw,44131,Explicitly list negative currency format,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,3,2022-01-10T07:14:05Z,2022-04-11T12:54:10Z,,CONTRIBUTOR,,"Downstream bases some tests on the original translation files to make sure no unknown keys are introduced. The negative currency format is currently not in the original Rails translations, making it difficult to translate this for Dutch downstream (see https://github.com/svenfuchs/rails-i18n/pull/858).

Apparently there is a fallback in the source code to derive this negative format at runtime: https://github.com/rails/rails/blob/984c3ef2775781d47efa9f541ce570daa2434a80/activesupport/lib/active_support/number_helper/number_to_currency_converter.rb#L41 This PR makes it explicit in the translation files.",https://api.github.com/repos/rails/rails/issues/44131/timeline,,frenkel,121169,MDQ6VXNlcjEyMTE2OQ==,https://avatars.githubusercontent.com/u/121169?v=4,,https://api.github.com/users/frenkel,https://github.com/frenkel,https://api.github.com/users/frenkel/followers,https://api.github.com/users/frenkel/following{/other_user},https://api.github.com/users/frenkel/gists{/gist_id},https://api.github.com/users/frenkel/starred{/owner}{/repo},https://api.github.com/users/frenkel/subscriptions,https://api.github.com/users/frenkel/orgs,https://api.github.com/users/frenkel/repos,https://api.github.com/users/frenkel/events{/privacy},https://api.github.com/users/frenkel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44131/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44131,https://github.com/rails/rails/pull/44131,https://github.com/rails/rails/pull/44131.diff,https://github.com/rails/rails/pull/44131.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
221,https://api.github.com/repos/rails/rails/issues/44106,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44106/labels{/name},https://api.github.com/repos/rails/rails/issues/44106/comments,https://api.github.com/repos/rails/rails/issues/44106/events,https://github.com/rails/rails/pull/44106,1096381412,PR_kwDNIULOMKmtLg,44106,Avoid booting in development then test for test tasks,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,7,2022-01-07T14:45:56Z,2022-04-15T13:17:31Z,,CONTRIBUTOR,,"### Summary

Since #41132, we fork to run the tests from the test Rake tasks, which allows the tests to run when the task runs (previously it was only loading the tests, they ran at the process exit, which isn't helpful for rake tasks where you want to stop processing if a task dependency fails).

That means the app boots twice, first from the top of the Rakefile:
https://github.com/rails/rails/blob/b7c3b52ce530d9914717ceafc64990a225ad96c4/railties/lib/rails/generators/rails/app/templates/Rakefile.tt#L4
then in the fork that runs the test runner.

It's not ideal but it is the only way to run tests in a Rake task since they run at exit.

But that caused some weird behavior/bugs like #43937 since the application boots in development first to load the tasks and then forks to run the tests. We had mentioned some potential problems where the global state in Ruby changed from the Rakefile wouldn't be available to the test process, but we missed the opposite, where an environment variable would be set in development and then available in the child process in the test environment.

> #41132 This diverges from previous behavior because now, any changes made in the Rakefile or other code loaded by Rake won't be available to the child process.

But investigating this, I realized we could define the test tasks as Thor tasks, which take priority over Rake tasks.

We keep the Rake tasks for compatibility (`rake test:models` will continue to work), but `rails test:models` won't go through Rake anymore. 

I built it on 7-0-stable because I think it's a regression that we want to fix, but let me know if you'd rather push that as a feature for 7.1 on main.

### Other Information

There is some incompatibility as mentioned in the commit where we could run `rails test:models ARG=value --trace` but now it won't work.

Another important point is that the `test:prepare` hook won't run when it used to. If you had this in your Rakefile:
```ruby
Rake::Task['test:prepare'].enhance { puts ""test:prepare enhancement"" }
```

… it would run with `rails test:models` but not with `rails test`. I haven't found any mention of the `test:prepare` hook in guides or documentation so I'll look into deprecating it ([rspec calls it](https://github.com/rspec/rspec-rails/blob/v5.0.2/lib/rspec/rails/tasks/rspec.rake#L25-L26) but doesn't enhance it).

For both cases, I think it's fair since the same wouldn't work with the test task (`rails test ARG=value --trace` fails and `rails test` doesn't run the `test:prepare` task either since it's not a Rake task).

Fixes #43937 ",https://api.github.com/repos/rails/rails/issues/44106/timeline,,etiennebarrie,3535,MDQ6VXNlcjM1MzU=,https://avatars.githubusercontent.com/u/3535?v=4,,https://api.github.com/users/etiennebarrie,https://github.com/etiennebarrie,https://api.github.com/users/etiennebarrie/followers,https://api.github.com/users/etiennebarrie/following{/other_user},https://api.github.com/users/etiennebarrie/gists{/gist_id},https://api.github.com/users/etiennebarrie/starred{/owner}{/repo},https://api.github.com/users/etiennebarrie/subscriptions,https://api.github.com/users/etiennebarrie/orgs,https://api.github.com/users/etiennebarrie/repos,https://api.github.com/users/etiennebarrie/events{/privacy},https://api.github.com/users/etiennebarrie/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44106/reactions,2,0,0,0,0,0,0,2,0,False,https://api.github.com/repos/rails/rails/pulls/44106,https://github.com/rails/rails/pull/44106,https://github.com/rails/rails/pull/44106.diff,https://github.com/rails/rails/pull/44106.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
222,https://api.github.com/repos/rails/rails/issues/44091,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44091/labels{/name},https://api.github.com/repos/rails/rails/issues/44091/comments,https://api.github.com/repos/rails/rails/issues/44091/events,https://github.com/rails/rails/pull/44091,1095033647,PR_kwDNIULOMJg_gw,44091,Update default puma to reflect separate RACK_ENV and support debugging,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,2,2022-01-06T07:10:46Z,2022-01-26T01:11:47Z,,CONTRIBUTOR,,"### Summary
2 changes:

#### 1. Rack, not Rails `environment`

`environment` configures the Rack env.

This may not match different Rails environments.

https://github.com/rails/webpacker/issues/3200
https://github.com/rails/webpacker/pull/3239

This matches the Heroku docs:
https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#environment

#### 2. Developer productivity
A single HTML page load request may hit many other APIs. Debugging without setting the concurrency values to 1 is extremely confusing.",https://api.github.com/repos/rails/rails/issues/44091/timeline,,justin808,1118459,MDQ6VXNlcjExMTg0NTk=,https://avatars.githubusercontent.com/u/1118459?v=4,,https://api.github.com/users/justin808,https://github.com/justin808,https://api.github.com/users/justin808/followers,https://api.github.com/users/justin808/following{/other_user},https://api.github.com/users/justin808/gists{/gist_id},https://api.github.com/users/justin808/starred{/owner}{/repo},https://api.github.com/users/justin808/subscriptions,https://api.github.com/users/justin808/orgs,https://api.github.com/users/justin808/repos,https://api.github.com/users/justin808/events{/privacy},https://api.github.com/users/justin808/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44091/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44091,https://github.com/rails/rails/pull/44091,https://github.com/rails/rails/pull/44091.diff,https://github.com/rails/rails/pull/44091.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
223,https://api.github.com/repos/rails/rails/issues/44084,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44084/labels{/name},https://api.github.com/repos/rails/rails/issues/44084/comments,https://api.github.com/repos/rails/rails/issues/44084/events,https://github.com/rails/rails/issues/44084,1094610708,I_kwDNIULOQT5vFA,44084,Associated new records are validated even if :autosave and :validate are false,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2022-01-05T18:01:31Z,2022-02-22T02:16:59Z,,NONE,,"### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
  gem 'byebug'
end

require ""active_record""
require ""minitest/autorun""
require ""logger""
require 'byebug'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.string :text
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post

  validates :text, presence: true
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!

    comment = post.comments.build
    
    assert_equal post.valid?, true # The post should be valid, even if there is an invalid comment
  end
end
```

### Expected behavior
I'd expect the post to be valid, even if there is an invalid comment attached. 

### Actual behavior
The post is invalid and `post.errors.messages[:comments]` is  `[""is invalid""]`. Therefore, `post.save` fails. (Related, even `post.save(validate: false)` fails, but I think this is #43400)
If the post and the comment are saved in the database and I set `comment.text = ''`, the post is valid and I can save the post.

This issue also appears when I set `validates_association :post` in the comment class and then try to save a new comment without text - `comment.errors.messages[:text]` will be [""can't be blank"", ""can't be blank""].
",https://api.github.com/repos/rails/rails/issues/44084/timeline,,niklas-hasselmeyer,62055282,MDQ6VXNlcjYyMDU1Mjgy,https://avatars.githubusercontent.com/u/62055282?v=4,,https://api.github.com/users/niklas-hasselmeyer,https://github.com/niklas-hasselmeyer,https://api.github.com/users/niklas-hasselmeyer/followers,https://api.github.com/users/niklas-hasselmeyer/following{/other_user},https://api.github.com/users/niklas-hasselmeyer/gists{/gist_id},https://api.github.com/users/niklas-hasselmeyer/starred{/owner}{/repo},https://api.github.com/users/niklas-hasselmeyer/subscriptions,https://api.github.com/users/niklas-hasselmeyer/orgs,https://api.github.com/users/niklas-hasselmeyer/repos,https://api.github.com/users/niklas-hasselmeyer/events{/privacy},https://api.github.com/users/niklas-hasselmeyer/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44084/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
224,https://api.github.com/repos/rails/rails/issues/44079,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44079/labels{/name},https://api.github.com/repos/rails/rails/issues/44079/comments,https://api.github.com/repos/rails/rails/issues/44079/events,https://github.com/rails/rails/pull/44079,1094494191,PR_kwDNIULOMJFMgA,44079,Fix #43978 migrations on multidb,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,8,2022-01-05T15:49:55Z,2022-04-05T14:24:20Z,,CONTRIBUTOR,,"### Summary

Possible fix for #43978, and other issues I found when trying to load schema.rb within a `connected_to` block and run migrations with a custom migration context. 

### Other Information

As part of this, would it make sense to [move this code](https://github.com/rails/rails/blob/7-0-stable/activerecord/lib/active_record/schema_migration.rb#L12-L52) into a module that could then be included in `SchemaMigration` (and in particular, for client code to be able to re-use when they need their own `ApplicationSchemaMigration` with the same code but a different superclass?

This is a duplicate of #43979 which will be closed in favor of this, since I originally wrote that one on the wrong branch, and Github won't let me change my branch of the PR, (and I neglected to create my own, using 7-0-stable from the rails/rails repo)

@rafaelfranca tagging you, since you had asked for this adjustment. ",https://api.github.com/repos/rails/rails/issues/44079/timeline,,codeodor,23479,MDQ6VXNlcjIzNDc5,https://avatars.githubusercontent.com/u/23479?v=4,,https://api.github.com/users/codeodor,https://github.com/codeodor,https://api.github.com/users/codeodor/followers,https://api.github.com/users/codeodor/following{/other_user},https://api.github.com/users/codeodor/gists{/gist_id},https://api.github.com/users/codeodor/starred{/owner}{/repo},https://api.github.com/users/codeodor/subscriptions,https://api.github.com/users/codeodor/orgs,https://api.github.com/users/codeodor/repos,https://api.github.com/users/codeodor/events{/privacy},https://api.github.com/users/codeodor/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44079/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44079,https://github.com/rails/rails/pull/44079,https://github.com/rails/rails/pull/44079.diff,https://github.com/rails/rails/pull/44079.patch,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
225,https://api.github.com/repos/rails/rails/issues/44074,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44074/labels{/name},https://api.github.com/repos/rails/rails/issues/44074/comments,https://api.github.com/repos/rails/rails/issues/44074/events,https://github.com/rails/rails/pull/44074,1093771248,PR_kwDNIULOMIf4bg,44074,Use same default host name in ActionController::Renderer as Integration::Session,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,7,2022-01-04T21:33:31Z,2022-04-06T17:37:03Z,,NONE,,"### Summary

Changes `ActionController::Renderer::DEFAULTS[:http_host]` from `example.org` to `www.example.com` to match `ActionDispatch::Integration::Session::DEFAULT_HOST`.

Fixes #44071.",https://api.github.com/repos/rails/rails/issues/44074/timeline,,dmolesUC,10374934,MDQ6VXNlcjEwMzc0OTM0,https://avatars.githubusercontent.com/u/10374934?v=4,,https://api.github.com/users/dmolesUC,https://github.com/dmolesUC,https://api.github.com/users/dmolesUC/followers,https://api.github.com/users/dmolesUC/following{/other_user},https://api.github.com/users/dmolesUC/gists{/gist_id},https://api.github.com/users/dmolesUC/starred{/owner}{/repo},https://api.github.com/users/dmolesUC/subscriptions,https://api.github.com/users/dmolesUC/orgs,https://api.github.com/users/dmolesUC/repos,https://api.github.com/users/dmolesUC/events{/privacy},https://api.github.com/users/dmolesUC/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44074/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44074,https://github.com/rails/rails/pull/44074,https://github.com/rails/rails/pull/44074.diff,https://github.com/rails/rails/pull/44074.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
226,https://api.github.com/repos/rails/rails/issues/44071,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44071/labels{/name},https://api.github.com/repos/rails/rails/issues/44071/comments,https://api.github.com/repos/rails/rails/issues/44071/events,https://github.com/rails/rails/issues/44071,1093693652,I_kwDNIULOQTBw1A,44071,Request tests and ApplicationController use different default hostnames,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2022-01-04T19:38:14Z,2022-01-07T23:29:56Z,,NONE,,"### Summary

When making GET requests in request tests, Rails uses the hostname `www.example.com` (possibly set in [ActionDispatch::Integration::Session::DEFAULT_HOST](https://github.com/rails/rails/blob/v6.1.4.4/actionpack/lib/action_dispatch/testing/integration.rb#L84-L85)).

However, `ApplicationController.render` uses the hostname `example.org` (possibly set in [ActionController::Renderer::DEFAULTS](https://github.com/rails/rails/blob/v6.1.4.4/actionpack/lib/action_controller/renderer.rb#L36-L45)).

This causes spurious test failures when comparing the output of `ApplicationController.render` to request bodies -- the sample test below is somewhat silly, but it's more useful when, e.g. checking that a complex render is using the correct partial.

### Steps to reproduce

1. Either:
   1. Clone the repository [dmolesUC/rs-hostnames](https://github.com/dmolesUC/rs-hostnames)

   or:

   1. Create a new Rails application
   2. Use `rails g scaffold Item name:string` to create an `Item` model, controller, views, tests, etc.
   3. Add the test code below to `test/controllers/items_controller_test.rb`

2. Ensure the database is set up and migrated, test assets are precompiled, etc.
3. Run `items_controller_test`

Test code:

```ruby
  test 'should show item as JSON' do
    get item_url(@item), as: :json
    assert_response :success

    json_actual = JSON.parse(response.body)
    json_expected = JSON.parse(
      ApplicationController.render(
        template: 'items/show',
        formats: :json,
        assigns: { :item => @item }
      )
    )

    json_expected.each do |k, v_expected|
      v_actual = json_actual[k]
      assert_equal(v_expected, v_actual)
    end
  end
```

### Expected behavior

Test passes.

### Actual behavior

Test fails with:

```none
Minitest::Assertion: --- expected
+++ actual
@@ -1 +1 @@
-""http://example.org/items/980190962.json""
+""http://www.example.com/items/980190962.json""
```

### System configuration

**Rails version**: 6.1.4.4

**Ruby version**: 3.0.2
",https://api.github.com/repos/rails/rails/issues/44071/timeline,,dmolesUC,10374934,MDQ6VXNlcjEwMzc0OTM0,https://avatars.githubusercontent.com/u/10374934?v=4,,https://api.github.com/users/dmolesUC,https://github.com/dmolesUC,https://api.github.com/users/dmolesUC/followers,https://api.github.com/users/dmolesUC/following{/other_user},https://api.github.com/users/dmolesUC/gists{/gist_id},https://api.github.com/users/dmolesUC/starred{/owner}{/repo},https://api.github.com/users/dmolesUC/subscriptions,https://api.github.com/users/dmolesUC/orgs,https://api.github.com/users/dmolesUC/repos,https://api.github.com/users/dmolesUC/events{/privacy},https://api.github.com/users/dmolesUC/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44071/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
227,https://api.github.com/repos/rails/rails/issues/44068,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44068/labels{/name},https://api.github.com/repos/rails/rails/issues/44068/comments,https://api.github.com/repos/rails/rails/issues/44068/events,https://github.com/rails/rails/issues/44068,1093609237,I_kwDNIULOQS8nFQ,44068,Problem trying to upgrade Rails application to 6.1.4.1 and autoloading with zeitwerk,[],open,False,,[],,13,2022-01-04T17:40:16Z,2022-02-01T21:55:40Z,,NONE,,"I'm trying to upgrade Rails to version 6.1.4.1 with Ruby 2.7.0 and I'm finding some problems with the new zeitwerk autoloading.

Specifically I have a file that is executing some code using `class_eval` for a class that is defined in a different file:

```ruby
MyApp::Menu.class_eval do
  # Some code to be evaluated at class level
end
```

This is some kind of ""extension"" over `MyApp::Menu` class (defined in a different file). My problem is that I don't know how to fit this with how zeitwerk autoload works. This file doesn't defines any class/constant/module  and zeitwerk is expecting something to be defined raising an error like:

```sh
NameError: uninitialized constant MyApp::Menu
```

How should I fix this allowing zeitwerk to work with these kind of files where I'm not defining anything but instead reopening or modifying an already created class?

According to Rails guides I should ping @fxn 😃 ",https://api.github.com/repos/rails/rails/issues/44068/timeline,,mroguzman,2051456,MDQ6VXNlcjIwNTE0NTY=,https://avatars.githubusercontent.com/u/2051456?v=4,,https://api.github.com/users/mroguzman,https://github.com/mroguzman,https://api.github.com/users/mroguzman/followers,https://api.github.com/users/mroguzman/following{/other_user},https://api.github.com/users/mroguzman/gists{/gist_id},https://api.github.com/users/mroguzman/starred{/owner}{/repo},https://api.github.com/users/mroguzman/subscriptions,https://api.github.com/users/mroguzman/orgs,https://api.github.com/users/mroguzman/repos,https://api.github.com/users/mroguzman/events{/privacy},https://api.github.com/users/mroguzman/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44068/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
228,https://api.github.com/repos/rails/rails/issues/44035,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44035/labels{/name},https://api.github.com/repos/rails/rails/issues/44035/comments,https://api.github.com/repos/rails/rails/issues/44035/events,https://github.com/rails/rails/issues/44035,1091385725,I_kwDNIULOQQ05fQ,44035,Allow user to choose importmap while using node-based CSS framework,[],open,False,,[],,1,2021-12-31T02:37:18Z,2022-03-14T13:11:50Z,,CONTRIBUTOR,,"If the new app is generated with any CSS framework other than Tailwind then the Rails generator forces `esbuild` as Javascript environment.

What if we allow users to choose the latest way to use Javascript with Importmap while they use Node, to depend minimum on it, only to process their stylesheets? 

For example, Sass requires Node but it may not always require ""node-based Javascript environment"" as mentioned in the code comment below:

https://github.com/rails/rails/blob/f292daad7051275f7b557b352876cfeb3988f639/railties/lib/rails/generators/app_base.rb#L345-L353

### System configuration
**Rails version**:
7.0.0
",https://api.github.com/repos/rails/rails/issues/44035/timeline,,tannakartikey,422544,MDQ6VXNlcjQyMjU0NA==,https://avatars.githubusercontent.com/u/422544?v=4,,https://api.github.com/users/tannakartikey,https://github.com/tannakartikey,https://api.github.com/users/tannakartikey/followers,https://api.github.com/users/tannakartikey/following{/other_user},https://api.github.com/users/tannakartikey/gists{/gist_id},https://api.github.com/users/tannakartikey/starred{/owner}{/repo},https://api.github.com/users/tannakartikey/subscriptions,https://api.github.com/users/tannakartikey/orgs,https://api.github.com/users/tannakartikey/repos,https://api.github.com/users/tannakartikey/events{/privacy},https://api.github.com/users/tannakartikey/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44035/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
229,https://api.github.com/repos/rails/rails/issues/44026,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44026/labels{/name},https://api.github.com/repos/rails/rails/issues/44026/comments,https://api.github.com/repos/rails/rails/issues/44026/events,https://github.com/rails/rails/issues/44026,1090726806,I_kwDNIULOQQMrlg,44026,Security - Subdomain Takeover at https://new.rubyonrails.org/,"[{'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,0,2021-12-29T20:10:11Z,2022-01-01T22:41:13Z,,NONE,,"### Preface

I tried to reach you in every way possible, emails didn't work, no answer on HackerOne for 2 weeks - https://hackerone.com/reports/1429148

so I will try as last resort to report it here for you to fix it.

If a malicious actor would have captured it, he could store download links of rubyonrails under your main domain with crypto miners / trojan horses...

## Summary
Hi!

I discovered that new.rubyonrails.org was pointing to an unclaimed Github Page, making it vulnerable to subdomain takeover.
I've managed to claim it in my Github-account and added a simple html file as POC:

`https://new.rubyonrails.org`

## Mitigation
- Remove the DNS record

Best regards,
nagli

## Impact

Subdomain takeovers can be used for
- Cookies set to the root domain will be shared with this subdomain and can be obtained
- Stored XSS (arbitrary javascript code can be executed in a users browser)
- Phishing
- Hosting malicious content

",https://api.github.com/repos/rails/rails/issues/44026/timeline,,NagliNagli,35578316,MDQ6VXNlcjM1NTc4MzE2,https://avatars.githubusercontent.com/u/35578316?v=4,,https://api.github.com/users/NagliNagli,https://github.com/NagliNagli,https://api.github.com/users/NagliNagli/followers,https://api.github.com/users/NagliNagli/following{/other_user},https://api.github.com/users/NagliNagli/gists{/gist_id},https://api.github.com/users/NagliNagli/starred{/owner}{/repo},https://api.github.com/users/NagliNagli/subscriptions,https://api.github.com/users/NagliNagli/orgs,https://api.github.com/users/NagliNagli/repos,https://api.github.com/users/NagliNagli/events{/privacy},https://api.github.com/users/NagliNagli/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44026/reactions,4,0,0,1,0,0,3,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
230,https://api.github.com/repos/rails/rails/issues/44019,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44019/labels{/name},https://api.github.com/repos/rails/rails/issues/44019/comments,https://api.github.com/repos/rails/rails/issues/44019/events,https://github.com/rails/rails/pull/44019,1090101879,PR_kwDNIULOMFjQnQ,44019,Fix flakey tests in `insert_all_test.rb`,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,4,2021-12-28T20:03:46Z,2022-04-20T23:18:48Z,,MEMBER,,"Example failure: https://buildkite.com/rails/rails/builds/83572#becc2b08-165b-44fe-92f9-9763e6595b29/1154-1164

These tests assert that `usec` is non-zero to verify that the relevant timestamps were set with a high-precision value.  However, a zero `usec` can occur naturally.  Therefore, stub the high-precision value, and check for that instead.
",https://api.github.com/repos/rails/rails/issues/44019/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44019/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44019,https://github.com/rails/rails/pull/44019,https://github.com/rails/rails/pull/44019.diff,https://github.com/rails/rails/pull/44019.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
231,https://api.github.com/repos/rails/rails/issues/44015,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44015/labels{/name},https://api.github.com/repos/rails/rails/issues/44015/comments,https://api.github.com/repos/rails/rails/issues/44015/events,https://github.com/rails/rails/pull/44015,1089962890,PR_kwDNIULOMFcJkA,44015,Change Content-Security-Policy Api,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,4,2021-12-28T15:16:39Z,2022-02-16T07:40:10Z,,NONE,,"Change the API for for Content-Security-Policy to make it easier to add
other sources in controllers.

Let say you only have CSP script rule setup and you want to allow
unsafe-inline for a particular page. With the current API you have to
first read the existing value, add new unsafe-inline and set. You also
have to add a default value of an empty array in case someone remove
default rule.

Here is one example of before and after. I think it's most common the
you want to add to default values in  controller not overwrite
```rb
# config.rb
Rails.application.config.content_security_policy do |policy|
  policy.default(:self, ""https://our.cdn.com/"")
end

# before
class FrontPageController < ApplicationController
  content_security_policy do |policy|
    new_connection = policy.connect_src || []
    new_connection.push(:unsafe_inline)
    policy.connect_src(*new_connection)
  end

  def index
  end
end

# After
class FrontPageController < ApplicationController
  content_security_policy do |policy|
    policy.connect_src(:unsafe_inline)
  end

  def index
  end
end
```

Previously you call call directive methods like script_src without and
argument to unset the value. First time you would get the value it had
before this call. The second time you call it without an argument it
would return nil because it didn't have a value.

After this patch calling script_scr would just return set values, a
reader. To clear the value now you have to pass a keyword argument
clear: true. Maybe this breaks single single responsibility but you have
a half the methods.

fix #43827

Not sure how to do it with deprecation warnings. Do you want to have deprecation in 7.0 and changes in 7.1. How do we do that?

Maybe it would be getter to have and unset_script_src method instead of script_src clear: true? but currently both are in one method and I think it's nice.

I would like to get some feedback, if you like the new api. When we settle on the api I would like to update the docs a bit.",https://api.github.com/repos/rails/rails/issues/44015/timeline,,stoivo,3492040,MDQ6VXNlcjM0OTIwNDA=,https://avatars.githubusercontent.com/u/3492040?v=4,,https://api.github.com/users/stoivo,https://github.com/stoivo,https://api.github.com/users/stoivo/followers,https://api.github.com/users/stoivo/following{/other_user},https://api.github.com/users/stoivo/gists{/gist_id},https://api.github.com/users/stoivo/starred{/owner}{/repo},https://api.github.com/users/stoivo/subscriptions,https://api.github.com/users/stoivo/orgs,https://api.github.com/users/stoivo/repos,https://api.github.com/users/stoivo/events{/privacy},https://api.github.com/users/stoivo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44015/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44015,https://github.com/rails/rails/pull/44015,https://github.com/rails/rails/pull/44015.diff,https://github.com/rails/rails/pull/44015.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
232,https://api.github.com/repos/rails/rails/issues/44012,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44012/labels{/name},https://api.github.com/repos/rails/rails/issues/44012/comments,https://api.github.com/repos/rails/rails/issues/44012/events,https://github.com/rails/rails/pull/44012,1089488172,PR_kwDNIULOMFD8jw,44012,docs: remove info for nested dictionaries,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,4,2021-12-27T21:47:45Z,2022-03-10T09:23:10Z,,NONE,,"### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

I removed a code-block from the documentation of the i18n module, as this does not hold true anymore. Since this PR ( https://github.com/rails/rails/pull/41872 ) rails automatically loads nested dictionaries for translations.

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44012/timeline,,johannesschobel,9431350,MDQ6VXNlcjk0MzEzNTA=,https://avatars.githubusercontent.com/u/9431350?v=4,,https://api.github.com/users/johannesschobel,https://github.com/johannesschobel,https://api.github.com/users/johannesschobel/followers,https://api.github.com/users/johannesschobel/following{/other_user},https://api.github.com/users/johannesschobel/gists{/gist_id},https://api.github.com/users/johannesschobel/starred{/owner}{/repo},https://api.github.com/users/johannesschobel/subscriptions,https://api.github.com/users/johannesschobel/orgs,https://api.github.com/users/johannesschobel/repos,https://api.github.com/users/johannesschobel/events{/privacy},https://api.github.com/users/johannesschobel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44012/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44012,https://github.com/rails/rails/pull/44012,https://github.com/rails/rails/pull/44012.diff,https://github.com/rails/rails/pull/44012.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
233,https://api.github.com/repos/rails/rails/issues/44010,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44010/labels{/name},https://api.github.com/repos/rails/rails/issues/44010/comments,https://api.github.com/repos/rails/rails/issues/44010/events,https://github.com/rails/rails/pull/44010,1089457835,PR_kwDNIULOMFCYfw,44010,Accept nested functions in Dangerous Query Methods,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,4,2021-12-27T20:27:04Z,2022-03-18T20:17:47Z,,NONE,,"### Summary

I think there’s an opportunity to reduce additional false positives for
Dangerous Query Method deprecations/errors. Similar to https://github.com/rails/rails/pull/36448, it seems
reasonable to allow functions that accept other functions (e.g.
`length(trim(title))`).

### Other Information

Mailing list thread: https://discuss.rubyonrails.org/t/feature-proposal-accept-nested-functions-w-r-t-dangerous-query-methods/78650

*Background*
* PR accepting non-nested functions: https://github.com/rails/rails/pull/36448
* Deep background on deprecation and false positives: https://github.com/rails/rails/issues/32995
* Constants: `COLUMN_NAME` for the first and `COLUMN_NAME_WITH_ORDER` for both
",https://api.github.com/repos/rails/rails/issues/44010/timeline,,siegfault,1421705,MDQ6VXNlcjE0MjE3MDU=,https://avatars.githubusercontent.com/u/1421705?v=4,,https://api.github.com/users/siegfault,https://github.com/siegfault,https://api.github.com/users/siegfault/followers,https://api.github.com/users/siegfault/following{/other_user},https://api.github.com/users/siegfault/gists{/gist_id},https://api.github.com/users/siegfault/starred{/owner}{/repo},https://api.github.com/users/siegfault/subscriptions,https://api.github.com/users/siegfault/orgs,https://api.github.com/users/siegfault/repos,https://api.github.com/users/siegfault/events{/privacy},https://api.github.com/users/siegfault/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44010/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44010,https://github.com/rails/rails/pull/44010,https://github.com/rails/rails/pull/44010.diff,https://github.com/rails/rails/pull/44010.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
234,https://api.github.com/repos/rails/rails/issues/44008,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/44008/labels{/name},https://api.github.com/repos/rails/rails/issues/44008/comments,https://api.github.com/repos/rails/rails/issues/44008/events,https://github.com/rails/rails/pull/44008,1089361900,PR_kwDNIULOME9aDA,44008,Cannot deliver new inbound email via form,"[{'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,10,2021-12-27T17:00:31Z,2022-03-13T22:39:30Z,,CONTRIBUTOR,,"### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

#### Steps to reproduce
1. Install ActionMailbox in your app
2. Visit `/rails/conductor/action_mailbox/inbound_emails` as specified in here https://guides.rubyonrails.org/action_mailbox_basics.html#working-with-action-mailbox-in-development
3. Click on ""New inbound email by form""
4. Fill the form and submit

#### Expected
The inbound email is created successfully 

#### Actual
A `NoMethodError` is raised:

```
NoMethodError in Rails::Conductor::ActionMailbox::InboundEmailsController#create
undefined method `original_filename' for """":String
```

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

```
>> mail_params[:attachments]
=> [""""]
```

This happens because of the hidden field tag the multiple select field uses under the hood. An easy fix for this problem is to exclude the empty string from the collection.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/44008/timeline,,juanmanuelramallo,13257832,MDQ6VXNlcjEzMjU3ODMy,https://avatars.githubusercontent.com/u/13257832?v=4,,https://api.github.com/users/juanmanuelramallo,https://github.com/juanmanuelramallo,https://api.github.com/users/juanmanuelramallo/followers,https://api.github.com/users/juanmanuelramallo/following{/other_user},https://api.github.com/users/juanmanuelramallo/gists{/gist_id},https://api.github.com/users/juanmanuelramallo/starred{/owner}{/repo},https://api.github.com/users/juanmanuelramallo/subscriptions,https://api.github.com/users/juanmanuelramallo/orgs,https://api.github.com/users/juanmanuelramallo/repos,https://api.github.com/users/juanmanuelramallo/events{/privacy},https://api.github.com/users/juanmanuelramallo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/44008/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/44008,https://github.com/rails/rails/pull/44008,https://github.com/rails/rails/pull/44008.diff,https://github.com/rails/rails/pull/44008.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
235,https://api.github.com/repos/rails/rails/issues/43996,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43996/labels{/name},https://api.github.com/repos/rails/rails/issues/43996/comments,https://api.github.com/repos/rails/rails/issues/43996/events,https://github.com/rails/rails/issues/43996,1088573317,I_kwDNIULOQOJPhQ,43996,Rails not response to signal QUIT? (pressing Ctrl+\ in terminal),[],open,False,,[],,2,2021-12-25T09:12:19Z,2022-03-26T05:47:18Z,,NONE,,"### Steps to reproduce

When i run `rails t`, some code is run into dead loop.

i want to see what cause this, so, i run code like this:

add a file, ./trap_backtrace.rb

```rb
trap(:QUIT) {
  t = Thread.list.first
  puts ""#"" * 90
  p t
  puts t.backtrace
  puts ""#"" * 90
}
```

run rails with:

```sh
 RUBYLIB= RUBYOPT='-r./trap_backtrace' command rails t
```

when i send 

```sh
kill -QUIT ${rails_pid}
```

<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# Your reproduction script goes here
```

### Expected behavior
<!-- Tell us what should happen -->

rails response to my kill signal, print threads, in fact, this hack works when i start with others app.

### Actual behavior
<!-- Tell us what happens instead -->

no any response.

### System configuration
**Rails version**:
6.1.3.2

**Ruby version**:
3.0.3",https://api.github.com/repos/rails/rails/issues/43996/timeline,,zw963,549126,MDQ6VXNlcjU0OTEyNg==,https://avatars.githubusercontent.com/u/549126?v=4,,https://api.github.com/users/zw963,https://github.com/zw963,https://api.github.com/users/zw963/followers,https://api.github.com/users/zw963/following{/other_user},https://api.github.com/users/zw963/gists{/gist_id},https://api.github.com/users/zw963/starred{/owner}{/repo},https://api.github.com/users/zw963/subscriptions,https://api.github.com/users/zw963/orgs,https://api.github.com/users/zw963/repos,https://api.github.com/users/zw963/events{/privacy},https://api.github.com/users/zw963/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43996/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
236,https://api.github.com/repos/rails/rails/issues/43983,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43983/labels{/name},https://api.github.com/repos/rails/rails/issues/43983/comments,https://api.github.com/repos/rails/rails/issues/43983/events,https://github.com/rails/rails/pull/43983,1088004863,PR_kwDNIULOMD6tJg,43983,"Link to valid time zones from ""Invalid"" error msg","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,3,2021-12-23T21:39:42Z,2022-04-19T11:47:23Z,,NONE,,"### Summary

Over in [gitlab#27209 (Timezone rake task outputs wrong timezone format)](https://gitlab.com/gitlab-org/gitlab/-/issues/27209) we encountered a bit of confusion about which exact time zone strings can be used.

I wondered whether y'all consider a link to the file in which their identifiers are defined from that same error message to be a sensible solution to that problem.

I'm hoping that users can thus self-serve to find the solution directly in the moment of needing it.

### Other Information

1. Is maybe a different resources the preferred landing point for the piece of info?
2. Or a Rails command to list the ones in the user's installation?

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43983/timeline,,katrinleinweber,9948149,MDQ6VXNlcjk5NDgxNDk=,https://avatars.githubusercontent.com/u/9948149?v=4,,https://api.github.com/users/katrinleinweber,https://github.com/katrinleinweber,https://api.github.com/users/katrinleinweber/followers,https://api.github.com/users/katrinleinweber/following{/other_user},https://api.github.com/users/katrinleinweber/gists{/gist_id},https://api.github.com/users/katrinleinweber/starred{/owner}{/repo},https://api.github.com/users/katrinleinweber/subscriptions,https://api.github.com/users/katrinleinweber/orgs,https://api.github.com/users/katrinleinweber/repos,https://api.github.com/users/katrinleinweber/events{/privacy},https://api.github.com/users/katrinleinweber/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43983/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43983,https://github.com/rails/rails/pull/43983,https://github.com/rails/rails/pull/43983.diff,https://github.com/rails/rails/pull/43983.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
237,https://api.github.com/repos/rails/rails/issues/43982,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43982/labels{/name},https://api.github.com/repos/rails/rails/issues/43982/comments,https://api.github.com/repos/rails/rails/issues/43982/events,https://github.com/rails/rails/issues/43982,1087757025,I_kwDNIULOQNXa4Q,43982,Common ActiveStorage configurations are vulnerable to ghostview exploit (by way of imagemagick),"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2021-12-23T14:20:20Z,2021-12-23T19:05:06Z,,NONE,,"(This isn't strictly a rails's vulnerability, but it seems to commonly effect production rails environments. As such, it seems worth documenting. I'm moving this here, from hackerone)

### Background

ActiveStorage commonly uses imagemagick based gems for the Variant processing. Recently, [CVE-2021-3781](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-3781) came out. This vulnerability describes an image format that, when parsed by a vulnerable version of ghostview, triggers remote code execution.

I was able to execute this on several rails installs, including one of the large rails hosting vendors.

### Possible Fixes

I don't think this is the first imagemagick related vulnerability. And so one commonly suggested mitigation, is to use ruby-vips. But, at the time I was testing this, that wasn't supported on macOS when using puma. 

This class of exploits can be blocked by a `policy.xml` file. I don't know if there's an in-ruby way to do this. I believe setting the `MAGICK_CONFIGURE_PATH` environmental variable to a directory that includes a stricter version. (And the `policy.xml` file I'm currently using is available at https://gist.github.com/directionless/3678187eff3c0ea0f1e3bc4488da0113)

But these all point to documentation approaches. Likely with a suitable policy file

### Steps to reproduce

1. Run rails with activestorage configured
2. Fairly normal defaults and hosting
3. Upload an image exploiting CVE-2021-3781

# Your reproduction script goes here

N/A

### Expected behavior

Nothing should happen. The image should be ignored as invalid. 

### Actual behavior

The host running the activestorage job executes arbitrary attacker code.

### System configuration

Er, I had tested this on rails 6 something (sorry I don't still have that environment up)",https://api.github.com/repos/rails/rails/issues/43982/timeline,,directionless,179542,MDQ6VXNlcjE3OTU0Mg==,https://avatars.githubusercontent.com/u/179542?v=4,,https://api.github.com/users/directionless,https://github.com/directionless,https://api.github.com/users/directionless/followers,https://api.github.com/users/directionless/following{/other_user},https://api.github.com/users/directionless/gists{/gist_id},https://api.github.com/users/directionless/starred{/owner}{/repo},https://api.github.com/users/directionless/subscriptions,https://api.github.com/users/directionless/orgs,https://api.github.com/users/directionless/repos,https://api.github.com/users/directionless/events{/privacy},https://api.github.com/users/directionless/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43982/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
238,https://api.github.com/repos/rails/rails/issues/43978,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43978/labels{/name},https://api.github.com/repos/rails/rails/issues/43978/comments,https://api.github.com/repos/rails/rails/issues/43978/events,https://github.com/rails/rails/issues/43978,1087284565,I_kwDNIULOQM6lVQ,43978,Rails 7 Schema Load ignores primary abstract class connection,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,5,2021-12-23T00:51:00Z,2022-04-05T00:13:31Z,,CONTRIBUTOR,,"### Steps to reproduce
See https://github.com/codeodor/rails-7-schema-load-test/blob/main/README.md for a test application I made that exhibits the behavior. 

I wasn't sure how to do the multi-db setup in the provided scripts, so I hope that repository I made helps. 

### Expected behavior
I expect that when running within `Model.connected_to(shard: shard_2)` that loading the Schema file would operate on the database specified in the `shard_2` config. 

### Actual behavior
It operates on the default shard database instead. 

### System configuration
**Rails version**: 7.0.0

**Ruby version**: ruby 2.7.1p83
",https://api.github.com/repos/rails/rails/issues/43978/timeline,,codeodor,23479,MDQ6VXNlcjIzNDc5,https://avatars.githubusercontent.com/u/23479?v=4,,https://api.github.com/users/codeodor,https://github.com/codeodor,https://api.github.com/users/codeodor/followers,https://api.github.com/users/codeodor/following{/other_user},https://api.github.com/users/codeodor/gists{/gist_id},https://api.github.com/users/codeodor/starred{/owner}{/repo},https://api.github.com/users/codeodor/subscriptions,https://api.github.com/users/codeodor/orgs,https://api.github.com/users/codeodor/repos,https://api.github.com/users/codeodor/events{/privacy},https://api.github.com/users/codeodor/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43978/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
239,https://api.github.com/repos/rails/rails/issues/43976,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43976/labels{/name},https://api.github.com/repos/rails/rails/issues/43976/comments,https://api.github.com/repos/rails/rails/issues/43976/events,https://github.com/rails/rails/issues/43976,1087243460,I_kwDNIULOQM4ExA,43976,Active Text / Active Storage: vips.so.42: cannot open shared object file: No such file or directory,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,7,2021-12-22T22:57:41Z,2022-02-05T15:05:43Z,,NONE,,"### Steps to reproduce
I encountered this error while following DHH's youtube video ""Rails 7: The Demo"" at 9:10. I have a fresh install of Ubuntu 20.04 and RoR. I got the same error on another computer with a freshly installed Ubuntu and RoR.  Here are the steps:
1) Install action_text and add a rich_text_area to a form.
2) Run rails server
3) add some text and image to the rich text and hit submit (just like in the video)

### Expected behavior
contents of form get saved normally along with image getting uploaded.

### Actual behavior
Rails server quits and I see the following error:

```
...
...
#<Thread:0x00007fd7113596f8 /home/dynamic/.rvm/gems/ruby-3.0.2/gems/actionpack-7.0.0/lib/action_controller/metal/live.rb:340 run> terminated with exception (report_on_exception is true):
/home/dynamic/.rvm/gems/ruby-3.0.2/gems/ffi-1.15.4/lib/ffi/library.rb:145:in `block in ffi_lib': Could not open library 'vips.so.42': vips.so.42: cannot open shared object file: No such file or directory. (LoadError)
Could not open library 'libvips.so.42': libvips.so.42: cannot open shared object file: No such file or directory
	from /home/dynamic/.rvm/gems/ruby-3.0.2/gems/ffi-1.15.4/lib/ffi/library.rb:99:in `map'
	from /home/dynamic/.rvm/gems/ruby-3.0.2/gems/ffi-1.15.4/lib/ffi/library.rb:99:in `ffi_lib'
	from /home/dynamic/.rvm/gems/ruby-3.0.2/gems/ruby-vips-2.1.4/lib/vips.rb:573:in `<module:Vips>'
	from /home/dynamic/.rvm/gems/ruby-3.0.2/gems/ruby-vips-2.1.4/lib/vips.rb:570:in `<main>'
...
...
```

### System configuration
**Rails version**: 7.0.0

**Ruby version**: 3.0.3

### What fixed the issue:
I installed ImageMagick and libvips: `sudo apt install imagemagick libvips` and the error went away and everything works normally. It took me a long time to figure that out. I hope there is a more appropriate error message when ImageMagick and libvips are not installed on the computer. The error message should clearly ask the user to install ImageMagick to proceed. This will save a lot of frustration and time.
",https://api.github.com/repos/rails/rails/issues/43976/timeline,,overdrivemachines,1007217,MDQ6VXNlcjEwMDcyMTc=,https://avatars.githubusercontent.com/u/1007217?v=4,,https://api.github.com/users/overdrivemachines,https://github.com/overdrivemachines,https://api.github.com/users/overdrivemachines/followers,https://api.github.com/users/overdrivemachines/following{/other_user},https://api.github.com/users/overdrivemachines/gists{/gist_id},https://api.github.com/users/overdrivemachines/starred{/owner}{/repo},https://api.github.com/users/overdrivemachines/subscriptions,https://api.github.com/users/overdrivemachines/orgs,https://api.github.com/users/overdrivemachines/repos,https://api.github.com/users/overdrivemachines/events{/privacy},https://api.github.com/users/overdrivemachines/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43976/reactions,7,6,0,0,0,0,1,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
240,https://api.github.com/repos/rails/rails/issues/43973,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43973/labels{/name},https://api.github.com/repos/rails/rails/issues/43973/comments,https://api.github.com/repos/rails/rails/issues/43973/events,https://github.com/rails/rails/issues/43973,1087061641,I_kwDNIULOQMs-iQ,43973,"Adding `type: ""module""` to actiontext caused an error",[],open,False,,[],,6,2021-12-22T18:04:22Z,2022-03-22T10:17:23Z,,CONTRIBUTOR,,"In [webpack](https://webpack.js.org/guides/ecma-script-modules/) it says

> Imports in ESM are resolved more strictly. Relative requests must include a filename and file extension.

By adding `type: ""module""` to [actiontext](https://github.com/rails/rails/blob/main/actiontext/package.json#L6), but not importing with an extension [here](https://github.com/rails/rails/blob/main/actiontext/app/javascript/actiontext/attachment_upload.js#L1), importing actiontext generates an error... I think.

### Steps to reproduce

In my app/javascript/packs/application.js, importing `import ""@rails/actiontext""`  generates an error message when running `bin/webpack` or `bin/webpack-dev-server`

It errors with just actiontext, as well an combination of the following:

```
import ""core-js/stable"";
import ""regenerator-runtime/runtime"";
import ""@rails/activestorage"";
import ""@rails/actiontext"";
import ""@rails/ujs"";

Rails.start();
```

Using actiontext (7.0.0) with webpacker (6.0.0-rc.6). I tried to create a test repo but could not get `rails webpacker:install` or `rails new --webpacker` (I think maybe it's gone in favor of the new stuff) to run.

### Expected behavior

It should import without an error message

### Actual behavior

It generates the following error

> ERROR in ./node_modules/@rails/actiontext/app/javascript/actiontext/index.js 1:0-54
> Module not found: Error: Can't resolve './attachment_upload' in '/Users/tomify/Desktop/development/visible-voices/node_modules/@rails/actiontext/app/javascript/actiontext'
> Did you mean 'attachment_upload.js'?
> BREAKING CHANGE: The request './attachment_upload' failed to resolve only because it was resolved as fully specified
> (probably because the origin is strict EcmaScript Module, e. g. a module with javascript mimetype, a '*.mjs' file, or a '*.js' file where the package.json contains '""type"": ""module""').
> The extension in the request is mandatory for it to be fully specified.
> Add the extension to the request.
> resolve './attachment_upload' in '/Users/tomify/Desktop/development/visible-voices/node_modules/@rails/actiontext/app/javascript/actiontext'
>   using description file: /Users/tomify/Desktop/development/visible-voices/node_modules/@rails/actiontext/package.json (relative path: ./app/javascript/actiontext)
>     Field 'browser' doesn't contain a valid alias configuration
>     using description file: /Users/tomify/Desktop/development/visible-voices/node_modules/@rails/actiontext/package.json (relative path: ./app/javascript/actiontext/attachment_upload)
>       Field 'browser' doesn't contain a valid alias configuration
>       /Users/tomify/Desktop/development/visible-voices/node_modules/@rails/actiontext/app/javascript/actiontext/attachment_upload doesn't exist
> 
> webpack 5.64.4 compiled with 1 error and 1 warning in 23809 ms

### System configuration

**Rails version**: 7.0.0
**Ruby version**: 2.7.1

Here is my package.json with potentially relevant libraries. I tested different combinations as well as removing some of them, but the error persists.

```
{
  ""name"": ""app"",
  ""browserslist"": [""defaults""],
  ""dependencies"": {
    ""@babel/core"": ""^7.16.0"",
    ""@babel/plugin-proposal-export-default-from"": ""^7.16.0"",
    ""@babel/preset-react"": ""^7.16.0"",
    ""@rails/actiontext"": ""^7.0.0"",
    ""@rails/activestorage"": ""^7.0.0"",
    ""@rails/ujs"": ""7.0.0"",
    ""@rails/webpacker"": ""6.0.0-rc.6"",
    ""core-js"": ""^3.18.2"",
    ""css-loader"": ""^6.3.0"",
    ""css-minimizer-webpack-plugin"": ""^3.2.0"",
    ""mini-css-extract-plugin"": ""^2.3.0"",
    ""prop-types"": ""^15.7.2"",
    ""react"": ""^17.0.2"",
    ""react-dom"": ""^17.0.2"",
    ""react-router-dom"": ""^6.0.2"",
    ""regenerator-runtime"": ""^0.13.9"",
    ""resolve-url-loader"": ""^4.0.0"",
    ""trix"": ""^1.2.0"",
    ""webpack"": ""^5.64.4"",
    ""webpack-cli"": ""^4.8.0""
  },
  ""devDependencies"": {
    ""@babel/eslint-parser"": ""^7.16.0"",
    ""@babel/eslint-plugin"": ""7.14.5"",
    ""@webpack-cli/serve"": ""^1.5.2"",
    ""webpack-dev-server"": ""^4.6.0""
  },
  ""private"": true,
  ""scripts"": {
    ""dev"": ""./bin/webpack-dev-server""
  },
  ""version"": ""0.0.0""
}
```
",https://api.github.com/repos/rails/rails/issues/43973/timeline,,tomprats,1906547,MDQ6VXNlcjE5MDY1NDc=,https://avatars.githubusercontent.com/u/1906547?v=4,,https://api.github.com/users/tomprats,https://github.com/tomprats,https://api.github.com/users/tomprats/followers,https://api.github.com/users/tomprats/following{/other_user},https://api.github.com/users/tomprats/gists{/gist_id},https://api.github.com/users/tomprats/starred{/owner}{/repo},https://api.github.com/users/tomprats/subscriptions,https://api.github.com/users/tomprats/orgs,https://api.github.com/users/tomprats/repos,https://api.github.com/users/tomprats/events{/privacy},https://api.github.com/users/tomprats/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43973/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
241,https://api.github.com/repos/rails/rails/issues/43966,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43966/labels{/name},https://api.github.com/repos/rails/rails/issues/43966/comments,https://api.github.com/repos/rails/rails/issues/43966/events,https://github.com/rails/rails/issues/43966,1086684082,I_kwDNIULOQMV7sg,43966,ActiveRecord::Type::Time::Value crashes when loaded from YAML on rails 7.0,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,28,2021-12-22T10:33:29Z,2022-02-01T18:10:23Z,,CONTRIBUTOR,,"### Steps to reproduce
```
# Rails 6.1
(byebug) YAML.load(YAML.dump(ActiveRecord::Type::Time::Value.new(Time.current))) + 1.day
Thu, 23 Dec 2021 10:24:42.873895000 UTC +00:00

# Rails 7
(byebug) YAML.load(YAML.dump(ActiveRecord::Type::Time::Value.new(Time.current))) + 1.day
*** ArgumentError Exception: not delegated
```
### Expected behavior
Should return an `ActiveRecord::Type::Time::Value` object

### Actual behavior
Raises `ArgumentError Exception: not delegated`

### System configuration
**Rails version**: 7.0

**Ruby version**: 3.0.3 and 2.7.3

# Details

We are trying to make the paper_trail gem [compatible with rails 7](https://github.com/paper-trail-gem/paper_trail/pull/1356) and encountered this issue. It looks like `ActiveRecord::Type::Time::Value` is not properly deserializable from YAML.

In Rails 6.1, it used to be dumped as `ActiveSupport::TimeWithZone` which avoided the issue.

Looks like this line is the one raising the exception : 

https://github.com/rails/rails/blob/a8d088fbdc7744d1806729dc8b4e477677056dce/activerecord/lib/active_record/type/time.rb#L24
",https://api.github.com/repos/rails/rails/issues/43966/timeline,,Intrepidd,803765,MDQ6VXNlcjgwMzc2NQ==,https://avatars.githubusercontent.com/u/803765?v=4,,https://api.github.com/users/Intrepidd,https://github.com/Intrepidd,https://api.github.com/users/Intrepidd/followers,https://api.github.com/users/Intrepidd/following{/other_user},https://api.github.com/users/Intrepidd/gists{/gist_id},https://api.github.com/users/Intrepidd/starred{/owner}{/repo},https://api.github.com/users/Intrepidd/subscriptions,https://api.github.com/users/Intrepidd/orgs,https://api.github.com/users/Intrepidd/repos,https://api.github.com/users/Intrepidd/events{/privacy},https://api.github.com/users/Intrepidd/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43966/reactions,8,6,0,0,0,0,0,0,2,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
242,https://api.github.com/repos/rails/rails/issues/43953,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43953/labels{/name},https://api.github.com/repos/rails/rails/issues/43953/comments,https://api.github.com/repos/rails/rails/issues/43953/events,https://github.com/rails/rails/issues/43953,1085817805,I_kwDNIULOQLhDzQ,43953,Only 1 level of subdomains is allowed since Rails 6.1.4.4,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,4,2021-12-21T13:10:25Z,2022-02-01T18:09:12Z,,CONTRIBUTOR,,"With the following configuration:

```ruby
config.hosts << "".test""
```

It was possible to access myapp.test, us.myapp.test, en.us.myapp.test. Now it only allows the first level of subdomains: myapp.test. I believe that was an unintentional change and there was no security risk in the old behavior.

Related to https://github.com/rails/rails/issues/43864",https://api.github.com/repos/rails/rails/issues/43953/timeline,,semaperepelitsa,347921,MDQ6VXNlcjM0NzkyMQ==,https://avatars.githubusercontent.com/u/347921?v=4,,https://api.github.com/users/semaperepelitsa,https://github.com/semaperepelitsa,https://api.github.com/users/semaperepelitsa/followers,https://api.github.com/users/semaperepelitsa/following{/other_user},https://api.github.com/users/semaperepelitsa/gists{/gist_id},https://api.github.com/users/semaperepelitsa/starred{/owner}{/repo},https://api.github.com/users/semaperepelitsa/subscriptions,https://api.github.com/users/semaperepelitsa/orgs,https://api.github.com/users/semaperepelitsa/repos,https://api.github.com/users/semaperepelitsa/events{/privacy},https://api.github.com/users/semaperepelitsa/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43953/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
243,https://api.github.com/repos/rails/rails/issues/43945,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43945/labels{/name},https://api.github.com/repos/rails/rails/issues/43945/comments,https://api.github.com/repos/rails/rails/issues/43945/events,https://github.com/rails/rails/pull/43945,1085082956,PR_kwDNIULOMBgsOA,43945,Add `ActiveRecord::Base::normalizes`,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,20,2021-12-20T18:25:19Z,2022-04-20T20:18:48Z,,MEMBER,,"This method can be used to declare normalizations for attribute values.  Normalizations are applied when attributes are assigned or updated, and the normalized values will be persisted to the database.  Normalizations are also applied to matching keyword arguments of finder methods.  This allows a record to be created and later queried using an unnormalized value.  For example:

```ruby
class User < ActiveRecord::Base
  normalizes :email, with: -> email { email.strip.downcase }
end

user = User.create(email: "" CRUISE-CONTROL@EXAMPLE.COM\n"")
user.email                  # => ""cruise-control@example.com""

user = User.find_by(email: ""\tCRUISE-CONTROL@EXAMPLE.COM "")
user.email                  # => ""cruise-control@example.com""
user.email_before_type_cast # => ""cruise-control@example.com""
```
",https://api.github.com/repos/rails/rails/issues/43945/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43945/reactions,75,14,0,0,11,0,50,0,0,False,https://api.github.com/repos/rails/rails/pulls/43945,https://github.com/rails/rails/pull/43945,https://github.com/rails/rails/pull/43945.diff,https://github.com/rails/rails/pull/43945.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
244,https://api.github.com/repos/rails/rails/issues/43937,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43937/labels{/name},https://api.github.com/repos/rails/rails/issues/43937/comments,https://api.github.com/repos/rails/rails/issues/43937/events,https://github.com/rails/rails/issues/43937,1084126340,I_kwDNIULOQJ50hA,43937,"Rails.env == ""development"" when starting system tests","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,10,2021-12-19T15:39:41Z,2022-04-15T10:31:50Z,,CONTRIBUTOR,,"When launching system tests, `Rails.env == ""development""` after launching the tests, but is correctly `test` in the test themselves.

This is breaking thinks like the `dotenv-rails` gem, due to the following:
- `rails test:system` is started
- App is loaded, `Rails.env == ""development""`, so `dotenv-rails` loads the env variables for `development`, and those are added to the process's `ENV` variable
- The main process then launches the tests's process, which inherits its parent's `ENV`
- `dotenv-rails` load the env variables for `test`
- But is some variables were set for `development` but dont have a value in `test`, they are still defined in the tests

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

- Create a new Rails 7 application
- Add `puts ""Rails.env: #{Rails.env}""` to `config/application.rb` on line 7 (after the `Bundler.require` line)
- Run system tests: `rails test:system`

### Expected behavior
`Rails.env` should be `test`, as it is in Rails 6.1 and when running `rails test`

### Actual behavior
`Rails.env` is `development`

### System configuration
**Rails version**:
7.0.0
**Ruby version**:
3.0.3",https://api.github.com/repos/rails/rails/issues/43937/timeline,,renchap,42070,MDQ6VXNlcjQyMDcw,https://avatars.githubusercontent.com/u/42070?v=4,,https://api.github.com/users/renchap,https://github.com/renchap,https://api.github.com/users/renchap/followers,https://api.github.com/users/renchap/following{/other_user},https://api.github.com/users/renchap/gists{/gist_id},https://api.github.com/users/renchap/starred{/owner}{/repo},https://api.github.com/users/renchap/subscriptions,https://api.github.com/users/renchap/orgs,https://api.github.com/users/renchap/repos,https://api.github.com/users/renchap/events{/privacy},https://api.github.com/users/renchap/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43937/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
245,https://api.github.com/repos/rails/rails/issues/43928,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43928/labels{/name},https://api.github.com/repos/rails/rails/issues/43928/comments,https://api.github.com/repos/rails/rails/issues/43928/events,https://github.com/rails/rails/issues/43928,1083763539,I_kwDNIULOQJjrUw,43928,Action Mailbox Conductor throws NoMethodError when creating inbound email,"[{'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,4,2021-12-18T06:45:18Z,2022-02-18T23:28:58Z,,NONE,,"### Steps to reproduce
- rails new conductor_bug
- cd conductor_bug
- rails action_mailbox:install
- rails db:migrate
- echo ""class ApplicationMailbox < ActionMailbox::Base\n routing all: :catchall\nend"" > 'app/mailboxes/application_mailbox.rb'
- echo ""class CatchallMailbox < ApplicationMailbox\n def process; end\nend"" > 'app/mailboxes/catchall_mailbox.rb'
- rails s
- Visit ""http://localhost:3000/rails/conductor/action_mailbox/inbound_emails/new""
- Leave completely blank or attach a file (same result)
- Press Submit

Test file at bottom. 

### Expected behavior
Conductor should create inbound email

### Actual behavior
```
NoMethodError in Rails::Conductor::ActionMailbox::InboundEmailsController#create
undefined method `original_filename' for """":String

>> mail_params[:attachments]
=> [""""]
```
Or if there is an attachment:
```
>> mail_params[:attachments]
=> ["""", #<ActionDispatch::Http::UploadedFile:...
```

### Proposed Solution

mail_params[:attachments] is an array of attachments however the first element as a blank string whether there are attachments or not. This is causing the NoMethodError as the original_filename method is being called on the attachment elements. 

https://github.com/rails/rails/blob/260f735a1acf040fc0c306c3fbfc59e066539715/actionmailbox/app/controllers/rails/conductor/action_mailbox/inbound_emails_controller.rb#L25

The browsers I tested (Chrome, Edge, Brave, Safari) all pass this empty string into the attachments array. I think we need to handle this?

The above line could be changed to:

`mail_params[:attachments].reject(&:blank?).to_a.each do |attachments|`

Happy to open PR with below tests if solution is appropriate.

### System configuration
**Rails version**: 7.0.0

**Ruby version**: 3.0.2p107

### Script to reproduce
Note that all this does is add a blank string to the element array which is what is happening in practice. As above this might not be appropriate

```
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""rails"", ""~> 7.0.0""
  gem ""sqlite3""
  if RUBY_VERSION >= ""3.1""
    # net-smtp, net-imap and net-pop were removed from default gems in Ruby 3.1, but is used by the `mail` gem.
    # So we need to add them as dependencies until `mail` is fixed: https://github.com/mikel/mail/pull/1439
    gem ""net-smtp"", require: false

    # digest gem, which is one of the default gems has bumped to 3.1.0.pre for ruby 3.1.0dev.
    # Also `net-smtp` v0.2.2 adds dependency to digest gem which attempts to install digest 3.0.0.
    gem ""digest"", ""~> 3.1.0.pre"", require: false
  end
end

require ""active_record/railtie""
require ""active_storage/engine""
require ""action_mailbox/engine""
require ""tmpdir""

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""www.example.com""
  config.eager_load = false
  config.session_store :cookie_store, key: ""cookie_store_key""
  secrets.secret_key_base = ""secret_key_base""

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  config.active_storage.service = :local
  config.active_storage.service_configurations = {
    local: {
      root: Dir.tmpdir,
      service: ""Disk""
    }
  }

  config.action_mailbox.ingress = :relay
end

ENV[""DATABASE_URL""] = ""sqlite3::memory:""

Rails.application.initialize!

require ActiveStorage::Engine.root.join(""db/migrate/20170806125915_create_active_storage_tables.rb"").to_s
require ActionMailbox::Engine.root.join(""db/migrate/20180917164000_create_action_mailbox_tables.rb"").to_s

ActiveRecord::Schema.define do
  CreateActiveStorageTables.new.change
  CreateActionMailboxTables.new.change
end

class ApplicationMailbox < ActionMailbox::Base
  routing (/^replies@/i) => :replies
end

class RepliesMailbox < ActionMailbox::Base
  def process
    $processed = mail.subject
  end
end

require ""minitest/autorun""

File.write('test_attachment.txt','test')

class InboundEmailsControllerTestNew < ActionDispatch::IntegrationTest
  test ""create inbound email with attachment"" do
    with_rails_env(""development"") do
      post rails_conductor_inbound_emails_path, params: {
        mail: {
          from: ""Jason Fried <jason@37signals.com>"",
          to: ""Replies <replies@example.com>"",
          subject: ""Let's debate some attachments"",
          body: ""Let's talk about these images:"",
          attachments: [ fixture_file_upload(""test_attachment.txt"") ]
        }
      }

      assert_response :redirect
    end
  end

  test ""create inbound email with attachment and empty string"" do
    with_rails_env(""development"") do
      post rails_conductor_inbound_emails_path, params: {
        mail: {
          from: ""Jason Fried <jason@37signals.com>"",
          to: ""Replies <replies@example.com>"",
          subject: ""Let's debate some attachments"",
          body: ""Let's talk about these images:"",
          attachments: [ """", fixture_file_upload(""test_attachment.txt"") ]
        }
      }

      assert_response :redirect
    end
  end

  test ""create inbound email with no attachments"" do
    with_rails_env(""development"") do
      post rails_conductor_inbound_emails_path, params: {
        mail: {
          from: ""Jason Fried <jason@37signals.com>"",
          to: ""Replies <replies@example.com>"",
          subject: ""Let's debate some attachments"",
          body: ""Let's talk about these images:"",
          attachments: [  ]
        }
      }

      assert_response :redirect
    end
  end

  test ""create inbound email with no attachments and blank string"" do
    with_rails_env(""development"") do
      post rails_conductor_inbound_emails_path, params: {
        mail: {
          from: ""Jason Fried <jason@37signals.com>"",
          to: ""Replies <replies@example.com>"",
          subject: ""Let's debate some attachments"",
          body: ""Let's talk about these images:"",
          attachments: [ """" ]
        }
      }

      assert_response :redirect
    end
  end

  private
    def with_rails_env(env)
      old_rails_env = Rails.env
      Rails.env = env
      yield
    ensure
      Rails.env = old_rails_env
    end
end
```",https://api.github.com/repos/rails/rails/issues/43928/timeline,,andrew2005,2309740,MDQ6VXNlcjIzMDk3NDA=,https://avatars.githubusercontent.com/u/2309740?v=4,,https://api.github.com/users/andrew2005,https://github.com/andrew2005,https://api.github.com/users/andrew2005/followers,https://api.github.com/users/andrew2005/following{/other_user},https://api.github.com/users/andrew2005/gists{/gist_id},https://api.github.com/users/andrew2005/starred{/owner}{/repo},https://api.github.com/users/andrew2005/subscriptions,https://api.github.com/users/andrew2005/orgs,https://api.github.com/users/andrew2005/repos,https://api.github.com/users/andrew2005/events{/privacy},https://api.github.com/users/andrew2005/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43928/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
246,https://api.github.com/repos/rails/rails/issues/43922,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43922/labels{/name},https://api.github.com/repos/rails/rails/issues/43922/comments,https://api.github.com/repos/rails/rails/issues/43922/events,https://github.com/rails/rails/issues/43922,1083439123,I_kwDNIULOQJP4Ew,43922,Flash error when in API mode,"[{'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,10,2021-12-17T16:46:48Z,2022-04-24T04:56:01Z,,CONTRIBUTOR,,"In an API only app (no session store) I'm seeing an error because the session is a hash:
https://github.com/rails/rails/blob/main/actionpack/lib/action_dispatch/middleware/flash.rb#L62

The Flash middleware is not in my stack, because I'm in API mode.
```
[Honeybadger::Rack::UserInformer, Honeybadger::Rack::UserFeedback, Honeybadger::Rack::ErrorNotifier,
 ActionDispatch::HostAuthorization, Rack::Sendfile, ActionDispatch::Static, ActionDispatch::Executor,
 ActiveSupport::Cache::Strategy::LocalCache::Middleware, Rack::Runtime, ActionDispatch::RequestId,
 RequestStore::Middleware, ActionDispatch::RemoteIp, Rails::Rack::Logger, ActionDispatch::ShowExceptions,
 ActionDispatch::DebugExceptions, ActionDispatch::ActionableExceptions, ActionDispatch::Callbacks, Rack::Head,
 Rack::ConditionalGet, Rack::ETag]
```

This used to work in rails 6.1, but starts failing after upgrading to 7.0.0

I believe this is because Metal calls commit_flash directly: https://github.com/rails/rails/blame/main/actionpack/lib/action_controller/metal.rb#L189

And the object returned by `Rack::Request#session` is a plain Hash

and this change did not account for this use case: https://github.com/rails/rails/commit/ca7c820c6962788d510c99a68e725de83cbe9cad

```
Failures:

  1) Update a workflow step for an object with error XML updates the step with error message/text
     Failure/Error: put ""/dor/objects/#{druid}/workflows/#{wf.workflow}/#{wf.process}"", params: process_xml

     NoMethodError:
       undefined method `enabled?' for {}:Hash
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/flash.rb:62:in `commit_flash'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_controller/metal.rb:189:in `dispatch'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_controller/metal.rb:251:in `dispatch'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/routing/route_set.rb:49:in `dispatch'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/routing/route_set.rb:32:in `serve'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/journey/router.rb:50:in `block in serve'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/journey/router.rb:32:in `each'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/journey/router.rb:32:in `serve'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/routing/route_set.rb:850:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-2.2.3/lib/rack/etag.rb:27:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-2.2.3/lib/rack/conditional_get.rb:40:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-2.2.3/lib/rack/head.rb:12:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/activesupport-7.0.0/lib/active_support/callbacks.rb:99:in `run_callbacks'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/callbacks.rb:26:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/actionable_exceptions.rb:17:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/debug_exceptions.rb:28:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/show_exceptions.rb:26:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/railties-7.0.0/lib/rails/rack/logger.rb:36:in `call_app'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/railties-7.0.0/lib/rails/rack/logger.rb:25:in `block in call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/activesupport-7.0.0/lib/active_support/tagged_logging.rb:99:in `block in tagged'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/activesupport-7.0.0/lib/active_support/tagged_logging.rb:37:in `tagged'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/activesupport-7.0.0/lib/active_support/tagged_logging.rb:99:in `tagged'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/railties-7.0.0/lib/rails/rack/logger.rb:25:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/remote_ip.rb:93:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/request_store-1.5.0/lib/request_store/middleware.rb:19:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/request_id.rb:26:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-2.2.3/lib/rack/runtime.rb:22:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/activesupport-7.0.0/lib/active_support/cache/strategy/local_cache_middleware.rb:29:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/executor.rb:14:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/static.rb:23:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-2.2.3/lib/rack/sendfile.rb:110:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/middleware/host_authorization.rb:131:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/honeybadger-4.9.0/lib/honeybadger/rack/error_notifier.rb:33:in `block in call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/honeybadger-4.9.0/lib/honeybadger/agent.rb:426:in `with_rack_env'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/honeybadger-4.9.0/lib/honeybadger/rack/error_notifier.rb:30:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/honeybadger-4.9.0/lib/honeybadger/rack/user_feedback.rb:31:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/honeybadger-4.9.0/lib/honeybadger/rack/user_informer.rb:21:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/railties-7.0.0/lib/rails/engine.rb:530:in `call'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/mock_session.rb:29:in `request'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/test.rb:266:in `process_request'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/rack-test-1.1.0/lib/rack/test.rb:119:in `request'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/testing/integration.rb:279:in `process'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/testing/integration.rb:34:in `put'
     # /Users/jcoyne85/.rbenv/versions/2.7.2/lib/ruby/gems/2.7.0/gems/actionpack-7.0.0/lib/action_dispatch/testing/integration.rb:370:in `put'
```",https://api.github.com/repos/rails/rails/issues/43922/timeline,,jcoyne,92044,MDQ6VXNlcjkyMDQ0,https://avatars.githubusercontent.com/u/92044?v=4,,https://api.github.com/users/jcoyne,https://github.com/jcoyne,https://api.github.com/users/jcoyne/followers,https://api.github.com/users/jcoyne/following{/other_user},https://api.github.com/users/jcoyne/gists{/gist_id},https://api.github.com/users/jcoyne/starred{/owner}{/repo},https://api.github.com/users/jcoyne/subscriptions,https://api.github.com/users/jcoyne/orgs,https://api.github.com/users/jcoyne/repos,https://api.github.com/users/jcoyne/events{/privacy},https://api.github.com/users/jcoyne/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43922/reactions,1,0,0,0,0,0,0,0,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
247,https://api.github.com/repos/rails/rails/issues/43906,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43906/labels{/name},https://api.github.com/repos/rails/rails/issues/43906/comments,https://api.github.com/repos/rails/rails/issues/43906/events,https://github.com/rails/rails/issues/43906,1082720675,I_kwDNIULOQIkBow,43906,Rails 7 assets:precompile webpack not found,"[{'id': 128693, 'node_id': 'MDU6TGFiZWwxMjg2OTM=', 'url': 'https://api.github.com/repos/rails/rails/labels/asset%20pipeline', 'name': 'asset pipeline', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,18,2021-12-16T23:11:54Z,2022-04-16T02:46:11Z,,NONE,,"
I have a Rails 6.1/Ruby 3.0.3 app where I ran bundle update rails, upgraded yarn versions, and ran rails app:update.
This worked fine locally with no issues.  I then pushed to production where one of the steps is 'rails assets:precompile'
This command fails with:

```
Compiling...
Compilation failed:
yarn run v1.22.17
info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.

error Command ""webpack"" not found.
```

If I revert back to Rails version 6.1.4.4 the command works perfectly fine and compiles assets.
",https://api.github.com/repos/rails/rails/issues/43906/timeline,,jason-hobbs,8509501,MDQ6VXNlcjg1MDk1MDE=,https://avatars.githubusercontent.com/u/8509501?v=4,,https://api.github.com/users/jason-hobbs,https://github.com/jason-hobbs,https://api.github.com/users/jason-hobbs/followers,https://api.github.com/users/jason-hobbs/following{/other_user},https://api.github.com/users/jason-hobbs/gists{/gist_id},https://api.github.com/users/jason-hobbs/starred{/owner}{/repo},https://api.github.com/users/jason-hobbs/subscriptions,https://api.github.com/users/jason-hobbs/orgs,https://api.github.com/users/jason-hobbs/repos,https://api.github.com/users/jason-hobbs/events{/privacy},https://api.github.com/users/jason-hobbs/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43906/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
248,https://api.github.com/repos/rails/rails/issues/43812,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43812/labels{/name},https://api.github.com/repos/rails/rails/issues/43812/comments,https://api.github.com/repos/rails/rails/issues/43812/events,https://github.com/rails/rails/pull/43812,1074877599,PR_kwDNIULOL5PWUg,43812,"Adds ""Deferrable Foreign Keys"" section to PostgreSQL guide","[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,2,2021-12-08T21:54:56Z,2022-03-14T08:15:35Z,,CONTRIBUTOR,,,https://api.github.com/repos/rails/rails/issues/43812/timeline,,eikes,219275,MDQ6VXNlcjIxOTI3NQ==,https://avatars.githubusercontent.com/u/219275?v=4,,https://api.github.com/users/eikes,https://github.com/eikes,https://api.github.com/users/eikes/followers,https://api.github.com/users/eikes/following{/other_user},https://api.github.com/users/eikes/gists{/gist_id},https://api.github.com/users/eikes/starred{/owner}{/repo},https://api.github.com/users/eikes/subscriptions,https://api.github.com/users/eikes/orgs,https://api.github.com/users/eikes/repos,https://api.github.com/users/eikes/events{/privacy},https://api.github.com/users/eikes/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43812/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43812,https://github.com/rails/rails/pull/43812,https://github.com/rails/rails/pull/43812.diff,https://github.com/rails/rails/pull/43812.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
249,https://api.github.com/repos/rails/rails/issues/43770,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43770/labels{/name},https://api.github.com/repos/rails/rails/issues/43770/comments,https://api.github.com/repos/rails/rails/issues/43770/events,https://github.com/rails/rails/pull/43770,1070205103,PR_kwDNIULOL1d3kg,43770,Pass params to url_for that ONLY get used for named segments; otherwise discard them,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,4,2021-12-03T04:23:22Z,2022-03-09T14:26:53Z,,CONTRIBUTOR,,"### What Problem Does This PR Solve?

[In my app](https://dev.to/kolide/a-rails-multi-tenant-strategy-thats-30-lines-and-just-works-58cd) we scope many of our routes by an `account_id`. Some routes however, live outside this scope (like the auth routes or other pages not associated with the main app).

A simplified version of our router looks something like this...

```ruby
Rails.application.routes.draw do
  scope "":account_id"" do
    get ""dashboard"" => ""pages#dashboard"", as: :dashboard
    get ""search/:term"" => ""search#search"", as: :search
  end
  delete ""signout"" => ""sessions#destroy"", as: :signout
end
```

When writing views in our app, we don't always want to supply the `account_id` to every single URL helper method (ex: `dashboard_path(account_id: Current.account)` because we'd be writing it everywhere. So in our `ApplicationController` we mix-in the following method...

```ruby
def default_url_options
 { account_id: Current.account }
end
```

This works great, save for one extremely annoying consequence; routes that live outside the scope (like `signout_path`) will have `?account_id=foo` tacked on the end of them. Not only does this look ugly, it can also introduce caching issues with things like CDNs when using [stuff like this.](https://edgeguides.rubyonrails.org/active_storage_overview.html#putting-a-cdn-in-front-of-active-storage)

I spent hours trying to figure out an elegant/supported way to have the params in `default_url_options` be used only if they were part of a named segment in the route. I came up short, so I decided to write a feature for it in Rails.

### Introducing the new `path_params` option for `url_for`

With this PR, the `url_for` helper now supports a new option called `path_params `. If you pass a hash of params to this key,
they will _only_ be used for the named segments portion of the route. If they aren't used, they are discarded instead of tacked on the end as query params. 

Using the same router as above and given the following `ApplicationController`...

```ruby
  class ApplicationController < ActionController::Base
    def default_url_options
      { path_params: { account_id: ""foo"" } }
    end
  end
```

...the standard `url_for` helpers will now behave as follows:

```ruby
dashboard_path # => /foo/dashboard
dashboard_path(account_id: ""bar"") # => /bar/dashboard
signout_path # => /signout
signout_path(account_id: ""bar"") # => /signout?account_id=bar
search_path(""quin"") # => /foo/search/quin
```

### Closing Thoughts
We are using this code in production so far without issue. I am open to changes here (especially the name of the option), but I really think other apps with a similar router goals could benefit immensely from this enhancement. I hope you will consider it for inclusion in a future version of Rails.",https://api.github.com/repos/rails/rails/issues/43770/timeline,,terracatta,315873,MDQ6VXNlcjMxNTg3Mw==,https://avatars.githubusercontent.com/u/315873?v=4,,https://api.github.com/users/terracatta,https://github.com/terracatta,https://api.github.com/users/terracatta/followers,https://api.github.com/users/terracatta/following{/other_user},https://api.github.com/users/terracatta/gists{/gist_id},https://api.github.com/users/terracatta/starred{/owner}{/repo},https://api.github.com/users/terracatta/subscriptions,https://api.github.com/users/terracatta/orgs,https://api.github.com/users/terracatta/repos,https://api.github.com/users/terracatta/events{/privacy},https://api.github.com/users/terracatta/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43770/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43770,https://github.com/rails/rails/pull/43770,https://github.com/rails/rails/pull/43770.diff,https://github.com/rails/rails/pull/43770.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
250,https://api.github.com/repos/rails/rails/issues/43760,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43760/labels{/name},https://api.github.com/repos/rails/rails/issues/43760/comments,https://api.github.com/repos/rails/rails/issues/43760/events,https://github.com/rails/rails/pull/43760,1067697420,PR_kwDNIULOLzZMOA,43760,"Fix NoMethod ""flash"" on ActionDispatch::Request error","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,8,2021-11-30T21:34:55Z,2022-03-03T15:15:42Z,,CONTRIBUTOR,,"### Summary

Steps to reproduce:

- Load rails in api_only mode. This will not load the flash middleware
  and the flash request mixin.
- Create a POST route/action that is protected with null_session.
- Run the post action. You should get the NoMethodError ""flash"" on Request.

This repo contains a single example route that causes the error as well: https://github.com/kwstannard/rails-bug

### Other Information

I split the change into two more reviewable commits.

I don't know how to test this change and it appears that the tests that exist for null session are ""No error occurred"" type tests and don't check any of the null session code is run. I can add some tests if someone can point me toward something I can put expectations on.",https://api.github.com/repos/rails/rails/issues/43760/timeline,,kwstannard,1151753,MDQ6VXNlcjExNTE3NTM=,https://avatars.githubusercontent.com/u/1151753?v=4,,https://api.github.com/users/kwstannard,https://github.com/kwstannard,https://api.github.com/users/kwstannard/followers,https://api.github.com/users/kwstannard/following{/other_user},https://api.github.com/users/kwstannard/gists{/gist_id},https://api.github.com/users/kwstannard/starred{/owner}{/repo},https://api.github.com/users/kwstannard/subscriptions,https://api.github.com/users/kwstannard/orgs,https://api.github.com/users/kwstannard/repos,https://api.github.com/users/kwstannard/events{/privacy},https://api.github.com/users/kwstannard/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43760/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43760,https://github.com/rails/rails/pull/43760,https://github.com/rails/rails/pull/43760.diff,https://github.com/rails/rails/pull/43760.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
251,https://api.github.com/repos/rails/rails/issues/43755,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43755/labels{/name},https://api.github.com/repos/rails/rails/issues/43755/comments,https://api.github.com/repos/rails/rails/issues/43755/events,https://github.com/rails/rails/pull/43755,1067405303,PR_kwDNIULOLzJ7sg,43755,Log redirects from router similarly to controller redirects,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,7,2021-11-30T16:00:45Z,2022-03-23T14:09:42Z,,NONE,,"_Note: I've [posted this on the discussion forum](https://discuss.rubyonrails.org/t/log-redirects-from-routes-similarly-as-redirects-from-controllers/79163) before (as per the guidelines), but didn't get a response there. That's why I'm opening a PR now, feel free to close if necessary._

### Summary

I want to propose a change to add logging to redirects that happen directly from routes.

Right now when a redirect happens in a route, it’s not clear from the log that an actual redirect happened. I was trying to find where a redirect originated and it took me some time to realize this, as redirects from controllers are logged differently.

For example with these routes:

```ruby
get :moo, to: ""rails/welcome#index""
get :redirect, to: ""regular#redirect""
root to: redirect(""moo"")
```

When requesting the route with the direct redirect, the logs only shows a line for the initial GET and then the GET for the redirected page:

> Started GET ""/"" for 127.0.0.1 at 2021-10-21 13:09:51 +0200
Started GET ""/moo"" for 127.0.0.1 at 2021-10-21 13:09:51 +0200
Processing by Rails::WelcomeController#index as */*                                                                 
...

While a redirect generated in a controller shows a lot more info:

> Started GET ""/redirect"" for 127.0.0.1 at 2021-10-21 13:11:33 +0200
> Processing by RegularController#redirect as */*
> Redirected to http://localhost:3000/moo
> Completed 302 Found in 0ms (ActiveRecord: 0.0ms | Allocations: 414)
>
>
> Started GET ""/moo"" for 127.0.0.1 at 2021-10-21 13:11:33 +0200
> Processing by Rails::WelcomeController#index as */*
> ...

I've added some instrumentation to ActionDispatch::Routing::Redirect that creates a similar log output for redirects from a route.

With these changes a redirect from a route would look like this in the logs:

> Started GET ""/"" for 127.0.0.1 at 2021-10-21 13:14:49 +0200
> Redirected to http://localhost:3000/moo
> Completed 301 Moved Permanently in 0ms
> 
> 
> Started GET ""/moo"" for 127.0.0.1 at 2021-10-21 13:14:49 +0200
> Processing by Rails::WelcomeController#index as */*
> ...

Happy to hear your thoughts. I'm open for suggestions and improvements.",https://api.github.com/repos/rails/rails/issues/43755/timeline,,djfpaagman,170034,MDQ6VXNlcjE3MDAzNA==,https://avatars.githubusercontent.com/u/170034?v=4,,https://api.github.com/users/djfpaagman,https://github.com/djfpaagman,https://api.github.com/users/djfpaagman/followers,https://api.github.com/users/djfpaagman/following{/other_user},https://api.github.com/users/djfpaagman/gists{/gist_id},https://api.github.com/users/djfpaagman/starred{/owner}{/repo},https://api.github.com/users/djfpaagman/subscriptions,https://api.github.com/users/djfpaagman/orgs,https://api.github.com/users/djfpaagman/repos,https://api.github.com/users/djfpaagman/events{/privacy},https://api.github.com/users/djfpaagman/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43755/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43755,https://github.com/rails/rails/pull/43755,https://github.com/rails/rails/pull/43755.diff,https://github.com/rails/rails/pull/43755.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
252,https://api.github.com/repos/rails/rails/issues/43754,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43754/labels{/name},https://api.github.com/repos/rails/rails/issues/43754/comments,https://api.github.com/repos/rails/rails/issues/43754/events,https://github.com/rails/rails/pull/43754,1067148878,PR_kwDNIULOLy8Y_A,43754,add `--js` alias to `--javascript` and `--skip-js` alias to `--skip-javscript`,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-30T11:57:43Z,2022-03-01T07:40:42Z,,CONTRIBUTOR,,"### Summary

I was creating a new app and did `rails new --js esbuild` thinking it would work, but it didn't and was surprised, so here I add the `--js` alias so that `rails new --javascript ...` has two aliases: `-j` and `--js`

### Other Information

I'm not too familiar with thor so not sure 100% especially about the change in `lib/rails/generators.rb`, not sure if it has any effect at all, doesn't seem to break tests though

Because it's using thor, the `rails new --help` is updated automatically:

```
  -j, --js, [--javascript=JAVASCRIPT]                            # Choose JavaScript approach [options: importmap (default), webpack, esbuild, rollup]
```

In https://github.com/rails/rails/pull/43563 @eileencodes suggested I do this instead of renaming `--javascript` to `--js`

**Edit**: Also did the same for `--skip-js` / `--skip-javascript`",https://api.github.com/repos/rails/rails/issues/43754/timeline,,dorianmariefr,58794487,MDQ6VXNlcjU4Nzk0NDg3,https://avatars.githubusercontent.com/u/58794487?v=4,,https://api.github.com/users/dorianmariefr,https://github.com/dorianmariefr,https://api.github.com/users/dorianmariefr/followers,https://api.github.com/users/dorianmariefr/following{/other_user},https://api.github.com/users/dorianmariefr/gists{/gist_id},https://api.github.com/users/dorianmariefr/starred{/owner}{/repo},https://api.github.com/users/dorianmariefr/subscriptions,https://api.github.com/users/dorianmariefr/orgs,https://api.github.com/users/dorianmariefr/repos,https://api.github.com/users/dorianmariefr/events{/privacy},https://api.github.com/users/dorianmariefr/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43754/reactions,3,3,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43754,https://github.com/rails/rails/pull/43754,https://github.com/rails/rails/pull/43754.diff,https://github.com/rails/rails/pull/43754.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
253,https://api.github.com/repos/rails/rails/issues/43739,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43739/labels{/name},https://api.github.com/repos/rails/rails/issues/43739/comments,https://api.github.com/repos/rails/rails/issues/43739/events,https://github.com/rails/rails/pull/43739,1065292559,PR_kwDNIULOLxeCIQ,43739,Add custom_error to ActiveModel::Error and ActiveModel::Errors,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}]",open,False,,[],,6,2021-11-28T10:18:24Z,2022-04-16T23:10:28Z,,NONE,,"Table of contents (I couldn't make these links work 😂  heeeeelp!)

- [Summary](#summary)
- [Context](#context)
  - [Listing errors at the top of a long form](#listing-errors-at-the-top-of-a-long-form)
  - [Error per input field](#error-per-input-field)
    - [Current behaviour](#current-behaviour)
- [Implemented behaviour: custom_message](#implemented-behaviour-custom-message)
  - [Usage](#usage)
- [Notes on implementation](#notes-on-implementation)
- [Future work](#future-work)

# Summary

> Note: This PR is a new take on https://github.com/rails/rails/pull/43283 by @ollieh-m based on the comments provided by me and @rafaelfranca. Note that the description of this PR is similar but not the same as the comment I made on that PR so please read again if you already read the other one :) 

# Context

This PR adds the `custom_message` functionality to `ActiveModel::Error` and helper methods in `ActiveModel::Errors` in an effort to make feedback in form fields nicer.

## Listing errors at the top of a long form
When creating a form, specially a long one, it's usually a good idea for all errors to be at the top of the form. This makes it specially important for users of your app that use assistive technologies (more on that [here](https://www.w3.org/WAI/tutorials/forms/notifications/#listing-errors))

Each item in this list describes a) the attribute that has an error and b) the error on that attribute. Each list item can potentially have a link with an anchor to the element that needs to be corrected

![image](https://user-images.githubusercontent.com/10928518/136735039-9dbdfd95-ea5c-4557-a1ad-99639cafd041.png)

This message is currently constructed using the `full_message` method which concatenates the name of the attribute with the error message.

## Error per input field

### Current behaviour

As UX on the web has evolved, it's become commonplace to have the error message alongside the input field. This makes it a little bit redundant to have the name of the attribute be repeated. The following example showcases what an input field would look like using the `full_messages_for(:attribute)` method.

![image](https://user-images.githubusercontent.com/10928518/136736534-66a783bd-7e8c-4ce9-9aa7-71f928a1a3b5.png)

# Implemented behaviour: `custom_message`

I've added a `custom_message` method to create an alternative message in forms like these that don't need the attribute's name or might not follow the format attribute + message. In working in this PR I discovered a feature in `full_messages` that allows its format to be modified from `#{name} #{message}` to something else and also a PR https://github.com/rails/rails/pull/42708 that allows this configuration to be made per validation. 

However, neither of these accomplish the purpose of this feature to have 2 distinct ways to describe error messages: one conventionally formatted with `full_message` and one friendlier with `custom_message`.

![image](https://user-images.githubusercontent.com/10928518/136736580-4a1fb080-f3e1-42d1-be6b-61d1571cb8d2.png)

## Usage

```erb
<%= form_with(model: @person) do |form|%>
<!-- for accessibility -->
<ul>
<% form.object.errors.full_messages.each do |message| %>
  <li><%= message %></li>
</ul>
<%= form.email_field :email %>
<p class=""error""><%= form.object.errors.custom_message_for(:email) %></p>
<% end %>
```

# Notes on the implementation
1. I based the implementation and tests for the `ActiveModel::Error` class on the `message` and `generate_message` already present. 
2. I decided to go with a new structure for the YAML translation file where the type of error (e.g. `blank`) is not a single key with a string value but a key with child keys: `blank: { message: ""can't be blank"", custom_message: ""Whoops! it's blank!"" } `. This required for the lookup chain for `message` to support the previous, simpler nesting: `blank: ""can't be blank""`. I've commented this in the lookup chain docs in `Errors` in case we wish to deprecate this in the future.
3. I enhanced the `as_json` and `to_hash` methods to support a more explicit type of argument: `message_method`. This allows callers to ask for the type of message they want, either `message`, `custom_message` and `full_message`. I've added deprecation warnings for users to upgrade to using explicit keyword arguments for as_json

# Future work
1. The `Error` class and specially its tests are quite long. I'm personally not used to this and thought it could be good to split the rendering of `message` and `custom_message` into different classes like `MessageRenderer` and `CustomMessageRenderer` or something similar. 
2. I wonder it's necessary to deprecate the previous lookup chain values
3. @rafaelfranca made an interesting comment on `full_message` not being the right name for what it does and I agree. `formatted_message` as he suggested describes its behaviour and intention much better. I wonder if we should take this opportunity to rename it and create a deprecation warning for `full_message`

### Other Information
TODO: 
If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43739/timeline,,pinzonjulian,10928518,MDQ6VXNlcjEwOTI4NTE4,https://avatars.githubusercontent.com/u/10928518?v=4,,https://api.github.com/users/pinzonjulian,https://github.com/pinzonjulian,https://api.github.com/users/pinzonjulian/followers,https://api.github.com/users/pinzonjulian/following{/other_user},https://api.github.com/users/pinzonjulian/gists{/gist_id},https://api.github.com/users/pinzonjulian/starred{/owner}{/repo},https://api.github.com/users/pinzonjulian/subscriptions,https://api.github.com/users/pinzonjulian/orgs,https://api.github.com/users/pinzonjulian/repos,https://api.github.com/users/pinzonjulian/events{/privacy},https://api.github.com/users/pinzonjulian/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43739/reactions,9,9,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43739,https://github.com/rails/rails/pull/43739,https://github.com/rails/rails/pull/43739.diff,https://github.com/rails/rails/pull/43739.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
254,https://api.github.com/repos/rails/rails/issues/43736,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43736/labels{/name},https://api.github.com/repos/rails/rails/issues/43736/comments,https://api.github.com/repos/rails/rails/issues/43736/events,https://github.com/rails/rails/pull/43736,1064959993,PR_kwDNIULOLxUXmg,43736,Introduce `**options` argument in the `DestroyAssociationAsyncJob#perform` method,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2021-11-27T10:36:46Z,2022-02-27T11:54:41Z,,NONE,,"It allows extending the job with additional options without breaking people's
applications.

See https://github.com/rails/rails/pull/42452/files#r678742445.

[#42430]

/cc @rafaelfranca ",https://api.github.com/repos/rails/rails/issues/43736/timeline,,smt116,619324,MDQ6VXNlcjYxOTMyNA==,https://avatars.githubusercontent.com/u/619324?v=4,,https://api.github.com/users/smt116,https://github.com/smt116,https://api.github.com/users/smt116/followers,https://api.github.com/users/smt116/following{/other_user},https://api.github.com/users/smt116/gists{/gist_id},https://api.github.com/users/smt116/starred{/owner}{/repo},https://api.github.com/users/smt116/subscriptions,https://api.github.com/users/smt116/orgs,https://api.github.com/users/smt116/repos,https://api.github.com/users/smt116/events{/privacy},https://api.github.com/users/smt116/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43736/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43736,https://github.com/rails/rails/pull/43736,https://github.com/rails/rails/pull/43736.diff,https://github.com/rails/rails/pull/43736.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
255,https://api.github.com/repos/rails/rails/issues/43728,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43728/labels{/name},https://api.github.com/repos/rails/rails/issues/43728/comments,https://api.github.com/repos/rails/rails/issues/43728/events,https://github.com/rails/rails/issues/43728,1064004220,I_kwDNIULOP2tqfA,43728,Extra stuff after charset in Content-Type disappears,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2021-11-26T00:52:59Z,2021-11-26T21:46:51Z,,CONTRIBUTOR,,"In my Rails 6 app, I tried to return CSV data with header as a response like this:

```ruby
class MyController < ApplicationController
  def show
    send_data(
      csv_with_header,
      type: ""text/csv; charset=utf-16; header=present""
    )
  end
end
```

but `header=present` has disappeared from its Content-Type.

This is because `#content_type=` seems to remove the extra stuff after `charset=...`.

e.g.:

```ruby
response = ActionDispatch::Response.new
response.content_type = ""text/csv; charset=utf-16; header=present""
response.headers[""Content-Type""] #=> ""text/csv; charset=utf-16""
```

As a workaround, I need to change the above code like this:

```diff
@@ -2,7 +2,7 @@
   def show
     send_data(
       csv_with_header,
-      type: ""text/csv; charset=utf-16; header=present""
+      type: ""text/csv; header=present; charset=utf-16""
     )
   end
 end
```

At least in Rails (6.0?), we decided to treat extra stuff as part of mime_type at https://github.com/rails/rails/pull/37017. Isn't it strange that what comes before charset is preseved, but what comes after the charset is removed?

```ruby
response = ActionDispatch::Response.new
response.content_type = ""text/csv; a; b; charset=utf-16; c; d""
response.headers[""Content-Type""] #=> ""text/csv; a; b; charset=utf-16""
```

Other information about text/csv:

- <https://datatracker.ietf.org/doc/html/rfc4180#section-3>
    - about MIME Type Registration of text/csv

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""rails"", ""~> 6.1.0""
end

require ""rack/test""
require ""action_controller/railtie""

class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""example.org""
  config.session_store :cookie_store, key: ""cookie_store_key""
  secrets.secret_key_base = ""secret_key_base""

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    get ""/"" => ""test#index""
  end
end

class TestController < ActionController::Base
  include Rails.application.routes.url_helpers

  def index
    send_data(
      ""dummy"",
      type: ""text/csv; charset=utf-16; header=present""
    )
  end
end

require ""minitest/autorun""

class BugTest < Minitest::Test
  include Rack::Test::Methods

  def test_content_type_includes_extra_stuff
    get ""/""
    assert_includes(last_response.headers[""Content-Type""], 'header=present')
  end

  private
    def app
      Rails.application
    end
end
```

### Expected behavior

I expect the above test passes.

### Actual behavior

But it fails.

```
# Running:

I, [2021-11-26T09:22:15.126890 #13131]  INFO -- : Started GET ""/"" for 127.0.0.1 at 2021-11-26 09:22:15 +0900
F

Failure:
BugTest#test_content_type [test.rb:49]:
Expected ""text/csv; charset=utf-16"" to include ""header=present"".


rails test test.rb:47



Finished in 0.069187s, 14.4537 runs/s, 28.9073 assertions/s.
1 runs, 2 assertions, 1 failures, 0 errors, 0 skips
```

### System configuration
**Rails version**:

6.1.4.1

**Ruby version**:

```console
$ ruby -v
ruby 3.0.1p64 (2021-04-05 revision 0fb782ee38) [x86_64-linux]
```",https://api.github.com/repos/rails/rails/issues/43728/timeline,,r7kamura,111689,MDQ6VXNlcjExMTY4OQ==,https://avatars.githubusercontent.com/u/111689?v=4,,https://api.github.com/users/r7kamura,https://github.com/r7kamura,https://api.github.com/users/r7kamura/followers,https://api.github.com/users/r7kamura/following{/other_user},https://api.github.com/users/r7kamura/gists{/gist_id},https://api.github.com/users/r7kamura/starred{/owner}{/repo},https://api.github.com/users/r7kamura/subscriptions,https://api.github.com/users/r7kamura/orgs,https://api.github.com/users/r7kamura/repos,https://api.github.com/users/r7kamura/events{/privacy},https://api.github.com/users/r7kamura/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43728/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
256,https://api.github.com/repos/rails/rails/issues/43721,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43721/labels{/name},https://api.github.com/repos/rails/rails/issues/43721/comments,https://api.github.com/repos/rails/rails/issues/43721/events,https://github.com/rails/rails/issues/43721,1063350691,I_kwDNIULOP2Fxow,43721,after_rollback hooks not triggered on ActiveRecord::NotNullViolation/RecordNotUnique,[],open,False,,[],,6,2021-11-25T09:36:01Z,2022-02-28T09:31:07Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
Using:
```ruby
gem ""activerecord"", ""= 6.1.4.1""
```
An error in an `after_update` hook is properly triggering a rollback and the `after_rollback` hooks. But if the error happens while hitting the DB, say an `ActiveRecord::NotNullViolation` or `ActiveRecord::RecordNotUnique` the transaction is properly rolled back, but the `after_rollback` hooks are never called.

Is it the expected behavior ? If it is, why are the after_rollback hooks not triggered in these cases ? If it is not, here is a script that reproduces the issue:

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""= 6.1.4.1""
  gem ""sqlite3""
  gem ""byebug""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""
require ""byebug""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(
  adapter: ""sqlite3"",
  database: "":memory:""
)
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :books, force: true do |t|
    t.string :title, null: false
    t.string :isbn, null: false, index: { unique: true }
  end

  create_table :newspapers, force: true do |t|
    t.string :name, null: false
  end
end

##########################
# We will pretend to be logging
# in after rollback hooks
# This class is just helping keeping
# track of whether the hooks
# are called or not
class FakeLogger
  def self.clean_up
    @@logger = nil
  end

  def self.error(what_to_say)
    @@logger ||= FakeLogger.new
    @@logger.error what_to_say
  end

  def self.error_logs
    @@logger ||= FakeLogger.new
    @@logger.error_logs
  end

  def initialize
    @error_logs = []
  end

  def error(what_to_say)
    @error_logs << what_to_say
  end

  attr_reader :error_logs
end
############################

class Book < ActiveRecord::Base
  after_rollback :notify_rollback

  private

  def notify_rollback
    FakeLogger.error ""Book #{id} transaction has been rolled back""
  end
end

class Newspaper < ActiveRecord::Base
  class NewspaperRefusesToBeUpdated < RuntimeError; end

  after_update :break_update
  after_rollback :notify_rollback

  private

  def break_update
    raise NewspaperRefusesToBeUpdated, 'Not letting myself be updated'
  end

  def notify_rollback
    FakeLogger.error ""Newspaper #{id} transaction has been rolled back""
  end
end

class BugTest < Minitest::Test
  SOME_ISBN = '9780394607269'

  def setup
    super
    Book.destroy_all
    FakeLogger.clean_up
  end

  def test_after_rollback_is_called_on_after_update_error
    times = Newspaper.create! name: 'Times'

    assert_raises Newspaper::NewspaperRefusesToBeUpdated do
      times.update! name: 'The New York Times'
    end

    times.reload

    assert_equal(
      'Times',
      times.name
    )

    assert_equal(
      1,
      FakeLogger.error_logs.size
    )

    assert_equal(
      ""Newspaper #{times.id} transaction has been rolled back"",
      FakeLogger.error_logs.first
    )
  end

  def test_after_rollback_is_called_on_not_null_violation
    book = Book.create!(
      title: 'Das Kapital',
      isbn: SOME_ISBN
    )

    assert_raises ActiveRecord::NotNullViolation do
      book.update! title: nil
    end

    book.reload

    assert_equal(
      'Das Kapital',
      book.title
    )

    # Expected 1 but actually 0
    assert_equal(
      1,
      FakeLogger.error_logs.size
    )

    # Message we would expect to see in logs
    assert_equal(
      ""Book #{book.id} transaction has been rolled back"",
      FakeLogger.error_logs.first
    )
  end


  def test_after_rollback_is_called_on_not_unique_violation
    Book.create!(
      title: 'Das Kapital',
      isbn: SOME_ISBN
    )

    other_book = Book.create!(
      title: 'Das Kapital. Kritik der politischen Ökonomie',
      isbn: '123'
    )

    assert_raises ActiveRecord::RecordNotUnique do
      other_book.update! isbn: SOME_ISBN
    end

    other_book.reload

    assert_equal(
      '123',
      other_book.isbn
    )

    # Expected 1 but actually 0
    assert_equal(
      1,
      FakeLogger.error_logs.size
    )

    # Message we would expect to see in logs
    assert_equal(
      ""Book #{other_book.id} transaction has been rolled back"",
      FakeLogger.error_logs.first
    )
  end
end

```

### Expected behavior
I would expect after_rollback hooks to be called on `ActiveRecord::NotNullViolation` or `ActiveRecord::RecordNotUnique`, since the transactions are indeed being rolled back.

### Actual behavior
`after_rollback` hooks are not being called on `ActiveRecord::NotNullViolation` or `ActiveRecord::RecordNotUnique`.

### System configuration
**Rails version**: `6.1.4.1`

**Ruby version**: reproduced with `2.7.0` and `2.6.6`
",https://api.github.com/repos/rails/rails/issues/43721/timeline,,stripedpumpkin,23067102,MDQ6VXNlcjIzMDY3MTAy,https://avatars.githubusercontent.com/u/23067102?v=4,,https://api.github.com/users/stripedpumpkin,https://github.com/stripedpumpkin,https://api.github.com/users/stripedpumpkin/followers,https://api.github.com/users/stripedpumpkin/following{/other_user},https://api.github.com/users/stripedpumpkin/gists{/gist_id},https://api.github.com/users/stripedpumpkin/starred{/owner}{/repo},https://api.github.com/users/stripedpumpkin/subscriptions,https://api.github.com/users/stripedpumpkin/orgs,https://api.github.com/users/stripedpumpkin/repos,https://api.github.com/users/stripedpumpkin/events{/privacy},https://api.github.com/users/stripedpumpkin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43721/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
257,https://api.github.com/repos/rails/rails/issues/43706,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43706/labels{/name},https://api.github.com/repos/rails/rails/issues/43706/comments,https://api.github.com/repos/rails/rails/issues/43706/events,https://github.com/rails/rails/pull/43706,1061855573,PR_kwDNIULOLu-0_w,43706,Avoid renders in equality check of rich_text content,"[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,0,2021-11-24T00:42:37Z,2022-02-18T20:34:30Z,,CONTRIBUTOR,,"### Summary

Avoiding the use of `ActionText::Content#to_s`, which in turn uses `ActionText::Content#to_rendered_html_with_layout`, stops the duplicate rendering issue described in https://github.com/rails/rails/issues/43469.

### Other Information

This approach was suggested as a workaround in https://github.com/rails/rails/issues/37818 and testing it locally does seem to work as expected. Since I've seen at least two issues around this, I thought I'd propose this change.

I'd like to write some kind of test for this code, but I'm really not sure how I'd go about doing that! If anyone wants to point me in the right direction, that'd be great. 😄 

This change could introduce some weird behavior because we won't be including the layout in the equality check if it is merged. I'm not sure what sort of impact it would have on people using this code otherwise.

I'm thinking because `_content.html.erb` is somewhat trivial, it might not be that big of a deal:
https://github.com/rails/rails/blob/16c537e098b2eea86e32b2cdf7a1b54f6270517d/actiontext/app/views/layouts/action_text/contents/_content.html.erb#L1-L3",https://api.github.com/repos/rails/rails/issues/43706/timeline,,jacobherrington,11466782,MDQ6VXNlcjExNDY2Nzgy,https://avatars.githubusercontent.com/u/11466782?v=4,,https://api.github.com/users/jacobherrington,https://github.com/jacobherrington,https://api.github.com/users/jacobherrington/followers,https://api.github.com/users/jacobherrington/following{/other_user},https://api.github.com/users/jacobherrington/gists{/gist_id},https://api.github.com/users/jacobherrington/starred{/owner}{/repo},https://api.github.com/users/jacobherrington/subscriptions,https://api.github.com/users/jacobherrington/orgs,https://api.github.com/users/jacobherrington/repos,https://api.github.com/users/jacobherrington/events{/privacy},https://api.github.com/users/jacobherrington/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43706/reactions,3,3,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43706,https://github.com/rails/rails/pull/43706,https://github.com/rails/rails/pull/43706.diff,https://github.com/rails/rails/pull/43706.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
258,https://api.github.com/repos/rails/rails/issues/43690,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43690/labels{/name},https://api.github.com/repos/rails/rails/issues/43690/comments,https://api.github.com/repos/rails/rails/issues/43690/events,https://github.com/rails/rails/pull/43690,1060383591,PR_kwDNIULOLt0hnQ,43690,Add `ActionController::Parameters#require_slice`,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-22T16:53:54Z,2022-02-28T18:36:03Z,,MEMBER,,"This method behaves like `slice`, but raises `ParameterMissing` if any of the specified keys are missing.  Additionally, the specified params are marked as permitted, but any nested params are not.  e.g. `params.require_slice(:foo, :bar).require(:foo)` is the same as `params.require(:foo)`, regardless of what the `:foo` param is.

This method is useful for permitting and requiring multiple keys.  It is also useful for permitting top-level (unscoped) params without triggering the `action_on_unpermitted_parameters` action due to incidental params like `authenticity_token` and `commit`.  For example, ""change password"" params implemented like:

```ruby
def password_params
  params.require(:password).permit(
    :password_challenge,
    :password,
    :password_confirmation,
  ).with_defaults(password_challenge: """")
end
```

Could instead be implemented like:

```ruby
def password_params
  params.require_slice(
    :password_challenge,
    :password,
    :password_confirmation,
  )
end
```

---

Tangential: #43688, #43689",https://api.github.com/repos/rails/rails/issues/43690/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43690/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43690,https://github.com/rails/rails/pull/43690,https://github.com/rails/rails/pull/43690.diff,https://github.com/rails/rails/pull/43690.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
259,https://api.github.com/repos/rails/rails/issues/43689,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43689/labels{/name},https://api.github.com/repos/rails/rails/issues/43689/comments,https://api.github.com/repos/rails/rails/issues/43689/events,https://github.com/rails/rails/pull/43689,1060366755,PR_kwDNIULOLtzq-g,43689,Add `:errors` option to `form_with`,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2021-11-22T16:36:36Z,2022-02-28T18:44:52Z,,MEMBER,,"This option allows developers to specify an errors object for a form independently of specifying a model.  This allows forms which aren't backed by a model to utilize `config.action_view.field_error_proc`.

This is also useful for forms that should not be pre-populated, but that should still display validation errors.  For example, a ""change password"" form like:

```erb
<%= form_with(url: change_password_path, scope: :password, model: current_user) do |form| %>
  <%= form.label :password_challenge, ""Current password"" %>
  <%= form.password_field :password_challenge, value: """" %>

  <%= form.label :password, ""New password"" %>
  <%= form.password_field :password, value: """" %>

  <%= form.label :password_confirmation, ""Confirm new password"" %>
  <%= form.password_field :password_confirmation, value: """" %>

  <%= form.submit ""Change password"" %>
<% end %>
```

Could be written as:

```erb
<%= form_with(url: change_password_path, scope: :password, errors: current_user.errors) do |form| %>
  <%= form.label :password_challenge, ""Current password"" %>
  <%= form.password_field :password_challenge %>

  <%= form.label :password, ""New password"" %>
  <%= form.password_field :password %>

  <%= form.label :password_confirmation, ""Confirm new password"" %>
  <%= form.password_field :password_confirmation %>

  <%= form.submit ""Change password"" %>
<% end %>
```

---

Tangential: #43688, #43690",https://api.github.com/repos/rails/rails/issues/43689/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43689/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43689,https://github.com/rails/rails/pull/43689,https://github.com/rails/rails/pull/43689.diff,https://github.com/rails/rails/pull/43689.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
260,https://api.github.com/repos/rails/rails/issues/43676,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43676/labels{/name},https://api.github.com/repos/rails/rails/issues/43676/comments,https://api.github.com/repos/rails/rails/issues/43676/events,https://github.com/rails/rails/issues/43676,1059019949,I_kwDNIULOPx9crQ,43676,ActiveRecord not validating relationship on update if :inverse_of is specified and relationship is accessed before update,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-20T00:55:57Z,2021-11-29T16:04:20Z,,NONE,,"### Steps to reproduce
1. Create a new empty Rails application with all the default settings and the following sample structure with an Item and its associated Category, not optional, enforcing validation.

Running this on the bug reporting template script with in-memory SQLite does **not** reveal the bug, for whichever reason.

`models/category.rb`
```
class Category < ApplicationRecord
        has_many :items, inverse_of: :category
end
```

`models/item.rb`

```
class Item < ApplicationRecord
  belongs_to :category, validate: true, optional: false, inverse_of: :items
end
```

2. Open the Rails console with `bin/rails c`
3. Create a new Category and a new Item attached to that Category. Make ActiveRecord read that item back (`test_item = Item.find( item.id )`, and **make it read the association** (`test_item.category`). Then update `test_item` and set its `category_id` to an invalid value. 
```
category = Category.create!
item = Item.create!( category: category )

test_item = Item.find( item.id )

test_item.category

test_item.update( category: 99999)
```
### Expected behavior
The record's validation would fail and the call to `update` would return `false`, or throw an exception.
### Actual behavior
The validation will let the bad association through to the database layer, where it will update the item and set `category_id` to the invalid value, breaking the association. If there's a foreign key enforced at the database level, the call to `update` will bomb with an exception.

**Important:** if you **don't** make ActiveRecord the association back (`test_item.category`) or don't ask it to fetch `test_item` from the database in the first place, the bug won't be triggered.
```
2.7.2 :001 > category = Category.create!
   (0.4ms)  SELECT sqlite_version(*)
  TRANSACTION (0.0ms)  begin transaction
  Category Create (1.0ms)  INSERT INTO ""categories"" (""created_at"", ""updated_at"") VALUES (?, ?)  [[""created_at"", ""2021-11-20 00:29:14.201493""], [""updated_at"", ""2021-11-20 00:29:14.201493""]]
  TRANSACTION (3.8ms)  commit transaction
 => #<Category id: 4, name: nil, created_at: ""2021-11-20 00:29:14.201493000 +0000"", updated_at: ""2021-11-20 00:29:14.201493000 +0000"">

2.7.2 :002 > item = Item.create!( category: category )
  TRANSACTION (0.0ms)  begin transaction
  Item Create (0.7ms)  INSERT INTO ""items"" (""created_at"", ""updated_at"", ""category_id"") VALUES (?, ?, ?)  [[""created_at"", ""2021-11-20 00:29:18.292957""], [""updated_at"", ""2021-11-20 00:29:18.292957""], [""category_id"", 4]]
  TRANSACTION (2.9ms)  commit transaction
 => #<Item id: 4, name: nil, created_at: ""2021-11-20 00:29:18.292957000 +0000"", updated_at: ""2021-11-20 00:29:18.292957000 +0000"", category_id: 4>

2.7.2 :003 > test = Item.find( item.id )
  Item Load (0.1ms)  SELECT ""items"".* FROM ""items"" WHERE ""items"".""id"" = ? LIMIT ?  [[""id"", 4], [""LIMIT"", 1]]
 => #<Item id: 4, name: nil, created_at: ""2021-11-20 00:29:18.292957000 +0000"", updated_at: ""2021-11-20 00:29:18.292957000 +0000"", category_id: 4>

2.7.2 :004 > test.category
  Category Load (0.1ms)  SELECT ""categories"".* FROM ""categories"" WHERE ""categories"".""id"" = ? LIMIT ?  [[""id"", 4], [""LIMIT"", 1]]
 => #<Category id: 4, name: nil, created_at: ""2021-11-20 00:29:14.201493000 +0000"", updated_at: ""2021-11-20 00:29:14.201493000 +0000"">

2.7.2 :005 > test.update( category_id: 99999 )
  TRANSACTION (0.1ms)  begin transaction
  Item Update (0.9ms)  UPDATE ""items"" SET ""updated_at"" = ?, ""category_id"" = ? WHERE ""items"".""id"" = ?  [[""updated_at"", ""2021-11-20 00:29:41.342328""], [""category_id"", 99999], [""id"", 4]]
  TRANSACTION (3.1ms)  commit transaction
 => true
```
### System configuration
**Rails version**: Rails 6.1.4.1
**Ruby version**: ruby 2.7.2p137
",https://api.github.com/repos/rails/rails/issues/43676/timeline,,morphine00,14062988,MDQ6VXNlcjE0MDYyOTg4,https://avatars.githubusercontent.com/u/14062988?v=4,,https://api.github.com/users/morphine00,https://github.com/morphine00,https://api.github.com/users/morphine00/followers,https://api.github.com/users/morphine00/following{/other_user},https://api.github.com/users/morphine00/gists{/gist_id},https://api.github.com/users/morphine00/starred{/owner}{/repo},https://api.github.com/users/morphine00/subscriptions,https://api.github.com/users/morphine00/orgs,https://api.github.com/users/morphine00/repos,https://api.github.com/users/morphine00/events{/privacy},https://api.github.com/users/morphine00/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43676/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
261,https://api.github.com/repos/rails/rails/issues/43672,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43672/labels{/name},https://api.github.com/repos/rails/rails/issues/43672/comments,https://api.github.com/repos/rails/rails/issues/43672/events,https://github.com/rails/rails/pull/43672,1058333654,PR_kwDNIULOLsMOxQ,43672,Add year and day translation support for date_select,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-19T09:42:43Z,2022-03-04T07:37:26Z,,CONTRIBUTOR,,"### Summary
I added `:day_format` option to `date_select` in https://github.com/rails/rails/pull/43567

But in most cases, the same `:year_format` and `:day_format` options for each locale are used in a whole application.
It would be great if there were global year_format and day_format options for each locale.
So I added year_format and day_format to i18n.

Although lambdas in i18n may look a little strange, rails already has lambdas in i18n.
https://github.com/rails/rails/blob/main/activesupport/lib/active_support/locale/en.rb

### An example
 ```ruby
 # config/locales/en.rb
 {
   en: {
     date: {
       year_format: lambda { |_key, options| ""Heisei #{options[:number] - 1988}"" },
       day_format: lambda { |_key, options| ActiveSupport::Inflector.ordinalize(options[:number]) }
     }
   }
 }
 ```
 
 ```ruby
 date_select(""article"", ""written_on"")
 # generates year options like <option value=""2003"">Heisei 15</option>\n<option value=""2004"">Heisei 16</option>...
 # and day options like <option value=""1"">1st</option>\n<option value=""2"">2nd</option>...
 ```
",https://api.github.com/repos/rails/rails/issues/43672/timeline,,shunichi,1687073,MDQ6VXNlcjE2ODcwNzM=,https://avatars.githubusercontent.com/u/1687073?v=4,,https://api.github.com/users/shunichi,https://github.com/shunichi,https://api.github.com/users/shunichi/followers,https://api.github.com/users/shunichi/following{/other_user},https://api.github.com/users/shunichi/gists{/gist_id},https://api.github.com/users/shunichi/starred{/owner}{/repo},https://api.github.com/users/shunichi/subscriptions,https://api.github.com/users/shunichi/orgs,https://api.github.com/users/shunichi/repos,https://api.github.com/users/shunichi/events{/privacy},https://api.github.com/users/shunichi/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43672/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43672,https://github.com/rails/rails/pull/43672,https://github.com/rails/rails/pull/43672.diff,https://github.com/rails/rails/pull/43672.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
262,https://api.github.com/repos/rails/rails/issues/43664,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43664/labels{/name},https://api.github.com/repos/rails/rails/issues/43664/comments,https://api.github.com/repos/rails/rails/issues/43664/events,https://github.com/rails/rails/issues/43664,1056183181,I_kwDNIULOPvQTjQ,43664,ActiveRecord Encryption unable to save with default JSONb column in PostgreSql,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,5,2021-11-17T14:15:33Z,2022-03-09T19:19:55Z,,NONE,,"### Steps to reproduce
I wasn't able to get a working test file, so I made [a small Rails app showcasing the underlying issue](https://github.com/codenamev/testy).

```bash
gh clone codenamev/testy
cd testy
bin/rails db:setup
bin/rails db:migrate
bin/rails test test/models/author_test.rb
```

### Expected behavior
I would expect a model with an encrypted JSONb PostgreSQL column that has a default value to save without providing a value.

### Actual behavior
Upon saving the above mentioned JSONb column with a default, a `ActiveRecord::Encryption::Errors::Decryption` error is raised.

### System configuration
**Rails version**: `7.0.0.alpha2`

**Ruby version**: `ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-darwin20]`
",https://api.github.com/repos/rails/rails/issues/43664/timeline,,codenamev,109135,MDQ6VXNlcjEwOTEzNQ==,https://avatars.githubusercontent.com/u/109135?v=4,,https://api.github.com/users/codenamev,https://github.com/codenamev,https://api.github.com/users/codenamev/followers,https://api.github.com/users/codenamev/following{/other_user},https://api.github.com/users/codenamev/gists{/gist_id},https://api.github.com/users/codenamev/starred{/owner}{/repo},https://api.github.com/users/codenamev/subscriptions,https://api.github.com/users/codenamev/orgs,https://api.github.com/users/codenamev/repos,https://api.github.com/users/codenamev/events{/privacy},https://api.github.com/users/codenamev/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43664/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
263,https://api.github.com/repos/rails/rails/issues/43657,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43657/labels{/name},https://api.github.com/repos/rails/rails/issues/43657/comments,https://api.github.com/repos/rails/rails/issues/43657/events,https://github.com/rails/rails/issues/43657,1055059912,I_kwDNIULOPuLvyA,43657,Preloading has_one through fails to load the associated record,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-16T16:09:42Z,2022-02-19T20:27:52Z,,NONE,,"Found an error when preloading a has_one through association. A quick search revealed that ActiveRecord was patched a long time ago in #14046, where the generated SQL was invalid.

The error seems to originate from this preload SQL:

```
D, [2021-11-16T10:47:30.184608 #93831] DEBUG -- :   BranchRoute Load (0.1ms)  SELECT ""routes"".* FROM ""routes"" WHERE ""routes"".""type"" = ? AND ""routes"".""id"" = ?  [[""type"", ""CustomerRoute""], [""id"", 2]]
```

ID 2 is the branch route, while the SQL query searches for customer routes.

Our current fix is to accept an N+1, by reloading offers, but this bug obviously has a performance impact.

### Steps to reproduce
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""
  gem ""rails"", github: ""rails/rails"" # ""= 6.1.4.1""
  gem ""sqlite3""
end

require ""active_record""
require ""logger""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :routes, force: true do |t|
    t.integer :customer_route_id
    t.string :type
  end

  create_table :products, force: true do |t|
    t.integer :branch_route_id
    t.string :type
  end
end

class Route < ActiveRecord::Base; end

class BranchRoute < Route
  belongs_to :customer_route
end

class CustomerRoute < Route; end

class Product < ActiveRecord::Base; end

class Offer < Product
  belongs_to :branch_route
  has_one :customer_route, through: :branch_route
end

cr = CustomerRoute.create!
br = BranchRoute.create!(customer_route: cr)
offer = Offer.create!(branch_route: br)

if Offer.includes(:customer_route).find(offer.id).customer_route.nil?
  warn ""FAILED""
else
  puts ""OK!""
end
```

### Expected behavior
has_one through should preload records, where they exist.

### Actual behavior
```
D, [2021-11-16T10:47:30.133376 #93831] DEBUG -- :    (0.0ms)  DROP TABLE IF EXISTS ""routes""
D, [2021-11-16T10:47:30.133685 #93831] DEBUG -- :    (0.2ms)  CREATE TABLE ""routes"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""customer_route_id"" integer, ""type"" varchar)
   -> 0.0052s
-- create_table(:offers, {:force=>true})
D, [2021-11-16T10:47:30.133862 #93831] DEBUG -- :    (0.0ms)  DROP TABLE IF EXISTS ""offers""
D, [2021-11-16T10:47:30.134048 #93831] DEBUG -- :    (0.1ms)  CREATE TABLE ""offers"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""branch_route_id"" integer, ""type"" varchar)
   -> 0.0003s
D, [2021-11-16T10:47:30.156291 #93831] DEBUG -- :    (0.1ms)  CREATE TABLE ""ar_internal_metadata"" (""key"" varchar NOT NULL PRIMARY KEY, ""value"" varchar, ""created_at"" datetime(6) NOT NULL, ""updated_at"" datetime(6) NOT NULL)
D, [2021-11-16T10:47:30.163374 #93831] DEBUG -- :   ActiveRecord::InternalMetadata Load (0.9ms)  SELECT ""ar_internal_metadata"".* FROM ""ar_internal_metadata"" WHERE ""ar_internal_metadata"".""key"" = ? LIMIT ?  [[""key"", ""environment""], [""LIMIT"", 1]]
D, [2021-11-16T10:47:30.166758 #93831] DEBUG -- :   ActiveRecord::InternalMetadata Create (0.1ms)  INSERT INTO ""ar_internal_metadata"" (""key"", ""value"", ""created_at"", ""updated_at"") VALUES (?, ?, ?, ?)  [[""key"", ""environment""], [""value"", ""development""], [""created_at"", ""2021-11-16 15:47:30.166360""], [""updated_at"", ""2021-11-16 15:47:30.166360""]]
D, [2021-11-16T10:47:30.172323 #93831] DEBUG -- :   CustomerRoute Create (0.0ms)  INSERT INTO ""routes"" (""type"") VALUES (?)  [[""type"", ""CustomerRoute""]]
D, [2021-11-16T10:47:30.175582 #93831] DEBUG -- :   BranchRoute Create (0.0ms)  INSERT INTO ""routes"" (""customer_route_id"", ""type"") VALUES (?, ?)  [[""customer_route_id"", 1], [""type"", ""BranchRoute""]]
D, [2021-11-16T10:47:30.177439 #93831] DEBUG -- :   Offer Create (0.0ms)  INSERT INTO ""offers"" (""branch_route_id"") VALUES (?)  [[""branch_route_id"", 2]]
D, [2021-11-16T10:47:30.177964 #93831] DEBUG -- :   Offer Load (0.0ms)  SELECT ""offers"".* FROM ""offers"" ORDER BY ""offers"".""id"" ASC LIMIT ?  [[""LIMIT"", 1]]
D, [2021-11-16T10:47:30.184608 #93831] DEBUG -- :   BranchRoute Load (0.1ms)  SELECT ""routes"".* FROM ""routes"" WHERE ""routes"".""type"" = ? AND ""routes"".""id"" = ?  [[""type"", ""CustomerRoute""], [""id"", 2]]
FAILED
```

NOTE: Removed begin/commit statements to improve readability.

### System configuration
**Rails version**: 6.1.4.1, 7.0 alpha 2 dea5603dffc19db6fbf94d506f087549c014efec

**Ruby version**: ruby 2.7.3p183 (2021-04-05 revision 6847ee089d) [x86_64-darwin20]

What else can I provide to help diagnose the issue? Thanks all for your work!",https://api.github.com/repos/rails/rails/issues/43657/timeline,,francois,247,MDQ6VXNlcjI0Nw==,https://avatars.githubusercontent.com/u/247?v=4,,https://api.github.com/users/francois,https://github.com/francois,https://api.github.com/users/francois/followers,https://api.github.com/users/francois/following{/other_user},https://api.github.com/users/francois/gists{/gist_id},https://api.github.com/users/francois/starred{/owner}{/repo},https://api.github.com/users/francois/subscriptions,https://api.github.com/users/francois/orgs,https://api.github.com/users/francois/repos,https://api.github.com/users/francois/events{/privacy},https://api.github.com/users/francois/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43657/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
264,https://api.github.com/repos/rails/rails/issues/43654,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43654/labels{/name},https://api.github.com/repos/rails/rails/issues/43654/comments,https://api.github.com/repos/rails/rails/issues/43654/events,https://github.com/rails/rails/issues/43654,1054624740,I_kwDNIULOPtxL5A,43654,Rails renders unexpected format with request MIME-Type `*/*`,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-16T09:06:08Z,2021-11-29T09:40:27Z,,CONTRIBUTOR,,"### Steps to reproduce

1. Check out [this repository](https://github.com/remofritzsche/rails_default_format)
2. Run `ruby rails.rb`
3. Run `wget http://localhost:3000`

### Expected behavior

The HTML template should be rendered and the response Mime-Type should be `text/html`:

```
Length: unspecified [text/html]
```
### Actual behavior

The PDF template is rendered and the Mime-Type is `application/pdf`:

```
Length: unspecified [application/pdf]
```

### System configuration
**Rails version**: 6.0.0

**Ruby version**: 3.0.2p107

### Summary

Tools like `wget` typically send the Header `Accept: */*`, accepting all response types (although it can be configured to send a specific one of course). However, in case of `*/*`, Rails just takes the first best template, regardless of the format / MIME type. In this example, the file `myview.pdf.erb` takes precedence over `myview.html.erb`, simply because it comes first.

A possible solution would be adding a new config option, such as `config.default_mime_type` or `config.default_request_format`. This would circumvent arbitrarily choosing templates.",https://api.github.com/repos/rails/rails/issues/43654/timeline,,sudoremo,109765,MDQ6VXNlcjEwOTc2NQ==,https://avatars.githubusercontent.com/u/109765?v=4,,https://api.github.com/users/sudoremo,https://github.com/sudoremo,https://api.github.com/users/sudoremo/followers,https://api.github.com/users/sudoremo/following{/other_user},https://api.github.com/users/sudoremo/gists{/gist_id},https://api.github.com/users/sudoremo/starred{/owner}{/repo},https://api.github.com/users/sudoremo/subscriptions,https://api.github.com/users/sudoremo/orgs,https://api.github.com/users/sudoremo/repos,https://api.github.com/users/sudoremo/events{/privacy},https://api.github.com/users/sudoremo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43654/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
265,https://api.github.com/repos/rails/rails/issues/43653,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43653/labels{/name},https://api.github.com/repos/rails/rails/issues/43653/comments,https://api.github.com/repos/rails/rails/issues/43653/events,https://github.com/rails/rails/issues/43653,1054499297,I_kwDNIULOPtph4Q,43653,An incorrect query is generated for has_many associations through has_many associations with nonstandard table names and foreign keys,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,0,2021-11-16T06:31:49Z,2021-11-21T21:11:08Z,,NONE,,"I'd be happy to learn that I'm just doing something incorrectly here. If I'm not, then I'd enjoy trying to work on a fix and would appreciate some pointers on where to start.

I ran into this when trying to write ActiveRecord models for [the MusicBrainz database](https://musicbrainz.org/doc/MusicBrainz_Database/Schema#Schema), which uses table names and foreign keys that are nonstandard for ActiveRecord.

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)


ActiveRecord::Schema.define do
  create_table :songs, force: true do |t|
    t.integer :album
  end

  create_table :album, force: true do |t|
    t.integer :artist_id
  end

  create_table :artists, force: true do |t|
  end
end


class Song < ActiveRecord::Base
end

class Album < ActiveRecord::Base
  has_many :songs, foreign_key: :album
  self.table_name = ""album""
end

class Artist < ActiveRecord::Base
  has_many :albums
  has_many :songs, through: :albums
end


class BugTest < Minitest::Test
  def test_has_many_association_through_a_has_many_association_with_a_nonstandard_table_name_and_nonstandard_foreign_key
    artist = Artist.create!
    artist.albums << Album.create!
    artist.albums.first.songs << Song.create!

    # passes
    assert_equal 1, artist.albums.count
    assert_equal 1, artist.albums.first.songs.count

    # fails
    assert_equal 1, artist.songs.count
  end
end
```
This behaves as expected and does not fail if either a standard table name is used or a standard foreign key is used for albums, or both.

### Expected behavior
<!-- Tell us what should happen -->
I would expect a query like the following to be run:
```
SELECT COUNT(*) FROM ""songs"" INNER JOIN ""album"" ON ""songs"".""album"" = ""album"".""id"" WHERE ""album"".""artist_id"" = ?  [[""artist_id"", 1]]
```

### Actual behavior
<!-- Tell us what happens instead -->
Instead, this is being run:
```
SELECT COUNT(*) FROM ""songs"" INNER JOIN ""album"" ON ""songs"".""album"" = ""album"".""id"" WHERE ""songs"".""album"" = ?  [[""album"", nil]]
```

### System configuration
**Rails version**: 7.0.0.alpha2 (also tested with 6.1.4.1)

**Ruby version**: ruby 2.7.4p191 (2021-07-07 revision a21a3b7d23) [arm64-darwin20]
",https://api.github.com/repos/rails/rails/issues/43653/timeline,,jamesbvaughan,2906913,MDQ6VXNlcjI5MDY5MTM=,https://avatars.githubusercontent.com/u/2906913?v=4,,https://api.github.com/users/jamesbvaughan,https://github.com/jamesbvaughan,https://api.github.com/users/jamesbvaughan/followers,https://api.github.com/users/jamesbvaughan/following{/other_user},https://api.github.com/users/jamesbvaughan/gists{/gist_id},https://api.github.com/users/jamesbvaughan/starred{/owner}{/repo},https://api.github.com/users/jamesbvaughan/subscriptions,https://api.github.com/users/jamesbvaughan/orgs,https://api.github.com/users/jamesbvaughan/repos,https://api.github.com/users/jamesbvaughan/events{/privacy},https://api.github.com/users/jamesbvaughan/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43653/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
266,https://api.github.com/repos/rails/rails/issues/43647,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43647/labels{/name},https://api.github.com/repos/rails/rails/issues/43647/comments,https://api.github.com/repos/rails/rails/issues/43647/events,https://github.com/rails/rails/issues/43647,1053868517,I_kwDNIULOPtDB5Q,43647,Association target with duplicate records,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,0,2021-11-15T16:35:58Z,2021-11-21T21:10:28Z,,MEMBER,,"### Steps to reproduce

This is an edge case where loading an association in an after commit hook when the tables involved span multiple databases can result in the association having duplicate records.

This doesn't seem super common, and I don't have any immediate plans to fix it, but I wanted to document it anyway. We worked around it in our application by adding `inverse_of: false` to one association.

It has to do with when the after commit hook runs vs. when a [new record gets added to the association target](https://github.com/rails/rails/blob/ced387ee58e9fd980217dd1f472f2c5afa241e9a/activerecord/lib/active_record/associations/collection_association.rb#L467-L470). Having multiple databases can change the order in which those happen, since each database will commit its own transaction separately.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main"" 
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

db1 = Tempfile.new(['db1', '.db'])
db2 = Tempfile.new(['db2', '.db'])
ActiveRecord::Base.configurations = { issues: { adapter: ""sqlite3"", database: db2 } }
ActiveRecord::Base.legacy_connection_handling = false
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: db1)
ActiveRecord::Base.establish_connection(:issues)
ActiveRecord::Base.logger = Logger.new(STDOUT)

class IssuesBase < ActiveRecord::Base
  self.abstract_class = true

  # The test passes if we comment this out so everything is in one database
  connects_to database: { writing: :issues, reading: :issues }
end

ActiveRecord::Base.connection.execute('CREATE TABLE ""assignees"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL)')
IssuesBase.connection.execute('CREATE TABLE ""issues"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL)')
IssuesBase.connection.execute(<<~SQL)
  CREATE TABLE ""assignments"" (
    ""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL,
    ""issue_id"" integer,
    ""assignee_id"" integer
  )
SQL

class Issue < IssuesBase
  # The test also passes if we set `inverse_of: false` here since we'll end up with a new issue object and load the assignees on that instead
  has_many :assignments
  has_many :assignees, through: :assignments, disable_joins: true
end

class Assignment < IssuesBase
  belongs_to :issue
  belongs_to :assignee

  after_commit :load_issue_assignees

  def load_issue_assignees
    issue.assignees.to_a
  end
end

class Assignee < ActiveRecord::Base
  has_many :assignments
end

class BugTest < Minitest::Test
  def test_association_stuff
    issue = Issue.create!
    user = Assignee.create

    # When the models are in different databases, the after commit runs earlier
    # (presumably because a transaction from one database won't be joinable from
    # another) and so the `assignees` association gets loaded, but then we add
    # this new assignee to the association target even though it's already there
    # at https://github.com/rails/rails/blob/ced387ee58e9fd980217dd1f472f2c5afa241e9a/activerecord/lib/active_record/associations/collection_association.rb#L467-L470
    #
    # When the models are in the same database, this happens in the opposite
    # order because the after_commit runs later. We add the new assignee to
    # the association target, then later the after_commit runs and loads the
    # whole association.
    issue.assignees << user

    assert_equal [user], issue.assignees.to_a
    # expected: [#<Assignee id: 1>]
    # actual: [#<Assignee id: 1>, #<Assignee id: 1>]
  end
end
```

### Expected behavior

`issue.assignees` should not include duplicate records

### Actual behavior

`issue.assignees` includes a duplicate record

### System configuration
**Rails version**: main@5292486
**Ruby version**: 3.0.2
",https://api.github.com/repos/rails/rails/issues/43647/timeline,,composerinteralia,13696143,MDQ6VXNlcjEzNjk2MTQz,https://avatars.githubusercontent.com/u/13696143?v=4,,https://api.github.com/users/composerinteralia,https://github.com/composerinteralia,https://api.github.com/users/composerinteralia/followers,https://api.github.com/users/composerinteralia/following{/other_user},https://api.github.com/users/composerinteralia/gists{/gist_id},https://api.github.com/users/composerinteralia/starred{/owner}{/repo},https://api.github.com/users/composerinteralia/subscriptions,https://api.github.com/users/composerinteralia/orgs,https://api.github.com/users/composerinteralia/repos,https://api.github.com/users/composerinteralia/events{/privacy},https://api.github.com/users/composerinteralia/received_events,User,True,https://api.github.com/repos/rails/rails/issues/43647/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
267,https://api.github.com/repos/rails/rails/issues/43642,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43642/labels{/name},https://api.github.com/repos/rails/rails/issues/43642/comments,https://api.github.com/repos/rails/rails/issues/43642/events,https://github.com/rails/rails/issues/43642,1053168602,I_kwDNIULOPsYT2g,43642,There is no way to run ActiveRecord callbacks after a model is loaded with included associations,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2021-11-15T03:17:54Z,2022-02-10T23:35:06Z,,NONE,,"This is a similar issue to https://github.com/rails/rails/issues/13156

### Steps to reproduce
I am building a translation engine which stores translated strings in a separate table. When the model is loaded, I am automatically loading the translations using default scopes and `after_find` as follows:
```ruby
class Page
  has_many :translations, as: :record
  has_one :translation_es, as: :record, class_name: 'Translation' # Spanish

  default_scope { includes_locale }
  def self.includes_locale locale=nil
    locale ||= I18n.locale
    includes(""translation_#{locale}"".to_sym)
  end

  after_find :for_locale
  def for_locale locale=nil
    locale ||= I18n.locale
    translation = public_send(""translation_#{locale}"".to_sym)
    # ... load translation into model
  end
end

class Translation
  belongs_to :record, polymorphic: true
end
```
(This is greatly simplified, in practice I have a `Translatable` module which is included into any model that requires translation)

Then wherever I need to load anything, calling `Page.all` (with or without any modifiers) will load the models plus any translation models if available.

### Expected behavior
I expect the `Page` models to automatically and transparently load their translations.

### Actual behavior
When querying against the Pages table, I see n+1 queries because it seems that the preloaded associations are not applied until after both `after_find` and `after_initialize` have been called.

Whether this is intentional or not isn't important, I'm just looking for a way that I can do this transparently. If it's not possible to do this with the existing callbacks, is it possible for another to be added, e.g. `after_init_includes`? Alternatively, is there some way I could already achieve something similar by overriding a method somewhere?

One workaround I can think of would be to add another function on the `Page` class, which would need to be called whenever I'm using models that can be translated, e.g.
```ruby
class Page
  # ...
  def self.for_locale locale=nil
    pages = includes_locale(locale)
    pages.each { |page| page.for_locale(locale) }
  end
end
```

This could then be called using `Page.all.for_locale`. Drawbacks of this solution:
- We need to include `for_locale` everywhere we load these pages, which is prone to human error
- It causes the query to execute immediately, rather than lazily when the data is needed
- The returned value is now an array, rather than a Relation object, which can't be chained with other query modifiers

The way I'm currently working around this is by overriding `preload_associations` as follows:
```ruby
class Page
  # ...
  def self.preload_associations records
    super(records)
    records.each(&:for_locale)

    records
  end
end
```
While this works the way I want, I'm not happy with overriding this as its internal code that could change from underneath me.

### System configuration
**Rails version**: 6.1.4

**Ruby version**: 2.7.3
",https://api.github.com/repos/rails/rails/issues/43642/timeline,,adamdebono,1049190,MDQ6VXNlcjEwNDkxOTA=,https://avatars.githubusercontent.com/u/1049190?v=4,,https://api.github.com/users/adamdebono,https://github.com/adamdebono,https://api.github.com/users/adamdebono/followers,https://api.github.com/users/adamdebono/following{/other_user},https://api.github.com/users/adamdebono/gists{/gist_id},https://api.github.com/users/adamdebono/starred{/owner}{/repo},https://api.github.com/users/adamdebono/subscriptions,https://api.github.com/users/adamdebono/orgs,https://api.github.com/users/adamdebono/repos,https://api.github.com/users/adamdebono/events{/privacy},https://api.github.com/users/adamdebono/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43642/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
268,https://api.github.com/repos/rails/rails/issues/43638,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43638/labels{/name},https://api.github.com/repos/rails/rails/issues/43638/comments,https://api.github.com/repos/rails/rails/issues/43638/events,https://github.com/rails/rails/issues/43638,1052295821,I_kwDNIULOPrjCjQ,43638,Scaffolding generates broken fixtures for namespaced models,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2021-11-12T18:39:20Z,2022-03-08T20:36:13Z,,CONTRIBUTOR,,"### Steps to reproduce

```
rails g model Customer name:string
rails g model Customers::Category name:string description:string position:integer
```

This ends up creating two fixture files
* `test/fixtures/customers.yml`
* `test/fixtures/customers/categories.yml`

When trying to run tests I get an error that looks like this:

```
bin/rails test test/controllers/customers/categories_controller_test.rb:26

E

Error:
Customers::CategoriesControllerTest#test_should_update_customers_category:
ActiveRecord::Fixture::FixtureError: table ""customers"" has no columns named ""position"", ""description"".
```

I found some details in #31782 that led me to a fix.

I needed to move `test/fixtures/customers/categories.yml` to `test/fixtures/customers_categories.yml` AND add this block to the top of that file:

```
_fixture:
  model_class: Customers::Category
```

### Expected behavior

Generating a namespaced model should work out of the box.

Intuitively I would expect that the fixture could be in a namespaced directory that matches the model itself. The response in #31782 makes it sound like that is explicitly not desired.

It's also counterintuitive for the `_fixture` block to not work when the fixture file is in a namespaced directory.

Given the details in #31782 it sounds like the expected behavior should be for the scaffold generator to not namespace the fixture file with a directory, but with a namespace prefix (`customers_` instead of `customers/`) AND it should include the `_fixture` block to set the correct model name.

FWIW, I'm not sure that the desired behavior as described in #31782 is ideal. Or at least it causes some problems and inconsistencies with the way that namespaces for fixtures work vs models. I think ideally we should be able to use a fixture file that is namespaced with a directory the same way that models are, and ideally we shouldn't need the `_fixture` block in the fixture file. A reasonable middle ground might be to allow the namespaced directory for the fixture to work, but to auto generate the required `_fixture` block.

### Actual behavior

Scaffolding a namespaced model does not work out of the box. It generates a fixture file that is namespaced with a directory name, and it does not include the required `_fixture` block.


### System configuration
**Rails version**: Rails 5.2.5

**Ruby version**: ruby 2.6.5p114 (2019-10-01 revision 67812) [x86_64-darwin20]
",https://api.github.com/repos/rails/rails/issues/43638/timeline,,jagthedrummer,58702,MDQ6VXNlcjU4NzAy,https://avatars.githubusercontent.com/u/58702?v=4,,https://api.github.com/users/jagthedrummer,https://github.com/jagthedrummer,https://api.github.com/users/jagthedrummer/followers,https://api.github.com/users/jagthedrummer/following{/other_user},https://api.github.com/users/jagthedrummer/gists{/gist_id},https://api.github.com/users/jagthedrummer/starred{/owner}{/repo},https://api.github.com/users/jagthedrummer/subscriptions,https://api.github.com/users/jagthedrummer/orgs,https://api.github.com/users/jagthedrummer/repos,https://api.github.com/users/jagthedrummer/events{/privacy},https://api.github.com/users/jagthedrummer/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43638/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
269,https://api.github.com/repos/rails/rails/issues/43633,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43633/labels{/name},https://api.github.com/repos/rails/rails/issues/43633/comments,https://api.github.com/repos/rails/rails/issues/43633/events,https://github.com/rails/rails/issues/43633,1051988560,I_kwDNIULOPrQSUA,43633,ActiveStorage is not compatible with relative_root_urls,"[{'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-12T13:51:45Z,2021-12-11T07:01:31Z,,NONE,,"## Bug
If you have configured a relative root url, the active storage service will redirect wrong.
Example:

> http://localhost:3000/anything/rails/active_storage/blobs/blob_hash/image.jpg
Will get redirected to:
> http://localhost:3000/rails/active_storage/disk/blob_hash/image.jpg
Instead of:
> http://localhost:3000/anything/rails/active_storage/disk/blob_hash/image.jpg


### Steps to reproduce
Add to config:
`config.relative_url_root = '/anything'`
In your view:
`image_tag(record.image)`

### System configuration
**Rails version**: 6.1.0

**Ruby version**: ruby 2.7.1p83
",https://api.github.com/repos/rails/rails/issues/43633/timeline,,taa-lze,91659607,U_kgDOBXadVw,https://avatars.githubusercontent.com/u/91659607?v=4,,https://api.github.com/users/taa-lze,https://github.com/taa-lze,https://api.github.com/users/taa-lze/followers,https://api.github.com/users/taa-lze/following{/other_user},https://api.github.com/users/taa-lze/gists{/gist_id},https://api.github.com/users/taa-lze/starred{/owner}{/repo},https://api.github.com/users/taa-lze/subscriptions,https://api.github.com/users/taa-lze/orgs,https://api.github.com/users/taa-lze/repos,https://api.github.com/users/taa-lze/events{/privacy},https://api.github.com/users/taa-lze/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43633/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
270,https://api.github.com/repos/rails/rails/issues/43626,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43626/labels{/name},https://api.github.com/repos/rails/rails/issues/43626/comments,https://api.github.com/repos/rails/rails/issues/43626/events,https://github.com/rails/rails/pull/43626,1050199796,PR_kwDNIULOLl3-Bg,43626,Support dumping & loading PostgreSQL 14 schemas,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2021-11-10T19:03:48Z,2022-02-27T08:03:57Z,,CONTRIBUTOR,,"### Summary

PostgreSQL 14 introduced a `pg_stat_statements_info` view table as part of the commonly-used [`pg_stat_statements` extension](https://www.postgresql.org/docs/current/pgstatstatements.html#id-1.11.7.39.7).

Previously, when dumping a PostgreSQL v14 schema, a `create_view ""pg_stat_statements_info"" [...]` would get inserted into the schema file. Since PG itself creates this view, subsequently loading the schema would fail because it already exists.

This adds the view to `ignore_tables` when loading the PG schema dumper.

I wasn't sure if this is the best place for the config nor how to approach a test file, but figured I'd try out Cunningham's Law and give it a go.
",https://api.github.com/repos/rails/rails/issues/43626/timeline,,woahdae,25282,MDQ6VXNlcjI1Mjgy,https://avatars.githubusercontent.com/u/25282?v=4,,https://api.github.com/users/woahdae,https://github.com/woahdae,https://api.github.com/users/woahdae/followers,https://api.github.com/users/woahdae/following{/other_user},https://api.github.com/users/woahdae/gists{/gist_id},https://api.github.com/users/woahdae/starred{/owner}{/repo},https://api.github.com/users/woahdae/subscriptions,https://api.github.com/users/woahdae/orgs,https://api.github.com/users/woahdae/repos,https://api.github.com/users/woahdae/events{/privacy},https://api.github.com/users/woahdae/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43626/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43626,https://github.com/rails/rails/pull/43626,https://github.com/rails/rails/pull/43626.diff,https://github.com/rails/rails/pull/43626.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
271,https://api.github.com/repos/rails/rails/issues/43617,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43617/labels{/name},https://api.github.com/repos/rails/rails/issues/43617/comments,https://api.github.com/repos/rails/rails/issues/43617/events,https://github.com/rails/rails/issues/43617,1048414265,I_kwDNIULOPn2IOQ,43617,"ActiveRecord generates new instance of `has_many` relation, if `has_many_through` relation is iterated from a callback","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2021-11-09T10:05:59Z,2022-02-23T12:54:26Z,,NONE,,"There's an `Order` model:

```
 has_many :order_items
 has_many :dishes, through: :order_items
 ```
When I try to create a new `Order` together with a new `OrderItem` (see test below), another `OrderItem` suddenly is created. It happens simply because I try to iterate over `dishes` in the `after_save` callback 🤔 

Seems like a bug, but may also be my lack of understanding, would appreciate any suggestions.
Tested with Rails 6.1.x, but same behavior is seen with version 5.x.x

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 6.1.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :orders, force: true do |t|
    t.integer :prep_time
  end

  create_table :order_items, force: true do |t|
    t.integer :order_id
    t.integer :dish_id
  end

  create_table :dishes, force: true do |t|
    t.integer :name
    t.integer :prep_time
  end
end

class Order < ActiveRecord::Base
  has_many :order_items
  has_many :dishes, through: :order_items

  def iterate_over_dishes
    dishes.map(&:prep_time).sum
  end
end

class OrderItem < ActiveRecord::Base
  belongs_to :order
  belongs_to :dish

  after_save -> { order.iterate_over_dishes }
end

class Dish < ActiveRecord::Base

end

class BugTest < Minitest::Test
  def test_association_stuff
    dish = Dish.create!(prep_time: 10)
    order = Order.create!(order_items: [OrderItem.new(dish: dish)])

    assert_equal 1, order.order_items.count
  end
end
```

### Expected behavior
Iterating over `Dishes`, defined as a `has_many_through` relation on the `Order`, should not create another `OrderItem`.

### Actual behavior
Second `OrderItem` is created

### System configuration
**Rails version**: 6.1.0

**Ruby version**: 2.7.4
",https://api.github.com/repos/rails/rails/issues/43617/timeline,,mcfoton,5016246,MDQ6VXNlcjUwMTYyNDY=,https://avatars.githubusercontent.com/u/5016246?v=4,,https://api.github.com/users/mcfoton,https://github.com/mcfoton,https://api.github.com/users/mcfoton/followers,https://api.github.com/users/mcfoton/following{/other_user},https://api.github.com/users/mcfoton/gists{/gist_id},https://api.github.com/users/mcfoton/starred{/owner}{/repo},https://api.github.com/users/mcfoton/subscriptions,https://api.github.com/users/mcfoton/orgs,https://api.github.com/users/mcfoton/repos,https://api.github.com/users/mcfoton/events{/privacy},https://api.github.com/users/mcfoton/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43617/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
272,https://api.github.com/repos/rails/rails/issues/43613,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43613/labels{/name},https://api.github.com/repos/rails/rails/issues/43613/comments,https://api.github.com/repos/rails/rails/issues/43613/events,https://github.com/rails/rails/pull/43613,1047913992,PR_kwDNIULOLkAfKw,43613,Extract annotations using a parser for Ruby files,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,1,2021-11-08T21:01:07Z,2022-02-11T16:46:16Z,,CONTRIBUTOR,,"When you're looking for annotations, it's possible (albeit extremely unlikely) for it to pick up things that aren't comments (see the added test for an example). If we instead use a parser like ripper, we can filter down to just the comments and only try to extract the annotations from the source file's comments.",https://api.github.com/repos/rails/rails/issues/43613/timeline,,kddnewton,5093358,MDQ6VXNlcjUwOTMzNTg=,https://avatars.githubusercontent.com/u/5093358?v=4,,https://api.github.com/users/kddnewton,https://github.com/kddnewton,https://api.github.com/users/kddnewton/followers,https://api.github.com/users/kddnewton/following{/other_user},https://api.github.com/users/kddnewton/gists{/gist_id},https://api.github.com/users/kddnewton/starred{/owner}{/repo},https://api.github.com/users/kddnewton/subscriptions,https://api.github.com/users/kddnewton/orgs,https://api.github.com/users/kddnewton/repos,https://api.github.com/users/kddnewton/events{/privacy},https://api.github.com/users/kddnewton/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43613/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43613,https://github.com/rails/rails/pull/43613,https://github.com/rails/rails/pull/43613.diff,https://github.com/rails/rails/pull/43613.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
273,https://api.github.com/repos/rails/rails/issues/43601,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43601/labels{/name},https://api.github.com/repos/rails/rails/issues/43601/comments,https://api.github.com/repos/rails/rails/issues/43601/events,https://github.com/rails/rails/issues/43601,1046123761,I_kwDNIULOPlqU8Q,43601,Change wording of master.key to be inclusive,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,15,2021-11-05T18:26:44Z,2022-03-31T10:50:17Z,,NONE,,"### Steps to reproduce
Just spinning up a new app. `$ rails new coolproject`

### Expected behavior
The `config/master.key` file should be renamed to use another term that is inclusive to everyone. Perhaps primary.key, root.key, or main.key

### Actual behavior
The `config/master.key` wording is outdated and rooted in discrimination. Let's make it better!

### System configuration
**Rails version**: 6.0.4.1

**Ruby version**: 2.7.0 and 2.7.3
",https://api.github.com/repos/rails/rails/issues/43601/timeline,,jennifersarahpaul,14044753,MDQ6VXNlcjE0MDQ0NzUz,https://avatars.githubusercontent.com/u/14044753?v=4,,https://api.github.com/users/jennifersarahpaul,https://github.com/jennifersarahpaul,https://api.github.com/users/jennifersarahpaul/followers,https://api.github.com/users/jennifersarahpaul/following{/other_user},https://api.github.com/users/jennifersarahpaul/gists{/gist_id},https://api.github.com/users/jennifersarahpaul/starred{/owner}{/repo},https://api.github.com/users/jennifersarahpaul/subscriptions,https://api.github.com/users/jennifersarahpaul/orgs,https://api.github.com/users/jennifersarahpaul/repos,https://api.github.com/users/jennifersarahpaul/events{/privacy},https://api.github.com/users/jennifersarahpaul/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43601/reactions,10,8,0,0,0,0,0,0,2,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
274,https://api.github.com/repos/rails/rails/issues/43594,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43594/labels{/name},https://api.github.com/repos/rails/rails/issues/43594/comments,https://api.github.com/repos/rails/rails/issues/43594/events,https://github.com/rails/rails/pull/43594,1045124911,PR_kwDNIULOLhyeUw,43594,Recommend mandatory STARTTLS for Google,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,1,2021-11-04T19:29:04Z,2022-02-02T22:11:34Z,,CONTRIBUTOR,,"### Summary

The [Action Mailer guide](https://edgeguides.rubyonrails.org/action_mailer_basics.html#action-mailer-configuration-for-gmail) recommends using [opportunistic TLS](https://en.wikipedia.org/wiki/Opportunistic_TLS) (`enable_starttls_auto: true`) for connecting to smtp.google.com.

This setting is vulnerable to man-in-the-middle attacks. Google definitely supports STARTTLS, so this should be required using `enable_starttls: true`.
",https://api.github.com/repos/rails/rails/issues/43594/timeline,,c960657,111346,MDQ6VXNlcjExMTM0Ng==,https://avatars.githubusercontent.com/u/111346?v=4,,https://api.github.com/users/c960657,https://github.com/c960657,https://api.github.com/users/c960657/followers,https://api.github.com/users/c960657/following{/other_user},https://api.github.com/users/c960657/gists{/gist_id},https://api.github.com/users/c960657/starred{/owner}{/repo},https://api.github.com/users/c960657/subscriptions,https://api.github.com/users/c960657/orgs,https://api.github.com/users/c960657/repos,https://api.github.com/users/c960657/events{/privacy},https://api.github.com/users/c960657/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43594/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43594,https://github.com/rails/rails/pull/43594,https://github.com/rails/rails/pull/43594.diff,https://github.com/rails/rails/pull/43594.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
275,https://api.github.com/repos/rails/rails/issues/43590,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43590/labels{/name},https://api.github.com/repos/rails/rails/issues/43590/comments,https://api.github.com/repos/rails/rails/issues/43590/events,https://github.com/rails/rails/issues/43590,1044252647,I_kwDNIULOPj4H5w,43590,Schema dumper incorrectly dumps operator-based generated PG columns,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-04T00:41:38Z,2021-11-07T22:24:20Z,,CONTRIBUTOR,,"### Steps to reproduce

* Clone Rails repo or check out the latest revision if you have it cloned already.
* `cd rails`.
* Apply the patch below.
* Run `(cd activerecord && ARCONN=postgresql bundle exec ruby -Itest test/cases/adapters/postgresql/virtual_column_test.rb -n test_schema_dumping)`.

```diff
diff --git a/activerecord/test/cases/adapters/postgresql/virtual_column_test.rb b/activerecord/test/cases/adapters/postgresql/virtual_column_test.rb
index 069e10e74b..a7d4562e4b 100644
--- a/activerecord/test/cases/adapters/postgresql/virtual_column_test.rb
+++ b/activerecord/test/cases/adapters/postgresql/virtual_column_test.rb
@@ -19,6 +19,8 @@ def setup
         t.virtual :upper_name,  type: :string,  as: ""UPPER(name)"", stored: true
         t.virtual :name_length, type: :integer, as: ""LENGTH(name)"", stored: true
         t.virtual :name_octet_length, type: :integer, as: ""OCTET_LENGTH(name)"", stored: true
+        t.jsonb :tender
+        t.virtual :love, type: :string, as: ""tender->>'love'"", stored: true
       end
       VirtualColumn.create(name: ""Rails"")
     end
@@ -78,6 +80,8 @@ def test_schema_dumping
       assert_match(/t\.virtual\s+""upper_name"",\s+type: :string,\s+as: ""upper\(\(name\)::text\)"", stored: true$/i, output)
       assert_match(/t\.virtual\s+""name_length"",\s+type: :integer,\s+as: ""length\(\(name\)::text\)"", stored: true$/i, output)
       assert_match(/t\.virtual\s+""name_octet_length"",\s+type: :integer,\s+as: ""octet_length\(\(name\)::text\)"", stored: true$/i, output)
+      assert_match(/as:.*tender.*love/, output)
+      assert_no_match(/as: nil/, output)
     end
 
     def test_build_fixture_sql
```

### Expected behavior

Dumper should generate the following output for the new virtual column:

```ruby
    t.virtual ""love"", type: :string, as: ""(tender ->> 'love'::text)"", stored: true
```

The test should be green, too. The two new assertions should pass.

### Actual behavior

The test fails because `as: nil` is generated for the new virtual column.

```ruby
    t.virtual ""love"", type: :string, as: nil, stored: true
```

### System configuration

**Rails version**:
I reproduced it on 57fe7dfce9fc751dd521ec8e175924eb1480b5d5, but it's probably been broken since #41856, when the support for generated Postgresql columns was added.

**Ruby version**:
ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-darwin17]

### Possible cause

The culprit is likely to be somewhere in the [has_default_function?](https://github.com/rails/rails/blob/57fe7dfce9fc751dd521ec8e175924eb1480b5d5/activerecord/lib/active_record/connection_adapters/postgresql_adapter.rb#L650) method. The regexp that is used there, `%r{\w+\(.*\)|\(.*\)::\w+|CURRENT_DATE|CURRENT_TIMESTAMP}`, does not recognize the expressions like `tender->>'love'` as a function call. Modifying the regexp to match this helps, but I'm not sure this modification can break anything, so I'm not sending a PR.

### Workaround

In this particular case, replacing `as: ""tender->>'love'""` with `as: ""jsonb_extract_path_text(tender, 'love')""` helps (and also makes the test green).

It's not always possible to find a suitable workaround though. For example, creating a virtual column with `as: ""id + 100""` generates `as: nil` in the schema dump. I don't know if there is an easy way to rewrite the expression in such a way that the dumper is happy.",https://api.github.com/repos/rails/rails/issues/43590/timeline,,DNNX,447953,MDQ6VXNlcjQ0Nzk1Mw==,https://avatars.githubusercontent.com/u/447953?v=4,,https://api.github.com/users/DNNX,https://github.com/DNNX,https://api.github.com/users/DNNX/followers,https://api.github.com/users/DNNX/following{/other_user},https://api.github.com/users/DNNX/gists{/gist_id},https://api.github.com/users/DNNX/starred{/owner}{/repo},https://api.github.com/users/DNNX/subscriptions,https://api.github.com/users/DNNX/orgs,https://api.github.com/users/DNNX/repos,https://api.github.com/users/DNNX/events{/privacy},https://api.github.com/users/DNNX/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43590/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
276,https://api.github.com/repos/rails/rails/issues/43589,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43589/labels{/name},https://api.github.com/repos/rails/rails/issues/43589/comments,https://api.github.com/repos/rails/rails/issues/43589/events,https://github.com/rails/rails/pull/43589,1044137696,PR_kwDNIULOLhCHQA,43589,ActiveRecord: Always use NestedError in association validation,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-03T21:38:15Z,2022-02-16T09:01:35Z,,CONTRIBUTOR,,"### Summary

When an association record about to be auto-saved fails validation, the validation error is wrapped in a `NestedError`, but only if the association is defined with `autosave: true` (see [ActiveRecord::AutosaveAssociation#association_valid?](https://github.com/rails/rails/blob/9c8fab9/activerecord/lib/active_record/autosave_association.rb#L330-L354)). Otherwise just a plain error is created without additional context. So if you are interested in the detailed `NestedError`s, you have to enable `autosave: true` – `validate: true` is not enough.

I don't see any good reason for this difference. The logic was originally added in [5cda000bf0f6d85d1a1efedf9fa4d0b6eaf988a1](https://github.com/rails/rails/commit/5cda000bf0f6d85d1a1efedf9fa4d0b6eaf988a1#diff-d88c50e3eec9509f3060d7847e8d6f3d82ad951b9f586698241d324eafc59cfdR245-R259) but without any explanation. A NestedError with full context seems useful in any case.

### Other Information
If one prefers just a single validation error, the `validates_association` validator still just creates one error for any number of invalidation errors on associated objects, possible with a custom `message`. If a `message` is supplied, it doesn't seem useful to create a NestedError for each invalidation error, because they would all have the same message.

One might consider modifying `Errors#messages_for`, `Errors#added?` etc. to do a prefix search, i.e. so that `Errors#messages_for(""foo"")` would match errors with attribute `foo` as well as `foo.bar` and `foo[1].bar`. This would provide the best of both worlds for the two different ways of handling errors .",https://api.github.com/repos/rails/rails/issues/43589/timeline,,c960657,111346,MDQ6VXNlcjExMTM0Ng==,https://avatars.githubusercontent.com/u/111346?v=4,,https://api.github.com/users/c960657,https://github.com/c960657,https://api.github.com/users/c960657/followers,https://api.github.com/users/c960657/following{/other_user},https://api.github.com/users/c960657/gists{/gist_id},https://api.github.com/users/c960657/starred{/owner}{/repo},https://api.github.com/users/c960657/subscriptions,https://api.github.com/users/c960657/orgs,https://api.github.com/users/c960657/repos,https://api.github.com/users/c960657/events{/privacy},https://api.github.com/users/c960657/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43589/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43589,https://github.com/rails/rails/pull/43589,https://github.com/rails/rails/pull/43589.diff,https://github.com/rails/rails/pull/43589.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
277,https://api.github.com/repos/rails/rails/issues/43582,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43582/labels{/name},https://api.github.com/repos/rails/rails/issues/43582/comments,https://api.github.com/repos/rails/rails/issues/43582/events,https://github.com/rails/rails/issues/43582,1042135721,I_kwDNIULOPh26qQ,43582,Cached AR object incompatibility between <6 and >=6,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2021-11-02T10:29:04Z,2022-02-01T17:47:52Z,,CONTRIBUTOR,,"ActiveRecord objects saved in the cache while running rails <6 that are loaded in rails >=6 will return `nil` for `.id`. `.attributes` shows the correct `id`, as does `[:id]`. 

This problem presented when I deployed a well-tested 5.2→6.1 PR to prod and immediately had problems anywhere that expected object ids. (in QA we didn't test cross-version cache compatibility)

my short-term solution is to add `namespace: 'rails-6.1'` to my cache config to bust the entire cache, which is of course not ideal.

The problem is described in this SO question: https://stackoverflow.com/questions/66081310/marshal-conflict-between-rails-activerecord-versions. The author believes the problem started here: https://github.com/rails/rails/commit/b6828fc91531ae0cc0a0f216705dd19112596301

* I was surprised to not find more discussion about this problem anywhere, so maybe Im misunderstanding the situation or why my use case is atypical
* I don't know if the problem could/should be solved in code
* maybe a note should be added to the 6.0 upgrade guide?


",https://api.github.com/repos/rails/rails/issues/43582/timeline,,jjb,6097,MDQ6VXNlcjYwOTc=,https://avatars.githubusercontent.com/u/6097?v=4,,https://api.github.com/users/jjb,https://github.com/jjb,https://api.github.com/users/jjb/followers,https://api.github.com/users/jjb/following{/other_user},https://api.github.com/users/jjb/gists{/gist_id},https://api.github.com/users/jjb/starred{/owner}{/repo},https://api.github.com/users/jjb/subscriptions,https://api.github.com/users/jjb/orgs,https://api.github.com/users/jjb/repos,https://api.github.com/users/jjb/events{/privacy},https://api.github.com/users/jjb/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43582/reactions,1,0,0,0,0,0,0,0,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
278,https://api.github.com/repos/rails/rails/issues/43565,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43565/labels{/name},https://api.github.com/repos/rails/rails/issues/43565/comments,https://api.github.com/repos/rails/rails/issues/43565/events,https://github.com/rails/rails/pull/43565,1039055610,PR_kwDNIULOLdMi9g,43565,ActiveRecord: Fix preloading when using a double as foreign_key,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2021-10-29T00:28:33Z,2022-03-11T20:08:59Z,,NONE,,"### Summary

I have a table called `accounts` in my Postgres database.  One of its columns acts as a foreign key for another table in my database called `businesses`, however, the foreign key is a double, while the primary key is an integer.  When trying to preload businesses for `accounts`, I get the error below.  

The issue is that when assigning preloaded associations for a given record, the foreign key gets converted to a string from a float, ie ""6.0"", while the primary key integer gets converted as ""6"".  As a result, it can't find an owner for the association.

To fix this, I would like to check for the existence of the key as a float, and convert it to an integer first.

It looks like this has been a long-standing issue, and was actually reported back in 2012: https://github.com/rails/rails/pull/6637, but the PR was abandoned.

```
undefined method `first' for nil:NilClass

/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/associations/preloader/association.rb:121:in `block in records_for'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/core.rb:546:in `init_with_attributes'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/persistence.rb:403:in `instantiate_instance_of'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/querying.rb:66:in `block (2 levels) in find_by_sql'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/result.rb:62:in `block in each'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/result.rb:62:in `each'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/result.rb:62:in `each'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/querying.rb:66:in `map'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/querying.rb:66:in `block in find_by_sql'
/app/vendor/bundle/ruby/2.7.0/gems/activesupport-6.1.4.1/lib/active_support/notifications/instrumenter.rb:24:in `instrument'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/querying.rb:61:in `find_by_sql'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/relation.rb:843:in `block in exec_queries'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/relation.rb:861:in `skip_query_cache_if_necessary'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/relation.rb:828:in `exec_queries'
/app/vendor/bundle/ruby/2.7.0/gems/activerecord-6.1.4.1/lib/active_record/relation.rb:631:in `load'
```

### Other Information
I'd like to create a test for this, but I'm not entirely sure how to go about doing that.  If anyone has any guidance I would appreciate it.  

Thank you!

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43565/timeline,,sdrioux,3970173,MDQ6VXNlcjM5NzAxNzM=,https://avatars.githubusercontent.com/u/3970173?v=4,,https://api.github.com/users/sdrioux,https://github.com/sdrioux,https://api.github.com/users/sdrioux/followers,https://api.github.com/users/sdrioux/following{/other_user},https://api.github.com/users/sdrioux/gists{/gist_id},https://api.github.com/users/sdrioux/starred{/owner}{/repo},https://api.github.com/users/sdrioux/subscriptions,https://api.github.com/users/sdrioux/orgs,https://api.github.com/users/sdrioux/repos,https://api.github.com/users/sdrioux/events{/privacy},https://api.github.com/users/sdrioux/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43565/reactions,2,1,0,0,0,0,0,1,0,False,https://api.github.com/repos/rails/rails/pulls/43565,https://github.com/rails/rails/pull/43565,https://github.com/rails/rails/pull/43565.diff,https://github.com/rails/rails/pull/43565.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
279,https://api.github.com/repos/rails/rails/issues/43557,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43557/labels{/name},https://api.github.com/repos/rails/rails/issues/43557/comments,https://api.github.com/repos/rails/rails/issues/43557/events,https://github.com/rails/rails/pull/43557,1038168381,PR_kwDNIULOLcd-Hw,43557,Propagate `save(validate:)` option for `:has_one` associations on autosave,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2021-10-28T07:20:13Z,2022-01-26T16:24:43Z,,CONTRIBUTOR,,"### Summary

Propagate `save(validate:)` option for `:has_one` associations on autosave.

`save(validate:)` option is propagated to associated records during `autosave` when `autosave` option is `nil`. Affects only `:has_one` associations.

*This is a follow up of https://github.com/rails/rails/pull/43525 for `has_one` associations.
Since https://github.com/rails/rails/pull/43525 has not been merged yet it also encompasses the changes done in https://github.com/rails/rails/pull/43525.*
<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43557/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43557/reactions,1,0,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/43557,https://github.com/rails/rails/pull/43557,https://github.com/rails/rails/pull/43557.diff,https://github.com/rails/rails/pull/43557.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
280,https://api.github.com/repos/rails/rails/issues/43540,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43540/labels{/name},https://api.github.com/repos/rails/rails/issues/43540/comments,https://api.github.com/repos/rails/rails/issues/43540/events,https://github.com/rails/rails/pull/43540,1036624455,PR_kwDNIULOLbObQw,43540,"Accept an integer for the week start day for `Date#next_week`, `Date#beginning_of_week`, etc","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,1,2021-10-26T18:43:42Z,2022-03-29T23:18:55Z,,MEMBER,,"Currently this works:

```ruby
Date.today.beginning_of_week(:tuesday) # returns a Tuesday
```

If you are using this functionality, you may also let users configure their week start day, and store this configuration in a database. To avoid i18n issues, the database column is most likely an integer (values 0-6) and then you display the corresponding day name in the UI.

This makes the code that provides the argument to `beginning_of_week` messy. You end up using this sort of pattern a lot:

```ruby
dayname = Date::DAYNAMES[week_start_day_from_settings].downcase.to_sym
start_of_week = date.beginning_of_week(dayname)
```

This works, but it'd be nicer if Rails could do it for you. This PR lets you pass an integer to `beginning_of_week` and related methods, so you can do this:

```ruby
Date.today.beginning_of_week(2) # returns a Tuesday
Date.today.beginning_of_week(week_start_day_from_settings) # returns a Tuesday
```
",https://api.github.com/repos/rails/rails/issues/43540/timeline,,ghiculescu,509837,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43540/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43540,https://github.com/rails/rails/pull/43540,https://github.com/rails/rails/pull/43540.diff,https://github.com/rails/rails/pull/43540.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
281,https://api.github.com/repos/rails/rails/issues/43539,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43539/labels{/name},https://api.github.com/repos/rails/rails/issues/43539/comments,https://api.github.com/repos/rails/rails/issues/43539/events,https://github.com/rails/rails/pull/43539,1036546043,PR_kwDNIULOLbKUpQ,43539,Correct preloading association scope documentation,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,1,2021-10-26T17:07:20Z,2022-01-28T20:26:12Z,,CONTRIBUTOR,,"### Summary

The implementation of `reflection.check_eager_loadable!` requires that
the arity of the proc be zero (or else it won't be called), so the docs
saying that the proc will be called with `nil` isn't true by itself --
the proc must also be declared with an optional argument.",https://api.github.com/repos/rails/rails/issues/43539/timeline,,jcoleman,125331,MDQ6VXNlcjEyNTMzMQ==,https://avatars.githubusercontent.com/u/125331?v=4,,https://api.github.com/users/jcoleman,https://github.com/jcoleman,https://api.github.com/users/jcoleman/followers,https://api.github.com/users/jcoleman/following{/other_user},https://api.github.com/users/jcoleman/gists{/gist_id},https://api.github.com/users/jcoleman/starred{/owner}{/repo},https://api.github.com/users/jcoleman/subscriptions,https://api.github.com/users/jcoleman/orgs,https://api.github.com/users/jcoleman/repos,https://api.github.com/users/jcoleman/events{/privacy},https://api.github.com/users/jcoleman/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43539/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43539,https://github.com/rails/rails/pull/43539,https://github.com/rails/rails/pull/43539.diff,https://github.com/rails/rails/pull/43539.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
282,https://api.github.com/repos/rails/rails/issues/43525,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43525/labels{/name},https://api.github.com/repos/rails/rails/issues/43525/comments,https://api.github.com/repos/rails/rails/issues/43525/events,https://github.com/rails/rails/pull/43525,1034989402,PR_kwDNIULOLZ40_A,43525,Propagate `save(validate:)` option for `:has_many` associations on au…,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,7,2021-10-25T11:00:50Z,2022-01-26T16:25:04Z,,CONTRIBUTOR,,"### Summary

`save(validate:)` option is propagated to associated records during `autosave` when `autosave` option is `nil`. 
Affects only `:has_many` associations.

Fixes #43400

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43525/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43525/reactions,2,1,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/43525,https://github.com/rails/rails/pull/43525,https://github.com/rails/rails/pull/43525.diff,https://github.com/rails/rails/pull/43525.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
283,https://api.github.com/repos/rails/rails/issues/43500,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43500/labels{/name},https://api.github.com/repos/rails/rails/issues/43500/comments,https://api.github.com/repos/rails/rails/issues/43500/events,https://github.com/rails/rails/pull/43500,1032016000,PR_kwDNIULOLXhvhA,43500,Adapter specific advisory lock (support for PostgreSQL per schema locking),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2021-10-21T03:19:42Z,2022-04-16T15:10:44Z,,NONE,,"### Summary

This is to revive #40251.

For PostgreSQL, the migrator should use both database and schema when creating a lock so concurrent migrations can be executed across schemas (e.g. `parallel_migration_threads` option in `apartment` gem).

### Other Information

The main issue with #40251 was introducing PostgreSQL-specific logic to the migrator. This pull moves lock_id generation logic to the abstract adapter. It allows creation of adapter-specific `generate_advisory_lock_id` methods.

For example, in case of PostgreSQL `pg_try_advisory_lock()` function can accept either single signed 64-bit integer lock argument, or two signed 32-bit integers. The latter is a perfect case for using it with PostgreSQL schemas.

/cc @eileencodes @tgxworld @marksiemers

Ref #31627
Ref influitive/apartment#506
Ref rails-on-services/apartment#147
Ref rails-on-services/apartment#149",https://api.github.com/repos/rails/rails/issues/43500/timeline,,leshik,443678,MDQ6VXNlcjQ0MzY3OA==,https://avatars.githubusercontent.com/u/443678?v=4,,https://api.github.com/users/leshik,https://github.com/leshik,https://api.github.com/users/leshik/followers,https://api.github.com/users/leshik/following{/other_user},https://api.github.com/users/leshik/gists{/gist_id},https://api.github.com/users/leshik/starred{/owner}{/repo},https://api.github.com/users/leshik/subscriptions,https://api.github.com/users/leshik/orgs,https://api.github.com/users/leshik/repos,https://api.github.com/users/leshik/events{/privacy},https://api.github.com/users/leshik/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43500/reactions,9,8,0,0,0,0,0,1,0,False,https://api.github.com/repos/rails/rails/pulls/43500,https://github.com/rails/rails/pull/43500,https://github.com/rails/rails/pull/43500.diff,https://github.com/rails/rails/pull/43500.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
284,https://api.github.com/repos/rails/rails/issues/43476,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43476/labels{/name},https://api.github.com/repos/rails/rails/issues/43476/comments,https://api.github.com/repos/rails/rails/issues/43476/events,https://github.com/rails/rails/pull/43476,1028060873,PR_kwDNIULOLUeZyQ,43476,Add negative scopes to delegated types,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2021-10-16T14:23:49Z,2022-04-15T00:59:06Z,,CONTRIBUTOR,,"### Summary

Similar to negative scopes on enums this adds negative scopes on delegated types.

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43476/timeline,,npezza93,5059927,MDQ6VXNlcjUwNTk5Mjc=,https://avatars.githubusercontent.com/u/5059927?v=4,,https://api.github.com/users/npezza93,https://github.com/npezza93,https://api.github.com/users/npezza93/followers,https://api.github.com/users/npezza93/following{/other_user},https://api.github.com/users/npezza93/gists{/gist_id},https://api.github.com/users/npezza93/starred{/owner}{/repo},https://api.github.com/users/npezza93/subscriptions,https://api.github.com/users/npezza93/orgs,https://api.github.com/users/npezza93/repos,https://api.github.com/users/npezza93/events{/privacy},https://api.github.com/users/npezza93/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43476/reactions,2,2,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43476,https://github.com/rails/rails/pull/43476,https://github.com/rails/rails/pull/43476.diff,https://github.com/rails/rails/pull/43476.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
285,https://api.github.com/repos/rails/rails/issues/43469,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43469/labels{/name},https://api.github.com/repos/rails/rails/issues/43469/comments,https://api.github.com/repos/rails/rails/issues/43469/events,https://github.com/rails/rails/issues/43469,1027099211,I_kwDNIULOPThKSw,43469,ActionText is rendering partials way too many times when parent is saved.,"[{'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,2,2021-10-15T05:36:24Z,2022-02-17T19:29:45Z,,NONE,,"Use the Trix editor and follow the guide on Go Rails here: https://www.youtube.com/watch?v=aE1Mqzpxa1U to implement @mentions. Then implement `to_attachable_partial_path` and put a breakpoint inside it, or put a breakpoint inside the default partial that is rendered when the model gets rendered as an attachment.

You will hit the break point several times before and after the content is stored.

I think it is the same problem described here: https://github.com/rails/rails/issues/37818

### Expected behavior
Should not render partial more than once for the returned HTML.

### Actual behavior
It renders the partial many times

### System configuration
**Rails version**:
7.0.0.alpha2

**Ruby version**:
2.7
",https://api.github.com/repos/rails/rails/issues/43469/timeline,,WriterZephos,11528362,MDQ6VXNlcjExNTI4MzYy,https://avatars.githubusercontent.com/u/11528362?v=4,,https://api.github.com/users/WriterZephos,https://github.com/WriterZephos,https://api.github.com/users/WriterZephos/followers,https://api.github.com/users/WriterZephos/following{/other_user},https://api.github.com/users/WriterZephos/gists{/gist_id},https://api.github.com/users/WriterZephos/starred{/owner}{/repo},https://api.github.com/users/WriterZephos/subscriptions,https://api.github.com/users/WriterZephos/orgs,https://api.github.com/users/WriterZephos/repos,https://api.github.com/users/WriterZephos/events{/privacy},https://api.github.com/users/WriterZephos/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43469/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
286,https://api.github.com/repos/rails/rails/issues/43466,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43466/labels{/name},https://api.github.com/repos/rails/rails/issues/43466/comments,https://api.github.com/repos/rails/rails/issues/43466/events,https://github.com/rails/rails/issues/43466,1026902020,I_kwDNIULOPTVIBA,43466,Unable to allow dots in params without slashes,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,0,2021-10-14T23:10:54Z,2021-10-15T15:48:20Z,,NONE,,"### Steps to reproduce

See this gist
https://gist.github.com/maths22/d4b0b689fdb18eb4d51d35d852b6e466

### Expected behavior
Given that you have a route that allows dots in a param but not slashes
And given that this route passes its params to a route helper with the same rule
And given that the the route is requested with an escaped slashes in the param
Requesting the route should not fail

### Actual behavior
Given the above, you get the following error:
```
ActionController::UrlGenerationError (No route matches {:action=>""with_dots"", :controller=>""test"", :param=>""foo/bar""}, possible unmatched constraints: [:param]
Did you mean?  with_dots_url):
  
rails (3b5db8e8c951) actionpack/lib/action_dispatch/journey/formatter.rb:44:in `path'
rails (3b5db8e8c951) actionpack/lib/action_dispatch/routing/route_set.rb:822:in `url_for'
rails (3b5db8e8c951) actionpack/lib/action_dispatch/routing/route_set.rb:269:in `call'
rails (3b5db8e8c951) actionpack/lib/action_dispatch/routing/route_set.rb:325:in `block in define_url_helper'
./action-pack-surprise-demo:38:in `with_dots'
```

This appears to be because the default param regex (`/[^\.\/\?]+/`) isn't enforced when constructing a url (which works since params get escaped when the url is actually built), but if you add an explicit constraint it is enforced at construction time.  Simply removing slashes from the list of prohibited characters doesn't work because then intermediate parameters in urls aren't parsed correctly.

### System configuration
**Rails version**: 6.0.4.1 through main

**Ruby version**: 2.7
",https://api.github.com/repos/rails/rails/issues/43466/timeline,,maths22,3067361,MDQ6VXNlcjMwNjczNjE=,https://avatars.githubusercontent.com/u/3067361?v=4,,https://api.github.com/users/maths22,https://github.com/maths22,https://api.github.com/users/maths22/followers,https://api.github.com/users/maths22/following{/other_user},https://api.github.com/users/maths22/gists{/gist_id},https://api.github.com/users/maths22/starred{/owner}{/repo},https://api.github.com/users/maths22/subscriptions,https://api.github.com/users/maths22/orgs,https://api.github.com/users/maths22/repos,https://api.github.com/users/maths22/events{/privacy},https://api.github.com/users/maths22/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43466/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
287,https://api.github.com/repos/rails/rails/issues/43462,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43462/labels{/name},https://api.github.com/repos/rails/rails/issues/43462/comments,https://api.github.com/repos/rails/rails/issues/43462/events,https://github.com/rails/rails/pull/43462,1026753377,PR_kwDNIULOLTf9WQ,43462,WIP: Default primary key to be unsigned in MySQL.,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2021-10-14T19:39:20Z,2022-04-12T21:36:38Z,,CONTRIBUTOR,,"WIP: Kicking off Draft PR to use CI for running tests to see if anything was missed in my local environment...

### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->

Fixes https://github.com/rails/rails/issues/40967",https://api.github.com/repos/rails/rails/issues/43462/timeline,,joshuapinter,180819,MDQ6VXNlcjE4MDgxOQ==,https://avatars.githubusercontent.com/u/180819?v=4,,https://api.github.com/users/joshuapinter,https://github.com/joshuapinter,https://api.github.com/users/joshuapinter/followers,https://api.github.com/users/joshuapinter/following{/other_user},https://api.github.com/users/joshuapinter/gists{/gist_id},https://api.github.com/users/joshuapinter/starred{/owner}{/repo},https://api.github.com/users/joshuapinter/subscriptions,https://api.github.com/users/joshuapinter/orgs,https://api.github.com/users/joshuapinter/repos,https://api.github.com/users/joshuapinter/events{/privacy},https://api.github.com/users/joshuapinter/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43462/reactions,0,0,0,0,0,0,0,0,0,True,https://api.github.com/repos/rails/rails/pulls/43462,https://github.com/rails/rails/pull/43462,https://github.com/rails/rails/pull/43462.diff,https://github.com/rails/rails/pull/43462.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
288,https://api.github.com/repos/rails/rails/issues/43418,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43418/labels{/name},https://api.github.com/repos/rails/rails/issues/43418/comments,https://api.github.com/repos/rails/rails/issues/43418/events,https://github.com/rails/rails/pull/43418,1021806296,PR_kwDNIULOLPoFtQ,43418,Forms: Deprecate `local:` and `remote:` options,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,7,2021-10-09T21:09:03Z,2022-02-25T20:12:21Z,,CONTRIBUTOR,,"This commit attempts to disentangle the two parts of interpreting the
`form_for` helper's `remote:` option, and the `form_with` helper's
`local:` option.

1. The `[data-remote]` attribute:

   When `remote: true` or `local: false`, Action View generates `<form>`
   elements with `[data-remote=""true""]`. When passed `remote: false` or
   `local: true`, the `[data-remote]` attribute is omitted.

   Omitting the options is equivalent to `remote: true` and `local:
   false`.

2. CSRF tokens

   When `remote: true` or `local: false`, Action view generates `<form>`
   elements without any CSRF tokens encoded as `<input type=""hidden"">`
   elements.

   When `remote: false` or `local: true`, Action view generates `<form>`
   elements with an embedded CSRF token either generated on the fly, or
   forwarded along from the form helper method's `authenticity_token:`
   option.

   When omitted, their default values are handled by two similar
   configuration values:

   * `config.action_view.embed_authenticity_token_in_remote_forms` for
     `form_for` and its `remote:` option

   * `config.action_view.form_with_generates_remote_forms` for
     `form_with` and its `local:` option

This commit introduces a new `config.action_view.per_form_csrf_tokens`
(drawing its name and default value from the already existent
[config.action_controller.per_form_csrf_tokens][].

This commit treats renders deprecation warnings when `local:` or
`remote:` options are passed to `form_with` and `form_for`,
respectively. Additionally, form helpers' `authenticity_token:` token
defaults to the value of `config.action_view.per_form_csrf_tokens`.

[config.action_controller.per_form_csrf_tokens]: https://edgeguides.rubyonrails.org/configuring.html#config-action-controller-per-form-csrf-tokens",https://api.github.com/repos/rails/rails/issues/43418/timeline,,seanpdoyle,2575027,MDQ6VXNlcjI1NzUwMjc=,https://avatars.githubusercontent.com/u/2575027?v=4,,https://api.github.com/users/seanpdoyle,https://github.com/seanpdoyle,https://api.github.com/users/seanpdoyle/followers,https://api.github.com/users/seanpdoyle/following{/other_user},https://api.github.com/users/seanpdoyle/gists{/gist_id},https://api.github.com/users/seanpdoyle/starred{/owner}{/repo},https://api.github.com/users/seanpdoyle/subscriptions,https://api.github.com/users/seanpdoyle/orgs,https://api.github.com/users/seanpdoyle/repos,https://api.github.com/users/seanpdoyle/events{/privacy},https://api.github.com/users/seanpdoyle/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43418/reactions,0,0,0,0,0,0,0,0,0,True,https://api.github.com/repos/rails/rails/pulls/43418,https://github.com/rails/rails/pull/43418,https://github.com/rails/rails/pull/43418.diff,https://github.com/rails/rails/pull/43418.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
289,https://api.github.com/repos/rails/rails/issues/43402,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43402/labels{/name},https://api.github.com/repos/rails/rails/issues/43402/comments,https://api.github.com/repos/rails/rails/issues/43402/events,https://github.com/rails/rails/pull/43402,1020548031,PR_kwDNIULOLOsY7w,43402,Fix eager loading models without primary keys,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,7,2021-10-07T23:43:11Z,2022-04-20T23:03:56Z,,NONE,,"### Summary

Eager-loading models without primary keys does not function correctly.

Fixes #29374

### Example

Consider the following and assume that the second model is backed by a DB object without a primary key (like a view):

```rb
class MyModel < ActiveRecord::Base
   has_one :model_without_primary_key, primary_key: :some_other_column
end

class ModelWithoutPrimaryKey < ActiveRecord::Base
   belongs_to :my_model, primary_key: :some_other_column
end
```
If we create a couple of records, we can see that `eager_load` produces incorrect results:

```rb
MyModel.create # => #<MyModel id: 1>
ModelWithoutPrimaryKey.create(some_other_column: 100, my_model_id: 1)

my_instance = MyModel.eager_load(:model_without_primary_key).first
my_instance.model_without_primary_key # => nil

my_instance.reload
my_instance.model_without_primary_key #=> #<ModelWithoutPrimaryKey ... >
```

This issue comes up during normal ActiveRecord use-cases when models are backed by DB views. It can also come up  with chains like:

```rb
my_instance.includes(:model_without_primary_key).order('model_without_primary_key.name')
```

### Credit

I give 95% of the credit to @chopraanmol1 and based this PR on their GH-30212, which looks to have gone stale a couple of years ago.
",https://api.github.com/repos/rails/rails/issues/43402/timeline,,mattalat,17059882,MDQ6VXNlcjE3MDU5ODgy,https://avatars.githubusercontent.com/u/17059882?v=4,,https://api.github.com/users/mattalat,https://github.com/mattalat,https://api.github.com/users/mattalat/followers,https://api.github.com/users/mattalat/following{/other_user},https://api.github.com/users/mattalat/gists{/gist_id},https://api.github.com/users/mattalat/starred{/owner}{/repo},https://api.github.com/users/mattalat/subscriptions,https://api.github.com/users/mattalat/orgs,https://api.github.com/users/mattalat/repos,https://api.github.com/users/mattalat/events{/privacy},https://api.github.com/users/mattalat/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43402/reactions,3,3,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43402,https://github.com/rails/rails/pull/43402,https://github.com/rails/rails/pull/43402.diff,https://github.com/rails/rails/pull/43402.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
290,https://api.github.com/repos/rails/rails/issues/43400,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43400/labels{/name},https://api.github.com/repos/rails/rails/issues/43400/comments,https://api.github.com/repos/rails/rails/issues/43400/events,https://github.com/rails/rails/issues/43400,1020300742,I_kwDNIULOPNCNxg,43400,`save(validate: false)` still runs `before_validation`s on associated records,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,12,2021-10-07T17:43:04Z,2022-03-10T20:52:18Z,,MEMBER,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :post_with_nested_attributes, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end

  create_table :comment_with_nested_attributes, force: true do |t|
    t.integer :post_with_nested_attribute_id
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class PostWithNestedAttribute < ActiveRecord::Base
  has_many :comment_with_nested_attributes
  accepts_nested_attributes_for :comment_with_nested_attributes
end

class Comment < ActiveRecord::Base
  belongs_to :post

  before_validation :do_something

  def do_something
    raise ""do not save!""
  end
end

class CommentWithNestedAttribute < ActiveRecord::Base
  belongs_to :post_with_nested_attribute

  before_validation :do_something

  def do_something
    raise ""do not save!""
  end
end

class BugTest < Minitest::Test
  def test_without_native_attributes
    post = Post.create!

    post.comments.build

    # this raises, which I think is wrong
    assert_raises(RuntimeError) do
      post.save!(validate: false)
    end
  end

  def test_with_native_attributes
    post = PostWithNestedAttribute.create!

    post.comment_with_nested_attributes.build

    # this doesn't raise, which I think is correct
    post.save!(validate: false)
  end
end
```

### Expected behavior
Currently both tests pass.

I think `test_without_native_attributes` should fail, because `before_validation` should not fire, since we are saving without validating.

### Actual behavior
Both tests pass, so:

- Normally, `save(validate: false)` will still run validation callbacks on associated autosaved records.
- Enabling nested attributes seems fixes the issue. (I'm not sure if this is relevant at all, it's just interesting...)

### System configuration
**Rails version**: main

**Ruby version**: 2.7
",https://api.github.com/repos/rails/rails/issues/43400/timeline,,ghiculescu,509837,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43400/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
291,https://api.github.com/repos/rails/rails/issues/43399,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43399/labels{/name},https://api.github.com/repos/rails/rails/issues/43399/comments,https://api.github.com/repos/rails/rails/issues/43399/events,https://github.com/rails/rails/pull/43399,1020228338,PR_kwDNIULOLOcWwA,43399,Add embedded associations in ActiveModel,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2021-10-07T16:18:11Z,2022-02-13T12:31:36Z,,NONE,,"Relational databases are very powerful. Their power comes from their ability to...
- Preserve data integrity with a predefined schema.
- Make complex relationships through joins.

But sometimes, we can stumble accross data that don't fit in the [relational model](https://www.digitalocean.com/community/tutorials/what-is-the-relational-model). We call this kind of data: **semi-structured data**. When this happens, the things that makes relational databases powerful are the things that gets in our way, and complicate our model instead of simplifying it.

That's why [document databases](https://en.wikipedia.org/wiki/Document-oriented_database) exist, to model and store semi structured data. However, if we choose to use a document database, we'll loose all the power of using a relational database.

Luckily for us, relational databases like Postgres and MySQL now has good JSON support. So most of us won't need to use a document database like MongoDB, as it would be overkill. Most of the time, we only need to [denormalize](https://www.geeksforgeeks.org/denormalization-in-databases/) some parts of our model. So it makes more sense to use simple JSON columns for those, instead of going all-in, and dump your beloved relational database for MongoDB.

Currently in Rails, we can have full control over how our JSON data is stored and retrieved from the database, by using the [Attributes API](https://dev.to/swanson/automatically-cast-params-with-the-rails-attributes-api-446a) to serialize and deserialize our data.

That's what this extension does, in order to provide a convinient way to model semi-structured data in a Rails application.

## Usage
Let's say that we need to store books in our database. We might want to ""embed"" data such as parts, chapters and sections without creating additional tables. By doing so, we can retrieve all the embedded data of a book in a single read operation, instead of performing expensive multi-table joins.

We can then model our data this way:
```ruby
class Book < ApplicationRecord
  include ActiveModel::Embedding::Associations

  embeds_many :parts
end

class Book::Part
  include ActiveModel::Embedding::Document

  attribute :title, :string

  embeds_many :chapters
end

class Book::Part::Chapter
  include ActiveModel::Embedding::Document

  attribute :title, :string

  embeds_many :sections
end

class Book::Part::Chapter::Section
  include ActiveModel::Embedding::Document

  attribute :title, :string
  attribute :content, :string
end
```

And display it like this (with nested attributes support out-of-the-box):
```erb
# app/views/books/_form.html.erb
<%= form_with model: @book do |book_form| %>
  <%= book_form.fields_for :parts do |part_fields| %>

    <%= part_fields.label :title %>
    <%= part_fields.text_field :title %>

    <%= part_fields.fields_for :chapters do |chapter_fields| %>
      <%= chapter_fields.label :title %>
      <%= chapter_fields.text_field :title %>

      <%= chapter_fields.fields_for :sections do |section_fields| %>
        <%= section_fields.label :title %>
        <%= section_fields.text_field :title %>
        <%= section_fields.text_area :content %>
      <% end %>
    <% end %>
  <% end %>

  <%= book_form.submit %>
<% end %>
```
### Validations
```ruby
class SomeModel < ApplicationRecord
  include ActiveModel::Embedding::Associations

  embeds_many :things

  validates_associated :things
end

class Thing
  include ActiveModel::Embedding::Document

  embeds_many :other_things

  validates_associated :other_things
end

class OtherThing
  include ActiveModel::Embedding::Document

  attribute :some_attribute, :string

  validates :some_attribute, presence: true
end
```
```ruby
things = Array.new(3) { Thing.new(other_things: Array.new(3) { OtherThing.new } }
record = SomeModel.new things: things

record.valid? # => false
record.save # => false

record.things.other_things = Array.new(3) { OtherThing.new(some_attribute: ""present"") }

record.valid? # => true
record.save # => true
```

### Custom collections
```ruby
class SomeCollection
  include ActiveModel::Embedding::Collecting
end

class Thing
  # ...
end

class SomeModel
  include ActiveModel::Embedding::Document

  embeds_many :things, collection: ""SomeCollection""
end

some_model = SomeModel.new things: Array.new(3) { Thing.new }
some_model.things.class
# => SomeCollection
```
### Custom types
```ruby
# config/initializers/types.rb
class SomeType < ActiveModel::Type::Value
  def cast(value)
    value.cast_type = self.class
    super
  end
end

ActiveModel::Type.register(:some_type, SomeType)

class SomeOtherType < ActiveModel::Type::Value
  attr_reader :context

  def initialize(context:)
    @context = context
  end

  def cast(value)
    value.cast_type = self.class
    value.context = context
    super
  end
end
```
```ruby
class Thing
  attr_accessor :cast_type
  attr_accessor :context
end

class SomeModel
  include ActiveModel::Embedding::Document

  embeds_many :things, cast_type: :some_type
  embeds_many :other_things, cast_type: SomeOtherType.new(context: self)
end

some_model = SomeModel.new(
  things: Array(3) { Thing.new },
  other_things: Array(3) { Thing.new }
)

some_model.things.first.cast_type
# => SomeType
some_model.other_things.first.cast_type
# => SomeOtherType
some_model.other_things.first.context
# => SomeModel
```

### Associations
#### embeds_many
Maps a JSON array to a collection.

Options:
- `:class_name`: Specify the class of the documents in the collection. Inferred by default.
- `:collection`: Specify a custom collection class which includes `ActiveModel:: Embedding::Collecting` (`ActiveModel::Embedding::Collection` by default).
- `:cast_type`: Specify a custom type that should be used to cast the documents in the collection. (the `:class_name` is ignored if this option is present.)
#### embed_one
Maps a JSON object to a document.

Options:
- `:class_name`: Same as above.
- `:cast_type`: Same as above.

## :warning: Warning
Embedded associations should only be used if you're sure that the data you want to embed is **encapsulated**. Which means, that embedded associations should only be accessed through the parent, and not from the outside. Thus, this should only be used if performing joins isn't a viable option.

Read [this section](https://github.com/mansakondo/activemodel-embedding#use-case-dealing-with-bibliographic-data) from the original README (and [this article](http://www.sarahmei.com/blog/2013/11/11/why-you-should-never-use-mongodb/)) for more insights on the use cases of this feature.

## Concepts
### Document
A JSON object mapped to a PORO which includes `ActiveModel::Embedding::Document`. Usually part of a collection.

### Collection
A JSON array mapped to an `ActiveModel::Embedding::Collection` (or any class that includes `ActiveModel::Embedding::Collecting`). Stores collections of documents.

### Embedded associations
Models structural hierarchies in semi-structured data, by ""embedding"" the content of children directly in the parent, instead of using references like foreign keys. See [Embedded Data Models](https://docs.mongodb.com/manual/core/data-model-design/#embedded-data-models) from MongoDB's docs.

### Semi-structured data
Data that don't fit in the [relational model](https://www.digitalocean.com/community/tutorials/what-is-the-relational-model).
> Semi-structured data is a form of structured data that does not obey the tabular structure of data models associated with relational databases or other forms of data tables, but nonetheless contains tags or other markers to separate semantic elements and enforce hierarchies of records and fields within the data. Therefore, it is also known as self-describing structure. - Wikipedia",https://api.github.com/repos/rails/rails/issues/43399/timeline,,mansakondo,47113995,MDQ6VXNlcjQ3MTEzOTk1,https://avatars.githubusercontent.com/u/47113995?v=4,,https://api.github.com/users/mansakondo,https://github.com/mansakondo,https://api.github.com/users/mansakondo/followers,https://api.github.com/users/mansakondo/following{/other_user},https://api.github.com/users/mansakondo/gists{/gist_id},https://api.github.com/users/mansakondo/starred{/owner}{/repo},https://api.github.com/users/mansakondo/subscriptions,https://api.github.com/users/mansakondo/orgs,https://api.github.com/users/mansakondo/repos,https://api.github.com/users/mansakondo/events{/privacy},https://api.github.com/users/mansakondo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43399/reactions,4,0,0,0,0,0,0,4,0,False,https://api.github.com/repos/rails/rails/pulls/43399,https://github.com/rails/rails/pull/43399,https://github.com/rails/rails/pull/43399.diff,https://github.com/rails/rails/pull/43399.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
292,https://api.github.com/repos/rails/rails/issues/43386,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43386/labels{/name},https://api.github.com/repos/rails/rails/issues/43386/comments,https://api.github.com/repos/rails/rails/issues/43386/events,https://github.com/rails/rails/pull/43386,1018471663,PR_kwDNIULOLM9qnw,43386,Fix tracking previous changes for ActiveRecord::Store accessors with underlying JSON data column,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2021-10-06T14:39:48Z,2022-04-05T14:58:05Z,,NONE,,"### Summary

Fixes https://github.com/rails/rails/issues/43385

Store accessors using structured data types in the DB, e.g. JSON, will not allow access using symbols. The dirty tracking for previous saved changes does not use `HashWithIndifferentAccess`, which prevents the methods from working on those columns.

This fixes the dirty tracking for previous changes to access the store from `saved_changes` as a `HashWithIndifferentAccess`.

### Other Information

I included a reproduction script in the linked issue. Changing the installation of `activerecord` from:
```
  gem ""activerecord"", ""~> 6.1.0""
```
to:
```
  git 'https://github.com/rdimartino/rails', branch: 'dirty_store' do
      gem 'activerecord'
  end
```
allows the tests in the reproduction script pass.",https://api.github.com/repos/rails/rails/issues/43386/timeline,,rdimartino,11539300,MDQ6VXNlcjExNTM5MzAw,https://avatars.githubusercontent.com/u/11539300?v=4,,https://api.github.com/users/rdimartino,https://github.com/rdimartino,https://api.github.com/users/rdimartino/followers,https://api.github.com/users/rdimartino/following{/other_user},https://api.github.com/users/rdimartino/gists{/gist_id},https://api.github.com/users/rdimartino/starred{/owner}{/repo},https://api.github.com/users/rdimartino/subscriptions,https://api.github.com/users/rdimartino/orgs,https://api.github.com/users/rdimartino/repos,https://api.github.com/users/rdimartino/events{/privacy},https://api.github.com/users/rdimartino/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43386/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43386,https://github.com/rails/rails/pull/43386,https://github.com/rails/rails/pull/43386.diff,https://github.com/rails/rails/pull/43386.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
293,https://api.github.com/repos/rails/rails/issues/43385,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43385/labels{/name},https://api.github.com/repos/rails/rails/issues/43385/comments,https://api.github.com/repos/rails/rails/issues/43385/events,https://github.com/rails/rails/issues/43385,1018458109,I_kwDNIULOPLRv_Q,43385,Previous change tracking for ActiveRecord::Store does not work when using a JSON column,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2021-10-06T14:33:23Z,2021-10-15T19:07:00Z,,NONE,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""~> 6.1.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
      t.text :options
      t.json :settings
  end
end

class Post < ActiveRecord::Base
    store :options, accessors: [:flavor], coder: JSON
    store_accessor :settings, :color
end

class BugTest < Minitest::Test
  # This works correctly
  def test_previous_change_tracking_on_text_column
    post = Post.create!
    post.flavor = 'lemon'
    post.save!

    assert_equal true, post.saved_change_to_flavor?
    assert_equal [nil, 'lemon'], post.saved_change_to_flavor
  end

  # These fail
  def test_previous_change_tracking_on_structured_column
    post = Post.create!
    post.color = 'blue'
    post.save!

    assert_equal true, post.saved_change_to_color?
    assert_equal [nil, 'blue'], post.saved_change_to_color
  end
end
```

### Expected behavior
Previous change tracking for `ActiveRecord::Store` attributes works the same when the underlying database data type is different.

### Actual behavior
Previous change tracking for `ActiveRecord::Store` attributes does not work when the underlying database data type is structured (e.g. JSON)

### System configuration
**Rails version**: 6.1.4.1

**Ruby version**: 2.7.2
",https://api.github.com/repos/rails/rails/issues/43385/timeline,,rdimartino,11539300,MDQ6VXNlcjExNTM5MzAw,https://avatars.githubusercontent.com/u/11539300?v=4,,https://api.github.com/users/rdimartino,https://github.com/rdimartino,https://api.github.com/users/rdimartino/followers,https://api.github.com/users/rdimartino/following{/other_user},https://api.github.com/users/rdimartino/gists{/gist_id},https://api.github.com/users/rdimartino/starred{/owner}{/repo},https://api.github.com/users/rdimartino/subscriptions,https://api.github.com/users/rdimartino/orgs,https://api.github.com/users/rdimartino/repos,https://api.github.com/users/rdimartino/events{/privacy},https://api.github.com/users/rdimartino/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43385/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
294,https://api.github.com/repos/rails/rails/issues/43359,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43359/labels{/name},https://api.github.com/repos/rails/rails/issues/43359/comments,https://api.github.com/repos/rails/rails/issues/43359/events,https://github.com/rails/rails/pull/43359,1013803683,PR_kwDNIULOLJUwuA,43359,Generate credentials with SecureRandom.alphanumeric instead of SecureRandom.hex,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,3,2021-10-01T22:13:11Z,2022-03-25T19:26:35Z,,CONTRIBUTOR,,"This allows for more entropy within keys while retaining the same byte size
",https://api.github.com/repos/rails/rails/issues/43359/timeline,,grepsedawk,6721355,MDQ6VXNlcjY3MjEzNTU=,https://avatars.githubusercontent.com/u/6721355?v=4,,https://api.github.com/users/grepsedawk,https://github.com/grepsedawk,https://api.github.com/users/grepsedawk/followers,https://api.github.com/users/grepsedawk/following{/other_user},https://api.github.com/users/grepsedawk/gists{/gist_id},https://api.github.com/users/grepsedawk/starred{/owner}{/repo},https://api.github.com/users/grepsedawk/subscriptions,https://api.github.com/users/grepsedawk/orgs,https://api.github.com/users/grepsedawk/repos,https://api.github.com/users/grepsedawk/events{/privacy},https://api.github.com/users/grepsedawk/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43359/reactions,3,0,0,0,0,0,3,0,0,False,https://api.github.com/repos/rails/rails/pulls/43359,https://github.com/rails/rails/pull/43359,https://github.com/rails/rails/pull/43359.diff,https://github.com/rails/rails/pull/43359.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
295,https://api.github.com/repos/rails/rails/issues/43357,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43357/labels{/name},https://api.github.com/repos/rails/rails/issues/43357/comments,https://api.github.com/repos/rails/rails/issues/43357/events,https://github.com/rails/rails/issues/43357,1013509862,I_kwDNIULOPGju5g,43357,default_url_options is ignored in console,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2021-10-01T15:58:23Z,2021-10-07T02:03:35Z,,CONTRIBUTOR,,"## What Ruby, Rails and RSpec versions are you using?

Ruby version: 2.7.2
Rails version: 6.1.4.1

## Observed behaviour

```
routes.default_url_options.merge!(host: 'localhost:3000', protocol: 'http') # development.rb

rails c
app.get '/'
-> 403
app.response
""Blocked host: www.example.com""
```

## Expected behaviour

using localhost:3000

## Can you provide an example app?

simple `rails new` reproduces it

## Root cause

https://github.com/rails/rails/blob/main/railties/lib/rails/console/app.rb#L13 which should be using default_url_options",https://api.github.com/repos/rails/rails/issues/43357/timeline,,grosser,11367,MDQ6VXNlcjExMzY3,https://avatars.githubusercontent.com/u/11367?v=4,,https://api.github.com/users/grosser,https://github.com/grosser,https://api.github.com/users/grosser/followers,https://api.github.com/users/grosser/following{/other_user},https://api.github.com/users/grosser/gists{/gist_id},https://api.github.com/users/grosser/starred{/owner}{/repo},https://api.github.com/users/grosser/subscriptions,https://api.github.com/users/grosser/orgs,https://api.github.com/users/grosser/repos,https://api.github.com/users/grosser/events{/privacy},https://api.github.com/users/grosser/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43357/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
296,https://api.github.com/repos/rails/rails/issues/43354,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43354/labels{/name},https://api.github.com/repos/rails/rails/issues/43354/comments,https://api.github.com/repos/rails/rails/issues/43354/events,https://github.com/rails/rails/pull/43354,1013426181,PR_kwDNIULOLJCq3w,43354,Remove deprecation warning of `merge` with `where.not(field_id: nil)`…,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2021-10-01T14:36:33Z,2022-01-26T16:26:00Z,,CONTRIBUTOR,,"### Summary

Merging a `where.not(field_id: nil)` doesn't print a deprecation warning.

Fixes #42759
<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43354/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43354/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43354,https://github.com/rails/rails/pull/43354,https://github.com/rails/rails/pull/43354.diff,https://github.com/rails/rails/pull/43354.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
297,https://api.github.com/repos/rails/rails/issues/43337,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43337/labels{/name},https://api.github.com/repos/rails/rails/issues/43337/comments,https://api.github.com/repos/rails/rails/issues/43337/events,https://github.com/rails/rails/pull/43337,1011863143,PR_kwDNIULOLH3nCQ,43337,Fix `thread_mattr_accessor` `default` option behavior,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,7,2021-09-30T08:15:23Z,2022-04-12T14:56:44Z,,NONE,,"### Summary

This makes the value supplier to the `default` option of
`thread_mattr_accessor` to be set in descendant classes
as well as in any new Thread that starts.

Previously, the `default` value provided was set only at the
moment of defining the attribute writer, which would cause
the attribute to be uninitialized in descendants and in other threads.

For instance:

    class Processor
      thread_mattr_accessor :mode, default: :smart
    end

    class SubProcessor < Processor
    end

    SubProcessor.mode # => :smart
    Thread.new do
      Processor.mode # => :smart
    end.join

when in the past, those two calls would have returned `nil`.

Fixes #43312

### Other Information

This logic comes with a performance impact on the reader,
here is the benchmark:

    Warming up --------------------------------------
            original   238.780k i/100ms
             patched   162.765k i/100ms
    Calculating -------------------------------------
            original    2.376M (± 9.4%) i/s -  11.939M in 5.078355s
             patched    1.635M (±16.4%) i/s -   7.813M in 5.008433s

    Comparison:
            original:  2375953.1 i/s
             patched:  1634668.2 i/s - 1.45x  (± 0.00) slower

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->

<!--
Note: Please avoid making *Draft* pull requests, as they still send
notifications to everyone watching the Rails repo.
Create a pull request when it is ready for review and feedback
from the Rails team :).
-->
",https://api.github.com/repos/rails/rails/issues/43337/timeline,,tdeo,6230277,MDQ6VXNlcjYyMzAyNzc=,https://avatars.githubusercontent.com/u/6230277?v=4,,https://api.github.com/users/tdeo,https://github.com/tdeo,https://api.github.com/users/tdeo/followers,https://api.github.com/users/tdeo/following{/other_user},https://api.github.com/users/tdeo/gists{/gist_id},https://api.github.com/users/tdeo/starred{/owner}{/repo},https://api.github.com/users/tdeo/subscriptions,https://api.github.com/users/tdeo/orgs,https://api.github.com/users/tdeo/repos,https://api.github.com/users/tdeo/events{/privacy},https://api.github.com/users/tdeo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43337/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43337,https://github.com/rails/rails/pull/43337,https://github.com/rails/rails/pull/43337.diff,https://github.com/rails/rails/pull/43337.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
298,https://api.github.com/repos/rails/rails/issues/43332,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43332/labels{/name},https://api.github.com/repos/rails/rails/issues/43332/comments,https://api.github.com/repos/rails/rails/issues/43332/events,https://github.com/rails/rails/issues/43332,1010927731,I_kwDNIULOPEGIcw,43332,Child controller's before action is overridden by parent,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,9,2021-09-29T12:59:42Z,2021-10-04T19:41:21Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""action_controller/railtie""
require 'rails/test_help'
class TestApp < Rails::Application
  config.root = __dir__
  config.hosts << ""www.example.com""
  secrets.secret_key_base = ""secret_key_base""

  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    get ""/child_index"" => ""child#index""
    get ""/child_show"" => ""child#show""
    get ""/base_index"" => ""base#index""
    get ""/base_show"" => ""base#show""
  end
end

class BaseController < ActionController::Base
  def index
    render plain: ""BaseController#index""
  end

  def show
    render plain: ""BaseController#show""
  end
end

class ChildController < BaseController
  def index
    render plain: ""ChildController#index""
  end

  def show
    render plain: ""ChildController#show""
  end
end

module ChildControllerDecorator
  def self.prepended(base)
    base.before_action :set_instance_var, only: :index
  end

  def set_instance_var
    @instance_var = :index
  end
end
ChildController.prepend(ChildControllerDecorator)

module BaseControllerDecorator
  def self.prepended(base)
    base.before_action :set_instance_var, only: :show
  end

  def set_instance_var
    @instance_var = :show
  end
end
BaseController.prepend(BaseControllerDecorator)

require ""minitest/autorun""

class ChildControllerTest < ActionDispatch::IntegrationTest
  
  test ""instance var should equal to :index when child index action is invoked"" do
    get ""/child_index""
    assert_equal :index, @controller.instance_variable_get(:@instance_var)
  end

  test ""instance var should equal to :nil when child show action is invoked"" do
    get ""/child_show""
    assert_equal nil, @controller.instance_variable_get(:@instance_var)
  end

  private
    def app
      Rails.application
    end
end
```

### Expected behavior
ChildController's before action should not be overridden by parent.  In the test case, @instance_var should be set to `:index`, and only be set when `index` action is executed. 

### Actual behavior
ChildController's before action is overridden by parent.  wrong execution condition and value.

### System configuration
**Rails version**: `main` branch

**Ruby version**: 2.7.2

In order to figure it out, I read the source code. It seems every time the `before_action` or `prepend_before_action` is executed, there is a operation called `remove_duplicates` which remove the filters with the same name from itself and its descendants. It should not remove filters with the same name from its descendants, right?

",https://api.github.com/repos/rails/rails/issues/43332/timeline,,samzhao2008,4662444,MDQ6VXNlcjQ2NjI0NDQ=,https://avatars.githubusercontent.com/u/4662444?v=4,,https://api.github.com/users/samzhao2008,https://github.com/samzhao2008,https://api.github.com/users/samzhao2008/followers,https://api.github.com/users/samzhao2008/following{/other_user},https://api.github.com/users/samzhao2008/gists{/gist_id},https://api.github.com/users/samzhao2008/starred{/owner}{/repo},https://api.github.com/users/samzhao2008/subscriptions,https://api.github.com/users/samzhao2008/orgs,https://api.github.com/users/samzhao2008/repos,https://api.github.com/users/samzhao2008/events{/privacy},https://api.github.com/users/samzhao2008/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43332/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
299,https://api.github.com/repos/rails/rails/issues/43330,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43330/labels{/name},https://api.github.com/repos/rails/rails/issues/43330/comments,https://api.github.com/repos/rails/rails/issues/43330/events,https://github.com/rails/rails/pull/43330,1010659041,PR_kwDNIULOLG-EFA,43330,add section for host header attack prevention in rails security guide,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,3,2021-09-29T08:33:04Z,2022-04-12T17:47:27Z,,NONE,,"This PR fixes rails/rails#42817

It is also fixes a related issue in the rails configuration guide about the HostAuthorization middleware - https://edgeguides.rubyonrails.org/configuring.html#actiondispatch-hostauthorization",https://api.github.com/repos/rails/rails/issues/43330/timeline,,aka47,7011,MDQ6VXNlcjcwMTE=,https://avatars.githubusercontent.com/u/7011?v=4,,https://api.github.com/users/aka47,https://github.com/aka47,https://api.github.com/users/aka47/followers,https://api.github.com/users/aka47/following{/other_user},https://api.github.com/users/aka47/gists{/gist_id},https://api.github.com/users/aka47/starred{/owner}{/repo},https://api.github.com/users/aka47/subscriptions,https://api.github.com/users/aka47/orgs,https://api.github.com/users/aka47/repos,https://api.github.com/users/aka47/events{/privacy},https://api.github.com/users/aka47/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43330/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43330,https://github.com/rails/rails/pull/43330,https://github.com/rails/rails/pull/43330.diff,https://github.com/rails/rails/pull/43330.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
300,https://api.github.com/repos/rails/rails/issues/43312,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43312/labels{/name},https://api.github.com/repos/rails/rails/issues/43312/comments,https://api.github.com/repos/rails/rails/issues/43312/events,https://github.com/rails/rails/issues/43312,1008053433,I_kwDNIULOPBWsuQ,43312,`thread_mattr_accessor` default value does not apply to threads,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,9,2021-09-27T11:52:11Z,2021-09-30T14:18:35Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""active_support/core_ext/module/attribute_accessors_per_thread""
require ""minitest/autorun""

class BugTest < Minitest::Test
  class ThreadAccessors
    thread_mattr_accessor :variable, default: 42
  end

  def test_stuff
    assert(ThreadAccessors.variable == 42)
    Thread.new do
      assert(ThreadAccessors.variable == 42)
    end.join
  end
end
```

### Expected behavior
<!-- Tell us what should happen -->

I'd expect the default value for the thread variable to be present in all threads

### Actual behavior
<!-- Tell us what happens instead -->

The variable is initialized only in the main thread at load time and `nil` in other threads

### System configuration
**Rails version**: main branch

**Ruby version**: ruby 3.0.2p107 (2021-07-07 revision 0db68f0233) [x86_64-linux]
",https://api.github.com/repos/rails/rails/issues/43312/timeline,,tdeo,6230277,MDQ6VXNlcjYyMzAyNzc=,https://avatars.githubusercontent.com/u/6230277?v=4,,https://api.github.com/users/tdeo,https://github.com/tdeo,https://api.github.com/users/tdeo/followers,https://api.github.com/users/tdeo/following{/other_user},https://api.github.com/users/tdeo/gists{/gist_id},https://api.github.com/users/tdeo/starred{/owner}{/repo},https://api.github.com/users/tdeo/subscriptions,https://api.github.com/users/tdeo/orgs,https://api.github.com/users/tdeo/repos,https://api.github.com/users/tdeo/events{/privacy},https://api.github.com/users/tdeo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43312/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
301,https://api.github.com/repos/rails/rails/issues/43293,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43293/labels{/name},https://api.github.com/repos/rails/rails/issues/43293/comments,https://api.github.com/repos/rails/rails/issues/43293/events,https://github.com/rails/rails/pull/43293,1005272376,PR_kwDNIULOLC69MQ,43293,Escape anchor once in #url_for with Hash syntax,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,9,2021-09-23T10:36:10Z,2022-04-04T16:37:09Z,,CONTRIBUTOR,,"### Summary

Fixes #43289

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/43293/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43293/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43293,https://github.com/rails/rails/pull/43293,https://github.com/rails/rails/pull/43293.diff,https://github.com/rails/rails/pull/43293.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
302,https://api.github.com/repos/rails/rails/issues/43289,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43289/labels{/name},https://api.github.com/repos/rails/rails/issues/43289/comments,https://api.github.com/repos/rails/rails/issues/43289/events,https://github.com/rails/rails/issues/43289,1004487586,I_kwDNIULOO99Dog,43289,`path_for` escapes anchor/fragment twice,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,5,2021-09-22T16:20:04Z,2022-03-10T20:52:05Z,,NONE,,"Not sure if this is a bug, but it looks like `path_for` escapes anchors twice. The issue seems to be in [`add_anchor`](https://github.com/rails/rails/blob/4e35354917325eee35c66a352e26ab4794756383/actionpack/lib/action_dispatch/http/url.rb#L91), which escapes the return value of `to_param` (aka `to_query`) which seems to already escape the string [here](https://github.com/rails/rails/blob/4e35354917325eee35c66a352e26ab4794756383/activesupport/lib/active_support/core_ext/object/to_query.rb#L14).

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
ActionDispatch::Http::URL.path_for(anchor: { foo: '%' }) # => ""#foo=%2525""
```

### Expected behavior
The above code should return `""#foo=%25""` (percent sign encoded once)

### Actual behavior
The above code returns `#foo=%2525` (percent sign encoded twice)

### System configuration
**Rails version**: 6.1.4.1
**Ruby version**: 2.6.5

",https://api.github.com/repos/rails/rails/issues/43289/timeline,,Peleg,3848185,MDQ6VXNlcjM4NDgxODU=,https://avatars.githubusercontent.com/u/3848185?v=4,,https://api.github.com/users/Peleg,https://github.com/Peleg,https://api.github.com/users/Peleg/followers,https://api.github.com/users/Peleg/following{/other_user},https://api.github.com/users/Peleg/gists{/gist_id},https://api.github.com/users/Peleg/starred{/owner}{/repo},https://api.github.com/users/Peleg/subscriptions,https://api.github.com/users/Peleg/orgs,https://api.github.com/users/Peleg/repos,https://api.github.com/users/Peleg/events{/privacy},https://api.github.com/users/Peleg/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43289/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
303,https://api.github.com/repos/rails/rails/issues/43231,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43231/labels{/name},https://api.github.com/repos/rails/rails/issues/43231/comments,https://api.github.com/repos/rails/rails/issues/43231/events,https://github.com/rails/rails/issues/43231,998493367,I_kwDNIULOO4PMtw,43231,Migration errors from active storage after rails master to rails alpha migration with app:update ,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,9,2021-09-16T18:12:28Z,2021-09-20T12:15:02Z,,NONE,,"### Steps to reproduce

<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
<!-- ```ruby
# Your reproduction script goes here
``` -->
1. Create an app with rails at: `01fd264d0012` (with active storage)
2. Update to rails `7.0.0.alpha2`
3. Run migrations

### Expected behavior
<!-- Tell us what should happen -->
Migrations should run without a problem or not be present.

### Actual behavior
<!-- Tell us what happens instead -->
Migrations are present and fail:
```
$ rails app:update
# ... SNIP
Copied migration 20210916174641_add_service_name_to_active_storage_blobs.active_storage.rb from active_storage
Copied migration 20210916174642_create_active_storage_variant_records.active_storage.rb from active_storage

After this, check Rails upgrade guide at https://guides.rubyonrails.org/upgrading_ruby_on_rails.html for more details about upgrading your app.
$ rails db:migrate                                                                   main ✭ ◼
== 20210916174641 AddServiceNameToActiveStorageBlobs: migrating ===============
-- column_exists?(:active_storage_blobs, :service_name)
   -> 0.0175s
== 20210916174641 AddServiceNameToActiveStorageBlobs: migrated (0.0176s) ======

== 20210916174642 CreateActiveStorageVariantRecords: migrating ================
-- create_table(:active_storage_variant_records, {:id=>:primary_key})
rails aborted!
StandardError: An error has occurred, this and all later migrations canceled:

PG::DuplicateTable: ERROR:  relation ""active_storage_variant_records"" already exists
project/db/migrate/20210916174642_create_active_storage_variant_records.active_storage.rb:5:in `change'

Caused by:
ActiveRecord::StatementInvalid: PG::DuplicateTable: ERROR:  relation ""active_storage_variant_records"" already exists
```

The migrations generated are using v6 of rails:
```
class CreateActiveStorageVariantRecords < ActiveRecord::Migration[6.0]
class AddServiceNameToActiveStorageBlobs < ActiveRecord::Migration[6.0]
```

The migration code failing is:

```
 create_table :active_storage_variant_records, id: primary_key_type do |t|
      t.belongs_to :blob, null: false, index: false, type: blobs_primary_key_type
      t.string :variation_digest, null: false

      t.index %i[ blob_id variation_digest ], name: ""index_active_storage_variant_records_uniqueness"", unique: true
      t.foreign_key :active_storage_blobs, column: :blob_id
    end
```

this is already present from a previous migration:
```
create_table :active_storage_variant_records, id: primary_key_type do |t|
      t.belongs_to :blob, null: false, index: false, type: foreign_key_type
      t.string :variation_digest, null: false

      t.index %i[ blob_id variation_digest ], name: ""index_active_storage_variant_records_uniqueness"", unique: true
      t.foreign_key :active_storage_blobs, column: :blob_id
    end
```



### System configuration
**Rails version**:
Described above.
**Ruby version**:
3.0.2",https://api.github.com/repos/rails/rails/issues/43231/timeline,,gingermusketeer,1177034,MDQ6VXNlcjExNzcwMzQ=,https://avatars.githubusercontent.com/u/1177034?v=4,,https://api.github.com/users/gingermusketeer,https://github.com/gingermusketeer,https://api.github.com/users/gingermusketeer/followers,https://api.github.com/users/gingermusketeer/following{/other_user},https://api.github.com/users/gingermusketeer/gists{/gist_id},https://api.github.com/users/gingermusketeer/starred{/owner}{/repo},https://api.github.com/users/gingermusketeer/subscriptions,https://api.github.com/users/gingermusketeer/orgs,https://api.github.com/users/gingermusketeer/repos,https://api.github.com/users/gingermusketeer/events{/privacy},https://api.github.com/users/gingermusketeer/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43231/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
304,https://api.github.com/repos/rails/rails/issues/43194,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43194/labels{/name},https://api.github.com/repos/rails/rails/issues/43194/comments,https://api.github.com/repos/rails/rails/issues/43194/events,https://github.com/rails/rails/issues/43194,992607222,MDU6SXNzdWU5OTI2MDcyMjI=,43194,"When passed index: nil, form builder helpers should not infix name attribute with empty brackets []","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2021-09-09T20:32:19Z,2021-12-08T21:01:28Z,,NONE,,"I have a situation that requires me to explicitly define the named argument `index:` passed to a call of `form_builder.text_field`. The value for `index` is either set or not. If it is set (not nil), then it should take that and place the `[]` infix with the value inside the brackets, for the name attribute of the `<input>` element.

### Steps to reproduce

Have a template that uses `form_for` and under that place a call to: `form.text_field` with an `index: nil` option.

```
<%= form_for :some_model do |form| %>
  <%= form.text_field :something, index: nil %>
<% end %>
```

Steps tracing the output for the name attribute that contains the ""index"":

```
From: [...]/lib/action_view/helpers/tags/base.rb:176 ActionView::Helpers::Tags::Base#name_and_id_index:

    174: def name_and_id_index(options)
    175:   binding.pry
 => 176:   if options.key?(""index"")
    177:     options.delete(""index"") || """"
    178:   elsif @generate_indexed_names
    179:     @auto_index || """"
    180:   end
    181: end

[1] pry(#<ActionView::Helpers::Tags::TextField>)> options
=> {""index""=>nil, ""class""=>""form-control"", ""size""=>nil, ""type""=>""text"", ""value""=>nil}

```

https://github.com/rails/rails/blob/cf99be46c9aec7fe4576da7fc667c4d3994470d2/actionview/lib/action_view/helpers/tags/base.rb#L173-L175

Note `index` is nil in the hash above, `options`. Since the key `index` is defined, it's taking the nil value, but due to short circuit with `||` it makes the function return empty string instead of `nil`.




```
[2] pry(#<ActionView::Helpers::Tags::TextField>)> up

From: [...]/lib/action_view/helpers/tags/base.rb:96 ActionView::Helpers::Tags::Base#add_default_name_and_id:

     95: def add_default_name_and_id(options)
 =>  96:   index = name_and_id_index(options)
     97:   options[""name""] = options.fetch(""name"") { tag_name(options[""multiple""], index) }
     98:
     99:   if generate_ids?
    100:     options[""id""] = options.fetch(""id"") { tag_id(index) }
    101:     if namespace = options.delete(""namespace"")
    102:       options[""id""] = options[""id""] ? ""#{namespace}_#{options['id']}"" : namespace
    103:     end
    104:   end
    105: end
```

https://github.com/rails/rails/blob/cf99be46c9aec7fe4576da7fc667c4d3994470d2/actionview/lib/action_view/helpers/tags/base.rb#L96

`index` in line 96 is then set to empty string `""""`, and a call to `tag_name` is made with the empty string as second argument.

```
[2] pry(#<ActionView::Helpers::Tags::TextField>)> next
[2] pry(#<ActionView::Helpers::Tags::TextField>)> tag_name(options[""multiple""], index)
=> ""some_model[][something]""
[3] pry(#<ActionView::Helpers::Tags::TextField>)> step
[3] pry(#<ActionView::Helpers::Tags::TextField>)> step

From: [...]/lib/action_view/helpers/tags/base.rb:108 ActionView::Helpers::Tags::Base#tag_name:

    107: def tag_name(multiple = false, index = nil)
 => 108:   binding.pry
    109:   # a little duplication to construct fewer strings
    110:   case
    111:   when @object_name.empty?
    112:     ""#{sanitized_method_name}#{multiple ? ""[]"" : """"}""
    113:   when index
    114:     ""#{@object_name}[#{index}][#{sanitized_method_name}]#{multiple ? ""[]"" : """"}""
    115:   else
    116:     ""#{@object_name}[#{sanitized_method_name}]#{multiple ? ""[]"" : """"}""
    117:   end
    118: end

[3] pry(#<ActionView::Helpers::Tags::TextField>)> index
=> """"
[4] pry(#<ActionView::Helpers::Tags::TextField>)> next
[4] pry(#<ActionView::Helpers::Tags::TextField>)> next

From: [...]/lib/action_view/helpers/tags/base.rb:114 ActionView::Helpers::Tags::Base#tag_name:

    107: def tag_name(multiple = false, index = nil)
    108:   binding.pry
    109:   # a little duplication to construct fewer strings
    110:   case
    111:   when @object_name.empty?
    112:     ""#{sanitized_method_name}#{multiple ? ""[]"" : """"}""
    113:   when index
 => 114:     ""#{@object_name}[#{index}][#{sanitized_method_name}]#{multiple ? ""[]"" : """"}""
    115:   else
    116:     ""#{@object_name}[#{sanitized_method_name}]#{multiple ? ""[]"" : """"}""
    117:   end
    118: end
    
```

https://github.com/rails/rails/blob/cf99be46c9aec7fe4576da7fc667c4d3994470d2/actionview/lib/action_view/helpers/tags/base.rb#L107-L113

Because index is passed as empty string (and not `nil`), it goes to the case `when index`, since empty string IS NOT FALSY in Ruby.

That results in an infix `[]` being added to the name attribute string. That would make sense if I had originally passed `index: """"`, but here originally I passed `index: nil`. So I don't think this is the appropriate or correct behavior.

```

[4] pry(#<ActionView::Helpers::Tags::TextField>)> ""#{@object_name}[#{index}][#{sanitized_method_name}]#{multiple ? ""[]"" : """"}""
=> ""some_model[][something]""
```

### Expected behavior

`index: nil` should not add an infix `[]` to the name attribute of the element

In contrast, `index: """"` should place the empty-bracket infix `[]` (this already happens)

### Actual behavior

`index: nil` is adding the infix `[]` to the name attribute of the element

### System configuration
**Rails version**: Rails 7.0.0.alpha.790723b

**Ruby version**: 3.0.0
",https://api.github.com/repos/rails/rails/issues/43194/timeline,,heynan0,58703271,MDQ6VXNlcjU4NzAzMjcx,https://avatars.githubusercontent.com/u/58703271?v=4,,https://api.github.com/users/heynan0,https://github.com/heynan0,https://api.github.com/users/heynan0/followers,https://api.github.com/users/heynan0/following{/other_user},https://api.github.com/users/heynan0/gists{/gist_id},https://api.github.com/users/heynan0/starred{/owner}{/repo},https://api.github.com/users/heynan0/subscriptions,https://api.github.com/users/heynan0/orgs,https://api.github.com/users/heynan0/repos,https://api.github.com/users/heynan0/events{/privacy},https://api.github.com/users/heynan0/received_events,User,True,https://api.github.com/repos/rails/rails/issues/43194/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
305,https://api.github.com/repos/rails/rails/issues/43122,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43122/labels{/name},https://api.github.com/repos/rails/rails/issues/43122/comments,https://api.github.com/repos/rails/rails/issues/43122/events,https://github.com/rails/rails/pull/43122,981831678,MDExOlB1bGxSZXF1ZXN0NzIxNzg0MDU0,43122,Reset `has_one` association when the related `belongs_to` association is set,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2021-08-28T13:11:42Z,2022-04-04T16:37:26Z,,CONTRIBUTOR,,"### Summary

When setting a `belongs_to` association the inverse `has_one` association is reset.

Example:

```ruby
jimmy = Author.create(name: ""Jimmy Tolkien"")
david = Author.create(name: ""DHH"")
post = jimmy.create_post(title: ""The silly medallion"", body: """")
jimmy.post.update!(author: david)
assert_nil jimmy.post
```

Fixes #43096

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->


<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/43122/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43122/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43122,https://github.com/rails/rails/pull/43122,https://github.com/rails/rails/pull/43122.diff,https://github.com/rails/rails/pull/43122.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
306,https://api.github.com/repos/rails/rails/issues/43096,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43096/labels{/name},https://api.github.com/repos/rails/rails/issues/43096/comments,https://api.github.com/repos/rails/rails/issues/43096/events,https://github.com/rails/rails/issues/43096,979050652,MDU6SXNzdWU5NzkwNTA2NTI=,43096,Kind of caching issue updating has_one association,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,9,2021-08-25T11:50:22Z,2022-03-10T20:51:26Z,,NONE,,"We run into an issue updating a has_one association. This is broken since Rails 6.0.4.

### Steps to reproduce

```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", ""6.0.3.7""
  gem ""sqlite3""
  gem ""nokogiri"", ""1.11.7"" # needed for my local setup
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :debtors, force: true do |t|
    t.string :name
  end

  create_table :mandates, force: true do |t|
    t.integer :debtor_id
  end
end

class Debtor < ActiveRecord::Base
  has_one :mandate
end

class Mandate < ActiveRecord::Base
  belongs_to :debtor
end

class BugTest < Minitest::Test
  def test_association_stuff
    debtor1 = Debtor.create!(name: ""John"")
    debtor2 = Debtor.create!(name: ""DHH"")
    Mandate.create!(debtor: debtor1)

    debtor1.mandate.update!(debtor: debtor2)
    debtor1.update!(name: ""Jonas"")

    assert_equal false, Mandate.find_by(debtor: debtor1).present?
  end
end
```
In Rails 6.0.3.7 the example succeeds, but in Rails 6.0.4 the example fails and the debtor is not changed on the mandate object.

### Expected behavior
When I update a has_one association followed by an update of an attribute of the object, it does not revert the change on the has_one association.

### Actual behavior
It reverts the change on the has_one association after updating an attribute.

### System configuration
**Rails version**:
6.0.4
**Ruby version**:
2.6.6",https://api.github.com/repos/rails/rails/issues/43096/timeline,,MathijsK93,1533307,MDQ6VXNlcjE1MzMzMDc=,https://avatars.githubusercontent.com/u/1533307?v=4,,https://api.github.com/users/MathijsK93,https://github.com/MathijsK93,https://api.github.com/users/MathijsK93/followers,https://api.github.com/users/MathijsK93/following{/other_user},https://api.github.com/users/MathijsK93/gists{/gist_id},https://api.github.com/users/MathijsK93/starred{/owner}{/repo},https://api.github.com/users/MathijsK93/subscriptions,https://api.github.com/users/MathijsK93/orgs,https://api.github.com/users/MathijsK93/repos,https://api.github.com/users/MathijsK93/events{/privacy},https://api.github.com/users/MathijsK93/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43096/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
307,https://api.github.com/repos/rails/rails/issues/43085,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43085/labels{/name},https://api.github.com/repos/rails/rails/issues/43085/comments,https://api.github.com/repos/rails/rails/issues/43085/events,https://github.com/rails/rails/pull/43085,977649240,MDExOlB1bGxSZXF1ZXN0NzE4MzYzNjMw,43085,Add support for array syntax on enums backed by string columns,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2021-08-24T02:49:58Z,2022-02-08T18:32:00Z,,CONTRIBUTOR,,"If you create an enum backed by a string column, you can use the following
syntax:

```ruby
class Book < ActiveRecord::Base
  enum cover: [:hard, :soft]
end
```

It will behave like this:

```ruby
class Book < ActiveRecord::Base
  enum cover: { hard: ""hard"", soft: ""soft"" }
end
```

This feature doesn't affect enums backed by integer columns.",https://api.github.com/repos/rails/rails/issues/43085/timeline,,MatheusRich,20938712,MDQ6VXNlcjIwOTM4NzEy,https://avatars.githubusercontent.com/u/20938712?v=4,,https://api.github.com/users/MatheusRich,https://github.com/MatheusRich,https://api.github.com/users/MatheusRich/followers,https://api.github.com/users/MatheusRich/following{/other_user},https://api.github.com/users/MatheusRich/gists{/gist_id},https://api.github.com/users/MatheusRich/starred{/owner}{/repo},https://api.github.com/users/MatheusRich/subscriptions,https://api.github.com/users/MatheusRich/orgs,https://api.github.com/users/MatheusRich/repos,https://api.github.com/users/MatheusRich/events{/privacy},https://api.github.com/users/MatheusRich/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43085/reactions,8,8,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43085,https://github.com/rails/rails/pull/43085,https://github.com/rails/rails/pull/43085.diff,https://github.com/rails/rails/pull/43085.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
308,https://api.github.com/repos/rails/rails/issues/43059,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43059/labels{/name},https://api.github.com/repos/rails/rails/issues/43059/comments,https://api.github.com/repos/rails/rails/issues/43059/events,https://github.com/rails/rails/issues/43059,975763720,MDU6SXNzdWU5NzU3NjM3MjA=,43059,"""No connection pool for 'ApplicationRecord'"" errors from ActiveRecord::Migration::CheckPending","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,4,2021-08-20T16:40:28Z,2022-04-07T13:01:22Z,,CONTRIBUTOR,,"### Steps to reproduce

* Checkout https://github.com/jdelStrother/migration-pool
* `bundle install`, `bin/rails db:reset`, `bin/rails server`
* Visit http://127.0.0.1:3000
* Check out main~1 (resulting in a change in db/migrate), and reload http://127.0.0.1:3000

### Expected behavior
The page refreshes without error, (or produces a message about having pending migrations)

### Actual behavior
This results in ActiveRecord::ConnectionNotEstablished - ""No connection pool for 'ApplicationRecord'"" found from the migration-checker middleware:
<details>
  <summary>Sample stacktrace</summary>

```
activerecord (6.1.5) lib/active_record/connection_adapters/abstract/connection_pool.rb:1125:in `retrieve_connection'
activerecord (6.1.5) lib/active_record/connection_handling.rb:327:in `retrieve_connection'
activerecord (6.1.5) lib/active_record/connection_handling.rb:283:in `connection'
activerecord (6.1.5) lib/active_record/model_schema.rb:380:in `table_exists?'
activerecord (6.1.5) lib/active_record/migration.rb:1108:in `get_all_versions'
activerecord (6.1.5) lib/active_record/migration.rb:1121:in `needs_migration?'
activerecord (6.1.5) lib/active_record/migration.rb:625:in `check_pending!'
activerecord (6.1.5) lib/active_record/migration.rb:590:in `block (2 levels) in call'
activesupport (6.1.5) lib/active_support/evented_file_update_checker.rb:59:in `execute'
activesupport (6.1.5) lib/active_support/evented_file_update_checker.rb:65:in `execute_if_updated'
activerecord (6.1.5) lib/active_record/migration.rb:597:in `block in call'
activerecord (6.1.5) lib/active_record/migration.rb:587:in `synchronize'
activerecord (6.1.5) lib/active_record/migration.rb:587:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/callbacks.rb:27:in `block in call'
activesupport (6.1.5) lib/active_support/callbacks.rb:98:in `run_callbacks'
actionpack (6.1.5) lib/action_dispatch/middleware/callbacks.rb:26:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/executor.rb:14:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/actionable_exceptions.rb:18:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/debug_exceptions.rb:29:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/show_exceptions.rb:33:in `call'
railties (6.1.5) lib/rails/rack/logger.rb:37:in `call_app'
railties (6.1.5) lib/rails/rack/logger.rb:26:in `block in call'
activesupport (6.1.5) lib/active_support/tagged_logging.rb:99:in `block in tagged'
activesupport (6.1.5) lib/active_support/tagged_logging.rb:37:in `tagged'
activesupport (6.1.5) lib/active_support/tagged_logging.rb:99:in `tagged'
railties (6.1.5) lib/rails/rack/logger.rb:26:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/remote_ip.rb:81:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/request_id.rb:26:in `call'
rack (2.2.3) lib/rack/method_override.rb:24:in `call'
rack (2.2.3) lib/rack/runtime.rb:22:in `call'
activesupport (6.1.5) lib/active_support/cache/strategy/local_cache_middleware.rb:29:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/executor.rb:14:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/static.rb:24:in `call'
rack (2.2.3) lib/rack/sendfile.rb:110:in `call'
actionpack (6.1.5) lib/action_dispatch/middleware/host_authorization.rb:148:in `call'
railties (6.1.5) lib/rails/engine.rb:539:in `call'
puma (5.4.0) lib/puma/configuration.rb:249:in `call'
puma (5.4.0) lib/puma/request.rb:77:in `block in handle_request'
puma (5.4.0) lib/puma/thread_pool.rb:340:in `with_force_shutdown'
puma (5.4.0) lib/puma/request.rb:76:in `handle_request'
puma (5.4.0) lib/puma/server.rb:440:in `process_client'
puma (5.4.0) lib/puma/thread_pool.rb:147:in `block in spawn_thread'
```

</details>

---

The problem appears to be that the migration connection has a reference to ApplicationRecord, but it's a old reference from before class reloading kicked in, so `self == ApplicationRecord` is no longer true, resulting in connection_specification_name returning `""ApplicationRecord""` rather than the expected `""ActiveRecord::Base""`

One potential fix that seems to work for me is to reimplement `ActiveRecord::Base.primary_class?` from this: https://github.com/rails/rails/blob/e7b0eddc70bf516bed56f892a40c57e8ddec559f/activerecord/lib/active_record/connection_handling.rb#L296-L298 to this:

```ruby
def primary_class?
  self == Base || self.name == ""ApplicationRecord""
end
```

---

It looks like in edge-rails that's moved here: https://github.com/rails/rails/blob/e9f38a164e36104cc495d5ac5859e57f6be75f36/activerecord/lib/active_record/core.rb#L80-L88 but I think the logic still stands.

@eileencodes WDYT to changing that to something like the following?

```diff
def self.application_record_class? # :nodoc:
   if ActiveRecord.application_record_class
     self == ActiveRecord.application_record_class
   else
-    if defined?(ApplicationRecord) && self == ApplicationRecord
-      true
-    end
+    self.name == ""ApplicationRecord""
   end
 end
```

[EDIT: Although, hmm... seems like you'd also need the `.name` comparison for the application_record_class]


### System configuration
**Rails version**: 6.1.5

**Ruby version**: 2.7.4
",https://api.github.com/repos/rails/rails/issues/43059/timeline,,jdelStrother,2377,MDQ6VXNlcjIzNzc=,https://avatars.githubusercontent.com/u/2377?v=4,,https://api.github.com/users/jdelStrother,https://github.com/jdelStrother,https://api.github.com/users/jdelStrother/followers,https://api.github.com/users/jdelStrother/following{/other_user},https://api.github.com/users/jdelStrother/gists{/gist_id},https://api.github.com/users/jdelStrother/starred{/owner}{/repo},https://api.github.com/users/jdelStrother/subscriptions,https://api.github.com/users/jdelStrother/orgs,https://api.github.com/users/jdelStrother/repos,https://api.github.com/users/jdelStrother/events{/privacy},https://api.github.com/users/jdelStrother/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43059/reactions,3,3,0,0,0,0,0,0,0,,,,,,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
309,https://api.github.com/repos/rails/rails/issues/43056,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43056/labels{/name},https://api.github.com/repos/rails/rails/issues/43056/comments,https://api.github.com/repos/rails/rails/issues/43056/events,https://github.com/rails/rails/issues/43056,975319142,MDU6SXNzdWU5NzUzMTkxNDI=,43056,ActiveRecord::StatementInvalid error for Rails 6.1 HABTM relationship with particular model name (but fine in Rails 6.0),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,14,2021-08-20T06:48:09Z,2022-02-01T23:08:16Z,,NONE,,"I recently updated my app from Rails 6.0 to Rails 6.1 and ran into an error with a has_and_belongs_to_many relationship for a model called ""EnabledDynamicField"".  I can reproduce this issue in an isolated context in a new Rails 6.1 app.

In the reproduction case below, I'm including other models called ""Apple"" and ""Zebra"" to demonstrate that alphabetical sorting in derived join table names doesn't seem to be related, and to show that a has_and_belongs_to_many relationship between the Apple and Zebra models, by comparison, doesn't produce any errors.

### Steps to reproduce

Create a new Rails 6.1 app (tested with Rails 6.1.4.1) and add following files:
```ruby
# db/migrate/20210820050644_create_tables.rb
class CreateTables < ActiveRecord::Migration[6.0]
  def change
    create_table :apples do |t|
      t.timestamps
    end

    create_table :zebras do |t|
      t.timestamps
    end

    create_join_table :apples, :zebras do |t|
      t.index :apple_id, name: 'apple_id_app_zeb_join'
      t.index :zebra_id, name: 'zebra_id_app_zeb_join'
    end

    create_table :enabled_dynamic_fields do |t|
      t.timestamps
    end

    create_join_table :apples, :enabled_dynamic_fields do |t|
      t.index :apple_id, name: 'apple_id_app_edf_join'
      t.index :enabled_dynamic_field_id, name: 'enabled_dynamic_field_id_app_edf_join'
    end

    create_join_table :enabled_dynamic_fields, :zebras do |t|
      t.index :enabled_dynamic_field_id, name: 'enabled_dynamic_field_id_edf_zeb_join'
      t.index :zebra_id, name: 'zebra_id_edf_zeb_join'
    end
  end
end

# app/models/apple.rb
class Apple < ApplicationRecord
  has_and_belongs_to_many :enabled_dynamic_fields
  has_and_belongs_to_many :zebras
end

# app/models/zebra.rb
class Zebra < ApplicationRecord
  has_and_belongs_to_many :apples
  has_and_belongs_to_many :enabled_dynamic_fields
end

# app/models/enabled_dynamic_field.rb
class EnabledDynamicField < ApplicationRecord
  has_and_belongs_to_many :apples
  has_and_belongs_to_many :zebras
end

# test/models/habtm_join_test.rb
require ""test_helper""

class HabtmJoinTest < ActiveSupport::TestCase
  test ""Apple has_and_belongs_to_many Zebras relationship exists"" do
    apple = Apple.create!
    assert apple.zebras.length == 0
  end

  test ""Zebra has_and_belongs_to_many Apples relationship exists"" do
    zebra = Zebra.create!
    assert zebra.apples.length == 0
  end

  test ""Apple has_and_belongs_to_many EnabledDynamicFields relationship exists"" do
    apple = Apple.create!
    assert apple.enabled_dynamic_fields.length == 0
  end

  test ""EnabledDynamicField has_and_belongs_to_many Apples relationship exists"" do
    enabled_dynamic_field = EnabledDynamicField.create!
    assert enabled_dynamic_field.apples.length == 0
  end

  test ""Zebra has_and_belongs_to_many EnabledDynamicFields relationship exists"" do
    zebra = Zebra.create!
    assert zebra.enabled_dynamic_fields.length == 0
  end

  test ""EnabledDynamicField has_and_belongs_to_many Zebras relationship exists"" do
    enabled_dynamic_field = EnabledDynamicField.create!
    assert enabled_dynamic_field.zebras.length == 0
  end
end
```

Run tests:
```
RAILS_ENV=test ./bin/rails db:migrate
./bin/rails test
```

If you create the above files and run the tests in a Rails 6.0 app, they all pass.  If you do the same thing in Rails 6.1, a couple of tests fail -- and to make matters worse it's not always the same tests (and not always the same error messages).  Here are some sample runs:

```
% ./bin/rails test
Running via Spring preloader in process 42365
Run options: --seed 63981

# Running:

..E

Error:
HabtmJoinTest#test_Apple_has_and_belongs_to_many_EnabledDynamicFields_relationship_exists:
ArgumentError: invalid byte sequence in UTF-8
    test/models/habtm_join_test.rb:16:in `block in <class:HabtmJoinTest>'


rails test test/models/habtm_join_test.rb:14

.E

Error:
HabtmJoinTest#test_Zebra_has_and_belongs_to_many_EnabledDynamicFields_relationship_exists:
ActiveRecord::StatementInvalid: SQLite3::SQLException: unrecognized token: """"""
    test/models/habtm_join_test.rb:26:in `block in <class:HabtmJoinTest>'


rails test test/models/habtm_join_test.rb:24

.

Finished in 0.304887s, 19.6794 runs/s, 13.1196 assertions/s.
6 runs, 4 assertions, 0 failures, 2 errors, 0 skips
```

And here's another run where the same tests are failing, but the error message is different for one of them (changed from `invalid byte sequence` to `unrecognized token`:
```
% ./bin/rails test
Running via Spring preloader in process 42569
Run options: --seed 42091

# Running:

..E

Error:
HabtmJoinTest#test_Zebra_has_and_belongs_to_many_EnabledDynamicFields_relationship_exists:
ActiveRecord::StatementInvalid: SQLite3::SQLException: unrecognized token: ""'enabled_dynamic_field_id""
    test/models/habtm_join_test.rb:26:in `block in <class:HabtmJoinTest>'


rails test test/models/habtm_join_test.rb:24

..E

Error:
HabtmJoinTest#test_Apple_has_and_belongs_to_many_EnabledDynamicFields_relationship_exists:
ActiveRecord::StatementInvalid: SQLite3::SQLException: unrecognized token: ""'enabled_dynamic_field_id""
    test/models/habtm_join_test.rb:16:in `block in <class:HabtmJoinTest>'


rails test test/models/habtm_join_test.rb:14



Finished in 0.203738s, 29.4496 runs/s, 19.6331 assertions/s.
6 runs, 4 assertions, 0 failures, 2 errors, 0 skips
```

And here's another run where only one test failed:
```
% ./bin/rails test
Running via Spring preloader in process 42484
Run options: --seed 5607

# Running:

...E

Error:
HabtmJoinTest#test_Apple_has_and_belongs_to_many_EnabledDynamicFields_relationship_exists:
ActiveRecord::StatementInvalid: SQLite3::SQLException: unrecognized token: """"""
    test/models/habtm_join_test.rb:16:in `block in <class:HabtmJoinTest>'


rails test test/models/habtm_join_test.rb:14

..

Finished in 0.253679s, 23.6519 runs/s, 19.7099 assertions/s.
6 runs, 5 assertions, 0 failures, 1 errors, 0 skips
```

And yet another run where there was only one failure:
```
% ./bin/rails test
Running via Spring preloader in process 42543
Run options: --seed 17029

# Running:

...E

Error:
HabtmJoinTest#test_Zebra_has_and_belongs_to_many_EnabledDynamicFields_relationship_exists:
ActiveRecord::StatementInvalid: SQLite3::SQLException: unrecognized token: """"""
    test/models/habtm_join_test.rb:26:in `block in <class:HabtmJoinTest>'


rails test test/models/habtm_join_test.rb:24

..

Finished in 0.205232s, 29.2352 runs/s, 24.3627 assertions/s.
6 runs, 5 assertions, 0 failures, 1 errors, 0 skips
```

Here's some additional info output from the rails console (in Rails 6.1):
```
2.6.4 :001 > apple = Apple.create!
   (0.5ms)  SELECT sqlite_version(*)
  TRANSACTION (0.1ms)  begin transaction
  Apple Create (0.7ms)  INSERT INTO ""apples"" (""created_at"", ""updated_at"") VALUES (?, ?)  [[""created_at"", ""2021-08-20 06:38:03.350455""], [""updated_at"", ""2021-08-20 06:38:03.350455""]]
  TRANSACTION (2.8ms)  commit transaction
 => #<Apple id: 2, created_at: ""2021-08-20 06:38:03.350455000 +0000"", updated_at: ""2021-08-20 06:38:03.350455000 +0000"">
2.6.4 :002 > apple.enabled_dynamic_fields.length == 0
Traceback (most recent call last):
        1: from (irb):2
ActiveRecord::StatementInvalid (SQLite3::SQLException: unrecognized token: ""'"")
```
And:
```
2.6.4 :001 > zebra = Zebra.create!
   (0.5ms)  SELECT sqlite_version(*)
  TRANSACTION (0.1ms)  begin transaction
  Zebra Create (0.5ms)  INSERT INTO ""zebras"" (""created_at"", ""updated_at"") VALUES (?, ?)  [[""created_at"", ""2021-08-20 06:39:02.020261""], [""updated_at"", ""2021-08-20 06:39:02.020261""]]
  TRANSACTION (0.8ms)  commit transaction
 => #<Zebra id: 5, created_at: ""2021-08-20 06:39:02.020261000 +0000"", updated_at: ""2021-08-20 06:39:02.020261000 +0000"">
2.6.4 :002 > zebra.enabled_dynamic_fields.length == 0
Traceback (most recent call last):
        1: from (irb):2
ArgumentError (invalid byte sequence in UTF-8)
```

So there's something that Rails doesn't like about the EnabledDynamicField model.

### Expected behavior
Since the above steps worked in Rails 6.0, I also expected them to work in Rails 6.1.

### Actual behavior
Fine in Rails 6.0, errors in Rails 6.1.

### System configuration

**Rails version**: 6.1.4.1
**Ruby version**: 2.6.4p104
**Database adapter**: sqlite3
",https://api.github.com/repos/rails/rails/issues/43056/timeline,,elohanlon,1017323,MDQ6VXNlcjEwMTczMjM=,https://avatars.githubusercontent.com/u/1017323?v=4,,https://api.github.com/users/elohanlon,https://github.com/elohanlon,https://api.github.com/users/elohanlon/followers,https://api.github.com/users/elohanlon/following{/other_user},https://api.github.com/users/elohanlon/gists{/gist_id},https://api.github.com/users/elohanlon/starred{/owner}{/repo},https://api.github.com/users/elohanlon/subscriptions,https://api.github.com/users/elohanlon/orgs,https://api.github.com/users/elohanlon/repos,https://api.github.com/users/elohanlon/events{/privacy},https://api.github.com/users/elohanlon/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43056/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
310,https://api.github.com/repos/rails/rails/issues/43019,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43019/labels{/name},https://api.github.com/repos/rails/rails/issues/43019/comments,https://api.github.com/repos/rails/rails/issues/43019/events,https://github.com/rails/rails/pull/43019,971223311,MDExOlB1bGxSZXF1ZXN0NzEzMDAxMTMz,43019,Add support for HTML attributes of optgroups to select helper,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,[],,4,2021-08-15T21:02:05Z,2022-02-14T14:51:28Z,,CONTRIBUTOR,,"PR #11517 updated `grouped_options_for_select` to allow passing HTML attributes of the optgroup as the last element of each array, which is called internally by `select` when it detects grouped choices.

However, the `select` helper detected grouped choices by seeing if the [last element is an Array](https://github.com/rails/rails/blob/6ec669b65d5cd47c984661920d670faccbf0920a/actionview/lib/action_view/helpers/tags/select.rb#L37), meaning if you passed a hash of HTML attributes, it would no longer treat the choices as grouped. This conflicted with `grouped_options_for_select`, which assumes the individual options are the [second element](https://github.com/rails/rails/blob/6ec669b65d5cd47c984661920d670faccbf0920a/actionview/lib/action_view/helpers/form_options_helper.rb#L546), not the last element.

Now there's agreement between `select` and `grouped_options_for_select` in expecting the individual option choices to be the second element, allowing the hash of HTML attributes to exist as the last element and properly trigger grouped options.

Since this mismatch existed since v4.1 (when #11517 was merged), if this can be backported to at least v6.1, that'd be much appreciated to avoid having to wait for v7.0 to be released to take advantage of.

Thanks!
",https://api.github.com/repos/rails/rails/issues/43019/timeline,,cgunther,107416,MDQ6VXNlcjEwNzQxNg==,https://avatars.githubusercontent.com/u/107416?v=4,,https://api.github.com/users/cgunther,https://github.com/cgunther,https://api.github.com/users/cgunther/followers,https://api.github.com/users/cgunther/following{/other_user},https://api.github.com/users/cgunther/gists{/gist_id},https://api.github.com/users/cgunther/starred{/owner}{/repo},https://api.github.com/users/cgunther/subscriptions,https://api.github.com/users/cgunther/orgs,https://api.github.com/users/cgunther/repos,https://api.github.com/users/cgunther/events{/privacy},https://api.github.com/users/cgunther/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43019/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/43019,https://github.com/rails/rails/pull/43019,https://github.com/rails/rails/pull/43019.diff,https://github.com/rails/rails/pull/43019.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
311,https://api.github.com/repos/rails/rails/issues/43014,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43014/labels{/name},https://api.github.com/repos/rails/rails/issues/43014/comments,https://api.github.com/repos/rails/rails/issues/43014/events,https://github.com/rails/rails/issues/43014,971009247,MDU6SXNzdWU5NzEwMDkyNDc=,43014,ActiveRecord raises an ActiveRecord::UnknownAttributeReference error on order of a PostgreSQL json column,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2021-08-14T22:57:06Z,2021-10-21T15:41:10Z,,CONTRIBUTOR,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""pg""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""postgresql"", encoding: ""unicode"", database: ""rails_debug"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  # ... for json datatype:
  create_table :events, force: true do |t|
    t.json 'payload'
  end

  # ... or for jsonb datatype:
  # create_table :events, force: true do |t|
  #   t.jsonb 'payload'
  # end
end

class Event < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_json_unknown_attribute_reference
    Event.create!(payload: { kind: ""user_renamed"", change: [""jack"", ""john""]})

    # PASSING: taken from guides
    assert_equal 1, Event.where(""payload->>'kind' = ?"", ""user_renamed"").count

    # FAILING
    assert_equal 1, Event.order(""payload->>'kind'"").count

    # ActiveRecord::UnknownAttributeReference: Dangerous query method (method whose arguments are used as raw SQL) called with non-attribute argument(s): ""payload->>'kind'"".This method should not be called with user-provided values, such as request parameters or model attributes. Known-safe values can be passed by wrapping them in Arel.sql().

    # PASSING: with Arel.sql
    assert_equal 1, Event.order(Arel.sql(""payload->>'kind'"")).count
  end
end
```

### Expected behavior

Code used here is based on the **Active Record and PostgreSQL** guide, chapter [1.4 JSON and JSONB](https://guides.rubyonrails.org/active_record_postgresql.html#json-and-jsonb)

We can use JSON documents without having to use `Arel.sql` in a `where` condition:

```ruby
Event.where(""payload->>'kind' = ?"", ""user_renamed"")
```

We could expect to use the same syntax for an `order` clause:

```ruby
Event.order(""payload->>'kind'"")
```

### Actual behavior

For now, it raises an `ActiveRecord::UnknownAttributeReference` error:

We explicitly have to wrap it with `Arel.sql`:

```ruby
Event.order(Arel.sql(""payload->>'kind'""))
```

Given the fact that it's not raising errors on `where` clauses, shouldn't it be possible to also directly use JSON documents in an `order` within having to wrap it?

### System configuration

**Rails version**: main branch
**Ruby version**: 2.7.2",https://api.github.com/repos/rails/rails/issues/43014/timeline,,cveneziani,50518,MDQ6VXNlcjUwNTE4,https://avatars.githubusercontent.com/u/50518?v=4,,https://api.github.com/users/cveneziani,https://github.com/cveneziani,https://api.github.com/users/cveneziani/followers,https://api.github.com/users/cveneziani/following{/other_user},https://api.github.com/users/cveneziani/gists{/gist_id},https://api.github.com/users/cveneziani/starred{/owner}{/repo},https://api.github.com/users/cveneziani/subscriptions,https://api.github.com/users/cveneziani/orgs,https://api.github.com/users/cveneziani/repos,https://api.github.com/users/cveneziani/events{/privacy},https://api.github.com/users/cveneziani/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43014/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
312,https://api.github.com/repos/rails/rails/issues/43005,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/43005/labels{/name},https://api.github.com/repos/rails/rails/issues/43005/comments,https://api.github.com/repos/rails/rails/issues/43005/events,https://github.com/rails/rails/issues/43005,968753939,MDU6SXNzdWU5Njg3NTM5Mzk=,43005,Statements with timestamp should not be prepared even if prepared_statements is enabled in mysql2 adapter,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,6,2021-08-12T12:44:14Z,2022-03-11T16:33:11Z,,NONE,,"When `prepared_statements` is enabled in mysql2 adapter, all the statements will be prepared even if the statement is not suitable for being prepared.

For example, the following code will create three prepare statements:
```rb
User.where(id: 1).where('created_at > ?', 1.day.ago)
User.where(id: 1).where('created_at > ?', 1.day.ago)
User.where(id: 1).where('created_at > ?', 1.day.ago)
```
```rb
# See the prepared statements from mysql logs:
ActiveRecord::Base.connection.exec_query(“select event_time, argument from mysql.general_log where command_type = ‘Prepare’ order by event_time desc limit 10”).to_a.each{|s| puts s[‘argument’] } ; nil
# =>
# SELECT `users`.* FROM `users` WHERE `users`.`id` = ? AND (created_at > ‘2021-08-12 11:27:23.936650’)
# SELECT `users`.* FROM `users` WHERE `users`.`id` = ? AND (created_at > ‘2021-08-12 11:26:34.254880’)
# SELECT `users`.* FROM `users` WHERE `users`.`id` = ? AND (created_at > ‘2021-08-12 11:26:17.727167’)
```

The more times it gets executed, the more prepare statements are created. 
The memory usage will keep growing until it reach the limit.

May be related to:
- https://github.com/rails/rails/issues/14645
- https://github.com/rails/rails/issues/21992
- https://github.com/rails/rails/pull/23461

### Steps to reproduce

```rb
MYSQL_DATABASE = 'xxxxx'
MYSQL_USERNAME = 'xxxxx'
MYSQL_PASSWORD = 'xxxxx'
```

```rb

begin
  require 'bundler/inline'
rescue LoadError => e
  warn 'Bundler version 1.10 or later is required. Please update your Bundler'
  raise e
end

gemfile(true) do
  source 'https://rubygems.org'
  gem 'activerecord', '~> 6.1.3'
  gem 'mysql2', '~> 0.5.3'
  gem 'mocha', '~> 1.13.0'
end

require 'active_record'
require 'minitest/autorun'

ActiveRecord::Base.establish_connection(
  'adapter'  => 'mysql2',
  'database' => MYSQL_DATABASE,
  'username' => MYSQL_USERNAME,
  'password' => MYSQL_PASSWORD,
  'host'     => '127.0.0.1',
  'port'     => 3306,
)

ActiveRecord::Schema.define do
  create_table 'users', force: :cascade do |t|
    t.timestamps
  end
end

class ApplicationRecord < ActiveRecord::Base
  self.abstract_class = true
end

class User < ApplicationRecord
end

require 'mocha/minitest'

class BugTest < Minitest::Test
  def setup
    @connection = User.connection
  end

  def test_prepare
    mock_stmt = mock('stmt')
    mock_result = mock('result')
    mock_stmt.expects(:execute).returns(mock_result)
    mock_result.expects(:fields).returns([])
    mock_result.expects(:to_a).returns([])
    mock_result.expects(:free)

    @connection.stubs(:prepared_statements).returns(true)
    @connection.raw_connection.expects(:prepare).returns(mock_stmt)

    User.where(id: 1).to_a
  end

  def test_stmt_no_prepare
    @connection.stubs(:prepared_statements).returns(true)
    @connection.raw_connection.expects(:prepare).never

    User.where(id: 1).where('created_at > ?', 1.days.ago).to_a
  end

  def test_connection_no_prepare
    @connection.stubs(:prepared_statements).returns(false)
    @connection.raw_connection.expects(:prepare).never

    User.where(id: 1).to_a
  end
end
```

### Expected behavior

Expect `Mysql2::Client#prepare` to not be invoked in `test_stmt_no_prepare` test case.

### Actual behavior

```
# Running:

..F

Finished in 0.024949s, 120.2434 runs/s, 240.4867 assertions/s.

  1) Failure:
BugTest#test_stmt_no_prepare [/home/khiav/.rvm/gems/ruby-2.5.5/gems/activerecord-6.1.4/lib/active_record/connection_adapters/mysql/database_statements.rb:169]:
unexpected invocation: #<Mysql2::Client:0x7fffe1902e58>.prepare(""SELECT `users`.* FROM `users` WHERE `users`.`id` = ? AND (created_at > '2021-08-11 12:23:41.809169')"")
unsatisfied expectations:
- expected never, invoked once: #<Mysql2::Client:0x7fffe1902e58>.prepare(any_parameters)
satisfied expectations:
- allowed any number of times, invoked 4 times: #<ActiveRecord::ConnectionAdapters::Mysql2Adapter:0x7fffe19018c8>.prepared_statements(any_parameters)


3 runs, 6 assertions, 1 failures, 0 errors, 0 skips
```

### System configuration
**Rails version**:
6.1.3

**Ruby version**:
ruby 2.5.5p157 (2019-03-15 revision 67260) [x86_64-linux]",https://api.github.com/repos/rails/rails/issues/43005/timeline,,khiav223577,4011729,MDQ6VXNlcjQwMTE3Mjk=,https://avatars.githubusercontent.com/u/4011729?v=4,,https://api.github.com/users/khiav223577,https://github.com/khiav223577,https://api.github.com/users/khiav223577/followers,https://api.github.com/users/khiav223577/following{/other_user},https://api.github.com/users/khiav223577/gists{/gist_id},https://api.github.com/users/khiav223577/starred{/owner}{/repo},https://api.github.com/users/khiav223577/subscriptions,https://api.github.com/users/khiav223577/orgs,https://api.github.com/users/khiav223577/repos,https://api.github.com/users/khiav223577/events{/privacy},https://api.github.com/users/khiav223577/received_events,User,False,https://api.github.com/repos/rails/rails/issues/43005/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,https://api.github.com/repos/rails/rails/milestones/82,https://github.com/rails/rails/milestone/82,https://api.github.com/repos/rails/rails/milestones/82/labels,7758309.0,MI_kwDNIULOAHZh5Q,82.0,7.1.0,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,1.0,0.0,open,2022-03-11T16:33:03Z,2022-03-11T16:33:11Z,,
313,https://api.github.com/repos/rails/rails/issues/42981,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42981/labels{/name},https://api.github.com/repos/rails/rails/issues/42981/comments,https://api.github.com/repos/rails/rails/issues/42981/events,https://github.com/rails/rails/pull/42981,964300001,MDExOlB1bGxSZXF1ZXN0NzA2Nzc3OTc3,42981,Active Storage eager loading: support more methods,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,14,2021-08-09T19:23:26Z,2022-03-08T20:21:37Z,,MEMBER,,"As noted at https://github.com/rails/rails/pull/40842#issuecomment-895231378, the current implementation works great with the `processed` method, but doesn't work with other methods such as `key`. This PR fixes that, by adding the missing `includes` statements.

cc @collimarco",https://api.github.com/repos/rails/rails/issues/42981/timeline,,ghiculescu,509837,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42981/reactions,6,0,0,0,0,0,6,0,0,False,https://api.github.com/repos/rails/rails/pulls/42981,https://github.com/rails/rails/pull/42981,https://github.com/rails/rails/pull/42981.diff,https://github.com/rails/rails/pull/42981.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
314,https://api.github.com/repos/rails/rails/issues/42975,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42975/labels{/name},https://api.github.com/repos/rails/rails/issues/42975/comments,https://api.github.com/repos/rails/rails/issues/42975/events,https://github.com/rails/rails/issues/42975,963670137,MDU6SXNzdWU5NjM2NzAxMzc=,42975,prepare statements is not enabled by default with mysql2 adapter,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,6,2021-08-09T05:59:33Z,2021-12-16T05:54:30Z,,NONE,,"### Steps to reproduce

It took me a long time to figure out `prepared_statements` is disabled because of my database adapter is different in my new project. Change the adapter in `database.yml`, and you will find `prepared_statements` is enabled in `sqlite3` and `postgresql` but is disabled in `mysql2` by default (which was added in https://github.com/rails/rails/pull/23461).

Should we make the default of prepared_statements be true (maybe in the next major rails version) to keep the behavior consistent? The feature was supported by `mysql2` 5 years ago, we should have confidence in it now.

### Expected behavior

expect `prepared_statements` is enabled by default with `mysql2` adapter

### Actual behavior

`prepared_statements` is disabled by default only with `mysql2` adapter

### System configuration
**Rails version**:
6.0.3.7

**Ruby version**:
2.7.2
",https://api.github.com/repos/rails/rails/issues/42975/timeline,,khiav223577,4011729,MDQ6VXNlcjQwMTE3Mjk=,https://avatars.githubusercontent.com/u/4011729?v=4,,https://api.github.com/users/khiav223577,https://github.com/khiav223577,https://api.github.com/users/khiav223577/followers,https://api.github.com/users/khiav223577/following{/other_user},https://api.github.com/users/khiav223577/gists{/gist_id},https://api.github.com/users/khiav223577/starred{/owner}{/repo},https://api.github.com/users/khiav223577/subscriptions,https://api.github.com/users/khiav223577/orgs,https://api.github.com/users/khiav223577/repos,https://api.github.com/users/khiav223577/events{/privacy},https://api.github.com/users/khiav223577/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42975/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
315,https://api.github.com/repos/rails/rails/issues/42959,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42959/labels{/name},https://api.github.com/repos/rails/rails/issues/42959/comments,https://api.github.com/repos/rails/rails/issues/42959/events,https://github.com/rails/rails/issues/42959,962946596,MDU6SXNzdWU5NjI5NDY1OTY=,42959,Deprecate mutable default for attributes,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2021-08-06T18:11:31Z,2021-08-09T20:31:29Z,,CONTRIBUTOR,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

On https://github.com/rails/rails/issues/41854, a user is confused on why changing one object modifies another due to a mutable default:

```ruby
class Foo
  include ActiveModel::Model
  include ActiveModel::Attributes

  attribute :bars, default: []
end

foo = Foo.new
foo.bars << 1

another_foo = Foo.new
another_foo.bars
=> [1]
```

The issue is closed with the correct suggestion: use a proc to define the default. 

Having been recently bitten by a similar issue, I come here to suggest `attribute` should not accept mutable objects as default. The overwhelming majority of users would actually want a new instance of the object rather than share the object.

For prior art, see FactoryBot which disallowed static values entirely: https://github.com/thoughtbot/factory_bot/pull/1135

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
end

require ""active_model""
require ""minitest/autorun""

class SomeModel
  include ActiveModel::Model
  include ActiveModel::Attributes

  attribute :my_attribute, default: {}
end

class BugTest < Minitest::Test
  def test_stuff
    m1 = SomeModel.new
    m2 = SomeModel.new
    m1.my_attribute[:key] = 1
    assert_equal({}, m2.my_attribute)
  end
end
```

### Expected behavior

AM prevents me from shooting myself in the foot, and tells me using a mutable default value is problematic.

### Actual behavior

AM is happy to use the same array instance for all `SomeModel` instances.

### System configuration
**Rails version**: 6.0, main

**Ruby version**: 2.7.2

",https://api.github.com/repos/rails/rails/issues/42959/timeline,,fsateler,1322013,MDQ6VXNlcjEzMjIwMTM=,https://avatars.githubusercontent.com/u/1322013?v=4,,https://api.github.com/users/fsateler,https://github.com/fsateler,https://api.github.com/users/fsateler/followers,https://api.github.com/users/fsateler/following{/other_user},https://api.github.com/users/fsateler/gists{/gist_id},https://api.github.com/users/fsateler/starred{/owner}{/repo},https://api.github.com/users/fsateler/subscriptions,https://api.github.com/users/fsateler/orgs,https://api.github.com/users/fsateler/repos,https://api.github.com/users/fsateler/events{/privacy},https://api.github.com/users/fsateler/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42959/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
316,https://api.github.com/repos/rails/rails/issues/42942,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42942/labels{/name},https://api.github.com/repos/rails/rails/issues/42942/comments,https://api.github.com/repos/rails/rails/issues/42942/events,https://github.com/rails/rails/issues/42942,960164852,MDU6SXNzdWU5NjAxNjQ4NTI=,42942,unsafe query generation?,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,4,2021-08-04T09:47:28Z,2021-08-09T20:33:09Z,,NONE,,"### Steps to reproduce

There's a weird bug, I think it's related to unsafe query generation, and there's action controller leakage.

Similar vulnerabilities can be found with these IDS `CVE-2016-6317,CVE-2012-2660, CVE-2012-2694`
and `CVE-2013-0155.`

### Actual behavior


For example:

https://github.com/Alaa-abdulridha?tab=repositories&q[].=&type[].=1

then we could use & operator to get a new result with nil

https://github.com/Alaa-abdulridha?tab=repositories&q[].&=&type[].&=1

I believe all rails applications are vulnerable.

![image](https://user-images.githubusercontent.com/53356539/128158385-cddd0644-cf28-4726-b033-cfc0e2fe3f04.png)

```ruby
[#<ActionController::Parameters {"".""=>""""} permitted: false>]
```
```ruby
[#<ActionController::Parameters {"".""=>nil} permitted: false>]
```
I have managed to mitigate this issue, by a simple solution as below:

```ruby
def block_array_parameters
      params.each do |key, value|
        if key != 'controller' && key != 'action'
          if params[key].is_a? Array
		    key = key.gsub(/\W/, """")
            render status: 403, json: JSON.pretty_generate({ error: ""`#{key}` parameter can't be an array."" })
          end
        end
      end
    end
```


Here I made a simple project vulnerable with this bug,

https://github.com/Alaa-abdulridha/RailsApplication

![image](https://user-images.githubusercontent.com/53356539/128159585-c14776dd-cc19-4c1b-94b1-a082aa81cddc.png)

If you notice on the `application_controller.rb` file lines between 23 and 32, I've added the code above, it's not activated only if you uncommented line 3
This is a simple solution I've made just to give you an Idea maybe about how to fix it.

You can test this issue on the `home_controller` e.g. the `search` parameter and as below:

```ruby
class HomeController < ApplicationController

	def index
		@post = Post.includes(:user).where(status: 0).order(created_at: :desc).page params[:page]
	end

	def search
		if params[:search] != """"
           @results = Post.where('lower(name) iLIKE ?', ""%#{params[:search]}%"").order(:created_at)
           @user = User.where('lower(name) iLIKE ?', ""%#{params[:search]}%"").order(:created_at)
       end  
    end
end
```



The above solution will work If your controllers are inherited from the application controller, It filter all the controller's parameters.

But the issue with this solution, if your application is using the nested parameters it won't work, as below:
```ruby
      @card.name = params[:credit_card][:name]
      @card.address_line1 = params[:credit_card][:address_line1]
      @card.address_line2 = params[:credit_card][:address_line2]
```

### System configuration
**Rails version**: Latest version.

**Ruby version**: Latest version.
",https://api.github.com/repos/rails/rails/issues/42942/timeline,,Alaa-abdulridha,53356539,MDQ6VXNlcjUzMzU2NTM5,https://avatars.githubusercontent.com/u/53356539?v=4,,https://api.github.com/users/Alaa-abdulridha,https://github.com/Alaa-abdulridha,https://api.github.com/users/Alaa-abdulridha/followers,https://api.github.com/users/Alaa-abdulridha/following{/other_user},https://api.github.com/users/Alaa-abdulridha/gists{/gist_id},https://api.github.com/users/Alaa-abdulridha/starred{/owner}{/repo},https://api.github.com/users/Alaa-abdulridha/subscriptions,https://api.github.com/users/Alaa-abdulridha/orgs,https://api.github.com/users/Alaa-abdulridha/repos,https://api.github.com/users/Alaa-abdulridha/events{/privacy},https://api.github.com/users/Alaa-abdulridha/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42942/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
317,https://api.github.com/repos/rails/rails/issues/42941,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42941/labels{/name},https://api.github.com/repos/rails/rails/issues/42941/comments,https://api.github.com/repos/rails/rails/issues/42941/events,https://github.com/rails/rails/issues/42941,960076645,MDU6SXNzdWU5NjAwNzY2NDU=,42941,`ActiveStorage::Attached::Many#attach` may erase files uploaded concurrently,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,12,2021-08-04T08:43:46Z,2022-03-30T13:30:14Z,,NONE,,"### Steps to reproduce

First setup the sample application:

1. `gem install rails -v6.1.4`
2. `rails new ConcurrentAttachTestApp --skip-action-mailer --skip-action-mailbox --skip-action-text --skip-action-cable --skip-sprockets --skip-spring --skip-listen --skip-javascript --skip-turbolinks --skip-jbuilder --skip-test --skip-system-test --skip-bootsnap`
3. apply the following diff:

    ```diff
    diff --git a/Gemfile b/Gemfile
    index 01a705b..25b3e19 100644
    --- a/Gemfile
    +++ b/Gemfile
    @@ -15,6 +15,8 @@ gem 'puma', '~> 5.0'
     # Use Active Storage variant
     # gem 'image_processing', '~> 1.2'
    
    +gem 'pg'
    +
     group :development, :test do
       # Call 'byebug' anywhere in the code to stop execution and get a debugger console
       gem 'byebug', platforms: [:mri, :mingw, :x64_mingw]
    @@ -26,6 +28,8 @@ group :development do
       # Display performance information such as SQL time and flame graphs for each request in your browser.
       # Can be configured to work on production as well see: https://github.com/MiniProfiler/rack-mini-profiler/blob/master/README.md
       gem 'rack-mini-profiler', '~> 2.0'
    +
    +  gem 'parallel'
     end
    
     # Windows does not include zoneinfo files, so bundle the tzinfo-data gem
    diff --git a/app/models/user.rb b/app/models/user.rb
    new file mode 100644
    index 0000000..2db75b6
    --- /dev/null
    +++ b/app/models/user.rb
    @@ -0,0 +1,3 @@
    +class User < ApplicationRecord
    +  has_many_attached :files
    +end
    diff --git a/config/database.yml b/config/database.yml
    index 4a8a1b2..78ac63a 100644
    --- a/config/database.yml
    +++ b/config/database.yml
    @@ -10,8 +10,12 @@ default: &default
       timeout: 5000
    
     development:
    -  <<: *default
    -  database: db/development.sqlite3
    +  adapter: postgresql
    +  database: concurrent_attach_development
    +  encoding: unicode
    +  host: localhost
    +  pool: 5
    +  username: postgres
    
     # Warning: The database defined as ""test"" will be erased and
     # re-generated from your development database when you run ""rake"".
    diff --git a/db/migrate/20210804080852_create_active_storage_tables.active_storage.rb b/db/migrate/20210804080852_create_active_storage_tables.active_storage.rb
    new file mode 100644
    index 0000000..8779826
    --- /dev/null
    +++ b/db/migrate/20210804080852_create_active_storage_tables.active_storage.rb
    @@ -0,0 +1,36 @@
    +# This migration comes from active_storage (originally 20170806125915)
    +class CreateActiveStorageTables < ActiveRecord::Migration[5.2]
    +  def change
    +    create_table :active_storage_blobs do |t|
    +      t.string   :key,          null: false
    +      t.string   :filename,     null: false
    +      t.string   :content_type
    +      t.text     :metadata
    +      t.string   :service_name, null: false
    +      t.bigint   :byte_size,    null: false
    +      t.string   :checksum,     null: false
    +      t.datetime :created_at,   null: false
    +
    +      t.index [ :key ], unique: true
    +    end
    +
    +    create_table :active_storage_attachments do |t|
    +      t.string     :name,     null: false
    +      t.references :record,   null: false, polymorphic: true, index: false
    +      t.references :blob,     null: false
    +
    +      t.datetime :created_at, null: false
    +
    +      t.index [ :record_type, :record_id, :name, :blob_id ], name: ""index_active_storage_attachments_uniqueness"", unique: true
    +      t.foreign_key :active_storage_blobs, column: :blob_id
    +    end
    +
    +    create_table :active_storage_variant_records do |t|
    +      t.belongs_to :blob, null: false, index: false
    +      t.string :variation_digest, null: false
    +
    +      t.index %i[ blob_id variation_digest ], name: ""index_active_storage_variant_records_uniqueness"", unique: true
    +      t.foreign_key :active_storage_blobs, column: :blob_id
    +    end
    +  end
    +end
    diff --git a/db/schema.rb b/db/schema.rb
    new file mode 100644
    index 0000000..dbb533c
    --- /dev/null
    +++ b/db/schema.rb
    @@ -0,0 +1,51 @@
    +# This file is auto-generated from the current state of the database. Instead
    +# of editing this file, please use the migrations feature of Active Record to
    +# incrementally modify your database, and then regenerate this schema definition.
    +#
    +# This file is the source Rails uses to define your schema when running `bin/rails
    +# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
    +# be faster and is potentially less error prone than running all of your
    +# migrations from scratch. Old migrations may fail to apply correctly if those
    +# migrations use external dependencies or application code.
    +#
    +# It's strongly recommended that you check this file into your version control system.
    +
    +ActiveRecord::Schema.define(version: 2021_08_04_080852) do
    +
    +  # These are extensions that must be enabled in order to support this database
    +  enable_extension ""plpgsql""
    +
    +  create_table ""active_storage_attachments"", force: :cascade do |t|
    +    t.string ""name"", null: false
    +    t.string ""record_type"", null: false
    +    t.bigint ""record_id"", null: false
    +    t.bigint ""blob_id"", null: false
    +    t.datetime ""created_at"", null: false
    +    t.index [""blob_id""], name: ""index_active_storage_attachments_on_blob_id""
    +    t.index [""record_type"", ""record_id"", ""name"", ""blob_id""], name: ""index_active_storage_attachments_uniqueness"", unique: true
    +  end
    +
    +  create_table ""active_storage_blobs"", force: :cascade do |t|
    +    t.string ""key"", null: false
    +    t.string ""filename"", null: false
    +    t.string ""content_type""
    +    t.text ""metadata""
    +    t.string ""service_name"", null: false
    +    t.bigint ""byte_size"", null: false
    +    t.string ""checksum"", null: false
    +    t.datetime ""created_at"", null: false
    +    t.index [""key""], name: ""index_active_storage_blobs_on_key"", unique: true
    +  end
    +
    +  create_table ""active_storage_variant_records"", force: :cascade do |t|
    +    t.bigint ""blob_id"", null: false
    +    t.string ""variation_digest"", null: false
    +    t.index [""blob_id"", ""variation_digest""], name: ""index_active_storage_variant_records_uniqueness"", unique: true
    +  end
    +
    +  create_table ""users"", force: :cascade do |t|
    +  end
    +
    +  add_foreign_key ""active_storage_attachments"", ""active_storage_blobs"", column: ""blob_id""
    +  add_foreign_key ""active_storage_variant_records"", ""active_storage_blobs"", column: ""blob_id""
    +end
    ```

4. `bundle install`
5. `bin/rails active_storage:install`
6. `bin/rails db:setup`

Now try the following code in the `bin/rails console`:

```ruby
User.create

Parallel.each(1..10) do
  ActiveRecord::Base.connection_pool.with_connection do
    User.first.files.attach(io: File.open(""README.md""), filename: ""README.md"")
  end
end

User.first.files.count
```

Note that `User.first.files.count` may return a smaller number than 10.

### Expected behavior
Each `Object#attach` appends the new file and does not touch existing attachments.

### Actual behavior
`Object#attach` may purge files that are uploaded concurrently.

### System configuration
**Rails version**: 6.1.4

**Ruby version**: 3.0.1
",https://api.github.com/repos/rails/rails/issues/42941/timeline,,smt116,619324,MDQ6VXNlcjYxOTMyNA==,https://avatars.githubusercontent.com/u/619324?v=4,,https://api.github.com/users/smt116,https://github.com/smt116,https://api.github.com/users/smt116/followers,https://api.github.com/users/smt116/following{/other_user},https://api.github.com/users/smt116/gists{/gist_id},https://api.github.com/users/smt116/starred{/owner}{/repo},https://api.github.com/users/smt116/subscriptions,https://api.github.com/users/smt116/orgs,https://api.github.com/users/smt116/repos,https://api.github.com/users/smt116/events{/privacy},https://api.github.com/users/smt116/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42941/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
318,https://api.github.com/repos/rails/rails/issues/42922,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42922/labels{/name},https://api.github.com/repos/rails/rails/issues/42922/comments,https://api.github.com/repos/rails/rails/issues/42922/events,https://github.com/rails/rails/issues/42922,957126926,MDU6SXNzdWU5NTcxMjY5MjY=,42922,ActiveRecord Encryption initializes with SHA1 and then new Rails 7 default switches to SHA256,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,5,2021-07-31T00:01:49Z,2022-04-11T15:36:42Z,,NONE,,"
`ActiveRecord::Railtie` initialization fires before `ActiveSupport::Railtie`

In `Rails::Application::Configuration#load_defaults(7.0)` it sets [`active_support.key_generator_hash_digest_class = OpenSSL::Digest::SHA256`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/railties/lib/rails/application/configuration.rb#L213)

Then in the `ActiveSupport::Railtie` it sets [`ActiveSupport::KeyGenerator.hash_digest_class = active_support.key_generator_hash_digest_class`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/activesupport/lib/active_support/railtie.rb#L114)

However, the `ActiveRecord::Railtie` configures `ActiveRecord::Encryption` before this configuration change happens.

What this causes is the `ActiveRecord::Encryption::Configurable.configure` to set the [`context.key_provider = ActiveRecord::Encryption::DerivedSecretKeyProvider.new(primary_key)`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/activerecord/lib/active_record/encryption/configurable.rb#L25), which uses the `ActiveSupport::KeyGenerator` from [`ActiveRecord::Encryption::KeyGenerator#derive_key_from`](https://github.com/rails/rails/blob/c3664b0c2b509fc0a47929f42afbd716959c8f4c/activerecord/lib/active_record/encryption/key_generator.rb#L33) method.  At this point it uses the classes default `hash_digest_class` of `OpenSSL::Digest::SHA1`.

After `ActiveSupport::Railtie` runs the `ActiveSupport::KeyGenerator.hash_digest_class` changes to `OpenSSL::Digest::SHA256`

I am not sure what the best fix is and there may be others, but a couple I can think of are:
* `ActiveRecord::Encryption` is ""explicit"" about how it configures/uses the `ActiveSupport::KeyGenerator` and possibly adds additional options for `hash_digest_class` and `iterations`.  This removes the dependency.  It also allows the database to live past future changes to ActiveSupport defaults. 
* `ActiveSupport::KeyGenerator` changes it's class default to be `OpenSSL::Digest::SHA256` and the `new_framework_defaults_7_0.rb` file sets it back to `OpenSSL::Digest::SHA1`

### Steps to reproduce
1. Create a new rails 7 project using all rails 7 defaults (removed `new_framework_defaults_7_0.rb` file and `application.rb` changes to `config.load_defaults 7.0`)
2. Configure Encryption by running `bin/rails db:encryption:init` and adding the generated credentials (`bin/rails credentials:edit`)
```ruby
Add this entry to the credentials of the target environment:

active_record_encryption:
  primary_key: nYeEQD0EqOKXeRMFcUq7BX6goxGt0hPq
  deterministic_key: aduCGCnZWFtRIN3xc8CiM15kZKt2Az8T
  key_derivation_salt: fidtmePZxQNmR6Gc4Yv7j1lko06ISaBu
``` 
3. Start a rails console (`bin/rails console`)

```ruby
ActiveRecord::Encryption.key_provider.encryption_key.secret
primary_key = ""nYeEQD0EqOKXeRMFcUq7BX6goxGt0hPq""
key_derivation_salt = ""fidtmePZxQNmR6Gc4Yv7j1lko06ISaBu""
ActiveRecord::Encryption::DerivedSecretKeyProvider.new(primary_key).encryption_key.secret
OpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA1.new)
OpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA256.new)
```

### Expected behavior
`ActiveRecord::Encryption.key_provider.encryption_key.secret`
`\xE547G\xE7\x99?\x95\xAEX\xE1\xEFS\xE9p\x87}\x93\xF8\x8A\x9Ch\x80\x95#Bee\x95\nD\x7F`

### Actual behavior
`ActiveRecord::Encryption.key_provider.encryption_key.secret`
`\x8B`\x17k\xA1\xC9`:a\x05>N\x10\xE4\eYD\xCFUh\x10\x9Ep\x89\x10\x15vt\xE0\x94\xAAN`

`ActiveRecord::Encryption::DerivedSecretKeyProvider.new(primary_key).encryption_key.secret`
`\xE547G\xE7\x99?\x95\xAEX\xE1\xEFS\xE9p\x87}\x93\xF8\x8A\x9Ch\x80\x95#Bee\x95\nD\x7F`

`OpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA1.new)`
`\x8B`\x17k\xA1\xC9`:a\x05>N\x10\xE4\eYD\xCFUh\x10\x9Ep\x89\x10\x15vt\xE0\x94\xAAN`

`OpenSSL::PKCS5.pbkdf2_hmac(primary_key, key_derivation_salt, 2**16, 32, OpenSSL::Digest::SHA256.new)`
`\xE547G\xE7\x99?\x95\xAEX\xE1\xEFS\xE9p\x87}\x93\xF8\x8A\x9Ch\x80\x95#Bee\x95\nD\x7F`

### System configuration
**Rails version**: `7.0` (`gem 'rails', github: 'rails/rails', branch: 'main'`)

**Ruby version**: `ruby 2.7.2p137`
",https://api.github.com/repos/rails/rails/issues/42922/timeline,,boomer196,6631628,MDQ6VXNlcjY2MzE2Mjg=,https://avatars.githubusercontent.com/u/6631628?v=4,,https://api.github.com/users/boomer196,https://github.com/boomer196,https://api.github.com/users/boomer196/followers,https://api.github.com/users/boomer196/following{/other_user},https://api.github.com/users/boomer196/gists{/gist_id},https://api.github.com/users/boomer196/starred{/owner}{/repo},https://api.github.com/users/boomer196/subscriptions,https://api.github.com/users/boomer196/orgs,https://api.github.com/users/boomer196/repos,https://api.github.com/users/boomer196/events{/privacy},https://api.github.com/users/boomer196/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42922/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
319,https://api.github.com/repos/rails/rails/issues/42918,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42918/labels{/name},https://api.github.com/repos/rails/rails/issues/42918/comments,https://api.github.com/repos/rails/rails/issues/42918/events,https://github.com/rails/rails/issues/42918,956737780,MDU6SXNzdWU5NTY3Mzc3ODA=,42918,ActiveRecord | #upsert_all without unique_by adds ID as the conflict_target in Postgres,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2021-07-30T13:16:26Z,2021-07-30T19:31:16Z,,NONE,,"When trying to call a `upsert_all` operation in one of the `ActiveRecord` models of my application, I've noticed that the resulting SQL inserts the statement `ON CONFLICT (""id"") DO UPDATE`. Passing the desired index via `:unique_by` key works though.

However, the current [documentation](https://apidock.com/rails/v6.0.0/ActiveRecord/Persistence/ClassMethods/upsert_all) of `#upsert_all` states:

> By default rows are considered to be unique by every unique index on the table

Also, when executing `#insert_all` without specifying the unique index, we receive the correct SQL statement `ON CONFLICT DO NOTHING`

### Expected behavior
The `#upsert_all` method, without `:unique_by` parameter to add the `ON CONFLICT DO UPDATE` SQL statement

### Actual behavior
The `#upsert_all` method, without `:unique_by` parameter adds the `ON CONFLICT (""id"") DO UPDATE` SQL statement

### System configuration
**Rails version**: 6.1.3

**Ruby version**: 3.0.1

**PostgreSQL version**: 12.4, running over AWS AuroraDB
",https://api.github.com/repos/rails/rails/issues/42918/timeline,,lucaspbordignon,11822875,MDQ6VXNlcjExODIyODc1,https://avatars.githubusercontent.com/u/11822875?v=4,,https://api.github.com/users/lucaspbordignon,https://github.com/lucaspbordignon,https://api.github.com/users/lucaspbordignon/followers,https://api.github.com/users/lucaspbordignon/following{/other_user},https://api.github.com/users/lucaspbordignon/gists{/gist_id},https://api.github.com/users/lucaspbordignon/starred{/owner}{/repo},https://api.github.com/users/lucaspbordignon/subscriptions,https://api.github.com/users/lucaspbordignon/orgs,https://api.github.com/users/lucaspbordignon/repos,https://api.github.com/users/lucaspbordignon/events{/privacy},https://api.github.com/users/lucaspbordignon/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42918/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
320,https://api.github.com/repos/rails/rails/issues/42909,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42909/labels{/name},https://api.github.com/repos/rails/rails/issues/42909/comments,https://api.github.com/repos/rails/rails/issues/42909/events,https://github.com/rails/rails/pull/42909,956097786,MDExOlB1bGxSZXF1ZXN0Njk5NzQ5MDg5,42909,Add `skip_nil:` support to `RedisCacheStore`,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,6,2021-07-29T18:24:35Z,2022-03-07T19:26:56Z,,NONE,,"### Summary

`ActiveSupport::Cache` accepts `skip_nil:` when initializing a cache to add to the default parameters of `fetch` requests. This pull request allows `RedisCacheStore` to also accept a default value for `skip_nil:`.

### Other Information

I copied the `skip_nil:` documentation from `ActiveSupport::Cache`, there might be a better way to write it so I'm definitely open to suggestions.
",https://api.github.com/repos/rails/rails/issues/42909/timeline,,joeyparis,1377422,MDQ6VXNlcjEzNzc0MjI=,https://avatars.githubusercontent.com/u/1377422?v=4,,https://api.github.com/users/joeyparis,https://github.com/joeyparis,https://api.github.com/users/joeyparis/followers,https://api.github.com/users/joeyparis/following{/other_user},https://api.github.com/users/joeyparis/gists{/gist_id},https://api.github.com/users/joeyparis/starred{/owner}{/repo},https://api.github.com/users/joeyparis/subscriptions,https://api.github.com/users/joeyparis/orgs,https://api.github.com/users/joeyparis/repos,https://api.github.com/users/joeyparis/events{/privacy},https://api.github.com/users/joeyparis/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42909/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42909,https://github.com/rails/rails/pull/42909,https://github.com/rails/rails/pull/42909.diff,https://github.com/rails/rails/pull/42909.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
321,https://api.github.com/repos/rails/rails/issues/42907,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42907/labels{/name},https://api.github.com/repos/rails/rails/issues/42907/comments,https://api.github.com/repos/rails/rails/issues/42907/events,https://github.com/rails/rails/pull/42907,956003570,MDExOlB1bGxSZXF1ZXN0Njk5NjY5NDAy,42907,Add ActiveModel::CompositeValidator,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,1,2021-07-29T16:18:22Z,2022-04-21T00:18:48Z,,MEMBER,,"`CompositeValidator` is a base class that can be used to compose existing validators.  Subclasses define a `compose` method that calls `validates*` methods in the same way a model class would:

```ruby
class MoneyValidator < ActiveModel::CompositeValidator
  def compose
    currencies = options[:in]

    validates *attributes, numericality: { only_integer: true }
    validates *attributes.map { |attribute| ""#{attribute}_currency"" }, inclusion: currencies
  end
end

class Account < ActiveRecord::Base
  validates :balance, money: [""JPY""]
end

Account.new(balance: 100, balance_currency: ""JPY"").valid?   # => true
Account.new(balance: 100.1, balance_currency: ""JPY"").valid? # => false
Account.new(balance: 100, balance_currency: ""USD"").valid?   # => false
```

---

This is based on the discussion in #41253.",https://api.github.com/repos/rails/rails/issues/42907/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42907/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42907,https://github.com/rails/rails/pull/42907,https://github.com/rails/rails/pull/42907.diff,https://github.com/rails/rails/pull/42907.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
322,https://api.github.com/repos/rails/rails/issues/42849,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42849/labels{/name},https://api.github.com/repos/rails/rails/issues/42849/comments,https://api.github.com/repos/rails/rails/issues/42849/events,https://github.com/rails/rails/issues/42849,951518313,MDU6SXNzdWU5NTE1MTgzMTM=,42849,ActionMailer fails to create correct multipart message with rfc822 attachment,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}]",open,False,,[],,12,2021-07-23T12:03:09Z,2022-04-22T13:35:05Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require 'bundler/inline'

gemfile(true) do
  source 'https://rubygems.org'
  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }
  gem 'rails', github: 'rails/rails', branch: 'main'
end

require 'minitest/autorun'
require 'action_mailer/railtie'

class TestMailer < ActionMailer::Base
  def main
    message_to_attach =  <<~MAIL.gsub(/\n/, ""\r\n"")
      Message-ID: <12345@foo.example>
      Subject: Test
      From: test1@foo.example
      To: test2@foo.example
      
      hello world
    MAIL
    attachments['test.eml'] = {
      mime_type: params[:mime_type],
      content: message_to_attach
    }

    mail(from: 'test3@foo.example', to: 'test4@foo.example', subject: 'Test outer') do |format|
      format.text { ""outer text - #{params[:mime_type]} attachment"" }
    end
  end
end

class BugTest < Minitest::Test
  def test_with_plain_mime_type
    message = TestMailer.with(mime_type: 'text/plain').main
    assert_equal message.mime_type, 'multipart/mixed'
  end

  def test_with_rfc822_mime_type
    message = TestMailer.with(mime_type: 'message/rfc822').main
    assert_equal message.mime_type, 'multipart/mixed'
  end
end
```

The second test fails, the message object is rendered as follows:
```
Date: Fri, 23 Jul 2021 13:59:19 +0200
From: test3@foo.example
To: test4@foo.example
Message-ID: <60faaf1738a02_14fbd98-3fb@flo.adigi.ai.mail>
Subject: Test outer
Mime-Version: 1.0
Content-Type: text/plain;
 boundary=""--==_mimepart_60faaf1738008_14fbd98-484"";
 charset=UTF-8
Content-Transfer-Encoding: 7bit


----==_mimepart_60faaf1738008_14fbd98-484
Content-Type: text/plain;
 charset=UTF-8
Content-Transfer-Encoding: 7bit

outer text - message/rfc822 attachment
----==_mimepart_60faaf1738008_14fbd98-484
Content-Type: message/rfc822
Content-Transfer-Encoding: 
Content-Disposition: attachment;
 filename=test.eml
Content-ID: <60faaf1739102_14fbd98-2b@flo.adigi.ai.mail>

Message-ID: <12345@foo.example>
Subject: Test
From: test1@foo.example
To: test2@foo.example

hello world

----==_mimepart_60faaf1738008_14fbd98-484--

```

### Expected behavior

The `message.mime_type` is `multipart/mixed` in both test cases. ActionMailer handles attachments in the way it is described in https://guides.rubyonrails.org/action_mailer_basics.html#adding-attachments describes.

### Actual behavior

When attaching a `message/rfc822` - an email message - the generated mail parts are not nested correctly, the outer `multipart/mixed` is missing.

Perhaps this behaviour is caused by the [special handling](https://github.com/mikel/mail/blob/master/lib/mail/attachments_list.rb#L9) of such attachments in the `mail` gem.


### System configuration
**Rails version**: master

**Ruby version**: 3.0.2
",https://api.github.com/repos/rails/rails/issues/42849/timeline,,der-flo,35431,MDQ6VXNlcjM1NDMx,https://avatars.githubusercontent.com/u/35431?v=4,,https://api.github.com/users/der-flo,https://github.com/der-flo,https://api.github.com/users/der-flo/followers,https://api.github.com/users/der-flo/following{/other_user},https://api.github.com/users/der-flo/gists{/gist_id},https://api.github.com/users/der-flo/starred{/owner}{/repo},https://api.github.com/users/der-flo/subscriptions,https://api.github.com/users/der-flo/orgs,https://api.github.com/users/der-flo/repos,https://api.github.com/users/der-flo/events{/privacy},https://api.github.com/users/der-flo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42849/reactions,7,7,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
323,https://api.github.com/repos/rails/rails/issues/42837,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42837/labels{/name},https://api.github.com/repos/rails/rails/issues/42837/comments,https://api.github.com/repos/rails/rails/issues/42837/events,https://github.com/rails/rails/pull/42837,950628233,MDExOlB1bGxSZXF1ZXN0Njk1MTQ2MTYw,42837,"ActionMailer Previewer: download eml, resize view (desktop, mobile), view source","[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,3,2021-07-22T12:56:21Z,2022-04-20T14:18:47Z,,CONTRIBUTOR,,"### Summary

It could be useful for developers to download EML file for email. Currently, I'm using mailcatcher or maildev to send email and download "".eml"" file there. So I can open it in Outlook for example and see how it looks.

In addition, I want to have an easy switch width option to see how the email looks with different widths.

### Other Information

![image](https://user-images.githubusercontent.com/11101/126642671-8f19c5b5-516a-4681-bd8c-71c26b07fabd.png)

PS: First I've created a simpler version with just edit EML file, PR is here: https://github.com/rails/rails/pull/42823 which I'm closing now. This version is better.",https://api.github.com/repos/rails/rails/issues/42837/timeline,,igorkasyanchuk,11101,MDQ6VXNlcjExMTAx,https://avatars.githubusercontent.com/u/11101?v=4,,https://api.github.com/users/igorkasyanchuk,https://github.com/igorkasyanchuk,https://api.github.com/users/igorkasyanchuk/followers,https://api.github.com/users/igorkasyanchuk/following{/other_user},https://api.github.com/users/igorkasyanchuk/gists{/gist_id},https://api.github.com/users/igorkasyanchuk/starred{/owner}{/repo},https://api.github.com/users/igorkasyanchuk/subscriptions,https://api.github.com/users/igorkasyanchuk/orgs,https://api.github.com/users/igorkasyanchuk/repos,https://api.github.com/users/igorkasyanchuk/events{/privacy},https://api.github.com/users/igorkasyanchuk/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42837/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42837,https://github.com/rails/rails/pull/42837,https://github.com/rails/rails/pull/42837.diff,https://github.com/rails/rails/pull/42837.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
324,https://api.github.com/repos/rails/rails/issues/42802,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42802/labels{/name},https://api.github.com/repos/rails/rails/issues/42802/comments,https://api.github.com/repos/rails/rails/issues/42802/events,https://github.com/rails/rails/issues/42802,946293551,MDU6SXNzdWU5NDYyOTM1NTE=,42802,ActiveSupport::Duration#inspect returns invalid output when integer division,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,"[{'login': 'martinjaimem', 'id': 50113670, 'node_id': 'MDQ6VXNlcjUwMTEzNjcw', 'avatar_url': 'https://avatars.githubusercontent.com/u/50113670?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/martinjaimem', 'html_url': 'https://github.com/martinjaimem', 'followers_url': 'https://api.github.com/users/martinjaimem/followers', 'following_url': 'https://api.github.com/users/martinjaimem/following{/other_user}', 'gists_url': 'https://api.github.com/users/martinjaimem/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/martinjaimem/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/martinjaimem/subscriptions', 'organizations_url': 'https://api.github.com/users/martinjaimem/orgs', 'repos_url': 'https://api.github.com/users/martinjaimem/repos', 'events_url': 'https://api.github.com/users/martinjaimem/events{/privacy}', 'received_events_url': 'https://api.github.com/users/martinjaimem/received_events', 'type': 'User', 'site_admin': False}]",,1,2021-07-16T13:25:51Z,2021-07-18T20:26:06Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require ""active_support/all""

(1.second + 1.hour/10).inspect
# (1.second + 1.hour/10.0).inspect works properly due to float division

```

### Expected behavior
<!-- Tell us what should happen -->
`0.1 hour, 1 second` or `361 seconds`

### Actual behavior
<!-- Tell us what happens instead -->
`1 second`

### System configuration
**Rails version**:
6.1.3.2

**Ruby version**:
2.7.3",https://api.github.com/repos/rails/rails/issues/42802/timeline,,ysugiyama12,22633414,MDQ6VXNlcjIyNjMzNDE0,https://avatars.githubusercontent.com/u/22633414?v=4,,https://api.github.com/users/ysugiyama12,https://github.com/ysugiyama12,https://api.github.com/users/ysugiyama12/followers,https://api.github.com/users/ysugiyama12/following{/other_user},https://api.github.com/users/ysugiyama12/gists{/gist_id},https://api.github.com/users/ysugiyama12/starred{/owner}{/repo},https://api.github.com/users/ysugiyama12/subscriptions,https://api.github.com/users/ysugiyama12/orgs,https://api.github.com/users/ysugiyama12/repos,https://api.github.com/users/ysugiyama12/events{/privacy},https://api.github.com/users/ysugiyama12/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42802/reactions,0,0,0,0,0,0,0,0,0,,,,,,,martinjaimem,50113670.0,MDQ6VXNlcjUwMTEzNjcw,https://avatars.githubusercontent.com/u/50113670?v=4,,https://api.github.com/users/martinjaimem,https://github.com/martinjaimem,https://api.github.com/users/martinjaimem/followers,https://api.github.com/users/martinjaimem/following{/other_user},https://api.github.com/users/martinjaimem/gists{/gist_id},https://api.github.com/users/martinjaimem/starred{/owner}{/repo},https://api.github.com/users/martinjaimem/subscriptions,https://api.github.com/users/martinjaimem/orgs,https://api.github.com/users/martinjaimem/repos,https://api.github.com/users/martinjaimem/events{/privacy},https://api.github.com/users/martinjaimem/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
325,https://api.github.com/repos/rails/rails/issues/42759,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42759/labels{/name},https://api.github.com/repos/rails/rails/issues/42759/comments,https://api.github.com/repos/rails/rails/issues/42759/events,https://github.com/rails/rails/issues/42759,942174896,MDU6SXNzdWU5NDIxNzQ4OTY=,42759,Deprecation warning in 6.1 if a `default_scope` contains a `where.not`,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,8,2021-07-12T15:20:16Z,2021-12-30T15:03:30Z,,MEMBER,,"Copying from https://github.com/rails/rails/pull/39328 as a new issue. I tried to fix it but couldn't figure out how to. https://github.com/rails/rails/pull/42481 contains some failing tests that I'm happy for anyone else to use.

```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post

  default_scope -> { where.not(post_id: nil) }
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!
    post.comments << Comment.create!

    # DEPRECATION WARNING: Merging (""comments"".""post_id"" IS NOT NULL) and (""comments"".""post_id"" = ?) no longer maintain both conditions, and will be replaced by the latter in Rails 7.0. To migrate to Rails 7.0's behavior, use `relation.merge(other, rewhere: true)`. (called from test_association_stuff at test.rb:47)
    post.comments.to_a
  end
end
```

The issue is that I'm not calling `merge` directly, so it's not clear how to fix the deprecation warning.

(In the app that this warning came up on, we ended up removing the default scope.)",https://api.github.com/repos/rails/rails/issues/42759/timeline,,ghiculescu,509837,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42759/reactions,1,1,0,0,0,0,0,0,0,,,,,,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
326,https://api.github.com/repos/rails/rails/issues/42748,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42748/labels{/name},https://api.github.com/repos/rails/rails/issues/42748/comments,https://api.github.com/repos/rails/rails/issues/42748/events,https://github.com/rails/rails/pull/42748,941068592,MDExOlB1bGxSZXF1ZXN0Njg3MDQxOTM2,42748,Fix autosave associations when saving new records with validate: false,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,14,2021-07-09T21:13:15Z,2022-04-08T20:36:13Z,,CONTRIBUTOR,,"### Summary

When saving a new record autosave wasn't considering the reflection validate option and always validating the association even when the default value of `validate` was false or was set explicit to false.

Based on the tests that I had to change it seems that this was an intended behavior at the time they were written, but it doesn't make much sense, because if someone sets `validate: false` to an association and `autosave: true` the association gets saved even when it is invalid, but when only `validate: false` is set it doesn't get saved when invalid, which means that we have two different behaviors based on the combination of the options provided to the association.

Fixes #25718 

### Other Information

Executable test case https://gist.github.com/marcelolx/243489f1dc05094f4b18d5ab57a9b6e4

",https://api.github.com/repos/rails/rails/issues/42748/timeline,,marcelolx,20196775,MDQ6VXNlcjIwMTk2Nzc1,https://avatars.githubusercontent.com/u/20196775?v=4,,https://api.github.com/users/marcelolx,https://github.com/marcelolx,https://api.github.com/users/marcelolx/followers,https://api.github.com/users/marcelolx/following{/other_user},https://api.github.com/users/marcelolx/gists{/gist_id},https://api.github.com/users/marcelolx/starred{/owner}{/repo},https://api.github.com/users/marcelolx/subscriptions,https://api.github.com/users/marcelolx/orgs,https://api.github.com/users/marcelolx/repos,https://api.github.com/users/marcelolx/events{/privacy},https://api.github.com/users/marcelolx/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42748/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42748,https://github.com/rails/rails/pull/42748,https://github.com/rails/rails/pull/42748.diff,https://github.com/rails/rails/pull/42748.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
327,https://api.github.com/repos/rails/rails/issues/42724,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42724/labels{/name},https://api.github.com/repos/rails/rails/issues/42724/comments,https://api.github.com/repos/rails/rails/issues/42724/events,https://github.com/rails/rails/pull/42724,939110074,MDExOlB1bGxSZXF1ZXN0Njg1MzgxNTM1,42724,Make `autosave` option work with `has_and_belongs_to_many`,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,9,2021-07-07T17:30:40Z,2022-02-14T10:37:27Z,,NONE,,"### Summary

Fixes https://github.com/rails/rails/issues/32476 scenarios when we have a `has_and_belongs_to_many` with a `autosave: true` option. In such case, the associated records need to saved as well, even if the associated post didn't not changed. 

",https://api.github.com/repos/rails/rails/issues/42724/timeline,,edipofederle,50778,MDQ6VXNlcjUwNzc4,https://avatars.githubusercontent.com/u/50778?v=4,,https://api.github.com/users/edipofederle,https://github.com/edipofederle,https://api.github.com/users/edipofederle/followers,https://api.github.com/users/edipofederle/following{/other_user},https://api.github.com/users/edipofederle/gists{/gist_id},https://api.github.com/users/edipofederle/starred{/owner}{/repo},https://api.github.com/users/edipofederle/subscriptions,https://api.github.com/users/edipofederle/orgs,https://api.github.com/users/edipofederle/repos,https://api.github.com/users/edipofederle/events{/privacy},https://api.github.com/users/edipofederle/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42724/reactions,1,0,0,0,1,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42724,https://github.com/rails/rails/pull/42724,https://github.com/rails/rails/pull/42724.diff,https://github.com/rails/rails/pull/42724.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
328,https://api.github.com/repos/rails/rails/issues/42716,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42716/labels{/name},https://api.github.com/repos/rails/rails/issues/42716/comments,https://api.github.com/repos/rails/rails/issues/42716/events,https://github.com/rails/rails/issues/42716,938433546,MDU6SXNzdWU5Mzg0MzM1NDY=,42716,"ActiveRecord 6.0.4 introduces extra JOIN on certain through assciations, breaking multi-database preloading","[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,1,2021-07-07T03:07:30Z,2021-08-02T23:09:54Z,,CONTRIBUTOR,,"### Steps to reproduce

Here is the reproduction script:

```ruby
require 'bundler/inline'

gemfile do
  source 'https://rubygems.org'
  gem 'activerecord', '6.0.4'  # error
  # gem 'activerecord', '6.0.3.7'  # OK
  gem 'sqlite3'
end

require 'active_record'
require 'minitest'
require 'logger'
require 'tmpdir'

tmpdir = Dir.mktmpdir
at_exit { FileUtils.remove_entry tmpdir }

main_db = File.join(tmpdir, 'main.sqlite3')
sub_db = File.join(tmpdir, 'sub.sqlite3')
ActiveRecord::Base.configurations = {
  'default_env' => {
    'primary' => {
      'adapter' => 'sqlite3',
      'database' => main_db
    },
    'sub' => {
      'adapter' => 'sqlite3',
      'database' => sub_db
    }
  }
}

ActiveRecord::Base.logger = Logger.new(STDOUT)
# ActiveRecord::Base.logger.level = 0

ActiveRecord::Base.establish_connection(:primary)
ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
  end

  create_table :posts, force: true do |t|
    t.integer :user_id
    t.datetime :created_at
  end
end

ActiveRecord::Base.establish_connection(:sub)
ActiveRecord::Schema.define do
  create_table :post_images, force: true do |t|
    t.integer :post_id
    t.string :purpose
  end
end


class User < ActiveRecord::Base
  has_many :posts

  has_one :latest_post, -> { order(created_at: :desc) }, class_name: 'Post'
  has_one :cover_image, through: :latest_post
end

class Post < ActiveRecord::Base
  belongs_to :user
  has_many :post_images
  has_one :cover_image, -> { where(purpose: 'cover_image') }, class_name: 'PostImage'
end

class PostImage < ActiveRecord::Base
  belongs_to :post
end

User.establish_connection(:primary)
Post.establish_connection(:primary)
PostImage.establish_connection(:sub)

class BugTest < Minitest::Test
  def test_foo
    user = User.create!
    post = user.posts.create!
    post_image = post.post_images.create!(purpose: 'inline')
    user = User.preload(:cover_image).find(user.id)
    assert_nil user.cover_image
  end
end
Minitest.autorun
```

### Expected behavior

The test passes.

### Actual behavior

The test fails with exception `ActiveRecord::StatementInvalid: SQLite3::SQLException: no such table: post_images`.

### System configuration
**Rails version**: 6.0.4

**Ruby version**: 2.7.3

Bisection points to https://github.com/rails/rails/commit/a415e804279c21b4dfbeb877ec0e40c12c2c8886 from https://github.com/rails/rails/pull/39378.

Previously it preloaded the through association step by step. To load `User#cover_image`, it first loads `User#latest_post` and then `Post#cover_image`, allowing the latter to use `WHERE .. IN` loading strategy.

After a415e804279c21b4dfbeb877ec0e40c12c2c8886 it dispatches a query that directly loads `User#cover_image`. During the query's construction it demands to check `post_image.purpose = 'cover_image'`, leading to a joined query.",https://api.github.com/repos/rails/rails/issues/42716/timeline,,qnighy,41755,MDQ6VXNlcjQxNzU1,https://avatars.githubusercontent.com/u/41755?v=4,,https://api.github.com/users/qnighy,https://github.com/qnighy,https://api.github.com/users/qnighy/followers,https://api.github.com/users/qnighy/following{/other_user},https://api.github.com/users/qnighy/gists{/gist_id},https://api.github.com/users/qnighy/starred{/owner}{/repo},https://api.github.com/users/qnighy/subscriptions,https://api.github.com/users/qnighy/orgs,https://api.github.com/users/qnighy/repos,https://api.github.com/users/qnighy/events{/privacy},https://api.github.com/users/qnighy/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42716/reactions,0,0,0,0,0,0,0,0,0,,,,,,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/milestones/75,https://github.com/rails/rails/milestone/75,https://api.github.com/repos/rails/rails/milestones/75/labels,5391770.0,MDk6TWlsZXN0b25lNTM5MTc3MA==,75.0,6.0.4,,eugeneius,432189.0,MDQ6VXNlcjQzMjE4OQ==,https://avatars.githubusercontent.com/u/432189?v=4,,https://api.github.com/users/eugeneius,https://github.com/eugeneius,https://api.github.com/users/eugeneius/followers,https://api.github.com/users/eugeneius/following{/other_user},https://api.github.com/users/eugeneius/gists{/gist_id},https://api.github.com/users/eugeneius/starred{/owner}{/repo},https://api.github.com/users/eugeneius/subscriptions,https://api.github.com/users/eugeneius/orgs,https://api.github.com/users/eugeneius/repos,https://api.github.com/users/eugeneius/events{/privacy},https://api.github.com/users/eugeneius/received_events,User,False,3.0,28.0,open,2020-05-06T20:51:20Z,2021-07-07T21:05:29Z,,
329,https://api.github.com/repos/rails/rails/issues/42701,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42701/labels{/name},https://api.github.com/repos/rails/rails/issues/42701/comments,https://api.github.com/repos/rails/rails/issues/42701/events,https://github.com/rails/rails/issues/42701,937311724,MDU6SXNzdWU5MzczMTE3MjQ=,42701,"Allow preview_path accept a array, not only a string","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2021-07-05T19:04:31Z,2021-07-06T14:53:19Z,,NONE,,"### Context
Hi Guys,

I used to work in a consultant firm, that have a lot of projects create above Ruby on Rails. For ship project faster, we create a lot of ""modules"" using Rails::Engine (https://guides.rubyonrails.org/engines.html). It works really well, but with some problems.

### Actual behavior
We load the engines using Gemfile path pointing to a relative path and git submodules to version it. It's fine. But, one problem that today is affecting a lot the team productivity is that there is no easy way to get all preview emails from all our engines, in the same time.

Today, preview_path only accept one string as argument. It will be nice to allow pass a array of string for each, like we have in assets path.

### Expected behavior

I'm wondering if its ok for me open a PullRequest to add this feature (I never open a pull request for rails before) or if it's best for us create a Gem to add this behavior.

### System configuration
**Rails version**: ~> 6.0

**Ruby version**: 2.6.6
",https://api.github.com/repos/rails/rails/issues/42701/timeline,,victorlcampos,1539610,MDQ6VXNlcjE1Mzk2MTA=,https://avatars.githubusercontent.com/u/1539610?v=4,,https://api.github.com/users/victorlcampos,https://github.com/victorlcampos,https://api.github.com/users/victorlcampos/followers,https://api.github.com/users/victorlcampos/following{/other_user},https://api.github.com/users/victorlcampos/gists{/gist_id},https://api.github.com/users/victorlcampos/starred{/owner}{/repo},https://api.github.com/users/victorlcampos/subscriptions,https://api.github.com/users/victorlcampos/orgs,https://api.github.com/users/victorlcampos/repos,https://api.github.com/users/victorlcampos/events{/privacy},https://api.github.com/users/victorlcampos/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42701/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
330,https://api.github.com/repos/rails/rails/issues/42695,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42695/labels{/name},https://api.github.com/repos/rails/rails/issues/42695/comments,https://api.github.com/repos/rails/rails/issues/42695/events,https://github.com/rails/rails/pull/42695,936517506,MDExOlB1bGxSZXF1ZXN0NjgzMjE5NjU0,42695,Efficient yield in batches,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,10,2021-07-04T18:47:42Z,2022-04-22T03:21:37Z,,NONE,,"### Summary

This PR intends to improve the efficiency of yielded relations from the `in_batches` method. Yielded relations now produce sql that more closely align with the original iteration pattern. Instead of defining an `IN` clause for all primary ids, a finish clause is added that bounds the last batch. `IN` queries with large batch sizes can be significantly less efficient. By replicating the initial iteration pattern closely, we can ensure the yielded relation is no less efficient than the original iteration pass. 

The original motivation for the `IN` query is [here](https://github.com/rails/rails/pull/20899#issuecomment-122541749). This PR also satisfies the original motivation.

The yielded relations are still subject to race conditions, though the behavior changes very slightly. The original implementation would guarantee that _the number of records returned by a yielded relation would be less or equal to the batch size_. This implementation does not guarantee this. It does, however, ensure that _all records within that batch interval are returned_, meaning that this could be more useful for dividing up work.

As a matter of potential impact, because the records are loaded into the yielded relation, it is unlikely for most callers to experience any change in behavior. To experience the effect of this change (beyond the reduced memory pressure of a simpler sql representation), one would need to further alter the relation to ""unload"" the existing records.

No new tests exist because no guarantees are expressed in documentation for which behavior changes. Beyond performance differences, behavior only changes under race conditions, which is expressed in the rdocs by `By its nature, batch processing is subject to race conditions if other processes are modifying the database.`

### Example

```
Post.in_batches(of: 2) Post.in_batches(of: 2) do |relation|
  puts relation.to_sql
end
```

#### Before
```
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" IN (1, 2)
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" IN (3, 4)
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" IN (5, 6)
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" IN (7, 8)
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" IN (9, 10)
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" = 11
```

#### After
```
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" <= 2 ORDER BY ""posts"".""id"" ASC
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" > 2 AND ""posts"".""id"" <= 4 ORDER BY ""posts"".""id"" ASC
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" > 4 AND ""posts"".""id"" <= 6 ORDER BY ""posts"".""id"" ASC
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" > 6 AND ""posts"".""id"" <= 8 ORDER BY ""posts"".""id"" ASC
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" > 8 AND ""posts"".""id"" <= 10 ORDER BY ""posts"".""id"" ASC
SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" > 10 AND ""posts"".""id"" <= 11 ORDER BY ""posts"".""id"" ASC
```

### Possible Variants

It would be possible to ensure the last yielded iteration does not have a finish (inclusive comparison) clause if no limit was provided. This mean that the final batch could become significantly larger than other batches with an append-only insert pattern under heavy write pressure, but it would guarantee that _the sum of all records from the yielded relations under a transaction would be equivalent to the records returned by the original relation under a transaction_. If this change is desired, I can implement it.

Alternately, if we would like to retain the guarantee of the original implementation that _the number of records returned by a yielded relation would be less or equal to the batch size_, then we can add a limit clause to each yielded relation.

### Other Information

This code change lays the ground work for two subsequent PRs:
https://github.com/montokapro/rails/pull/2 - Non-primary keys in batches
https://github.com/montokapro/rails/pull/1 - Composite keys in batches

The PR is meant to stand alone, regardless of whether the downstream PRs are accepted.",https://api.github.com/repos/rails/rails/issues/42695/timeline,,montokapro,35639676,MDQ6VXNlcjM1NjM5Njc2,https://avatars.githubusercontent.com/u/35639676?v=4,,https://api.github.com/users/montokapro,https://github.com/montokapro,https://api.github.com/users/montokapro/followers,https://api.github.com/users/montokapro/following{/other_user},https://api.github.com/users/montokapro/gists{/gist_id},https://api.github.com/users/montokapro/starred{/owner}{/repo},https://api.github.com/users/montokapro/subscriptions,https://api.github.com/users/montokapro/orgs,https://api.github.com/users/montokapro/repos,https://api.github.com/users/montokapro/events{/privacy},https://api.github.com/users/montokapro/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42695/reactions,2,2,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42695,https://github.com/rails/rails/pull/42695,https://github.com/rails/rails/pull/42695.diff,https://github.com/rails/rails/pull/42695.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
331,https://api.github.com/repos/rails/rails/issues/42691,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42691/labels{/name},https://api.github.com/repos/rails/rails/issues/42691/comments,https://api.github.com/repos/rails/rails/issues/42691/events,https://github.com/rails/rails/pull/42691,936339824,MDExOlB1bGxSZXF1ZXN0NjgzMDg3Mjc2,42691,Improve mysql2 mismatched foreign keys reporting,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,4,2021-07-03T23:00:43Z,2022-01-25T12:27:14Z,,CONTRIBUTOR,,"When we add multiple foreign keys at the same time via `ALTER/CREATE TABLE` and one of them has mismatched type, mysql adapter always parses and reports the first `FOREIGN KEY ... REFERENCES` statement from the error message.

We do not always know the exact failed foreign key reference.

MariaDB does not report the failing column name in its error: 
Error Code | Error | Description
--- | --- | ---
1215 | ER_CANNOT_ADD_FOREIGN | Cannot add foreign key constraint

But MySQL does in one case:
Error Code | Error | Description
--- | --- | ---
1215 | ER_CANNOT_ADD_FOREIGN | Cannot add foreign key constraint
3780 | ER_FK_INCOMPATIBLE_COLUMNS | Referencing column '%s' and referenced column '%s' in foreign key constraint '%s' are incompatible.

This case seems the most popular for me.

We can handle another case, but that would require brittle parsing of errored sql to determine all columns used in foreign keys, their types and comparing these types with types of the primary keys from the referenced tables.

Closes #42661
",https://api.github.com/repos/rails/rails/issues/42691/timeline,,fatkodima,5657035,MDQ6VXNlcjU2NTcwMzU=,https://avatars.githubusercontent.com/u/5657035?v=4,,https://api.github.com/users/fatkodima,https://github.com/fatkodima,https://api.github.com/users/fatkodima/followers,https://api.github.com/users/fatkodima/following{/other_user},https://api.github.com/users/fatkodima/gists{/gist_id},https://api.github.com/users/fatkodima/starred{/owner}{/repo},https://api.github.com/users/fatkodima/subscriptions,https://api.github.com/users/fatkodima/orgs,https://api.github.com/users/fatkodima/repos,https://api.github.com/users/fatkodima/events{/privacy},https://api.github.com/users/fatkodima/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42691/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42691,https://github.com/rails/rails/pull/42691,https://github.com/rails/rails/pull/42691.diff,https://github.com/rails/rails/pull/42691.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
332,https://api.github.com/repos/rails/rails/issues/42661,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42661/labels{/name},https://api.github.com/repos/rails/rails/issues/42661/comments,https://api.github.com/repos/rails/rails/issues/42661/events,https://github.com/rails/rails/issues/42661,934070008,MDU6SXNzdWU5MzQwNzAwMDg=,42661,ActiveRecord migrations report an error on the wrong column,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,1,2021-06-30T19:48:04Z,2021-12-22T00:21:51Z,,NONE,,"I experienced this in MySQL, though it may show in other adapters. I did not see this in the SQLite adapter.

In this case the error reported when running this migration indicated that the problematic column was the bigint_id_model foreign key column, when it was actually the integer_id_model.

We seem to report the first column for other issues on the second column as well, this was just the first one I saw.

Please let me know if there is anything I can do to improve the self-executing test case as well. If it is preferred to handle database creation and dropping in the test I can do that as well 😄 

### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""6.1.0""
  gem ""mysql2""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(
  adapter: ""mysql2"",
  user: ""root"",
  database: ""migration_error_issue_test""
)
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :integer_id_models, id: false do |t|
    t.integer :id, primary_key: true
  end

  create_table :bigint_id_models do |t|
  end
end


class CreateRelationshipModels < ActiveRecord::Migration[6.1]
  def change
    create_table :relationship_models do |t|
      t.references :bigint_id_model, null: false, foreign_key: true
      t.references :integer_id_model, null: false, foreign_key: true

      t.timestamps
    end
  end
end

class BugTest < Minitest::Test
  def test_migration_up
    CreateRelationshipModels.migrate(:up)

  rescue => error
    p error
    refute_includes error.message, ""bigint_id_model_id""
    assert_includes error.message, ""integer_id_model_id""
  end
end
```

### Expected behavior
The error reported should mention the `integer_id_model` reference having the wrong type.

### Actual behavior
The error reported mentions the `bigint_id_model` reference having the wrong type.

### System configuration
**Rails version**: 6.1.0

**Ruby version**: 2.6.3
",https://api.github.com/repos/rails/rails/issues/42661/timeline,,lelandmiller,3421478,MDQ6VXNlcjM0MjE0Nzg=,https://avatars.githubusercontent.com/u/3421478?v=4,,https://api.github.com/users/lelandmiller,https://github.com/lelandmiller,https://api.github.com/users/lelandmiller/followers,https://api.github.com/users/lelandmiller/following{/other_user},https://api.github.com/users/lelandmiller/gists{/gist_id},https://api.github.com/users/lelandmiller/starred{/owner}{/repo},https://api.github.com/users/lelandmiller/subscriptions,https://api.github.com/users/lelandmiller/orgs,https://api.github.com/users/lelandmiller/repos,https://api.github.com/users/lelandmiller/events{/privacy},https://api.github.com/users/lelandmiller/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42661/reactions,3,3,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
333,https://api.github.com/repos/rails/rails/issues/42650,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42650/labels{/name},https://api.github.com/repos/rails/rails/issues/42650/comments,https://api.github.com/repos/rails/rails/issues/42650/events,https://github.com/rails/rails/pull/42650,933656595,MDExOlB1bGxSZXF1ZXN0NjgwODMxODgz,42650,Normalize virtual attributes on ActiveRecord::Persistence#becomes,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2021-06-30T12:30:49Z,2022-04-19T21:11:30Z,,CONTRIBUTOR,,"### Summary

When source and target classes have a different set of attributes normalizes
attributes such that:
  - Extra attributes from source are removed
  - Extra attributes from target are kept

Fixes #41195

Co-authored-by: @SampsonCrowley 

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/42650/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42650/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42650,https://github.com/rails/rails/pull/42650,https://github.com/rails/rails/pull/42650.diff,https://github.com/rails/rails/pull/42650.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
334,https://api.github.com/repos/rails/rails/issues/42637,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42637/labels{/name},https://api.github.com/repos/rails/rails/issues/42637/comments,https://api.github.com/repos/rails/rails/issues/42637/events,https://github.com/rails/rails/issues/42637,932517972,MDU6SXNzdWU5MzI1MTc5NzI=,42637,Association `reset` does not work as expected when you then call `save`,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2021-06-29T11:21:49Z,2021-06-29T21:14:23Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :publishers, force: true do |t|
    t.integer :post_id
    t.datetime :expires_at
  end
end

class Post < ActiveRecord::Base
  has_one :active_publisher, -> { active }, class_name: ""Publisher""
end

class Publisher < ActiveRecord::Base
  def self.active
    where(expires_at: nil).or(expiring)
  end

  def self.expiring
    where(""expires_at > ?"", Time.current)
  end
end

class BugTest < Minitest::Test
  # this fails
  def test_association_reset_then_save
    post = Post.create
    post.create_active_publisher
    post.active_publisher.update(expires_at: Time.current)
    post.association(:active_publisher).reset

    # this loads the `active_publisher` association using the already-set `@association_scope`,
    # which now has a stale timestamp - the publisher has already expired
    # but its expiry is in the future according to the timestamp set in `@association_scope`
    post.save

    assert_nil post.active_publisher
  end

  # this passes
  def test_association_reset
    post = Post.create
    post.create_active_publisher
    post.active_publisher.update(expires_at: Time.current)

    post.association(:active_publisher).reset

    assert_nil post.active_publisher
  end
end
```

### Expected behavior
<!-- Tell us what should happen -->

I _think_ both the tests in the above test case should pass, but only one does. 

When we load an association (`active_publisher`) on an object (`post`), then reset that association (`post.association(:active_publisher).reset`), the next time the association is loaded should trigger a fresh query to find any associated record. That fresh query should invoke the association's `scope` realtime, so if the `scope` refers to `Time.current`, that should evaluate to the time when the association is loaded (not the time when the association was first loaded).

### Actual behavior
<!-- Tell us what happens instead -->

After loading an association on an object then resetting the association, calling `save` on the object has the effect of loading the association again (as part of `AutosaveAssocation#save_has_one_association`). When the association is loaded in this way, the query to find the associated record is based on the `scope` as it was evaluated originally. The conditions are not re-evaluated, meaning they can be stale. In this example, an expired `publisher` is returned as if its expiry is still in the future, because the timestamp in the `scope` is now out-of-date. 

The implication is (as an example) that if we do the following:
- `post.create_active_publisher`
- `post.active_publisher.update(expires_at: Time.current)`
- `post.assocation(:active_publisher).reset`
- `post.save`
- `post.create_active_publisher`

the original `publisher` will be deleted or its foreign key set to `nil`, because it will be handled as if it is still an `active_publisher` the second time `post.create_active_publisher` is called.

A workaround is to call `post.association(:active_publisher).reset_scope` as well as `post.association(:active_publisher).reset`, but would it be less surprising for `reset` to _include_ `reset_scope` automatically?

### System configuration
**Rails version**: 7.0.0.alpha

**Ruby version**: 2.7.0",https://api.github.com/repos/rails/rails/issues/42637/timeline,,ollieh-m,17131096,MDQ6VXNlcjE3MTMxMDk2,https://avatars.githubusercontent.com/u/17131096?v=4,,https://api.github.com/users/ollieh-m,https://github.com/ollieh-m,https://api.github.com/users/ollieh-m/followers,https://api.github.com/users/ollieh-m/following{/other_user},https://api.github.com/users/ollieh-m/gists{/gist_id},https://api.github.com/users/ollieh-m/starred{/owner}{/repo},https://api.github.com/users/ollieh-m/subscriptions,https://api.github.com/users/ollieh-m/orgs,https://api.github.com/users/ollieh-m/repos,https://api.github.com/users/ollieh-m/events{/privacy},https://api.github.com/users/ollieh-m/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42637/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
335,https://api.github.com/repos/rails/rails/issues/42607,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42607/labels{/name},https://api.github.com/repos/rails/rails/issues/42607/comments,https://api.github.com/repos/rails/rails/issues/42607/events,https://github.com/rails/rails/issues/42607,930386173,MDU6SXNzdWU5MzAzODYxNzM=,42607,Rails exits with zero code if launched with invalid parameters in command-line outside of project directory,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2021-06-25T17:55:26Z,2021-06-25T18:21:25Z,,NONE,,"I noticed this problem while configuring CI. I called `rails db:migrate` from incorrect folder. It passed: it rendered usage instructions without returning any error code.

### Steps to reproduce

When called outside of project directory
```bash
rails some-invalid-argument
```

### Expected behavior
Renders usage instructions and return a non-zero exit code

### Actual behavior
Renders usage instructions and returns a zero exit code as if there is no error.

### System configuration
**Rails version**:
7.0.0.alpha

**Ruby version**:
2.7.3
",https://api.github.com/repos/rails/rails/issues/42607/timeline,,endenis,1074181,MDQ6VXNlcjEwNzQxODE=,https://avatars.githubusercontent.com/u/1074181?v=4,,https://api.github.com/users/endenis,https://github.com/endenis,https://api.github.com/users/endenis/followers,https://api.github.com/users/endenis/following{/other_user},https://api.github.com/users/endenis/gists{/gist_id},https://api.github.com/users/endenis/starred{/owner}{/repo},https://api.github.com/users/endenis/subscriptions,https://api.github.com/users/endenis/orgs,https://api.github.com/users/endenis/repos,https://api.github.com/users/endenis/events{/privacy},https://api.github.com/users/endenis/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42607/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
336,https://api.github.com/repos/rails/rails/issues/42602,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42602/labels{/name},https://api.github.com/repos/rails/rails/issues/42602/comments,https://api.github.com/repos/rails/rails/issues/42602/events,https://github.com/rails/rails/pull/42602,930197267,MDExOlB1bGxSZXF1ZXN0Njc3OTMzMTY1,42602,`eager_loading?` works when ordering tables with a schema prefix.,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2021-06-25T13:54:06Z,2022-02-18T12:21:22Z,,CONTRIBUTOR,,"### Summary

Some DBMS (e.g. PostgreSQL) allows to define multiple schemas per database.
`eager_loading?` now works when ordering using a table name which contains a schema prefix.

Fixes #42331

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->


<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/42602/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42602/reactions,2,2,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42602,https://github.com/rails/rails/pull/42602,https://github.com/rails/rails/pull/42602.diff,https://github.com/rails/rails/pull/42602.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
337,https://api.github.com/repos/rails/rails/issues/42575,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42575/labels{/name},https://api.github.com/repos/rails/rails/issues/42575/comments,https://api.github.com/repos/rails/rails/issues/42575/events,https://github.com/rails/rails/pull/42575,928123279,MDExOlB1bGxSZXF1ZXN0Njc2MTcxNjE3,42575,Read `has_one` through association target from memory for new records,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,9,2021-06-23T10:49:15Z,2022-02-11T13:13:32Z,,CONTRIBUTOR,,"### Summary

When reading an `has_one` through association for a new record and loading from DB is not possible retrieves the association target from the in memory through association.

Fixes #42387

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/42575/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42575/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42575,https://github.com/rails/rails/pull/42575,https://github.com/rails/rails/pull/42575.diff,https://github.com/rails/rails/pull/42575.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
338,https://api.github.com/repos/rails/rails/issues/42561,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42561/labels{/name},https://api.github.com/repos/rails/rails/issues/42561/comments,https://api.github.com/repos/rails/rails/issues/42561/events,https://github.com/rails/rails/issues/42561,927464947,MDU6SXNzdWU5Mjc0NjQ5NDc=,42561,`#with` cannot be used with strings in 6.1,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,6,2021-06-22T17:17:36Z,2021-06-23T01:39:00Z,,CONTRIBUTOR,,"### Steps to reproduce

Using `#with` with strings instead of relations stopped working between Rails 6.0 and 6.1. Specifically, the following commit caused the break:

https://github.com/rails/rails/commit/596469d556fa924bd792288668f7f0fbdea518f2

In Rails 6.0, you could do things like 

```ruby
popular_posts_from_cte = Post.with(""popular_posts AS (SELECT * FROM posts WHERE views_count > 100)"").from(""popular_posts AS posts"")
```

However, that broke in Rails 6.1 with the following exception as there is no case to handle strings in the `case` statement:

```
TypeError: no implicit conversion of nil into String
```

A patch to fix the issue is forth coming.

### Expected behavior

The SQL should generate when strings are used in `#with` values.

### Actual behavior

A `TypeError` is raised.

### System configuration

**Rails version**: 6.1.3.2

**Ruby version**: 2.7.3
",https://api.github.com/repos/rails/rails/issues/42561/timeline,,dark-panda,84783,MDQ6VXNlcjg0Nzgz,https://avatars.githubusercontent.com/u/84783?v=4,,https://api.github.com/users/dark-panda,https://github.com/dark-panda,https://api.github.com/users/dark-panda/followers,https://api.github.com/users/dark-panda/following{/other_user},https://api.github.com/users/dark-panda/gists{/gist_id},https://api.github.com/users/dark-panda/starred{/owner}{/repo},https://api.github.com/users/dark-panda/subscriptions,https://api.github.com/users/dark-panda/orgs,https://api.github.com/users/dark-panda/repos,https://api.github.com/users/dark-panda/events{/privacy},https://api.github.com/users/dark-panda/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42561/reactions,1,0,0,0,0,0,0,0,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
339,https://api.github.com/repos/rails/rails/issues/42544,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42544/labels{/name},https://api.github.com/repos/rails/rails/issues/42544/comments,https://api.github.com/repos/rails/rails/issues/42544/events,https://github.com/rails/rails/issues/42544,925676307,MDU6SXNzdWU5MjU2NzYzMDc=,42544,ETags don't take assets into account,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,8,2021-06-20T20:29:39Z,2022-03-29T15:00:11Z,,CONTRIBUTOR,,"Consider the below controller action, layout, and view:

```ruby
class PostsController < ApplicationController
  def show
    @post = Post.find(params[:id])

    fresh_when @post
  end
end
```

```erb
<%# app/views/layouts/application.html.erb %>

<!DOCTYPE html>
<html>
  <head>
    <title>Sandbox</title>

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag ""application"" %>
    <%= javascript_pack_tag ""application"" %>
  </head>

  <body>
    <%= yield %>
  </body>
</html>
```

```erb
<%# app/views/posts/show.html.erb %>

<h1><%= @post.title %></h1>

<%= @post.content %>
```

Note the use of [`fresh_when`](https://edgeapi.rubyonrails.org/classes/ActionController/ConditionalGet.html#method-i-fresh_when) in `PostsController#show` to set an ETag response header based on `@post`.

1. Visit `/posts/1`, assuming a Post exists with ID 1.
2. Make and deploy a change to the `application` stylesheet.
3. Return to the app. Navigate away from `/posts/1` and back.

Your browser will perform a conditional GET using the ETag from the response to the request in step 1. It’ll receive a 304 Not Modified response from the app, even though the `application` stylesheet’s fingerprint has changed.

The browser will then request the old stylesheet. Worst case: the old stylesheet doesn’t exist anymore, and the page may be rendered unstyled. Best case: it does still exist, but it contains the old styles.

To fix, we could incorporate asset fingerprints into ETags by default. Low-touch: incorporate all asset fingerprints into ETags for all cached HTML requests. More sophisticated: only assets explicitly linked from the view.",https://api.github.com/repos/rails/rails/issues/42544/timeline,,georgeclaghorn,94129,MDQ6VXNlcjk0MTI5,https://avatars.githubusercontent.com/u/94129?v=4,,https://api.github.com/users/georgeclaghorn,https://github.com/georgeclaghorn,https://api.github.com/users/georgeclaghorn/followers,https://api.github.com/users/georgeclaghorn/following{/other_user},https://api.github.com/users/georgeclaghorn/gists{/gist_id},https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo},https://api.github.com/users/georgeclaghorn/subscriptions,https://api.github.com/users/georgeclaghorn/orgs,https://api.github.com/users/georgeclaghorn/repos,https://api.github.com/users/georgeclaghorn/events{/privacy},https://api.github.com/users/georgeclaghorn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42544/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
340,https://api.github.com/repos/rails/rails/issues/42531,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42531/labels{/name},https://api.github.com/repos/rails/rails/issues/42531/comments,https://api.github.com/repos/rails/rails/issues/42531/events,https://github.com/rails/rails/issues/42531,924487314,MDU6SXNzdWU5MjQ0ODczMTQ=,42531,ActiveRecord merge method error in Rails 6.0.4,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,9,2021-06-18T02:39:42Z,2022-02-14T12:09:27Z,,NONE,,"After updating to Rails 6.0.4, I got an error in the merge method of ActiveRecord.

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
# example
foos = Foo.joins(:bar).where(bars: { id: 1..10 })
bars = Bar.eager_load(:foos).merge(foos).records # error!
```

Rails 6.0.3.7

```sql
FROM
  ""bars""
  LEFT OUTER JOIN
    ""foos""
  ON  ""foos"".""bar_id"" = ""bars"".""id""
  INNER JOIN
    ""bars"" ""bars_foos""
  ON  ""bars_foos"".""id"" = ""foos"".""bar_id""
```

Rails 6.0.4

```sql
FROM
  ""bars""
  INNER JOIN
    ""bars"" ""bars_foos""
  ON  ""bars_foos"".""id"" = ""foos"".""bar_id"" -- foos table not found.
  LEFT OUTER JOIN
    ""foos""
  ON  ""foos"".""bar_id"" = ""bars"".""id""
```

### System configuration
**Rails version**: 6.0.4

**Ruby version**: 2.7.3

**Database**: PostgreSQL 11",https://api.github.com/repos/rails/rails/issues/42531/timeline,,patorash,672769,MDQ6VXNlcjY3Mjc2OQ==,https://avatars.githubusercontent.com/u/672769?v=4,,https://api.github.com/users/patorash,https://github.com/patorash,https://api.github.com/users/patorash/followers,https://api.github.com/users/patorash/following{/other_user},https://api.github.com/users/patorash/gists{/gist_id},https://api.github.com/users/patorash/starred{/owner}{/repo},https://api.github.com/users/patorash/subscriptions,https://api.github.com/users/patorash/orgs,https://api.github.com/users/patorash/repos,https://api.github.com/users/patorash/events{/privacy},https://api.github.com/users/patorash/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42531/reactions,1,1,0,0,0,0,0,0,0,,,,,,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
341,https://api.github.com/repos/rails/rails/issues/42520,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42520/labels{/name},https://api.github.com/repos/rails/rails/issues/42520/comments,https://api.github.com/repos/rails/rails/issues/42520/events,https://github.com/rails/rails/pull/42520,923520712,MDExOlB1bGxSZXF1ZXN0NjcyMjc4Mjk0,42520,Add top level rails application url,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,10,2021-06-17T06:38:04Z,2022-03-05T09:41:04Z,,NONE,,"### Summary

This PR adds an Rails.application.url as described in the open issue https://github.com/rails/rails/issues/39566. 

### Other Information

The http/request.rb object is a complicated one - with around 6 different modules mixed in - Rack::Helpers, Rack::Env and others. I renamed  ActionDispatch::Http::URL to ActionDispatch::Http::RequestURL as it is mainly building an URL out of the request object, for all the different settings and edge cases. Relying heavily on Rack in the background. Some of the methods, especially around constructing the port - need to stay part of RequestUrl as they are need to build the URL out of the request object and can not move to the URI class, unfortunately.

Once the url is build, we parse it and can work with it as an URI object. 

Also - with the next release of Rack, Rack::Request::Env will be gone and that needs to be reflected in ActionDispatch::Request Class then.

",https://api.github.com/repos/rails/rails/issues/42520/timeline,,aka47,7011,MDQ6VXNlcjcwMTE=,https://avatars.githubusercontent.com/u/7011?v=4,,https://api.github.com/users/aka47,https://github.com/aka47,https://api.github.com/users/aka47/followers,https://api.github.com/users/aka47/following{/other_user},https://api.github.com/users/aka47/gists{/gist_id},https://api.github.com/users/aka47/starred{/owner}{/repo},https://api.github.com/users/aka47/subscriptions,https://api.github.com/users/aka47/orgs,https://api.github.com/users/aka47/repos,https://api.github.com/users/aka47/events{/privacy},https://api.github.com/users/aka47/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42520/reactions,4,2,0,0,0,0,2,0,0,False,https://api.github.com/repos/rails/rails/pulls/42520,https://github.com/rails/rails/pull/42520,https://github.com/rails/rails/pull/42520.diff,https://github.com/rails/rails/pull/42520.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
342,https://api.github.com/repos/rails/rails/issues/42452,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42452/labels{/name},https://api.github.com/repos/rails/rails/issues/42452/comments,https://api.github.com/repos/rails/rails/issues/42452/events,https://github.com/rails/rails/pull/42452,918646886,MDExOlB1bGxSZXF1ZXN0NjY4MDU0NzY1,42452,Respect the `dependent: :destroy_async` when replacing the association,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,11,2021-06-11T11:49:49Z,2022-02-25T11:04:38Z,,NONE,,"See https://github.com/rails/rails/issues/42430

There are two ways for deleting an associated record:

  1. by deleting it explicitly (i.e. `parent.has_many.first.destroy!`),
  2. by replacing the association (i.e. `parent.has_many = []`).

Previously, Active Record respected the asynchronous deletion only with
the first approach. When replacing the association, it just detached the
record(s) from the parent without removing them from the database (via
enqueuing relevant background job).

Make the dependent option consistent and cleanup records from the
database even when removing them via replacing the association.

Fixes #42430",https://api.github.com/repos/rails/rails/issues/42452/timeline,,smt116,619324,MDQ6VXNlcjYxOTMyNA==,https://avatars.githubusercontent.com/u/619324?v=4,,https://api.github.com/users/smt116,https://github.com/smt116,https://api.github.com/users/smt116/followers,https://api.github.com/users/smt116/following{/other_user},https://api.github.com/users/smt116/gists{/gist_id},https://api.github.com/users/smt116/starred{/owner}{/repo},https://api.github.com/users/smt116/subscriptions,https://api.github.com/users/smt116/orgs,https://api.github.com/users/smt116/repos,https://api.github.com/users/smt116/events{/privacy},https://api.github.com/users/smt116/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42452/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42452,https://github.com/rails/rails/pull/42452,https://github.com/rails/rails/pull/42452.diff,https://github.com/rails/rails/pull/42452.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
343,https://api.github.com/repos/rails/rails/issues/42430,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42430/labels{/name},https://api.github.com/repos/rails/rails/issues/42430/comments,https://api.github.com/repos/rails/rails/issues/42430/events,https://github.com/rails/rails/issues/42430,916099836,MDU6SXNzdWU5MTYwOTk4MzY=,42430,Inconsistent behavior of `dependent: :destroy_async` for  the`has_many` association,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,9,2021-06-09T11:33:37Z,2022-03-08T15:26:38Z,,NONE,,"### Steps to reproduce

1. Generate a new application:

    ```
    rails new AsyncDestroyTestApp --skip-action-mailer --skip-action-mailbox --skip-action-text --skip-active-storage --skip-action-cable --skip-sprockets --skip-spring --skip-listen --skip-javascript --skip-turbolinks --skip-jbuilder --skip-test --skip-system-test --skip-bootsnap
    ```

2. Apply the following diff (add models):

    ```diff
    diff --git a/app/models/book.rb b/app/models/book.rb
    new file mode 100644
    index 0000000..f1e2a65
    --- /dev/null
    +++ b/app/models/book.rb
    @@ -0,0 +1,3 @@
    +class Book < ApplicationRecord
    +  has_many :tags, dependent: :destroy_async
    +end
    diff --git a/app/models/tag.rb b/app/models/tag.rb
    new file mode 100644
    index 0000000..7b23605
    --- /dev/null
    +++ b/app/models/tag.rb
    @@ -0,0 +1,2 @@
    +class Tag < ApplicationRecord
    +end
    diff --git a/db/migrate/20210609112034_add_books_and_tags.rb b/db/migrate/20210609112034_add_books_and_tags.rb
    new file mode 100644
    index 0000000..baed2c0
    --- /dev/null
    +++ b/db/migrate/20210609112034_add_books_and_tags.rb
    @@ -0,0 +1,8 @@
    +class AddBooksAndTags < ActiveRecord::Migration[6.1]
    +  def change
    +    create_table :books
    +    create_table :tags do |t|
    +      t.references :book, foreign_key: true, null: true
    +    end
    +  end
    +end
    diff --git a/db/schema.rb b/db/schema.rb
    new file mode 100644
    index 0000000..fca4c69
    --- /dev/null
    +++ b/db/schema.rb
    @@ -0,0 +1,24 @@
    +# This file is auto-generated from the current state of the database. Instead
    +# of editing this file, please use the migrations feature of Active Record to
    +# incrementally modify your database, and then regenerate this schema definition.
    +#
    +# This file is the source Rails uses to define your schema when running `bin/rails
    +# db:schema:load`. When creating a new database, `bin/rails db:schema:load` tends to
    +# be faster and is potentially less error prone than running all of your
    +# migrations from scratch. Old migrations may fail to apply correctly if those
    +# migrations use external dependencies or application code.
    +#
    +# It's strongly recommended that you check this file into your version control system.
    +
    +ActiveRecord::Schema.define(version: 2021_06_09_112034) do
    +
    +  create_table ""books"", force: :cascade do |t|
    +  end
    +
    +  create_table ""tags"", force: :cascade do |t|
    +    t.integer ""book_id""
    +    t.index [""book_id""], name: ""index_tags_on_book_id""
    +  end
    +
    +  add_foreign_key ""tags"", ""books""
    +end
    ````

### Expected behavior

Consistent behavior when removing records asynchronously via passing a new list to the `has_many` association (replacing). When you delete an object using `parent.has_many_attr.first.destroy!`, Active Record will update the child's foreign key to `nil` and schedule a job to delete an associated record from the database. However, when you will replace the ""has many"" association and delete the child (using `parent.update!(has_many_attr: [])`) it will only update the foreign key. It won't actually cleanup them from the database:

```ruby
irb(main):001:0> book = Book.create!(tags: [Tag.new, Tag.new])
   (2.4ms)  SELECT sqlite_version(*)
  TRANSACTION (0.1ms)  begin transaction
  Book Create (1.4ms)  INSERT INTO ""books"" DEFAULT VALUES
  Tag Create (1.2ms)  INSERT INTO ""tags"" (""book_id"") VALUES (?)  [[""book_id"", 1]]
  Tag Create (0.2ms)  INSERT INTO ""tags"" (""book_id"") VALUES (?)  [[""book_id"", 1]]
  TRANSACTION (2.1ms)  commit transaction
=> #<Book:0x00007fcfa24c0c60 id: 1>
irb(main):002:0> Tag.all
  Tag Load (0.3ms)  SELECT ""tags"".* FROM ""tags""
=> [#<Tag:0x00007fcfa258a420 id: 1, book_id: 1>, #<Tag:0x00007fcfa258a2b8 id: 2, book_id: 1>]
irb(main):003:0> book.tags.last.destroy!
  TRANSACTION (0.1ms)  begin transaction
  Tag Destroy (0.8ms)  DELETE FROM ""tags"" WHERE ""tags"".""id"" = ?  [[""id"", 2]]
  TRANSACTION (1.5ms)  commit transaction
=> #<Tag:0x00007fcfa24c31b8 id: 2, book_id: 1>
irb(main):004:0> Tag.all
  Tag Load (0.2ms)  SELECT ""tags"".* FROM ""tags""
=> [#<Tag:0x00007fcfa26c37b0 id: 1, book_id: 1>]
irb(main):005:0> book.update!(tags: [])
  TRANSACTION (0.1ms)  begin transaction
  Tag Update All (1.0ms)  UPDATE ""tags"" SET ""book_id"" = ? WHERE ""tags"".""book_id"" = ? AND ""tags"".""id"" IN (?, ?)  [[""book_id"", nil], [""book_id"", 1], [nil, 1], [nil, 2]]
  TRANSACTION (1.5ms)  commit transaction
=> true
irb(main):006:0> Tag.all
  Tag Load (0.2ms)  SELECT ""tags"".* FROM ""tags""
=> [#<Tag:0x00007fcfa25288b0 id: 1, book_id: nil>]
irb(main):007:0> book.update!(tags: [Tag.new])
  TRANSACTION (0.1ms)  begin transaction
  Tag Create (1.2ms)  INSERT INTO ""tags"" (""book_id"") VALUES (?)  [[""book_id"", 1]]
  TRANSACTION (9.4ms)  commit transaction
=> true
irb(main):008:0> Tag.all
  Tag Load (0.3ms)  SELECT ""tags"".* FROM ""tags""
=> [#<Tag:0x00007fcfa2e5b3d8 id: 1, book_id: nil>, #<Tag:0x00007fcfa2e5b310 id: 3, book_id: 1>]
```

Note that the tag with id = 1 is still there while Active Record should clean it up after calling `book.update!(tags: [])`.

### Actual behavior

Inconsistent behavior when replacing ""has many"" association (deleting some records asynchronously). Associated records are updated with the `null` value for the foreign key when replacing the association as the whole, but there are no delete jobs scheduled.

Note that using `dependant: :destroy` works as expected:

```ruby
irb(main):001:0> book = Book.create!(tags: [Tag.new, Tag.new])
   (1.2ms)  SELECT sqlite_version(*)
  TRANSACTION (0.1ms)  begin transaction
  Book Create (1.3ms)  INSERT INTO ""books"" DEFAULT VALUES
  Tag Create (0.4ms)  INSERT INTO ""tags"" (""book_id"") VALUES (?)  [[""book_id"", 1]]
  Tag Create (0.3ms)  INSERT INTO ""tags"" (""book_id"") VALUES (?)  [[""book_id"", 1]]
  TRANSACTION (1.6ms)  commit transaction
=> #<Book:0x00007fd0d6be2e78 id: 1>
irb(main):002:0> book.update!(tags: [])
  TRANSACTION (0.1ms)  begin transaction
  Tag Destroy (1.3ms)  DELETE FROM ""tags"" WHERE ""tags"".""id"" = ?  [[""id"", 1]]
  Tag Destroy (0.4ms)  DELETE FROM ""tags"" WHERE ""tags"".""id"" = ?  [[""id"", 2]]
  TRANSACTION (10.0ms)  commit transaction
=> true
irb(main):003:0> Tag.all
  Tag Load (0.3ms)  SELECT ""tags"".* FROM ""tags""
=> []
irb(main):004:0>
```

### System configuration
**Rails version**: 6.1.3.2

**Ruby version**: 3.0.1",https://api.github.com/repos/rails/rails/issues/42430/timeline,,smt116,619324,MDQ6VXNlcjYxOTMyNA==,https://avatars.githubusercontent.com/u/619324?v=4,,https://api.github.com/users/smt116,https://github.com/smt116,https://api.github.com/users/smt116/followers,https://api.github.com/users/smt116/following{/other_user},https://api.github.com/users/smt116/gists{/gist_id},https://api.github.com/users/smt116/starred{/owner}{/repo},https://api.github.com/users/smt116/subscriptions,https://api.github.com/users/smt116/orgs,https://api.github.com/users/smt116/repos,https://api.github.com/users/smt116/events{/privacy},https://api.github.com/users/smt116/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42430/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
344,https://api.github.com/repos/rails/rails/issues/42424,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42424/labels{/name},https://api.github.com/repos/rails/rails/issues/42424/comments,https://api.github.com/repos/rails/rails/issues/42424/events,https://github.com/rails/rails/issues/42424,915248782,MDU6SXNzdWU5MTUyNDg3ODI=,42424,Duplicate escaping of quotes in check constraint expressions (MySQL),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2021-06-08T16:48:12Z,2021-06-17T08:34:33Z,,NONE,,"### Steps to reproduce
With a check constraint in the (MySQL) database and the Rails project set to use the schema.rb format I end up with duplicate escape sequences for quotes in the expression of the check constraint.

1. Add a migration that adds a check constraints with an expression that includes quotes.
2. Run the migration (it runs fine)
3. Check the generated `schema.rb`
4. The generated `schema.rb` contains duplicate escaping for the quotes in the check constraint expression
5. Trying to load the schema `rails db:schema:load` leads to an SQL syntax error

Here is an executable version of the problem (I used MySQL`Ver 8.0.23 for osx10.15 on x86_64`): 

<!-- Paste your executable test case created from one of the scripts found [here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#create-an-executable-test-case) below: -->
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""activerecord"", ""~> 6.1.3""
  gem ""mysql2""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

ActiveRecord::Base.establish_connection(
  adapter: ""mysql2"",
  database: 'check_constraint_schema_dump_bug',
  charset: 'utfmb4',
  encoding: 'utf8mb4',
  collation: 'utf8mb4_unicode_ci',
  username: ENV.fetch(""MYSQL_USERNAME"") { ""rails"" },
  password: ENV.fetch(""MYSQL_PASSWORD"") { """" },
  host: ENV.fetch(""MYSQL_HOST"") { ""127.0.0.1"" },
  port: ENV.fetch(""MYSQL_PORT"") { 3306 }
)
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string :title
    t.check_constraint ""(title <> 'forbidden_title')""
  end
end

class BugTest < Minitest::Test
  def test_adapter_check_constraint_quoting
    expected = %q(`title` <> _utf8mb4'forbidden_title')

    assert_equal ActiveRecord::Base.connection.check_constraints('posts').first.expression, expected
  end

  def test_schema_dumper_not_including_wrong_quotes
    dumped_schema = ActiveRecord::SchemaDumper.dump(ActiveRecord::Base.connection, StringIO.new).string

    wrong = %q(t.check_constraint ""`title` <> _utf8mb4\\\\'forbidden_title\\\\'"")
    refute_includes dumped_schema, wrong
  end

  def test_schema_dumper_including_correct_quotes
    dumped_schema = ActiveRecord::SchemaDumper.dump(ActiveRecord::Base.connection, StringIO.new).string

    expected = %q(t.check_constraint ""`title` <> _utf8mb4'forbidden_title'"")
    assert_includes dumped_schema, expected
  end
end

```

### Expected behavior
E.g. a migration like this:

```ruby
create_table :posts, force: true do |t|
  t.string :title
  t.check_constraint ""(title <> 'forbidden_title')""
end
```

should generate a schema like that:
```ruby
create_table ""posts"", charset: ""utf8mb4"", force: :cascade do |t|
  t.string ""title""
  t.check_constraint ""`title` <> _utf8mb4'forbidden_title'""
end
```

### Actual behavior
It generates a schema like this:
```ruby
create_table ""posts"", charset: ""utf8mb4"", force: :cascade do |t|
  t.string ""title""
  t.check_constraint ""`title` <> _utf8mb4\\'forbidden_title\\'"" # <-- Notice the slashes
end
```

### System configuration
**Rails version**: 6.1.3.2

**Ruby version**: 2.6.3

### Potential fix
I created a monkey patch which fixes the issue for my project locally:
```ruby
module ActiveRecord
  module ConnectionAdapters
    class AbstractMysqlAdapter
      def check_constraints(table_name)
        if supports_check_constraints?
          scope = quoted_scope(table_name)

          chk_info = exec_query(<<~SQL, ""SCHEMA"")
            SELECT cc.constraint_name AS 'name',
                  cc.check_clause AS 'expression'
            FROM information_schema.check_constraints cc
            JOIN information_schema.table_constraints tc
            USING (constraint_schema, constraint_name)
            WHERE tc.table_schema = #{scope[:schema]}
              AND tc.table_name = #{scope[:name]}
              AND cc.constraint_schema = #{scope[:schema]}
          SQL

          chk_info.map do |row|
            options = {
              name: row[""name""]
            }
            expression = row[""expression""].gsub(""\\'"", ""'"") # <-- replace duplicate escaping
            expression = expression[1..-2] unless mariadb? # remove parentheses added by mysql
            CheckConstraintDefinition.new(table_name, expression, options)
          end
        else
          raise NotImplementedError
        end
      end
    end
  end
end
```

If this goes into the right direction I'd open up a pull request and write the corresponding tests.
Diff: https://github.com/rails/rails/compare/main...Flixt:fix-mysql-check-constraints-quoting?expand=1",https://api.github.com/repos/rails/rails/issues/42424/timeline,,Flixt,1724355,MDQ6VXNlcjE3MjQzNTU=,https://avatars.githubusercontent.com/u/1724355?v=4,,https://api.github.com/users/Flixt,https://github.com/Flixt,https://api.github.com/users/Flixt/followers,https://api.github.com/users/Flixt/following{/other_user},https://api.github.com/users/Flixt/gists{/gist_id},https://api.github.com/users/Flixt/starred{/owner}{/repo},https://api.github.com/users/Flixt/subscriptions,https://api.github.com/users/Flixt/orgs,https://api.github.com/users/Flixt/repos,https://api.github.com/users/Flixt/events{/privacy},https://api.github.com/users/Flixt/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42424/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
345,https://api.github.com/repos/rails/rails/issues/42387,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42387/labels{/name},https://api.github.com/repos/rails/rails/issues/42387/comments,https://api.github.com/repos/rails/rails/issues/42387/events,https://github.com/rails/rails/issues/42387,911357474,MDU6SXNzdWU5MTEzNTc0NzQ=,42387,Delegated Type associations do not cascade,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,7,2021-06-04T10:17:53Z,2021-06-23T16:04:03Z,,NONE,,"### Steps to reproduce

Consider the following:

```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  gem ""rails"", ""~> 6.1""
  gem ""sqlite3"", platform: :mri
end

require ""active_record""
require ""minitest/autorun""

ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :authors, force: true do |t|
    t.string :name
  end

  create_table :books, force: true do |t|
    t.references :author, null: false
    t.references :book_details, polymorphic: true, null: false
    t.string :title
  end

  create_table :nonfiction_books, force: true do |t|
    t.string :subject_area, null: false
  end
end

class Author < ActiveRecord::Base
  has_many :books, inverse_of: :author
end

class Book < ActiveRecord::Base
  belongs_to :author, inverse_of: :books

  delegated_type :book_details, types: %w[NonfictionBook], dependent: :destroy
end

class NonfictionBook < ActiveRecord::Base
  has_one :book, as: :book_details
  has_one :author, through: :book
end

class BugTest < Minitest::Test
  def test_nonfiction_book_has_author
    author = Author.new(name: ""Author"")
    book = Book.new(author: author, title: ""Book"")
    nonfiction_book = NonfictionBook.new(book: book, subject_area: ""Ruby on Rails"")

    assert_equal book.author, author
    assert_equal nonfiction_book.author, author
  end
end
```

### Expected behavior

Having assigned an author to the book, I expect to be able to ask the book details about its author.

### Actual behavior

The book's details have a `nil` author.

### System configuration
**Rails version**: ""~> 6.1""

**Ruby version**: ""ruby 3.0.1p64 (2021-04-05 revision 0fb782ee38) [x86_64-darwin20]""
",https://api.github.com/repos/rails/rails/issues/42387/timeline,,ball-hayden,1596233,MDQ6VXNlcjE1OTYyMzM=,https://avatars.githubusercontent.com/u/1596233?v=4,,https://api.github.com/users/ball-hayden,https://github.com/ball-hayden,https://api.github.com/users/ball-hayden/followers,https://api.github.com/users/ball-hayden/following{/other_user},https://api.github.com/users/ball-hayden/gists{/gist_id},https://api.github.com/users/ball-hayden/starred{/owner}{/repo},https://api.github.com/users/ball-hayden/subscriptions,https://api.github.com/users/ball-hayden/orgs,https://api.github.com/users/ball-hayden/repos,https://api.github.com/users/ball-hayden/events{/privacy},https://api.github.com/users/ball-hayden/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42387/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
346,https://api.github.com/repos/rails/rails/issues/42314,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42314/labels{/name},https://api.github.com/repos/rails/rails/issues/42314/comments,https://api.github.com/repos/rails/rails/issues/42314/events,https://github.com/rails/rails/pull/42314,906122565,MDExOlB1bGxSZXF1ZXN0NjU3MTU1NjIw,42314,make acts_like behavior more intuitive,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}]",open,False,,[],,5,2021-05-28T21:59:45Z,2022-02-02T18:14:38Z,,MEMBER,,"### Summary

Previously, defining an `acts_like-*?` method would result in `acts_like?`
returning true for that type no matter what the underlying method
returned. This change makes the result of `acts_like?` more intuitive:
the return value of `acts_like_*?` is respected.

### Other Information

Fixes #42292 
",https://api.github.com/repos/rails/rails/issues/42314/timeline,,SkipKayhil,6014046,MDQ6VXNlcjYwMTQwNDY=,https://avatars.githubusercontent.com/u/6014046?v=4,,https://api.github.com/users/SkipKayhil,https://github.com/SkipKayhil,https://api.github.com/users/SkipKayhil/followers,https://api.github.com/users/SkipKayhil/following{/other_user},https://api.github.com/users/SkipKayhil/gists{/gist_id},https://api.github.com/users/SkipKayhil/starred{/owner}{/repo},https://api.github.com/users/SkipKayhil/subscriptions,https://api.github.com/users/SkipKayhil/orgs,https://api.github.com/users/SkipKayhil/repos,https://api.github.com/users/SkipKayhil/events{/privacy},https://api.github.com/users/SkipKayhil/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42314/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42314,https://github.com/rails/rails/pull/42314,https://github.com/rails/rails/pull/42314.diff,https://github.com/rails/rails/pull/42314.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
347,https://api.github.com/repos/rails/rails/issues/42278,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42278/labels{/name},https://api.github.com/repos/rails/rails/issues/42278/comments,https://api.github.com/repos/rails/rails/issues/42278/events,https://github.com/rails/rails/issues/42278,899373402,MDU6SXNzdWU4OTkzNzM0MDI=,42278,Accessing request.params breaks parameter encoding validation,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,20,2021-05-24T07:26:39Z,2021-12-15T03:10:15Z,,MEMBER,,"Given a controller:

```ruby
class FooController < ApplicationController
  skip_parameter_encoding :index
  skip_before_action :verify_authenticity_token

  def index
    head :ok
  end
end
```

parameters in the `index` action should be able to carry any payload. For example, this should work

```ruby
require ""net/http""

uri = URI(""http://localhost:3000"")
Net::HTTP.post_form(uri, ""foo"" => ""\xe1"") # Invalid UTF-8.
```

and it does.

However, a middleware as innocent as

```ruby
class FooMiddleware
  def initialize(app)
    @app = app
  end

  def call(env)
    request = ActionDispatch::Request.new(env)
    request.params
    @app.call(request.env)
  end
end
```

interferes somehow with parameter encoding validation, and the request now raises

```
ActionController::BadRequest (Invalid request parameters: Invalid encoding for parameter: �)
```",https://api.github.com/repos/rails/rails/issues/42278/timeline,,fxn,3387,MDQ6VXNlcjMzODc=,https://avatars.githubusercontent.com/u/3387?v=4,,https://api.github.com/users/fxn,https://github.com/fxn,https://api.github.com/users/fxn/followers,https://api.github.com/users/fxn/following{/other_user},https://api.github.com/users/fxn/gists{/gist_id},https://api.github.com/users/fxn/starred{/owner}{/repo},https://api.github.com/users/fxn/subscriptions,https://api.github.com/users/fxn/orgs,https://api.github.com/users/fxn/repos,https://api.github.com/users/fxn/events{/privacy},https://api.github.com/users/fxn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42278/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
348,https://api.github.com/repos/rails/rails/issues/42271,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42271/labels{/name},https://api.github.com/repos/rails/rails/issues/42271/comments,https://api.github.com/repos/rails/rails/issues/42271/events,https://github.com/rails/rails/issues/42271,898698652,MDU6SXNzdWU4OTg2OTg2NTI=,42271,Fiber safe ActiveRecord connection pool ,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,22,2021-05-22T02:27:29Z,2022-02-06T13:37:30Z,,CONTRIBUTOR,,"I've been playing around with the AR connection pool and investigating it's behaviour when running on Falcon or using the fiber scheduler.

I'm comparing with the db gem, using a very predictable query: `SELECT pg_sleep(1)`.

Here is the fastest implementation - there is no thread local or fiber local state.

~~~ ruby
def db(env)
	Console.logger.measure(""db"") do
		@db.session do |session|
			session.query(""SELECT pg_sleep(1)"").call
		end
	end
	
	OK
end
~~~

The performance of this:

~~~
> wrk -t 1 -c 32 -d 10 https://localhost:9292/db
Running 10s test @ https://localhost:9292/db
  1 threads and 32 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency   974.00ms  311.65ms   1.13s    90.00%
    Req/Sec   104.67     98.23   282.00     71.43%
  320 requests in 10.07s, 19.69KB read
Requests/sec:     31.78
Transfer/sec:      1.96KB
~~~

The most direct comparison with ActiveRecord I could come up with looks like this:

~~~ ruby
def active_record_checkout(env)
	Console.logger.measure(""active_record"") do
		connection = ActiveRecord::Base.connection_pool.checkout
		connection.execute(""SELECT pg_sleep(1)"")
	ensure
		ActiveRecord::Base.connection_pool.checkin(connection)
	end
	
	OK
end
~~~

The performance of this Is still pretty good:

~~~
> wrk -t 1 -c 32 -d 10 https://localhost:9292/active_record_checkout
Running 10s test @ https://localhost:9292/active_record_checkout
  1 threads and 32 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.09s    70.48ms   1.31s    78.82%
    Req/Sec    90.14    120.47   303.00     78.57%
  288 requests in 9.98s, 17.72KB read
Requests/sec:     28.84
Transfer/sec:      1.77KB
~~~

This shows that AR is quite capable of decent performance. However the problem is the connection pool implementation is essentially incompatible with Fiber based event loops.

## `ConnectionPool#with_connection`

I wrote a similar implementation using `#with_connection` but found that internally it still uses a per-thread cache of connections. Each request has it's own fiber, but runs on the same thread, so what essentially happens is we end up with all the requests trying to use the same connection.

~~~ ruby
def active_record_with_connection(env)
	Console.logger.measure(""active_record"") do
		ActiveRecord::Base.connection_pool.with_connection do |connection|
			connection.execute(""SELECT pg_sleep(1)"")
		end
	end
	
	OK
end
~~~

My intuition is that `#with_connection` should be a direct wrapper around `checkout`/`checkin`. For example, I could imagine someone wants to use multiple connections during the same request for different queries.

The performance of this approach is therefore not that great, and it seems to get worse over time which makes me wonder if the fibers are clobbering each other.

~~~
> wrk -t 1 -c 32 -d 10 https://localhost:9292/active_record_with_connection
Running 10s test @ https://localhost:9292/active_record_with_connection
  1 threads and 32 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.31s    44.94ms   1.46s    95.52%
    Req/Sec     8.18     12.79    36.00     72.73%
  99 requests in 10.09s, 11.72KB read
  Socket errors: connect 0, read 0, write 0, timeout 32
  Non-2xx or 3xx responses: 28
Requests/sec:      9.81
Transfer/sec:      1.16KB
> wrk -t 1 -c 32 -d 10 https://localhost:9292/active_record_with_connection
Running 10s test @ https://localhost:9292/active_record_with_connection
  1 threads and 32 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.00us    0.00us   0.00us     nan%
    Req/Sec     6.00      0.00     6.00    100.00%
  32 requests in 10.00s, 8.41KB read
  Socket errors: connect 0, read 0, write 0, timeout 32
  Non-2xx or 3xx responses: 32
Requests/sec:      3.20
Transfer/sec:     860.76B
> wrk -t 1 -c 32 -d 10 https://localhost:9292/active_record_with_connection
Running 10s test @ https://localhost:9292/active_record_with_connection
  1 threads and 32 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.00us    0.00us   0.00us     nan%
    Req/Sec     4.00      2.83     6.00    100.00%
  45 requests in 10.06s, 11.82KB read
  Socket errors: connect 0, read 0, write 0, timeout 45
  Non-2xx or 3xx responses: 45
Requests/sec:      4.47
Transfer/sec:      1.18KB
~~~

The errors from Falcon are things like:

~~~
33.56s    error: Falcon::Adapters::Rack [oid=0x45b0] [ec=0x5898] [pid=85284] [2021-05-22 14:05:12 +1200]
               |   ActiveRecord::ConnectionTimeoutError: could not obtain a connection from the pool within 5.000 seconds (waited 5.011 seconds); all pooled connections were in use
               |   → /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:210 in `block in wait_poll'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:199 in `loop'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:199 in `wait_poll'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:160 in `internal_poll'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:286 in `internal_poll'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:155 in `block in poll'
               |     /Users/samuel/.rubies/ruby-head/lib/ruby/3.1.0/monitor.rb:202 in `synchronize'
               |     /Users/samuel/.rubies/ruby-head/lib/ruby/3.1.0/monitor.rb:202 in `mon_synchronize'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:164 in `synchronize'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:155 in `poll'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:870 in `acquire_connection'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:588 in `checkout'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:428 in `connection'
               |     /Users/samuel/.gem/ruby/3.1.0/gems/activerecord-6.1.3.2/lib/active_record/connection_adapters/abstract/connection_pool.rb:459 in `with_connection'
               |     config.ru:35 in `block in active_record_with_connection'
~~~

## `ActiveRecord::Base.connection.execute`

This is the most ""typical"" way I imagine AR would be used.

~~~ ruby
def active_record(env)
	Console.logger.measure(""active_record"") do
		ActiveRecord::Base.connection.execute(""SELECT pg_sleep(1)"")
	end
	
	OK
end
~~~

Not only that, but I'm not sure what the semantics should be for tidying up the connections afterwards. It feels like `ActiveRecord::Base.clear_active_connections!` is the wrong approach.

As you can imagine, the performance of this approach is problematic.

~~~
> wrk -t 1 -c 32 -d 10 https://localhost:9292/active_record
Running 10s test @ https://localhost:9292/active_record
  1 threads and 32 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     1.29s    67.90ms   1.33s    85.29%
    Req/Sec     2.44      7.33    22.00     88.89%
  40 requests in 10.07s, 2.46KB read
  Socket errors: connect 0, read 0, write 0, timeout 6
Requests/sec:      3.97
Transfer/sec:     250.24B
> wrk -t 1 -c 32 -d 10 https://localhost:9292/active_record
Running 10s test @ https://localhost:9292/active_record
  1 threads and 32 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     0.00us    0.00us   0.00us     nan%
    Req/Sec     0.00      0.00     0.00       nan%
  0 requests in 10.03s, 0.00B read
Requests/sec:      0.00
Transfer/sec:       0.00B
~~~

In my debug log, I can see that some requests are taking over 60 seconds, because they become essentially serialized - i.e. one after another.

## Non-blocking Database Adapters

The `pg` gem recently added basic support for the fiber scheduler. `mysql2` could also take a similar approach. The implementation leaves a lot to be desired, and I've implemented fully non-blocking database adapters in the `db` gem:

- https://github.com/socketry/db-postgres
- https://github.com/socketry/db-mariadb

These gems use specific non-blocking interfaces exposed by `libpq` and `libmariadbclient` respectively via FFI.

## Possible Solutions

It would be really wonderful to see AR take a position compatible with the fiber scheduler.

The way I typically approach the problem is that fiber local is the ""default"" execution context, which is true for Ruby. Therefore, it doesn't seem unreasonable to me to change the current implementation to be use `Fiber.current` instead of `Thread.current` for keying ""per-request"" connection state. However, this is also a bit more tricky w.r.t. cleaning up state. One main concern with this approach would be backwards compatibility.

The idea of having ""thread-local"" pools and ""fiber-local"" pools seems like moving the problem on to the user, so for me personally I don't like this approach. If you wish to retain a shared ""global pool"", using a multi-level - i.e. a pool cable of dealing with threads AND fibers might be the right approach - with a per-thread pool which doesn't require locking. Some memory allocators work like this and achieve impressive performance while still looking effectively ""global"".

Another option which is kind of more interesting to me, is to have establish generic interface e.g. in the above example of a memory allocator - `malloc` and `free` - for a pool maybe `checkout`/`checkin` or `acquire`/`release` (my preference). Then, allow users to provide their own connection pool. Have a standard interface for AREL feature detection, so that we can essentially have external database drivers. This way, I can easily plug in the work I've done in `db` gems.

## Summary

The current performance is essentially serialised due to the internal locking, and this produces poor performance. I believe that AR would benefit from a fiber aware connection pool. It might also be nice to have an official abstraction for connection pooling and generally ""drivers"", which allows us to plug in external database drivers more easily.",https://api.github.com/repos/rails/rails/issues/42271/timeline,,ioquatix,30030,MDQ6VXNlcjMwMDMw,https://avatars.githubusercontent.com/u/30030?v=4,,https://api.github.com/users/ioquatix,https://github.com/ioquatix,https://api.github.com/users/ioquatix/followers,https://api.github.com/users/ioquatix/following{/other_user},https://api.github.com/users/ioquatix/gists{/gist_id},https://api.github.com/users/ioquatix/starred{/owner}{/repo},https://api.github.com/users/ioquatix/subscriptions,https://api.github.com/users/ioquatix/orgs,https://api.github.com/users/ioquatix/repos,https://api.github.com/users/ioquatix/events{/privacy},https://api.github.com/users/ioquatix/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42271/reactions,29,0,0,0,0,0,24,0,5,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
349,https://api.github.com/repos/rails/rails/issues/42268,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42268/labels{/name},https://api.github.com/repos/rails/rails/issues/42268/comments,https://api.github.com/repos/rails/rails/issues/42268/events,https://github.com/rails/rails/issues/42268,898418163,MDU6SXNzdWU4OTg0MTgxNjM=,42268,Postgres + ActiveRecord::Point uses invalid equal operator (= instead of ~=) on find_or_create_by(),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}]",open,False,,[],,1,2021-05-21T20:01:09Z,2021-08-06T21:36:07Z,,NONE,,"### Steps to reproduce
```ruby
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""6.1.3.2""
  gem ""pg""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""postgresql"", database: ""test-db"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :addresses, force: true do |t|
    t.point :coordinates
  end
end

class Address < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_nested_saving
    address = Address.find_or_create_by!({ coordinates: ActiveRecord::Point.new(0, 0) })

    assert address
  end
end

```

### Expected behavior
I would expect it to use the correct `~=` operator for comparison when a `ActiveRecord::Point` type is provided (explicitly or otherwise). 

### Actual behavior
It attempts to use the `=` operator for equality comparison which is invalid (https://www.postgresql.org/docs/13/functions-geometry.html)

### System configuration
**Rails version**: Rails 6.1.3.2
**Ruby version**: ruby 3.0.1p64 (2021-04-05 revision 0fb782ee38) [x86_64-darwin20]
",https://api.github.com/repos/rails/rails/issues/42268/timeline,,aforty,523683,MDQ6VXNlcjUyMzY4Mw==,https://avatars.githubusercontent.com/u/523683?v=4,,https://api.github.com/users/aforty,https://github.com/aforty,https://api.github.com/users/aforty/followers,https://api.github.com/users/aforty/following{/other_user},https://api.github.com/users/aforty/gists{/gist_id},https://api.github.com/users/aforty/starred{/owner}{/repo},https://api.github.com/users/aforty/subscriptions,https://api.github.com/users/aforty/orgs,https://api.github.com/users/aforty/repos,https://api.github.com/users/aforty/events{/privacy},https://api.github.com/users/aforty/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42268/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
350,https://api.github.com/repos/rails/rails/issues/42251,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42251/labels{/name},https://api.github.com/repos/rails/rails/issues/42251/comments,https://api.github.com/repos/rails/rails/issues/42251/events,https://github.com/rails/rails/pull/42251,894273904,MDExOlB1bGxSZXF1ZXN0NjQ2NjYyMzU4,42251,Make Active Record adapters connections lazy,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,3,2021-05-18T11:25:18Z,2021-10-22T21:07:22Z,,CONTRIBUTOR,,"### Context

This is a rebase of an old branch: https://github.com/Shopify/rails/tree/lazy-connection.

Related: https://github.com/rails/rails/pull/42085

For resiliency reasons, it is paramount that Rails is able to boot even if it can't connect to the database, right now it is achieved by skipping Active Record attribute methods definition if an error happens (Ref: https://github.com/rails/rails/pull/40119).

But for historical reason, lots of important data is held by the `Adapter` and accessed through `ActiveRecord::Base.connection`, and that later does eagerly connect to the database.

If the `Adapter` would only connect when necessary, it would make it much easier to initialize the application without having a dependency on the database.",https://api.github.com/repos/rails/rails/issues/42251/timeline,,casperisfine,19192189,MDQ6VXNlcjE5MTkyMTg5,https://avatars.githubusercontent.com/u/19192189?v=4,,https://api.github.com/users/casperisfine,https://github.com/casperisfine,https://api.github.com/users/casperisfine/followers,https://api.github.com/users/casperisfine/following{/other_user},https://api.github.com/users/casperisfine/gists{/gist_id},https://api.github.com/users/casperisfine/starred{/owner}{/repo},https://api.github.com/users/casperisfine/subscriptions,https://api.github.com/users/casperisfine/orgs,https://api.github.com/users/casperisfine/repos,https://api.github.com/users/casperisfine/events{/privacy},https://api.github.com/users/casperisfine/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42251/reactions,0,0,0,0,0,0,0,0,0,True,https://api.github.com/repos/rails/rails/pulls/42251,https://github.com/rails/rails/pull/42251,https://github.com/rails/rails/pull/42251.diff,https://github.com/rails/rails/pull/42251.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
351,https://api.github.com/repos/rails/rails/issues/42248,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42248/labels{/name},https://api.github.com/repos/rails/rails/issues/42248/comments,https://api.github.com/repos/rails/rails/issues/42248/events,https://github.com/rails/rails/issues/42248,894016335,MDU6SXNzdWU4OTQwMTYzMzU=,42248,Update `relative_url_root` docs,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,"[{'login': 'zzak', 'id': 277819, 'node_id': 'MDQ6VXNlcjI3NzgxOQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/277819?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/zzak', 'html_url': 'https://github.com/zzak', 'followers_url': 'https://api.github.com/users/zzak/followers', 'following_url': 'https://api.github.com/users/zzak/following{/other_user}', 'gists_url': 'https://api.github.com/users/zzak/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/zzak/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/zzak/subscriptions', 'organizations_url': 'https://api.github.com/users/zzak/orgs', 'repos_url': 'https://api.github.com/users/zzak/repos', 'events_url': 'https://api.github.com/users/zzak/events{/privacy}', 'received_events_url': 'https://api.github.com/users/zzak/received_events', 'type': 'User', 'site_admin': False}]",,0,2021-05-18T06:31:12Z,2021-05-27T12:20:20Z,,NONE,,"A few things should be updated for the relative_url_root docs.

https://guides.rubyonrails.org/configuring.html#deploy-to-a-subdirectory-relative-url-root

> Firstly, regarding your point about `config.action_controller.relative_url_root` - that's what the configuration used to be called in earlier versions of Rails but has been moved to the general application config because it affects a number of areas in Rails - Action Mailer, Assets as well as Action Controller. It seems we missed one place to rename it in the guides and I apologise for that.

`config.action_controller.relative_url_root` should be changed to `config.relative_url_root`

`config.ru`:

``` ruby
map RelativeRoot::Application.config.relative_url_root || '/' do
  run Rails.application
end
```

> There's a very good reason why you need that there and it relates to the CGI environment variables [`SCRIPT_NAME`][1] and [`PATH_INFO`][2]. The former is what you'd consider the relative url root and Rails needs Rack to that set correctly when the app receives `call` with the request environment hash - if it's not set then you might as well just wrap all your routes in a `scope(""/sub"") { ... }` block. Using `map` creates a `Rack::URLMap` instance which [you can see from the code][3] sets `SCRIPT_NAME` and `PATH_INFO` to the desired values. When a Rails application has a mounted Engine (or other Rack app), those values then get adjusted so that you can easily mount them at different URLs without altering the Engine. The `SCRIPT_NAME` value takes precedence over the relative url config when there is a request context like in a controller but in other contexts like an Action Mailer view or an Active Job task there is no `SCRIPT_NAME` so there the relative url config is used. I hope this helps you understand the complex interactions at play here - it's not a simple matter of just prefixing `config.relative_url_root` onto every generated url.

This explanation and the `Rack::URLMap` example would be an amazing addition to the docs, especially if there was an included section for Puma.

[1]: https://datatracker.ietf.org/doc/html/rfc3875#section-4.1.13
[2]: https://datatracker.ietf.org/doc/html/rfc3875#section-4.1.5
[3]: https://github.com/rack/rack/blob/master/lib/rack/urlmap.rb

_Originally posted by @pixeltrix in https://github.com/rails/rails/issues/42243#issuecomment-842747962_",https://api.github.com/repos/rails/rails/issues/42248/timeline,,arianf,7397857,MDQ6VXNlcjczOTc4NTc=,https://avatars.githubusercontent.com/u/7397857?v=4,,https://api.github.com/users/arianf,https://github.com/arianf,https://api.github.com/users/arianf/followers,https://api.github.com/users/arianf/following{/other_user},https://api.github.com/users/arianf/gists{/gist_id},https://api.github.com/users/arianf/starred{/owner}{/repo},https://api.github.com/users/arianf/subscriptions,https://api.github.com/users/arianf/orgs,https://api.github.com/users/arianf/repos,https://api.github.com/users/arianf/events{/privacy},https://api.github.com/users/arianf/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42248/reactions,1,1,0,0,0,0,0,0,0,,,,,,,zzak,277819.0,MDQ6VXNlcjI3NzgxOQ==,https://avatars.githubusercontent.com/u/277819?v=4,,https://api.github.com/users/zzak,https://github.com/zzak,https://api.github.com/users/zzak/followers,https://api.github.com/users/zzak/following{/other_user},https://api.github.com/users/zzak/gists{/gist_id},https://api.github.com/users/zzak/starred{/owner}{/repo},https://api.github.com/users/zzak/subscriptions,https://api.github.com/users/zzak/orgs,https://api.github.com/users/zzak/repos,https://api.github.com/users/zzak/events{/privacy},https://api.github.com/users/zzak/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
352,https://api.github.com/repos/rails/rails/issues/42228,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42228/labels{/name},https://api.github.com/repos/rails/rails/issues/42228/comments,https://api.github.com/repos/rails/rails/issues/42228/events,https://github.com/rails/rails/issues/42228,892167323,MDU6SXNzdWU4OTIxNjczMjM=,42228,ActionText uploads show as completed before the upload request completes,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,0,2021-05-14T19:04:02Z,2021-05-17T03:07:02Z,,CONTRIBUTOR,,"When uploading an attachment using ActionText/trix, the progress bar in the trix control disappears after the data is finished sending, even if we're still waiting on the response to the upload request.

If you submit the form the trix control is on before the upload request is actually complete, the data for the upload will not be included in the form submission. (The issue is not so much that attachments whose requests aren't complete don't work when you submit, it's that the attachment appears to be done when it's not.)

When uploading to S3, the ""waiting"" period is regularly multiple seconds for me, so essentially I have to wait ~5s after the upload UI shows it as done before I can submit the form.

### Steps to reproduce

Monitor the browser dev tools while uploading an attachment using ActionText. Notice the progress bar goes away when the the request is done the ""sending"" phase, even though the request is not complete.

You can also override AttachmentUpload.directUploadWillStoreFileWithXHR to monitor this.

```
import { AttachmentUpload } from ""@rails/actiontext/app/javascript/actiontext/attachment_upload""

AttachmentUpload.prototype.directUploadWillStoreFileWithXHR = function(xhr) {
  xhr.upload.addEventListener(""progress"", event => {
    console.log(Date.now() + "" "" + (event.loaded / event.total * 100))
    const progress = event.loaded / event.total * 100
    this.attachment.setUploadProgress(progress)
  })
  xhr.upload.addEventListener(""load"", event => {
    console.log(Date.now() + "" - completely done"")
    this.attachment.setUploadProgress(100)
  })
}
```

```
1621017610817 31.191174399098486
1621017612622 100
1621017618265 - completely done
```

Timings as reported by Firefox:

```
Request Timing
Blocked: -1 ms
DNS Resolution: 0 ms
Connecting: 0 ms
TLS Setup: 0 ms
Sending: 1.81 s
Waiting: 5.69 s
Receiving: 0 ms
```

At timestamp 1621017612622, the progress bar disappears. If I submit the form in the 5 seconds between 1621017612622 and 1621017618265, my submission does not include the attachment.

### Expected behavior

Attachment does not appear to complete until it actually is.

### Actual behavior

Attachment shows as complete once the upload phase of the request is complete.

### System configuration

**Rails version**: 6.1.3.2
**Ruby version**: 2.6.6

### Workaround/fix

Override the method so that the ""progress"" event will never set the progress to 100, and add a ""load"" event listener to set it to 100 when complete.
```
import { AttachmentUpload } from ""@rails/actiontext/app/javascript/actiontext/attachment_upload""

AttachmentUpload.prototype.directUploadWillStoreFileWithXHR = function(xhr) {
  xhr.upload.addEventListener(""progress"", event => {
    const progress = Math.min(event.loaded / event.total * 100, 99.9)
    this.attachment.setUploadProgress(progress)
  })
  xhr.upload.addEventListener(""load"", event => {
    this.attachment.setUploadProgress(100)
  })
}
```",https://api.github.com/repos/rails/rails/issues/42228/timeline,,JasonBarnabe,583995,MDQ6VXNlcjU4Mzk5NQ==,https://avatars.githubusercontent.com/u/583995?v=4,,https://api.github.com/users/JasonBarnabe,https://github.com/JasonBarnabe,https://api.github.com/users/JasonBarnabe/followers,https://api.github.com/users/JasonBarnabe/following{/other_user},https://api.github.com/users/JasonBarnabe/gists{/gist_id},https://api.github.com/users/JasonBarnabe/starred{/owner}{/repo},https://api.github.com/users/JasonBarnabe/subscriptions,https://api.github.com/users/JasonBarnabe/orgs,https://api.github.com/users/JasonBarnabe/repos,https://api.github.com/users/JasonBarnabe/events{/privacy},https://api.github.com/users/JasonBarnabe/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42228/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
353,https://api.github.com/repos/rails/rails/issues/42125,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42125/labels{/name},https://api.github.com/repos/rails/rails/issues/42125/comments,https://api.github.com/repos/rails/rails/issues/42125/events,https://github.com/rails/rails/pull/42125,874007842,MDExOlB1bGxSZXF1ZXN0NjI4NjUyOTMx,42125,Fix numericality validator on decimal attribute with implicit scale,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,3,2021-05-02T18:13:59Z,2022-02-26T05:44:25Z,,MEMBER,,"#38212 added scale support to numericality validator on decimal
attribute.

That works as expected if a decimal attribute has explicit scale.

On the database-backed decimal type, implicit scale means that has no
scale. But the implementation of #38212 does no truncation in that case
(this behavior is correct for non-database-backed decimal type though).

To fix the issue on the database-backed decimal type, use the attribute
type object rather than extracting precision and scale and parsing
values on its own.
",https://api.github.com/repos/rails/rails/issues/42125/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/42125/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/42125,https://github.com/rails/rails/pull/42125,https://github.com/rails/rails/pull/42125.diff,https://github.com/rails/rails/pull/42125.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
354,https://api.github.com/repos/rails/rails/issues/42010,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/42010/labels{/name},https://api.github.com/repos/rails/rails/issues/42010/comments,https://api.github.com/repos/rails/rails/issues/42010/events,https://github.com/rails/rails/pull/42010,860564189,MDExOlB1bGxSZXF1ZXN0NjE3NDE0OTMw,42010,Add batched_method for custom batch preloading in ActiveRecord,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,4,2021-04-18T03:29:11Z,2021-07-26T12:33:10Z,,MEMBER,,"### Summary

Often with Rails models, we end up iterating over a collection or
relation and calling the same method repeatedly. For these cases,
`includes` comes in really handy, but it has the limitation that it
only works on associations. More complex logic needs separate one-off
code to load in a way that will still avoid N+1s.

We write a lot of code like this in our applications, and it became
clear that a lot of these shared the same type of interface. There would
be a class method that took in an `Array` of objects to load, and
returned a `Hash` where the keys of the hash are the elements in the
`Array` and the values are the results, which would be loaded all at once.
What would it look like to build this pattern into Rails?

This commit proposes an interface called `batched_method` which is a DSL
allowing for the definition of methods in models which play nice
with `includes` & `preload`, but can have any definition. The idea is
that you'd define a batch method like:

``` ruby
class Post < ActiveRecord::Base
  # An implementation which takes in an Array[Post], and returns
  # a Hash[Post => Array[Comment]]
  batch_method(:featured_comments) do |posts|
    comments_by_post_id = Comment.featured.where(post: posts).group_by(&:post_id)
    posts.index_with { |post| comments_by_post_id[post.id] }
  end
end
```

By writing the above implementation, you get the ability to call
`featured_comments` on a `Post` object like a normal method, but you can
also use `includes(:featured_comments)` and it loads them all the first
time that a single one is accessed (!).

I've been playing with this idea over in https://github.com/seejohnrun/prelude
(see README for more detail on motivations) for a bit and really think that
this would be a nice addition to Rails to help application authors think more
in terms of batching when iterating over model objects. I've taken
inspiration from over there, but rewritten the implementation to be clearer.

There are a bunch of ways that this can get more robust in the future,
but for this commit I've included a few neat additional features:

* The ability to define a `batch_size` on individual batch method
  definitions so that they load elements in batches only up to a certain
  size.

* The ability to define batched methods that take arguments. This is
  useful for common patterns like authentication checks where you want
  to batch things like `post.editable_by?(current_user)`.

* Compatibility with batch methods that happen to return a `Hash` with `#default_proc`.

Thanks for reading and I appreciate any feedback!

cc / @eileencodes & @jhawthorn who I've chatted with about this idea previously",https://api.github.com/repos/rails/rails/issues/42010/timeline,,seejohnrun,64965,MDQ6VXNlcjY0OTY1,https://avatars.githubusercontent.com/u/64965?v=4,,https://api.github.com/users/seejohnrun,https://github.com/seejohnrun,https://api.github.com/users/seejohnrun/followers,https://api.github.com/users/seejohnrun/following{/other_user},https://api.github.com/users/seejohnrun/gists{/gist_id},https://api.github.com/users/seejohnrun/starred{/owner}{/repo},https://api.github.com/users/seejohnrun/subscriptions,https://api.github.com/users/seejohnrun/orgs,https://api.github.com/users/seejohnrun/repos,https://api.github.com/users/seejohnrun/events{/privacy},https://api.github.com/users/seejohnrun/received_events,User,True,https://api.github.com/repos/rails/rails/issues/42010/reactions,4,0,0,0,0,0,4,0,0,False,https://api.github.com/repos/rails/rails/pulls/42010,https://github.com/rails/rails/pull/42010,https://github.com/rails/rails/pull/42010.diff,https://github.com/rails/rails/pull/42010.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
355,https://api.github.com/repos/rails/rails/issues/41966,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41966/labels{/name},https://api.github.com/repos/rails/rails/issues/41966/comments,https://api.github.com/repos/rails/rails/issues/41966/events,https://github.com/rails/rails/pull/41966,857136262,MDExOlB1bGxSZXF1ZXN0NjE0NjA3MDkw,41966,Use leading arguments with `...` instead of `ruby2_keywords` when possible,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,3,2021-04-13T16:37:11Z,2022-01-24T10:33:45Z,,MEMBER,,"This cannot be applied to the codebase since Rails 7.0 supports Ruby 2.7.0+ for now, so this is an experiment on how much code can be cleaned up.

Ruby 2.7.3 supports leading arguments together with `...`:

https://bugs.ruby-lang.org/issues/16378

Actually this is a new feature, but has been backported to Ruby 2.7.3 to
mitigate the pain of kwargs migration.
",https://api.github.com/repos/rails/rails/issues/41966/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41966/reactions,8,0,0,0,0,0,8,0,0,False,https://api.github.com/repos/rails/rails/pulls/41966,https://github.com/rails/rails/pull/41966,https://github.com/rails/rails/pull/41966.diff,https://github.com/rails/rails/pull/41966.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
356,https://api.github.com/repos/rails/rails/issues/41878,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41878/labels{/name},https://api.github.com/repos/rails/rails/issues/41878/comments,https://api.github.com/repos/rails/rails/issues/41878/events,https://github.com/rails/rails/pull/41878,853285432,MDExOlB1bGxSZXF1ZXN0NjExMzk4Njg3,41878,Fix validation of bi-directional accepts_nested_attributes,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2021-04-08T09:47:20Z,2022-01-29T11:53:15Z,,CONTRIBUTOR,,"### Summary

When defining bi-directional `accepts_nested_attributes` the validation of a collection doesn't work well: in particular only the last record of the collection is used. This happens because each child item in the collection calls `valid?` on the parent record erasing the previous validation errors stored in the parent.

Fixes the issue by tracking the record under validation and skipping cyclic `valid?` calls.

Fixes #41811

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->


<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/41878/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41878/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41878,https://github.com/rails/rails/pull/41878,https://github.com/rails/rails/pull/41878.diff,https://github.com/rails/rails/pull/41878.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
357,https://api.github.com/repos/rails/rails/issues/41870,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41870/labels{/name},https://api.github.com/repos/rails/rails/issues/41870/comments,https://api.github.com/repos/rails/rails/issues/41870/events,https://github.com/rails/rails/issues/41870,852772304,MDU6SXNzdWU4NTI3NzIzMDQ=,41870,ActiveRecord::Relation #one? and #many? methods break when query contains a .group(),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2021-04-07T20:10:41Z,2021-06-29T15:05:39Z,,NONE,,"### Steps to reproduce

Please use this gist: https://gist.github.com/mnacos/f81a2363d5e0ed925ff58e369690a9f3

This is not adapter-specific, I've reproduced with both postgres and sqlite.

### Expected behavior

Given:

```ruby
    post = Post.create!
    post.comments << Comment.create!
    post.comments << Comment.create!
    relation = Post.joins(:comments).group('posts.id')
```

You'd expect:

```ruby
    relation.one? == true
    relation.many? == false
```

### Actual behavior

Instead, we get:

```ruby
    relation.one? == false 
    relation.many? # throws TypeError: no implicit conversion of Integer into Hash
```

These methods rely on #size, which sometimes performs a #count, but #count on a query containing a .group() clause returns a Hash, e.g. `{1=>1}` if the query contains exactly one result.

### System configuration

**Rails version**: Edge

**Ruby version**: 2.7.1
",https://api.github.com/repos/rails/rails/issues/41870/timeline,,mnacos,107591,MDQ6VXNlcjEwNzU5MQ==,https://avatars.githubusercontent.com/u/107591?v=4,,https://api.github.com/users/mnacos,https://github.com/mnacos,https://api.github.com/users/mnacos/followers,https://api.github.com/users/mnacos/following{/other_user},https://api.github.com/users/mnacos/gists{/gist_id},https://api.github.com/users/mnacos/starred{/owner}{/repo},https://api.github.com/users/mnacos/subscriptions,https://api.github.com/users/mnacos/orgs,https://api.github.com/users/mnacos/repos,https://api.github.com/users/mnacos/events{/privacy},https://api.github.com/users/mnacos/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41870/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
358,https://api.github.com/repos/rails/rails/issues/41868,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41868/labels{/name},https://api.github.com/repos/rails/rails/issues/41868/comments,https://api.github.com/repos/rails/rails/issues/41868/events,https://github.com/rails/rails/issues/41868,852234911,MDU6SXNzdWU4NTIyMzQ5MTE=,41868,Including a scoped has_many..through association breaks the SQL in 6.1,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2021-04-07T09:54:41Z,2022-02-10T22:09:09Z,,NONE,,"### Steps to reproduce
 
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  # git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", ""6.1.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
  end

  create_table :comment_artefacts, force: true do |t|
    t.integer :comment_id
    t.integer :artefact_id
  end

  create_table :artefacts, force: true do |t|
    t.string :type
    t.integer :rank
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
  has_many :comment_artefacts
  has_many :artefacts, through: :comment_artefacts
  has_many :photos, through: :comment_artefacts, source: :artefact, class_name: ""PhotoArtefact""
  has_many :articles, -> { order(:rank) },  through: :comment_artefacts, source: :artefact, class_name: ""ArticleArtefact""
end

class CommentArtefact < ActiveRecord::Base
  belongs_to :comment
  belongs_to :artefact
end

class Artefact < ActiveRecord::Base
end

class PhotoArtefact < Artefact
end

class ArticleArtefact < Artefact
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!
    comment = post.comments.create!
    comment.photos << PhotoArtefact.create!(rank: 0)
    comment.articles << ArticleArtefact.create!(rank: 1)

    assert_equal 1, comment.photos.count
    assert_equal 1, comment.articles.count

    c = Comment.includes(:articles, :photos, :artefacts).find_by(id: 1)
    assert_equal 1, c.photos.pluck(:id).length # ⬅️ breaking test
  end
end

```

### Expected behavior

The associations should return the correct type of Single-Table-Inherited class and not the unscoped base class. Considering the example above, it should yield : 

```ruby
comment = Comment.includes(:articles, :photos, :artefacts).find_by(id: 1)
comment.photos.pluck(:id) # => returns a an array with the unique photo id: [1]
```

### Actual behavior
The association returns all artefacts, independently of the STI class used : 

```ruby 
comment = Comment.includes(:articles, :photos, :artefacts).find_by(id: 1)
comment.photos.pluck(:id) # => returns a an array all artefacs id for that comment:  [1, 2]
```

ℹ️ if I remove the scope used for the articles association `{ order(:rank) }`, it works again. Il also works for Rails versions prior to 6.1. It works with rails 6.1 if I move the scoped association at the end of the includes list.

### System configuration
**Rails version**: 6.1.3

**Ruby version**: 2.6.6
",https://api.github.com/repos/rails/rails/issues/41868/timeline,,virolea,3525369,MDQ6VXNlcjM1MjUzNjk=,https://avatars.githubusercontent.com/u/3525369?v=4,,https://api.github.com/users/virolea,https://github.com/virolea,https://api.github.com/users/virolea/followers,https://api.github.com/users/virolea/following{/other_user},https://api.github.com/users/virolea/gists{/gist_id},https://api.github.com/users/virolea/starred{/owner}{/repo},https://api.github.com/users/virolea/subscriptions,https://api.github.com/users/virolea/orgs,https://api.github.com/users/virolea/repos,https://api.github.com/users/virolea/events{/privacy},https://api.github.com/users/virolea/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41868/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
359,https://api.github.com/repos/rails/rails/issues/41855,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41855/labels{/name},https://api.github.com/repos/rails/rails/issues/41855/comments,https://api.github.com/repos/rails/rails/issues/41855/events,https://github.com/rails/rails/issues/41855,851596567,MDU6SXNzdWU4NTE1OTY1Njc=,41855,Connection closed during migrations under certain circumstances,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,4,2021-04-06T16:30:21Z,2021-04-20T15:32:53Z,,CONTRIBUTOR,,"MVCE: https://github.com/joshleblanc/sharding-migrations-bug

### Steps to reproduce

Create a new rails application

Create a sharded database with 

```yml
# database.yml
development:
  default:
    database: default
  archive:
    database: archive
```

```ruby
# application_record.rb
class ApplicationRecord < ActiveRecord::Base
  self.abstract_class = true

  connects_to shards: {
    default: {writing: :default, reading: :default},
    archive: {writing: :archive, reading: :archive}
  }
end
```

Create any model, then add a second migration that queries the database using the model, then runs an `execute` statement.

```ruby
class ThisShouldBreak < ActiveRecord::Migration[6.0]
  def up
    Author.count
    execute ""SELECT * from authors""
  end

  def down
    # no-op
  end
end
```

### Expected behavior

The migration should run

### Actual behavior

The connection is closed during the migration, triggering a rollback.

### System configuration
**Rails version**: Rails 6.1.3.1

**Ruby version**: ruby 2.7.2p137 (2020-10-01 revision 5445e04352) [x64-mingw32]
",https://api.github.com/repos/rails/rails/issues/41855/timeline,,joshleblanc,1729810,MDQ6VXNlcjE3Mjk4MTA=,https://avatars.githubusercontent.com/u/1729810?v=4,,https://api.github.com/users/joshleblanc,https://github.com/joshleblanc,https://api.github.com/users/joshleblanc/followers,https://api.github.com/users/joshleblanc/following{/other_user},https://api.github.com/users/joshleblanc/gists{/gist_id},https://api.github.com/users/joshleblanc/starred{/owner}{/repo},https://api.github.com/users/joshleblanc/subscriptions,https://api.github.com/users/joshleblanc/orgs,https://api.github.com/users/joshleblanc/repos,https://api.github.com/users/joshleblanc/events{/privacy},https://api.github.com/users/joshleblanc/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41855/reactions,2,2,0,0,0,0,0,0,0,,,,,,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,https://api.github.com/repos/rails/rails/milestones/79,https://github.com/rails/rails/milestone/79,https://api.github.com/repos/rails/rails/milestones/79/labels,6599195.0,MDk6TWlsZXN0b25lNjU5OTE5NQ==,79.0,6.1.4,,georgeclaghorn,94129.0,MDQ6VXNlcjk0MTI5,https://avatars.githubusercontent.com/u/94129?v=4,,https://api.github.com/users/georgeclaghorn,https://github.com/georgeclaghorn,https://api.github.com/users/georgeclaghorn/followers,https://api.github.com/users/georgeclaghorn/following{/other_user},https://api.github.com/users/georgeclaghorn/gists{/gist_id},https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo},https://api.github.com/users/georgeclaghorn/subscriptions,https://api.github.com/users/georgeclaghorn/orgs,https://api.github.com/users/georgeclaghorn/repos,https://api.github.com/users/georgeclaghorn/events{/privacy},https://api.github.com/users/georgeclaghorn/received_events,User,False,3.0,6.0,open,2021-03-27T12:10:57Z,2021-10-22T16:25:06Z,,
360,https://api.github.com/repos/rails/rails/issues/41848,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41848/labels{/name},https://api.github.com/repos/rails/rails/issues/41848/comments,https://api.github.com/repos/rails/rails/issues/41848/events,https://github.com/rails/rails/issues/41848,851050141,MDU6SXNzdWU4NTEwNTAxNDE=,41848,InsertAll does not work with tables with overridden primary_key,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2021-04-06T06:35:05Z,2021-06-03T15:17:53Z,,CONTRIBUTOR,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
In our case, we have a partitioned table in postgres 12, which requires us to set `self.primary_key = ""id""` in the model. Because of that, while `Model.primary_key` returns `""id""`, `ApplicationRecord.connection.schema_cache.primary_keys(Model.table_name)` returns `nil`.

### Expected behavior
<!-- Tell us what should happen -->
`insert_all` should keep working for this table after upgrading from 6.0.x to 6.1.3.1.

### Actual behavior
<!-- Tell us what happens instead -->
`insert_all` fails with error
```
     ArgumentError:
       No unique index found for id
     # /Users/grk/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.3.1/lib/active_record/insert_all.rb:82:in `find_unique_index_for'
     # /Users/grk/.asdf/installs/ruby/2.7.2/lib/ruby/gems/2.7.0/gems/activerecord-6.1.3.1/lib/active_record/insert_all.rb:25:in `initialize'
```

It seems that this is happening since https://github.com/rails/rails/commit/1af44e4aeeb04a6360b5104d8ee7b4a042ef93d8#diff-3f89af7ff219385718b7c0e4635cc4190476349db18f8bf80fb84fa1e7f5e289R35, where the array of primary keys is taken from the schema cache instead of the model. Because of that, https://github.com/rails/rails/commit/1af44e4aeeb04a6360b5104d8ee7b4a042ef93d8#diff-3f89af7ff219385718b7c0e4635cc4190476349db18f8bf80fb84fa1e7f5e289R64 does not pick up the case for inserting with uniqueness by primary key, as it compares `[""id""] == []`.

I'd like to open a PR but I'm not sure what the correct solution would be. One approach would be to revert to the previous implementation of `primary_keys`. Another would be to change it to something like `Array(connection.schema_cache.primary_keys(model.table_name)).presence || Array(model.primary_key)`.

### System configuration
**Rails version**: 6.1.3.1

**Ruby version**: 2.7.2
",https://api.github.com/repos/rails/rails/issues/41848/timeline,,grk,34018,MDQ6VXNlcjM0MDE4,https://avatars.githubusercontent.com/u/34018?v=4,,https://api.github.com/users/grk,https://github.com/grk,https://api.github.com/users/grk/followers,https://api.github.com/users/grk/following{/other_user},https://api.github.com/users/grk/gists{/gist_id},https://api.github.com/users/grk/starred{/owner}{/repo},https://api.github.com/users/grk/subscriptions,https://api.github.com/users/grk/orgs,https://api.github.com/users/grk/repos,https://api.github.com/users/grk/events{/privacy},https://api.github.com/users/grk/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41848/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
361,https://api.github.com/repos/rails/rails/issues/41830,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41830/labels{/name},https://api.github.com/repos/rails/rails/issues/41830/comments,https://api.github.com/repos/rails/rails/issues/41830/events,https://github.com/rails/rails/issues/41830,849574805,MDU6SXNzdWU4NDk1NzQ4MDU=,41830,Use RAILS_ENV to edit different credentials files,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,11,2021-04-03T04:28:44Z,2022-03-01T02:36:26Z,,CONTRIBUTOR,,"### Steps to reproduce

1. Run `rails credentials:edit` in development environment and add/edit credentials
2. Run `RAILS_ENV=production rails credentials:edit` to edit production credentials but same file opens up

### Expected behaviour
I expected `RAILS_ENV=production rails credentials:edit` to work much like `RAILS_ENV=production rails console`

### Actual behaviour
You actually need to specify the `--environment` flag in order to change environments. This is documented in the [PR introducing the feature](https://github.com/rails/rails/pull/33521) but not in the [Rails Guide](https://edgeguides.rubyonrails.org/security.html).

It also means you can run confusing commands like `RAILS_ENV=staging rails credentials:edit --environment production`

I suspect it was done this way to maintain backwards compatibility. It's only a minor paper cut but to me it violates the principle of least surprise.

If it needs to remain this way for backwards compatibility then clearer documentation would help (I'm happy to do a PR if that's the way forward). Additionally, if there is any way to detect someone has explicitly passed `RAILS_ENV` to this command, a warning explaining the correct way to edit the environment along with a link to the documentation would be very helpful.

### System configuration
**Rails version**: Rails 6.1.3

**Ruby version**: ruby 3.0.0p0 (2020-12-25 revision 95aff21468) [x86_64-darwin20]
",https://api.github.com/repos/rails/rails/issues/41830/timeline,,matt17r,19525237,MDQ6VXNlcjE5NTI1MjM3,https://avatars.githubusercontent.com/u/19525237?v=4,,https://api.github.com/users/matt17r,https://github.com/matt17r,https://api.github.com/users/matt17r/followers,https://api.github.com/users/matt17r/following{/other_user},https://api.github.com/users/matt17r/gists{/gist_id},https://api.github.com/users/matt17r/starred{/owner}{/repo},https://api.github.com/users/matt17r/subscriptions,https://api.github.com/users/matt17r/orgs,https://api.github.com/users/matt17r/repos,https://api.github.com/users/matt17r/events{/privacy},https://api.github.com/users/matt17r/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41830/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
362,https://api.github.com/repos/rails/rails/issues/41811,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41811/labels{/name},https://api.github.com/repos/rails/rails/issues/41811/comments,https://api.github.com/repos/rails/rails/issues/41811/events,https://github.com/rails/rails/issues/41811,846815677,MDU6SXNzdWU4NDY4MTU2Nzc=,41811,Rails bi-directional accepts_nested_attributes_for leads to unexpected validation result,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,10,2021-03-31T14:55:36Z,2022-04-22T21:39:45Z,,NONE,,"### Steps to reproduce

script: https://gist.github.com/rsalehi2013/7cf9c458af9923bcd3e2f3053cefcc55

**Setup**
Migration: 
```
create_table :posts do |t|
  t.string :title
end

create_table :comments do |t|
  t.integer :post_id
  t.string :body
end
```
post.rb
```
class Post < ActiveRecord::Base
  has_many :comments, inverse_of: :post
  accepts_nested_attributes_for :comments

  validates :title, presence: true
end
```
comment.rb
```
class Comment < ActiveRecord::Base
  belongs_to :post, inverse_of: :comments
  accepts_nested_attributes_for :post
  
  validates :body, presence: true
end
```
**Procedure**
post = Post.new(title: 'foo', comments_attributes: [{body: 'bar'}, {body: nil}, {body: 'baz'}])
post.valid?
post.errors

### Expected behavior
valid? -> false
errors -> @messages={:""comments.body""=>[""can't be blank""]}, @details={:""comments.body""=>[{:error=>:blank}]}
user is prevented from persisting to the database

### Actual behavior
valid? -> true
errors -> @messages={}, @details={}
user is able to persist the invalid records to the database

NOTE: if the invalid comments attribute is at the end of the comments_attributes list, or if there is only one item in the comments_attributes list, the post is correctly marked as invalid 

### System configuration
**Rails version**: Rails 5.2.4.5

**Ruby version**: ruby 2.5.8p224 (2020-03-31 revision 67882) [x86_64-linux]
",https://api.github.com/repos/rails/rails/issues/41811/timeline,,rsalehi2013,19552342,MDQ6VXNlcjE5NTUyMzQy,https://avatars.githubusercontent.com/u/19552342?v=4,,https://api.github.com/users/rsalehi2013,https://github.com/rsalehi2013,https://api.github.com/users/rsalehi2013/followers,https://api.github.com/users/rsalehi2013/following{/other_user},https://api.github.com/users/rsalehi2013/gists{/gist_id},https://api.github.com/users/rsalehi2013/starred{/owner}{/repo},https://api.github.com/users/rsalehi2013/subscriptions,https://api.github.com/users/rsalehi2013/orgs,https://api.github.com/users/rsalehi2013/repos,https://api.github.com/users/rsalehi2013/events{/privacy},https://api.github.com/users/rsalehi2013/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41811/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
363,https://api.github.com/repos/rails/rails/issues/41799,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41799/labels{/name},https://api.github.com/repos/rails/rails/issues/41799/comments,https://api.github.com/repos/rails/rails/issues/41799/events,https://github.com/rails/rails/pull/41799,844298402,MDExOlB1bGxSZXF1ZXN0NjAzNTYyMDAy,41799,Add caution notes to active storage migrations,"[{'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,8,2021-03-30T09:46:04Z,2022-04-18T22:11:50Z,,NONE,,"### Summary

The `service_name` migration contained in ActiveStorage 6.1 can cause downtime when run on semi-large production systems. This PR warns app maintainers about this, and suggests mitigations.

### Issues with the `add_service_name_to_active_storage_blobs` migration

I recently updated a semi-large production app to Rails 6.1, and ran into a 5 minutes downtime when running this ActiveStorage migration (plus some transcient errors until all instances were migrated).

From what I understand, there are two causes:

1. The `update_all` statement can take a long time (e.g. 1s for 100,000 records), during which the database may be entirely locked (at least on Postgres).
2. The `change_column` statement will make app instances not running on ActiveStorage 6.1 yet unable to create Blobs.

### Mitigations

This PR contains two commits:

1. **The first commit just adds comments** about the pitfalls of this migration. It makes developers aware of potential issue, and prompt them to adjust it themselves if needed.
2. **The second commit makes the migration asynchronous**, which avoids locking the database during the migration.

I guess just adding the comments to the `6-1-stable` branch would allow developers migrating to Rails 6.1 to make informed decisions. And in a second step, adding the actual mitigations could also be nice.",https://api.github.com/repos/rails/rails/issues/41799/timeline,,kemenaran,179923,MDQ6VXNlcjE3OTkyMw==,https://avatars.githubusercontent.com/u/179923?v=4,,https://api.github.com/users/kemenaran,https://github.com/kemenaran,https://api.github.com/users/kemenaran/followers,https://api.github.com/users/kemenaran/following{/other_user},https://api.github.com/users/kemenaran/gists{/gist_id},https://api.github.com/users/kemenaran/starred{/owner}{/repo},https://api.github.com/users/kemenaran/subscriptions,https://api.github.com/users/kemenaran/orgs,https://api.github.com/users/kemenaran/repos,https://api.github.com/users/kemenaran/events{/privacy},https://api.github.com/users/kemenaran/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41799/reactions,1,0,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/41799,https://github.com/rails/rails/pull/41799,https://github.com/rails/rails/pull/41799.diff,https://github.com/rails/rails/pull/41799.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
364,https://api.github.com/repos/rails/rails/issues/41730,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41730/labels{/name},https://api.github.com/repos/rails/rails/issues/41730/comments,https://api.github.com/repos/rails/rails/issues/41730/events,https://github.com/rails/rails/pull/41730,838110510,MDExOlB1bGxSZXF1ZXN0NTk4MzQyNTA3,41730,Propose a way to add validation on the enum attribute,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,8,2021-03-22T21:08:52Z,2022-04-07T13:28:08Z,,MEMBER,,"Last year, I heard about the inconveniences of ActiveRecord Enum and got
some feedback (one of those is #40456).

Some people have reported that in practice they are using enums for user
input and it is inconvenient to not be able to handle invalid input with
validation like other attributes.

Actually, a former colleague was overriding the attribute writer for
validation, and they had wished this inconvenience to be resolved in the
Rails.

So I propose a way to add validation on the enum attribute. This allows
people to no longer need to override the attribute writer.

Before:

```ruby
class Book < ActiveRecord::Base
  enum :status, [:proposed, :written]

  validates_inclusion_of :status, in: statuses.keys

  def status=(value)
    super
  rescue ArgumentError
    @attributes.write_cast_value(""status"", value)
  end
end
```

After:

```ruby
class Book < ActiveRecord::Base
  enum :status, [:proposed, :written], validate: true
end
```

Resolves #13971.
",https://api.github.com/repos/rails/rails/issues/41730/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41730/reactions,62,10,0,0,0,0,41,11,0,False,https://api.github.com/repos/rails/rails/pulls/41730,https://github.com/rails/rails/pull/41730,https://github.com/rails/rails/pull/41730.diff,https://github.com/rails/rails/pull/41730.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
365,https://api.github.com/repos/rails/rails/issues/41701,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41701/labels{/name},https://api.github.com/repos/rails/rails/issues/41701/comments,https://api.github.com/repos/rails/rails/issues/41701/events,https://github.com/rails/rails/issues/41701,835934400,MDU6SXNzdWU4MzU5MzQ0MDA=,41701,Cyclic has_one and belongs_to associations cause extra saves,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2021-03-19T12:27:51Z,2021-09-04T20:35:53Z,,CONTRIBUTOR,,"Say we have two models, `Post` and `Message`, defined like so:

```ruby
class Post < ApplicationRecord
  belongs_to :postable, polymorphic: true, inverse_of: :post
end

class Message < ApplicationRecord
  has_one :post, as: :postable
end
```

Posts and messages are commonly created together:

```ruby
post = Post.create!(postable: Message.new(subject: ""Hello, world!""))
```

After the above, `post.previously_new_record?` should be true, per [the docs](https://edgeapi.rubyonrails.org/classes/ActiveRecord/Persistence.html#method-i-previously_new_record-3F):

> Returns true if this object was just created – that is, prior to the last save, the object didn't exist in the database and new_record? would have returned true.

However, it is actually false on latest main (currently 6d38553). This is because:
1. The post autosaves its postable `before_save` ([here](https://github.com/rails/rails/blob/6d38553b093aeea26944ae75724f35011f7cc6b0/activerecord/lib/active_record/autosave_association.rb#L212)).
2. The message autosaves its post `after_create` ([here](https://github.com/rails/rails/blob/6d38553b093aeea26944ae75724f35011f7cc6b0/activerecord/lib/active_record/autosave_association.rb#L208)). The post is created here. Its `@new_record` flag is cleared and its `@previously_new_record` flag is set.
3. The post’s `before_save` callbacks complete and it is finally saved. It’s no longer a `new_record?` because of the save in step 2, so the save is treated as an update. The update clears the post’s `@previously_new_record` flag.

The issue boils down to the post being saved twice unnecessarily. It can be avoided by creating the message and post separately:

```ruby
message = Message.create!(subject: ""Foo"")
post = Post.create!(postable: message)
assert post.previously_new_record?
```

…or by creating the post through the message:

```ruby
message = Message.create!(post: Post.new)
assert message.post.previously_new_record?
```

…or by removing the `inverse_of` option on the `:postable` association.

Based on other workarounds that were needed in our app, I suspect the duplicate saving also affects updates and other per-save state (like `previous_changes` and `changes_before_last_save`).

I’ve posted the obligatory reproduction script [here](https://gist.github.com/georgeclaghorn/301f9fdd9e3353882d12a391ee9614e6).",https://api.github.com/repos/rails/rails/issues/41701/timeline,,georgeclaghorn,94129,MDQ6VXNlcjk0MTI5,https://avatars.githubusercontent.com/u/94129?v=4,,https://api.github.com/users/georgeclaghorn,https://github.com/georgeclaghorn,https://api.github.com/users/georgeclaghorn/followers,https://api.github.com/users/georgeclaghorn/following{/other_user},https://api.github.com/users/georgeclaghorn/gists{/gist_id},https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo},https://api.github.com/users/georgeclaghorn/subscriptions,https://api.github.com/users/georgeclaghorn/orgs,https://api.github.com/users/georgeclaghorn/repos,https://api.github.com/users/georgeclaghorn/events{/privacy},https://api.github.com/users/georgeclaghorn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41701/reactions,2,0,0,0,0,0,0,0,2,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
366,https://api.github.com/repos/rails/rails/issues/41692,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41692/labels{/name},https://api.github.com/repos/rails/rails/issues/41692/comments,https://api.github.com/repos/rails/rails/issues/41692/events,https://github.com/rails/rails/issues/41692,833659499,MDU6SXNzdWU4MzM2NTk0OTk=,41692,initialize of new AR model with association deletes persisted record,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,16,2021-03-17T11:11:16Z,2021-05-22T00:26:43Z,,NONE,,"### Steps to reproduce

bug report
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", ""~> 6.1.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.string :title
    t.string :content
  end

  create_table :post_details, force: true do |t|
    t.integer :post_id
    t.string :summary
  end
end

class ApplicationRecord < ActiveRecord::Base
  self.abstract_class = true
end

class Post < ApplicationRecord
  has_one :post_detail, class_name: 'PostDetail', dependent: :delete
end

class PostDetail < ApplicationRecord
  belongs_to :post
end

class BugTest < Minitest::Test
  def test_new_with_association
    old_post = Post.create!(title: 'foo')
    old_post_detail = PostDetail.create(post_id: old_post.id, summary: 'bar')

    assert_equal 'foo', old_post.reload.title
    assert_equal 1, PostDetail.where(id: old_post_detail.id).count
    assert_equal 'bar', old_post.reload.post_detail.summary
    assert_equal old_post_detail.id, old_post.reload.post_detail.id

    new_post = Post.new(
      id: old_post.id,
      post_detail: PostDetail.new(summary: 'wrong')
    )

    assert_equal 'foo', old_post.reload.title
    assert_equal 1, PostDetail.where(id: old_post_detail.id).count
    assert_equal 'bar', old_post.reload.post_detail.summary
    assert_equal old_post_detail.id, old_post.reload.post_detail.id
    assert new_post.new_record?
    assert new_post.post_detail.new_record?
  end
end
```

### Expected behavior
tests should pass. building new instance of model with id should not affect persisted records

### Actual behavior
persisted record being deleted

### System configuration
**Rails version**: 6.1.3

**Ruby version**: 2.5.5

### bug report running log
```
Testing started at 13:06 ...
Fetching gem metadata from https://rubygems.org/.............
Resolving dependencies...
Using rake 13.0.3
Using concurrent-ruby 1.1.8
Using minitest 5.14.4
Using zeitwerk 2.4.2
Using builder 3.2.4
Using erubi 1.10.0
Using racc 1.5.2
Using crass 1.0.6
Using rack 2.2.3
Using nio4r 2.5.7 (was 2.5.5)
Using websocket-extensions 0.1.5
Using mimemagic 0.3.5
Using mini_mime 1.0.2
Using bundler 2.2.8
Using method_source 1.0.0
Using thor 1.1.0
Using sqlite3 1.4.2
Using i18n 1.8.9
Using tzinfo 2.0.4
Using nokogiri 1.11.2 (x86_64-linux) (was 1.11.1)
Using rack-test 1.1.0
Using websocket-driver 0.7.3
Using marcel 0.3.3
Using mail 2.7.1
Using sprockets 4.0.2
Using activesupport 6.1.3
Using loofah 2.9.0
Using rails-dom-testing 2.0.3
Using rails-html-sanitizer 1.3.0
Using globalid 0.4.2
Using activemodel 6.1.3
Using actionview 6.1.3
Using activejob 6.1.3
Using activerecord 6.1.3
Using actionpack 6.1.3
Using actioncable 6.1.3
Using activestorage 6.1.3
Using actionmailer 6.1.3
Using railties 6.1.3
Using sprockets-rails 3.2.2
Using actionmailbox 6.1.3
Using actiontext 6.1.3
Using rails 6.1.3
-- create_table(:posts, {:force=>true})
D, [2021-03-17T13:06:22.465102 #1137602] DEBUG -- :    (0.5ms)  SELECT sqlite_version(*)
D, [2021-03-17T13:06:22.465387 #1137602] DEBUG -- :    (0.0ms)  DROP TABLE IF EXISTS ""posts""
D, [2021-03-17T13:06:22.465639 #1137602] DEBUG -- :    (0.1ms)  CREATE TABLE ""posts"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""title"" varchar, ""content"" varchar)
   -> 0.0029s
-- create_table(:post_details, {:force=>true})
D, [2021-03-17T13:06:22.465963 #1137602] DEBUG -- :    (0.0ms)  DROP TABLE IF EXISTS ""post_details""
D, [2021-03-17T13:06:22.466135 #1137602] DEBUG -- :    (0.1ms)  CREATE TABLE ""post_details"" (""id"" integer PRIMARY KEY AUTOINCREMENT NOT NULL, ""post_id"" integer, ""summary"" varchar)
   -> 0.0005s
D, [2021-03-17T13:06:22.480848 #1137602] DEBUG -- :    (0.1ms)  CREATE TABLE ""ar_internal_metadata"" (""key"" varchar NOT NULL PRIMARY KEY, ""value"" varchar, ""created_at"" datetime(6) NOT NULL, ""updated_at"" datetime(6) NOT NULL)
D, [2021-03-17T13:06:22.485807 #1137602] DEBUG -- :   ActiveRecord::InternalMetadata Load (0.1ms)  SELECT ""ar_internal_metadata"".* FROM ""ar_internal_metadata"" WHERE ""ar_internal_metadata"".""key"" = ? LIMIT ?  [[""key"", ""environment""], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.488520 #1137602] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2021-03-17T13:06:22.488709 #1137602] DEBUG -- :   ActiveRecord::InternalMetadata Create (0.1ms)  INSERT INTO ""ar_internal_metadata"" (""key"", ""value"", ""created_at"", ""updated_at"") VALUES (?, ?, ?, ?)  [[""key"", ""environment""], [""value"", ""test""], [""created_at"", ""2021-03-17 11:06:22.488231""], [""updated_at"", ""2021-03-17 11:06:22.488231""]]
D, [2021-03-17T13:06:22.488850 #1137602] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
D, [2021-03-17T13:06:22.523263 #1137602] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2021-03-17T13:06:22.523422 #1137602] DEBUG -- :   Post Create (0.1ms)  INSERT INTO ""posts"" (""title"") VALUES (?)  [[""title"", ""foo""]]
D, [2021-03-17T13:06:22.523577 #1137602] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
D, [2021-03-17T13:06:22.525916 #1137602] DEBUG -- :   TRANSACTION (0.0ms)  begin transaction
D, [2021-03-17T13:06:22.526071 #1137602] DEBUG -- :   PostDetail Create (0.1ms)  INSERT INTO ""post_details"" (""post_id"", ""summary"") VALUES (?, ?)  [[""post_id"", 1], [""summary"", ""bar""]]
D, [2021-03-17T13:06:22.526193 #1137602] DEBUG -- :   TRANSACTION (0.0ms)  commit transaction
D, [2021-03-17T13:06:22.526728 #1137602] DEBUG -- :   Post Load (0.1ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.527219 #1137602] DEBUG -- :    (0.1ms)  SELECT COUNT(*) FROM ""post_details"" WHERE ""post_details"".""id"" = ?  [[""id"", 1]]
D, [2021-03-17T13:06:22.527542 #1137602] DEBUG -- :   Post Load (0.0ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.531725 #1137602] DEBUG -- :   PostDetail Load (0.1ms)  SELECT ""post_details"".* FROM ""post_details"" WHERE ""post_details"".""post_id"" = ? LIMIT ?  [[""post_id"", 1], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.532867 #1137602] DEBUG -- :   Post Load (0.0ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.533216 #1137602] DEBUG -- :   PostDetail Load (0.0ms)  SELECT ""post_details"".* FROM ""post_details"" WHERE ""post_details"".""post_id"" = ? LIMIT ?  [[""post_id"", 1], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.533659 #1137602] DEBUG -- :   PostDetail Load (0.0ms)  SELECT ""post_details"".* FROM ""post_details"" WHERE ""post_details"".""post_id"" = ? LIMIT ?  [[""post_id"", 1], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.533940 #1137602] DEBUG -- :   PostDetail Destroy (0.1ms)  DELETE FROM ""post_details"" WHERE ""post_details"".""id"" = ?  [[""id"", 1]]
D, [2021-03-17T13:06:22.534273 #1137602] DEBUG -- :   Post Load (0.0ms)  SELECT ""posts"".* FROM ""posts"" WHERE ""posts"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
D, [2021-03-17T13:06:22.534606 #1137602] DEBUG -- :    (0.1ms)  SELECT COUNT(*) FROM ""post_details"" WHERE ""post_details"".""id"" = ?  [[""id"", 1]]

Minitest::Assertion: Expected: 1
  Actual: 0
test_bug_report_rails_new_deletes_assoc.rb:62:in `test_new_with_association'
```
",https://api.github.com/repos/rails/rails/issues/41692/timeline,,senid231,8393857,MDQ6VXNlcjgzOTM4NTc=,https://avatars.githubusercontent.com/u/8393857?v=4,,https://api.github.com/users/senid231,https://github.com/senid231,https://api.github.com/users/senid231/followers,https://api.github.com/users/senid231/following{/other_user},https://api.github.com/users/senid231/gists{/gist_id},https://api.github.com/users/senid231/starred{/owner}{/repo},https://api.github.com/users/senid231/subscriptions,https://api.github.com/users/senid231/orgs,https://api.github.com/users/senid231/repos,https://api.github.com/users/senid231/events{/privacy},https://api.github.com/users/senid231/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41692/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
367,https://api.github.com/repos/rails/rails/issues/41661,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41661/labels{/name},https://api.github.com/repos/rails/rails/issues/41661/comments,https://api.github.com/repos/rails/rails/issues/41661/events,https://github.com/rails/rails/issues/41661,829461354,MDU6SXNzdWU4Mjk0NjEzNTQ=,41661,Multiple attachment files are not persisted to storage service when attached separately within a transaction,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,2,2021-03-11T19:34:50Z,2022-04-03T08:47:03Z,,CONTRIBUTOR,,"Hello!

I've encountered an issue with multiple ActiveStorage attachments that occurs when calling `#attach` more than once on the same model within a transaction.

Specifically, the `ActiveStorage::Attachment` objects are all created as expected, however all attachments except the last silently fail to be persisted to the storage service. Attempting to access these files (e.g., by calling `#download`) throws `ActiveStorage::FileNotFoundError`.

This issue does not appear to occur when attaching multiple attachments in a single call to `#attach` within a transaction, nor does it occur with multiple calls to `#attach` that are not wrapped in a transaction.

I found a similar recent (but closed) bug related to ActiveStorage attachments and transactions which could be related: https://github.com/rails/rails/issues/40630

Thanks!

### Steps to reproduce

[This gist](https://gist.github.com/reshleman/25edc7854e9d8a262e6fff9e5a8f26ab) contains a reproduction script with a failing test case (along with 3 passing test cases which do not meet all the conditions to trigger the issue).

### Expected behavior

Multiple calls to `#attach` inside a transaction persist all attached files to the storage service.

### Actual behavior

Multiple calls to `#attach` inside a transaction creates `ActiveStorage::Attachment` objects, but only the last attached file is persisted to the storage service.

### System configuration
**Rails version**: 6.1.3

**Ruby version**: 2.6.5p114
",https://api.github.com/repos/rails/rails/issues/41661/timeline,,reshleman,7756801,MDQ6VXNlcjc3NTY4MDE=,https://avatars.githubusercontent.com/u/7756801?v=4,,https://api.github.com/users/reshleman,https://github.com/reshleman,https://api.github.com/users/reshleman/followers,https://api.github.com/users/reshleman/following{/other_user},https://api.github.com/users/reshleman/gists{/gist_id},https://api.github.com/users/reshleman/starred{/owner}{/repo},https://api.github.com/users/reshleman/subscriptions,https://api.github.com/users/reshleman/orgs,https://api.github.com/users/reshleman/repos,https://api.github.com/users/reshleman/events{/privacy},https://api.github.com/users/reshleman/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41661/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
368,https://api.github.com/repos/rails/rails/issues/41651,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41651/labels{/name},https://api.github.com/repos/rails/rails/issues/41651/comments,https://api.github.com/repos/rails/rails/issues/41651/events,https://github.com/rails/rails/issues/41651,827953134,MDU6SXNzdWU4Mjc5NTMxMzQ=,41651,ActiveRecord::Result#column_types is often missing data,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2021-03-10T15:55:01Z,2021-08-02T23:39:04Z,,CONTRIBUTOR,,"### Regression in ActiveRecord::Result column_types

In my app (which uses PostgreSQL) I have several reporting features that construct TEMP DB views on the fly and query them with ActiveRecord's `exec_query` functionality. When I run these queries, I depend upon the values in the `column_types` attribute of the [ActiveRecord::Result object ](https://api.rubyonrails.org/classes/ActiveRecord/Result.html) to contain all of the column names and associated types.

After upgrading to Rails 6.1 I have noticed most of the time, the `columns_types` hash is now empty. This seems to be caused by this commit, specifically on the line that I have highlighted. https://github.com/rails/rails/commit/71e45582b794d7cdcbd72a93dc2f3c8665859653#diff-e6fd03cad5e3437c76b6c5db106359124dc9feab8341ade39b9ae54af001fac9R58

This appears to skip adding certain items to `column_types`. From what I can see, it's clear this was an intentional decision, and that the absence of data in meaningful in some way to other parts of AR. With that said, I believe this attribute is a public-enough API surface that it should always reflect all columns in the query.

As you might expect, it's hard to understand the context of a SQL query result without knowing what data types are for each column. I think we should keep that context in the `ActiveRecord::Result` object and restore the original behavior.

### Steps to reproduce

1. In a rails console run `result = ActiveRecord::Base.connection.exec_query(""SELECT 1 AS test"")`
1. Run `result.column_types`

### Expected behavior
I expect that `result.column_type` will return something like `=> {""test""=>#<ActiveModel::Type::Integer:0x00007fc9fbb6fe50 @limit=4, @precision=nil, @range=-2147483648...2147483648, @scale=nil>}`

### Actual behavior
After this commit 71e45582b794d7cdcbd72a93dc2f3c8665859653, `result.column_type` returns `{}`

### System configuration
**Rails version**:Rails 6.1.3
**Ruby version**: ruby 2.7.2p137
",https://api.github.com/repos/rails/rails/issues/41651/timeline,,terracatta,315873,MDQ6VXNlcjMxNTg3Mw==,https://avatars.githubusercontent.com/u/315873?v=4,,https://api.github.com/users/terracatta,https://github.com/terracatta,https://api.github.com/users/terracatta/followers,https://api.github.com/users/terracatta/following{/other_user},https://api.github.com/users/terracatta/gists{/gist_id},https://api.github.com/users/terracatta/starred{/owner}{/repo},https://api.github.com/users/terracatta/subscriptions,https://api.github.com/users/terracatta/orgs,https://api.github.com/users/terracatta/repos,https://api.github.com/users/terracatta/events{/privacy},https://api.github.com/users/terracatta/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41651/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
369,https://api.github.com/repos/rails/rails/issues/41650,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41650/labels{/name},https://api.github.com/repos/rails/rails/issues/41650/comments,https://api.github.com/repos/rails/rails/issues/41650/events,https://github.com/rails/rails/issues/41650,827901541,MDU6SXNzdWU4Mjc5MDE1NDE=,41650,"slow perfomance method `sum` for enumerable, array","[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2021-03-10T15:19:54Z,2021-03-18T23:21:06Z,,NONE,,"### Steps to reproduce
```ruby
> irb
require 'benchmark/ips'
num_arr = (1..10).to_a;
C = Struct.new(:v);
obj_arr = (1..10).map { |i| C.new(i) };

Benchmark.ips do |x|
  x.report(""sum num_arr"") do |n|
    while n > 0
      num_arr.sum
      n-=1
    end
  end
  x.report(""sum obj_arr"") do |n|
    while n > 0
      obj_arr.sum(&:v)
      n-=1
    end
  end

  x.compare!
end;
Calculating -------------------------------------
         sum num_arr     17.615M (± 4.4%) i/s -     88.270M in   5.021204s
         sum obj_arr      2.645M (± 3.8%) i/s -     13.292M in   5.033431s
```

```ruby
> rails c
require 'benchmark/ips'
num_arr = (1..10).to_a;
C = Struct.new(:v);
obj_arr = (1..10).map { |i| C.new(i) };

Benchmark.ips do |x|
  x.report(""sum num_arr"") do |n|
    while n > 0
      num_arr.sum
      n-=1
    end
  end
  x.report(""sum obj_arr"") do |n|
    while n > 0
      obj_arr.sum(&:v)
      n-=1
    end
  end

  x.compare!
end;

Calculating -------------------------------------
         sum num_arr      5.277M (± 4.0%) i/s -     26.518M in   5.034190s
         sum obj_arr    911.786k (± 5.6%) i/s -      4.626M in   5.090562
```

### Expected behavior
speed should be equal

### Actual behavior
in rails app code very slow
```
sum num_arr 17.6/5.2 => 3.3846153846153846
sum obj_arr 2645/911.0 => 2.903402854006586
```

### System configuration
**Rails version**: 6.0

**Ruby version**: 2.5

I think we may remove this monkey patch

https://github.com/rails/rails/blob/4607f13c88fdc773a3ee69101bcb6ebe41ed20ce/activesupport/lib/active_support/core_ext/enumerable.rb#L53

https://github.com/rails/rails/blob/4607f13c88fdc773a3ee69101bcb6ebe41ed20ce/activesupport/lib/active_support/core_ext/enumerable.rb#L265

### The next examples very strange
https://github.com/rails/rails/blob/4607f13c88fdc773a3ee69101bcb6ebe41ed20ce/activesupport/lib/active_support/core_ext/enumerable.rb#L47
replaced by `['foo', 'bar'].join`

https://github.com/rails/rails/blob/4607f13c88fdc773a3ee69101bcb6ebe41ed20ce/activesupport/lib/active_support/core_ext/enumerable.rb#L48
replaced by `[[1, 2], [3, 1, 5]].flatten`

---

method sum added in rails in the 2006 year https://github.com/rails/rails/commit/236c7325df4ca2783c92dffc0f0b9592f822d95a

but ruby added this method in version 2.4, and now rails require minimum ruby version 2.5, we may remove it from rails",https://api.github.com/repos/rails/rails/issues/41650/timeline,,ermolaev,938305,MDQ6VXNlcjkzODMwNQ==,https://avatars.githubusercontent.com/u/938305?v=4,,https://api.github.com/users/ermolaev,https://github.com/ermolaev,https://api.github.com/users/ermolaev/followers,https://api.github.com/users/ermolaev/following{/other_user},https://api.github.com/users/ermolaev/gists{/gist_id},https://api.github.com/users/ermolaev/starred{/owner}{/repo},https://api.github.com/users/ermolaev/subscriptions,https://api.github.com/users/ermolaev/orgs,https://api.github.com/users/ermolaev/repos,https://api.github.com/users/ermolaev/events{/privacy},https://api.github.com/users/ermolaev/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41650/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
370,https://api.github.com/repos/rails/rails/issues/41622,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41622/labels{/name},https://api.github.com/repos/rails/rails/issues/41622/comments,https://api.github.com/repos/rails/rails/issues/41622/events,https://github.com/rails/rails/pull/41622,823031800,MDExOlB1bGxSZXF1ZXN0NTg1NTU2ODYx,41622,Support PostgreSQL DISTINCT ON,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,12,2021-03-05T12:16:16Z,2022-02-18T16:12:21Z,,CONTRIBUTOR,,"### Summary

This PR adds an interface for ActiveRecord relations to use (already implemented in arel) DISTINCT ON feature.

fixes https://github.com/rails/rails/issues/17706. Similar issue exists with tables which have `point` data type column.",https://api.github.com/repos/rails/rails/issues/41622/timeline,,aliismayilov,993934,MDQ6VXNlcjk5MzkzNA==,https://avatars.githubusercontent.com/u/993934?v=4,,https://api.github.com/users/aliismayilov,https://github.com/aliismayilov,https://api.github.com/users/aliismayilov/followers,https://api.github.com/users/aliismayilov/following{/other_user},https://api.github.com/users/aliismayilov/gists{/gist_id},https://api.github.com/users/aliismayilov/starred{/owner}{/repo},https://api.github.com/users/aliismayilov/subscriptions,https://api.github.com/users/aliismayilov/orgs,https://api.github.com/users/aliismayilov/repos,https://api.github.com/users/aliismayilov/events{/privacy},https://api.github.com/users/aliismayilov/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41622/reactions,23,5,0,0,0,0,18,0,0,False,https://api.github.com/repos/rails/rails/pulls/41622,https://github.com/rails/rails/pull/41622,https://github.com/rails/rails/pull/41622.diff,https://github.com/rails/rails/pull/41622.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
371,https://api.github.com/repos/rails/rails/issues/41562,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41562/labels{/name},https://api.github.com/repos/rails/rails/issues/41562/comments,https://api.github.com/repos/rails/rails/issues/41562/events,https://github.com/rails/rails/pull/41562,817731348,MDExOlB1bGxSZXF1ZXN0NTgxMTc3ODQ3,41562,Support grouped collection for collection_select,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,5,2021-02-26T22:45:06Z,2022-04-20T22:18:49Z,,MEMBER,,"This adds support for grouped collections to the `collection_select` helper, much like the `select` helper:

```ruby
collection_select :country_id, @countries.group_by(&:continent_name), :id, :name
```

This differs from `grouped_collection_select` in that it does not require a secondary model to group options:

```ruby
grouped_collection_select :country_id, @continents, :countries, :name, :id, :name
```

Of course, a secondary model can be used as well:

```ruby
collection_select :country_id, @countries.group_by { |country| country.continent.name }, :id, :name
```

---

This finishes #40338, which can't be reopened because `master` branch has been deleted.
",https://api.github.com/repos/rails/rails/issues/41562/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41562/reactions,1,0,0,0,1,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41562,https://github.com/rails/rails/pull/41562,https://github.com/rails/rails/pull/41562.diff,https://github.com/rails/rails/pull/41562.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
372,https://api.github.com/repos/rails/rails/issues/41520,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41520/labels{/name},https://api.github.com/repos/rails/rails/issues/41520/comments,https://api.github.com/repos/rails/rails/issues/41520/events,https://github.com/rails/rails/issues/41520,813838621,MDU6SXNzdWU4MTM4Mzg2MjE=,41520,`attr_readonly`: surprising inconsistency between what's saved and what's in memory,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,"[{'login': 'ghiculescu', 'id': 509837, 'node_id': 'MDQ6VXNlcjUwOTgzNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/509837?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/ghiculescu', 'html_url': 'https://github.com/ghiculescu', 'followers_url': 'https://api.github.com/users/ghiculescu/followers', 'following_url': 'https://api.github.com/users/ghiculescu/following{/other_user}', 'gists_url': 'https://api.github.com/users/ghiculescu/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/ghiculescu/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/ghiculescu/subscriptions', 'organizations_url': 'https://api.github.com/users/ghiculescu/orgs', 'repos_url': 'https://api.github.com/users/ghiculescu/repos', 'events_url': 'https://api.github.com/users/ghiculescu/events{/privacy}', 'received_events_url': 'https://api.github.com/users/ghiculescu/received_events', 'type': 'User', 'site_admin': False}]",,12,2021-02-22T20:29:03Z,2021-07-22T00:53:08Z,,MEMBER,,"### Steps to reproduce

When an attribute is marked as `attr_readonly`, updates to it are not persisted. But, surprisingly, the in memory object *is* updated. There is no warning about this inconsistency. This means that if you do something that refers to this attribute's value after the update attempt, you'll be working with an incorrect value.

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails"", branch: ""main""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.text :content
    t.text :title
  end
end

class Post < ActiveRecord::Base
  attr_readonly :content
end

class BugTest < Minitest::Test
  def test_readonly
    post = Post.create!(content: ""v1"", title: ""title v1"")
    assert_equal ""v1"", post.content
    assert_equal ""title v1"", post.title
    assert_equal ""v1"", Post.find(post.id).content
    assert_equal ""title v1"", Post.find(post.id).title

    post = Post.find(post.id) # reload the object
    post.update(content: ""v2"", title: ""title v2"")
    assert post.valid?
    assert_equal ""v2"", post.content # passes
    assert_equal ""title v2"", post.title # passes
    assert_equal ""title v2"", Post.find(post.id).title # passes
    assert_equal ""v2"", Post.find(post.id).content # fails; it's still ""v1""
  end

  def test_readonly_via_assign
    post = Post.create!(content: ""v1"", title: ""title v1"")
    post.content = ""v2""
    post.title = ""title v2""
    assert post.valid?
    post.save!

    assert_equal ""v2"", post.content # passes
    assert_equal ""title v2"", post.title # passes
    assert_equal ""title v2"", Post.find(post.id).title # passes
    assert_equal ""v2"", Post.find(post.id).content # fails; it's still ""v1""
  end
end
```

### Expected behavior
I would expect the in memory object (`post.content`) to match the object in the database (`Post.find(post.id).content`). Or at least I'd expect an error or warning.

I am happy to put together a PR to improve this, I'd like feedback on which direction to go in. My ideas, in order of preference:

- Raise an error when assigning a readonly attribute. (Can be configured between logging or raising an error, similar to `action_on_strict_loading_violation` etc)
- Make the in-memory update also ignore readonly attributes, to match the persistence behavior.
- Make this more explicit in [the docs](https://api.rubyonrails.org/classes/ActiveRecord/ReadonlyAttributes/ClassMethods.html).
- Open to other suggestions!

### System configuration
**Rails version**: main branch

**Ruby version**: 2.7.2
",https://api.github.com/repos/rails/rails/issues/41520/timeline,,ghiculescu,509837,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41520/reactions,4,4,0,0,0,0,0,0,0,,,,,,,ghiculescu,509837.0,MDQ6VXNlcjUwOTgzNw==,https://avatars.githubusercontent.com/u/509837?v=4,,https://api.github.com/users/ghiculescu,https://github.com/ghiculescu,https://api.github.com/users/ghiculescu/followers,https://api.github.com/users/ghiculescu/following{/other_user},https://api.github.com/users/ghiculescu/gists{/gist_id},https://api.github.com/users/ghiculescu/starred{/owner}{/repo},https://api.github.com/users/ghiculescu/subscriptions,https://api.github.com/users/ghiculescu/orgs,https://api.github.com/users/ghiculescu/repos,https://api.github.com/users/ghiculescu/events{/privacy},https://api.github.com/users/ghiculescu/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
373,https://api.github.com/repos/rails/rails/issues/41517,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41517/labels{/name},https://api.github.com/repos/rails/rails/issues/41517/comments,https://api.github.com/repos/rails/rails/issues/41517/events,https://github.com/rails/rails/pull/41517,813625274,MDExOlB1bGxSZXF1ZXN0NTc3NzQyODM3,41517,Encodes the uploaded file's headers,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,11,2021-02-22T15:51:45Z,2022-04-18T17:36:35Z,,NONE,,"### Summary

This pull request address the issue #38080 

Fixes #38080 ",https://api.github.com/repos/rails/rails/issues/41517/timeline,,brunoarueira,119518,MDQ6VXNlcjExOTUxOA==,https://avatars.githubusercontent.com/u/119518?v=4,,https://api.github.com/users/brunoarueira,https://github.com/brunoarueira,https://api.github.com/users/brunoarueira/followers,https://api.github.com/users/brunoarueira/following{/other_user},https://api.github.com/users/brunoarueira/gists{/gist_id},https://api.github.com/users/brunoarueira/starred{/owner}{/repo},https://api.github.com/users/brunoarueira/subscriptions,https://api.github.com/users/brunoarueira/orgs,https://api.github.com/users/brunoarueira/repos,https://api.github.com/users/brunoarueira/events{/privacy},https://api.github.com/users/brunoarueira/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41517/reactions,2,2,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41517,https://github.com/rails/rails/pull/41517,https://github.com/rails/rails/pull/41517.diff,https://github.com/rails/rails/pull/41517.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
374,https://api.github.com/repos/rails/rails/issues/41498,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41498/labels{/name},https://api.github.com/repos/rails/rails/issues/41498/comments,https://api.github.com/repos/rails/rails/issues/41498/events,https://github.com/rails/rails/issues/41498,811865867,MDU6SXNzdWU4MTE4NjU4Njc=,41498,ActiveRecord: Missing joined table after upgrading to 6.1,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,2,2021-02-19T09:40:25Z,2021-06-16T16:34:25Z,,CONTRIBUTOR,,"### Steps to reproduce

I have written a test to reproduce the error. Passing on 6.0 and failing on 6.1.

Put this file in its own directory and run it from there.

```ruby
# If you change the gem dependencies, run it with:
# `rm Gemfile* && ruby test.rb`

unless File.exist?(""Gemfile"")
  File.write(""Gemfile"", <<-GEMFILE)
    source ""https://rubygems.org""
    # gem ""rails"", github: ""rails/rails"", branch: ""6-0-stable""
    gem ""rails"", github: ""rails/rails"", branch: ""6-1-stable""
    gem ""pg""
  GEMFILE

  system ""bundle install""
end

require ""bundler""
Bundler.setup(:default)

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(
  adapter: ""postgresql"",
  database: ""activerecord_test"",
  host: ""postgres"",
  user: ""username"",
  password: ""password""
)
# ActiveRecord::Base.logger = Logger.new(STDOUT)

# Display versions.
message = ""Running test case with Ruby #{RUBY_VERSION}, Active Record #{
  ::ActiveRecord::VERSION::STRING}, Arel #{Arel::VERSION} and #{
  ::ActiveRecord::Base.connection.adapter_name}""
line = ""="" * message.length
puts line, message, line

ActiveRecord::Schema.define do
  create_table :contacts, force: true do |t|
    t.string :name
  end

  create_table :contact_relationships, force: true do |t|
    t.references :child
    t.references :parent
    t.string :relationship_type
  end
end

class Contact < ActiveRecord::Base
  has_one :commune_relationship, -> { where(relationship_type: ""commune"") }, class_name: ""ContactRelationship"", foreign_key: :child_id
  has_one :commune, source: :parent, through: :commune_relationship

  has_many :commune_for_relationships, -> { where(relationship_type: ""commune"") }, class_name: ""ContactRelationship"", foreign_key: :parent_id
  has_many :commune_for, source: :child, through: :commune_for_relationships

  has_many :schools_relationships, -> { where(relationship_type: ""school"") }, class_name: ""ContactRelationship"", foreign_key: :child_id
  has_many :schools, source: :parent, through: :schools_relationships

  has_many :schools_communes, source: :commune, through: :schools

  has_many :school_for_relationships, -> { where(relationship_type: ""school"") }, class_name: ""ContactRelationship"", foreign_key: :parent_id
  has_many :school_for, source: :child, through: :school_for_relationships

  has_many :children_relationships, class_name: ""ContactRelationship"", foreign_key: :parent_id
  has_many :children, source: :child, through: :children_relationships

  has_many :parents_relationships, class_name: ""ContactRelationship"", foreign_key: :child_id
  has_many :parents, source: :parent, through: :parents_relationships
end

class ContactRelationship < ActiveRecord::Base
  belongs_to :child, class_name: ""Contact""
  belongs_to :parent, class_name: ""Contact""
end

class TestActiveRecord < ActiveSupport::TestCase
  def setup
    @nothern_commune = Contact.create!(name: ""Nothern Commune"")
    @southern_commune = Contact.create!(name: ""Southern Commune"")

    @southern_school = Contact.create!(name: ""Southern School"")
    ContactRelationship.create!(child: @southern_school, parent: @southern_commune, relationship_type: ""commune"")

    @nothern_school = Contact.create!(name: ""Nothern School"")
    ContactRelationship.create!(child: @nothern_school, parent: @nothern_commune, relationship_type: ""commune"")

    # Student that both lives and goes to school in the north
    @nothern_student = Contact.create!(name: ""Nothern Student"")
    ContactRelationship.create!(child: @nothern_student, parent: @nothern_commune, relationship_type: ""commune"")
    ContactRelationship.create!(child: @nothern_student, parent: @nothern_school, relationship_type: ""school"")

    # Student that both lives and goes to school in the south
    @southern_student = Contact.create!(name: ""Southern Student"")
    ContactRelationship.create!(child: @southern_student, parent: @southern_commune, relationship_type: ""commune"")
    ContactRelationship.create!(child: @southern_student, parent: @southern_school, relationship_type: ""school"")

    # Student that lives in the northern commune but goes to school in the southern school
    @eastern_student = Contact.create!(name: ""Eastern Student"")
    ContactRelationship.create!(child: @eastern_student, parent: @nothern_commune, relationship_type: ""commune"")
    ContactRelationship.create!(child: @eastern_student, parent: @southern_school, relationship_type: ""school"")

    # Student that liaves in the southern commune but goes to school in the nothern school
    @western_student = Contact.create!(name: ""Western Student"")
    ContactRelationship.create!(child: @western_student, parent: @southern_commune, relationship_type: ""commune"")
    ContactRelationship.create!(child: @western_student, parent: @nothern_school, relationship_type: ""school"")
  end

  def test_setup
    assert_equal @nothern_commune, @nothern_student.commune
    assert_equal [@nothern_school], @nothern_student.schools
    assert_equal [@nothern_commune], @nothern_student.schools_communes

    assert_equal @southern_commune, @southern_student.commune
    assert_equal [@southern_school], @southern_student.schools
    assert_equal [@southern_commune], @southern_student.schools_communes

    assert_equal @nothern_commune, @eastern_student.commune
    assert_equal [@southern_school], @eastern_student.schools
    assert_equal [@southern_commune], @eastern_student.schools_communes

    assert_equal @southern_commune, @western_student.commune
    assert_equal [@nothern_school], @western_student.schools

    assert_equal [@nothern_school, @nothern_student, @eastern_student], @nothern_commune.children
    assert_equal [@nothern_school, @nothern_student, @eastern_student], @nothern_commune.commune_for

    assert_equal [@southern_school, @southern_student, @western_student], @southern_commune.children
    assert_equal [@southern_school, @southern_student, @western_student], @southern_commune.commune_for

    assert_equal [@nothern_student, @western_student], @nothern_school.children
    assert_equal [@nothern_student, @western_student], @nothern_school.school_for
    assert_equal [@southern_student, @eastern_student], @southern_school.school_for
  end

  def test_queries
    query = Contact
      .left_joins(:commune, schools: :commune)
      .where(""communes_contacts.id = :commune_id OR communes_contacts_2.id = :commune_id"", commune_id: @southern_commune.id)

    # Output from Rails 6.0
    # SELECT ""contacts"".*
    # FROM ""contacts""
    # LEFT OUTER JOIN ""contact_relationships"" ON ""contact_relationships"".""relationship_type"" = 'commune' AND ""contact_relationships"".""child_id"" = ""contacts"".""id""
    # LEFT OUTER JOIN ""contacts"" ""communes_contacts"" ON ""communes_contacts"".""id"" = ""contact_relationships"".""parent_id""
    # LEFT OUTER JOIN ""contact_relationships"" ""schools_relationships_contacts_join"" ON ""schools_relationships_contacts_join"".""relationship_type"" = 'school' AND ""schools_relationships_contacts_join"".""child_id"" = ""contacts"".""id""
    # LEFT OUTER JOIN ""contacts"" ""schools_contacts"" ON ""schools_contacts"".""id"" = ""schools_relationships_contacts_join"".""parent_id""
    # Note: This relationships-join is missing in Rails 6.1
    # LEFT OUTER JOIN ""contact_relationships"" ""commune_relationships_contacts_join"" ON ""commune_relationships_contacts_join"".""relationship_type"" = 'commune' AND ""commune_relationships_contacts_join"".""child_id"" = ""schools_contacts"".""id""
    # LEFT OUTER JOIN ""contacts"" ""communes_contacts_2"" ON ""communes_contacts_2"".""id"" = ""commune_relationships_contacts_join"".""parent_id""
    # WHERE (communes_contacts.id = 2 OR communes_contacts_2.id = 2)

    # Output from Rails 6.1
    # SELECT ""contacts"".*
    # FROM ""contacts""
    # LEFT OUTER JOIN ""contact_relationships"" ON ""contact_relationships"".""relationship_type"" = 'commune' AND ""contact_relationships"".""child_id"" = ""contacts"".""id""
    # LEFT OUTER JOIN ""contacts"" ""communes_contacts"" ON ""communes_contacts"".""id"" = ""contact_relationships"".""parent_id""
    # LEFT OUTER JOIN ""contact_relationships"" ""schools_relationships_contacts_join"" ON ""schools_relationships_contacts_join"".""relationship_type"" = 'school' AND ""schools_relationships_contacts_join"".""child_id"" = ""contacts"".""id""
    # LEFT OUTER JOIN ""contacts"" ""schools_contacts"" ON ""schools_contacts"".""id"" = ""schools_relationships_contacts_join"".""parent_id""
    # Note: Missing relationships join like in Rails 6.0
    # LEFT OUTER JOIN ""contacts"" ""communes_contacts_2"" ON ""communes_contacts_2"".""id"" = ""contact_relationships"".""parent_id""
    # WHERE (communes_contacts.id = 2 OR communes_contacts_2.id = 2)

    # puts ""SQL:\n#{query.to_sql}""

    # Southern school should be included because it belongs to the southern commune
    # Southern student should be included because he both goes to school and lives in the south
    # Eastern student should be included because he goes to school in the southern school that belongs to the southern commune
    # Western student should be included because he lives in the south and is directly related to the southern commune

    assert_equal [@southern_school, @southern_student, @eastern_student, @western_student], query
  end
end

```

### Expected behavior

I would expect the ""contact_relationships"" for communes on schools to be present instead of re-using the previous join wrongly.

I would expect this assertion to pass:
```ruby
assert_equal [@southern_school, @southern_student, @eastern_student, @western_student], query
 ```


### Actual behavior

It uses the previous join wrongly and reaches the wrong result.

### System configuration
**Rails version**: 6.1

**Ruby version**: 2.6.6
",https://api.github.com/repos/rails/rails/issues/41498/timeline,,kaspernj,234531,MDQ6VXNlcjIzNDUzMQ==,https://avatars.githubusercontent.com/u/234531?v=4,,https://api.github.com/users/kaspernj,https://github.com/kaspernj,https://api.github.com/users/kaspernj/followers,https://api.github.com/users/kaspernj/following{/other_user},https://api.github.com/users/kaspernj/gists{/gist_id},https://api.github.com/users/kaspernj/starred{/owner}{/repo},https://api.github.com/users/kaspernj/subscriptions,https://api.github.com/users/kaspernj/orgs,https://api.github.com/users/kaspernj/repos,https://api.github.com/users/kaspernj/events{/privacy},https://api.github.com/users/kaspernj/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41498/reactions,4,4,0,0,0,0,0,0,0,,,,,,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
375,https://api.github.com/repos/rails/rails/issues/41452,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41452/labels{/name},https://api.github.com/repos/rails/rails/issues/41452/comments,https://api.github.com/repos/rails/rails/issues/41452/events,https://github.com/rails/rails/issues/41452,808729348,MDU6SXNzdWU4MDg3MjkzNDg=,41452,Slow performance when rendering collections of nested partials,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,12,2021-02-15T18:00:12Z,2021-05-22T22:30:00Z,,NONE,,"### Steps to reproduce
* To start, you need two partials (`_a.html.erb` and `_b.html.erb`)
* Partial `_a.html.erb` should contain a render call for partial `_b.html.erb`
* Render partial `_a.html.erb` in a collection

### Expected behavior
Ideally, the time to render should be on par with the aggregate time to render both `_a` and `_b` if `_b` was not nested inside of `_a`.

### Actual behavior
I see about a 10x difference in render time between a nested example and a flat example. I've done some preliminary digging with stackprof. Keep in mind that I am not well versed in the internals of ActionView rendering so my understanding of what is not working may not line up with reality. It seems like whatever optimization is done that affords such a significant speed difference between these two cases:

#### Fast
```erb
<%= render partial: ""a"", collection: 100.times.to_a %>
```

#### Slow
```erb
<% 100.times do %>
  <%= render partial: ""a"" %>
<% end %>
```

...is not able to be applied to the partial that is nested inside of the outer partial. Based on my stackprof digging it looks like some of that optimization is happening in the conversion of the partial string (`""a""`) into an actual path to a view file. In the fast case above, that conversion of `""a""` into `""#{Rails.root}/app/views/application/_a.html.erb""` happens one time, and in the slow case it happens 100 times. The same is true of the nested partials situation: the outer partial gets its view path calculated/looked-up one time, but the inner render call for the nested partial `_b` gets looked-up on each iteration.

I had some back and forth on Twitter with @tenderlove about this, and his intuition from the best description I could muster in 270 characters was that this was a bug and shouldn't require a performance hit. But it is entirely possible I wasn't explaining it well enough to him over the limited bandwidth communication channel of Twitter 😄 

#### Tweet
https://twitter.com/tenderlove/status/1351223079805083648

#### Reproduction Repo
https://github.com/willcosgrove/partial-perf-repro

#### Server log images
Flat case (fast):
![Flat](https://user-images.githubusercontent.com/77887/107979570-683b1200-6f84-11eb-8910-193a3e79f823.jpeg)

Nested case (slow):
![slow_1](https://user-images.githubusercontent.com/77887/107979612-7db03c00-6f84-11eb-9746-01f6ee5dc760.jpeg)
![slow_2](https://user-images.githubusercontent.com/77887/107979618-80ab2c80-6f84-11eb-8afd-714eae1a4cb4.jpeg)

I should also clarify about the logs: The default view logging in development definitely adds some additional overhead to the slow case, because it logs a line of output for each iteration. But even with view logging turned off completely, there is still a significant performance difference between the two cases, so I don't believe the difference falls entirely at the feet of ActionView logging instrumentation.

#### Flamegraph:
Fast:
![fast_flame](https://user-images.githubusercontent.com/77887/107979667-93bdfc80-6f84-11eb-9313-e2da2abd2814.png)

Slow:
![slow_flame](https://user-images.githubusercontent.com/77887/107979694-a0425500-6f84-11eb-8dc9-67d570b0a337.jpeg)

### System configuration
**Rails version**:
Seems to be any version, but I tested specifically on 6.1.2.1 and `main`.

**Ruby version**:
Also seems to be any version but I tested on both Ruby 2.7 and Ruby 3.0.

CC: @tenderlove ",https://api.github.com/repos/rails/rails/issues/41452/timeline,,willcosgrove,77887,MDQ6VXNlcjc3ODg3,https://avatars.githubusercontent.com/u/77887?v=4,,https://api.github.com/users/willcosgrove,https://github.com/willcosgrove,https://api.github.com/users/willcosgrove/followers,https://api.github.com/users/willcosgrove/following{/other_user},https://api.github.com/users/willcosgrove/gists{/gist_id},https://api.github.com/users/willcosgrove/starred{/owner}{/repo},https://api.github.com/users/willcosgrove/subscriptions,https://api.github.com/users/willcosgrove/orgs,https://api.github.com/users/willcosgrove/repos,https://api.github.com/users/willcosgrove/events{/privacy},https://api.github.com/users/willcosgrove/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41452/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
376,https://api.github.com/repos/rails/rails/issues/41415,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41415/labels{/name},https://api.github.com/repos/rails/rails/issues/41415/comments,https://api.github.com/repos/rails/rails/issues/41415/events,https://github.com/rails/rails/pull/41415,806765878,MDExOlB1bGxSZXF1ZXN0NTcyMTMwMzI0,41415,Allows passing a token to be added to the WebSocket sub protocols,"[{'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,21,2021-02-11T21:42:00Z,2022-03-21T07:36:10Z,,NONE,,"### Summary

One can pass his token (JWT or any others) to the createConsumer function as a second parameter, and it will be passed down to the WebSocket Protocols allowing the `ApplicationCable::Connection` class, on the server side, to retrieve it from the `:HTTP_SEC_WEBSOCKET_PROTOCOL` request header list.

Also this commit adds the convenient function `createConsumerFromMeta` that takes anyway the cable URL from the meta or the default one and takes a token as an optional parameter. It avoids to have to pass `undefined` as the first argument to `createConsumer` when you want to keep the default behavior but passing a token
",https://api.github.com/repos/rails/rails/issues/41415/timeline,,zedtux,478564,MDQ6VXNlcjQ3ODU2NA==,https://avatars.githubusercontent.com/u/478564?v=4,,https://api.github.com/users/zedtux,https://github.com/zedtux,https://api.github.com/users/zedtux/followers,https://api.github.com/users/zedtux/following{/other_user},https://api.github.com/users/zedtux/gists{/gist_id},https://api.github.com/users/zedtux/starred{/owner}{/repo},https://api.github.com/users/zedtux/subscriptions,https://api.github.com/users/zedtux/orgs,https://api.github.com/users/zedtux/repos,https://api.github.com/users/zedtux/events{/privacy},https://api.github.com/users/zedtux/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41415/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41415,https://github.com/rails/rails/pull/41415,https://github.com/rails/rails/pull/41415.diff,https://github.com/rails/rails/pull/41415.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
377,https://api.github.com/repos/rails/rails/issues/41413,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41413/labels{/name},https://api.github.com/repos/rails/rails/issues/41413/comments,https://api.github.com/repos/rails/rails/issues/41413/events,https://github.com/rails/rails/issues/41413,806690076,MDU6SXNzdWU4MDY2OTAwNzY=,41413,"ActiveStorage blobs can be attached using their ""displayable"" signed IDs","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,0,2021-02-11T19:48:32Z,2021-06-29T20:55:41Z,,CONTRIBUTOR,,"### Steps to reproduce

ActiveStorage blobs currently use signed IDs. The purpose however is always the same (blob_id). When uploading a Blob through the direct_upload endpoint, a user gets the same signed ID for a Blob as the one that is later used for attaching a Blob to a model through Attached - see https://github.com/rails/rails/blob/bddb2c9b193c976dbe6a9a1358479d1792931986/activestorage/app/controllers/active_storage/direct_uploads_controller.rb#L18

Since the signed blob ID is the same as the one used for later retrieving a blob (even for a small period of time, since the purpose of the signature is the same), the following attack can be performed:

* Alice uploads a PDF document and shares a link to a page with it with Bob
* Mallory manages to view that page for whatever reason
* Mallory examines the source page and copies the signed ID of the blob on that page
* Mallory then uses her account on the same service and supplies the signed ID of the blob in a form POST request which would perform file attachment and create a reference to the blob in their account too.

At that stage, the Blob in the database would have more referencing Attachments since an Attachment would be generated allowing Mallory to have full access to the Blob in their account on the service. This would also prevent the Blob from being garbage-collected if Alice decides to remove it from ""her"" attachment. At first glance, I see the following possible impact:

* An attacker can link attachments stored on the service into the model objects belonging to the attacker, even though they weren't uploaded by the attacker
* An attacker can ""increase refcount"" for Blobs and thus prevent those blobs from being deleted from the application once there are no Attachments referencing them from records belonging to accounts that did have access.

Mitigation would possibly require using a different signature purpose for direct uploading / attaching than the rest of the ActiveStorage operations. An alternative would be to blend the user account identifier into the signature for upload, so that an account may only use signed IDs which were generated for them / on their behalf (Since Rails does not provide authorization out-of-the-box I don't see that likely but might be possible).

### Expected behavior

It is only possible to attach a blob to a record using a signed ID if that signed ID was issued to you for the purpose of upload (proof-of-work).

### Actual behavior

Signed IDs are used interchangeably and attaching by any user is possible, even if the user was not the original uploader.

### System configuration
**Rails version**: 5.x -6.x

**Ruby version**: any relevant version for framework versions mentioned above
",https://api.github.com/repos/rails/rails/issues/41413/timeline,,julik,16446,MDQ6VXNlcjE2NDQ2,https://avatars.githubusercontent.com/u/16446?v=4,,https://api.github.com/users/julik,https://github.com/julik,https://api.github.com/users/julik/followers,https://api.github.com/users/julik/following{/other_user},https://api.github.com/users/julik/gists{/gist_id},https://api.github.com/users/julik/starred{/owner}{/repo},https://api.github.com/users/julik/subscriptions,https://api.github.com/users/julik/orgs,https://api.github.com/users/julik/repos,https://api.github.com/users/julik/events{/privacy},https://api.github.com/users/julik/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41413/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
378,https://api.github.com/repos/rails/rails/issues/41412,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41412/labels{/name},https://api.github.com/repos/rails/rails/issues/41412/comments,https://api.github.com/repos/rails/rails/issues/41412/events,https://github.com/rails/rails/pull/41412,806576627,MDExOlB1bGxSZXF1ZXN0NTcxOTcxNjA0,41412,Revert #22610 by default and make it opt-in,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,[],,12,2021-02-11T17:03:44Z,2022-03-29T09:46:24Z,,CONTRIBUTOR,,"### Summary

Change #22610 in order to revert the behaviour by default.
If the option `all: true` is given applies the new behaviour.

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

Fixes #41051

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/41412/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41412/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41412,https://github.com/rails/rails/pull/41412,https://github.com/rails/rails/pull/41412.diff,https://github.com/rails/rails/pull/41412.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
379,https://api.github.com/repos/rails/rails/issues/41387,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41387/labels{/name},https://api.github.com/repos/rails/rails/issues/41387/comments,https://api.github.com/repos/rails/rails/issues/41387/events,https://github.com/rails/rails/pull/41387,804943530,MDExOlB1bGxSZXF1ZXN0NTcwNjI5NTYw,41387,Add support for DATABASE_NAME in DB tasks to work with dynamic database.yml,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,20,2021-02-09T21:35:12Z,2022-02-20T14:00:40Z,,CONTRIBUTOR,,"#36560 added hacks to make rake tasks work somehow with a custom ERB based `database.yml`. The core issue seems to be the way Rails needs to know in advance about all shards(names) for it to create the tasks. Instead, we can make use of ENV variables for the same purpose and avoid redundant tasks. This also resolves the issue of having to resolve `database.yml` to define rake tasks which IMO, should be standard and not application specific. All dynamics should be passed as runtime arguments - found ENV variable to be the best approach, but open to suggestions on changing the approach.

Before:
**works:** without dynamic DB configs - `RAILS_ENV=development bundle exec rails db:schema:load:name`
**does not work:** with dynamic DB configs - `RAILS_ENV=development bundle exec rails db:schema:load:name`
```ruby
Rails couldn't infer whether you are using multiple databases from your database.yml and can't generate the tasks for the non-primary databases. If you'd like to use this feature, please simplify your ERB.
rails aborted!
Don't know how to build task 'db:schema:load:name' (See the list of available tasks with `rails --tasks`)
Did you mean?  db:schema:load
```

After:
**works:** with or without dynamic DB configs - `RAILS_ENV=development NAME=name bundle exec rails db:schema:load`

Reason for going with ENV - we are already relying on ENV variable for other things like `VERSION`, `SCOPE`, `SCHEMA`, `DATABASE_URL` etc.

Will update/fix tests if the PR is okay.",https://api.github.com/repos/rails/rails/issues/41387/timeline,,ritikesh,1778360,MDQ6VXNlcjE3NzgzNjA=,https://avatars.githubusercontent.com/u/1778360?v=4,,https://api.github.com/users/ritikesh,https://github.com/ritikesh,https://api.github.com/users/ritikesh/followers,https://api.github.com/users/ritikesh/following{/other_user},https://api.github.com/users/ritikesh/gists{/gist_id},https://api.github.com/users/ritikesh/starred{/owner}{/repo},https://api.github.com/users/ritikesh/subscriptions,https://api.github.com/users/ritikesh/orgs,https://api.github.com/users/ritikesh/repos,https://api.github.com/users/ritikesh/events{/privacy},https://api.github.com/users/ritikesh/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41387/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41387,https://github.com/rails/rails/pull/41387,https://github.com/rails/rails/pull/41387.diff,https://github.com/rails/rails/pull/41387.patch,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
380,https://api.github.com/repos/rails/rails/issues/41378,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41378/labels{/name},https://api.github.com/repos/rails/rails/issues/41378/comments,https://api.github.com/repos/rails/rails/issues/41378/events,https://github.com/rails/rails/issues/41378,804263505,MDU6SXNzdWU4MDQyNjM1MDU=,41378,ActiveRecord#includes gives different results if the includes order is different.,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,15,2021-02-09T06:44:29Z,2021-12-11T18:43:48Z,,NONE,,"### Steps to reproduce

I prepared a repo.
https://github.com/github0013/activerecord-includes


### Expected behavior
<!-- Tell us what should happen -->

Switching the order in `#includes` should not change the results. (please see the [repo](https://github.com/github0013/activerecord-includes))

- A.includes(`:c_type_xs, :ds`).find(subject.id).c_type_xs.size # => 1
- A.includes(`:ds, :c_type_xs`).find(subject.id).c_type_xs.size # => 1

### Actual behavior
<!-- Tell us what happens instead -->

- A.includes(`:c_type_xs, :ds`).find(subject.id).c_type_xs.size # => 1
- A.includes(`:ds, :c_type_xs`).find(subject.id).c_type_xs.size # => 4

### System configuration
**Rails version**:

- 5.2.4.1
- 6.1.1

**Ruby version**:

- ruby 2.7.1p83 (2020-03-31 revision a0c7c23c9c) [x86_64-linux-musl]

",https://api.github.com/repos/rails/rails/issues/41378/timeline,,github0013,809378,MDQ6VXNlcjgwOTM3OA==,https://avatars.githubusercontent.com/u/809378?v=4,,https://api.github.com/users/github0013,https://github.com/github0013,https://api.github.com/users/github0013/followers,https://api.github.com/users/github0013/following{/other_user},https://api.github.com/users/github0013/gists{/gist_id},https://api.github.com/users/github0013/starred{/owner}{/repo},https://api.github.com/users/github0013/subscriptions,https://api.github.com/users/github0013/orgs,https://api.github.com/users/github0013/repos,https://api.github.com/users/github0013/events{/privacy},https://api.github.com/users/github0013/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41378/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
381,https://api.github.com/repos/rails/rails/issues/41346,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41346/labels{/name},https://api.github.com/repos/rails/rails/issues/41346/comments,https://api.github.com/repos/rails/rails/issues/41346/events,https://github.com/rails/rails/issues/41346,802294518,MDU6SXNzdWU4MDIyOTQ1MTg=,41346,Active Storage add download_chunk for blob,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,3,2021-02-05T16:18:52Z,2021-08-08T13:14:41Z,,NONE,,"With active storage you cannot get chunks directly from the attached file. You can access to the download_chunk using a different path. For ex:
```ruby
class Movie
  has_one_attached :video
end

movie = Movie.where(name: ""Star Wars: Episode IV - A New Hope"").first
chunk = movie.video.service.download_chunk(movie.video.key, 0..5.megabytes)
```

### Expected behavior
It would be better to delegate that functionality to the blob instance. In that way we could do something like:
```ruby
chunk = movie.video.download_chunk(0..10.megabytes)
```
On the other side, when you have to process a block of code for large files (10GB for example) in chunks of 5MB, there is always the possibility of an execution error. I think it could be helpful to have the ability to iterate over the chunks by index. In that way if your file processing fails after 9GB, you can restart from there instead of re-process 90% of the file.

```ruby
movie.video.download_with_index(last_successfully_processed_chunk_index) do |chunk, index|
  ...
  last_successfully_processed_chunk_index = index
end
```
",https://api.github.com/repos/rails/rails/issues/41346/timeline,,psoldier,4432609,MDQ6VXNlcjQ0MzI2MDk=,https://avatars.githubusercontent.com/u/4432609?v=4,,https://api.github.com/users/psoldier,https://github.com/psoldier,https://api.github.com/users/psoldier/followers,https://api.github.com/users/psoldier/following{/other_user},https://api.github.com/users/psoldier/gists{/gist_id},https://api.github.com/users/psoldier/starred{/owner}{/repo},https://api.github.com/users/psoldier/subscriptions,https://api.github.com/users/psoldier/orgs,https://api.github.com/users/psoldier/repos,https://api.github.com/users/psoldier/events{/privacy},https://api.github.com/users/psoldier/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41346/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
382,https://api.github.com/repos/rails/rails/issues/41321,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41321/labels{/name},https://api.github.com/repos/rails/rails/issues/41321/comments,https://api.github.com/repos/rails/rails/issues/41321/events,https://github.com/rails/rails/pull/41321,800216193,MDExOlB1bGxSZXF1ZXN0NTY2NzM3OTk5,41321,Fix counter_cache create/concat with overlapping counter_cache_column,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2021-02-03T10:59:28Z,2022-02-07T02:41:26Z,,CONTRIBUTOR,,"### Summary

Fix when multiple `belongs_to` maps to the same counter_cache column. 
In such situation `inverse_which_updates_counter_cache` may find the wrong relation which leads into an invalid increment of the counter_cache.

This is done by improving the inverse relation detection in 2 ways:
- by comparing `inverse.klass` with the current `active_record` (doesn't work for polymorphic)
- by relying on `inverse_of`

The above adjustments allows to correctly map the `inverse_which_updates_counter_cache` for both non-polymorphic/polymorphic relations.

Fixes #41250
<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/41321/timeline,,intrip,1753245,MDQ6VXNlcjE3NTMyNDU=,https://avatars.githubusercontent.com/u/1753245?v=4,,https://api.github.com/users/intrip,https://github.com/intrip,https://api.github.com/users/intrip/followers,https://api.github.com/users/intrip/following{/other_user},https://api.github.com/users/intrip/gists{/gist_id},https://api.github.com/users/intrip/starred{/owner}{/repo},https://api.github.com/users/intrip/subscriptions,https://api.github.com/users/intrip/orgs,https://api.github.com/users/intrip/repos,https://api.github.com/users/intrip/events{/privacy},https://api.github.com/users/intrip/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41321/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41321,https://github.com/rails/rails/pull/41321,https://github.com/rails/rails/pull/41321.diff,https://github.com/rails/rails/pull/41321.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
383,https://api.github.com/repos/rails/rails/issues/41262,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41262/labels{/name},https://api.github.com/repos/rails/rails/issues/41262/comments,https://api.github.com/repos/rails/rails/issues/41262/events,https://github.com/rails/rails/pull/41262,795608770,MDExOlB1bGxSZXF1ZXN0NTYyOTI4NjI5,41262,Provide a way `decorate_attribute` for attribute type decoration,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,9,2021-01-28T02:22:43Z,2022-02-26T05:44:41Z,,MEMBER,,"Just an implementation for https://github.com/rails/rails/pull/41139#discussion_r565752925.

cc @kaspth 
",https://api.github.com/repos/rails/rails/issues/41262/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41262/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41262,https://github.com/rails/rails/pull/41262,https://github.com/rails/rails/pull/41262.diff,https://github.com/rails/rails/pull/41262.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
384,https://api.github.com/repos/rails/rails/issues/41250,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41250/labels{/name},https://api.github.com/repos/rails/rails/issues/41250/comments,https://api.github.com/repos/rails/rails/issues/41250/events,https://github.com/rails/rails/issues/41250,794673794,MDU6SXNzdWU3OTQ2NzM3OTQ=,41250,ActiveRecord updates counters when it shouldn't,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,11,2021-01-27T00:52:56Z,2022-02-07T10:04:03Z,,NONE,,"### Steps to reproduce

Here is a test case:

```
# frozen_string_literal: true

require 'bundler/inline'

gemfile(true) do
  source 'https://rubygems.org'

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem 'rails', github: 'rails/rails', branch: 'main'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.integer :comments_count, default: 0
  end

  create_table :users, force: true do |t|
    t.integer :comments_count, default: 0
  end

  create_table :comments, force: true do |t|
    t.integer :user_id
  end

  create_table :comment_maps, force: true do |t|
    t.integer :comment_id
    t.integer :commentable_id
    t.string :commentable_type
  end
end

class User < ActiveRecord::Base
end

class CommentMap < ActiveRecord::Base
  belongs_to :comment
  belongs_to :commentable, polymorphic: true
end

class Comment < ActiveRecord::Base
  belongs_to :user, counter_cache: true
  has_many :comment_maps, dependent: :destroy
  has_many :commented_posts, through: :comment_maps, source: :commentable, source_type: 'Post'
end

class Post < ActiveRecord::Base
  has_many :comment_maps, as: :commentable
  has_many :comments, through: :comment_maps
end

class BugTest < Minitest::Test
  def test_counter
    post = Post.create!
    post.comments << Comment.create!

    assert_equal 0, post.comments_count
  end
end
```

### Expected Behaviour

The test should pass. Since there is no `counter_cache` defined for the comments-posts relation, I don't expect its counters get the updates.

### Actual Behaviour

The test fails:

```
Failure:
BugTest#test_counter [test.rb:66]:
Expected: 0
  Actual: 1
```

### The Cause

It is happening because a `belongs_to` relation is defined for the `User` model. The root of the problem is here:

https://github.com/rails/rails/blob/291a3d2ef29a3842d1156ada7526f4ee60dd2b59/activerecord/lib/active_record/reflection.rb#L250-L255

It needs a more strict condition to determine the inverse relation.",https://api.github.com/repos/rails/rails/issues/41250/timeline,,milani,508130,MDQ6VXNlcjUwODEzMA==,https://avatars.githubusercontent.com/u/508130?v=4,,https://api.github.com/users/milani,https://github.com/milani,https://api.github.com/users/milani/followers,https://api.github.com/users/milani/following{/other_user},https://api.github.com/users/milani/gists{/gist_id},https://api.github.com/users/milani/starred{/owner}{/repo},https://api.github.com/users/milani/subscriptions,https://api.github.com/users/milani/orgs,https://api.github.com/users/milani/repos,https://api.github.com/users/milani/events{/privacy},https://api.github.com/users/milani/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41250/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
385,https://api.github.com/repos/rails/rails/issues/41195,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41195/labels{/name},https://api.github.com/repos/rails/rails/issues/41195/comments,https://api.github.com/repos/rails/rails/issues/41195/events,https://github.com/rails/rails/issues/41195,790700051,MDU6SXNzdWU3OTA3MDAwNTE=,41195,ActiveRecord::Persistence#becomes doesn't handle virtual attributes,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2021-01-21T05:04:07Z,2021-07-02T05:26:25Z,,CONTRIBUTOR,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

Add a virtual attribute to an inherited model, and use `#becomes` from either the parent to the child or the child to the parent

### Expected behavior
<!-- Tell us what should happen -->

Virtual Attributes should be correctly initialized and there shouldn't be any errors, since they have nothing to do with the database

### Actual behavior
<!-- Tell us what happens instead -->

an `ActiveRecord::UnknownAttributeError` is thrown if you try to go either direction

### System configuration
**Rails version**: 6.0.3.4 (but I was the one who submitted the last patch for becomes to correctly move items back into the initialize block like they're supposed to be, so I have the current monkey patch for the latest version, it happens on all versions at least from 6+, tested up to 6.1.1)

**Ruby version**: ruby 2.7.2p137 (2020-10-01 revision 5445e04352) [x86_64-linux] (but also really not a cause here)
",https://api.github.com/repos/rails/rails/issues/41195/timeline,,SampsonCrowley,22461638,MDQ6VXNlcjIyNDYxNjM4,https://avatars.githubusercontent.com/u/22461638?v=4,,https://api.github.com/users/SampsonCrowley,https://github.com/SampsonCrowley,https://api.github.com/users/SampsonCrowley/followers,https://api.github.com/users/SampsonCrowley/following{/other_user},https://api.github.com/users/SampsonCrowley/gists{/gist_id},https://api.github.com/users/SampsonCrowley/starred{/owner}{/repo},https://api.github.com/users/SampsonCrowley/subscriptions,https://api.github.com/users/SampsonCrowley/orgs,https://api.github.com/users/SampsonCrowley/repos,https://api.github.com/users/SampsonCrowley/events{/privacy},https://api.github.com/users/SampsonCrowley/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41195/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
386,https://api.github.com/repos/rails/rails/issues/41176,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41176/labels{/name},https://api.github.com/repos/rails/rails/issues/41176/comments,https://api.github.com/repos/rails/rails/issues/41176/events,https://github.com/rails/rails/issues/41176,789261168,MDU6SXNzdWU3ODkyNjExNjg=,41176,Parallel-testing test-run raises Bad file descriptor (Errno::EBADF) using MySQL 8.0,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 911155223, 'node_id': 'MDU6TGFiZWw5MTExNTUyMjM=', 'url': 'https://api.github.com/repos/rails/rails/labels/parallel%20testing', 'name': 'parallel testing', 'color': 'a9f9c3', 'default': False, 'description': ''}]",open,False,,[],,10,2021-01-19T18:34:24Z,2022-01-26T13:36:34Z,,CONTRIBUTOR,,"**See below:** The issue can also be worked around by compiling the mysql2 gem using the mysql 5.7 client: https://github.com/rails/rails/issues/41176#issuecomment-772186345

**Updated** to reflect that the issue also exists under apps using Rails 6.1.1 and rails/rails. https://github.com/johnmaxwell/parallelmysql61

We updated an application to Rails 6.0.3.4 and configured it to use parallel tests. This application uses MySQL 8.0. Our team uses Macs for our development machines, and MySQL 8.0 is installed via Homebrew with little-to-no customization.

When running the test-suite in parallel with two or more workers, the tests will raise an error: `Bad file descriptor (Errno::EBADF)`  part way through the run. It's unclear what causes this issue since the exception originates from `drb/drb.rb`. 

We've tweaked the gems and poked and prodded at this application in an attempt to fix the problem to no avail. The only ""fix"" is to run the tests serially by changing `test_helper.rb` or using `PARALLEL_WORKERS=1` when running the test suite. This is advice that you usually find on StackOverflow when searching for this problem.

### Steps to reproduce

We have reproduced this issue in a stock Rails 6.0.3.4 application connecting to a MySQL 8.0 database: https://github.com/johnmaxwell/parallelmysql 

This simple Rails application was generated with the following commands:

```
rails new parallelmysql -d mysql
./bin/rails db:create 
./bin/rails g model User name:string
./bin/rails db:migrate
```

We give `test/models/user_test.rb` the following content. This gives us a bunch of time-consuming tests for the parallel test suite to run.

```ruby
require 'test_helper'

class UserTest < ActiveSupport::TestCase
  200.times do |i|
    test ""test-case ##{i}: creates #{i} records"" do
      i.times do
        User.create!(name: SecureRandom.alphanumeric(20))
      end
      assert_equal i, User.count
    end
  end
end
```

### Expected behavior

Running the tests with the following command should run the test suite to completion using 2 test workers. `PARALLEL_WORKERS=2 ./bin/rails test` 

### Actual behavior

The tests suite fails without running to completion with the following output:

```
$ PARALLEL_WORKERS=2 ./bin/rails test
Running via Spring preloader in process 9204
Run options: --seed 6137

# Running:

......#<Thread:0x00007ffcb81416c8 /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1259 run> terminated with exception (report_on_exception is true):
Traceback (most recent call last):
	10: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1262:in `block in make_pool'
	 9: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1237:in `_execute'
	 8: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/monitor.rb:202:in `mon_synchronize'
	 7: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/monitor.rb:202:in `synchronize'
	 6: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1239:in `block in _execute'
	 5: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1268:in `block (2 levels) in make_pool'
	 4: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1268:in `each'
	 3: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1270:in `block (3 levels) in make_pool'
	 2: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1334:in `alive?'
	 1: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1002:in `alive?'
/Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1002:in `wait_readable': Bad file descriptor (Errno::EBADF)
#<Thread:0x00007ffcb81416c8 /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1259 run> terminated with exception (report_on_exception is true):
Traceback (most recent call last):
	10: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1262:in `block in make_pool'
	 9: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1237:in `_execute'
	 8: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/monitor.rb:202:in `mon_synchronize'
	 7: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/monitor.rb:202:in `synchronize'
	 6: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1239:in `block in _execute'
	 5: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1268:in `block (2 levels) in make_pool'
	 4: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1268:in `each'
	 3: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1270:in `block (3 levels) in make_pool'
	 2: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1334:in `alive?'
	 1: from /Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1002:in `alive?'
/Users/john/.rbenv/versions/2.7.2/lib/ruby/2.7.0/drb/drb.rb:1002:in `wait_readable': Bad file descriptor (Errno::EBADF)
```

### System configuration
**Rails version**: 6.0.3.4, 6.1.1 & rails/rails:e8d7181ad6fd040b60c25752c1a60d939e4a8505
**Ruby version**: 2.7.2p137
**MySQL version**: 8.0.22, 8.0.23
**MacOS versions**: 10.15.7
",https://api.github.com/repos/rails/rails/issues/41176/timeline,,johnmaxwell,13686,MDQ6VXNlcjEzNjg2,https://avatars.githubusercontent.com/u/13686?v=4,,https://api.github.com/users/johnmaxwell,https://github.com/johnmaxwell,https://api.github.com/users/johnmaxwell/followers,https://api.github.com/users/johnmaxwell/following{/other_user},https://api.github.com/users/johnmaxwell/gists{/gist_id},https://api.github.com/users/johnmaxwell/starred{/owner}{/repo},https://api.github.com/users/johnmaxwell/subscriptions,https://api.github.com/users/johnmaxwell/orgs,https://api.github.com/users/johnmaxwell/repos,https://api.github.com/users/johnmaxwell/events{/privacy},https://api.github.com/users/johnmaxwell/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41176/reactions,6,6,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
387,https://api.github.com/repos/rails/rails/issues/41151,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41151/labels{/name},https://api.github.com/repos/rails/rails/issues/41151/comments,https://api.github.com/repos/rails/rails/issues/41151/events,https://github.com/rails/rails/issues/41151,787967608,MDU6SXNzdWU3ODc5Njc2MDg=,41151,Join table data assigned to Model,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,15,2021-01-18T06:33:54Z,2022-02-03T12:59:29Z,,NONE,,"### Steps to reproduce
Guess Author and Article models and there are the following data.
```ruby
irb(main):010:0> Author.all
  Author Load (0.2ms)  SELECT ""authors"".* FROM ""authors"" /* loading for inspect */ LIMIT ?  [[""LIMIT"", 11]]
=> #<ActiveRecord::Relation [#<Author id: 1, name: ""John"", created_at: ""2021-01-08 06:31:00.102779000 +0000"", updated_at: ""2021-01-08 06:31:00.102779000 +0000"", author_profile_id: nil>, #<Author id: 2, name: ""Smith"", created_at: ""2021-01-08 06:31:11.958534000 +0000"", updated_at: ""2021-01-08 06:31:11.958534000 +0000"", author_profile_id: nil>]>
```
```ruby
irb(main):009:0> Article.all
  Article Load (0.2ms)  SELECT ""articles"".* FROM ""articles"" /* loading for inspect */ LIMIT ?  [[""LIMIT"", 11]]
=> #<ActiveRecord::Relation [#<Article id: 1, author_id: 2, name: ""article name"", body: ""test"", created_at: ""2021-01-08 06:31:51.149971000 +0000"", updated_at: ""2021-01-18 06:12:35.192548000 +0000"">]>
irb(main):010:0> 
```

On Rails 6.1, `select` method with `*`results in that join table's column data assigned to the attribute which is the same name. In this case, `<Article id: 1, name: ""article name"", ...` is expected and I think this is dangerous.
```ruby
irb(main):011:0> Article.joins(:author).select(Arel.star).find 1
  Article Load (0.2ms)  SELECT * FROM ""articles"" INNER JOIN ""authors"" ON ""authors"".""id"" = ""articles"".""author_id"" WHERE ""articles"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
=> #<Article id: 2, author_id: 2, name: ""Smith"", body: ""test"", created_at: ""2021-01-08 06:31:11.958534000 +0000"", updated_at: ""2021-01-08 06:31:11.958534000 +0000"">
```

This works.
```ruby
irb(main):014:0> Article.joins(:author).select('authors.*', 'articles.*').find 1
  Article Load (0.2ms)  SELECT authors.*, articles.* FROM ""articles"" INNER JOIN ""authors"" ON ""authors"".""id"" = ""articles"".""author_id"" WHERE ""articles"".""id"" = ? LIMIT ?  [[""id"", 1], [""LIMIT"", 1]]
=> #<Article id: 1, author_id: 2, body: ""test"", created_at: ""2021-01-08 06:31:51.149971000 +0000"", updated_at: ""2021-01-18 06:12:35.192548000 +0000"", name: ""article name"">
```

### Expected behavior
<!-- Tell us what should happen -->

### Actual behavior
<!-- Tell us what happens instead -->

### System configuration
**Rails version**:
6.1.1

**Ruby version**:
2.7.1",https://api.github.com/repos/rails/rails/issues/41151/timeline,,weistom,39337855,MDQ6VXNlcjM5MzM3ODU1,https://avatars.githubusercontent.com/u/39337855?v=4,,https://api.github.com/users/weistom,https://github.com/weistom,https://api.github.com/users/weistom/followers,https://api.github.com/users/weistom/following{/other_user},https://api.github.com/users/weistom/gists{/gist_id},https://api.github.com/users/weistom/starred{/owner}{/repo},https://api.github.com/users/weistom/subscriptions,https://api.github.com/users/weistom/orgs,https://api.github.com/users/weistom/repos,https://api.github.com/users/weistom/events{/privacy},https://api.github.com/users/weistom/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41151/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
388,https://api.github.com/repos/rails/rails/issues/41148,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41148/labels{/name},https://api.github.com/repos/rails/rails/issues/41148/comments,https://api.github.com/repos/rails/rails/issues/41148/events,https://github.com/rails/rails/issues/41148,787702832,MDU6SXNzdWU3ODc3MDI4MzI=,41148,Remove Rack::SendFile from default middleware.,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,11,2021-01-17T13:10:01Z,2022-03-14T23:36:50Z,,NONE,,"### Steps to reproduce

Example of rails controller.

```ruby
class FilesController < ApplicationController
  def index
    send_file(""./README.md"")
  end
end
````

Code like the one above can be attacked by a specially crafted request.
See [hackrone](https://hackerone.com/reports/1057216) for details on the attack code.

### Actual behavior

[Rack::SendFile](https://github.com/rack/rack/blob/v2.2.2/lib/rack/sendfile.rb) used in [send_file](https://api.rubyonrails.org/classes/ActionController/DataStreaming.html#method-i-send_file) has the following risks if proxy is not set properly.

- ReDoS via Regex Injection
- Unexpected access to nginx internal


It has been suggested to remove Rack::SendFile from the default in the hope that the user will handle the proxy properly.


### System configuration
**Rails version**: *

**Ruby version**: *
",https://api.github.com/repos/rails/rails/issues/41148/timeline,,ooooooo-q,395584,MDQ6VXNlcjM5NTU4NA==,https://avatars.githubusercontent.com/u/395584?v=4,,https://api.github.com/users/ooooooo-q,https://github.com/ooooooo-q,https://api.github.com/users/ooooooo-q/followers,https://api.github.com/users/ooooooo-q/following{/other_user},https://api.github.com/users/ooooooo-q/gists{/gist_id},https://api.github.com/users/ooooooo-q/starred{/owner}{/repo},https://api.github.com/users/ooooooo-q/subscriptions,https://api.github.com/users/ooooooo-q/orgs,https://api.github.com/users/ooooooo-q/repos,https://api.github.com/users/ooooooo-q/events{/privacy},https://api.github.com/users/ooooooo-q/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41148/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
389,https://api.github.com/repos/rails/rails/issues/41136,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41136/labels{/name},https://api.github.com/repos/rails/rails/issues/41136/comments,https://api.github.com/repos/rails/rails/issues/41136/events,https://github.com/rails/rails/pull/41136,787322476,MDExOlB1bGxSZXF1ZXN0NTU2MDU4MjA5,41136,Concise logging format for the binds of casted values,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2021-01-16T01:58:42Z,2022-02-26T05:44:52Z,,MEMBER,,"Related issue #41133.

In #39106, I've allowed binds of casted values as an alternative of the
legacy binds (an array of `[column || nil, value]`) to deprecate and
remove the legacy binds support in a future version of Rails.

At that time, I've respected the existing logging format for binds.

i.e.

```ruby
# legacy binds
conn.select_all(""SELECT * FROM events WHERE id IN (?, ?)"", nil, [[nil, 1], [nil, 2]])
# (0.1ms)  SELECT * FROM events WHERE id IN (?, ?)  [[nil, 1], [nil, 2]]

# casted binds
conn.select_all(""SELECT * FROM events WHERE id IN (?, ?)"", nil, [1, 2])
# (0.1ms)  SELECT * FROM events WHERE id IN (?, ?)  [[nil, 1], [nil, 2]]
```

To improve the performance of generating IN clause, 72fd0ba avoids
`build_bind_attribute` for each values, so now binds has become casted
values.

```ruby
conn.select_all(Event.where(id: [1, 2]))
# (0.1ms)  SELECT * FROM events WHERE id IN (?, ?)  [[nil, 1], [nil, 2]]
```

Regardless of whether 72fd0ba avoids `build_bind_attribute` or not, the
logging format for the binds of casted values is odd (at least not
pretty to me).

I'd like to concise the logging format to just use casted values.

```ruby
conn.select_all(""SELECT * FROM events WHERE id IN (?, ?)"", nil, [1, 2])
# (0.1ms)  SELECT * FROM events WHERE id IN (?, ?)  [1, 2]

conn.select_all(Event.where(id: [1, 2]))
# (0.1ms)  SELECT * FROM events WHERE id IN (?, ?)  [1, 2]
```
",https://api.github.com/repos/rails/rails/issues/41136/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41136/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41136,https://github.com/rails/rails/pull/41136,https://github.com/rails/rails/pull/41136.diff,https://github.com/rails/rails/pull/41136.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
390,https://api.github.com/repos/rails/rails/issues/41051,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41051/labels{/name},https://api.github.com/repos/rails/rails/issues/41051/comments,https://api.github.com/repos/rails/rails/issues/41051/events,https://github.com/rails/rails/issues/41051,782068726,MDU6SXNzdWU3ODIwNjg3MjY=,41051,Empty arrays don't pass validate exclusion of nil in Rails 6.1,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,9,2021-01-08T11:57:49Z,2021-08-16T21:22:42Z,,NONE,,"We'd like to validate that an attribute backed by an array or JSON(B) database column is not nil, while allowing empty arrays.

Before Rails 6.1 `validates :value, exclusion: { in: [nil] }` worked.

After https://github.com/rails/rails/pull/22610 this is no longer the case.

Also reported by @mkamensky here: https://github.com/rails/rails/pull/22610#commitcomment-45326313

### Steps to reproduce

Attempt to set an attribute with `validates :value, exclusion: { in: [nil] }` to `[]`.

[Repro script](https://gist.github.com/haines/90d8abb93c7ca00279a723e20c32e072) (requires PostgreSQL running locally)

```console
$ git clone https://gist.github.com/90d8abb93c7ca00279a723e20c32e072.git validates_exclusion_of_nil_with_empty_array

$ cd validates_exclusion_of_nil_with_empty_array

$ ruby validates_exclusion_of_nil_with_empty_array_test.rb 6.0.3.4
-- create_table(:examples)
   -> 0.0196s
Run options: --seed 50787

# Running:

..

Finished in 0.016144s, 123.8850 runs/s, 123.8850 assertions/s.
2 runs, 2 assertions, 0 failures, 0 errors, 0 skips

$ ruby validates_exclusion_of_nil_with_empty_array_test.rb 6.1.1
-- create_table(:examples)
   -> 0.0199s
Run options: --seed 6233

# Running:

F

Failure:
TestValidateExclusionOfNilWithEmptyArray#test_empty_array_is_valid [validates_exclusion_of_nil_with_empty_array_test.rb:39]:
Expected false to be truthy.


rails test validates_exclusion_of_nil_with_empty_array_test.rb:38

.

Finished in 0.006463s, 309.4538 runs/s, 309.4538 assertions/s.
2 runs, 2 assertions, 1 failures, 0 errors, 0 skips
```

### Expected behavior

`validates :value, exclusion: { in: [nil] }` should allow `[]` but reject `nil`

### Actual behavior

`validates :value, exclusion: { in: [nil] }` rejects both `[]` and `nil`

### System configuration
**Rails version**: 6.1.1

**Ruby version**: 2.7.2p137
",https://api.github.com/repos/rails/rails/issues/41051/timeline,,haines,785641,MDQ6VXNlcjc4NTY0MQ==,https://avatars.githubusercontent.com/u/785641?v=4,,https://api.github.com/users/haines,https://github.com/haines,https://api.github.com/users/haines/followers,https://api.github.com/users/haines/following{/other_user},https://api.github.com/users/haines/gists{/gist_id},https://api.github.com/users/haines/starred{/owner}{/repo},https://api.github.com/users/haines/subscriptions,https://api.github.com/users/haines/orgs,https://api.github.com/users/haines/repos,https://api.github.com/users/haines/events{/privacy},https://api.github.com/users/haines/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41051/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
391,https://api.github.com/repos/rails/rails/issues/41010,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41010/labels{/name},https://api.github.com/repos/rails/rails/issues/41010/comments,https://api.github.com/repos/rails/rails/issues/41010/events,https://github.com/rails/rails/issues/41010,778317179,MDU6SXNzdWU3NzgzMTcxNzk=,41010,Joins with filter genererates invalid query. Regression in 6.1,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,4,2021-01-04T19:41:26Z,2021-10-15T19:19:53Z,,CONTRIBUTOR,,"Given the following structure:

```ruby

class CreateCollections < ActiveRecord::Migration[6.0]
  def change
    create_table :collections do |t|
      t.string :name, null: false
      t.timestamps
    end
  end
end

class CreateWorks < ActiveRecord::Migration[6.0]
  def change
    create_table :works do |t|
      t.string :title, null: false
      t.references :collection
      t.timestamps
    end
  end
end

class DeviseCreateUsers < ActiveRecord::Migration[6.0]
  def change
    create_table :users do |t|
      ## Database authenticatable
      t.string :email,              null: false, default: """"
    end
  end
end

class AddHabtmReviewersToCollection < ActiveRecord::Migration[6.0]
  def change
    create_join_table :collections, :users, table_name: :reviewers do |t|
      t.index [:collection_id, :user_id], unique: true
    end
  end
end

class User < ApplicationRecord
  has_and_belongs_to_many :reviews_collections, class_name: 'Collection', join_table: 'reviewers'
end

class Collection < ApplicationRecord
  has_many :works, dependent: :destroy
  has_and_belongs_to_many :reviewers, class_name: 'User', join_table: 'reviewers'
end

class Work < ApplicationRecord
  belongs_to :collection
end
```


Then when I run this query:
```
Work.joins(collection: :reviewers).where('reviewers.user_id' => 1)
```

I get this SQL in Rails 6.1:
```
SELECT ""works"".* FROM ""works"" INNER JOIN ""collections"" ON ""collections"".""id"" = ""works"".""collection_id"" INNER JOIN ""reviewers"" ""collections_reviewers_collections_join"" ON ""collections_reviewers_collections_join"".""collection_id"" = ""collections"".""id"" INNER JOIN ""users"" reviewers ON reviewers.""id"" = ""collections_reviewers_collections_join"".""user_id"" WHERE ""reviewers"".""user_id"" = $1
```

But in Rails 6.0 I get:
```
 SELECT ""works"".* FROM ""works"" INNER JOIN ""collections"" ON ""collections"".""id"" = ""works"".""collection_id"" INNER JOIN ""reviewers"" ON ""reviewers"".""collection_id"" = ""collections"".""id"" INNER JOIN ""users"" ON ""users"".""id"" = ""reviewers"".""user_id"" WHERE ""reviewers"".""user_id"" = $1
```


The SQL from Rails 6.1 results in the error: 

```
ActiveRecord::StatementInvalid (PG::UndefinedColumn: ERROR:  column reviewers.user_id does not exist)
LINE 1: ...ERE (""works"".""state"" IN ('pending_approval')) AND ""reviewers...
                                                             ^
```

I believe this is because it has used the alias ""reviewers"" for the table ""users"", and ""reviewers"" is an actual table name.",https://api.github.com/repos/rails/rails/issues/41010/timeline,,jcoyne,92044,MDQ6VXNlcjkyMDQ0,https://avatars.githubusercontent.com/u/92044?v=4,,https://api.github.com/users/jcoyne,https://github.com/jcoyne,https://api.github.com/users/jcoyne/followers,https://api.github.com/users/jcoyne/following{/other_user},https://api.github.com/users/jcoyne/gists{/gist_id},https://api.github.com/users/jcoyne/starred{/owner}{/repo},https://api.github.com/users/jcoyne/subscriptions,https://api.github.com/users/jcoyne/orgs,https://api.github.com/users/jcoyne/repos,https://api.github.com/users/jcoyne/events{/privacy},https://api.github.com/users/jcoyne/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41010/reactions,3,3,0,0,0,0,0,0,0,,,,,,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/milestones/79,https://github.com/rails/rails/milestone/79,https://api.github.com/repos/rails/rails/milestones/79/labels,6599195.0,MDk6TWlsZXN0b25lNjU5OTE5NQ==,79.0,6.1.4,,georgeclaghorn,94129.0,MDQ6VXNlcjk0MTI5,https://avatars.githubusercontent.com/u/94129?v=4,,https://api.github.com/users/georgeclaghorn,https://github.com/georgeclaghorn,https://api.github.com/users/georgeclaghorn/followers,https://api.github.com/users/georgeclaghorn/following{/other_user},https://api.github.com/users/georgeclaghorn/gists{/gist_id},https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo},https://api.github.com/users/georgeclaghorn/subscriptions,https://api.github.com/users/georgeclaghorn/orgs,https://api.github.com/users/georgeclaghorn/repos,https://api.github.com/users/georgeclaghorn/events{/privacy},https://api.github.com/users/georgeclaghorn/received_events,User,False,3.0,6.0,open,2021-03-27T12:10:57Z,2021-10-22T16:25:06Z,,
392,https://api.github.com/repos/rails/rails/issues/41004,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/41004/labels{/name},https://api.github.com/repos/rails/rails/issues/41004/comments,https://api.github.com/repos/rails/rails/issues/41004/events,https://github.com/rails/rails/pull/41004,777679909,MDExOlB1bGxSZXF1ZXN0NTQ3OTA5ODYy,41004,enable custom Blob#key configuration (to ease Paperclip migration to ActiveStorage),"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,21,2021-01-03T17:17:35Z,2022-03-30T18:37:01Z,,NONE,,"Hello Rails Team!

First of all I want to thank you for all job that you make here!!! Rails is a wonderfull framework to work with.

@georgeclaghorn Thank you for your answers in [this issue](https://github.com/rails/rails/issues/38161#issuecomment-571163001) that helped me to fine-tune this feature.


### Summary

**ActiveStorage custom storage path configuration**

**thoughtbot** has made a wonderfull [paperclip gem](https://github.com/thoughtbot/paperclip), but since it is depracated we are in the process of switching to ActiveStorage all our attachments management.

In Paperclip there is a fine feature where you can choose a [specific storage path](https://github.com/thoughtbot/paperclip) for each of the model attachable attribute and interpolate values in it as follows:

```ruby
# app/models/user.rb

# in Paperclip
has_attached_file :avatar,
                  path: ':tenant/users/:user_id/:hash/:filename'
```

The idea of this PR is to make this possible in ActiveStorage too and have something like that:

```ruby
# app/models/user.rb

# now in ActiveStorage
has_one_attached :avatar,
                 key: ':tenant/users/:id/:unique_secure_token'
```

NB: I have also added a test that makes sure the following change from the [Rails 6.1 changelog](https://github.com/rails/rails/releases/tag/v6.1.0) is still working :

```
You can optionally provide a custom blob key when attaching a new file:

user.avatar.attach key: ""avatars/#{user.id}.jpg"",
  io: io, content_type: ""image/jpeg"", filename: ""avatar.jpg""
Active Storage will store the blob's data on the configured service at the provided key.

George Claghorn
```

Thanks for your consideration, I would be glad to contribute even more!

### Other Information

Just for record, here is our business issue other tech companies might also have: *We use the [apartment gem](https://github.com/influitive/apartment) to split our datas on a client basis and we want to make the same with uploaded files and store them in separate folders.*

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/41004/timeline,,frantisekrokusekpa,56537762,MDQ6VXNlcjU2NTM3NzYy,https://avatars.githubusercontent.com/u/56537762?v=4,,https://api.github.com/users/frantisekrokusekpa,https://github.com/frantisekrokusekpa,https://api.github.com/users/frantisekrokusekpa/followers,https://api.github.com/users/frantisekrokusekpa/following{/other_user},https://api.github.com/users/frantisekrokusekpa/gists{/gist_id},https://api.github.com/users/frantisekrokusekpa/starred{/owner}{/repo},https://api.github.com/users/frantisekrokusekpa/subscriptions,https://api.github.com/users/frantisekrokusekpa/orgs,https://api.github.com/users/frantisekrokusekpa/repos,https://api.github.com/users/frantisekrokusekpa/events{/privacy},https://api.github.com/users/frantisekrokusekpa/received_events,User,False,https://api.github.com/repos/rails/rails/issues/41004/reactions,50,50,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/41004,https://github.com/rails/rails/pull/41004,https://github.com/rails/rails/pull/41004.diff,https://github.com/rails/rails/pull/41004.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
393,https://api.github.com/repos/rails/rails/issues/40958,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40958/labels{/name},https://api.github.com/repos/rails/rails/issues/40958/comments,https://api.github.com/repos/rails/rails/issues/40958/events,https://github.com/rails/rails/issues/40958,775454919,MDU6SXNzdWU3NzU0NTQ5MTk=,40958,Rails 6: Scoping behavior on associations: Consistency with Security,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,5,2020-12-28T15:29:05Z,2021-03-29T05:20:49Z,,NONE,,"6.0.0.RC1 introduced a correction on an inconsistency: 

> Association loading isn't to be affected by scoping consistently whether preloaded / eager loaded or not, with the exception of unscoped.
> 
> Before:
>
> ```
>Post.where(""1=0"").scoping do
>   Comment.find(1).post                   # => nil
>   Comment.preload(:post).find(1).post    # => #<Post id: 1, ...>
>   Comment.eager_load(:post).find(1).post # => #<Post id: 1, ...>
> end
>```
> 
> After:
> 
> ```
> Post.where(""1=0"").scoping do
>   Comment.find(1).post                   # => #<Post id: 1, ...>
>   Comment.preload(:post).find(1).post    # => #<Post id: 1, ...>
>   Comment.eager_load(:post).find(1).post # => #<Post id: 1, ...>
> end
>  ```
>
> Fixes #34638, #35398.
> 

""Scoping"" is a corner stone in the management of security: we lock users within scopes of the data they are allowed to see. Scopes are used as a data jail mechanism. While we agree on the initial problem statement (the behavior was inconsistent), we believe that to preserve good security of the data, the consistency should be restored as follows:
```
Post.where(""1=0"").scoping do
  Comment.find(1).post                   # => nil
  Comment.preload(:post).find(1).post    # => nil
  Comment.eager_load(:post).find(1).post # => nil
end
```
As a consequence, applications that were safe before Rails 6 may now leak information to some unprivileged users.

We can also note that some inconsistencies are present with the current version:
```
Comment.where('1=0').scoping do
  Comment.where(post_id: 1).exists?   # => false
  Post.find(1).comments.exists?       # => true
end
```

We can provide a PR for Rails 6 (based on 1a58db0, maybe with a less naive approach) following these lines (enforcing the strong scoping rules, not the weak ones). While we don't see when the weak model is relevant (we do not have a use for it), it might be useful to some. So possibly the solution should not be to have either, but both. In which case, we suggest to have a global configuration mechanism to select whether the application is running with the weak scoping rules, or the strong scoping rules.",https://api.github.com/repos/rails/rails/issues/40958/timeline,,jdelporte,16072040,MDQ6VXNlcjE2MDcyMDQw,https://avatars.githubusercontent.com/u/16072040?v=4,,https://api.github.com/users/jdelporte,https://github.com/jdelporte,https://api.github.com/users/jdelporte/followers,https://api.github.com/users/jdelporte/following{/other_user},https://api.github.com/users/jdelporte/gists{/gist_id},https://api.github.com/users/jdelporte/starred{/owner}{/repo},https://api.github.com/users/jdelporte/subscriptions,https://api.github.com/users/jdelporte/orgs,https://api.github.com/users/jdelporte/repos,https://api.github.com/users/jdelporte/events{/privacy},https://api.github.com/users/jdelporte/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40958/reactions,12,12,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
394,https://api.github.com/repos/rails/rails/issues/40892,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40892/labels{/name},https://api.github.com/repos/rails/rails/issues/40892/comments,https://api.github.com/repos/rails/rails/issues/40892/events,https://github.com/rails/rails/issues/40892,771518021,MDU6SXNzdWU3NzE1MTgwMjE=,40892,CSRF ActionableExceptions middleware,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,1,2020-12-20T05:28:55Z,2020-12-30T00:55:38Z,,NONE,,"https://github.com/rails/rails/blob/v6.1.0/actionpack/lib/action_dispatch/middleware/actionable_exceptions.rb

XSS with ActionableExceptions has been fixed in 6.0.3.4, but there is still an issue with accepting cross site requests.
Therefore, there are the following problems in the development environment.

I suggest limiting the requests this middleware accepts to ajax requests with custom headers (x-requested-with).

For more information [hackerone](https://hackerone.com/reports/904059).

### Steps to reproduce

example attack server.

```html
<form method=""post"" action=""http://localhost:3000/rails/actions?error=ActiveRecord::PendingMigrationError&action=Run%20pending%20migrations&location=https://www.hackerone.com/"">
    <button type=""submit"">click!</button>
</form>
```

### Expected behavior

Block cross site request.

### Actual behavior

- Run pending migrations by CSRF
- Open redirect (from POST method)
- HTTP header injection

### System configuration

**Rails version**: 6.1.0

**Ruby version**: ruby 2.7.1p83",https://api.github.com/repos/rails/rails/issues/40892/timeline,,ooooooo-q,395584,MDQ6VXNlcjM5NTU4NA==,https://avatars.githubusercontent.com/u/395584?v=4,,https://api.github.com/users/ooooooo-q,https://github.com/ooooooo-q,https://api.github.com/users/ooooooo-q/followers,https://api.github.com/users/ooooooo-q/following{/other_user},https://api.github.com/users/ooooooo-q/gists{/gist_id},https://api.github.com/users/ooooooo-q/starred{/owner}{/repo},https://api.github.com/users/ooooooo-q/subscriptions,https://api.github.com/users/ooooooo-q/orgs,https://api.github.com/users/ooooooo-q/repos,https://api.github.com/users/ooooooo-q/events{/privacy},https://api.github.com/users/ooooooo-q/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40892/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
395,https://api.github.com/repos/rails/rails/issues/40874,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40874/labels{/name},https://api.github.com/repos/rails/rails/issues/40874/comments,https://api.github.com/repos/rails/rails/issues/40874/events,https://github.com/rails/rails/issues/40874,770417005,MDU6SXNzdWU3NzA0MTcwMDU=,40874,ActiveRecord 6.1.0 query with merge raises ActiveModel:: MissingAttributeError,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,8,2020-12-17T22:19:51Z,2021-06-25T20:45:34Z,,NONE,,"This issue does not exist on rails 6.0.3.4 with the same versions of other libraries (mainly `geocoder`).

### Steps to reproduce
```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""6.1.0""
  gem ""sqlite3""
  gem ""geocoder"", ""1.6.4""
end

require ""active_record""
require ""geocoder""
require ""geocoder/models/active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :organizations, force: true do |t|
    t.string :name
  end

  create_table :sales, force: true do |t|
    t.references :location
  end

  create_table :locations, force: true do |t|
    t.references :organization
    t.integer :sale_id
  end

  create_table :addresses, force: true do |t|
    t.references :entity, polymorphic: true
    t.decimal ""latitude""
    t.decimal ""longitude""
    t.index [""latitude"", ""longitude""], name: ""index_addresses_on_latitude_and_longitude""
  end
end

class Sale < ActiveRecord::Base
  belongs_to :location
  has_one :organization, through: :location
end

class Organization < ActiveRecord::Base
  has_many :locations
end

class Location < ActiveRecord::Base
  belongs_to :organization
  has_many :sales
  has_one :address, as: :entity, required: true, dependent: :destroy
end

class Address < ActiveRecord::Base
  extend Geocoder::Model::ActiveRecord

  belongs_to :entity, polymorphic: true

  geocoded_by :address_details
  after_validation :geocode

  def address_details
    ""New York, NY""
  end
end

Geocoder.configure(lookup: :test, ip_lookup: :test)
Geocoder::Lookup::Test.add_stub(
  ""New York, NY"", [
    {
    'coordinates'  => [40.7143528, -74.0059731],
    'address'      => 'New York, NY, USA',
    'state'        => 'New York',
    'state_code'   => 'NY',
    'country'      => 'United States',
    'country_code' => 'US'
    }
  ]
)

class BugTest < Minitest::Test
  def test_no_exception_raised
    organization = Organization.create!
    location = organization.locations.create! { |l| l.build_address }
    location.sales.create!

    relation = Sale.joins(:organization).merge(Organization.all)
    relation = relation.includes(location: [:organization, :address])
    relation = relation.merge(Address.near('New York, NY')).references(:addresses)

    relation.to_a
  end
end
```

### Expected behavior
The query should continue to select all columns in the source table and not raise an `ActiveModel:: MissingAttributeError ` error.

### Actual behavior
Using the relation immediately raises an `ActiveModel:: MissingAttributeError` error.

### System configuration
**Rails version**: 6.1.0
**Ruby version**: 2.7.2

Possibly related to #40743 ",https://api.github.com/repos/rails/rails/issues/40874/timeline,,macfanatic,162970,MDQ6VXNlcjE2Mjk3MA==,https://avatars.githubusercontent.com/u/162970?v=4,,https://api.github.com/users/macfanatic,https://github.com/macfanatic,https://api.github.com/users/macfanatic/followers,https://api.github.com/users/macfanatic/following{/other_user},https://api.github.com/users/macfanatic/gists{/gist_id},https://api.github.com/users/macfanatic/starred{/owner}{/repo},https://api.github.com/users/macfanatic/subscriptions,https://api.github.com/users/macfanatic/orgs,https://api.github.com/users/macfanatic/repos,https://api.github.com/users/macfanatic/events{/privacy},https://api.github.com/users/macfanatic/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40874/reactions,1,1,0,0,0,0,0,0,0,,,,,,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/milestones/79,https://github.com/rails/rails/milestone/79,https://api.github.com/repos/rails/rails/milestones/79/labels,6599195.0,MDk6TWlsZXN0b25lNjU5OTE5NQ==,79.0,6.1.4,,georgeclaghorn,94129.0,MDQ6VXNlcjk0MTI5,https://avatars.githubusercontent.com/u/94129?v=4,,https://api.github.com/users/georgeclaghorn,https://github.com/georgeclaghorn,https://api.github.com/users/georgeclaghorn/followers,https://api.github.com/users/georgeclaghorn/following{/other_user},https://api.github.com/users/georgeclaghorn/gists{/gist_id},https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo},https://api.github.com/users/georgeclaghorn/subscriptions,https://api.github.com/users/georgeclaghorn/orgs,https://api.github.com/users/georgeclaghorn/repos,https://api.github.com/users/georgeclaghorn/events{/privacy},https://api.github.com/users/georgeclaghorn/received_events,User,False,3.0,6.0,open,2021-03-27T12:10:57Z,2021-10-22T16:25:06Z,,
396,https://api.github.com/repos/rails/rails/issues/40829,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40829/labels{/name},https://api.github.com/repos/rails/rails/issues/40829/comments,https://api.github.com/repos/rails/rails/issues/40829/events,https://github.com/rails/rails/issues/40829,765938493,MDU6SXNzdWU3NjU5Mzg0OTM=,40829,ActionText::RichText attempts to render attachments when creating a new object,"[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,4,2020-12-14T05:46:03Z,2021-04-30T13:55:28Z,,NONE,,"A feature of my application is automatic translation of user generated content, which is captured using ActionText's rich text fields. In order to achieve this, we essentially take the raw body of the `ActionText::RichText`, run it through a translation service, and then assign that content to a new object.

One (intentional) side effect of this is that any attachments are now shared across the rich text objects. After looking through rails source code, it looks like the `ActionText::Content` renders the content to html before storing it in the database.

https://github.com/rails/rails/commit/614e813161ad8f6e13ad19aedd577acdd976d9d6#diff-2845a2dd736db0371741dbae62c17e7fd997c7df8e66596020cff068f456854aL91
This particular commit has changed the renderer, which shouldn't cause an issue, except for the fact that I have a custom view for `active_storage/blobs/_blob`, which includes custom helpers. Since the renderer is not part of application controller anymore, I get an error when saving these objects.

This issue doesn't occur when creating/editing objects from the browser, only when copying these objects from within by background jobs.

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->
Create a custom blob.html:
```erb
<%# views/active_storage/blobs/_blob.html.erb %>
<figure class=""attachment attachment--<%= blob.representable? ? ""preview"" : ""file"" %> attachment--<%= blob.filename.extension %>"">
  <%= custom_image_helper(blob) %>
</figure>
```

Create document classes:
```ruby
class Document < ApplicationRecord
  has_rich_text :content
end
class DocumentTranslation
  belongs_to :document
  has_rich_text :content
end
```

Attempt to copy the rich text object in a background job:
```ruby
class DocumentTranlateJob < ApplicationJob
  def perform document
    translation = DocumentTranslation.find_or_initialize_by(document: document, language: 'es')
    translation.content = TranslationService.translate(document.content)
    translation.save!
  end
end
```

You can also replicate this in a rails console:
```ruby
blob = ActiveStorage::Blob.create_and_upload!(io: File.open('path/to/a/file'), filename: 'filename')
attachment = ActionText::Attachment.from_attachable(blob)
document = Document.create!(content: ""<div>Sample content with attachment</div><div>#{attachment.to_html}</div>"")
```

### Expected behavior
<!-- Tell us what should happen -->
Making inserts or edits to rich text content should not attempt to render attachments.

### Actual behavior
<!-- Tell us what happens instead -->
Making inserts or edits to rich text content attempts to render attachments which causes my custom blob view to fail.

### System configuration
**Rails version**: 6.1.0

**Ruby version**: 2.7.1
",https://api.github.com/repos/rails/rails/issues/40829/timeline,,adamdebono,1049190,MDQ6VXNlcjEwNDkxOTA=,https://avatars.githubusercontent.com/u/1049190?v=4,,https://api.github.com/users/adamdebono,https://github.com/adamdebono,https://api.github.com/users/adamdebono/followers,https://api.github.com/users/adamdebono/following{/other_user},https://api.github.com/users/adamdebono/gists{/gist_id},https://api.github.com/users/adamdebono/starred{/owner}{/repo},https://api.github.com/users/adamdebono/subscriptions,https://api.github.com/users/adamdebono/orgs,https://api.github.com/users/adamdebono/repos,https://api.github.com/users/adamdebono/events{/privacy},https://api.github.com/users/adamdebono/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40829/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
397,https://api.github.com/repos/rails/rails/issues/40827,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40827/labels{/name},https://api.github.com/repos/rails/rails/issues/40827/comments,https://api.github.com/repos/rails/rails/issues/40827/events,https://github.com/rails/rails/issues/40827,765589209,MDU6SXNzdWU3NjU1ODkyMDk=,40827,Activestorage duplicating blobs when .attach is called,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,7,2020-12-13T18:40:41Z,2021-06-11T23:13:36Z,,NONE,,"### Steps to reproduce
1. Initialize an activerecord object that has say `has_many_attached :files` relationship. Ensure to set the files attribute with a ActionDispatch::Http::UploadedFile object.
2. Then call `.attach` on `files` with an activestorage blob object.

### Expected behavior
I should have two blobs waiting to be attached/persisted. One from each step.

### Actual behavior
I have 3 blobs waiting to be attached. 

From looking at the code, it seems `.attach` appends any existing blobs to the new attachables and then it calls the `files` setter method which itself appends any existing blobs to the ""new attachables"" from `.attach` . See code references below.

https://github.com/rails/rails/blob/95d4c50eb5d35c036a1a52fc66c81d11a84ddd37/activestorage/lib/active_storage/attached/many.rb#L35
https://github.com/rails/rails/blob/95d4c50eb5d35c036a1a52fc66c81d11a84ddd37/activestorage/lib/active_storage/attached/model.rb#L149

As a side note, if you use the setter method directly on step 2 to set the activestorage blob, then you get 2 blobs waiting to be attached. The issue only occurs when `.attach` is used. You could also just replace step 1 with a .attach call. You get the same results.

### System configuration
**Rails version**: 6.1.0.rc2

**Ruby version**: 2.7.1

Thanks for the hard work by the Rails team!
",https://api.github.com/repos/rails/rails/issues/40827/timeline,,muyiwaoyeniyi,1622600,MDQ6VXNlcjE2MjI2MDA=,https://avatars.githubusercontent.com/u/1622600?v=4,,https://api.github.com/users/muyiwaoyeniyi,https://github.com/muyiwaoyeniyi,https://api.github.com/users/muyiwaoyeniyi/followers,https://api.github.com/users/muyiwaoyeniyi/following{/other_user},https://api.github.com/users/muyiwaoyeniyi/gists{/gist_id},https://api.github.com/users/muyiwaoyeniyi/starred{/owner}{/repo},https://api.github.com/users/muyiwaoyeniyi/subscriptions,https://api.github.com/users/muyiwaoyeniyi/orgs,https://api.github.com/users/muyiwaoyeniyi/repos,https://api.github.com/users/muyiwaoyeniyi/events{/privacy},https://api.github.com/users/muyiwaoyeniyi/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40827/reactions,3,3,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
398,https://api.github.com/repos/rails/rails/issues/40778,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40778/labels{/name},https://api.github.com/repos/rails/rails/issues/40778/comments,https://api.github.com/repos/rails/rails/issues/40778/events,https://github.com/rails/rails/pull/40778,760772510,MDExOlB1bGxSZXF1ZXN0NTM1NTQ4NjM0,40778,Credentials edit with config paths,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}]",open,False,,[],,5,2020-12-10T00:16:15Z,2022-03-18T22:48:25Z,,NONE,,"I'm resubmitting this because the [original](https://github.com/rails/rails/pull/38966) was closed by the rails-bot for staleness. I'm awaiting review by someone on the Rails team.

### Summary
Fixes #37631

Documentation ([here](https://github.com/rails/rails/blob/8544c9c23687964ab754c06a7745215a5369a4e0/railties/lib/rails/commands/credentials/USAGE#L72-L73) and [here](https://github.com/rails/rails/blame/8544c9c23687964ab754c06a7745215a5369a4e0/guides/source/configuring.md#L144-L146)) states that the credentials content and key paths are configurable via `config.credentials.content_path` and `config.credentials.key_path`. While these config variables appear to be respected by the web application, they are not used by the `credentials:edit` or `credentials:show` commands.

#### Current behavior:
* credentials commands with no environment specified use 
  * `config/master.key` and `config/credentials.yml.enc`
* credentials commands with an environment option use 
  * `config/credentials/$environment.key` and `config/credentials/$environmnet.yml.enc`

#### This pull request aims to implement the following behavior:
* credentials commands with no environment specified use 
  * `key_path` and `content_path` configured in config/application.rb
  * `config/master.key` and `config/credentials.yml.enc`
* credentials commands with an environment option use 
  * `key_path` and `content_path` configured in config/environments/$environment.rb
  * `key_path` and `content_path` configured in config/application.rb
  * `config/credentials/$environment.key` and `config/credentials/$environmnet.yml.enc`",https://api.github.com/repos/rails/rails/issues/40778/timeline,,brianthoman,57139027,MDQ6VXNlcjU3MTM5MDI3,https://avatars.githubusercontent.com/u/57139027?v=4,,https://api.github.com/users/brianthoman,https://github.com/brianthoman,https://api.github.com/users/brianthoman/followers,https://api.github.com/users/brianthoman/following{/other_user},https://api.github.com/users/brianthoman/gists{/gist_id},https://api.github.com/users/brianthoman/starred{/owner}{/repo},https://api.github.com/users/brianthoman/subscriptions,https://api.github.com/users/brianthoman/orgs,https://api.github.com/users/brianthoman/repos,https://api.github.com/users/brianthoman/events{/privacy},https://api.github.com/users/brianthoman/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40778/reactions,6,6,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/40778,https://github.com/rails/rails/pull/40778,https://github.com/rails/rails/pull/40778.diff,https://github.com/rails/rails/pull/40778.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
399,https://api.github.com/repos/rails/rails/issues/40642,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40642/labels{/name},https://api.github.com/repos/rails/rails/issues/40642/comments,https://api.github.com/repos/rails/rails/issues/40642/events,https://github.com/rails/rails/issues/40642,745554501,MDU6SXNzdWU3NDU1NTQ1MDE=,40642,LenthValidator breaks if nil value has a minimum length with a proc.,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,7,2020-11-18T10:55:22Z,2021-02-17T19:47:04Z,,NONE,,"### Steps to reproduce
```ruby
require 'active_model'

class Foo
  include ActiveModel::Validations

  validates :bar, length: { minimum: ->(record) { record.one + 2 } }

  def one
    1
  end

  def bar
    nil
  end
end
f = Foo.new
f.valid? #=> same error as next line in 6.0, false as expected in 6.1
f.errors.messages #=> NoMethodError (undefined method `one' for #<Hash:0x00007fac793a2280>)
```

### Expected behavior
```ruby
{:bar=>[""is too short (minimum is 3 characters)""]} 
```

### Actual behavior
```
NoMethodError (undefined method `one' for #<Hash:0x00007fac793a2280>)
```

### System configuration
**Rails version**: both 6.0.3 and master

**Ruby version**: 2.5.3

### Notes
There is code to support procs in `LengthValidator` but it's not called if value is `nil` and key is `:minimum`, it works as expected if value is empty string or key is `:maximum` instead.

It breaks on `.valid?` in 6.0 since messages are generated immediately, breaks later on master since message generation happens later.

The proc is not called in the validator in this specific case and the proc is passed onto message generation. That's why it's called with some _random_ hash instead of the expected record.",https://api.github.com/repos/rails/rails/issues/40642/timeline,,sliiser,6681358,MDQ6VXNlcjY2ODEzNTg=,https://avatars.githubusercontent.com/u/6681358?v=4,,https://api.github.com/users/sliiser,https://github.com/sliiser,https://api.github.com/users/sliiser/followers,https://api.github.com/users/sliiser/following{/other_user},https://api.github.com/users/sliiser/gists{/gist_id},https://api.github.com/users/sliiser/starred{/owner}{/repo},https://api.github.com/users/sliiser/subscriptions,https://api.github.com/users/sliiser/orgs,https://api.github.com/users/sliiser/repos,https://api.github.com/users/sliiser/events{/privacy},https://api.github.com/users/sliiser/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40642/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
400,https://api.github.com/repos/rails/rails/issues/40401,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40401/labels{/name},https://api.github.com/repos/rails/rails/issues/40401/comments,https://api.github.com/repos/rails/rails/issues/40401/events,https://github.com/rails/rails/pull/40401,723377480,MDExOlB1bGxSZXF1ZXN0NTA0OTczNTA5,40401,Add `prepend_order` as a new query method to prepend the specified order onto any existing order,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,20,2020-10-16T16:51:21Z,2022-04-20T18:21:21Z,,CONTRIBUTOR,,"### Summary

I recently ran into a situation where it would've been great to *prepend* a new `ORDER BY` clause to a query. In our case, it was when using a `scope` that itself had something to the effect of:

```ruby
class Profile < ApplicationRecord
  belongs_to :user

  scope :recently_updated, -> { where(arel_table[:updated_at].gteq(7.days.ago)).order(updated_at: :desc) }
end

class User < ApplicationRecord
  has_one :profile

  scope :recently_updated, -> { joins(:profile).merge(Profile.recently_updated) }
end
```

We wanted to use `User.recently_updated`, but needed to put a specific group of users at the top of the list. The only way to do that without something like `prepend_order` would be to reimplement the `recently_updated` scopes defined on the model.

With `prepend_order`, we can simply call `User.recently_updated.prepend_order('...')`, and we're done!

Another way we could use this would be in conjunction with [`ActiveRecord::FinderMethods#ordered_relation`](https://github.com/rails/rails/blob/d83ee61dc6b5e73dd2853c5af9681e71c0150e30/activerecord/lib/active_record/relation/finder_methods.rb#L578-L588):

```ruby
class CustomerLegalEntity < ApplicationRecord
  scope :ordered, -> { ordered_relation.prepend_order(default: :desc) }
end
```",https://api.github.com/repos/rails/rails/issues/40401/timeline,,agrobbin,46724,MDQ6VXNlcjQ2NzI0,https://avatars.githubusercontent.com/u/46724?v=4,,https://api.github.com/users/agrobbin,https://github.com/agrobbin,https://api.github.com/users/agrobbin/followers,https://api.github.com/users/agrobbin/following{/other_user},https://api.github.com/users/agrobbin/gists{/gist_id},https://api.github.com/users/agrobbin/starred{/owner}{/repo},https://api.github.com/users/agrobbin/subscriptions,https://api.github.com/users/agrobbin/orgs,https://api.github.com/users/agrobbin/repos,https://api.github.com/users/agrobbin/events{/privacy},https://api.github.com/users/agrobbin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40401/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/40401,https://github.com/rails/rails/pull/40401,https://github.com/rails/rails/pull/40401.diff,https://github.com/rails/rails/pull/40401.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
401,https://api.github.com/repos/rails/rails/issues/40337,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40337/labels{/name},https://api.github.com/repos/rails/rails/issues/40337/comments,https://api.github.com/repos/rails/rails/issues/40337/events,https://github.com/rails/rails/pull/40337,715065036,MDExOlB1bGxSZXF1ZXN0NDk4MDM2ODU5,40337,Add concurrency to ActiveJob,"[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}]",,24,2020-10-05T18:27:44Z,2021-09-08T19:51:12Z,,NONE,,"### Summary

At Shopify, we have been using different flavours of concurrency within `ActiveJob` for several years. 
This year we have consolidated all of this functionality into one API method called `concurrency`. 
After validating that this works for the scale of Shopify we decided to port the API upstream.

There have been others attempt to add locking to `ActiveJob` https://github.com/rails/rails/pull/33728

While that functionality has nothing wrong, we have identified that locking is not enough as a concurrency primitive.

At Shopify, we allow developers to specify multiple concurrency options for there jobs:

In all examples below, `keys` is the array of keys that will help build a unique concurrency key from the job arguments.

- `EndToEnd` where a job holds a concurrency ticket from the moment gets enqueue until the job is performed. When any jobs that try to enter the queue, we check if the concurrent limit is reached, and if it is, we drop the job.
`concurrency(limit: 1, keys: ['checkout_id'])`

```ruby
class PaymentProcessingJob < ActiveJob
  # We only allow one job to be in the queue and processing at all times.
  # If a job tries to enter the queue while another job with the same checkout_id
  # is in the queue or performing, we drop the new job.

  # Do not want to charge the same checkout twice :)
  concurrency(limit: 1, keys: ['checkout_id'])

  def perform(params)
    # Logic
  end
end
```

- `EnqueueLimit` where a job holds a concurrency ticket from the moment gets enqueue until the jobs get dequeued. When any jobs that try to enter the queue, we check if the concurrent limit is reached and if it is, we drop the job.
`concurrency(limit: { enqueue: 1 }, keys: ['checkout_id'])`

- `PerformLimit` where a job holds a concurrency ticket from the moment gets dequeued until the jobs get performed. At the time of the dequeue, we check if the concurrency limit is reached and if so we put that job back into the Delayed queue
`concurrency(limit: { performed: 1 }, keys: ['checkout_id'])`

```ruby
class UpdateThemeSettingsReferencesJob < ActiveJob
  # We only allow one job to perform at any moment. 
  # This is often used as a form of throttling for expensive operations.
  # When a job from the head of the queue tries to start performing while another job 
  # with the same key is already performing, we re-enqueue the new job with a delay.
  concurrency(
    limit: { perform: 1 },
    keys: ['shop_id', 'model', 'model_id']
  )

  def perform(params)
    # Logic 
  end
end
```

- `BoundedStages` is the combination of `EnqueueLimit` and `PerformLimit`
`concurrency(limit: { enqueue: 1, perform:1  }, keys: ['checkout_id'])`

```ruby
class ExpensiveIdempotentSyncJob < ActiveJob
  # This job syncs the data of this shop with an external service.
  # Since it is expensive, we want only one sync running at a time for each shop.
  # We need to enqueue this job whenever something changes that requires syncing.
  # However, if there is already an ExpensiveSyncJob in the queue, that job will sync all the changes made
  # before it starts running, so there is no need to enqueue duplicates.
  concurrency(limit: { enqueue: 1, perform: 1 }, keys: ['shop_id'])

  def perform(params)
    # Logic 
  end
end
```

**`ActiveJob` only care about the concurrency at the `enqueue` (EndToEnd and EnqueueLimit) steps for the `perform` cases (PerformLimit and BoundedStages) is up to the job adapters to implement it internally. So the adapters can decide to add the functionality or not 😄**

### Other Information

The `timeout` option allows specifying for how long a job can hold a concurrency ticket.

At Shopify, we allow other API options like `perform_delay` which configures the delay in which the job is placed back in the delayed queue when the `PerformLimit` is reached.

Here is an example of the API in use in one of our jobs:

```
concurrency(limit: { perform: 8, perform_delay: 300 }, keys: ['task_name'])
```",https://api.github.com/repos/rails/rails/issues/40337/timeline,,GustavoCaso,4672858,MDQ6VXNlcjQ2NzI4NTg=,https://avatars.githubusercontent.com/u/4672858?v=4,,https://api.github.com/users/GustavoCaso,https://github.com/GustavoCaso,https://api.github.com/users/GustavoCaso/followers,https://api.github.com/users/GustavoCaso/following{/other_user},https://api.github.com/users/GustavoCaso/gists{/gist_id},https://api.github.com/users/GustavoCaso/starred{/owner}{/repo},https://api.github.com/users/GustavoCaso/subscriptions,https://api.github.com/users/GustavoCaso/orgs,https://api.github.com/users/GustavoCaso/repos,https://api.github.com/users/GustavoCaso/events{/privacy},https://api.github.com/users/GustavoCaso/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40337/reactions,11,0,0,0,0,0,4,0,7,False,https://api.github.com/repos/rails/rails/pulls/40337,https://github.com/rails/rails/pull/40337,https://github.com/rails/rails/pull/40337.diff,https://github.com/rails/rails/pull/40337.patch,,rafaelfranca,47848.0,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
402,https://api.github.com/repos/rails/rails/issues/40230,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40230/labels{/name},https://api.github.com/repos/rails/rails/issues/40230/comments,https://api.github.com/repos/rails/rails/issues/40230/events,https://github.com/rails/rails/issues/40230,702217507,MDU6SXNzdWU3MDIyMTc1MDc=,40230,HostAuthorization: confusing error message when using multiple hostnames,[],open,False,,[],,12,2020-09-15T19:58:57Z,2022-03-14T08:31:36Z,,NONE,,"### Steps to reproduce
Calling the application with different values for `HTTP_HOST` and `HTTP_X_FORWARDED_HOST` while HostAuthorization is enabled (i.e. `config.hosts` is set/active) while at least HTTP_HOST is **not** present in `config.hosts`.

### Expected behavior
Error message that displays the user that both hostnames are checked and need to be added to `config.hosts`.

Example:
```
Blocked hosts: HTTP_HOST, HTTP_X_FORWARDED_HOST
---------------------------------------------------------------------------------------------
To allow requests to HTTP_HOST, HTTP_X_FORWARDED_HOST, add the following to your environment configuration:
config.hosts << ""HTTP_HOST""
config.hosts << ""HTTP_X_FORWARDED_HOST""
```

### Actual behavior
Output
```
Blocked host: HTTP_X_FORWARDED_HOST
---------------------------------------------------------------------------------------------
To allow requests to HTTP_X_FORWARDED_HOST, add the following to your environment configuration:
config.hosts << ""HTTP_X_FORWARDED_HOST""
```

If you then add `HTTP_X_FORWARDED_HOST` to `config.hosts` the error message is still displayed (unchanged) if HTTP_HOST is missing.

### System configuration
**Rails version**: 6.0.3.3 (should be present since introduction of HostAuthorization in v6.0.0.beta1)

**Ruby version**: any

I created a commit that changes / fixes that behavior ([See here](https://github.com/Eusebius1920/rails/commit/c63f7b07fd47651708bd4ce4ca8dd6106537d68f)) in a forked repository. I can create a pull request if needed / wanted.



**Edit**: Fixed wrong header name in issue description
",https://api.github.com/repos/rails/rails/issues/40230/timeline,,Eusebius1920,8429638,MDQ6VXNlcjg0Mjk2Mzg=,https://avatars.githubusercontent.com/u/8429638?v=4,,https://api.github.com/users/Eusebius1920,https://github.com/Eusebius1920,https://api.github.com/users/Eusebius1920/followers,https://api.github.com/users/Eusebius1920/following{/other_user},https://api.github.com/users/Eusebius1920/gists{/gist_id},https://api.github.com/users/Eusebius1920/starred{/owner}{/repo},https://api.github.com/users/Eusebius1920/subscriptions,https://api.github.com/users/Eusebius1920/orgs,https://api.github.com/users/Eusebius1920/repos,https://api.github.com/users/Eusebius1920/events{/privacy},https://api.github.com/users/Eusebius1920/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40230/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
403,https://api.github.com/repos/rails/rails/issues/40224,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40224/labels{/name},https://api.github.com/repos/rails/rails/issues/40224/comments,https://api.github.com/repos/rails/rails/issues/40224/events,https://github.com/rails/rails/pull/40224,700465388,MDExOlB1bGxSZXF1ZXN0NDg2MTAwNzU3,40224,Add support for exclusion constraints (PostgreSQL-only),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,13,2020-09-13T02:47:18Z,2022-03-06T18:14:20Z,,CONTRIBUTOR,,"### Summary

Similar to #31323, this extends Active Record's migration/schema dumping to support [exclusion constraints](https://www.postgresql.org/docs/12/sql-createtable.html#SQL-CREATETABLE-EXCLUDE)!

```ruby
add_exclusion_constraint :invoices, ""daterange(start_date, end_date) WITH &&"", using: :gist, name: ""invoices_date_overlap""
remove_exclusion_constraint :invoices, name: ""invoices_date_overlap""
```

Hopefully the approach is reasonable, but definitely let me know if there is anything that looks out of whack.",https://api.github.com/repos/rails/rails/issues/40224/timeline,,agrobbin,46724,MDQ6VXNlcjQ2NzI0,https://avatars.githubusercontent.com/u/46724?v=4,,https://api.github.com/users/agrobbin,https://github.com/agrobbin,https://api.github.com/users/agrobbin/followers,https://api.github.com/users/agrobbin/following{/other_user},https://api.github.com/users/agrobbin/gists{/gist_id},https://api.github.com/users/agrobbin/starred{/owner}{/repo},https://api.github.com/users/agrobbin/subscriptions,https://api.github.com/users/agrobbin/orgs,https://api.github.com/users/agrobbin/repos,https://api.github.com/users/agrobbin/events{/privacy},https://api.github.com/users/agrobbin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40224/reactions,9,8,0,0,1,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/40224,https://github.com/rails/rails/pull/40224,https://github.com/rails/rails/pull/40224.diff,https://github.com/rails/rails/pull/40224.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
404,https://api.github.com/repos/rails/rails/issues/40217,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40217/labels{/name},https://api.github.com/repos/rails/rails/issues/40217/comments,https://api.github.com/repos/rails/rails/issues/40217/events,https://github.com/rails/rails/pull/40217,699261912,MDExOlB1bGxSZXF1ZXN0NDg1MDIyOTAy,40217,Fix broken TLD parsing for cookie store,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}]",open,False,,[],,12,2020-09-11T12:33:12Z,2022-03-16T12:14:08Z,,CONTRIBUTOR,,"### Summary

See #40200 for details. Currently contains a broken test case demonstrating the problem.

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/40217/timeline,,kevinsjoberg,503025,MDQ6VXNlcjUwMzAyNQ==,https://avatars.githubusercontent.com/u/503025?v=4,,https://api.github.com/users/kevinsjoberg,https://github.com/kevinsjoberg,https://api.github.com/users/kevinsjoberg/followers,https://api.github.com/users/kevinsjoberg/following{/other_user},https://api.github.com/users/kevinsjoberg/gists{/gist_id},https://api.github.com/users/kevinsjoberg/starred{/owner}{/repo},https://api.github.com/users/kevinsjoberg/subscriptions,https://api.github.com/users/kevinsjoberg/orgs,https://api.github.com/users/kevinsjoberg/repos,https://api.github.com/users/kevinsjoberg/events{/privacy},https://api.github.com/users/kevinsjoberg/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40217/reactions,0,0,0,0,0,0,0,0,0,True,https://api.github.com/repos/rails/rails/pulls/40217,https://github.com/rails/rails/pull/40217,https://github.com/rails/rails/pull/40217.diff,https://github.com/rails/rails/pull/40217.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
405,https://api.github.com/repos/rails/rails/issues/40200,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40200/labels{/name},https://api.github.com/repos/rails/rails/issues/40200/comments,https://api.github.com/repos/rails/rails/issues/40200/events,https://github.com/rails/rails/issues/40200,695669585,MDU6SXNzdWU2OTU2Njk1ODU=,40200,"Cookie store configured with domain all, fail for 3-letter domains with a 2-letter TLD","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,10,2020-09-08T08:29:50Z,2021-06-16T11:30:27Z,,CONTRIBUTOR,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

### Expected behavior

When the cookie store has been configured using `domain: :all`, the cookie domain for `whatever.abc.se` should resolve to `.abc.se`.

### Actual behavior

it resolves to `.whatever.abc.se`. This is due to the following regexp

https://github.com/rails/rails/blob/7af59e16a255da5aee2863af0eefaa9f0cfd857d/actionpack/lib/action_dispatch/middleware/cookies.rb#L298

and to the fact that the regexp also handle TLDs such as `com.au` or `co.uk`.

https://github.com/rails/rails/blob/7af59e16a255da5aee2863af0eefaa9f0cfd857d/actionpack/lib/action_dispatch/middleware/cookies.rb#L287-L288

A quick fix would be to set the `tld_length` option to `2` which causes the resolution to proceed as expected, but at the same time I'd expect the default case to either ""just work"" or otherwise make the configuration explicit.

As it stands right now, Rails is making arbitrary assumptions, and if those assumptions happen to be invalid, it resolves the domain incorrectly without the user even knowing.

### System configuration

**Rails version**: 4.2 (should be present in Rails 6 as well)

**Ruby version**: 2.7
",https://api.github.com/repos/rails/rails/issues/40200/timeline,,kevinsjoberg,503025,MDQ6VXNlcjUwMzAyNQ==,https://avatars.githubusercontent.com/u/503025?v=4,,https://api.github.com/users/kevinsjoberg,https://github.com/kevinsjoberg,https://api.github.com/users/kevinsjoberg/followers,https://api.github.com/users/kevinsjoberg/following{/other_user},https://api.github.com/users/kevinsjoberg/gists{/gist_id},https://api.github.com/users/kevinsjoberg/starred{/owner}{/repo},https://api.github.com/users/kevinsjoberg/subscriptions,https://api.github.com/users/kevinsjoberg/orgs,https://api.github.com/users/kevinsjoberg/repos,https://api.github.com/users/kevinsjoberg/events{/privacy},https://api.github.com/users/kevinsjoberg/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40200/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
406,https://api.github.com/repos/rails/rails/issues/40058,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40058/labels{/name},https://api.github.com/repos/rails/rails/issues/40058/comments,https://api.github.com/repos/rails/rails/issues/40058/events,https://github.com/rails/rails/pull/40058,679770665,MDExOlB1bGxSZXF1ZXN0NDY4NDU2NDU1,40058,Add db_runtime to Active Job instrumentation,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,6,2020-08-16T15:07:43Z,2022-04-20T22:18:50Z,,MEMBER,,"This adds `db_runtime` to the notification payload of a `""perform.active_job""` event.  `db_runtime` tracks the total time taken by database queries while performing a job, which helps in understanding how a job's time is spent.  This is similar to what is done for controller actions in `ActiveRecord::Railties::ControllerRuntime`.

Closes #35354.

---

/cc @gwincr11  I added you as a co-author since you began investigating this in #35354.
/cc @jeremy  Since you expressed interest in this in https://github.com/rails/rails/pull/35354#issuecomment-607347998.
",https://api.github.com/repos/rails/rails/issues/40058/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40058/reactions,1,0,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/40058,https://github.com/rails/rails/pull/40058,https://github.com/rails/rails/pull/40058.diff,https://github.com/rails/rails/pull/40058.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
407,https://api.github.com/repos/rails/rails/issues/40051,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/40051/labels{/name},https://api.github.com/repos/rails/rails/issues/40051/comments,https://api.github.com/repos/rails/rails/issues/40051/events,https://github.com/rails/rails/pull/40051,679374493,MDExOlB1bGxSZXF1ZXN0NDY4MTYwNzQy,40051,Add HTTP_REFERER when following redirects on integration tests,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,[],,8,2020-08-14T20:01:28Z,2022-03-06T23:25:03Z,,CONTRIBUTOR,,"### Summary

This changes `follow_redirect!` to set `HTTP_REFERER` on the next request, unless it was set in the `**args`.

### Other Information

This makes a closer simulation of what happens in a real browser session
",https://api.github.com/repos/rails/rails/issues/40051/timeline,,fsateler,1322013,MDQ6VXNlcjEzMjIwMTM=,https://avatars.githubusercontent.com/u/1322013?v=4,,https://api.github.com/users/fsateler,https://github.com/fsateler,https://api.github.com/users/fsateler/followers,https://api.github.com/users/fsateler/following{/other_user},https://api.github.com/users/fsateler/gists{/gist_id},https://api.github.com/users/fsateler/starred{/owner}{/repo},https://api.github.com/users/fsateler/subscriptions,https://api.github.com/users/fsateler/orgs,https://api.github.com/users/fsateler/repos,https://api.github.com/users/fsateler/events{/privacy},https://api.github.com/users/fsateler/received_events,User,False,https://api.github.com/repos/rails/rails/issues/40051/reactions,1,0,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/40051,https://github.com/rails/rails/pull/40051,https://github.com/rails/rails/pull/40051.diff,https://github.com/rails/rails/pull/40051.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
408,https://api.github.com/repos/rails/rails/issues/39968,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39968/labels{/name},https://api.github.com/repos/rails/rails/issues/39968/comments,https://api.github.com/repos/rails/rails/issues/39968/events,https://github.com/rails/rails/pull/39968,670939323,MDExOlB1bGxSZXF1ZXN0NDYxMTc3MTQw,39968,Implement returning for postgresql,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,38,2020-08-01T14:58:01Z,2022-03-15T00:36:27Z,,NONE,,"### Summary

This is an attempt to implement #34237

It adds a class method that will receive the attributes that should be returned on record creation or update because they are calculated inside postgresql.


### Steps to reproduce
 
**1. Create a model**
 
```Ruby
class Order < ApplicationRecord
end
```
 
**2. Create a migration with a DB function as `default`.**
 
```Ruby
class CreateOrders < ActiveRecord::Migration[5.2]
  def change
    create_table :orders do |t|
      t.string :uuid, default: -> { ""gen_random_uuid()"" }
      t.references :user
      t.references :product
      t.text :comment
 
      t.timestamps
    end
  end
end
```
 
`rails db:migrate`
 
**3. Create a new order**
 
`rails console`
 
```
order = Order.create(user_id: 1, product_id: 1)
```
 
### Desired behavior
I would like `create` to set `uuid` (by the postgres default) **and** for it to set the new `uuid` value into the `order` AR instance, as it does with the `id`.
 
```
> order
# =>
# +----+--------------------------------------+---------+------------+---------+----------------+----------------+
# | id | uuid                                 | user_id | product_id | comment | created_at     | updated_at     |
# +----+--------------------------------------+---------+------------+---------+----------------+----------------+
# | 1  | bec94fe0-f7c3-4ede-8b25-c4bce702ec00 | 1       | 1          |         | 2018-10-17 ... | 2018-10-17 ... |
# +----+--------------------------------------+---------+------------+---------+----------------+----------------+
```
 
### Actual behavior
The `uuid` does get set in the db, but it is not returned into the `order` instance.",https://api.github.com/repos/rails/rails/issues/39968/timeline,,00dav00,9206778,MDQ6VXNlcjkyMDY3Nzg=,https://avatars.githubusercontent.com/u/9206778?v=4,,https://api.github.com/users/00dav00,https://github.com/00dav00,https://api.github.com/users/00dav00/followers,https://api.github.com/users/00dav00/following{/other_user},https://api.github.com/users/00dav00/gists{/gist_id},https://api.github.com/users/00dav00/starred{/owner}{/repo},https://api.github.com/users/00dav00/subscriptions,https://api.github.com/users/00dav00/orgs,https://api.github.com/users/00dav00/repos,https://api.github.com/users/00dav00/events{/privacy},https://api.github.com/users/00dav00/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39968/reactions,26,25,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/39968,https://github.com/rails/rails/pull/39968,https://github.com/rails/rails/pull/39968.diff,https://github.com/rails/rails/pull/39968.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
409,https://api.github.com/repos/rails/rails/issues/39863,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39863/labels{/name},https://api.github.com/repos/rails/rails/issues/39863/comments,https://api.github.com/repos/rails/rails/issues/39863/events,https://github.com/rails/rails/pull/39863,659298581,MDExOlB1bGxSZXF1ZXN0NDUxMTYwMjMy,39863,"Support `where` with comparison operators (`>`, `>=`, `<`, and `<=`) Take 2","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,14,2020-07-17T14:24:10Z,2022-03-03T22:53:01Z,,MEMBER,,"Revert ""Revert ""Merge pull request #39613 from kamipo/where_with_custom_operator""""

This reverts commit da022915d9a5ca29a11ea150f6d87fcedcff9b86.

```ruby
posts = Post.order(:id)

posts.where(""id >"": 9).pluck(:id)  # => [10, 11]
posts.where(""id >="": 9).pluck(:id) # => [9, 10, 11]
posts.where(""id <"": 3).pluck(:id)  # => [1, 2]
posts.where(""id <="": 3).pluck(:id) # => [1, 2, 3]
```

From type casting and table/column name resolution's point of view,
`where(""created_at >="": time)` is better alternative than `where(""created_at >= ?"", time)`.

```ruby
class Post < ActiveRecord::Base
  attribute :created_at, :datetime, precision: 3
end

time = Time.now.utc # => 2020-06-24 10:11:12.123456 UTC

Post.create!(created_at: time) # => #<Post id: 1, created_at: ""2020-06-24 10:11:12.123000"">

# SELECT `posts`.* FROM `posts` WHERE (created_at >= '2020-06-24 10:11:12.123456')
Post.where(""created_at >= ?"", time) # => []

# SELECT `posts`.* FROM `posts` WHERE `posts`.`created_at` >= '2020-06-24 10:11:12.123000'
Post.where(""created_at >="": time) # => [#<Post id: 1, created_at: ""2020-06-24 10:11:12.123000"">]
```

As a main contributor of the predicate builder area, I'd recommend to
people use the hash syntax, the hash syntax also have other useful
effects (making boundable queries, unscopeable queries, hash-like
relation merging friendly, automatic other table references detection).

* Making boundable queries

While working on #23461, I realized that Active Record doesn't generate
boundable queries perfectly, so I've been improving generated queries to
be boundable for a long time.

e.g.

#26117
7d5399379cb9ac2d3ffafa28fdc844d7b6c18ab8
#39219

Now, `where` with the hash syntax will generate boundable queries
perfectly.

I also want to generate boundable queries with a comparison operator in
a third party gem, but currently there is no other way than calling
`predicate_builder` directly.

https://github.com/kufu/activerecord-bitemporal/pull/62

* Unscopeable queries, Hash-like relation merging friendly

Unscopeable, and Hash-like merging friendly queries are relying on where
clause is an array of attr with value, and attr name is normalized as a
string (i.e. using `User.arel_table[:name]` is not preferable for
`unscope` and `merge`).

Example:

```ruby
id = User.arel_table[:id]

users = User.where(id.gt(1).and(id.lteq(10)))

# no-op due to `id.gt(1).and(id.lteq(10))` is not an attr with value
users.unscope(:id)
```

* Automatic other table references detection

It works only for the hash syntax.

ee7f66603573fd441f1522cc73ec0b7f56c4d1af
",https://api.github.com/repos/rails/rails/issues/39863/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39863/reactions,33,0,0,0,0,0,33,0,0,False,https://api.github.com/repos/rails/rails/pulls/39863,https://github.com/rails/rails/pull/39863,https://github.com/rails/rails/pull/39863.diff,https://github.com/rails/rails/pull/39863.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
410,https://api.github.com/repos/rails/rails/issues/39750,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39750/labels{/name},https://api.github.com/repos/rails/rails/issues/39750/comments,https://api.github.com/repos/rails/rails/issues/39750/events,https://github.com/rails/rails/pull/39750,647377601,MDExOlB1bGxSZXF1ZXN0NDQxNDE1MTQx,39750,Support pending migrations error for multiple databases.,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,8,2020-06-29T13:29:12Z,2021-12-06T22:38:09Z,,CONTRIBUTOR,,"### Summary

Resolves https://github.com/rails/rails/issues/37524

### Other Information

<!-- If there's anything else that's important and relevant to your pull
request, mention that information here. This could include
benchmarks, or other information.

If you are updating any of the CHANGELOG files or are asked to update the
CHANGELOG files by reviewers, please add the CHANGELOG entry at the top of the file.

Finally, if your pull request affects documentation or any non-code
changes, guidelines for those changes are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation)

Thanks for contributing to Rails! -->
",https://api.github.com/repos/rails/rails/issues/39750/timeline,,tgxworld,4335742,MDQ6VXNlcjQzMzU3NDI=,https://avatars.githubusercontent.com/u/4335742?v=4,,https://api.github.com/users/tgxworld,https://github.com/tgxworld,https://api.github.com/users/tgxworld/followers,https://api.github.com/users/tgxworld/following{/other_user},https://api.github.com/users/tgxworld/gists{/gist_id},https://api.github.com/users/tgxworld/starred{/owner}{/repo},https://api.github.com/users/tgxworld/subscriptions,https://api.github.com/users/tgxworld/orgs,https://api.github.com/users/tgxworld/repos,https://api.github.com/users/tgxworld/events{/privacy},https://api.github.com/users/tgxworld/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39750/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39750,https://github.com/rails/rails/pull/39750,https://github.com/rails/rails/pull/39750.diff,https://github.com/rails/rails/pull/39750.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
411,https://api.github.com/repos/rails/rails/issues/39714,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39714/labels{/name},https://api.github.com/repos/rails/rails/issues/39714/comments,https://api.github.com/repos/rails/rails/issues/39714/events,https://github.com/rails/rails/issues/39714,644780073,MDU6SXNzdWU2NDQ3ODAwNzM=,39714,after_commit for inner transaction has different object id,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2020-06-24T17:20:35Z,2020-07-07T04:49:49Z,,NONE,,"I have a model that has a queue structure that should be executed on `after_commit`. The model is saved within a nested transaction and the queue is not executing. I have discovered that the `after_commit` model has a different object_id from the one in the inner transaction. 

### Steps to reproduce
I created a reproducible test case:
Note: I have tried with both the inclusion and exclusion of `Company.transaction(requires_new: true)`
```
require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""6.0.3""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :companies, force: true do |t|
    t.string :name, null: false
  end
end

$actual_after_commit_call_objects = []

class Company < ActiveRecord::Base
  after_commit { $actual_after_commit_call_objects << object_id }
end

class BugTest < ActiveSupport::TestCase
  include ActiveRecord::TestFixtures

  self.use_transactional_tests = true

  def test_commit_callbacks_for_identical_ar_model
    expected_after_commit_call_objects = []
    Company.create(name:""S"")
    Company.transaction do
      Company.find(1).tap do |company| # object A
        expected_after_commit_call_objects << company.object_id
        company.name = ""A""
        company.save!
      end
      Company.transaction do
        Company.find(1).tap do |company| # object A
          expected_after_commit_call_objects << company.object_id
          company.name = ""B""
          company.save!
        end
      end
    end
    assert_equal expected_after_commit_call_objects, $actual_after_commit_call_objects
  end
end
```
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

### Expected behavior
Expected behavior is that the object id of from the inner transaction and `after_commit` callback should be the same
 
### Actual behavior
The outermost transaction has matching object id (note: they are not in the same position in the expected/actual) but the inner transaction has different object id.

```
--- expected
+++ actual
@@ -1 +1 @@
-[70320209145860, 70320209176540]
+[70320208918760, 70320209145860]
```

### System configuration
**Rails version**: 6.0.2.1
**Activerecord version**: ""6.0.3""
**Ruby version**:
ruby 2.6.3p62",https://api.github.com/repos/rails/rails/issues/39714/timeline,,SheldonNunes,12289606,MDQ6VXNlcjEyMjg5NjA2,https://avatars.githubusercontent.com/u/12289606?v=4,,https://api.github.com/users/SheldonNunes,https://github.com/SheldonNunes,https://api.github.com/users/SheldonNunes/followers,https://api.github.com/users/SheldonNunes/following{/other_user},https://api.github.com/users/SheldonNunes/gists{/gist_id},https://api.github.com/users/SheldonNunes/starred{/owner}{/repo},https://api.github.com/users/SheldonNunes/subscriptions,https://api.github.com/users/SheldonNunes/orgs,https://api.github.com/users/SheldonNunes/repos,https://api.github.com/users/SheldonNunes/events{/privacy},https://api.github.com/users/SheldonNunes/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39714/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
412,https://api.github.com/repos/rails/rails/issues/39686,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39686/labels{/name},https://api.github.com/repos/rails/rails/issues/39686/comments,https://api.github.com/repos/rails/rails/issues/39686/events,https://github.com/rails/rails/pull/39686,642497870,MDExOlB1bGxSZXF1ZXN0NDM3NDk3OTk1,39686,Enroll new apps in decrypted diffs of credentials,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}]",open,False,,[],,11,2020-06-21T05:20:29Z,2022-04-20T21:18:49Z,,MEMBER,,"Users, especially those who are creating an app for the first time, might not be aware of the `rails credentials:diff --enroll` command.  This commit enrolls new apps in decrypted diffs by default so that users benefit automatically.  This behavior can be opted out of with the `--skip-decrypted-diffs` flag.
",https://api.github.com/repos/rails/rails/issues/39686/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39686/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39686,https://github.com/rails/rails/pull/39686,https://github.com/rails/rails/pull/39686.diff,https://github.com/rails/rails/pull/39686.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
413,https://api.github.com/repos/rails/rails/issues/39585,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39585/labels{/name},https://api.github.com/repos/rails/rails/issues/39585/comments,https://api.github.com/repos/rails/rails/issues/39585/events,https://github.com/rails/rails/pull/39585,635931936,MDExOlB1bGxSZXF1ZXN0NDMyMjA0OTcw,39585,ActiveRecord PostgreSQL adapter: escape range bound values during serialization,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,8,2020-06-10T05:08:19Z,2022-04-15T03:55:15Z,,CONTRIBUTOR,,"## Summary

When formatting the bound values of range types, PostgreSQL quotes the value using double-quotes in certain conditions: if its formatted representation contains parentheses, commas, double quotes, backslashes or whitespace (manual section 8.17.5, 8.16.6). When parsing input, it requires escaping in nearly the same conditions: with the exception of whitespace.

As of rails/rails#37648, escaped output from Postgres is unescaped during deserialization of range values. However, Rails still does not escape values when serializing for Postgres.

Neglecting to escape doesn't actually cause issues with any of Postgres' pre-defined range types (integer, numeric, time, date), because none of them feature values that strictly require escaping on input (they are only escaped on output due to whitespace). However it's possible to define range types for which this would be an issue: for example, ranges defined over strings, enum values, or arrays.

This PR provides an implementation of bound escaping in `ActiveRecord::ConnectionAdapters::PostgreSQL::Quoting#type_cast_range_value`.

## Questions about the proposed implementation:

* What types are allowed in the return value of `type_cast`? In test runs, I see `Integer` and `String`. Is it safe to assume that any complex types that would require escaping will have already have been serialized to a string?
* Is the return value of `type_cast` guaranteed to be unaliased? If so the call to `gsub` could be changed to operate in place.


",https://api.github.com/repos/rails/rails/issues/39585/timeline,,chrisandreae,186537,MDQ6VXNlcjE4NjUzNw==,https://avatars.githubusercontent.com/u/186537?v=4,,https://api.github.com/users/chrisandreae,https://github.com/chrisandreae,https://api.github.com/users/chrisandreae/followers,https://api.github.com/users/chrisandreae/following{/other_user},https://api.github.com/users/chrisandreae/gists{/gist_id},https://api.github.com/users/chrisandreae/starred{/owner}{/repo},https://api.github.com/users/chrisandreae/subscriptions,https://api.github.com/users/chrisandreae/orgs,https://api.github.com/users/chrisandreae/repos,https://api.github.com/users/chrisandreae/events{/privacy},https://api.github.com/users/chrisandreae/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39585/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39585,https://github.com/rails/rails/pull/39585,https://github.com/rails/rails/pull/39585.diff,https://github.com/rails/rails/pull/39585.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
414,https://api.github.com/repos/rails/rails/issues/39566,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39566/labels{/name},https://api.github.com/repos/rails/rails/issues/39566/comments,https://api.github.com/repos/rails/rails/issues/39566/events,https://github.com/rails/rails/issues/39566,633630360,MDU6SXNzdWU2MzM2MzAzNjA=,39566,Add top-level Rails.application.url for canonical reference,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,7,2020-06-07T18:09:19Z,2021-12-06T22:35:33Z,,MEMBER,,"We often need to know the application's URL outside of the request/response cycle. This can be in jobs or in mailers or for configuration purposes. Let's extract this concept as `Rails.application.url`, which is configured by default in the environment files.

What we'd like is for config/development.rb to have something like:

```ruby
  # Application URL
  config.url = ""https://hey.test""
```

Which is then turned into a `ActionDispatch::Http::URI` behind the scenes, and made available as `Rails.application.url`. This URL should automatically be configured as the default URL for mailers and renderers.

Here's a quick stab at an extraction that take the shared logic from ActionDispatch::Http::URL and turns into a decoration on top of stdlib's `URI`. The ActionDispatch::Http::URL is a better name, but it's unfortunately setup as a module that's included in ActionDispatch::Http::Request. It's possible that we could just rename that, though, and then reuse this name instead of URI:

```ruby
class ActionDispatch::Http::URI
  mattr_accessor :tld_length, default: 1

  delegate :scheme, :host, :port, :path, :query, :to_s, to: :uri
  delegate :scheme=, :host=, :port=, :path=, :query=, to: :uri

  class << self
    # Returns the domain part of a host given the domain level.
    #
    #    # Top-level domain example
    #    extract_domain('www.example.com', 1) # => ""example.com""
    #    # Second-level domain example
    #    extract_domain('dev.www.example.co.uk', 2) # => ""example.co.uk""
    def extract_domain(host, tld_length)
      extract_domain_from(host, tld_length) if named_host?(host)
    end

    # Returns the subdomains of a host as an Array given the domain level.
    #
    #    # Top-level domain example
    #    extract_subdomains('www.example.com', 1) # => [""www""]
    #    # Second-level domain example
    #    extract_subdomains('dev.www.example.co.uk', 2) # => [""dev"", ""www""]
    def extract_subdomains(host, tld_length)
      if named_host?(host)
        extract_subdomains_from(host, tld_length)
      else
        []
      end
    end

    # Returns the subdomains of a host as a String given the domain level.
    #
    #    # Top-level domain example
    #    extract_subdomain('www.example.com', 1) # => ""www""
    #    # Second-level domain example
    #    extract_subdomain('dev.www.example.co.uk', 2) # => ""dev.www""
    def extract_subdomain(host, tld_length)
      extract_subdomains(host, tld_length).join(""."")
    end

    private
      def extract_domain_from(host, tld_length)
        host.split(""."").last(1 + tld_length).join(""."")
      end
  end

  def initialize(uri_string)
    @uri = URI.parse(uri_string)
  end

  def protocol
    ""#{scheme}://""
  end

  # Returns a \host:\port string for this request, such as ""example.com"" or
  # ""example.com:8080"". Port is only included if it is not a default port
  # (80 or 443).
  def host_with_port
    ""#{host}#{port_string}""
  end

  # Returns a string \port suffix, including colon, like "":8080"" if the \port
  # number of this request is not the default HTTP \port 80 or HTTPS \port 443.
  def port_string
    standard_port? ? """" : "":#{port}""
  end

  # Returns the standard \port number for this request's protocol.
  def standard_port
    scheme == ""https"" ? 443 : 80
  end

  # Returns whether this request is using the standard port.
  def standard_port?
    port == standard_port
  end

  # Returns a hash with the host and the protocol, for use with URL calls.
  def host_and_protocol
    { host: host, protocol: protocol }
  end

  # Returns the \domain part of a \host, such as ""rubyonrails.org"" in ""www.rubyonrails.org"". You can specify
  # a different <tt>tld_length</tt>, such as 2 to catch rubyonrails.co.uk in ""www.rubyonrails.co.uk"".
  def domain(tld_length = @@tld_length)
    self.class.extract_domain(host, tld_length)
  end

  # Returns all the \subdomains as an array, so <tt>[""dev"", ""www""]</tt> would be
  # returned for ""dev.www.rubyonrails.org"". You can specify a different <tt>tld_length</tt>,
  # such as 2 to catch <tt>[""www""]</tt> instead of <tt>[""www"", ""rubyonrails""]</tt>
  # in ""www.rubyonrails.co.uk"".
  def subdomains(tld_length = @@tld_length)
    self.class.extract_subdomains(host, tld_length)
  end

  # Returns all the \subdomains as a string, so <tt>""dev.www""</tt> would be
  # returned for ""dev.www.rubyonrails.org"". You can specify a different <tt>tld_length</tt>,
  # such as 2 to catch <tt>""www""</tt> instead of <tt>""www.rubyonrails""</tt>
  # in ""www.rubyonrails.co.uk"".
  def subdomain(tld_length = @@tld_length)
    self.class.extract_subdomain(host, tld_length)
  end

  private
    attr_accessor :uri
end
```",https://api.github.com/repos/rails/rails/issues/39566/timeline,,dhh,2741,MDQ6VXNlcjI3NDE=,https://avatars.githubusercontent.com/u/2741?v=4,,https://api.github.com/users/dhh,https://github.com/dhh,https://api.github.com/users/dhh/followers,https://api.github.com/users/dhh/following{/other_user},https://api.github.com/users/dhh/gists{/gist_id},https://api.github.com/users/dhh/starred{/owner}{/repo},https://api.github.com/users/dhh/subscriptions,https://api.github.com/users/dhh/orgs,https://api.github.com/users/dhh/repos,https://api.github.com/users/dhh/events{/privacy},https://api.github.com/users/dhh/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39566/reactions,49,28,0,0,0,0,18,0,3,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
415,https://api.github.com/repos/rails/rails/issues/39525,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39525/labels{/name},https://api.github.com/repos/rails/rails/issues/39525/comments,https://api.github.com/repos/rails/rails/issues/39525/events,https://github.com/rails/rails/pull/39525,629830879,MDExOlB1bGxSZXF1ZXN0NDI3MDY5MDY0,39525,Add support for default order,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,[],,7,2020-06-03T09:11:19Z,2022-04-05T15:27:10Z,,NONE,,"### Summary

Add `#default_order` and `default_order` relation option to define a default order which will be used if no other order is specified.

This extends the functionality offered by `#implicit_order_column` to scopes and relations.

Usage:

```ruby
    class Post < ApplicationRecord
      has_many :comments, default_order: :likes
      # .. or ..
      has_many :comments, -> { default_order(:likes) }
    end

    post = Post.first
    post.comments # comments ordered by `likes`
    post.comments.order(:created_at) # comments ordered by `created_at`
```

### Other Information

I started a discussion about this on Ruby on Rails forum:

https://discuss.rubyonrails.org/t/default-order-for-relations/75554",https://api.github.com/repos/rails/rails/issues/39525/timeline,,udan11,4147664,MDQ6VXNlcjQxNDc2NjQ=,https://avatars.githubusercontent.com/u/4147664?v=4,,https://api.github.com/users/udan11,https://github.com/udan11,https://api.github.com/users/udan11/followers,https://api.github.com/users/udan11/following{/other_user},https://api.github.com/users/udan11/gists{/gist_id},https://api.github.com/users/udan11/starred{/owner}{/repo},https://api.github.com/users/udan11/subscriptions,https://api.github.com/users/udan11/orgs,https://api.github.com/users/udan11/repos,https://api.github.com/users/udan11/events{/privacy},https://api.github.com/users/udan11/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39525/reactions,11,11,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39525,https://github.com/rails/rails/pull/39525,https://github.com/rails/rails/pull/39525.diff,https://github.com/rails/rails/pull/39525.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
416,https://api.github.com/repos/rails/rails/issues/39487,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39487/labels{/name},https://api.github.com/repos/rails/rails/issues/39487/comments,https://api.github.com/repos/rails/rails/issues/39487/events,https://github.com/rails/rails/pull/39487,627845176,MDExOlB1bGxSZXF1ZXN0NDI1NTM1MTI3,39487,Add update_heritable_value_of,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 12449438, 'node_id': 'MDU6TGFiZWwxMjQ0OTQzOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/stale', 'name': 'stale', 'color': '444444', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,12,2020-05-30T23:15:22Z,2022-04-20T21:18:50Z,,MEMBER,,"Using a `class_attribute` for inheritance of values in a Hash is tricky.  When storing a new value in a subclass's Hash, you must be careful to not modify the superclass's Hash.  On the flip side, when storing a new value in a superclass's Hash, you must ensure the subclass can access the value if and only if it has not already been overridden in the subclass's Hash.  (See #39467, #39468, and #39473 for examples of addressing the latter.)

`update_heritable_value_of` handles both of these requirements:

```ruby
A = Class.new
B = Class.new(A)
C = Class.new(B)

A.class_attribute :settings, default: {}

A.update_heritable_value_of(:settings, :foo, ""A"")
A.update_heritable_value_of(:settings, :bar, ""A"")
B.update_heritable_value_of(:settings, :bar, ""B"")
C.update_heritable_value_of(:settings, :qux, ""C"")
A.update_heritable_value_of(:settings, :qux, ""A"")

A.settings  # == {:foo=>""A"", :bar=>""A"", :qux=>""A""}
B.settings  # == {:foo=>""A"", :bar=>""B"", :qux=>""A""}
C.settings  # == {:foo=>""A"", :bar=>""B"", :qux=>""C""}
```

---

TODO:
- [x] tests
- [ ] make it public?

---

/cc @eugeneius
/cc @kamipo

This is an alternative approach to what was being discussed in https://github.com/rails/rails/pull/39467#discussion_r432333910 and https://github.com/rails/rails/pull/39467#discussion_r432562283.

",https://api.github.com/repos/rails/rails/issues/39487/timeline,,jonathanhefner,771968,MDQ6VXNlcjc3MTk2OA==,https://avatars.githubusercontent.com/u/771968?v=4,,https://api.github.com/users/jonathanhefner,https://github.com/jonathanhefner,https://api.github.com/users/jonathanhefner/followers,https://api.github.com/users/jonathanhefner/following{/other_user},https://api.github.com/users/jonathanhefner/gists{/gist_id},https://api.github.com/users/jonathanhefner/starred{/owner}{/repo},https://api.github.com/users/jonathanhefner/subscriptions,https://api.github.com/users/jonathanhefner/orgs,https://api.github.com/users/jonathanhefner/repos,https://api.github.com/users/jonathanhefner/events{/privacy},https://api.github.com/users/jonathanhefner/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39487/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39487,https://github.com/rails/rails/pull/39487,https://github.com/rails/rails/pull/39487.diff,https://github.com/rails/rails/pull/39487.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
417,https://api.github.com/repos/rails/rails/issues/39476,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39476/labels{/name},https://api.github.com/repos/rails/rails/issues/39476/comments,https://api.github.com/repos/rails/rails/issues/39476/events,https://github.com/rails/rails/pull/39476,627474385,MDExOlB1bGxSZXF1ZXN0NDI1MjczMjM2,39476,Remove HTML fallback for JS requests,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,9,2020-05-29T19:01:22Z,2021-06-01T01:20:36Z,,MEMBER,,"We shouldn't fall back to HTML for JS requests because caching proxies
might cache secrets that are embedded in the HTML (like CSRF tokens).

See #39475

I *think* this removes everything related to the HTML fallback, but I'm not 100% sure.",https://api.github.com/repos/rails/rails/issues/39476/timeline,,tenderlove,3124,MDQ6VXNlcjMxMjQ=,https://avatars.githubusercontent.com/u/3124?v=4,,https://api.github.com/users/tenderlove,https://github.com/tenderlove,https://api.github.com/users/tenderlove/followers,https://api.github.com/users/tenderlove/following{/other_user},https://api.github.com/users/tenderlove/gists{/gist_id},https://api.github.com/users/tenderlove/starred{/owner}{/repo},https://api.github.com/users/tenderlove/subscriptions,https://api.github.com/users/tenderlove/orgs,https://api.github.com/users/tenderlove/repos,https://api.github.com/users/tenderlove/events{/privacy},https://api.github.com/users/tenderlove/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39476/reactions,2,0,0,0,0,0,1,0,1,False,https://api.github.com/repos/rails/rails/pulls/39476,https://github.com/rails/rails/pull/39476,https://github.com/rails/rails/pull/39476.diff,https://github.com/rails/rails/pull/39476.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
418,https://api.github.com/repos/rails/rails/issues/39475,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39475/labels{/name},https://api.github.com/repos/rails/rails/issues/39475/comments,https://api.github.com/repos/rails/rails/issues/39475/events,https://github.com/rails/rails/issues/39475,627439129,MDU6SXNzdWU2Mjc0MzkxMjk=,39475,HTML fallback for .js paths is dangerous,"[{'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,3,2020-05-29T17:58:15Z,2020-08-11T14:31:41Z,,MEMBER,,"This issue came in from Hackerone ([here is the link](https://hackerone.com/bugs?subject=rails&report_id=167778) for those with access).  I'm filing an issue here because the Hackerone ticket is very old, and I don't see any way to actually fix the issue without definitely breaking backwards compatibility.

The issue is that controllers will fall back to HTML for `.js` requests (unless the controller uses an explicit `respond_to` handler).  For example a controller like this:

```ruby
class ContributorsController
  def index
    @contributors = if params[:release_id].present?
      set_release
      Contributor.all_with_ncommits_by_release(@release)
    else
      Contributor.all_with_ncommits
    end
  end
end
```

(I stole this code from [here](https://github.com/rails/rails-contributors/blob/d4d5066527783d9eb2c3603e08d798bd76800b50/app/controllers/contributors_controller.rb) to show this is a problem with real apps).

If someone makes a request to this with a `.js` extension, Rails will render the HTML template since there is no JS template.  If you go to [this link](https://contributors.rubyonrails.org/contributors/in-time-window/this-week.js) you can see that the HTML view is rendered even though we asked for `.js`.

The issue is that some caching proxies will see the `.js` extension and cache the response, including any authenticity tokens.  A crafty attacker could send someone a link to a Rails app that's behind a proxy like this, but with a `.js` extension.  After the victim clicks the link, the attacker can access the proxy and steal the cached authenticity token.

My personal opinion is that we should eliminate the fallback from `.js`.  If someone requests a `.js` and there is no template, we should 404 or something.  However, I'm also 99% sure that someone is relying on this behavior and we'll break apps.",https://api.github.com/repos/rails/rails/issues/39475/timeline,,tenderlove,3124,MDQ6VXNlcjMxMjQ=,https://avatars.githubusercontent.com/u/3124?v=4,,https://api.github.com/users/tenderlove,https://github.com/tenderlove,https://api.github.com/users/tenderlove/followers,https://api.github.com/users/tenderlove/following{/other_user},https://api.github.com/users/tenderlove/gists{/gist_id},https://api.github.com/users/tenderlove/starred{/owner}{/repo},https://api.github.com/users/tenderlove/subscriptions,https://api.github.com/users/tenderlove/orgs,https://api.github.com/users/tenderlove/repos,https://api.github.com/users/tenderlove/events{/privacy},https://api.github.com/users/tenderlove/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39475/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
419,https://api.github.com/repos/rails/rails/issues/39473,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39473/labels{/name},https://api.github.com/repos/rails/rails/issues/39473/comments,https://api.github.com/repos/rails/rails/issues/39473/events,https://github.com/rails/rails/pull/39473,627335652,MDExOlB1bGxSZXF1ZXN0NDI1MTU4Nzc1,39473,Ensure associations are inherited even after subclasses are defined,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,6,2020-05-29T15:03:43Z,2022-02-26T05:45:26Z,,MEMBER,,"This is a common `class_attribute` implementation issue (e.g. #39467,
#39468, #38871).

For now, we should take care of the change propagation by themselves if
we want to ensure the propagation after the `class_attribute` are
accessed in subclasses.

Fixes #20678.
",https://api.github.com/repos/rails/rails/issues/39473/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39473/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39473,https://github.com/rails/rails/pull/39473,https://github.com/rails/rails/pull/39473.diff,https://github.com/rails/rails/pull/39473.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
420,https://api.github.com/repos/rails/rails/issues/39444,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39444/labels{/name},https://api.github.com/repos/rails/rails/issues/39444/comments,https://api.github.com/repos/rails/rails/issues/39444/events,https://github.com/rails/rails/pull/39444,625261068,MDExOlB1bGxSZXF1ZXN0NDIzNTE0NzU2,39444,rails new cool_app --interactive,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,8,2020-05-26T23:21:58Z,2021-05-21T22:46:18Z,,CONTRIBUTOR,,"### Summary

rails new cool_app --interactive

Adds the ability to interactively setup your rails application. All the questions we ask:

- database
- skip_action_cable
- skip_action_mailer
- skip_action_mailbox
- skip_active_storage
- skip_action_text
- skip_bootsnap
- skip_jbuilder
- skip_javascript
- skip_spring
- skip_sprockets
- skip_system_tests
- skip_turbolinks
- skip_webpack
- webpack (which library you want to use if skip_webpack = false)

related #39282

If you want to help test this out, please do:

1. Pull down this branch
2. cd into the rails source
3. `railties/exe/rails new ~/Desktop/testapps/your_interactive_app --interactive`",https://api.github.com/repos/rails/rails/issues/39444/timeline,,hahmed,658005,MDQ6VXNlcjY1ODAwNQ==,https://avatars.githubusercontent.com/u/658005?v=4,,https://api.github.com/users/hahmed,https://github.com/hahmed,https://api.github.com/users/hahmed/followers,https://api.github.com/users/hahmed/following{/other_user},https://api.github.com/users/hahmed/gists{/gist_id},https://api.github.com/users/hahmed/starred{/owner}{/repo},https://api.github.com/users/hahmed/subscriptions,https://api.github.com/users/hahmed/orgs,https://api.github.com/users/hahmed/repos,https://api.github.com/users/hahmed/events{/privacy},https://api.github.com/users/hahmed/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39444/reactions,30,17,0,0,0,0,13,0,0,False,https://api.github.com/repos/rails/rails/pulls/39444,https://github.com/rails/rails/pull/39444,https://github.com/rails/rails/pull/39444.diff,https://github.com/rails/rails/pull/39444.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
421,https://api.github.com/repos/rails/rails/issues/39398,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39398/labels{/name},https://api.github.com/repos/rails/rails/issues/39398/comments,https://api.github.com/repos/rails/rails/issues/39398/events,https://github.com/rails/rails/pull/39398,623519024,MDExOlB1bGxSZXF1ZXN0NDIyMTcxNTc4,39398,Add new APIs to customize content security policy for non-HTML responses,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,22,2020-05-22T23:26:50Z,2022-03-08T21:23:41Z,,CONTRIBUTOR,,"### Summary
One feature of the content security policy DSL, though undocumented,
is that it will not generate headers for non-HTML responses, even if a
configuration is explicitly provided. While it may not seem obvious
that anyone would want to send this header in an API response, Mozilla
Observatory, for instance, recommends the following for API responses:

`Content-Security-Policy: default-src 'none'; frame-ancestors 'none'`

(source: https://observatory.mozilla.org/faq/)

The Secure Headers gem also makes recommendations about the content
security policy for API responses: https://github.com/github/secure_headers#api-configurations

As such, this removes the HTML guard clause from the
`ContentSecurityPolicy` middleware.

### Other Information
I imagine that it may be preferable to gate this behavior, assuming that the change is agreeable, but kindly request feedback before getting too deeply involved with that.
",https://api.github.com/repos/rails/rails/issues/39398/timeline,,imtayadeway,1710874,MDQ6VXNlcjE3MTA4NzQ=,https://avatars.githubusercontent.com/u/1710874?v=4,,https://api.github.com/users/imtayadeway,https://github.com/imtayadeway,https://api.github.com/users/imtayadeway/followers,https://api.github.com/users/imtayadeway/following{/other_user},https://api.github.com/users/imtayadeway/gists{/gist_id},https://api.github.com/users/imtayadeway/starred{/owner}{/repo},https://api.github.com/users/imtayadeway/subscriptions,https://api.github.com/users/imtayadeway/orgs,https://api.github.com/users/imtayadeway/repos,https://api.github.com/users/imtayadeway/events{/privacy},https://api.github.com/users/imtayadeway/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39398/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39398,https://github.com/rails/rails/pull/39398,https://github.com/rails/rails/pull/39398.diff,https://github.com/rails/rails/pull/39398.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
422,https://api.github.com/repos/rails/rails/issues/39364,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39364/labels{/name},https://api.github.com/repos/rails/rails/issues/39364/comments,https://api.github.com/repos/rails/rails/issues/39364/events,https://github.com/rails/rails/pull/39364,621664652,MDExOlB1bGxSZXF1ZXN0NDIwNjcxMzY0,39364,Add Amazon SES/SNS ingress to ActionMailbox,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,[],,69,2020-05-20T10:53:04Z,2022-03-30T10:49:13Z,,CONTRIBUTOR,,"### Summary

Provides an ingress for Amazon SES/SNS.

Includes:
* `/rails/action_mailbox/amazon/inbound_emails` ingress route
* Signature verification
* Auto-subscribe
* Permitted SNS topic configuration

Tests for all of the above are included.

### Other Information

This commit (f480cfabcd9000b5817b610e21466299025b12d2) from @georgeclaghorn  states that SES integration was removed and will be re-written for 6.1.

I needed this sooner so I wrote a gem here: https://github.com/bobf/action_mailbox_amazon_ingress

I emailed George to discuss and he suggested a PR. I have adapted the tests from RSpec to Minitest.

Please let me know if any adjustments are needed.",https://api.github.com/repos/rails/rails/issues/39364/timeline,,bobf,18470,MDQ6VXNlcjE4NDcw,https://avatars.githubusercontent.com/u/18470?v=4,,https://api.github.com/users/bobf,https://github.com/bobf,https://api.github.com/users/bobf/followers,https://api.github.com/users/bobf/following{/other_user},https://api.github.com/users/bobf/gists{/gist_id},https://api.github.com/users/bobf/starred{/owner}{/repo},https://api.github.com/users/bobf/subscriptions,https://api.github.com/users/bobf/orgs,https://api.github.com/users/bobf/repos,https://api.github.com/users/bobf/events{/privacy},https://api.github.com/users/bobf/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39364/reactions,16,0,0,0,16,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39364,https://github.com/rails/rails/pull/39364,https://github.com/rails/rails/pull/39364.diff,https://github.com/rails/rails/pull/39364.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
423,https://api.github.com/repos/rails/rails/issues/39299,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39299/labels{/name},https://api.github.com/repos/rails/rails/issues/39299/comments,https://api.github.com/repos/rails/rails/issues/39299/events,https://github.com/rails/rails/pull/39299,619064381,MDExOlB1bGxSZXF1ZXN0NDE4NjYwNzI3,39299,Add search to Rails Guides,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,10,2020-05-15T15:35:45Z,2022-03-02T17:44:55Z,,CONTRIBUTOR,,"For better discoverability and to prevent users from having to leave
the Guides webiste, this commit implements a client side search based
on the open **lunr** library.

Different libraries were compared:

* lucaong/minisearch, where it was not possible to pre-build an index.
  Building it on the fly would take about 3 seconds and render the
  browser unresponsive.
* krisk/Fuse, where it was possible to pre-build an index, but the
  fuzzy search was very slow and would block for about 600ms.
* olivernn/lunr.js, where the index cloud be pre-built and the fuzzy
  search could be disabled.

The new search uses Lunr with a pre-built index and by using a lookup
table where the id of the documents are mapped to their respective url
to keep the index size small.

To build the index, the Guides HTML is parsed and split into documents
that are then indexed using ExecJS. This generates an index of about
3.3 MB in size which is only loaded when the user focuses the search
input.

The index is then stored in the browsers localstorage for up to a week
for performance.

[Demo here](http://codefabrik-rails-demo.s3-website-us-west-2.amazonaws.com/)

![image](https://user-images.githubusercontent.com/282447/82068594-7a74e080-96d2-11ea-88c1-2a286a7aefeb.png)


### Summary

<!-- Provide a general description of the code changes in your pull
request... were there any bugs you had fixed? If so, mention them. If
these bugs have open GitHub issues, be sure to tag them here as well,
to keep the conversation linked together. -->

### Other Information

References:
* [Issue 36218](https://github.com/rails/rails/issues/36218)
* [May of WTFs 1](https://discuss.rubyonrails.org/t/rails-api-guides-navigation/74481)
* [May of WTFs 2](https://discuss.rubyonrails.org/t/no-search-in-rails-guides/74460)
",https://api.github.com/repos/rails/rails/issues/39299/timeline,,LukasSkywalker,282447,MDQ6VXNlcjI4MjQ0Nw==,https://avatars.githubusercontent.com/u/282447?v=4,,https://api.github.com/users/LukasSkywalker,https://github.com/LukasSkywalker,https://api.github.com/users/LukasSkywalker/followers,https://api.github.com/users/LukasSkywalker/following{/other_user},https://api.github.com/users/LukasSkywalker/gists{/gist_id},https://api.github.com/users/LukasSkywalker/starred{/owner}{/repo},https://api.github.com/users/LukasSkywalker/subscriptions,https://api.github.com/users/LukasSkywalker/orgs,https://api.github.com/users/LukasSkywalker/repos,https://api.github.com/users/LukasSkywalker/events{/privacy},https://api.github.com/users/LukasSkywalker/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39299/reactions,9,9,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39299,https://github.com/rails/rails/pull/39299,https://github.com/rails/rails/pull/39299.diff,https://github.com/rails/rails/pull/39299.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
424,https://api.github.com/repos/rails/rails/issues/39283,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39283/labels{/name},https://api.github.com/repos/rails/rails/issues/39283/comments,https://api.github.com/repos/rails/rails/issues/39283/events,https://github.com/rails/rails/pull/39283,618175782,MDExOlB1bGxSZXF1ZXN0NDE3OTUxODEy,39283,ActiveStorage enable variants for custom media types,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,22,2020-05-14T12:06:48Z,2022-01-29T17:05:48Z,,CONTRIBUTOR,,"### Summary

Enables ActiveStorage variants for other file types than images, such as audio or video files, through an API for registering custom transformers similar to previewers. An example `ffmpeg` transformation is provided.

### Other Information

It was [suggested](https://discuss.rubyonrails.org/t/activestorage-only-supports-image-variants/74808) to submit this PR to get feedback (from @georgeclaghorn?). NB: As `ActiveStorage::Transformers::Transformer` and `ActiveStorage::Previewer` do not differ much, we could consider merging them in another PR to allow using them interchangeably.",https://api.github.com/repos/rails/rails/issues/39283/timeline,,sedubois,4217871,MDQ6VXNlcjQyMTc4NzE=,https://avatars.githubusercontent.com/u/4217871?v=4,,https://api.github.com/users/sedubois,https://github.com/sedubois,https://api.github.com/users/sedubois/followers,https://api.github.com/users/sedubois/following{/other_user},https://api.github.com/users/sedubois/gists{/gist_id},https://api.github.com/users/sedubois/starred{/owner}{/repo},https://api.github.com/users/sedubois/subscriptions,https://api.github.com/users/sedubois/orgs,https://api.github.com/users/sedubois/repos,https://api.github.com/users/sedubois/events{/privacy},https://api.github.com/users/sedubois/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39283/reactions,11,10,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/39283,https://github.com/rails/rails/pull/39283,https://github.com/rails/rails/pull/39283.diff,https://github.com/rails/rails/pull/39283.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
425,https://api.github.com/repos/rails/rails/issues/39230,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39230/labels{/name},https://api.github.com/repos/rails/rails/issues/39230/comments,https://api.github.com/repos/rails/rails/issues/39230/events,https://github.com/rails/rails/issues/39230,615904752,MDU6SXNzdWU2MTU5MDQ3NTI=,39230,Migrations Should Raise an Exception for Unsupported Options,"[{'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2020-05-11T13:55:27Z,2021-07-05T16:41:02Z,,NONE,,"### Steps to reproduce
It's easy to make a mistake in a migration and accidentally use an option that ends up being ignored.

Some options are supported by one command but not another:

```ruby
create_table :things do |t|
  # Good - Creates column_a and an index
  t.integer :column_a, index: true
end

# Bad - Creates column_b but silently ignores the index option
add_column :things, :column_b, :integer, index: true
```

And typos are allowed.  In [this example from Stack Overflow](https://stackoverflow.com/a/14271429/2622934), using `precison` instead of `precision` still created a numeric column without the precision defined.

### Expected behavior
Migrations should raise an exception for unsupported options.

### Actual behavior
Migration completes successfully without any error.

### System configuration
**Rails version**: 6.0

**Ruby version**: 2.6
",https://api.github.com/repos/rails/rails/issues/39230/timeline,,chadrschroeder,5098851,MDQ6VXNlcjUwOTg4NTE=,https://avatars.githubusercontent.com/u/5098851?v=4,,https://api.github.com/users/chadrschroeder,https://github.com/chadrschroeder,https://api.github.com/users/chadrschroeder/followers,https://api.github.com/users/chadrschroeder/following{/other_user},https://api.github.com/users/chadrschroeder/gists{/gist_id},https://api.github.com/users/chadrschroeder/starred{/owner}{/repo},https://api.github.com/users/chadrschroeder/subscriptions,https://api.github.com/users/chadrschroeder/orgs,https://api.github.com/users/chadrschroeder/repos,https://api.github.com/users/chadrschroeder/events{/privacy},https://api.github.com/users/chadrschroeder/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39230/reactions,7,7,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
426,https://api.github.com/repos/rails/rails/issues/39207,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39207/labels{/name},https://api.github.com/repos/rails/rails/issues/39207/comments,https://api.github.com/repos/rails/rails/issues/39207/events,https://github.com/rails/rails/pull/39207,615185937,MDExOlB1bGxSZXF1ZXN0NDE1NTgxOTE4,39207,Expose Arel attributes through ActiveRecord::Table module and `t` method,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,3,2020-05-09T14:19:33Z,2021-07-12T10:48:12Z,,CONTRIBUTOR,,"### Summary

This implements a `Table` module and `t` class method for ActiveRecord models. 
The goal is to expose a table's Arel attributes without directly typing ""Arel"". This started with the `[]` method here: https://github.com/rails/rails/pull/39198

The module is installed after a db connection is available, and the methods are defined at call time:

Examples:

```ruby
Developer::Table.id.eq(42)

Developer.t.salary.gt(9000)
```

References:
- https://github.com/rails/rails/pull/39198
- https://discuss.rubyonrails.org/t/what-has-happened-to-arel/74383/36",https://api.github.com/repos/rails/rails/issues/39207/timeline,,flanger001,1645017,MDQ6VXNlcjE2NDUwMTc=,https://avatars.githubusercontent.com/u/1645017?v=4,,https://api.github.com/users/flanger001,https://github.com/flanger001,https://api.github.com/users/flanger001/followers,https://api.github.com/users/flanger001/following{/other_user},https://api.github.com/users/flanger001/gists{/gist_id},https://api.github.com/users/flanger001/starred{/owner}{/repo},https://api.github.com/users/flanger001/subscriptions,https://api.github.com/users/flanger001/orgs,https://api.github.com/users/flanger001/repos,https://api.github.com/users/flanger001/events{/privacy},https://api.github.com/users/flanger001/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39207/reactions,3,3,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39207,https://github.com/rails/rails/pull/39207,https://github.com/rails/rails/pull/39207.diff,https://github.com/rails/rails/pull/39207.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
427,https://api.github.com/repos/rails/rails/issues/39150,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39150/labels{/name},https://api.github.com/repos/rails/rails/issues/39150/comments,https://api.github.com/repos/rails/rails/issues/39150/events,https://github.com/rails/rails/pull/39150,612349686,MDExOlB1bGxSZXF1ZXN0NDEzMzE1MTk5,39150,"Remove useless `eq_all`, `eq_any`, etc","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,13,2020-05-05T05:33:01Z,2022-03-10T07:16:12Z,,MEMBER,,"All `*_all` and `*_any` are quite useless (e.g. `attr.eq_all([1,2])` ->
always empty, `attr.eq_any([1,2])` -> use `attr.in([1,2])` instead), and
it is hard to find effective use case.

I'd not like to maintain that useless private API which are not used in
the code base.",https://api.github.com/repos/rails/rails/issues/39150/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39150/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/39150,https://github.com/rails/rails/pull/39150,https://github.com/rails/rails/pull/39150.diff,https://github.com/rails/rails/pull/39150.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
428,https://api.github.com/repos/rails/rails/issues/39015,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/39015/labels{/name},https://api.github.com/repos/rails/rails/issues/39015/comments,https://api.github.com/repos/rails/rails/issues/39015/events,https://github.com/rails/rails/issues/39015,604800526,MDU6SXNzdWU2MDQ4MDA1MjY=,39015,Public storage tests are not ran in CI,"[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,4,2020-04-22T14:24:50Z,2021-05-14T17:22:57Z,,CONTRIBUTOR,,"### Steps to reproduce

Credentials for public buckets are not supplied on CI on master so public service tests are not ran (feature was implemented in #36729).

### Expected behavior

Tests are ran on CI on master.

### Actual behavior

`Skipping Azure Storage Public Service tests because no Azure configuration was supplied`

`Skipping GCS Public Service tests because no GCS configuration was supplied`

`Skipping S3 Public Service tests because no S3 configuration was supplied`

Are present in the logs for Active Storage tests.

### System configuration
**Rails version**: master

**Ruby version**: all
",https://api.github.com/repos/rails/rails/issues/39015/timeline,,peterzhu2118,15860699,MDQ6VXNlcjE1ODYwNjk5,https://avatars.githubusercontent.com/u/15860699?v=4,,https://api.github.com/users/peterzhu2118,https://github.com/peterzhu2118,https://api.github.com/users/peterzhu2118/followers,https://api.github.com/users/peterzhu2118/following{/other_user},https://api.github.com/users/peterzhu2118/gists{/gist_id},https://api.github.com/users/peterzhu2118/starred{/owner}{/repo},https://api.github.com/users/peterzhu2118/subscriptions,https://api.github.com/users/peterzhu2118/orgs,https://api.github.com/users/peterzhu2118/repos,https://api.github.com/users/peterzhu2118/events{/privacy},https://api.github.com/users/peterzhu2118/received_events,User,False,https://api.github.com/repos/rails/rails/issues/39015/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
429,https://api.github.com/repos/rails/rails/issues/38940,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38940/labels{/name},https://api.github.com/repos/rails/rails/issues/38940/comments,https://api.github.com/repos/rails/rails/issues/38940/events,https://github.com/rails/rails/issues/38940,599132361,MDU6SXNzdWU1OTkxMzIzNjE=,38940,ActiveStorage direct uploads can't specify a service_name?,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,12,2020-04-13T20:58:24Z,2021-06-23T15:23:59Z,,NONE,,"hey @DmitryTsepelev -- I brought my app to rails master, so that i could try out your PR: https://github.com/rails/rails/pull/34935

unfortunately, I can't seem to figure out how direct uploads can respect the service specified in the model? `DirectUploadsController` doesn't seem to allow passing in a service (though I'm not sure you'd want that to be user controlled necessarily?). I was expecting somehow for the rails form helpers to somehow signal to the `DirectUploadsController` what service to use, based on the model it was posting to. 

I'm assuming I'm just missing something, but it seems like there might not be a way to use direct uploads with your PR changes? I guess you could write your own `DirectUploadsController`?

<hr>

### Steps to reproduce
use  a `form_with` in your erb that points to a model, make a file field the same name as a `has_one_attached` field and `direct_upload: true`. then upload a file via your web browser

### Expected behavior
direct upload will be directed at the service specified in the model

### Actual behavior
direct upload goes to the default storage adapter

### System configuration
**Rails version**: rails@c1ccc6a0d240

**Ruby version**: 2.5.1p7


",https://api.github.com/repos/rails/rails/issues/38940/timeline,,scottjg,118412,MDQ6VXNlcjExODQxMg==,https://avatars.githubusercontent.com/u/118412?v=4,,https://api.github.com/users/scottjg,https://github.com/scottjg,https://api.github.com/users/scottjg/followers,https://api.github.com/users/scottjg/following{/other_user},https://api.github.com/users/scottjg/gists{/gist_id},https://api.github.com/users/scottjg/starred{/owner}{/repo},https://api.github.com/users/scottjg/subscriptions,https://api.github.com/users/scottjg/orgs,https://api.github.com/users/scottjg/repos,https://api.github.com/users/scottjg/events{/privacy},https://api.github.com/users/scottjg/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38940/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
430,https://api.github.com/repos/rails/rails/issues/38721,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38721/labels{/name},https://api.github.com/repos/rails/rails/issues/38721/comments,https://api.github.com/repos/rails/rails/issues/38721/events,https://github.com/rails/rails/pull/38721,580792253,MDExOlB1bGxSZXF1ZXN0Mzg3OTM1ODM0,38721,Add a database configuration DSL,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,28,2020-03-13T19:15:01Z,2021-07-20T03:52:34Z,,MEMBER,,"This PR adds the ability to define database configurations in an
application using a Ruby DSL. This would allow applications with much
more complex configurations use Ruby over YAML. One of the advantages is
we can avoid making the YAML parsing for database configuration objects
more complex.

The defined behavior will use the `database.yml` file if present. If
there is no `database.yml` and there is a `database.rb` Rails will use
the Ruby file.

The structure of the Ruby config is very similar to the YAML. It
supports default settings that can get merged into the configurations to
avoid duplicating the same lines. It uses a dummy kwarg to avoid parsing
the configuration hash before boot just like the dummy database yaml.

To create a configuration DSL, delete your `database.yml` and add a
`database.rb`.

A database.yml that looks like this:

```yaml
default: &default
  adapter: mysql2
  encoding: utf8mb4
  pool: <%= ENV.fetch(""RAILS_MAX_THREADS"") { 5 } %>
  username: root
  password:
  socket: /tmp/mysql.sock

development:
  primary:
    <<: *default
    database: recipes_development
  primary_replica:
    <<: *default
    database: recipes_development
    replica: true
```

Would be written in the Ruby DSL like this:

```ruby
ActiveRecord::DatabaseConfigurations.configure do
  default = build do
    adapter ""mysql2""
    encoding ""utf8mb4""
    pool ENV.fetch(""RAILS_MAX_THREADS"") { 5 }
    username ""root""
    password """"
    socket ""/tmp/mysql.sock""
  end

  for_env(:development) do
    add(:primary, default) do
      database ""recipes_development""

      replica
    end
  end
end
```

The Ruby example from above will return 2 configurations; one named
`primary` and one named `primary_replica`. If we passed a name to
`replica` like `replica(:one)` it would create a replica named
`primary_replica_one`. One of the benefits of using the Ruby DSL over
the YAML is we can ignore the default configuration. In YAML since we
don't know what someone will name their default we must always include
it the configurations list when calling
`ActiveRecord::Base.configurations`. When using the Ruby DSL we know
which ones are the default settings so it can be ignored.

If `dummy: true` is passed to the builder we'll skip evaluating the
block and return a list of configurations with `env_name` and `name`
set while `configuration_hash` will be empty.

In the future Rails should provide a generator option to use the Ruby
DSL over YAML and a task that can convert a YAML file into the Ruby DSL.
For now, this PR adds support for the DSL and replacement of the YAML
file will be manual.

The aim of this PR is not to replace YAML but to give an option for
more complex database configurations.

The main benefits of using the Ruby DSL are:

1) Can use simple Ruby to create multiple databases, ex:

```ruby
add(:primary) do
  database ""my_database""

  10.times do |int|
    replica(""#{int}"")
  end
end
```

Or write out conditionals:

```ruby
add(:primary) do
  database Rails.config.some_value ? ""my_database"" : ""your_database""
end
```

2) The Ruby DSL leaves the `default` config definitions out of the
`configurations` list. This isn't possible with YAML because we don't
know what the name of the default will be, it can be anything.

3) Reduces repetition by supporting nested configurations. This will
allow us to tie replicas to their primaries and eventually simplify
`connects_to` to only be `connects_to :primary`. This will never be
possible with the 3-tier YAML configuration.

4) The flexibility of YAML + ERB makes it difficult to ""guess"" where we
are in the levels. Adding a 4th level to YAML configurations for replicas
or shards is untenable without a stricter solution. The Ruby DSL makes it
easier to build complex configurations programmatically.

Co-authored-by: @eileencodes 

cc / @rafaelfranca @tenderlove @dhh ",https://api.github.com/repos/rails/rails/issues/38721/timeline,,seejohnrun,64965,MDQ6VXNlcjY0OTY1,https://avatars.githubusercontent.com/u/64965?v=4,,https://api.github.com/users/seejohnrun,https://github.com/seejohnrun,https://api.github.com/users/seejohnrun/followers,https://api.github.com/users/seejohnrun/following{/other_user},https://api.github.com/users/seejohnrun/gists{/gist_id},https://api.github.com/users/seejohnrun/starred{/owner}{/repo},https://api.github.com/users/seejohnrun/subscriptions,https://api.github.com/users/seejohnrun/orgs,https://api.github.com/users/seejohnrun/repos,https://api.github.com/users/seejohnrun/events{/privacy},https://api.github.com/users/seejohnrun/received_events,User,True,https://api.github.com/repos/rails/rails/issues/38721/reactions,5,5,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/38721,https://github.com/rails/rails/pull/38721,https://github.com/rails/rails/pull/38721.diff,https://github.com/rails/rails/pull/38721.patch,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
431,https://api.github.com/repos/rails/rails/issues/38707,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38707/labels{/name},https://api.github.com/repos/rails/rails/issues/38707/comments,https://api.github.com/repos/rails/rails/issues/38707/events,https://github.com/rails/rails/issues/38707,579668385,MDU6SXNzdWU1Nzk2NjgzODU=,38707,Record with attribute of custom type fails to create when value is 0,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,10,2020-03-12T03:29:14Z,2020-09-29T13:51:25Z,,CONTRIBUTOR,,"I have a `Duration` type which I use to cast ActiveSupport durations to and from the database.

Creation of new record fails if the record has a value of `0`. It fails because the attribute is completely removed from the `INSERT` statement, leading to a `NULL` constraint violation.

Notable is that updating an existing record with the same value works without problem. (The correct `UPDATE` statement is generated.)

Also ActiveRecord reports the record as `#valid?` both before and after the failed save.

### Steps to reproduce

```ruby
# app/types/duration.rb
#
class Duration < ActiveRecord::Type::Integer
  def cast(value)
    if value.present? && !value.is_a?(ActiveSupport::Duration)
      super(value.to_i.seconds)
    else
      super
    end
  end

  def serialize(value)
    value.to_i
  end

  def deserialize(value)
    value.to_i.seconds
  end
end
```

```ruby
# app/models/processor.rb
#
class Processor < ApplicationRecord
  attribute :processing_delay, :duration

  validates :processing_delay, presence: true, numericality: { greater_than_or_equal_to: 0 }
end
```

```ruby
Processor.create!(name: ""foo"", processing_delay: 0.seconds)
```

### Expected behavior

Record saves successfully.

### Actual behavior

```
ActiveRecord::NotNullViolation (PG::NotNullViolation: ERROR:  null value in column ""processing_delay"" violates not-null constraint)
```

The generated `INSERT` statement:

```sql
INSERT INTO ""processors"" (""name"") VALUES ($1) RETURNING ""id""
```

### System configuration

**Rails version**:

2.6.5

**Ruby version**:

6.0.2.1",https://api.github.com/repos/rails/rails/issues/38707/timeline,,Drenmi,5259935,MDQ6VXNlcjUyNTk5MzU=,https://avatars.githubusercontent.com/u/5259935?v=4,,https://api.github.com/users/Drenmi,https://github.com/Drenmi,https://api.github.com/users/Drenmi/followers,https://api.github.com/users/Drenmi/following{/other_user},https://api.github.com/users/Drenmi/gists{/gist_id},https://api.github.com/users/Drenmi/starred{/owner}{/repo},https://api.github.com/users/Drenmi/subscriptions,https://api.github.com/users/Drenmi/orgs,https://api.github.com/users/Drenmi/repos,https://api.github.com/users/Drenmi/events{/privacy},https://api.github.com/users/Drenmi/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38707/reactions,3,3,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
432,https://api.github.com/repos/rails/rails/issues/38577,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38577/labels{/name},https://api.github.com/repos/rails/rails/issues/38577/comments,https://api.github.com/repos/rails/rails/issues/38577/events,https://github.com/rails/rails/pull/38577,571168840,MDExOlB1bGxSZXF1ZXN0MzgwMDkwMzc0,38577,Prevent schema_cache leaking connections between threads,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,9,2020-02-26T08:54:52Z,2021-07-29T07:26:08Z,,NONE,,"At Discourse, we have been seeing some unexpected behaviour in our Sidekiq worker processes, which run jobs in a multi-threaded environment. We were seeing multiple threads accessing the same database connections concurrently.

The root cause appears to be 49b6b211, which changed schema_cache to be per-pool rather than per-connection. However, the schema_cache still maintains an internal reference to a single connection. This reference [was replaced](https://github.com/rails/rails/commit/49b6b211a922f73d0b083e7e4d2f0a91bd44da90#diff-7735c67f539e7d1e2908a4d5d8909c24R25-R27) each time the schema_cache was requested, but the change would affect all threads. Under some circumstances, this can result in multiple threads trying to use the same connection.

This commit switches back to a single SchemaCache instance per connection, but also introduces a new SchemaCacheData class. A single instance of SchemaCacheData is shared between all SchemaCache instances for a pool.

cc @SamSaffron ",https://api.github.com/repos/rails/rails/issues/38577/timeline,,davidtaylorhq,6270921,MDQ6VXNlcjYyNzA5MjE=,https://avatars.githubusercontent.com/u/6270921?v=4,,https://api.github.com/users/davidtaylorhq,https://github.com/davidtaylorhq,https://api.github.com/users/davidtaylorhq/followers,https://api.github.com/users/davidtaylorhq/following{/other_user},https://api.github.com/users/davidtaylorhq/gists{/gist_id},https://api.github.com/users/davidtaylorhq/starred{/owner}{/repo},https://api.github.com/users/davidtaylorhq/subscriptions,https://api.github.com/users/davidtaylorhq/orgs,https://api.github.com/users/davidtaylorhq/repos,https://api.github.com/users/davidtaylorhq/events{/privacy},https://api.github.com/users/davidtaylorhq/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38577/reactions,18,10,0,0,0,0,8,0,0,False,https://api.github.com/repos/rails/rails/pulls/38577,https://github.com/rails/rails/pull/38577,https://github.com/rails/rails/pull/38577.diff,https://github.com/rails/rails/pull/38577.patch,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
433,https://api.github.com/repos/rails/rails/issues/38189,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38189/labels{/name},https://api.github.com/repos/rails/rails/issues/38189/comments,https://api.github.com/repos/rails/rails/issues/38189/events,https://github.com/rails/rails/issues/38189,546949823,MDU6SXNzdWU1NDY5NDk4MjM=,38189,quoted_date has an hour window of failure for timestamp with timezone,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2020-01-08T15:56:47Z,2020-04-16T17:27:07Z,,NONE,,"### Description
This is a catch-22. The code is built to work well with timestamp without time zone (and that is the convention for things like created_at/updated_at).  However, for timestamp with time zone and timezones with DST there exists a window of time where this causes any timestamp within that window to disappear, shifting the offset to standard time.

### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

1. Have a model with a column that has postgresql timestamp with time zone
1. update that column with a Time during that window.
1. Retrieving that column of that row shifts it to the prevailing timezone.

For details, see actual behavior.

### Expected behavior
<!-- Tell us what should happen -->
The timestamp with timezone should be persisted with the correct timezone.

### Actual behavior
<!-- Tell us what happens instead -->
Example (while in Eastern Standard Time):
-  In rails console, using a model with a column that's backed by a postgresql timestamp with time zone, update the column to a time during that period.
`model.update(time_column: Time.new(2018,11,04,01,01,00,'-04:00')) `
- Check the models time_column:
> model.time_column
=> Sun, 04 Nov 2018 01:01:00 EDT -04:00
- Reload the model
> model.reload
- Check the model's time_column
> model.time_column
=> Sun, 04 Nov 2018 01:01:00 EST -05:00
- Check the postgresql commandline:
``` sql
# select time_column from models where id = X; -- fictitious id
   time_column
------------------------
 2018-11-04 01:01:00-05
(1 row)
```
### System configuration
**Rails version**:
2.5 
**Ruby version**:
2.4

### Attempted workarounds
#### Add timezone to all db activities:
`config/initializers/time_formats.rb`
``` ruby
Time::DATE_FORMATS[:db] = lambda { |time|
  offset_format = time.formatted_offset(false)
  time.strftime(""%Y-%m-%d %H:%M:%S.%6N#{offset_format}"")
}
````
#### Broken by https://github.com/rails/rails/blob/master/activerecord/lib/active_record/connection_adapters/abstract/quoting.rb#L115

This appends the microseconds to the string after the offset format.

#### Final solution?
I will probably have to monkey patch which I hate. I don't see a good global resolution offhand unless there's a new approach for timestamp with timezone that is separate from timestamp without time zone?

Looking for other suggestions.",https://api.github.com/repos/rails/rails/issues/38189/timeline,,JasonHerr,1554154,MDQ6VXNlcjE1NTQxNTQ=,https://avatars.githubusercontent.com/u/1554154?v=4,,https://api.github.com/users/JasonHerr,https://github.com/JasonHerr,https://api.github.com/users/JasonHerr/followers,https://api.github.com/users/JasonHerr/following{/other_user},https://api.github.com/users/JasonHerr/gists{/gist_id},https://api.github.com/users/JasonHerr/starred{/owner}{/repo},https://api.github.com/users/JasonHerr/subscriptions,https://api.github.com/users/JasonHerr/orgs,https://api.github.com/users/JasonHerr/repos,https://api.github.com/users/JasonHerr/events{/privacy},https://api.github.com/users/JasonHerr/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38189/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
434,https://api.github.com/repos/rails/rails/issues/38157,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38157/labels{/name},https://api.github.com/repos/rails/rails/issues/38157/comments,https://api.github.com/repos/rails/rails/issues/38157/events,https://github.com/rails/rails/issues/38157,545385700,MDU6SXNzdWU1NDUzODU3MDA=,38157,"Modifing child model's instance variable triggers child model's validation at v5.2.3, but not v5.2.4","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2020-01-05T07:44:21Z,2021-07-17T13:22:05Z,,NONE,,"There is some breaking change for validations between v5.2.3 and v5.2.4.
When;

- there are 2 models (e.g. Foo and Bar),
- and Foo `has_one` Bar,
- and Foo has `accepts_nested_attributes_for :bar`,
- and Bar has an `attr_accessor` (e.g. name),
- and `foo.bar.name` is modified,
- and `foo.save` is called,

then the validation for `bar` is executed at v5.2.3, but not at v5.2.4.

I have no idea which behavior is ideal, but at least it seems this is a breaking change on patch version update.

### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""5.2.4""
  gem ""sqlite3"", ""~> 1.3.6""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :foos, force: true do |t|
  end

  create_table :bars, force: true do |t|
    t.integer :foo_id
  end
end

$count_validation = 0

class Foo < ActiveRecord::Base
  has_one :bar
  accepts_nested_attributes_for :bar
end

class Bar < ActiveRecord::Base
  belongs_to :foo
  attr_accessor :name
  before_validation -> { $count_validation += 1 }
end

class BugTest < Minitest::Test
  def test_association_stuff
    foo = Foo.create
    bar = foo.create_bar(name: ""old_name"")

    $count_validation = 0

    foo.bar.name = ""new_name""
    foo.save
    assert_equal 1, $count_validation
  end
end
```

### Expected behavior

* The behavior is consistent between v5.2.3 and v5.2.4
  * i.e. The validation for Bar is executed

### Actual behavior

* The behavior is *not* consistent between v5.2.3 and v5.2.4
    * i.e. The validation for Bar is *not* executed

### System configuration
**Rails version**:

* v5.2.3 and v5.2.4

**Ruby version**:

* ruby 2.6.5p114 (2019-10-01 revision 67812) [x86_64-darwin17]
",https://api.github.com/repos/rails/rails/issues/38157/timeline,,megane42,8451003,MDQ6VXNlcjg0NTEwMDM=,https://avatars.githubusercontent.com/u/8451003?v=4,,https://api.github.com/users/megane42,https://github.com/megane42,https://api.github.com/users/megane42/followers,https://api.github.com/users/megane42/following{/other_user},https://api.github.com/users/megane42/gists{/gist_id},https://api.github.com/users/megane42/starred{/owner}{/repo},https://api.github.com/users/megane42/subscriptions,https://api.github.com/users/megane42/orgs,https://api.github.com/users/megane42/repos,https://api.github.com/users/megane42/events{/privacy},https://api.github.com/users/megane42/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38157/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
435,https://api.github.com/repos/rails/rails/issues/38146,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38146/labels{/name},https://api.github.com/repos/rails/rails/issues/38146/comments,https://api.github.com/repos/rails/rails/issues/38146/events,https://github.com/rails/rails/pull/38146,544914769,MDExOlB1bGxSZXF1ZXN0MzU4OTIzNjU4,38146,Prevent deadlocks from touch callbacks on chained associations,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,19,2020-01-03T09:27:56Z,2022-02-23T23:17:15Z,,CONTRIBUTOR,,"Even with great care to arrange our model updates consistently within
transaction blocks, ActiveRecord could still cause deadlocks based on the
sequence of models needing to touch associations before commit.

The order that records are appended to the transaction callback array should be
sorted in a sequence that is:

1. Consistent between different transactions operating on the same tables, and
2. Least likely to conflict with the order of statements across different tables

Consider a simple hierarchy of Child belongs to Parent with touch: true. We can
easily create a situation where the deferred touches are listed out of order on
transaction records, based on different data conditions:

Transaction A

    Child.nice.each(&:send_gifts)
    # => [
    #   #<Child id: 1, parent_id: 1>,
    #   #<Child id: 2, parent_id: 2>
    # ]
    current_transaction.records
    # => [
    #   #<Parent id: 1>
    #   #<Parent id: 2>
    # ]

Transaction B

    Child.naughty.each(&:send_coal)
    # => [
    #   #<Child id: 3, parent_id: 2>,
    #   #<Child id: 4, parent_id: 1>
    # ]
    current_transaction.records
    # => [
    #   #<Parent id: 2>
    #   #<Parent id: 1>
    # ]

If these two transactions were to run concurrently, the `before_commit` callback
sequence could end up as:

|     | Transaction A             | Transaction B             |               |
| --- | ---                       | ---                       | ---           |
| 1   | UPDATE parents WHERE id=1 |                           | A locks row 1 |
| 2   |                           | UPDATE parents WHERE id=2 | B locks row 2 |
| 3   | UPDATE parents WHERE id=2 |                           | A waits for B |
| 4   |                           | UPDATE parents WHERE id=1 | B waits for A |

As each transaction is holding a row lock and waiting on the other to complete,
the database has no choice but to ROLLBACK one of these transactions with a
corresponding deadlock error.

To prevent this, we sort the transaction callback records in order of:

1. *Greatest depth* so when different associations reference a parent through
different paths, the deepest dependencies are applied first. This mostly mimics
the current implementation as associations get traversed upwards. (Polymorphic
associations are not counted for depth since they are indeterminate.)
2. *Table name* so different models that refer to the same table are applied
together in sequence, and not interleaved with other models.
3. *Primary key* as records from the same table can be listed for touch
callbacks in different order, they need to be updated in sequence.",https://api.github.com/repos/rails/rails/issues/38146/timeline,,avit,4278,MDQ6VXNlcjQyNzg=,https://avatars.githubusercontent.com/u/4278?v=4,,https://api.github.com/users/avit,https://github.com/avit,https://api.github.com/users/avit/followers,https://api.github.com/users/avit/following{/other_user},https://api.github.com/users/avit/gists{/gist_id},https://api.github.com/users/avit/starred{/owner}{/repo},https://api.github.com/users/avit/subscriptions,https://api.github.com/users/avit/orgs,https://api.github.com/users/avit/repos,https://api.github.com/users/avit/events{/privacy},https://api.github.com/users/avit/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38146/reactions,39,25,0,0,0,0,0,14,0,False,https://api.github.com/repos/rails/rails/pulls/38146,https://github.com/rails/rails/pull/38146,https://github.com/rails/rails/pull/38146.diff,https://github.com/rails/rails/pull/38146.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
436,https://api.github.com/repos/rails/rails/issues/38045,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38045/labels{/name},https://api.github.com/repos/rails/rails/issues/38045/comments,https://api.github.com/repos/rails/rails/issues/38045/events,https://github.com/rails/rails/issues/38045,540763801,MDU6SXNzdWU1NDA3NjM4MDE=,38045,The associated model became not validated,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,9,2019-12-20T05:08:17Z,2021-04-01T09:47:17Z,,NONE,,"After we upgraded Rails from 5.2.3 to 5.2.4, our test fails.
I guess AR's behavior was changed through #36671.

### Steps to reproduce

https://gist.github.com/hkdnet/9889e283c28f5994bd38e42c12ec3364

This test passes with `5.2.3`, `5.1.7` and `4.2.11.1`. But it fails with `5.2.4`.

### Expected behavior

This test passes.

### Actual behavior

Fails.

```
F

Finished in 0.013553s, 73.7844 runs/s, 73.7844 assertions/s.

  1) Failure:
T#test_case [repro.rb:69]:
Expected: false
  Actual: true

1 runs, 1 assertions, 1 failures, 0 errors, 0 skips
```

### System configuration
**Rails version**: 5.2.4

**Ruby version**: ruby 2.6.3p62 (2019-04-16 revision 67580) [x86_64-darwin18]
",https://api.github.com/repos/rails/rails/issues/38045/timeline,,hkdnet,11524757,MDQ6VXNlcjExNTI0NzU3,https://avatars.githubusercontent.com/u/11524757?v=4,,https://api.github.com/users/hkdnet,https://github.com/hkdnet,https://api.github.com/users/hkdnet/followers,https://api.github.com/users/hkdnet/following{/other_user},https://api.github.com/users/hkdnet/gists{/gist_id},https://api.github.com/users/hkdnet/starred{/owner}{/repo},https://api.github.com/users/hkdnet/subscriptions,https://api.github.com/users/hkdnet/orgs,https://api.github.com/users/hkdnet/repos,https://api.github.com/users/hkdnet/events{/privacy},https://api.github.com/users/hkdnet/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38045/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
437,https://api.github.com/repos/rails/rails/issues/38036,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38036/labels{/name},https://api.github.com/repos/rails/rails/issues/38036/comments,https://api.github.com/repos/rails/rails/issues/38036/events,https://github.com/rails/rails/issues/38036,540363365,MDU6SXNzdWU1NDAzNjMzNjU=,38036,Associated models are validated when there is a custom validation context,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,2,2019-12-19T14:55:56Z,2021-06-21T19:23:14Z,,NONE,,"### Steps to reproduce
After we upgraded from Rails 5.2.3 to Rails 5.2.4, one model cannot be saved due to validation errors. We found it was caused by the validation on an associated model which was not validated on Rails 5.2.3.

The problem is likely caused by the newly added `custom_validation_context?` boolean checking at https://github.com/rails/rails/pull/37295/files#diff-829fd5510b886395117cc530518ef7f7R273, which enforces validating associated collections when there is a custom validation context.

Sample code:
```
class Subscription
  validates :price, presence: true
end

class User
  has_many :subscriptions, dependent: :delete_all
end

# insert into a valid user record in the database and a subscription without price
user = User.first
user.subscriptions.first.valid? # this returns false
user.valid?(:registration_context) # this used to return true on Rails 5.2.3 and now returns false
```

### Expected behavior
Associated models should NOT be validated when there is no `validates_associated` for a relationship, as described in https://guides.rubyonrails.org/active_record_validations.html#validates-associated

### Actual behavior
Associated models are validated.

### System configuration
**Rails version**:
5.2.4
**Ruby version**:
2.6.3",https://api.github.com/repos/rails/rails/issues/38036/timeline,,jmao-wellframe,40397741,MDQ6VXNlcjQwMzk3NzQx,https://avatars.githubusercontent.com/u/40397741?v=4,,https://api.github.com/users/jmao-wellframe,https://github.com/jmao-wellframe,https://api.github.com/users/jmao-wellframe/followers,https://api.github.com/users/jmao-wellframe/following{/other_user},https://api.github.com/users/jmao-wellframe/gists{/gist_id},https://api.github.com/users/jmao-wellframe/starred{/owner}{/repo},https://api.github.com/users/jmao-wellframe/subscriptions,https://api.github.com/users/jmao-wellframe/orgs,https://api.github.com/users/jmao-wellframe/repos,https://api.github.com/users/jmao-wellframe/events{/privacy},https://api.github.com/users/jmao-wellframe/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38036/reactions,8,8,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
438,https://api.github.com/repos/rails/rails/issues/38027,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/38027/labels{/name},https://api.github.com/repos/rails/rails/issues/38027/comments,https://api.github.com/repos/rails/rails/issues/38027/events,https://github.com/rails/rails/issues/38027,539832778,MDU6SXNzdWU1Mzk4MzI3Nzg=,38027,Action Text pdf previews are missing in trix editor,"[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 1180817762, 'node_id': 'MDU6TGFiZWwxMTgwODE3NzYy', 'url': 'https://api.github.com/repos/rails/rails/labels/actiontext', 'name': 'actiontext', 'color': '3bc667', 'default': False, 'description': ''}]",open,False,,"[{'login': 'javan', 'id': 5355, 'node_id': 'MDQ6VXNlcjUzNTU=', 'avatar_url': 'https://avatars.githubusercontent.com/u/5355?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/javan', 'html_url': 'https://github.com/javan', 'followers_url': 'https://api.github.com/users/javan/followers', 'following_url': 'https://api.github.com/users/javan/following{/other_user}', 'gists_url': 'https://api.github.com/users/javan/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/javan/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/javan/subscriptions', 'organizations_url': 'https://api.github.com/users/javan/orgs', 'repos_url': 'https://api.github.com/users/javan/repos', 'events_url': 'https://api.github.com/users/javan/events{/privacy}', 'received_events_url': 'https://api.github.com/users/javan/received_events', 'type': 'User', 'site_admin': False}]",,6,2019-12-18T18:00:09Z,2022-02-24T08:25:37Z,,CONTRIBUTOR,,"PR #37868 seems to introduce regression where Action Text would try render PDFs as images, rather than using generated preview.

<img width=""1558"" alt=""Screenshot 2019-12-18 at 19 57 37"" src=""https://user-images.githubusercontent.com/1409998/71110797-aac25c80-21d0-11ea-962e-615b0904d5eb.png"">  

### Steps to reproduce

1. Clone https://github.com/rolandasb/action-text-bug
2. Visit `/posts`
3. Create a post with pdf attachment
4. Save & open edit post form

### Expected behavior
PDF preview should be shown.

### Actual behavior
Action Text tries to render PDF as an image.

### System configuration
**Rails version**: master

**Ruby version**: 2.6.5
",https://api.github.com/repos/rails/rails/issues/38027/timeline,,rolandasb,1409998,MDQ6VXNlcjE0MDk5OTg=,https://avatars.githubusercontent.com/u/1409998?v=4,,https://api.github.com/users/rolandasb,https://github.com/rolandasb,https://api.github.com/users/rolandasb/followers,https://api.github.com/users/rolandasb/following{/other_user},https://api.github.com/users/rolandasb/gists{/gist_id},https://api.github.com/users/rolandasb/starred{/owner}{/repo},https://api.github.com/users/rolandasb/subscriptions,https://api.github.com/users/rolandasb/orgs,https://api.github.com/users/rolandasb/repos,https://api.github.com/users/rolandasb/events{/privacy},https://api.github.com/users/rolandasb/received_events,User,False,https://api.github.com/repos/rails/rails/issues/38027/reactions,0,0,0,0,0,0,0,0,0,,,,,,,javan,5355.0,MDQ6VXNlcjUzNTU=,https://avatars.githubusercontent.com/u/5355?v=4,,https://api.github.com/users/javan,https://github.com/javan,https://api.github.com/users/javan/followers,https://api.github.com/users/javan/following{/other_user},https://api.github.com/users/javan/gists{/gist_id},https://api.github.com/users/javan/starred{/owner}{/repo},https://api.github.com/users/javan/subscriptions,https://api.github.com/users/javan/orgs,https://api.github.com/users/javan/repos,https://api.github.com/users/javan/events{/privacy},https://api.github.com/users/javan/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
439,https://api.github.com/repos/rails/rails/issues/37944,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37944/labels{/name},https://api.github.com/repos/rails/rails/issues/37944/comments,https://api.github.com/repos/rails/rails/issues/37944/events,https://github.com/rails/rails/pull/37944,536810238,MDExOlB1bGxSZXF1ZXN0MzUyMjc1ODkx,37944,"Common Table Expression support added ""out-of-the-box""","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,32,2019-12-12T07:45:12Z,2022-04-19T15:39:20Z,,CONTRIBUTOR,,"### Summary

This PR adds `.with` query method which makes it super easy to build complex queries with Common Table Expressions.

It basically just ""wraps"" the passed arguments in the way `Arel::SelectManager.with` expects it. The biggest advantages this brings are: 

* You can just use standard ActiveRecord relations instead of manually building `Arel::Nodes::As` nodes
* It returns `ActiveRecord::Relation` so you don't loose any flexibility

See example below:

```ruby
Post.with(
  posts_with_comments: Post.where(""comments_count > ?"", 0),
  posts_with_tags: Post.where(""tags_count > ?"", 0)
)

# Replaces

posts_with_comments_table = Arel::Table.new(:posts_with_comments)
posts_with_comments_expression = Post.arel_table.where(posts_with_comments_table[:comments_count].gt(0))
posts_with_tags_table = Arel::Table.new(:posts_with_tags)
posts_with_tags_expression = Post.arel_table.where(posts_with_tags_table[:tags_count].gt(0))

Post.all.arel.with([
  Arel::Nodes::As.new(posts_with_comments_table, posts_with_comments_expression),
  Arel::Nodes::As.new(posts_with_tags_table, posts_with_tags_expression)
])
# WITH posts_with_comments AS (
#   SELECT * FROM posts WHERE (comments_count > 0)
# ), posts_with_tags AS (
#   SELECT * FROM posts WHERE (tags_count > 0)
# )
# SELECT * FROM posts
```",https://api.github.com/repos/rails/rails/issues/37944/timeline,,vlado,5148,MDQ6VXNlcjUxNDg=,https://avatars.githubusercontent.com/u/5148?v=4,,https://api.github.com/users/vlado,https://github.com/vlado,https://api.github.com/users/vlado/followers,https://api.github.com/users/vlado/following{/other_user},https://api.github.com/users/vlado/gists{/gist_id},https://api.github.com/users/vlado/starred{/owner}{/repo},https://api.github.com/users/vlado/subscriptions,https://api.github.com/users/vlado/orgs,https://api.github.com/users/vlado/repos,https://api.github.com/users/vlado/events{/privacy},https://api.github.com/users/vlado/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37944/reactions,29,24,0,0,0,0,1,0,4,False,https://api.github.com/repos/rails/rails/pulls/37944,https://github.com/rails/rails/pull/37944,https://github.com/rails/rails/pull/37944.diff,https://github.com/rails/rails/pull/37944.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
440,https://api.github.com/repos/rails/rails/issues/37875,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37875/labels{/name},https://api.github.com/repos/rails/rails/issues/37875/comments,https://api.github.com/repos/rails/rails/issues/37875/events,https://github.com/rails/rails/issues/37875,532287987,MDU6SXNzdWU1MzIyODc5ODc=,37875,Bring Many monad to Active Support and Active Record relations,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,9,2019-12-03T21:47:14Z,2022-02-15T01:30:31Z,,MEMBER,,"Inspired by @tomstuart's lovely [talk on monads in Ruby](https://codon.com/refactoring-ruby-with-monads), I'd like to dip our feet in with Rails on the Many monad.

Tom has [gracefully permitted](https://twitter.com/tomstuart/status/1201964366540787712) us to copy his work from the monads gem into Active Support as needed. The API I'm most keen to see is the one that allows us to use the Many monad with Active Record relations, like so:

```ruby
Blogs.all.with_many.categories.posts.comments.body.split(/\s+/).values
```

It's a huge level up over the flat_map version:

```ruby
Blogs.all.flat_map(:categories).flat_map(:posts).flat_map(:comments).flat_map(:body).split(/\s+/).values
```

I've wanted this for a very long time, but could think of the right way to express it. The monad is the way!

So to make this work, I'd propose that we pull in the Maybe monad into Active Support, then do a core extension for Enumerable called #with_many, and then making sure that plays nicely with the AR relations (I think it should, out of the box). ",https://api.github.com/repos/rails/rails/issues/37875/timeline,,dhh,2741,MDQ6VXNlcjI3NDE=,https://avatars.githubusercontent.com/u/2741?v=4,,https://api.github.com/users/dhh,https://github.com/dhh,https://api.github.com/users/dhh/followers,https://api.github.com/users/dhh/following{/other_user},https://api.github.com/users/dhh/gists{/gist_id},https://api.github.com/users/dhh/starred{/owner}{/repo},https://api.github.com/users/dhh/subscriptions,https://api.github.com/users/dhh/orgs,https://api.github.com/users/dhh/repos,https://api.github.com/users/dhh/events{/privacy},https://api.github.com/users/dhh/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37875/reactions,43,0,0,0,0,8,31,0,4,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
441,https://api.github.com/repos/rails/rails/issues/37807,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37807/labels{/name},https://api.github.com/repos/rails/rails/issues/37807/comments,https://api.github.com/repos/rails/rails/issues/37807/events,https://github.com/rails/rails/pull/37807,528998613,MDExOlB1bGxSZXF1ZXN0MzQ1OTU3MzE1,37807,Fix first and last when records are not loaded in a sorted relationship,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,16,2019-11-26T22:07:48Z,2022-04-18T07:25:29Z,,NONE,,"### Summary

Fix `last` and `first` methods on a sorted relationship with elements with the same order criteria.

A test was added in https://github.com/rails/rails/pull/37807/commits/9863eae78f095a9d3dd9cd88a867b61d8844df6d and is failing with current implementation, for all databases tests, i.e.:

<img width=""1129"" alt=""image"" src=""https://user-images.githubusercontent.com/570991/69701553-7a196680-10ed-11ea-84d4-543ffa36c4d5.png"">

The underlying problem is that `first` and `last` when the relationship is not loaded in the parent record uses an optimization based on the database to retrieve the items. The optimization applies correctly the order criteria and also a `LIMIT` clause to minimize the retrieved data to only the amount of records requested (1 by default, but can be used for `.last(4)`).

The solution proposed is to add the default ordering criteria (based on `implicit_order_column` and `primary_key`) to disambiguate the sorting on the database.

### Related issues

This PR adds a second column for `implicit_order_column` => https://github.com/rails/rails/pull/37626? Am I duplicating the solution and it's already solved? @pawurb?

Probably solving this issue #36475?

No, after reproducing the case with the fix applies is still failing.",https://api.github.com/repos/rails/rails/issues/37807/timeline,,GermanDZ,570991,MDQ6VXNlcjU3MDk5MQ==,https://avatars.githubusercontent.com/u/570991?v=4,,https://api.github.com/users/GermanDZ,https://github.com/GermanDZ,https://api.github.com/users/GermanDZ/followers,https://api.github.com/users/GermanDZ/following{/other_user},https://api.github.com/users/GermanDZ/gists{/gist_id},https://api.github.com/users/GermanDZ/starred{/owner}{/repo},https://api.github.com/users/GermanDZ/subscriptions,https://api.github.com/users/GermanDZ/orgs,https://api.github.com/users/GermanDZ/repos,https://api.github.com/users/GermanDZ/events{/privacy},https://api.github.com/users/GermanDZ/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37807/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/37807,https://github.com/rails/rails/pull/37807,https://github.com/rails/rails/pull/37807.diff,https://github.com/rails/rails/pull/37807.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
442,https://api.github.com/repos/rails/rails/issues/37724,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37724/labels{/name},https://api.github.com/repos/rails/rails/issues/37724/comments,https://api.github.com/repos/rails/rails/issues/37724/events,https://github.com/rails/rails/pull/37724,523191363,MDExOlB1bGxSZXF1ZXN0MzQxMjQ1NTQ2,37724,Add first & last_id segments to collection cache_version,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,28,2019-11-15T00:53:54Z,2022-02-14T14:15:18Z,,CONTRIBUTOR,,"### Summary

In collections with a limit, including the IDs of the first and last records when generating a collection's cache version ensures correct cache key expiration after a record is deleted. Prior to this commit, collection cache versions only include the collection's size and maximum updated_at timestamp, e.g.:

    ""#{collection_size}-#{max_updated_at_timestamp}""

To demonstrate why this isn't robust enough, consider the following database table:

    Employee.all

    SELECT * FROM employees;
    +----+-------+---------------------+---------------------+
    | id | name  | created_at          | updated_at          |
    +----+-------+---------------------+---------------------+
    |  1 | alice | 2019-11-01 00:00:00 | 2019-11-01 00:00:00 |
    |  2 | carol | 2019-11-02 00:00:00 | 2019-11-02 00:00:00 |
    |  3 | doug  | 2019-11-03 00:00:00 | 2019-11-03 00:00:00 |
    |  4 | bob   | 2019-11-04 00:00:00 | 2019-11-04 00:00:00 |
    +----+-------+---------------------+---------------------+

Select the first three employees sorted alphabetically:

    employees = Employee.order(:name).limit(3)

    SELECT * FROM employees ORDER BY name ASC LIMIT 3;
    +----+-------+---------------------+---------------------+
    | id | name  | created_at          | updated_at          |
    +----+-------+---------------------+---------------------+
    |  1 | alice | 2019-11-01 00:00:00 | 2019-11-01 00:00:00 |
    |  4 | bob   | 2019-11-04 00:00:00 | 2019-11-04 00:00:00 |
    |  2 | carol | 2019-11-02 00:00:00 | 2019-11-02 00:00:00 |
    +----+-------+---------------------+---------------------+

Note the collection's size (3) and max updated_at timestamp (2019-11-04 00:00:00), both of which are used to compose the cache version:

    employees.cache_version
    # => ""3-20191104000000""

Now, delete an employee:

    Employee.find_by(name: ""alice"").destroy

    DELETE FROM employees WHERE name = ""alice"";

Re-run the original query:

    employees = Employee.order(:name).limit(3)

    SELECT * FROM employees ORDER BY name ASC LIMIT 3;
    +----+-------+---------------------+---------------------+
    | id | name  | created_at          | updated_at          |
    +----+-------+---------------------+---------------------+
    |  4 | bob   | 2019-11-04 00:00:00 | 2019-11-04 00:00:00 |
    |  2 | carol | 2019-11-02 00:00:00 | 2019-11-02 00:00:00 |
    |  3 | doug  | 2019-11-03 00:00:00 | 2019-11-03 00:00:00 |
    +----+-------+---------------------+---------------------+

Note that while the collection's contents have changed, its size and maximum updated_at timestamp remain the same, resulting in the cache_version failing to correctly expire:

    employees.cache_version
    # => ""3-20191104000000""

Including the ID of the first and last record in a collection fixes this problem - when deleting a record from a collection with a limit (or some other combination of inserts/updates/deletes), either the collection size will shrink, its max updated_at timestamp will increase, or one of its bounding IDs will change.

If a collection is loaded, determining the IDs of its first and last records is straightforward:

    employees = Employee.limit(3)
    first_id = employees.size > 0 ? employees.first.id : nil
    last_id = employees.size > 0 ? employees.last.id : nil

If a collection isn't loaded, this commit uses SQL common table expressions (for SQLite and PostgreSQL databases) or user-defined variables (for MySQL databases) to determine the last record's ID. Example SQL queries below (table aliases shortened for readability):

    -- PostgreSQL/SQLite
    WITH
      col AS
        (SELECT id, updated_at FROM employees ORDER BY name ASC LIMIT 3),
      agg AS
        (SELECT COUNT(*) AS size, MAX(updated_at) AS timestamp FROM col)
    SELECT
      size,
      timestamp,
      (SELECT id FROM col LIMIT 1) AS first_id,
      (SELECT id FROM col LIMIT 1 OFFSET
        GREATEST((SELECT size FROM agg) - 1, 0)) AS last_id
    FROM agg;

    -- MySQL
    SET @first_id := NULL, @last_id := NULL;
    SELECT
      COUNT(*) AS collection_size,
      MAX(updated_at) AS timestamp,
      @first_id AS first_id,
      @last_id AS last_id
    FROM (
      SELECT
        @first_id := COALESCE(@first_id, id),
        @last_id := id,
        updated_at
      FROM employees
      ORDER BY name ASC LIMIT 3
    ) col;

    +------+---------------------+----------+---------+
    | size | timestamp           | first_id | last_id |
    +------+---------------------+----------+---------+
    |    3 | 2019-11-04 00:00:00 |        4 |       3 |
    +------+---------------------+----------+---------+

Fixes #31996, #34408 and #37555.

### Benchmarks

This change has a negligible impact on common use-cases (e.g. paginating records). For very large collections (~100k+ records for Postgres, ~10k+ for MySQL), generating cache_versions takes an estimated 1.75 times longer for Postgres, and 2.75 for MySQL. However, this change should not impact the overall time complexity which should remain linear in regard to the limit/collection size.

Here are some charts (with linear and logarithmic x axes) visualizing the results of my benchmarking (full script and raw results further below):

https://docs.google.com/spreadsheets/d/1d9u7vPh7AD8ArD4krRY7esWsvoBP1eK925prOH4c1uU/edit?folder=0AL-x-3mNk-iPUk9PVA#gid=1452480752

Log charts:

![postgres log chart](https://docs.google.com/spreadsheets/d/e/2PACX-1vTvSS1smbMOibaMpOLHr1ryO6aun0VZzTsJsDe4M2gWGdWZ6BywGZtGvDA_neH1-7rhK77A9NqQS9WB/pubchart?oid=1118001582&format=image)

![mysql log chart](https://docs.google.com/spreadsheets/d/e/2PACX-1vTvSS1smbMOibaMpOLHr1ryO6aun0VZzTsJsDe4M2gWGdWZ6BywGZtGvDA_neH1-7rhK77A9NqQS9WB/pubchart?oid=345571619&format=image)

Linear charts:

![postgres log chart](https://docs.google.com/spreadsheets/d/e/2PACX-1vTvSS1smbMOibaMpOLHr1ryO6aun0VZzTsJsDe4M2gWGdWZ6BywGZtGvDA_neH1-7rhK77A9NqQS9WB/pubchart?oid=133526580&format=image)

![mysql log chart](https://docs.google.com/spreadsheets/d/e/2PACX-1vTvSS1smbMOibaMpOLHr1ryO6aun0VZzTsJsDe4M2gWGdWZ6BywGZtGvDA_neH1-7rhK77A9NqQS9WB/pubchart?oid=1389627901&format=image)

### Other changes

This commit updates the signatures of `ActiveRecord::Relation#cache_version`, `#cache_key` and related methods to use keyword instead of positional arguments, as said methods now accept multiple optional arguments. In order to avoid breaking changes, both methods still accept positional arguments, but will raise deprecation warnings if passed.

### Other considered solutions

In writing this commit, I reviewed other potential solutions to this issue, particularly https://github.com/rails/rails/pull/21503. Most other solutions detected changes to a collection via either a checksum of its IDs, or a hash digest of a string of concatenated IDs. I leaned away from this approach for several reasons:

1. SQLite doesn't have an MD5 function.
2. It's inefficient for very large collections, taking about four times longer than the current approach. (Although the overall time complexity appears equivalent.)
3. For HABTM relations where neither model's updated_at columns are touched when associations are created or destroyed, an ID checksum covers one additional use case: On a query like `@project.employees`, an ID checksum would detect changes to a project's employees even when the collection size, max updated_at timestamp and bounding IDs remain the same. However, an ID checksum *won't* cover the most basic use case of Russian doll caching: consider a cached collection of projects each with an inner-nested cached collection of employees - changes to a project's employees fails to expire the outer cached fragment. Thus, I don't find that the ID checksum approach provides a comprehensive advantage.

### Benchmarking Script + results

For the purposes of Benchmarking, I provisioned Postgres and MySQL databases through Heroku's add-ons. For Postgres, I used a ""Standard-0"" tier DB with 4 GB ram. For MySQL, I used a JawsSB ""Whitetip"" tier DB with 1 GB of ram. (Both services are backed by AWS.)

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails""
  gem ""benchmark-ips""
  gem ""pg""
  gem ""mysql2""
end

require ""active_record""
require ""logger""

ActiveRecord::Base.establish_connection({
  # redacted
})

ActiveRecord::Base.collection_cache_versioning = true

class ActiveRecord::Relation
  def cache_version_new(deprecated_timestamp_column = nil, id_column: primary_key, timestamp_column: :updated_at)
    if deprecated_timestamp_column
      ActiveSupport::Deprecation.warn(""Passing a timestamp column as a positional argument to ActiveRecord::Relation#cache_version is deprecated. Please use a `:timestamp_column` keyword argument instead."")
      timestamp_column = deprecated_timestamp_column
    end

    if collection_cache_versioning
      @cache_versions_new ||= {}
      @cache_versions_new[[id_column, timestamp_column]] ||= compute_cache_version_new(id_column: id_column, timestamp_column: timestamp_column)
    end
  end

  def compute_cache_version_new(id_column: primary_key, timestamp_column: :updated_at) # :nodoc:
    size = 0
    first_id = nil
    last_id = nil
    timestamp = nil

    if loaded? || distinct_value
      size = records.size

      if size > 0
        timestamp = max_by(&timestamp_column)._read_attribute(timestamp_column).utc.to_s(cache_timestamp_format)

        if has_limit_or_offset?
          first_id = first._read_attribute(id_column)
          last_id = last._read_attribute(id_column)
        end
      end
    else
      collection = eager_loading? ? apply_join_dependency : self
      timestamp_col = connection.visitor.compile(arel_attribute(timestamp_column))
      id_col = connection.visitor.compile(arel_attribute(id_column))

      if collection.has_limit_or_offset?
        case connection.adapter_name
        when ""PostgreSQL"", ""SQLite""
          collection_table = Arel::Table.new(""cache_key_collection"")
          aggregates_table = Arel::Table.new(""cache_key_aggregates"")
          query = collection.select(""#{id_col} AS collection_cache_key_id, #{timestamp_col} AS collection_cache_key_timestamp"")
          collection_query = Arel::Nodes::SqlLiteral.new ""(#{ query.to_sql })""
          aggregates_query = collection_table.project(""COUNT(*) AS collection_size, MAX(collection_cache_key_timestamp) AS timestamp"")
          collection_common_table_expr = Arel::Nodes::As.new(collection_table, collection_query)
          aggregates_common_table_expr = Arel::Nodes::As.new(aggregates_table, aggregates_query)

          collection_size_minus_one = Arel::Nodes::Subtraction.new(aggregates_table[:collection_size], 1)
          last_id_offset = connection.adapter_name == ""PostgreSQL"" ?
            Arel::Nodes::NamedFunction.new(""GREATEST"", [collection_size_minus_one, 0]) :
            aggregates_table.project(collection_size_minus_one)

          select_values = [
            aggregates_table[:collection_size],
            aggregates_table[:timestamp],
            collection_table.project(collection_table[:collection_cache_key_id]).take(1).as(""first_id""),
            collection_table.project(collection_table[:collection_cache_key_id]).take(1).skip(last_id_offset).as(""last_id"")
          ]

          arel = aggregates_table
            .project(select_values)
            .with(collection_common_table_expr, aggregates_common_table_expr)
        when ""Mysql2""
          select_values = ""COUNT(*) AS collection_size, @first_id AS first_id, @last_id AS last_id, MAX(collection_cache_key_timestamp) AS timestamp""
          query = collection.select(""COALESCE(@first_id, @first_id := #{id_col}), @last_id := #{id_col}, #{timestamp_col} AS collection_cache_key_timestamp"")
          subquery_alias = ""subquery_for_cache_key""
          arel = query.build_subquery(subquery_alias, select_values)
        else
          select_values = ""COUNT(*) AS collection_size, MAX(#{timestamp_col}) AS timestamp""
          query = collection.select(""#{timestamp_col} AS collection_cache_key_timestamp"")
          subquery_alias = ""subquery_for_cache_key""
          arel = query.build_subquery(subquery_alias, select_values)
        end
      else
        select_values = ""COUNT(*) AS collection_size, MAX(#{timestamp_col}) AS timestamp""
        query = collection.unscope(:order)
        query.select_values = [select_values]
        arel = query.arel
      end

      result = nil

      connection_pool.with_connection do
        if connection.adapter_name == ""Mysql2"" && collection.has_limit_or_offset?
          connection.execute(""SET @first_id := @last_id := NULL"")
        end

        result = connection.select_one(arel, nil)
      end

      if result
        column_type = klass.type_for_attribute(timestamp_column)
        size = result[""collection_size""]

        if size > 0
          first_id = result[""first_id""]
          last_id = result[""last_id""]
          timestamp = column_type.deserialize(result[""timestamp""]).utc.to_s(cache_timestamp_format)
        end
      end
    end

    [size, first_id, last_id, timestamp].reject(&:blank?).join(""-"")
  end
  private :compute_cache_version_new
end

ActiveRecord::Schema.define do
  create_table :users, if_not_exists: true do |t|
    t.string :name
    t.timestamps
  end
end

class User < ActiveRecord::Base
end

# Seed database with two million records
if User.first.nil?
  r = 2_000_000
  t = 5.years.ago.to_i
  now = Time.now.to_i
  pct = 0.0

  puts ""initializing test records""

  (1..r).map { |n| {
    id: n,
    name: SecureRandom.alphanumeric(5 + rand(12)),
    created_at: Time.at(t += (now - t) / (1 + r - n)),
    updated_at: Time.at(rand(t..now+1))
  } }.each_slice(20_000) { |slice|
    puts ""seeding DB"" if pct == 0.0
    User.insert_all(slice)
    puts ""#{pct+=1}%""
  }
end

Benchmark.ips do |benchmark|
  benchmark.config(warmup: 0, time: 120)

  limits = [10, 100, 1000, 10000, 100000, 200000, 400000, 600000, 800000, 1000000]
  orders = [:asc, :desc]
  offsets = (0..1_000_000).step(250_000)

  limits.each do |limit|
    benchmark.report(""current cache_version, limit #{limit}"") do
      orders.each do |order|
        offsets.each do |offset|
          User.order(id: order).limit(limit).offset(offset).cache_version
        end
      end
    end

    benchmark.report(""w/ first & last ID, limit #{limit}"") do
      orders.each do |order|
        offsets.each do |offset|
          User.order(id: order).limit(limit).offset(offset).cache_version_new
        end
      end
    end
  end
end
```

results:

```
Postgres
Calculating -------------------------------------
current cache_version, limit 10
                          0.457  (± 0.0%) i/s -     53.000  in 120.940372s
w/ first & last ID, limit 10
                          0.630  (± 0.0%) i/s -     74.000  in 120.222423s
current cache_version, limit 100
                          0.555  (± 0.0%) i/s -     66.000  in 121.112922s
w/ first & last ID, limit 100
                          0.622  (± 0.0%) i/s -     71.000  in 120.100475s
current cache_version, limit 1000
                          0.473  (± 0.0%) i/s -     55.000  in 120.244607s
w/ first & last ID, limit 1000
                          0.627  (± 0.0%) i/s -     71.000  in 120.659220s
current cache_version, limit 10000
                          0.442  (± 0.0%) i/s -     52.000  in 121.285019s
w/ first & last ID, limit 10000
                          0.561  (± 0.0%) i/s -     64.000  in 120.059518s
current cache_version, limit 100000
                          0.431  (± 0.0%) i/s -     51.000  in 121.234291s
w/ first & last ID, limit 100000
                          0.410  (± 0.0%) i/s -     48.000  in 120.316814s
current cache_version, limit 200000
                          0.406  (± 0.0%) i/s -     49.000  in 121.883819s
w/ first & last ID, limit 200000
                          0.303  (± 0.0%) i/s -     37.000  in 122.960886s
current cache_version, limit 400000
                          0.315  (± 0.0%) i/s -     38.000  in 121.148364s
w/ first & last ID, limit 400000
                          0.223  (± 0.0%) i/s -     27.000  in 121.430635s
current cache_version, limit 600000
                          0.266  (± 0.0%) i/s -     32.000  in 120.808200s
w/ first & last ID, limit 600000
                          0.168  (± 0.0%) i/s -     21.000  in 125.029394s
current cache_version, limit 800000
                          0.236  (± 0.0%) i/s -     29.000  in 123.167375s
w/ first & last ID, limit 800000
                          0.140  (± 0.0%) i/s -     17.000  in 121.361332s
current cache_version, limit 1000000
                          0.208  (± 0.0%) i/s -     26.000  in 125.224578s
w/ first & last ID, limit 1000000
                          0.120  (± 0.0%) i/s -     15.000  in 125.416142s

MySQL
current cache_version, limit 10
                          0.400  (± 0.0%) i/s -     46.000  in 120.437852s
w/ first & last ID, limit 10
                          0.429  (± 0.0%) i/s -     51.000  in 121.507532s
current cache_version, limit 100
                          0.380  (± 0.0%) i/s -     45.000  in 122.325720s
w/ first & last ID, limit 100
                          0.426  (± 0.0%) i/s -     51.000  in 122.081295s
current cache_version, limit 1000
                          0.436  (± 0.0%) i/s -     50.000  in 121.347133s
w/ first & last ID, limit 1000
                          0.422  (± 0.0%) i/s -     50.000  in 120.497030s
current cache_version, limit 10000
                          0.424  (± 0.0%) i/s -     49.000  in 120.461740s
w/ first & last ID, limit 10000
                          0.395  (± 0.0%) i/s -     46.000  in 120.202285s
current cache_version, limit 100000
                          0.304  (± 0.0%) i/s -     35.000  in 120.550654s
w/ first & last ID, limit 100000
                          0.198  (± 0.0%) i/s -     24.000  in 122.127827s
current cache_version, limit 200000
                          0.215  (± 0.0%) i/s -     26.000  in 122.966909s
w/ first & last ID, limit 200000
                          0.150  (± 0.0%) i/s -     18.000  in 120.493927s
current cache_version, limit 400000
                          0.173  (± 0.0%) i/s -     21.000  in 121.901465s
w/ first & last ID, limit 400000
                          0.100  (± 0.0%) i/s -     12.000  in 120.903169s
current cache_version, limit 600000
                          0.156  (± 0.0%) i/s -     19.000  in 122.053916s
w/ first & last ID, limit 600000
                          0.079  (± 0.0%) i/s -     10.000  in 126.504833s
current cache_version, limit 800000
                          0.147  (± 0.0%) i/s -     18.000  in 123.154995s
w/ first & last ID, limit 800000
                          0.062  (± 0.0%) i/s -      8.000  in 128.516317s
current cache_version, limit 1000000
                          0.129  (± 0.0%) i/s -     16.000  in 124.396169s
w/ first & last ID, limit 1000000
                          0.048  (± 0.0%) i/s -      6.000  in 126.030320s
```",https://api.github.com/repos/rails/rails/issues/37724/timeline,,alipman88,3922511,MDQ6VXNlcjM5MjI1MTE=,https://avatars.githubusercontent.com/u/3922511?v=4,,https://api.github.com/users/alipman88,https://github.com/alipman88,https://api.github.com/users/alipman88/followers,https://api.github.com/users/alipman88/following{/other_user},https://api.github.com/users/alipman88/gists{/gist_id},https://api.github.com/users/alipman88/starred{/owner}{/repo},https://api.github.com/users/alipman88/subscriptions,https://api.github.com/users/alipman88/orgs,https://api.github.com/users/alipman88/repos,https://api.github.com/users/alipman88/events{/privacy},https://api.github.com/users/alipman88/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37724/reactions,6,0,0,0,0,0,6,0,0,False,https://api.github.com/repos/rails/rails/pulls/37724,https://github.com/rails/rails/pull/37724,https://github.com/rails/rails/pull/37724.diff,https://github.com/rails/rails/pull/37724.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
443,https://api.github.com/repos/rails/rails/issues/37555,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37555/labels{/name},https://api.github.com/repos/rails/rails/issues/37555/comments,https://api.github.com/repos/rails/rails/issues/37555/events,https://github.com/rails/rails/issues/37555,512150051,MDU6SXNzdWU1MTIxNTAwNTE=,37555,Modified Active Record collections may return same cache_version when using limit,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,11,2019-10-24T19:57:37Z,2021-02-22T10:08:11Z,,NONE,,"Active Record collections might generate the same `cache_key` and `cache_version` despite containing different records. This can happen when you use `limit` (e.g. for pagination) and destroy one of the collection's records, as long as it's not the most recent one.

This way `cache_key` stays the same because the query is unchanged, and `cache_version` is the same because the collection size is the same (due to limit) and max(updated_at) is untouched too.

### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
    t.timestamps
  end
end

class Post < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_cache_version
    6.times { Post.create }

    posts = Post.order(created_at: :desc).limit(3)

    ids_1 = posts.pluck(:id)
    cache_key_1 = posts.cache_key
    cache_version_1 = posts.cache_version

    posts.second.destroy
    posts = Post.order(created_at: :desc).limit(3)

    ids_2 = posts.pluck(:id)
    cache_key_2 = posts.cache_key
    cache_version_2 = posts.cache_version

    assert(ids_1 != ids_2)
    assert_equal cache_key_1, cache_key_2
    assert(cache_version_1 != cache_version_2)
  end
end
```

Example app available as well: https://github.com/marckohlbrugge/rails-6-collection-caching-bug

### Expected behavior

I expect `collection.cache_version` to be different if the `collection` has changed.

### Actual behavior

`collection.cache_version` remains unchanged.

### System configuration

**Rails version**: 6.0.0
**Ruby version**: 2.6.3p62

### Related (but closed) issues

https://github.com/rails/rails/issues/34408 https://github.com/rails/rails/issues/31996 https://github.com/rails/rails/issues/34093",https://api.github.com/repos/rails/rails/issues/37555/timeline,,marckohlbrugge,93276,MDQ6VXNlcjkzMjc2,https://avatars.githubusercontent.com/u/93276?v=4,,https://api.github.com/users/marckohlbrugge,https://github.com/marckohlbrugge,https://api.github.com/users/marckohlbrugge/followers,https://api.github.com/users/marckohlbrugge/following{/other_user},https://api.github.com/users/marckohlbrugge/gists{/gist_id},https://api.github.com/users/marckohlbrugge/starred{/owner}{/repo},https://api.github.com/users/marckohlbrugge/subscriptions,https://api.github.com/users/marckohlbrugge/orgs,https://api.github.com/users/marckohlbrugge/repos,https://api.github.com/users/marckohlbrugge/events{/privacy},https://api.github.com/users/marckohlbrugge/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37555/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
444,https://api.github.com/repos/rails/rails/issues/37524,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37524/labels{/name},https://api.github.com/repos/rails/rails/issues/37524/comments,https://api.github.com/repos/rails/rails/issues/37524/events,https://github.com/rails/rails/issues/37524,510400459,MDU6SXNzdWU1MTA0MDA0NTk=,37524,ActiveRecord::PendingMigrationError is not raised when non-primary database migration is down with multi-db,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,3,2019-10-22T02:51:55Z,2022-03-15T12:59:48Z,,NONE,,"### Steps to reproduce
ActiveRecord::PendingMigrationError is not raised when non-primary database migrations are down with multi-db.

config database.yml 

```
development:
  backbone:
    <<: *default
    database: backbone_development
  library:
    <<: *default
    database: library_development
    migrations_paths: db/library_migrate
```

run the following
```
bin/rails g scaffold User title 
bin/rails g scaffold Book title --db library
bin/rails db:create db:migrate
bin/rails s
# in another console
bin/rails g migration add_published_at_to_books published_at:datetime --db library
```
access http://localhost:3000/users or http://localhost:3000/books

### Expected behavior
Raise ActiveRecord::PendingMigrationError because add_published_at_to_books migration status is down

```
$ bin/rails db:migrate:status

database: backbone_development
 Status   Migration ID    Migration Name
--------------------------------------------------
   up     20191022014341  Create users

database: library_development

 Status   Migration ID    Migration Name
--------------------------------------------------
   up     20191022023152  Create books
  down    20191022023755  Add published at to books
```

```
$ rails db:abort_if_pending_migrations
You have 1 pending migration:
  20191022023755 AddPublishedAtToBooks
Run `rails db:migrate` to update your database then try again.
```
### Actual behavior
There is no error

### System configuration
Rails 6.0.0
Ruby 2.6.5",https://api.github.com/repos/rails/rails/issues/37524/timeline,,suketa,80150,MDQ6VXNlcjgwMTUw,https://avatars.githubusercontent.com/u/80150?v=4,,https://api.github.com/users/suketa,https://github.com/suketa,https://api.github.com/users/suketa/followers,https://api.github.com/users/suketa/following{/other_user},https://api.github.com/users/suketa/gists{/gist_id},https://api.github.com/users/suketa/starred{/owner}{/repo},https://api.github.com/users/suketa/subscriptions,https://api.github.com/users/suketa/orgs,https://api.github.com/users/suketa/repos,https://api.github.com/users/suketa/events{/privacy},https://api.github.com/users/suketa/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37524/reactions,0,0,0,0,0,0,0,0,0,,,,,,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,https://api.github.com/repos/rails/rails/milestones/81,https://github.com/rails/rails/milestone/81,https://api.github.com/repos/rails/rails/milestones/81/labels,7591006.0,MI_kwDNIULOAHPUXg,81.0,7.0.2,,rafaelfranca,47848.0,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,1.0,2.0,open,2022-01-20T01:51:07Z,2022-03-15T12:59:48Z,,
445,https://api.github.com/repos/rails/rails/issues/37270,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37270/labels{/name},https://api.github.com/repos/rails/rails/issues/37270/comments,https://api.github.com/repos/rails/rails/issues/37270/events,https://github.com/rails/rails/issues/37270,496901128,MDU6SXNzdWU0OTY5MDExMjg=,37270,Rails 6 inconsistently overrides ActiveJob queue_adapter setting with TestAdapter,"[{'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,[],,41,2019-09-23T05:29:13Z,2021-12-14T18:24:44Z,,CONTRIBUTOR,,"### Summary

Like many folks, I set this in my `config/environments/test.rb` file:

```ruby
config.active_job.queue_adapter = :inline  
```

The reason I do this is to have easy-to-test, deterministic behavior of any potentially async delayed jobs triggered by the application. Under Rails 5, all of my tests (children of `ActiveSupport::TestCase` and `ActionDispatch::SystemTestCase` alike) would respect this queue adapter. However, under Rails 6, any built-in Rails test case that includes `ActiveJob::TestHelper` will also override this setting for all descendants of `ActiveJob::Base` ([relevant source](https://github.com/rails/rails/blob/master/activejob/lib/active_job/test_helper.rb#L39-L41)).

The net effect of this is that my `perform_later` and `deliver_later` calls to jobs aren't being fired synchronously (or, in fact, at all) during my system tests, which is leading to test failures upon upgrading to Rails 6.

### Steps to reproduce

Here are two tests that demonstrates the problem:

```ruby
require ""test_helper""

class JobTest < ActiveSupport::TestCase
  class SomeJob < ActiveJob::Base
    cattr_accessor :job_ran

    def perform
      @@job_ran = true
    end
  end

  def test_some_job
    assert_equal :inline, Rails.application.config.active_job.queue_adapter
    assert_equal ActiveJob::QueueAdapters::InlineAdapter, SomeJob.queue_adapter.class

    SomeJob.perform_later

    assert_equal true, SomeJob.job_ran
  end
end

class JobSystemTest < ActionDispatch::SystemTestCase
  class OtherJob < ActiveJob::Base
    cattr_accessor :job_ran

    def perform
      @@job_ran = true
    end
  end

  def test_other_job
    assert_equal :inline, Rails.application.config.active_job.queue_adapter
    assert_equal ActiveJob::QueueAdapters::InlineAdapter, OtherJob.queue_adapter.class

    OtherJob.perform_later

    assert_equal true, OtherJob.job_ran
  end
end
```

### Expected behavior

I would expect the behavior to have remained as it did under Rails 5, where the `active_job.queue_adapter` setting would be respected for all of Rails' test types.

### Actual behavior

The first test, which descends from `ActiveSupport::TestCase` will pass and behave as it did under Rails 5. However, the second test, descending from from `ActionDispatch::SystemTestCase` will now fail under Rails 6, because `OtherJob`'s `queue_adapter` will have been reset by `ActiveJob::TestHelper` to be an instance of `TestAdapter`

```
JobSystemTest#test_other_job [/Users/justin/code/testdouble/present/test/lib/job_test.rb:33]:
--- expected
+++ actual
@@ -1 +1 @@
-ActiveJob::QueueAdapters::InlineAdapter
+ActiveJob::QueueAdapters::TestAdapter
```

### System configuration
**Rails version**: 6.0.0 as well as [6-0-stable](https://github.com/rails/rails/tree/2bc6a948a2f46f8cf2d44506af1be235691c84b5), as of today.

**Ruby version**: ruby 2.6.3p62 (2019-04-16 revision 67580) [x86_64-darwin18]

",https://api.github.com/repos/rails/rails/issues/37270/timeline,,searls,79303,MDQ6VXNlcjc5MzAz,https://avatars.githubusercontent.com/u/79303?v=4,,https://api.github.com/users/searls,https://github.com/searls,https://api.github.com/users/searls/followers,https://api.github.com/users/searls/following{/other_user},https://api.github.com/users/searls/gists{/gist_id},https://api.github.com/users/searls/starred{/owner}{/repo},https://api.github.com/users/searls/subscriptions,https://api.github.com/users/searls/orgs,https://api.github.com/users/searls/repos,https://api.github.com/users/searls/events{/privacy},https://api.github.com/users/searls/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37270/reactions,41,41,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,https://api.github.com/repos/rails/rails/milestones/75,https://github.com/rails/rails/milestone/75,https://api.github.com/repos/rails/rails/milestones/75/labels,5391770.0,MDk6TWlsZXN0b25lNTM5MTc3MA==,75.0,6.0.4,,eugeneius,432189.0,MDQ6VXNlcjQzMjE4OQ==,https://avatars.githubusercontent.com/u/432189?v=4,,https://api.github.com/users/eugeneius,https://github.com/eugeneius,https://api.github.com/users/eugeneius/followers,https://api.github.com/users/eugeneius/following{/other_user},https://api.github.com/users/eugeneius/gists{/gist_id},https://api.github.com/users/eugeneius/starred{/owner}{/repo},https://api.github.com/users/eugeneius/subscriptions,https://api.github.com/users/eugeneius/orgs,https://api.github.com/users/eugeneius/repos,https://api.github.com/users/eugeneius/events{/privacy},https://api.github.com/users/eugeneius/received_events,User,False,3.0,28.0,open,2020-05-06T20:51:20Z,2021-07-07T21:05:29Z,,
446,https://api.github.com/repos/rails/rails/issues/37022,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/37022/labels{/name},https://api.github.com/repos/rails/rails/issues/37022/comments,https://api.github.com/repos/rails/rails/issues/37022/events,https://github.com/rails/rails/issues/37022,484247976,MDU6SXNzdWU0ODQyNDc5NzY=,37022,Attaching an ActiveStorage blob in a model callback creates a SystemStackError,"[{'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,3,2019-08-22T22:36:55Z,2019-11-01T16:06:30Z,,NONE,,"### Summary
Calling `attach` in an model callback causes a `SystemStackError: stack level too deep`.

This is specific to Rails 6, as it didn't happen previously in a Rails 5.2.3 app that I tested this in.

### Steps to reproduce
The simplest way to reproduce is to pull down an example repo, and run `rails test`: https://github.com/jarydkrish/attach-in-model-callbacks

This can be reproduced in a Rails 6 app with a model like the following:
```rb
class User < ApplicationRecord
  has_one_attached :avatar

  attr_accessor :copy_avatar_from_user_id

  # Callback that triggers an endless loop
  after_save :copy_avatar, if: :should_copy_avatar_from_user?

  def should_copy_avatar_from_user?
    copy_avatar_from_user_id.present?
  end

  # Copy a user avatar from a different user
  def copy_avatar
    user_to_copy_from = User.find_by(id: copy_avatar_from_user_id)
    avatar.attach(user_to_copy_from.avatar.blob)
  end
end
```

### Expected behavior
I would expect the above code to copy the ActiveStorage attachment to a different model, or at least not return an error.

Here is an example of the same code running in a Rails 5.2.3 application, which works as expected: https://github.com/jarydkrish/attach-in-model-callbacks-rails-5

### Actual behavior
Running `rails test` in [my example repo](https://github.com/jarydkrish/attach-in-model-callbacks) gives the following:
```bash
➜  attach-in-model-callbacks git:(master) rails test
Running via Spring preloader in process 59406
Run options: --seed 22489

# Running:

E

Error:
UserTest#test_attaching_an_image_via_callback:
SystemStackError: stack level too deep
    app/models/user.rb:16:in `copy_avatar'
    app/models/user.rb:16:in `copy_avatar'
    app/models/user.rb:16:in `copy_avatar'
    app/models/user.rb:16:in `copy_avatar'
    app/models/user.rb:16:in `copy_avatar'
    ...
    app/models/user.rb:16:in `copy_avatar'
    app/models/user.rb:16:in `copy_avatar'
    app/models/user.rb:16:in `copy_avatar'
    test/models/user_test.rb:19:in `block in <class:UserTest>'


rails test test/models/user_test.rb:4



Finished in 1.059573s, 0.9438 runs/s, 0.0000 assertions/s.
1 runs, 0 assertions, 0 failures, 1 errors, 0 skips
```

### System configuration
**Rails version**: 6.0.0

**Ruby version**: 2.6.3",https://api.github.com/repos/rails/rails/issues/37022/timeline,,jarydkrish,12515498,MDQ6VXNlcjEyNTE1NDk4,https://avatars.githubusercontent.com/u/12515498?v=4,,https://api.github.com/users/jarydkrish,https://github.com/jarydkrish,https://api.github.com/users/jarydkrish/followers,https://api.github.com/users/jarydkrish/following{/other_user},https://api.github.com/users/jarydkrish/gists{/gist_id},https://api.github.com/users/jarydkrish/starred{/owner}{/repo},https://api.github.com/users/jarydkrish/subscriptions,https://api.github.com/users/jarydkrish/orgs,https://api.github.com/users/jarydkrish/repos,https://api.github.com/users/jarydkrish/events{/privacy},https://api.github.com/users/jarydkrish/received_events,User,False,https://api.github.com/repos/rails/rails/issues/37022/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
447,https://api.github.com/repos/rails/rails/issues/36965,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36965/labels{/name},https://api.github.com/repos/rails/rails/issues/36965/comments,https://api.github.com/repos/rails/rails/issues/36965/events,https://github.com/rails/rails/issues/36965,481939236,MDU6SXNzdWU0ODE5MzkyMzY=,36965,Rails 6 regression in after_rollback callback not called for new records,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,13,2019-08-18T00:31:35Z,2021-07-26T03:49:31Z,,NONE,,"### Steps to reproduce
<!-- (Guidelines for creating a bug report are [available
here](https://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#creating-a-bug-report)) -->

Try this test case, it fails in Rails 6, and passes in 5.2.3

```
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""6.0.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :comments, force: true do |t|
    t.integer :post_id
    t.string :name
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post

  validates :name, presence: true

  after_rollback do
    @rollback_called = true
  end
end

class BugTest < Minitest::Test
  def test_association_stuff
    post = Post.create!

    comment = post.comments.new

    refute comment.save
    assert comment.instance_variable_get(:""@rollback_called"")

  end
end
```

### Expected behavior
<!-- Tell us what should happen -->

The rollbacks should be called.

### System configuration
**Rails version**: 6.

**Ruby version**: 2.6.3

Related https://github.com/rails/rails/issues/36132
cc @kamipo 
",https://api.github.com/repos/rails/rails/issues/36965/timeline,,jeffblake,620564,MDQ6VXNlcjYyMDU2NA==,https://avatars.githubusercontent.com/u/620564?v=4,,https://api.github.com/users/jeffblake,https://github.com/jeffblake,https://api.github.com/users/jeffblake/followers,https://api.github.com/users/jeffblake/following{/other_user},https://api.github.com/users/jeffblake/gists{/gist_id},https://api.github.com/users/jeffblake/starred{/owner}{/repo},https://api.github.com/users/jeffblake/subscriptions,https://api.github.com/users/jeffblake/orgs,https://api.github.com/users/jeffblake/repos,https://api.github.com/users/jeffblake/events{/privacy},https://api.github.com/users/jeffblake/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36965/reactions,1,1,0,0,0,0,0,0,0,,,,,,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/milestones/75,https://github.com/rails/rails/milestone/75,https://api.github.com/repos/rails/rails/milestones/75/labels,5391770.0,MDk6TWlsZXN0b25lNTM5MTc3MA==,75.0,6.0.4,,eugeneius,432189.0,MDQ6VXNlcjQzMjE4OQ==,https://avatars.githubusercontent.com/u/432189?v=4,,https://api.github.com/users/eugeneius,https://github.com/eugeneius,https://api.github.com/users/eugeneius/followers,https://api.github.com/users/eugeneius/following{/other_user},https://api.github.com/users/eugeneius/gists{/gist_id},https://api.github.com/users/eugeneius/starred{/owner}{/repo},https://api.github.com/users/eugeneius/subscriptions,https://api.github.com/users/eugeneius/orgs,https://api.github.com/users/eugeneius/repos,https://api.github.com/users/eugeneius/events{/privacy},https://api.github.com/users/eugeneius/received_events,User,False,3.0,28.0,open,2020-05-06T20:51:20Z,2021-07-07T21:05:29Z,,
448,https://api.github.com/repos/rails/rails/issues/36886,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36886/labels{/name},https://api.github.com/repos/rails/rails/issues/36886/comments,https://api.github.com/repos/rails/rails/issues/36886/events,https://github.com/rails/rails/pull/36886,478138154,MDExOlB1bGxSZXF1ZXN0MzA1MzE4OTg3,36886,Infer migrations_paths from database name,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,2,2019-08-07T21:02:21Z,2021-01-14T17:01:15Z,,MEMBER,,"### Summary

Similar to what we do for schema files, we now infer the default
`migrations_paths` for a database configuration using the database
specification name.

We still allow overriding these defaults with a `migrations_paths` key
in the database configuration file.

Additionally, we've updated some documentation accordingly in the guides.

We've also removed `Migrator.migrations_paths` since we should be taking
the `migrations_paths` off of the config instead.

cc / @eileencodes ",https://api.github.com/repos/rails/rails/issues/36886/timeline,,seejohnrun,64965,MDQ6VXNlcjY0OTY1,https://avatars.githubusercontent.com/u/64965?v=4,,https://api.github.com/users/seejohnrun,https://github.com/seejohnrun,https://api.github.com/users/seejohnrun/followers,https://api.github.com/users/seejohnrun/following{/other_user},https://api.github.com/users/seejohnrun/gists{/gist_id},https://api.github.com/users/seejohnrun/starred{/owner}{/repo},https://api.github.com/users/seejohnrun/subscriptions,https://api.github.com/users/seejohnrun/orgs,https://api.github.com/users/seejohnrun/repos,https://api.github.com/users/seejohnrun/events{/privacy},https://api.github.com/users/seejohnrun/received_events,User,True,https://api.github.com/repos/rails/rails/issues/36886/reactions,5,4,0,0,0,0,1,0,0,False,https://api.github.com/repos/rails/rails/pulls/36886,https://github.com/rails/rails/pull/36886,https://github.com/rails/rails/pull/36886.diff,https://github.com/rails/rails/pull/36886.patch,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
449,https://api.github.com/repos/rails/rails/issues/36833,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36833/labels{/name},https://api.github.com/repos/rails/rails/issues/36833/comments,https://api.github.com/repos/rails/rails/issues/36833/events,https://github.com/rails/rails/issues/36833,475731365,MDU6SXNzdWU0NzU3MzEzNjU=,36833,save! returns nil when has_one association throws abort,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2019-08-01T14:56:16Z,2019-11-21T16:53:31Z,,CONTRIBUTOR,,"### Steps to reproduce
```
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""6.0.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
  end

  create_table :profiles, force: true do |t|
    t.integer :user_id
  end
end

class User < ActiveRecord::Base
  has_one :profile
end

class Profile < ActiveRecord::Base
  belongs_to :user

  before_save do
    # Do something, but finally throw abort
    throw(:abort)
  end
end

class BugTest < Minitest::Test
  def test_association_stuff
    user = User.new
    user.build_profile

    assert_raises { user.save! }
  end
end
```

### Expected behavior
`save!` raise an exception (for example `ActiveRecord::RecordInvalid`) when has_one association is invalid for throwing abort.

### Actual behavior
`save!` returns nil and does not save the records.

### System configuration
**Rails version**: 6.0.0

**Ruby version**: 2.6.2
",https://api.github.com/repos/rails/rails/issues/36833/timeline,,giraffate,17407489,MDQ6VXNlcjE3NDA3NDg5,https://avatars.githubusercontent.com/u/17407489?v=4,,https://api.github.com/users/giraffate,https://github.com/giraffate,https://api.github.com/users/giraffate/followers,https://api.github.com/users/giraffate/following{/other_user},https://api.github.com/users/giraffate/gists{/gist_id},https://api.github.com/users/giraffate/starred{/owner}{/repo},https://api.github.com/users/giraffate/subscriptions,https://api.github.com/users/giraffate/orgs,https://api.github.com/users/giraffate/repos,https://api.github.com/users/giraffate/events{/privacy},https://api.github.com/users/giraffate/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36833/reactions,1,0,0,0,0,0,0,0,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
450,https://api.github.com/repos/rails/rails/issues/36737,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36737/labels{/name},https://api.github.com/repos/rails/rails/issues/36737/comments,https://api.github.com/repos/rails/rails/issues/36737/events,https://github.com/rails/rails/issues/36737,471716116,MDU6SXNzdWU0NzE3MTYxMTY=,36737,Actionpack: potential breaking change in rack-test,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,3,2019-07-23T14:02:00Z,2020-11-24T16:55:15Z,,NONE,,"We are currently discussing [a potential change](https://github.com/rack-test/rack-test/issues/241#issue-406963889) to [rack-test](https://github.com/rack-test/rack-test) which is s a [dependency of actionpack](https://github.com/rails/rails/blob/master/actionpack/actionpack.gemspec#L35).

The user suggested that rack-test should cause a test-failure when the rack-response does not conform to the rack-spec. 

## Example:

Creating a response like 
```ruby
[""200"", {}, ""hello world""] #string instead of an enumerable as last argument
```
would pass the tests, but fail on a real request. The full example is included in the linked issue.

## Benefit
The primary benefits are primarily 
* confidence in the test-suite. Green tests for a completely broken response are not an ideal experience
* Fast feedback. In case rack-test would immediately fail tests with a malformed response, we could significantly shorten the time until the bug is discovered

## Compatibility
Implementing the suggestion would be a breaking change that might impact a lot of downstream libraries and applications. 
In reality, most production apps with a recent ruby/rack version should have a correct implementation, which would mean that the change should have a low impact.

I would love to learn about the implications of such a breaking change from the rails and rack perspective so that I can take that into consideration for the decision.

`cc` @eileencodes @tenderlove ",https://api.github.com/repos/rails/rails/issues/36737/timeline,,dennissivia,3408791,MDQ6VXNlcjM0MDg3OTE=,https://avatars.githubusercontent.com/u/3408791?v=4,,https://api.github.com/users/dennissivia,https://github.com/dennissivia,https://api.github.com/users/dennissivia/followers,https://api.github.com/users/dennissivia/following{/other_user},https://api.github.com/users/dennissivia/gists{/gist_id},https://api.github.com/users/dennissivia/starred{/owner}{/repo},https://api.github.com/users/dennissivia/subscriptions,https://api.github.com/users/dennissivia/orgs,https://api.github.com/users/dennissivia/repos,https://api.github.com/users/dennissivia/events{/privacy},https://api.github.com/users/dennissivia/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36737/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
451,https://api.github.com/repos/rails/rails/issues/36682,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36682/labels{/name},https://api.github.com/repos/rails/rails/issues/36682/comments,https://api.github.com/repos/rails/rails/issues/36682/events,https://github.com/rails/rails/issues/36682,467973463,MDU6SXNzdWU0Njc5NzM0NjM=,36682,quote_bound_value does not handle ranges of Time,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2019-07-15T07:14:11Z,2019-08-12T17:26:07Z,,NONE,,"### Steps to reproduce

```
range = Time.now..Time.now
ActiveRecord::Base.send :quote_bound_value, range
```

### Expected behavior
```
range = DateTime.now..2.days.from_now
ActiveRecord::Base.send :quote_bound_value, range
=> ""'2019-07-15 07:02:38.929537','2019-07-16 07:02:38.929537','2019-07-17 07:02:38.929537'""
```

This is what happens for a Range of DateTime. However, I'm not sure if this should even be the expected behaviour for a Range of DateTime. E.g. the Postgres connection adapter can handle Ranges https://github.com/rails/rails/blob/master/activerecord/lib/active_record/connection_adapters/postgresql/quoting.rb#L141
Shouldn't we, therefore, pass the entire range to `c.quote`?


### Actual behavior
=> can't iterate from Time

### System configuration
**Rails version**:
5.2.3
**Ruby version**:
2.6.3",https://api.github.com/repos/rails/rails/issues/36682/timeline,,Tolsto,20240901,MDQ6VXNlcjIwMjQwOTAx,https://avatars.githubusercontent.com/u/20240901?v=4,,https://api.github.com/users/Tolsto,https://github.com/Tolsto,https://api.github.com/users/Tolsto/followers,https://api.github.com/users/Tolsto/following{/other_user},https://api.github.com/users/Tolsto/gists{/gist_id},https://api.github.com/users/Tolsto/starred{/owner}{/repo},https://api.github.com/users/Tolsto/subscriptions,https://api.github.com/users/Tolsto/orgs,https://api.github.com/users/Tolsto/repos,https://api.github.com/users/Tolsto/events{/privacy},https://api.github.com/users/Tolsto/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36682/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
452,https://api.github.com/repos/rails/rails/issues/36628,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36628/labels{/name},https://api.github.com/repos/rails/rails/issues/36628/comments,https://api.github.com/repos/rails/rails/issues/36628/events,https://github.com/rails/rails/issues/36628,465465533,MDU6SXNzdWU0NjU0NjU1MzM=,36628,ActiveRecord PostgreSQL adapter method `index_name_exists?` checks the wrong schema,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2019-07-08T21:21:52Z,2019-07-17T22:35:24Z,,NONE,,"### Steps to reproduce

```ruby
        def index_name_exists?(table_name, index_name)
          table = quoted_scope(table_name)
          index = quoted_scope(index_name)

          query_value(<<~SQL, ""SCHEMA"").to_i > 0
            SELECT COUNT(*)
            FROM pg_class t
            INNER JOIN pg_index d ON t.oid = d.indrelid
            INNER JOIN pg_class i ON d.indexrelid = i.oid
            LEFT JOIN pg_namespace n ON n.oid = i.relnamespace
            WHERE i.relkind = 'i'
              AND i.relname = #{index[:name]}
              AND t.relname = #{table[:name]}
              AND n.nspname = #{index[:schema]}
          SQL
        end
```

The `index_name_exists?` method in the PostgreSQL adapter extracts the schema name from `index_name` instead of `table_name`. This leads to different problems as `add_index` uses `index_name_exists?` when determining whether it should create the index or not. We have the following scenario when we try to create indexes with the same name in different schemas, same table names:

```ruby
  create_schema ""some_schema""

  create_table ""table"" do |t|
    t.string :foo
  end

  create_table ""some_schema.table"" do |t|
    t.string :bar
  end

  # This will work.
  add_index ""table"", ""foo"", name: ""index_name""

  # This will crash with the following exception 
  # as it will end up looking in the 'public' schema and finding 
  # index ""index_name"" in table ""table""
  #
  # ArgumentError: Index name 'index_name' on table 'some_schema.table' already exists 
  add_index ""some_schema.table"", ""bar"", name: ""index_name""
```
Check the following unit test: https://gist.github.com/vldcmp/3fcc9795ff40b1981a02fcad6053ec9e

The broader problem is that unlike other RDBMS, PostgreSQL constraints index name uniqueness per schema, not per table, so we can end up in this situation:

```ruby
  create_table ""table"" do |t|
    t.string :foo
  end

  create_table ""another_table"" do |t|
    t.string :bar
  end

  # This will work.
  add_index ""table"", ""foo"", name: ""index_name""

  # This will crash with a PG exception
  # PG::DuplicateTable: ERROR: relation ""index_name"" already exists
  #
  # Note that PG stores tables, views, indexes etc as ""relations"" objects in `pg_class` catalog
  # Hence the not-so-usual error message
  add_index ""another_table"", ""bar"", name: ""index_name""
```

The conclusion is that `add_index` should check for the given index_name in all the schema where table_name resides, as only looking in the table is not sufficient for validation. Nevertheless, one should expect for `index_name_exists?` to work properly, given a table_name and index_name. 

Pull request on the way.

### Expected behavior
PostgreSQL `index_name_exists?` should extract the schema name from the table_name and check the index_name in the correct table

### Actual behavior
The schema name is extracted from the index_name leading to wrong schema lookup

### System configuration
**Rails version**: 6.1.0.alpha

**Ruby version**: 2.6.3
",https://api.github.com/repos/rails/rails/issues/36628/timeline,,vldcmp,11362209,MDQ6VXNlcjExMzYyMjA5,https://avatars.githubusercontent.com/u/11362209?v=4,,https://api.github.com/users/vldcmp,https://github.com/vldcmp,https://api.github.com/users/vldcmp/followers,https://api.github.com/users/vldcmp/following{/other_user},https://api.github.com/users/vldcmp/gists{/gist_id},https://api.github.com/users/vldcmp/starred{/owner}{/repo},https://api.github.com/users/vldcmp/subscriptions,https://api.github.com/users/vldcmp/orgs,https://api.github.com/users/vldcmp/repos,https://api.github.com/users/vldcmp/events{/privacy},https://api.github.com/users/vldcmp/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36628/reactions,1,0,0,0,0,0,0,0,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
453,https://api.github.com/repos/rails/rails/issues/36578,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36578/labels{/name},https://api.github.com/repos/rails/rails/issues/36578/comments,https://api.github.com/repos/rails/rails/issues/36578/events,https://github.com/rails/rails/issues/36578,462351867,MDU6SXNzdWU0NjIzNTE4Njc=,36578,ActiveRecord::RecordNotUnique When Calling Active Storage attach,"[{'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,3,2019-06-29T23:50:10Z,2019-07-23T08:19:23Z,,NONE,,"Our app uses Active Storage and automatically uploads files once selected or dropped on the file area. When uploading multiple files at once, we started running into ActiveRecord::RecordNotUnique errors such as the following:

> ActiveRecord::RecordNotUnique in MessagesController#upload PG::UniqueViolation: ERROR: duplicate key value violates unique constraint ""index_active_storage_attachments_uniqueness"" DETAIL: Key (record_type, record_id, name, blob_id)=(Message, 1, images, 1271) already exists.

I confirmed that each file key we're sending to `.attach` is unique when this error happens and tried stripping away as much code as possible and we're still seeing the error.

### Steps to reproduce

I've created a [stripped down sample project](https://github.com/iamjohnford/async-test) with the minimum code to reproduce the error. Follow the basic instructions in the README to get app running and upload all of the test files (`test/fixtures/files`) at once. It may take a couple of tries to get the error to happen and uploading more and larger files usually helps reproduce the error.

The error is being thrown in `app/controllers/messages_controller.rb:17` when `@message.images.attach(params[:files])` is called.

The JavaScript that handles the automatic uploading is in `app/javascript/controllers/upload_controller.js`. `uploadSuccess()` sends the successfully uploaded file key to `messages_controller.rb#upload`, via `Rails.ajax`, which is where the error is thrown.

A bit of the error is printed out on the page when the upload fails and the stacktrace should show up in the web browser console.

### Expected behavior

When `.attach` is called no error should be thrown.

### Actual behavior

```
ActiveRecord::RecordNotUnique in MessagesController#upload

PG::UniqueViolation: ERROR:  duplicate key value violates unique constraint ""index_active_storage_attachments_uniqueness""
DETAIL:  Key (record_type, record_id, name, blob_id)=(Message, 1, images, 1271) already exists.

Extracted source (around line #661):

#659           log(sql, name, binds, type_casted_binds) do
#660             ActiveSupport::Dependencies.interlock.permit_concurrent_loads do
*661               @connection.exec_params(sql, type_casted_binds)
#662             end
#663           end
#664         end

Extracted source (around line #661):

#659           log(sql, name, binds, type_casted_binds) do
#660             ActiveSupport::Dependencies.interlock.permit_concurrent_loads do
*661               @connection.exec_params(sql, type_casted_binds)
#662             end
#663           end
#664         end

Extracted source (around line #48):

#46       def permit_concurrent_loads
#47         @lock.yield_shares(compatible: [:load]) do
*48           yield
#49         end
#50       end
#51 
```

Here's a gist with the entire stacktrace: https://gist.github.com/iamjohnford/c39e42d15e71702962ed111461b4b0c2

### System configuration
**Rails version**: 6.0.0.rc1
**Ruby version**: 2.6.3
**Postgres version**: 11.2
",https://api.github.com/repos/rails/rails/issues/36578/timeline,,iamjohnford,12647,MDQ6VXNlcjEyNjQ3,https://avatars.githubusercontent.com/u/12647?v=4,,https://api.github.com/users/iamjohnford,https://github.com/iamjohnford,https://api.github.com/users/iamjohnford/followers,https://api.github.com/users/iamjohnford/following{/other_user},https://api.github.com/users/iamjohnford/gists{/gist_id},https://api.github.com/users/iamjohnford/starred{/owner}{/repo},https://api.github.com/users/iamjohnford/subscriptions,https://api.github.com/users/iamjohnford/orgs,https://api.github.com/users/iamjohnford/repos,https://api.github.com/users/iamjohnford/events{/privacy},https://api.github.com/users/iamjohnford/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36578/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
454,https://api.github.com/repos/rails/rails/issues/36512,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36512/labels{/name},https://api.github.com/repos/rails/rails/issues/36512/comments,https://api.github.com/repos/rails/rails/issues/36512/events,https://github.com/rails/rails/issues/36512,457200554,MDU6SXNzdWU0NTcyMDA1NTQ=,36512,has_one doesn't generate an [association]_id method and every other association type does,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2019-06-18T00:05:44Z,2021-08-29T23:56:41Z,,CONTRIBUTOR,,"I keep expecting this to work because it does for literally every other association type. and sure I can just use `delegate :id, to: :[association], prefix: true` but it feels like it's missing. 

I made a test because i was sure it must work and i'm missing something.

I find i notice it especially on `has_one, through: [thing with belongs_to on it]`

```ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails""
  gem ""sqlite3""
  gem ""openssl"", '2.1.2' # i was having trouble booting rails because of this
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true

  create_table :comments, force: true do |t|
    t.integer :post_id
  end

  create_table :comment_authors, force: true do |t|
    t.integer :comment_id
  end

  create_join_table :posts, :tags

  create_table :tags, force: true

  create_table :attachment, force: true do |t|
    t.integer :attachable_id
    t.integer :attachable_type
  end
end

class Post < ActiveRecord::Base
  has_many :comments
  has_many :comment_authors, through: :comments
  has_and_belongs_to_many :tags
  has_many :attachments, as: :attachable
end

class Tags < ActiveRecord::Base
  has_and_belongs_to_many :posts
end

class Comment < ActiveRecord::Base
  belongs_to :post
  has_one :comment_author
  has_one :attachment, as: :attachable
end

class CommentAuthor < ActiveRecord::Base
  belongs_to :comment
  has_one :post, through: :comment
end

class Attachment < ActiveRecord::Base
  belongs_to :attachable, polymorphic: true
end

class BugTest < Minitest::Test
  def test_association_id_exists_for_has_one # fails
    # the associations exist
    assert_respond_to Comment.new, :comment_author
    assert_respond_to Comment.new, :comment_author=
    # but there's no _id method
    assert_respond_to Comment.new, :comment_author_id
    assert_respond_to Comment.new, :comment_author_id=
  end

  def test_association_id_exists_for_polymorphic_has_one # fails
    # the associations exist
    assert_respond_to Comment.new, :attachment
    assert_respond_to Comment.new, :attachment=
    # but there's no _id method
    assert_respond_to Comment.new, :attachment_id
    assert_respond_to Comment.new, :attachment_id=
  end

  def test_association_id_exists_for_has_one_through # fails
    # the associations exist
    assert_respond_to Comment.new, :post
    # but there's no _id method
    assert_respond_to CommentAuthor.new, :post_id
  end

  def test_association_id_exists_for_belongs_to # literally an attribute the universe would have to break for this to not work
    assert_respond_to CommentAuthor.new, :comment_id
    assert_respond_to CommentAuthor.new, :comment_id=
  end

  def test_association_ids_exists_for_has_many
    assert_respond_to Post.new, :comment_ids
    assert_respond_to Post.new, :comment_ids=
  end

  def test_association_ids_exists_for_polymorphic_has_many
    assert_respond_to Post.new, :attachment_ids
    assert_respond_to Post.new, :attachment_ids=
  end

  def test_association_ids_exists_for_has_many_through
    assert_respond_to Post.new, :comment_author_ids
  end

  def test_association_ids_exists_for_habtm
    assert_respond_to Post.new, :tag_ids
    assert_respond_to Post.new, :tag_ids=
  end
end
```

",https://api.github.com/repos/rails/rails/issues/36512/timeline,,robotdana,295007,MDQ6VXNlcjI5NTAwNw==,https://avatars.githubusercontent.com/u/295007?v=4,,https://api.github.com/users/robotdana,https://github.com/robotdana,https://api.github.com/users/robotdana/followers,https://api.github.com/users/robotdana/following{/other_user},https://api.github.com/users/robotdana/gists{/gist_id},https://api.github.com/users/robotdana/starred{/owner}{/repo},https://api.github.com/users/robotdana/subscriptions,https://api.github.com/users/robotdana/orgs,https://api.github.com/users/robotdana/repos,https://api.github.com/users/robotdana/events{/privacy},https://api.github.com/users/robotdana/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36512/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
455,https://api.github.com/repos/rails/rails/issues/36475,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36475/labels{/name},https://api.github.com/repos/rails/rails/issues/36475/comments,https://api.github.com/repos/rails/rails/issues/36475/events,https://github.com/rails/rails/issues/36475,455890431,MDU6SXNzdWU0NTU4OTA0MzE=,36475,Eager load order bug,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,8,2019-06-13T18:28:12Z,2019-07-04T05:43:04Z,,NONE,,"### Steps to reproduce
![Screen Shot 2019-06-13 at 19 24 53](https://user-images.githubusercontent.com/31311538/59457831-1a662200-8e11-11e9-81ab-1f3290b57ec1.png)
![Screen Shot 2019-06-13 at 19 25 14](https://user-images.githubusercontent.com/31311538/59457840-1fc36c80-8e11-11e9-8c88-353434313531.png)


### Expected behaviour
Get the last record for each machine

### Actual behavior
It loads the first record for each machine. The order is not applied at all

### System configuration
**Rails version**:
 'rails', '~> 5.2.3'
**Ruby version**:
ruby '2.6.0'",https://api.github.com/repos/rails/rails/issues/36475/timeline,,cbillinis,31311538,MDQ6VXNlcjMxMzExNTM4,https://avatars.githubusercontent.com/u/31311538?v=4,,https://api.github.com/users/cbillinis,https://github.com/cbillinis,https://api.github.com/users/cbillinis/followers,https://api.github.com/users/cbillinis/following{/other_user},https://api.github.com/users/cbillinis/gists{/gist_id},https://api.github.com/users/cbillinis/starred{/owner}{/repo},https://api.github.com/users/cbillinis/subscriptions,https://api.github.com/users/cbillinis/orgs,https://api.github.com/users/cbillinis/repos,https://api.github.com/users/cbillinis/events{/privacy},https://api.github.com/users/cbillinis/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36475/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
456,https://api.github.com/repos/rails/rails/issues/36423,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36423/labels{/name},https://api.github.com/repos/rails/rails/issues/36423/comments,https://api.github.com/repos/rails/rails/issues/36423/events,https://github.com/rails/rails/issues/36423,452824859,MDU6SXNzdWU0NTI4MjQ4NTk=,36423,ActiveStorage 5.2.3 dependent: :purge causes unexpected result,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,2,2019-06-06T04:21:18Z,2020-12-25T06:20:22Z,,NONE,,"### Steps to reproduce
Create a new Rails app with a User model. Set up the model to have one attached photo, and set `dependent: :purge`

```
class User < ApplicationRecord
  has_one_attached :photo, dependent: :purge
end
```

### Expected behavior
On deletion of a user having an attached photo, the attachment should be purged.

### Actual behavior
On deletion of the user, the attached photo is detached, **not purged**. The problem occurs with both `has_one_attached` and `has_many_attached`. This violates the principle of least surprise. 

### Commentary

In ActiveStorage, there are three ways to remove attachments: `purge`, `purge_later`, and `detach`. When we set up a `has_one_attached` or `has_many_attached` relationship, we have the option to specify a `dependent` argument. If `dependent` is set to `:purge_later` or `:detach`, we get the expected result. If it is set to `:purge`, we get an unexpected result.

The problem lies, at least in part, in `lib/active_storage/attached/macros.rb` in lines 46-50 and again in 103-107, which look like this:

      if dependent == :purge_later
        after_destroy_commit { public_send(name).purge_later }
      else
        before_destroy { public_send(name).detach }
      end 

### System configuration
**Rails version**: 5.2.3

**Ruby version**: 2.6.1
",https://api.github.com/repos/rails/rails/issues/36423/timeline,,moveson,14797300,MDQ6VXNlcjE0Nzk3MzAw,https://avatars.githubusercontent.com/u/14797300?v=4,,https://api.github.com/users/moveson,https://github.com/moveson,https://api.github.com/users/moveson/followers,https://api.github.com/users/moveson/following{/other_user},https://api.github.com/users/moveson/gists{/gist_id},https://api.github.com/users/moveson/starred{/owner}{/repo},https://api.github.com/users/moveson/subscriptions,https://api.github.com/users/moveson/orgs,https://api.github.com/users/moveson/repos,https://api.github.com/users/moveson/events{/privacy},https://api.github.com/users/moveson/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36423/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
457,https://api.github.com/repos/rails/rails/issues/36413,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36413/labels{/name},https://api.github.com/repos/rails/rails/issues/36413/comments,https://api.github.com/repos/rails/rails/issues/36413/events,https://github.com/rails/rails/issues/36413,452368183,MDU6SXNzdWU0NTIzNjgxODM=,36413,actriverecord 5.2.3 breaks on numeric searches for empty strings,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,11,2019-06-05T08:12:56Z,2019-10-08T12:13:10Z,,NONE,,"### Steps to reproduce
* create a mysql table `units` with a numeric column (int or bigint) `tag`
* run in `Unit.where(tag: """").to_sql` in a console
* run in `Unit.where.not(tag: """").to_sql` in a console

### Expected behavior
5.2.2.1 returns ""SELECT `units`.* FROM `units` WHERE `units`.`tag` IS NULL""
5.2.2.1 returns ""SELECT `units`.* FROM `units` WHERE `units`.`tag` IS NOT NULL""

### Actual behavior
5.2.3 returns ""SELECT `units`.* FROM `units` WHERE `units`.`tag` = NULL""
5.2.3 returns ""SELECT `units`.* FROM `units` WHERE `units`.`tag` != NULL""

### System configuration
**Rails version**:
5.2.3 and 5.2.2.1 or older
**Ruby version**:
2.6.x

## Comments
This makes form searches from web forms impossible for ""empty values"".",https://api.github.com/repos/rails/rails/issues/36413/timeline,,cork,404380,MDQ6VXNlcjQwNDM4MA==,https://avatars.githubusercontent.com/u/404380?v=4,,https://api.github.com/users/cork,https://github.com/cork,https://api.github.com/users/cork/followers,https://api.github.com/users/cork/following{/other_user},https://api.github.com/users/cork/gists{/gist_id},https://api.github.com/users/cork/starred{/owner}{/repo},https://api.github.com/users/cork/subscriptions,https://api.github.com/users/cork/orgs,https://api.github.com/users/cork/repos,https://api.github.com/users/cork/events{/privacy},https://api.github.com/users/cork/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36413/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
458,https://api.github.com/repos/rails/rails/issues/36108,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/36108/labels{/name},https://api.github.com/repos/rails/rails/issues/36108/comments,https://api.github.com/repos/rails/rails/issues/36108/events,https://github.com/rails/rails/issues/36108,437676362,MDU6SXNzdWU0Mzc2NzYzNjI=,36108,counter_cache double increment,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2019-04-26T13:35:38Z,2019-05-03T00:26:36Z,,NONE,,"### Steps to reproduce
```ruby
unless File.exist?('Gemfile')
  File.write('Gemfile', <<-GEMFILE)
    source 'https://rubygems.org'
    gem 'rails', github: 'rails/rails'
    gem 'arel', github: 'rails/arel'
    gem 'sqlite3'
  GEMFILE

  system 'bundle install'
end

require 'bundler'
Bundler.setup(:default)

require 'active_record'
require 'minitest/autorun'
require 'logger'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)

# Display database and Active Record, Arel, Ruby versions.
message = ""Running tests with #{ActiveRecord::Base.connection.adapter_name}, Active Record #{
ActiveRecord::VERSION::STRING}, Arel #{Arel::VERSION} and Ruby #{RUBY_VERSION}""
line = '=' * message.length
puts line, message, line

ActiveRecord::Schema.define do
  create_table :days, force: true do |t|
    t.integer ""assembly_lots_count"", default: 0
  end

  create_table :expiration_days, force: true do |t|
    t.references :day
    t.integer ""assembly_lots_count"", default: 0
  end

  create_table :assembly_lots, force: true do |t|
    t.references :day
    t.references :expiration_day
  end
end

class Day < ActiveRecord::Base
  has_one :expiration_day

  has_many :assembly_lots
end

class ExpirationDay < ActiveRecord::Base
  belongs_to :day

  has_many :assembly_lots
end

class AssemblyLot < ActiveRecord::Base
  belongs_to :day, counter_cache: true, touch: true
  belongs_to :expiration_day, counter_cache: true, touch: true, optional: true
end

class BugTest < ActiveSupport::TestCase
  def test_counter_cache_from_shovel
    today = Day.create
    assembly_lot = today.assembly_lots.create

    tomorrow = Day.create
    expiration_day = tomorrow.build_expiration_day
    expiration_day.save

    expiration_day.assembly_lots << assembly_lot

    assert_equal 1, today.assembly_lots.count
    assert_equal 1, today.assembly_lots_count

    assert_equal 0, tomorrow.assembly_lots.count
    assert_equal 0, tomorrow.assembly_lots_count

    assert_equal 1, expiration_day.assembly_lots.count
    assert_equal 1, expiration_day.assembly_lots_count
  end

  def test_counter_cache_from_update
    today = Day.create
    assembly_lot = today.assembly_lots.create

    tomorrow = Day.create
    expiration_day = tomorrow.build_expiration_day
    expiration_day.save

    assembly_lot.update(expiration_day: expiration_day)

    assert_equal 1, today.assembly_lots.count
    assert_equal 1, today.assembly_lots_count

    assert_equal 0, tomorrow.assembly_lots.count
    assert_equal 0, tomorrow.assembly_lots_count

    assert_equal 1, expiration_day.assembly_lots.count
    assert_equal 1, expiration_day.assembly_lots_count
  end
end
```

### Expected behavior
```
..

Finished in 0.045836s, 43.6338 runs/s, 261.8030 assertions/s.
2 runs, 12 assertions, 0 failures, 0 errors, 0 skips
```

### Actual behavior
```
F

Failure:
BugTest#test_counter_cache_from_shovel [run.rb:80]:
Expected: 1
  Actual: 2

.
Finished in 0.045836s, 43.6338 runs/s, 261.8030 assertions/s.
2 runs, 12 assertions, 1 failures, 0 errors, 0 skips
```

### System configuration
**Rails version**: `6.1.0.alpha` (also affects `5.2.3`)

**Ruby version**: `ruby 2.5.1p57 (2018-03-29 revision 63029) [x86_64-darwin17]`",https://api.github.com/repos/rails/rails/issues/36108/timeline,,garside,337924,MDQ6VXNlcjMzNzkyNA==,https://avatars.githubusercontent.com/u/337924?v=4,,https://api.github.com/users/garside,https://github.com/garside,https://api.github.com/users/garside/followers,https://api.github.com/users/garside/following{/other_user},https://api.github.com/users/garside/gists{/gist_id},https://api.github.com/users/garside/starred{/owner}{/repo},https://api.github.com/users/garside/subscriptions,https://api.github.com/users/garside/orgs,https://api.github.com/users/garside/repos,https://api.github.com/users/garside/events{/privacy},https://api.github.com/users/garside/received_events,User,False,https://api.github.com/repos/rails/rails/issues/36108/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
459,https://api.github.com/repos/rails/rails/issues/35811,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/35811/labels{/name},https://api.github.com/repos/rails/rails/issues/35811/comments,https://api.github.com/repos/rails/rails/issues/35811/events,https://github.com/rails/rails/issues/35811,427447230,MDU6SXNzdWU0Mjc0NDcyMzA=,35811,Active Storage models ignore table_name_prefix,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,12,2019-03-31T21:14:52Z,2021-12-15T01:06:34Z,,NONE,,"### Steps to reproduce
1. `rails new astest`
2. `cd astest/`
3. Edit `config/application.rb` and add set a general table prefix with `config.active_record.table_name_prefix = 'abc_'`
4. Create ActiveStorage models `bundle exec rake active_storage:install db:migrate`

Observe: tables are created with prefix (`abc_active_storage_attachements` and `*_blobs`).

5. Create a user model via `bundle exec rails generate model User name:string` and attach an avatar to it
```
class User < ApplicationRecord
  has_one_attached :avatar
end
```
6. Add an Avatar via console
```
2.6.1 :002 > u.avatar.attach(io: File.open(Rails.root.join('public', 'apple-touch-icon.png')))
Traceback (most recent call last):
        1: from (irb):2
ActiveRecord::StatementInvalid (Could not find table 'active_storage_attachments')
```

Observe: ActiveRecord cannot find its table.

### Expected behavior
ActiveStorage::Attachment should use the prefixed table name the migration created previously.

### Actual behavior
ActiveStorage::Attachment cannot find its table as it looks for the non-prefixed table name.

Which is hardcoded in ActiveStorage::Attachment [here](https://github.com/rails/rails/blob/d2542882b20f6205e1c40ab34ff075eefc2d589c/activestorage/app/models/active_storage/attachment.rb#L9) and in ActiveStorage::Blob [here](https://github.com/rails/rails/blob/d2542882b20f6205e1c40ab34ff075eefc2d589c/activestorage/app/models/active_storage/blob.rb#L27)

### System configuration
**Rails version**: 5.2.3
**Ruby version**: 2.6.1",https://api.github.com/repos/rails/rails/issues/35811/timeline,,gr8bit,341793,MDQ6VXNlcjM0MTc5Mw==,https://avatars.githubusercontent.com/u/341793?v=4,,https://api.github.com/users/gr8bit,https://github.com/gr8bit,https://api.github.com/users/gr8bit/followers,https://api.github.com/users/gr8bit/following{/other_user},https://api.github.com/users/gr8bit/gists{/gist_id},https://api.github.com/users/gr8bit/starred{/owner}{/repo},https://api.github.com/users/gr8bit/subscriptions,https://api.github.com/users/gr8bit/orgs,https://api.github.com/users/gr8bit/repos,https://api.github.com/users/gr8bit/events{/privacy},https://api.github.com/users/gr8bit/received_events,User,False,https://api.github.com/repos/rails/rails/issues/35811/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
460,https://api.github.com/repos/rails/rails/issues/35666,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/35666/labels{/name},https://api.github.com/repos/rails/rails/issues/35666/comments,https://api.github.com/repos/rails/rails/issues/35666/events,https://github.com/rails/rails/issues/35666,422666940,MDU6SXNzdWU0MjI2NjY5NDA=,35666,Model.new returning a pre-initialised object in class method,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2019-03-19T10:58:02Z,2019-04-05T13:40:51Z,,NONE,,"### Steps to reproduce
1. I have a Model named Project and a class method in project.rb called 'set_new_project'.

def self.set_new_project
  Project.new
end

2. run the 'where' query on Project i.e a = Project.where(id: 1)
3.  Call  a.set_new_project


### Expected behaviour
 This should return an uninitialised object i.e  
 <Project id: nil, name: nil, description: nil>
### Actual behaviour
It returns an id initialised object  i.e 
<Project id: 1, name: nil, description: nil>

Additional Information:
- if you run `Project.new.reload` in set_new_project then it will return an object with all fields initialised as that of 'a'
- if you run `Project.all` then it will return a

### System configuration
**Rails version**:
Rails 5.2.0.rc1
**Ruby version**:
2.4.2",https://api.github.com/repos/rails/rails/issues/35666/timeline,,sonal425chouhan,30461862,MDQ6VXNlcjMwNDYxODYy,https://avatars.githubusercontent.com/u/30461862?v=4,,https://api.github.com/users/sonal425chouhan,https://github.com/sonal425chouhan,https://api.github.com/users/sonal425chouhan/followers,https://api.github.com/users/sonal425chouhan/following{/other_user},https://api.github.com/users/sonal425chouhan/gists{/gist_id},https://api.github.com/users/sonal425chouhan/starred{/owner}{/repo},https://api.github.com/users/sonal425chouhan/subscriptions,https://api.github.com/users/sonal425chouhan/orgs,https://api.github.com/users/sonal425chouhan/repos,https://api.github.com/users/sonal425chouhan/events{/privacy},https://api.github.com/users/sonal425chouhan/received_events,User,False,https://api.github.com/repos/rails/rails/issues/35666/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
461,https://api.github.com/repos/rails/rails/issues/35489,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/35489/labels{/name},https://api.github.com/repos/rails/rails/issues/35489/comments,https://api.github.com/repos/rails/rails/issues/35489/events,https://github.com/rails/rails/pull/35489,417575570,MDExOlB1bGxSZXF1ZXN0MjU4NTQzNDQx,35489,The Rails Conductor,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 1174770998, 'node_id': 'MDU6TGFiZWwxMTc0NzcwOTk4', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailbox', 'name': 'actionmailbox', 'color': 'f4a6cb', 'default': False, 'description': ''}]",open,False,,"[{'login': 'dhh', 'id': 2741, 'node_id': 'MDQ6VXNlcjI3NDE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/2741?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/dhh', 'html_url': 'https://github.com/dhh', 'followers_url': 'https://api.github.com/users/dhh/followers', 'following_url': 'https://api.github.com/users/dhh/following{/other_user}', 'gists_url': 'https://api.github.com/users/dhh/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/dhh/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/dhh/subscriptions', 'organizations_url': 'https://api.github.com/users/dhh/orgs', 'repos_url': 'https://api.github.com/users/dhh/repos', 'events_url': 'https://api.github.com/users/dhh/events{/privacy}', 'received_events_url': 'https://api.github.com/users/dhh/received_events', 'type': 'User', 'site_admin': False}]",,10,2019-03-06T01:11:40Z,2021-12-06T22:38:01Z,,MEMBER,,"I've had this dream since before Rails was released to build a web interface for developing Rails itself. We've long had little drops of this idea, like with the mailer previews, and now in Rails 6, with the Action Mailbox inbound emails processing. So rather than wait for some grand vision to come together, I'm just getting started with what we got and going from there.",https://api.github.com/repos/rails/rails/issues/35489/timeline,,dhh,2741,MDQ6VXNlcjI3NDE=,https://avatars.githubusercontent.com/u/2741?v=4,,https://api.github.com/users/dhh,https://github.com/dhh,https://api.github.com/users/dhh/followers,https://api.github.com/users/dhh/following{/other_user},https://api.github.com/users/dhh/gists{/gist_id},https://api.github.com/users/dhh/starred{/owner}{/repo},https://api.github.com/users/dhh/subscriptions,https://api.github.com/users/dhh/orgs,https://api.github.com/users/dhh/repos,https://api.github.com/users/dhh/events{/privacy},https://api.github.com/users/dhh/received_events,User,False,https://api.github.com/repos/rails/rails/issues/35489/reactions,148,67,0,0,0,0,56,25,0,False,https://api.github.com/repos/rails/rails/pulls/35489,https://github.com/rails/rails/pull/35489,https://github.com/rails/rails/pull/35489.diff,https://github.com/rails/rails/pull/35489.patch,,dhh,2741.0,MDQ6VXNlcjI3NDE=,https://avatars.githubusercontent.com/u/2741?v=4,,https://api.github.com/users/dhh,https://github.com/dhh,https://api.github.com/users/dhh/followers,https://api.github.com/users/dhh/following{/other_user},https://api.github.com/users/dhh/gists{/gist_id},https://api.github.com/users/dhh/starred{/owner}{/repo},https://api.github.com/users/dhh/subscriptions,https://api.github.com/users/dhh/orgs,https://api.github.com/users/dhh/repos,https://api.github.com/users/dhh/events{/privacy},https://api.github.com/users/dhh/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
462,https://api.github.com/repos/rails/rails/issues/35416,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/35416/labels{/name},https://api.github.com/repos/rails/rails/issues/35416/comments,https://api.github.com/repos/rails/rails/issues/35416/events,https://github.com/rails/rails/issues/35416,414471562,MDU6SXNzdWU0MTQ0NzE1NjI=,35416,Unable to configure ActionMailer custom delivery methods,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2019-02-26T07:38:08Z,2020-07-21T03:22:10Z,,NONE,,"### Steps to reproduce

1. `git clone https://github.com/Benjamin-Dobell/actionmailer-delivery-test.git`
2. `cd actionmailer-delivery-test`
3. `bundle`

#### Option A

4. `rails console`
5. Enter `ActionMailer::Base.delivery_method`

#### Option B

4. `rails server`
5. Visit `http://localhost:3000`

**Note**: The `foomailer` gem we're using for testing is available at https://github.com/Benjamin-Dobell/actionmailer-delivery-gem-test
### Expected behavior

#### Option A
Expect to see `:foo` printed.

#### Option B
Expect error `Not a real mailer` - which is intentionally raised when our test FooMailer gem is used to deliver mail.

### Actual behavior

> NoMethodError (undefined method `foo_settings=' for ActionMailer::Base:Class)

is raised. Refer to ""More details"" below for an explanation.

### System configuration
**Rails version**:
5.2.2 (down to at least 3)

**Ruby version**:
2.6.1

### More details

The ActionMailer railtie looks at `config.action_mailer` and assigns these options to `ActionMailer::Base`. However, it does so as soon as `ActionMailer` is loaded (`ActiveSupport.on_load(:action_mailer)`).

However, `ActionMailer` (and its config) is explicitly designed to be extensible, specifically ActionMailer allows third-party gems to register additional ""delivery methods"".

Delivery methods can be registered with third-party Railtie by using:

```ruby
class Railtie < ::Rails::Railtie
  initializer ""foomailer.add_delivery_method"" do
    ActiveSupport.on_load(:action_mailer) do
      add_delivery_method :foo, FooMailer
    end
  end
end
```

`add_delivery_method` adds support for `ActionMailer::Base.foo_settings` (and therefore support for `config.action_mailer.foo_settings`) - https://github.com/rails/rails/blob/master/actionmailer/lib/action_mailer/delivery_methods.rb#L51.

However, calling `add_delivery_method` requires `ActionMailer` to be loaded, therefore the config has already have been assigned on `ActionMailer::Base`, so there's no opportunity to add:

```ruby
config.action_mailer.foo_settings = {
  prop_test: true
}
```

If you are to put the above directly in your environment config, you get an error when the `ActionMailer` is loaded (the error is within the `actionmailer` railtie). This is because third-party gems _typically_ (does the gem's name come into play?!?) haven't run their initializers so `undefined method 'foo_settings=' for ActionMailer::Base:Class` is raised (e.g. https://github.com/mailgun/mailgun-ruby/issues/104).

Instead, if you were to move your logic into `app/initializers/foomailer.rb`:

```ruby
ActiveSupport.on_load(:action_mailer) do
  Rails.application.config do
    config.action_mailer.delivery_method = :foo
    config.action_mailer.foo_settings = {
        prop_test: true
    }
  end
end
```

**Note**: Checkout the `delayed_config` branch and repeat steps 4-5.

This _silently_ fails, because we're assigning the config _after_ `ActionMailer` has been loaded (and the config copied across), so although we've set the config it is never used and out of sync with `ActionMailer::Base`, which for example still returns `:smtp` for `ActionMailer::Base.delivery_method`, even though `Rails.application.config.action_mailer.delivery_method` correctly returns `:foo`.",https://api.github.com/repos/rails/rails/issues/35416/timeline,,Benjamin-Dobell,482276,MDQ6VXNlcjQ4MjI3Ng==,https://avatars.githubusercontent.com/u/482276?v=4,,https://api.github.com/users/Benjamin-Dobell,https://github.com/Benjamin-Dobell,https://api.github.com/users/Benjamin-Dobell/followers,https://api.github.com/users/Benjamin-Dobell/following{/other_user},https://api.github.com/users/Benjamin-Dobell/gists{/gist_id},https://api.github.com/users/Benjamin-Dobell/starred{/owner}{/repo},https://api.github.com/users/Benjamin-Dobell/subscriptions,https://api.github.com/users/Benjamin-Dobell/orgs,https://api.github.com/users/Benjamin-Dobell/repos,https://api.github.com/users/Benjamin-Dobell/events{/privacy},https://api.github.com/users/Benjamin-Dobell/received_events,User,False,https://api.github.com/repos/rails/rails/issues/35416/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
463,https://api.github.com/repos/rails/rails/issues/35032,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/35032/labels{/name},https://api.github.com/repos/rails/rails/issues/35032/comments,https://api.github.com/repos/rails/rails/issues/35032/events,https://github.com/rails/rails/issues/35032,402432157,MDU6SXNzdWU0MDI0MzIxNTc=,35032,ActionView leaks memory in dev,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'tenderlove', 'id': 3124, 'node_id': 'MDQ6VXNlcjMxMjQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3124?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/tenderlove', 'html_url': 'https://github.com/tenderlove', 'followers_url': 'https://api.github.com/users/tenderlove/followers', 'following_url': 'https://api.github.com/users/tenderlove/following{/other_user}', 'gists_url': 'https://api.github.com/users/tenderlove/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/tenderlove/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/tenderlove/subscriptions', 'organizations_url': 'https://api.github.com/users/tenderlove/orgs', 'repos_url': 'https://api.github.com/users/tenderlove/repos', 'events_url': 'https://api.github.com/users/tenderlove/events{/privacy}', 'received_events_url': 'https://api.github.com/users/tenderlove/received_events', 'type': 'User', 'site_admin': False}]",,1,2019-01-23T21:13:13Z,2019-04-24T05:14:37Z,,MEMBER,,"I'm working to fix this, but I wanted to open a ticket for tracking.

There are a few areas where we can demonstrate that memory is leaking, but I'm only going to focus on one place that is easy to observe here.  ERB templates are compiled to methods on `ActionView::Base`.  These methods are supposed to be removed when the template object gets GC'd by [this finalizer](https://github.com/rails/rails/blob/52af51c08a48ea7c6e0df09e2470a66a3141087d/actionview/lib/action_view/template.rb#L310).  Compiled ERB templates are evaluated against an instance of `AV::Base`, so if we print out a list of methods on `AV::Base`, that list length should stay fairly stable (if the finalizer is actually running).

I created a simple app that just [prints the number of methods when the view is executing](https://github.com/tenderlove/view-method-count/blob/master/app/views/users/new.html.erb#L5).  Running multiple requests through the app that render this view will show that the number of methods only ever increases.  This means the finalizer is never executed, the methods are never cleaned, and we have a memory leak.

I believe the cause of this leak is due to [this middleware that runs in dev](https://github.com/rails/rails/blob/52af51c08a48ea7c6e0df09e2470a66a3141087d/actionview/lib/action_view/digestor.rb#L11-L15).  It clears the ""DetailsKey"" cache, causing it to return an empty cache on each request.  Now that cache object is actually used as the cache key for another cache.  It is the `key` variable [here](https://github.com/rails/rails/blob/52af51c08a48ea7c6e0df09e2470a66a3141087d/actionview/lib/action_view/template/resolver.rb#L73).  This means the resolver object (which is also a singleton) contains a cache that constantly grows.  That cache holds instances of ""Templates"", and since that cache is never expired the Templates stay around forever and their finalizers never run (so the methods also stick around forever).

I ran 500 requests through the ""new"" page.  Here is a graph of the number of methods:

<img width=""514"" alt=""untitled 2019-01-23 13-11-29"" src=""https://user-images.githubusercontent.com/3124/51637376-7b4b9700-1f10-11e9-9d5d-654344dba0bc.png"">

X axis is request number, Y axis is method count.  It leaks 3 methods per request.  The number of methods leaked depends on the number of templates rendered.  This particular test only renders 3 templates, so only 3 methods are leaked per request.

I think with some careful rearchitecting of this cache we can eliminate the finalizers and also fix the memory leak.  I would like to start evaling templates on to an anonymous subclass of `AV::Base`.  Any time we need to expire template caches, we just create a new anonymous subclass of `AV::Base`.  Since we'd generate methods on to an anonymous subclass, we can throw it away at any time and let the GC take care of collecting the methods.  No finalizers required.

There are *lots* of caches in ActionView, and figuring out what they cache and what their dependencies are is very difficult.  I will try to untangle them and fix this issue.",https://api.github.com/repos/rails/rails/issues/35032/timeline,,tenderlove,3124,MDQ6VXNlcjMxMjQ=,https://avatars.githubusercontent.com/u/3124?v=4,,https://api.github.com/users/tenderlove,https://github.com/tenderlove,https://api.github.com/users/tenderlove/followers,https://api.github.com/users/tenderlove/following{/other_user},https://api.github.com/users/tenderlove/gists{/gist_id},https://api.github.com/users/tenderlove/starred{/owner}{/repo},https://api.github.com/users/tenderlove/subscriptions,https://api.github.com/users/tenderlove/orgs,https://api.github.com/users/tenderlove/repos,https://api.github.com/users/tenderlove/events{/privacy},https://api.github.com/users/tenderlove/received_events,User,False,https://api.github.com/repos/rails/rails/issues/35032/reactions,53,0,0,0,0,1,32,4,16,,,,,,,tenderlove,3124.0,MDQ6VXNlcjMxMjQ=,https://avatars.githubusercontent.com/u/3124?v=4,,https://api.github.com/users/tenderlove,https://github.com/tenderlove,https://api.github.com/users/tenderlove/followers,https://api.github.com/users/tenderlove/following{/other_user},https://api.github.com/users/tenderlove/gists{/gist_id},https://api.github.com/users/tenderlove/starred{/owner}{/repo},https://api.github.com/users/tenderlove/subscriptions,https://api.github.com/users/tenderlove/orgs,https://api.github.com/users/tenderlove/repos,https://api.github.com/users/tenderlove/events{/privacy},https://api.github.com/users/tenderlove/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
464,https://api.github.com/repos/rails/rails/issues/34964,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/34964/labels{/name},https://api.github.com/repos/rails/rails/issues/34964/comments,https://api.github.com/repos/rails/rails/issues/34964/events,https://github.com/rails/rails/issues/34964,400418278,MDU6SXNzdWU0MDA0MTgyNzg=,34964,ActiveRecord. Double validation with `autosave: true` on both sides,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2019-01-17T19:01:27Z,2019-07-11T15:04:04Z,,CONTRIBUTOR,,"### Steps to reproduce
```ruby
#!/usr/bin/env ruby
# frozen_string_literal: true

require ""bundler/inline""

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :stories do |t|
    t.string :type
  end

  create_table :bad_guys do |t|
    t.references :story
  end
end

::VALIDATED = 0

class Story < ActiveRecord::Base
  has_one :bad_guy, foreign_key: :story_id, inverse_of: :story, autosave: true

  validate { ::VALIDATED += 1 }
end

class BadGuy < ActiveRecord::Base
  belongs_to :story, inverse_of: :bad_guy, autosave: true
end

class TestDoubleValidation < Minitest::Test
  def test_validated_once
    story = Story.new()
    bad_guy = BadGuy.new(story: story)
    story.save!
    assert_equal 1, VALIDATED
  end
end
```

### Expected behavior
`Story` should be validated only once

### Actual behavior
`Story` validated twice

### System configuration
**Rails version**: master, 5.2.0

**Ruby version**: 2.5.1",https://api.github.com/repos/rails/rails/issues/34964/timeline,,EPecherkin,1036610,MDQ6VXNlcjEwMzY2MTA=,https://avatars.githubusercontent.com/u/1036610?v=4,,https://api.github.com/users/EPecherkin,https://github.com/EPecherkin,https://api.github.com/users/EPecherkin/followers,https://api.github.com/users/EPecherkin/following{/other_user},https://api.github.com/users/EPecherkin/gists{/gist_id},https://api.github.com/users/EPecherkin/starred{/owner}{/repo},https://api.github.com/users/EPecherkin/subscriptions,https://api.github.com/users/EPecherkin/orgs,https://api.github.com/users/EPecherkin/repos,https://api.github.com/users/EPecherkin/events{/privacy},https://api.github.com/users/EPecherkin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/34964/reactions,9,9,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
465,https://api.github.com/repos/rails/rails/issues/34584,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/34584/labels{/name},https://api.github.com/repos/rails/rails/issues/34584/comments,https://api.github.com/repos/rails/rails/issues/34584/events,https://github.com/rails/rails/pull/34584,386445725,MDExOlB1bGxSZXF1ZXN0MjM1MTg1MzEz,34584,Extract `ActiveSupport::DeepTransformObject`,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}]",open,False,,[],,22,2018-12-01T10:30:42Z,2022-02-26T05:45:39Z,,MEMBER,,"An alternative of #24721.

People sometimes need to deep transform keys against JSON array.
To reuse the deep transform code, I'd like to extract that as the
`ActiveSupport::DeepTransformObject`.",https://api.github.com/repos/rails/rails/issues/34584/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/34584/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/34584,https://github.com/rails/rails/pull/34584,https://github.com/rails/rails/pull/34584.diff,https://github.com/rails/rails/pull/34584.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
466,https://api.github.com/repos/rails/rails/issues/34452,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/34452/labels{/name},https://api.github.com/repos/rails/rails/issues/34452/comments,https://api.github.com/repos/rails/rails/issues/34452/events,https://github.com/rails/rails/issues/34452,380909275,MDU6SXNzdWUzODA5MDkyNzU=,34452,URL helpers in mounted engine called from renderer produce incorrect paths,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 4782967, 'node_id': 'MDU6TGFiZWw0NzgyOTY3', 'url': 'https://api.github.com/repos/rails/rails/labels/engines', 'name': 'engines', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,0,2018-11-14T22:10:42Z,2018-11-15T16:50:24Z,,CONTRIBUTOR,,"When using url helpers in a mounted engine via `renderer.render`(background jobs etc.) produced paths are missing engine mount point prefix.

### Steps to reproduce
```ruby
#!/usr/bin/env ruby
# frozen_string_literal: true

begin
  require 'bundler/inline'
rescue LoadError => e
  raise 'Bundler version 1.10 or later is required. Please update your Bundler'
end

gemfile(ENV['INSTALL'] == '1') do
  source 'https://rubygems.org'
  rails_version = ENV['RAILS'] || '> 5'
  if ENV['LOCAL_RAILS'] && (
    File.directory?(local_copy = ENV['LOCAL_RAILS']) ||
    File.directory?(local_copy = '../rails'))
    rails_version = { path: local_copy }
  end
  gem 'rails', rails_version
  gem 'minitest', '5.10.3'
end

require 'action_controller/railtie'

module SomeMountedEngine
  class Engine < ::Rails::Engine
    # to avoid 'Could not find root path for...':
    def self.find_root(from); from; end

    isolate_namespace SomeMountedEngine

    routes.draw do
      resources :engine_resources, only: :index
      root to: redirect('/engine_resources')
    end
  end

  class EngineResourcesController < ActionController::Base
    include Engine.routes.url_helpers

    TEMPLATE = <<-ERB.freeze
      main_app.root       : <%= main_app.root_path %>
      mounted_helper.root : <%= someengine.root_path %>
      engine root_path    : <%= root_path %>
    ERB

    EXPECTED = <<-TXT.freeze
      main_app.root       : /
      mounted_helper.root : /engine_mount/
      engine root_path    : /engine_mount/
    TXT

    def index
      render inline: TEMPLATE
    end
  end
end

class TestApp < Rails::Application
  secrets.secret_token = secrets.secret_key_base = 'secret'
  config.logger = Rails.logger = ::Logger.new(File::NULL)

  routes.draw do
    mount SomeMountedEngine::Engine, at: '/engine_mount', as: :someengine
    root to: redirect('/foo')
  end
  routes.define_mounted_helper(:main_app)
end

puts ""Rails #{Rails.version}""

require 'minitest/autorun'
class PathTest < Minitest::Test
  include Rack::Test::Methods

  def test_paths_via_plain_render
    get '/engine_mount/engine_resources'
    assert_equal(
      SomeMountedEngine::EngineResourcesController::EXPECTED,
      last_response.body
    )
  end

  def test_paths_via_renderer
    template = SomeMountedEngine::EngineResourcesController::TEMPLATE
    renderer = SomeMountedEngine::EngineResourcesController.renderer

    # adding this has no effect:
    # renderer = renderer.with_defaults(script_name: '/engine_mount')

    assert_equal(
      SomeMountedEngine::EngineResourcesController::EXPECTED,
      renderer.render(inline: template)
    )
  end

  private

  def app
    Rails.application
  end
end
```


### Expected behavior
helpers produce the same result as in regular render and test above pass, that means that inside engine:
```ruby
main_app.root_path == '/'
someengine.root_path == '/engine_mount/'
root_path == '/engine_mount/'
```

### Actual behavior
on rails 5.1.6, 5.2.1 and master:
```ruby
main_app.root_path == '/'
someengine.root_path == '/engine_mount/'
root_path == '/'
```
 on rails 5.0.7:
```ruby
main_app.root_path == '/'
someengine.root_path == '/'
root_path == '/'
```
### System configuration
**Rails version**:
master(6.0.0.alpha), 5.2.1, 5.1.6, 5.0.7
also tried 4.2.1 and 4.1 with gem backport_new_renderer

**Ruby version**:
2.5.0, 2.3.1",https://api.github.com/repos/rails/rails/issues/34452/timeline,,Vasfed,135265,MDQ6VXNlcjEzNTI2NQ==,https://avatars.githubusercontent.com/u/135265?v=4,,https://api.github.com/users/Vasfed,https://github.com/Vasfed,https://api.github.com/users/Vasfed/followers,https://api.github.com/users/Vasfed/following{/other_user},https://api.github.com/users/Vasfed/gists{/gist_id},https://api.github.com/users/Vasfed/starred{/owner}{/repo},https://api.github.com/users/Vasfed/subscriptions,https://api.github.com/users/Vasfed/orgs,https://api.github.com/users/Vasfed/repos,https://api.github.com/users/Vasfed/events{/privacy},https://api.github.com/users/Vasfed/received_events,User,False,https://api.github.com/repos/rails/rails/issues/34452/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
467,https://api.github.com/repos/rails/rails/issues/34443,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/34443/labels{/name},https://api.github.com/repos/rails/rails/issues/34443/comments,https://api.github.com/repos/rails/rails/issues/34443/events,https://github.com/rails/rails/issues/34443,380492882,MDU6SXNzdWUzODA0OTI4ODI=,34443,active_storage fips 140-2 issue,"[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,7,2018-11-14T01:11:07Z,2020-11-09T03:45:36Z,,NONE,,"Tried using active_storage to handle file upload, but encountered an issue when FIPS mode is enforced.

Tried the following configuration option with same issue:
Rails.application.config.active_support.use_sha1_digests = true

rail 5.2.1

ruby 2.5.0
",https://api.github.com/repos/rails/rails/issues/34443/timeline,,da-development-id,36071943,MDQ6VXNlcjM2MDcxOTQz,https://avatars.githubusercontent.com/u/36071943?v=4,,https://api.github.com/users/da-development-id,https://github.com/da-development-id,https://api.github.com/users/da-development-id/followers,https://api.github.com/users/da-development-id/following{/other_user},https://api.github.com/users/da-development-id/gists{/gist_id},https://api.github.com/users/da-development-id/starred{/owner}{/repo},https://api.github.com/users/da-development-id/subscriptions,https://api.github.com/users/da-development-id/orgs,https://api.github.com/users/da-development-id/repos,https://api.github.com/users/da-development-id/events{/privacy},https://api.github.com/users/da-development-id/received_events,User,False,https://api.github.com/repos/rails/rails/issues/34443/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
468,https://api.github.com/repos/rails/rails/issues/34310,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/34310/labels{/name},https://api.github.com/repos/rails/rails/issues/34310/comments,https://api.github.com/repos/rails/rails/issues/34310/events,https://github.com/rails/rails/issues/34310,373791560,MDU6SXNzdWUzNzM3OTE1NjA=,34310,Occasional deadlocks between Dependencies::Interlock and db adapter lock,"[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,10,2018-10-25T06:24:54Z,2019-03-29T18:39:31Z,,NONE,,"In our rspec test environment, some feature specs occasionally hang. Generating stack traces using the [sigdump gem](https://github.com/frsyuki/sigdump) and `ActionDispatch::DebugLocks` I was able to narrow it down to roughly the following.

There are two request threads, A and B, and another thread accessing the database C. When requests start they call `ActiveSupport::Dependencies.interlock.start_sharing` and if they need to autoload any files, they upgrade to `interlock.exclusive`. When threads use the database, they call `AbstractAdapter#log` which acquires a separate lock for the database connection (which is a `LoadInterlockAwareMonitor`). Then I have the following:

| Thread A | Thread B | Thread C|
|----------|----------|----------|
| gets interlock share lock | | |
| | gets interlock share lock | |
| | | gets db connection lock |
| | calls `AbstractAdapter#log` | |
| | notes it can't get db lock right away (blocked on C) | | 
| | releases interlock share and waits on db lock | | 
| tries to autoload a model | | |
| upgrades to an exclusive interlock | | |
| | | releases the db connection lock |
| | takes the db lock | |
| | tries to reclaim interlock share lock | |
| | blocked on thread A which has exclusive lock | |
| requires a db query to load schema | | |
| calls `AbstractAdapter#log` | | |
| notes it can't get db lock right away (blocked on B) | | |
| does not release interlock as exclusive and waits on db lock | | |
| waits on db connection lock | | |

And then A and B wait forever. Also of note, rspec cleanup requires rolling back a transaction which requires the db connection lock so rspec also hangs forever.

### Steps to reproduce
It's hard to actually reproduce this as it's so timing based but I created this unit test https://github.com/rails/rails/commit/7ab4f357f6281798d76a801e7a397d0d4fc6be11. I also added the full `ActionDispatch::DebugLocks` output at the end.

### Expected behavior
All requests complete

### Actual behavior
The test suite hangs

### System configuration
**Rails version**: 5.1.6 (the test also reproduces against master)

**Ruby version**: 2.3.6 (the test also reproduces against 2.5.1)

<details><summary>ActionDispatch::DebugLocks output</summary><pre><code>
Thread 0 [0xa06e4b0 sleep]  No lock (yielded share)
  Waiting in yield_shares
  may be pre-empted for: ""load"", share
  blocked by: 1

/usr/local/lib/ruby/2.3.0/monitor.rb:111:in `sleep'
/usr/local/lib/ruby/2.3.0/monitor.rb:111:in `wait'
/usr/local/lib/ruby/2.3.0/monitor.rb:111:in `wait'
/usr/local/lib/ruby/2.3.0/monitor.rb:123:in `wait_while'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/share_lock.rb:221:in `wait_for'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/share_lock.rb:189:in `block in yield_shares'
/usr/local/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/share_lock.rb:187:in `yield_shares'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies/interlock.rb:45:in `permit_concurrent_loads'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/load_interlock_aware_monitor.rb:13:in `mon_enter'
/usr/local/lib/ruby/2.3.0/monitor.rb:212:in `mon_synchronize'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:612:in `block in log'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications/instrumenter.rb:21:in `instrument'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:604:in `log'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/postgresql_adapter.rb:614:in `exec_no_cache'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/postgresql_adapter.rb:603:in `execute_and_clear'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:79:in `exec_query'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:371:in `select'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract/database_statements.rb:42:in `select_all'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract/query_cache.rb:97:in `select_all'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/relation/calculations.rb:176:in `pluck'
<app code which queries the database>
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:413:in `instance_exec'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:413:in `block in make_lambda'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:197:in `block (2 levels) in halting'
/usr/local/bundle/gems/actionpack-5.1.6/lib/abstract_controller/callbacks.rb:12:in `block (2 levels) in <module:Callbacks>'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:198:in `block in halting'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:507:in `block in invoke_before'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:507:in `each'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:507:in `invoke_before'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:130:in `run_callbacks'
/usr/local/bundle/gems/actionpack-5.1.6/lib/abstract_controller/callbacks.rb:19:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/rescue.rb:20:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/instrumentation.rb:32:in `block in process_action'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications.rb:166:in `block in instrument'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications/instrumenter.rb:21:in `instrument'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications.rb:166:in `instrument'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/instrumentation.rb:30:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/params_wrapper.rb:252:in `process_action'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/railties/controller_runtime.rb:22:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/abstract_controller/base.rb:124:in `process'
/usr/local/bundle/gems/actionview-5.1.6/lib/action_view/rendering.rb:30:in `process'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal.rb:189:in `dispatch'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal.rb:253:in `dispatch'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/route_set.rb:49:in `dispatch'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/route_set.rb:31:in `serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/mapper.rb:16:in `block in <class:Constraints>'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/mapper.rb:46:in `serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/journey/router.rb:50:in `block in serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/journey/router.rb:33:in `each'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/journey/router.rb:33:in `serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/route_set.rb:844:in `call'
/usr/local/bundle/gems/warden-1.2.7/lib/warden/manager.rb:36:in `block in call'
/usr/local/bundle/gems/warden-1.2.7/lib/warden/manager.rb:35:in `catch'
/usr/local/bundle/gems/warden-1.2.7/lib/warden/manager.rb:35:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/etag.rb:25:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/conditional_get.rb:38:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/head.rb:12:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/session/abstract/id.rb:232:in `context'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/session/abstract/id.rb:226:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/cookies.rb:613:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/callbacks.rb:26:in `block in call'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:97:in `run_callbacks'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/callbacks.rb:24:in `call'
/usr/local/bundle/gems/bugsnag-6.7.3/lib/bugsnag/integrations/rack.rb:46:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/debug_exceptions.rb:59:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/show_exceptions.rb:31:in `call'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/rack/logger.rb:36:in `call_app'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/rack/logger.rb:24:in `block in call'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/tagged_logging.rb:69:in `block in tagged'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/tagged_logging.rb:26:in `tagged'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/tagged_logging.rb:69:in `tagged'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/rack/logger.rb:24:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/remote_ip.rb:79:in `call'
/usr/local/bundle/gems/request_store-1.4.1/lib/request_store/middleware.rb:19:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/request_id.rb:25:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/method_override.rb:22:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/runtime.rb:22:in `call'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/cache/strategy/local_cache_middleware.rb:27:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/executor.rb:12:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/static.rb:125:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/sendfile.rb:111:in `call'
/usr/local/bundle/gems/rack-utf8_sanitizer-1.4.0/lib/rack/utf8_sanitizer.rb:20:in `call'
/usr/local/bundle/gems/secure_headers-6.0.0.alpha02/lib/secure_headers/middleware.rb:13:in `call'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/engine.rb:522:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/urlmap.rb:68:in `block in call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/urlmap.rb:53:in `each'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/urlmap.rb:53:in `call'
/usr/local/bundle/gems/capybara-3.7.2/lib/capybara/server/middleware.rb:48:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/handler/webrick.rb:86:in `service'
/usr/local/lib/ruby/2.3.0/webrick/httpserver.rb:140:in `service'
/usr/local/lib/ruby/2.3.0/webrick/httpserver.rb:96:in `run'
/usr/local/lib/ruby/2.3.0/webrick/server.rb:314:in `block in start_thread'


---


Thread 1 [0x331cad8 sleep]  Exclusive (yielded share)
  blocking: 0

/usr/local/lib/ruby/2.3.0/monitor.rb:187:in `lock'
/usr/local/lib/ruby/2.3.0/monitor.rb:187:in `mon_enter'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/load_interlock_aware_monitor.rb:13:in `block in mon_enter'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies/interlock.rb:46:in `block in permit_concurrent_loads'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/share_lock.rb:185:in `yield_shares'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies/interlock.rb:45:in `permit_concurrent_loads'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/load_interlock_aware_monitor.rb:13:in `mon_enter'
/usr/local/lib/ruby/2.3.0/monitor.rb:212:in `mon_synchronize'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:612:in `block in log'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications/instrumenter.rb:21:in `instrument'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:604:in `log'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/postgresql/database_statements.rb:59:in `query'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/postgresql_adapter.rb:765:in `column_definitions'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/abstract_adapter.rb:167:in `columns'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/schema_cache.rb:67:in `columns'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/connection_adapters/schema_cache.rb:73:in `columns_hash'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/model_schema.rb:471:in `load_schema!'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/attributes.rb:233:in `load_schema!'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/attribute_decorators.rb:50:in `load_schema!'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/model_schema.rb:464:in `block in load_schema'
/usr/local/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/model_schema.rb:461:in `load_schema'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/model_schema.rb:353:in `attribute_types'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/attribute_methods.rb:164:in `attribute_names'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/attribute_methods.rb:62:in `block in define_attribute_methods'
/usr/local/lib/ruby/2.3.0/mutex_m.rb:74:in `synchronize'
/usr/local/lib/ruby/2.3.0/mutex_m.rb:74:in `mu_synchronize'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/attribute_methods.rb:59:in `define_attribute_methods'
<model class load which calls define_attribute_methods directly>
/usr/local/bundle/gems/bootsnap-1.3.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:21:in `require'
/usr/local/bundle/gems/bootsnap-1.3.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:21:in `block in require_with_bootsnap_lfi'
/usr/local/bundle/gems/bootsnap-1.3.0/lib/bootsnap/load_path_cache/loaded_features_index.rb:65:in `register'
/usr/local/bundle/gems/bootsnap-1.3.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:20:in `require_with_bootsnap_lfi'
/usr/local/bundle/gems/bootsnap-1.3.0/lib/bootsnap/load_path_cache/core_ext/kernel_require.rb:29:in `require'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:292:in `block in require'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:258:in `load_dependency'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:292:in `require'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:379:in `block in require_or_load'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:36:in `block in load_interlock'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies/interlock.rb:12:in `block in loading'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/concurrency/share_lock.rb:149:in `exclusive'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies/interlock.rb:11:in `loading'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:36:in `load_interlock'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:357:in `require_or_load'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:511:in `load_missing_constant'
/usr/local/bundle/gems/bootsnap-1.3.0/lib/bootsnap/load_path_cache/core_ext/active_support.rb:43:in `load_missing_constant'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:202:in `const_missing'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/inflector/methods.rb:271:in `const_get'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/inflector/methods.rb:271:in `block in constantize'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/inflector/methods.rb:267:in `each'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/inflector/methods.rb:267:in `inject'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/inflector/methods.rb:267:in `constantize'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/inflector/methods.rb:312:in `safe_constantize'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:589:in `safe_get'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/dependencies.rb:620:in `safe_constantize'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/inheritance.rb:159:in `block in compute_type'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/inheritance.rb:158:in `each'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/inheritance.rb:158:in `compute_type'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:408:in `compute_class'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:404:in `klass'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:621:in `automatic_inverse_of'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:609:in `block in inverse_name'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:609:in `fetch'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:609:in `inverse_name'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:523:in `has_inverse?'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:236:in `check_validity_of_inverse!'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/reflection.rb:474:in `check_validity!'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/associations/association.rb:25:in `initialize'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/associations.rb:265:in `new'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/associations.rb:265:in `association'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/associations/builder/association.rb:111:in `integration'
<application code which referenced unloaded model>
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/basic_implicit_render.rb:4:in `send_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/abstract_controller/base.rb:186:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/rendering.rb:30:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/abstract_controller/callbacks.rb:20:in `block in process_action'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:131:in `run_callbacks'
/usr/local/bundle/gems/actionpack-5.1.6/lib/abstract_controller/callbacks.rb:19:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/rescue.rb:20:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/instrumentation.rb:32:in `block in process_action'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications.rb:166:in `block in instrument'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications/instrumenter.rb:21:in `instrument'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/notifications.rb:166:in `instrument'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/instrumentation.rb:30:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal/params_wrapper.rb:252:in `process_action'
/usr/local/bundle/gems/activerecord-5.1.6/lib/active_record/railties/controller_runtime.rb:22:in `process_action'
/usr/local/bundle/gems/actionpack-5.1.6/lib/abstract_controller/base.rb:124:in `process'
/usr/local/bundle/gems/actionview-5.1.6/lib/action_view/rendering.rb:30:in `process'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal.rb:189:in `dispatch'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_controller/metal.rb:253:in `dispatch'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/route_set.rb:49:in `dispatch'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/route_set.rb:31:in `serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/mapper.rb:16:in `block in <class:Constraints>'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/mapper.rb:46:in `serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/journey/router.rb:50:in `block in serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/journey/router.rb:33:in `each'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/journey/router.rb:33:in `serve'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/routing/route_set.rb:844:in `call'
/usr/local/bundle/gems/warden-1.2.7/lib/warden/manager.rb:36:in `block in call'
/usr/local/bundle/gems/warden-1.2.7/lib/warden/manager.rb:35:in `catch'
/usr/local/bundle/gems/warden-1.2.7/lib/warden/manager.rb:35:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/etag.rb:25:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/conditional_get.rb:38:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/head.rb:12:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/session/abstract/id.rb:232:in `context'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/session/abstract/id.rb:226:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/cookies.rb:613:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/callbacks.rb:26:in `block in call'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/callbacks.rb:97:in `run_callbacks'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/callbacks.rb:24:in `call'
/usr/local/bundle/gems/bugsnag-6.7.3/lib/bugsnag/integrations/rack.rb:46:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/debug_exceptions.rb:59:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/show_exceptions.rb:31:in `call'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/rack/logger.rb:36:in `call_app'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/rack/logger.rb:24:in `block in call'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/tagged_logging.rb:69:in `block in tagged'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/tagged_logging.rb:26:in `tagged'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/tagged_logging.rb:69:in `tagged'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/rack/logger.rb:24:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/remote_ip.rb:79:in `call'
/usr/local/bundle/gems/request_store-1.4.1/lib/request_store/middleware.rb:19:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/request_id.rb:25:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/method_override.rb:22:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/runtime.rb:22:in `call'
/usr/local/bundle/gems/activesupport-5.1.6/lib/active_support/cache/strategy/local_cache_middleware.rb:27:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/executor.rb:12:in `call'
/usr/local/bundle/gems/actionpack-5.1.6/lib/action_dispatch/middleware/static.rb:125:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/sendfile.rb:111:in `call'
/usr/local/bundle/gems/rack-utf8_sanitizer-1.4.0/lib/rack/utf8_sanitizer.rb:20:in `call'
/usr/local/bundle/gems/secure_headers-6.0.0.alpha02/lib/secure_headers/middleware.rb:13:in `call'
/usr/local/bundle/gems/railties-5.1.6/lib/rails/engine.rb:522:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/urlmap.rb:68:in `block in call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/urlmap.rb:53:in `each'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/urlmap.rb:53:in `call'
/usr/local/bundle/gems/capybara-3.7.2/lib/capybara/server/middleware.rb:48:in `call'
/usr/local/bundle/gems/rack-2.0.5/lib/rack/handler/webrick.rb:86:in `service'
/usr/local/lib/ruby/2.3.0/webrick/httpserver.rb:140:in `service'
/usr/local/lib/ruby/2.3.0/webrick/httpserver.rb:96:in `run'
/usr/local/lib/ruby/2.3.0/webrick/server.rb:314:in `block in start_thread'
</pre></code>
</details>",https://api.github.com/repos/rails/rails/issues/34310/timeline,,tessereth,4583474,MDQ6VXNlcjQ1ODM0NzQ=,https://avatars.githubusercontent.com/u/4583474?v=4,,https://api.github.com/users/tessereth,https://github.com/tessereth,https://api.github.com/users/tessereth/followers,https://api.github.com/users/tessereth/following{/other_user},https://api.github.com/users/tessereth/gists{/gist_id},https://api.github.com/users/tessereth/starred{/owner}{/repo},https://api.github.com/users/tessereth/subscriptions,https://api.github.com/users/tessereth/orgs,https://api.github.com/users/tessereth/repos,https://api.github.com/users/tessereth/events{/privacy},https://api.github.com/users/tessereth/received_events,User,False,https://api.github.com/repos/rails/rails/issues/34310/reactions,18,6,0,2,2,0,8,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
469,https://api.github.com/repos/rails/rails/issues/34282,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/34282/labels{/name},https://api.github.com/repos/rails/rails/issues/34282/comments,https://api.github.com/repos/rails/rails/issues/34282/events,https://github.com/rails/rails/issues/34282,372453930,MDU6SXNzdWUzNzI0NTM5MzA=,34282,form_with doesn't render form tag itself when no block is passed from second call onward,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2018-10-22T09:38:55Z,2018-10-27T05:23:31Z,,NONE,,"### Steps to reproduce

i'm using a table with an HTML5 form in a hidden column per row and references to the form from the input elements according to the HTML5 spec. in this case no 'block' is needed as we just want to have the form tag in isolation.

### Expected behavior

form_with should always render the form tag also when no block is passed, and not only on the first occurance 

### Actual behavior

form_with renders the form tag with the standard hidden fields in the first row but it fails to render the form tag from the second row onwards when no block is given

not repeating the form tag

```
      td.hide
        =form_with model: window, :html => { :id => ""window_form_#{window.id}"" } 

```
repeating the form tag (empty block)

```
      td.hide
         =form_with model: window, :html => { :id => ""window_form_#{window.id}"" } do |f|

```
### System configuration
**Rails version**: 5.2.1

**Ruby version**: 2.5.1
",https://api.github.com/repos/rails/rails/issues/34282/timeline,,koenhandekyn,710262,MDQ6VXNlcjcxMDI2Mg==,https://avatars.githubusercontent.com/u/710262?v=4,,https://api.github.com/users/koenhandekyn,https://github.com/koenhandekyn,https://api.github.com/users/koenhandekyn/followers,https://api.github.com/users/koenhandekyn/following{/other_user},https://api.github.com/users/koenhandekyn/gists{/gist_id},https://api.github.com/users/koenhandekyn/starred{/owner}{/repo},https://api.github.com/users/koenhandekyn/subscriptions,https://api.github.com/users/koenhandekyn/orgs,https://api.github.com/users/koenhandekyn/repos,https://api.github.com/users/koenhandekyn/events{/privacy},https://api.github.com/users/koenhandekyn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/34282/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
470,https://api.github.com/repos/rails/rails/issues/34023,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/34023/labels{/name},https://api.github.com/repos/rails/rails/issues/34023/comments,https://api.github.com/repos/rails/rails/issues/34023/events,https://github.com/rails/rails/issues/34023,365007401,MDU6SXNzdWUzNjUwMDc0MDE=,34023,URL helpers for isolated engines disregard SCRIPT_NAME when it's set by app middleware,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,2,2018-09-28T19:09:57Z,2018-12-31T13:52:23Z,,CONTRIBUTOR,,"In Basecamp, we use Rack middleware to extract an account ID from the leading segment of each request's path and move it to `env['SCRIPT_NAME']`. This causes Rails to prefix every generated path with the account ID, freeing us from having to pass it as an argument at every call site for every URL helper.

Here’s a simplified example of such a middleware class:

```ruby
class SlugExtractor
  def initialize(app)
    @app = app
  end

  def call(env)
    request = ActionDispatch::Request.new(env)

    # If the first path segment is an integer, pull it off of path_info and put it in script_name.
    if request.path_info =~ /\A(\/(\d+))/
      request.script_name = $1
      request.path_info   = $'.empty? ? '/' : $'
    end

    @app.call(env)
  end
end
```

URL helpers for isolated Rails engines disregard `env['SCRIPT_NAME']` when it’s populated by middleware like `SlugExtractor`. If `SlugExtractor` sets `env['SCRIPT_NAME']` to `""/8675309""`, the following erroneously generates `""/google_sign_in/authorization""` instead of `""/8675309/google_sign_in/authorization""` (assuming [`GoogleSignIn::Engine`](https://github.com/basecamp/google_sign_in) is mounted at `/google_sign_in`):

```ruby
google_sign_in.authorization_path
```

When the code below is reached, it appears that `options[:script_name]` is incorrectly `nil`. As a result, it’s set to `""/google_sign_in""` instead of `""/8675309/google_sign_in""`:

https://github.com/rails/rails/blob/9fa4342970e2c8ac24bcc595f120ab65e88095a4/actionpack/lib/action_dispatch/routing/routes_proxy.rb#L38-L41

For a failing test case, see [this gist](https://gist.github.com/georgeclaghorn/d362d442ab2149f84939e2f65945afd0).",https://api.github.com/repos/rails/rails/issues/34023/timeline,,georgeclaghorn,94129,MDQ6VXNlcjk0MTI5,https://avatars.githubusercontent.com/u/94129?v=4,,https://api.github.com/users/georgeclaghorn,https://github.com/georgeclaghorn,https://api.github.com/users/georgeclaghorn/followers,https://api.github.com/users/georgeclaghorn/following{/other_user},https://api.github.com/users/georgeclaghorn/gists{/gist_id},https://api.github.com/users/georgeclaghorn/starred{/owner}{/repo},https://api.github.com/users/georgeclaghorn/subscriptions,https://api.github.com/users/georgeclaghorn/orgs,https://api.github.com/users/georgeclaghorn/repos,https://api.github.com/users/georgeclaghorn/events{/privacy},https://api.github.com/users/georgeclaghorn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/34023/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
471,https://api.github.com/repos/rails/rails/issues/33980,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33980/labels{/name},https://api.github.com/repos/rails/rails/issues/33980/comments,https://api.github.com/repos/rails/rails/issues/33980/events,https://github.com/rails/rails/issues/33980,363574280,MDU6SXNzdWUzNjM1NzQyODA=,33980,Parsing of Accept header in request fails on quoted-strings,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,1,2018-09-25T13:18:13Z,2018-10-02T04:34:39Z,,NONE,,"### Steps to reproduce

```ruby
# frozen_string_literal: true

require ""bundler/inline""
gemfile(true) do
  source ""https://rubygems.org""
  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }
  gem ""rails"", github: ""rails/rails""
end

require ""action_controller/railtie""

class TestApp < Rails::Application
  config.root = __dir__
  config.logger = Logger.new($stdout)
  Rails.logger  = config.logger

  routes.draw do
    get ""/greet"" => ""test#greet""
  end
end

class TestController < ActionController::Base
  def greet
    respond_to do |format|
      format.csv {render plain: ""Hello""}
      format.text {render plain: ""Hello""}
    end
  end
end

require ""minitest/autorun""
require ""rack/test""

class BugTest < Minitest::Test
  include Rack::Test::Methods

  def test_media_type_parameters
    get ""/greet"", nil, { 'HTTP_ACCEPT' => 'text/html; someparameter=""a, \""quoted, string, text/csv, etc"", text/plain' }
    assert last_response.ok?
    assert_equal ""text/plain; charset=utf-8"", last_response.content_type
    assert_equal ""Hello"", last_response.body
  end

  private
    def app
      Rails.application
    end
end
```

### Expected behavior
As per RFC 7231 sections 5.3.2 and 3.1.1.1, the header sent by the client should be understood as having two media type specifications; the first `text/html` with the media type parameter `someparameter` having the value `a, ""quoted, string, text/csv, etc` and the second `text/plain` with no media type parameters. The content negotiation should thus result in choosing `text/plain`.

### Actual behavior
```
Failure:
BugTest#test_media_type_parameters [accepts.rb:40]:
Expected: ""text/plain; charset=utf-8""
  Actual: ""text/csv; charset=utf-8""
```
The header parsing fails to take quoted-strings into account, and `text/csv` is mistakenly interpreted as an accepted media type. The response is sent as CSV.

### System configuration
**Rails version**: 6.0.0alpha (master)

**Ruby version**: 2.4.1p111
",https://api.github.com/repos/rails/rails/issues/33980/timeline,,tkalliom,4124528,MDQ6VXNlcjQxMjQ1Mjg=,https://avatars.githubusercontent.com/u/4124528?v=4,,https://api.github.com/users/tkalliom,https://github.com/tkalliom,https://api.github.com/users/tkalliom/followers,https://api.github.com/users/tkalliom/following{/other_user},https://api.github.com/users/tkalliom/gists{/gist_id},https://api.github.com/users/tkalliom/starred{/owner}{/repo},https://api.github.com/users/tkalliom/subscriptions,https://api.github.com/users/tkalliom/orgs,https://api.github.com/users/tkalliom/repos,https://api.github.com/users/tkalliom/events{/privacy},https://api.github.com/users/tkalliom/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33980/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
472,https://api.github.com/repos/rails/rails/issues/33505,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33505/labels{/name},https://api.github.com/repos/rails/rails/issues/33505/comments,https://api.github.com/repos/rails/rails/issues/33505/events,https://github.com/rails/rails/issues/33505,346683790,MDU6SXNzdWUzNDY2ODM3OTA=,33505,"ActionCable.Subscription.perform: Key name ""action"" not allowed for ""data"" argument","[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,0,2018-08-01T16:54:35Z,2018-08-02T00:34:06Z,,NONE,,"

When the `data` argument to ActionCable.Subscription.perform contains a key called `action`, its value is replaced. Would help to throw an error here:

**Example:**
Javascript:
```javascript
App.my_channel.my_action({ foo: 'This key name is allowed.', action: 'This key name is NOT allowed.' })
```
Rails server:
```
MyChannel#my_action({""foo""=>""This key name is allowed.""})
{""foo""=>""This key name is allowed."", ""action""=>""update_event""}
```

Not technically a bug, but could be clarified a little.

[ActionCable.Subscription](https://github.com/rails/rails/blob/master/actioncable/app/assets/javascripts/action_cable/subscription.coffee)

```coffee
  # Perform a channel action with the optional data passed as an attribute
  perform: (action, data = {}) ->
    data.action = action
    @send(data)
```",https://api.github.com/repos/rails/rails/issues/33505/timeline,,pinksynth,25071920,MDQ6VXNlcjI1MDcxOTIw,https://avatars.githubusercontent.com/u/25071920?v=4,,https://api.github.com/users/pinksynth,https://github.com/pinksynth,https://api.github.com/users/pinksynth/followers,https://api.github.com/users/pinksynth/following{/other_user},https://api.github.com/users/pinksynth/gists{/gist_id},https://api.github.com/users/pinksynth/starred{/owner}{/repo},https://api.github.com/users/pinksynth/subscriptions,https://api.github.com/users/pinksynth/orgs,https://api.github.com/users/pinksynth/repos,https://api.github.com/users/pinksynth/events{/privacy},https://api.github.com/users/pinksynth/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33505/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
473,https://api.github.com/repos/rails/rails/issues/33330,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33330/labels{/name},https://api.github.com/repos/rails/rails/issues/33330/comments,https://api.github.com/repos/rails/rails/issues/33330/events,https://github.com/rails/rails/pull/33330,339800373,MDExOlB1bGxSZXF1ZXN0MjAwMzYzNjQ1,33330,Allow fstring as a safe raw SQL string,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,31,2018-07-10T11:23:25Z,2022-02-04T12:30:37Z,,MEMBER,,"#27947 was intended to address `Post.order(params[:order])` which
leading to SQL injection.

But the protection caused very annoying warnings, especially for calling
by a string literal which invoke a function like `Post.order(""length(title)"")`.

Calling by a string literal should be safe since it is not an user
input. So I'd like to allow string literals as a safe raw SQL string.

There is no reliable way to distinguish between `params[:order]` and
`""length(title)""`, but at least `params[:order]` as an user input is
always a mutable string, and `""length(title)""` will be a fstring if
`# frozen_string_literal: true`.

So I think that we can add fstring to the allowlist to mitigate the
annoying warnings without losing the original intention of #27947.

Resolves #32995.",https://api.github.com/repos/rails/rails/issues/33330/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33330/reactions,19,19,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/33330,https://github.com/rails/rails/pull/33330,https://github.com/rails/rails/pull/33330.diff,https://github.com/rails/rails/pull/33330.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
474,https://api.github.com/repos/rails/rails/issues/33284,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33284/labels{/name},https://api.github.com/repos/rails/rails/issues/33284/comments,https://api.github.com/repos/rails/rails/issues/33284/events,https://github.com/rails/rails/issues/33284,337966775,MDU6SXNzdWUzMzc5NjY3NzU=,33284,`t.references` doesn't raise an error on non-existent options,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2018-07-03T16:14:06Z,2018-07-20T02:21:32Z,,NONE,,"### Steps to reproduce

1. Create a migration
2. Use `create_table` to add a table called `:users` like this:
```
create_table :users, force: true do |t|
end
```
3. Use `create_table` to add a table called `:posts` that references `:users` like this:
```
create_table :posts, force: true do |t|
  t.references :users, nnull: false, uniqe: true 
end
```
 \*\*\*\* NOTE that 'nnull' and 'uniqe' are non-existent options!! \*\*\*\*
 
4. Run the migration

I created a runnable gist to illustrate the issue here: https://gist.github.com/georgewambold/16ee14cb0e5ca77b35ff3c94b4537475

### Expected behavior
An error should be raised

### Actual behavior
The migration changes are commited without raising an error

### System configuration
**Rails version**: 6.0.0.alpha

**Ruby version**: 2.5.1

### Other notes
This is my first issue and I'd love to write the fix if the issue is accepted. 

This issue is similar to [issue 8104](https://github.com/rails/rails/issues/8104) and [PR 32675](https://github.com/rails/rails/pull/32675)
",https://api.github.com/repos/rails/rails/issues/33284/timeline,,georgewambold,13788135,MDQ6VXNlcjEzNzg4MTM1,https://avatars.githubusercontent.com/u/13788135?v=4,,https://api.github.com/users/georgewambold,https://github.com/georgewambold,https://api.github.com/users/georgewambold/followers,https://api.github.com/users/georgewambold/following{/other_user},https://api.github.com/users/georgewambold/gists{/gist_id},https://api.github.com/users/georgewambold/starred{/owner}{/repo},https://api.github.com/users/georgewambold/subscriptions,https://api.github.com/users/georgewambold/orgs,https://api.github.com/users/georgewambold/repos,https://api.github.com/users/georgewambold/events{/privacy},https://api.github.com/users/georgewambold/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33284/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
475,https://api.github.com/repos/rails/rails/issues/33270,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33270/labels{/name},https://api.github.com/repos/rails/rails/issues/33270/comments,https://api.github.com/repos/rails/rails/issues/33270/events,https://github.com/rails/rails/issues/33270,337288725,MDU6SXNzdWUzMzcyODg3MjU=,33270,Command Line guide is too narrative,"[{'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,2,2018-07-01T12:50:32Z,2022-01-10T14:37:52Z,,MEMBER,,"Reading over the [Command Line guide](http://edgeguides.rubyonrails.org/command_line.html), I find it feels too concerned with its narrative structure (complete with a side-track mention of `db:migrate` under the `rails generate` heading, because that's needed for the ""next"" command to work).

It feels like we're rehashing a sequence already covered by the Getting Started guide (which this guide calls out as a prerequisite), while that makes it trickier to fully explore each command's options in isolation: the focus is primarily (and in some cases exclusively) on which invocations are suitable to set us up for the next step. While that provides an approachable tour, I think it leaves awkwardly mixed priorities. As _the_ documentation for our CLI (they have their help output, but there's no second piece-by-piece source as there is for API docs), I believe we'd be better served with a series of semi-manpage-style content, either in full alphabetical order, or in grouped alphabetical order. 

(As originally discussed in and around https://github.com/rails/rails/pull/33229#issuecomment-401221241)",https://api.github.com/repos/rails/rails/issues/33270/timeline,,matthewd,1034,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,https://api.github.com/repos/rails/rails/issues/33270/reactions,9,0,0,0,0,0,9,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
476,https://api.github.com/repos/rails/rails/issues/33179,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33179/labels{/name},https://api.github.com/repos/rails/rails/issues/33179/comments,https://api.github.com/repos/rails/rails/issues/33179/events,https://github.com/rails/rails/issues/33179,334599069,MDU6SXNzdWUzMzQ1OTkwNjk=,33179,Integer division of ActiveSupport::Duration instance returns zero,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2018-06-21T18:03:02Z,2021-07-27T21:36:25Z,,NONE,,"### Steps to reproduce

```shell
~ rails new division_test
[ ... snip 202 lines ... ]
~ cd division_test
~ rails console

Running via Spring preloader in process 13824
Loading development environment (Rails 5.2.0)
2.3.1 :001 > 1.year / 2
 => 0 seconds
```

### Expected behavior
In previous versions of Rails this behaved reasonably and would return a new `ActiveSupport::Duration` object representing half the original duration.

The expected behaviour is still currently seen with floats, it only behaves incorrectly with integers:

```ruby
1.year / 2
=> 0 seconds

1.year / 2.0
=> 0.5 years
```

### System configuration
**Rails version**: Rails 5.2.0
**Ruby version**: ruby 2.3.1p112 (2016-04-26 revision 54768) [x86_64-darwin15]
",https://api.github.com/repos/rails/rails/issues/33179/timeline,,aarongough,170317,MDQ6VXNlcjE3MDMxNw==,https://avatars.githubusercontent.com/u/170317?v=4,,https://api.github.com/users/aarongough,https://github.com/aarongough,https://api.github.com/users/aarongough/followers,https://api.github.com/users/aarongough/following{/other_user},https://api.github.com/users/aarongough/gists{/gist_id},https://api.github.com/users/aarongough/starred{/owner}{/repo},https://api.github.com/users/aarongough/subscriptions,https://api.github.com/users/aarongough/orgs,https://api.github.com/users/aarongough/repos,https://api.github.com/users/aarongough/events{/privacy},https://api.github.com/users/aarongough/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33179/reactions,9,9,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
477,https://api.github.com/repos/rails/rails/issues/33155,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33155/labels{/name},https://api.github.com/repos/rails/rails/issues/33155/comments,https://api.github.com/repos/rails/rails/issues/33155/events,https://github.com/rails/rails/issues/33155,333434461,MDU6SXNzdWUzMzM0MzQ0NjE=,33155,has_one through not available on unpersisted instances,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2018-06-18T21:05:07Z,2022-01-11T14:06:23Z,,CONTRIBUTOR,,"Opening a new issue since the old one was marked as stale and I didn't get to it in time (doesn't seem like I can re-open it).

https://github.com/rails/rails/issues/31975

@adamlogic confirmed that this still reproduces on current master: https://github.com/rails/rails/issues/31975#issuecomment-397656705

Note: I believe the way that this works is by associating with post_id, so if that's the case it makes sense that this would be the behavior, and I suppose this becomes an enhancement request.

`Comment` knows that it has a `Post` associated with it as evidenced by the passed assertion on L66, so is it possible to leverage that relationship to make the `through` association work?

### Steps to reproduce

Script to reproduce: https://gist.github.com/zachwalton/395412f5b7e97837e6273981dbb7faf3

### Expected behavior

`owner` should be not be nil when accessed through the `has_one through` association

### Actual behavior

`owner` is nil when accessed through the `has_one through` association

### System configuration
**Rails version**: 5.1.2

**Ruby version**: 2.4.2
",https://api.github.com/repos/rails/rails/issues/33155/timeline,,zachwalton,303729,MDQ6VXNlcjMwMzcyOQ==,https://avatars.githubusercontent.com/u/303729?v=4,,https://api.github.com/users/zachwalton,https://github.com/zachwalton,https://api.github.com/users/zachwalton/followers,https://api.github.com/users/zachwalton/following{/other_user},https://api.github.com/users/zachwalton/gists{/gist_id},https://api.github.com/users/zachwalton/starred{/owner}{/repo},https://api.github.com/users/zachwalton/subscriptions,https://api.github.com/users/zachwalton/orgs,https://api.github.com/users/zachwalton/repos,https://api.github.com/users/zachwalton/events{/privacy},https://api.github.com/users/zachwalton/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33155/reactions,7,7,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
478,https://api.github.com/repos/rails/rails/issues/33036,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33036/labels{/name},https://api.github.com/repos/rails/rails/issues/33036/comments,https://api.github.com/repos/rails/rails/issues/33036/events,https://github.com/rails/rails/issues/33036,328248767,MDU6SXNzdWUzMjgyNDg3Njc=,33036,Cannot Serialize Object with no ActiveStorage Attachment to JSON,"[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,18,2018-05-31T18:29:53Z,2021-05-19T08:38:13Z,,CONTRIBUTOR,,"### Steps to reproduce

```ruby
class Foo
  has_one_attached :image
end

Foo.new.as_json
```

### Expected behavior

The serialized `Foo.new` should have an `image` field that is specified as `nil`, signifying that it has no attached `image`.

### Actual behavior

`Module::DelegationError: to_model delegated to attachment, but attachment is nil`

### System configuration
**Rails version**: 5.2.0

**Ruby version**: 2.5.1
",https://api.github.com/repos/rails/rails/issues/33036/timeline,,CodingAnarchy,5926159,MDQ6VXNlcjU5MjYxNTk=,https://avatars.githubusercontent.com/u/5926159?v=4,,https://api.github.com/users/CodingAnarchy,https://github.com/CodingAnarchy,https://api.github.com/users/CodingAnarchy/followers,https://api.github.com/users/CodingAnarchy/following{/other_user},https://api.github.com/users/CodingAnarchy/gists{/gist_id},https://api.github.com/users/CodingAnarchy/starred{/owner}{/repo},https://api.github.com/users/CodingAnarchy/subscriptions,https://api.github.com/users/CodingAnarchy/orgs,https://api.github.com/users/CodingAnarchy/repos,https://api.github.com/users/CodingAnarchy/events{/privacy},https://api.github.com/users/CodingAnarchy/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33036/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
479,https://api.github.com/repos/rails/rails/issues/33022,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/33022/labels{/name},https://api.github.com/repos/rails/rails/issues/33022/comments,https://api.github.com/repos/rails/rails/issues/33022/events,https://github.com/rails/rails/issues/33022,327796190,MDU6SXNzdWUzMjc3OTYxOTA=,33022,NoMethodError - undefined method `clear' for nil:NilClass - ConnectionHandler#establish_connection - after upgrading to rails 5.2.0,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2018-05-30T15:59:39Z,2018-06-15T05:54:06Z,,NONE,,"### Steps to reproduce
Difficult to reproduce, but it occurs in our production environment about once in every 10,000 Resque child process forks. Possibly caused by a race condition between `#discard!` and `#disconnect!` in `ActiveRecord::ConnectionAdapters::ConnectionPool`.

### Expected behavior
We have a few abstract models that inherit from ApplicationRecord and connect to different Postgres databases. We use the common pattern where where we call `#disconnect!` on each of the connection pools of these abstract models in a `Resque.before_fork` hook, and we run `#establish_connection` on each of these abstract models in a `Resque.after_fork` hook. 

It looks like this pattern is no longer necessary thanks to https://github.com/rails/rails/pull/31173. However, it sounds like we want this pattern to remain safe to use since it is widely adopted.

Expected behavior is that no error should be raised.

### Actual behavior
This error happens rarely. Possibly caused by a race condition between `#discard!` and `#disconnect!` in `ConnectionPool`.

The `@available.clear` method call fails because `@available` is nil at lib/active_record/connection_adapters/abstract/connection_pool.rb:759

Backtrace:

```
NoMethodError - undefined method `clear' for nil:NilClass
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:759:in `block in with_new_connections_blocked'
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:755:in `ensure in with_new_connections_blocked'
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:772:in `with_new_connections_blocked'
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:674:in `with_exclusively_acquired_all_connections'
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:431:in `disconnect'
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:453:in `disconnect!'
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:1025:in `remove_connection'
.../activerecord-5.2.0/lib/active_record/connection_adapters/abstract/connection_pool.rb:952:in `establish_connection'
.../activerecord-5.2.0/lib/active_record/connection_handling.rb:60:in `establish_connection'
```

### System configuration
**Rails version**: 5.2.0
**Ruby version**: 2.5.1",https://api.github.com/repos/rails/rails/issues/33022/timeline,,cliffcrosland,581562,MDQ6VXNlcjU4MTU2Mg==,https://avatars.githubusercontent.com/u/581562?v=4,,https://api.github.com/users/cliffcrosland,https://github.com/cliffcrosland,https://api.github.com/users/cliffcrosland/followers,https://api.github.com/users/cliffcrosland/following{/other_user},https://api.github.com/users/cliffcrosland/gists{/gist_id},https://api.github.com/users/cliffcrosland/starred{/owner}{/repo},https://api.github.com/users/cliffcrosland/subscriptions,https://api.github.com/users/cliffcrosland/orgs,https://api.github.com/users/cliffcrosland/repos,https://api.github.com/users/cliffcrosland/events{/privacy},https://api.github.com/users/cliffcrosland/received_events,User,False,https://api.github.com/repos/rails/rails/issues/33022/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
480,https://api.github.com/repos/rails/rails/issues/32912,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32912/labels{/name},https://api.github.com/repos/rails/rails/issues/32912/comments,https://api.github.com/repos/rails/rails/issues/32912/events,https://github.com/rails/rails/issues/32912,323855663,MDU6SXNzdWUzMjM4NTU2NjM=,32912,Incorrect polymorphic_type when STI is unused,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2018-05-17T03:01:22Z,2018-07-04T05:29:37Z,,NONE,,"I am not using STI but just inheritance. It seems that `base_class` returns superclass rather than subclass.

```ruby
# app/models/car.rb
class Car < ActiveRecord::Base
  belongs_to :borrowable, :polymorphic => true
end

# app/models/staff.rb
class Staff < ActiveRecord::Base
  has_many :cars, :as => :borrowable
end

# app/models/guard.rb
class Guard < Staff
   self.table_name = ""guards""
end
```

Note that `Staff` and `Guard` are persisted in different tables.

```ruby
irb> Guard.take.cars.to_sql
=> ""SELECT \""cars\"".* FROM \""cars\"" WHERE \""cars\"".\""borrowable_id\"" = 1 AND \""cars\"".\""borrowable_type\"" = 'Staff' ORDER BY \""cars\"".\""updated_at\"" DESC""
```

I'll make a PR to fix the issue.",https://api.github.com/repos/rails/rails/issues/32912/timeline,,FX-HAO,6838487,MDQ6VXNlcjY4Mzg0ODc=,https://avatars.githubusercontent.com/u/6838487?v=4,,https://api.github.com/users/FX-HAO,https://github.com/FX-HAO,https://api.github.com/users/FX-HAO/followers,https://api.github.com/users/FX-HAO/following{/other_user},https://api.github.com/users/FX-HAO/gists{/gist_id},https://api.github.com/users/FX-HAO/starred{/owner}{/repo},https://api.github.com/users/FX-HAO/subscriptions,https://api.github.com/users/FX-HAO/orgs,https://api.github.com/users/FX-HAO/repos,https://api.github.com/users/FX-HAO/events{/privacy},https://api.github.com/users/FX-HAO/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32912/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
481,https://api.github.com/repos/rails/rails/issues/32888,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32888/labels{/name},https://api.github.com/repos/rails/rails/issues/32888/comments,https://api.github.com/repos/rails/rails/issues/32888/events,https://github.com/rails/rails/issues/32888,323045369,MDU6SXNzdWUzMjMwNDUzNjk=,32888,ActiveRecord doesn't correctly handle Infinity values for decimal columns with a scale,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2018-05-15T02:32:39Z,2020-10-27T02:48:44Z,,NONE,,"In our codebase we use some models with decimal columns and validation for numericality and uniqueness. If the string `'Infinity'` is set as the value for a decimal field, the model's save action fails with a database exception, as it's passing the unquoted value `Infinity` straight to the database.

After digging into a root cause, I found it only happens when the decimal column has a scale parameter. ActiveRecord uses the `Decimal` type class for this case instead of `DecimalWithoutScale`. These two classes have different behaviour when handling `BigDecimal` values.

### Steps to reproduce

<details><summary>Full script to reproduce the bug:</summary>

```ruby
# frozen_string_literal: true

begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""5.2.0""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# Ensure backward compatibility with Minitest 4
Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

ActiveRecord::Base.establish_connection({
  adapter: ""sqlite3"",
  database: "":memory:"",
  prepared_statements: false,
})
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :valids, force: true do |t|
    t.decimal :value, precision: 10
  end

  create_table :invalids, force: true do |t|
    t.decimal :value, precision: 10, scale: 1
  end
end

class Valid < ActiveRecord::Base
  validates :value, presence: true, numericality: true, uniqueness: true
end

class Invalid < ActiveRecord::Base
  # NOTE: Removing the uniqueness check here makes the validation work correctly
  validates :value, presence: true, numericality: true, uniqueness: true
end

class BugTest < Minitest::Test
  def test_infinity_no_scale
    valid = Valid.new(value: 'Infinity')
    saved = valid.save
    assert !saved
    assert_equal valid.errors[:value], [""is not a number""]
  end

  def test_infinity_with_scale
    invalid = Invalid.new(value: 'Infinity')
    # BUG: This save will fail with an exception:
    #   ActiveRecord::StatementInvalid: SQLite3::SQLException: no such column: Infinity:
    #     SELECT  1 AS one FROM ""invalids"" WHERE ""invalids"".""value"" = Infinity LIMIT 1
    saved = invalid.save
    assert !saved
    assert_equal invalid.errors[:value], [""is not a number""]
  end
end
```
</details>

### Expected behavior
When setting `'Infinity'` as the value, saving the model should return `false` with a ""not a number"" error message.

### Actual behavior
If the decimal column has a `0` scale, the `'Infinity'` string is type cast to `nil` and the validations work as expected.

If the decimal column has a scale greater than 0, the numericality validation works as expect (it adds the ""not a number"" error,) but the uniqueness check passes a `BigDecimal::INFINITY` value to the database without quoting it. The database then returns an exception:

```
ActiveRecord::StatementInvalid: Mysql2::Error: Unknown column 'Infinity' in 'where clause': SELECT  1 AS one FROM `invalids` WHERE `invalids`.`value` = Infinity LIMIT 1
```

I've seen this fail in SQLite, MySQL and SQL Server.

From searching through existing issues, it seems to be related to https://github.com/rails/rails/issues/21262#issuecomment-293987939

### System configuration
**Rails version**: 5.2.0 — but I've also seen it fail in 5.1.5 and 3.2.22

**Ruby version**: 2.3.4
",https://api.github.com/repos/rails/rails/issues/32888/timeline,,gilmoreorless,159415,MDQ6VXNlcjE1OTQxNQ==,https://avatars.githubusercontent.com/u/159415?v=4,,https://api.github.com/users/gilmoreorless,https://github.com/gilmoreorless,https://api.github.com/users/gilmoreorless/followers,https://api.github.com/users/gilmoreorless/following{/other_user},https://api.github.com/users/gilmoreorless/gists{/gist_id},https://api.github.com/users/gilmoreorless/starred{/owner}{/repo},https://api.github.com/users/gilmoreorless/subscriptions,https://api.github.com/users/gilmoreorless/orgs,https://api.github.com/users/gilmoreorless/repos,https://api.github.com/users/gilmoreorless/events{/privacy},https://api.github.com/users/gilmoreorless/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32888/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
482,https://api.github.com/repos/rails/rails/issues/32803,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32803/labels{/name},https://api.github.com/repos/rails/rails/issues/32803/comments,https://api.github.com/repos/rails/rails/issues/32803/events,https://github.com/rails/rails/issues/32803,319978834,MDU6SXNzdWUzMTk5Nzg4MzQ=,32803,wrap_parameters drops attributes for has_and_belongs_to_many association ,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2018-05-03T15:50:20Z,2019-12-20T14:37:53Z,,CONTRIBUTOR,,"When posting a flat JSON request to a controller which has wrap_parameters enabled for an associated model, the key-value for any has_and_belongs_to_many association is not present in the wrapped parameters.

### Steps to reproduce

```ruby
class User < ActiveRecord::Base
  has_and_belongs_to_many :roles
end

class UsersController < ActionController::Base
  wrap_parameters User, format: [:json]
end
```

The role_ids **are not** present when posting the user data in a **flat** JSON request, such as:

```json
{
  ""name"":     ""Doe"",
  ""role_ids"": [1, 2]
}
```

### Actual behavior

The actual params in the controller:

```ruby
{ ""name"" => ""Doe"", ""role_ids"" => [1, 2], ""user"" => { ""name"" => ""Doe"" } }
```

Note how the wrapped ""user"" params do not include the role_ids key.

### Expected behavior

The expected params in the controller:

```ruby
{ ""name"" => ""Doe"", ""role_ids"" => [1, 2], ""user"" => { ""name"" => ""Doe"", ""role_ids"" => [1, 2] } }
```

### System configuration

**Rails version**: <= v5.2.0

**Ruby version**: 2.5.0
",https://api.github.com/repos/rails/rails/issues/32803/timeline,,eikes,219275,MDQ6VXNlcjIxOTI3NQ==,https://avatars.githubusercontent.com/u/219275?v=4,,https://api.github.com/users/eikes,https://github.com/eikes,https://api.github.com/users/eikes/followers,https://api.github.com/users/eikes/following{/other_user},https://api.github.com/users/eikes/gists{/gist_id},https://api.github.com/users/eikes/starred{/owner}{/repo},https://api.github.com/users/eikes/subscriptions,https://api.github.com/users/eikes/orgs,https://api.github.com/users/eikes/repos,https://api.github.com/users/eikes/events{/privacy},https://api.github.com/users/eikes/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32803/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
483,https://api.github.com/repos/rails/rails/issues/32770,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32770/labels{/name},https://api.github.com/repos/rails/rails/issues/32770/comments,https://api.github.com/repos/rails/rails/issues/32770/events,https://github.com/rails/rails/pull/32770,319052027,MDExOlB1bGxSZXF1ZXN0MTg1MDc3MTE3,32770,Request Forgery takes relative paths into account,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,5,2018-04-30T22:05:40Z,2021-10-22T20:51:56Z,,CONTRIBUTOR,,"Passing relative paths into form_for and related / derived helpers led to invalid
token generations, as the tokens did not match the request.path on the
POST endpoint. Variants, such as:

```
form_for url: """" do
```

Wouldn't generate a matching csrf-token and led to an InvalidAuthenticityToken.

I've added test + code to handle the common cases, such as:

* """"
* ""./""
* ""./post_one""
* ""post_one""

are now handled according to [RFC 3986 5.2 - 5.4](https://tools.ietf.org/html/rfc3986#section-5.2). 


Not implemented from RFC: double dots are not handled (../../path)

relevant/ fixing issue: #31191
",https://api.github.com/repos/rails/rails/issues/32770/timeline,,zealot128,147175,MDQ6VXNlcjE0NzE3NQ==,https://avatars.githubusercontent.com/u/147175?v=4,,https://api.github.com/users/zealot128,https://github.com/zealot128,https://api.github.com/users/zealot128/followers,https://api.github.com/users/zealot128/following{/other_user},https://api.github.com/users/zealot128/gists{/gist_id},https://api.github.com/users/zealot128/starred{/owner}{/repo},https://api.github.com/users/zealot128/subscriptions,https://api.github.com/users/zealot128/orgs,https://api.github.com/users/zealot128/repos,https://api.github.com/users/zealot128/events{/privacy},https://api.github.com/users/zealot128/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32770/reactions,2,1,0,0,1,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/32770,https://github.com/rails/rails/pull/32770,https://github.com/rails/rails/pull/32770.diff,https://github.com/rails/rails/pull/32770.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
484,https://api.github.com/repos/rails/rails/issues/32476,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32476/labels{/name},https://api.github.com/repos/rails/rails/issues/32476/comments,https://api.github.com/repos/rails/rails/issues/32476/events,https://github.com/rails/rails/issues/32476,311889316,MDU6SXNzdWUzMTE4ODkzMTY=,32476,has_many does not update on save if parent has not been changed,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,8,2018-04-06T08:28:23Z,2019-11-18T06:41:10Z,,NONE,,"### Steps to reproduce
I have the following relationship between models:

    class Gift 
        has_and_belongs_to_many :constituents, :autosave => true
        accepts_nested_attributes_for :constituents
    end


    class Constituent
        has_and_belongs_to_many :gifts
        has_many :addresses, :autosave => true
    end

    class Address 
        belongs_to :constituent
    end
    
In my controller, I am simply running the `save!` method:
    
    def create
        @gift.assign_attributes gift_params
        p @gift.constituents[0].changed? #Should print false
        p @gift.constituents[0].addresses[0].changed? #Should print true
        @gift.save!
    end

    def gift_params
        params.require(:gift).permit(:amount, :constituents_attributes => [:id, :organization_name, :title_id, :first_name, :last_name, :addresses_attributes => [ :id, :address_type, :address1, :address2, :city, :country_id, :state_id, :pin_code, :constituent_id ]])
    end

Pass the params to the action, such that there is some change in the address record, but not in the constituent record.

### Expected behavior

The `address` record should be updated irrespective of whether or not there are changes in its `constituent` record.

### Actual behavior
The `address` record gets updated only if there are changes in the `constituent` record. Otherwise, it is not updated EVEN IF there are changes in the `address` record.

It works if I add this to the action:

    @donation.constituents[0].addresses.each do |a|
            a.save! if a.changed?
    end

### System configuration
**Rails version**:
5.0.6
**Ruby version**:
2.4.1p111",https://api.github.com/repos/rails/rails/issues/32476/timeline,,mri-dula,1460035,MDQ6VXNlcjE0NjAwMzU=,https://avatars.githubusercontent.com/u/1460035?v=4,,https://api.github.com/users/mri-dula,https://github.com/mri-dula,https://api.github.com/users/mri-dula/followers,https://api.github.com/users/mri-dula/following{/other_user},https://api.github.com/users/mri-dula/gists{/gist_id},https://api.github.com/users/mri-dula/starred{/owner}{/repo},https://api.github.com/users/mri-dula/subscriptions,https://api.github.com/users/mri-dula/orgs,https://api.github.com/users/mri-dula/repos,https://api.github.com/users/mri-dula/events{/privacy},https://api.github.com/users/mri-dula/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32476/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
485,https://api.github.com/repos/rails/rails/issues/32276,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32276/labels{/name},https://api.github.com/repos/rails/rails/issues/32276/comments,https://api.github.com/repos/rails/rails/issues/32276/events,https://github.com/rails/rails/issues/32276,306159949,MDU6SXNzdWUzMDYxNTk5NDk=,32276,Has many through _ids setter raises an exception when saving safely.,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2018-03-17T14:19:05Z,2022-04-22T06:49:22Z,,NONE,,"### Steps to reproduce

```
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  gem ""rails"", github: ""rails/rails""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
    create_table :users do |t|
      t.string :email, null: false

      t.timestamps
    end

    create_table :accounts do |t|
      t.string :name, null: false

      t.timestamps
    end

    create_table :account_users do |t|
      t.references :user, foreign_key: true
      t.references :account, foreign_key: true

      t.timestamps
    end
end

class User < ApplicationRecord
  has_many :account_users
  has_many :accounts, through: :account_users
end

class Account < ApplicationRecord
  has_many :account_users
  has_many :users, through: :account_users
end

class AccountUser < ApplicationRecord
  belongs_to :user
  belongs_to :account

  validate :something_goes_wrong

  def something_goes_wrong
    errors.add(:base, 'error')
  end
end

class BugTest < Minitest::Test
  def test_has_many_through_ids_setter
    user = User.create!(email: 'test@test.com')
    account = Account.create!(name: 'Test')
    assert_equal false, user.update(account_ids: [account.id])
  end
end
```

### Actual behavior
Raises an exception
```
  Account Load (0.4ms)  SELECT ""accounts"".* FROM ""accounts"" WHERE ""accounts"".""id"" = 1
  Account Load (0.1ms)  SELECT ""accounts"".* FROM ""accounts"" INNER JOIN ""account_users"" ON ""accounts"".""id"" = ""account_users"".""account_id"" WHERE ""account_users"".""user_id"" = ?  [[""user_id"", 1]]
   (0.2ms)  rollback transaction
ActiveRecord::RecordInvalid: Validation failed: error
	from (irb):6
```

### System configuration
**Rails version**: 5.1.5

**Ruby version**: 2.3.1
",https://api.github.com/repos/rails/rails/issues/32276/timeline,,matiasgarcia,2261869,MDQ6VXNlcjIyNjE4Njk=,https://avatars.githubusercontent.com/u/2261869?v=4,,https://api.github.com/users/matiasgarcia,https://github.com/matiasgarcia,https://api.github.com/users/matiasgarcia/followers,https://api.github.com/users/matiasgarcia/following{/other_user},https://api.github.com/users/matiasgarcia/gists{/gist_id},https://api.github.com/users/matiasgarcia/starred{/owner}{/repo},https://api.github.com/users/matiasgarcia/subscriptions,https://api.github.com/users/matiasgarcia/orgs,https://api.github.com/users/matiasgarcia/repos,https://api.github.com/users/matiasgarcia/events{/privacy},https://api.github.com/users/matiasgarcia/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32276/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
486,https://api.github.com/repos/rails/rails/issues/32238,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32238/labels{/name},https://api.github.com/repos/rails/rails/issues/32238/comments,https://api.github.com/repos/rails/rails/issues/32238/events,https://github.com/rails/rails/pull/32238,304755601,MDExOlB1bGxSZXF1ZXN0MTc0NjUyNjk0,32238,Make Active Storage work with API-only apps,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,27,2018-03-13T13:03:08Z,2022-02-06T11:40:51Z,,CONTRIBUTOR,,"Inherit from ActionController::API and include only the required features.

Fixes #32208.",https://api.github.com/repos/rails/rails/issues/32238/timeline,,pixeltrix,6321,MDQ6VXNlcjYzMjE=,https://avatars.githubusercontent.com/u/6321?v=4,,https://api.github.com/users/pixeltrix,https://github.com/pixeltrix,https://api.github.com/users/pixeltrix/followers,https://api.github.com/users/pixeltrix/following{/other_user},https://api.github.com/users/pixeltrix/gists{/gist_id},https://api.github.com/users/pixeltrix/starred{/owner}{/repo},https://api.github.com/users/pixeltrix/subscriptions,https://api.github.com/users/pixeltrix/orgs,https://api.github.com/users/pixeltrix/repos,https://api.github.com/users/pixeltrix/events{/privacy},https://api.github.com/users/pixeltrix/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32238/reactions,6,6,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/32238,https://github.com/rails/rails/pull/32238,https://github.com/rails/rails/pull/32238.diff,https://github.com/rails/rails/pull/32238.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
487,https://api.github.com/repos/rails/rails/issues/32208,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32208/labels{/name},https://api.github.com/repos/rails/rails/issues/32208/comments,https://api.github.com/repos/rails/rails/issues/32208/events,https://github.com/rails/rails/issues/32208,303653126,MDU6SXNzdWUzMDM2NTMxMjY=,32208,Make ActiveStorage work for API only apps,"[{'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,34,2018-03-08T22:18:34Z,2022-04-21T22:43:58Z,,NONE,,"I have a Rails API serving a React SPA. It works perfect but I had to do a modification to use ActiveStorage's direct uploads.

The problem appears when trying to create a direct upload (i.e. a Blob).  `ActiveStorage::DirectUploadsController` will fail with some errors which I believe are expected on a normal app but not on an API controllers. These are the errors:

- `HTTP Origin header (http://localhost:3001/) didn't match request.base_url (http://localhost:3000)`
- `Can't verify CSRF token authenticity.`

My solution has been to change this line:
https://github.com/rails/rails/blob/4ec8bf68ff92f35e79232fbd605012ce1f4e1e6e/activestorage/app/controllers/active_storage/direct_uploads_controller.rb#L6

and make:
`class ActiveStorage::DirectUploadsController < ApplicationController`

I think the problem is solved because my `ApplicationController` inherits from `ActionController::API`.

If my assumptions are correct, shouldn't ActiveStorage controllers inherit from `ActionController::API` or `ActionController::Base` depending on `config.api_only = true`?",https://api.github.com/repos/rails/rails/issues/32208/timeline,,hector,34079,MDQ6VXNlcjM0MDc5,https://avatars.githubusercontent.com/u/34079?v=4,,https://api.github.com/users/hector,https://github.com/hector,https://api.github.com/users/hector/followers,https://api.github.com/users/hector/following{/other_user},https://api.github.com/users/hector/gists{/gist_id},https://api.github.com/users/hector/starred{/owner}{/repo},https://api.github.com/users/hector/subscriptions,https://api.github.com/users/hector/orgs,https://api.github.com/users/hector/repos,https://api.github.com/users/hector/events{/privacy},https://api.github.com/users/hector/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32208/reactions,32,32,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
488,https://api.github.com/repos/rails/rails/issues/32198,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32198/labels{/name},https://api.github.com/repos/rails/rails/issues/32198/comments,https://api.github.com/repos/rails/rails/issues/32198/events,https://github.com/rails/rails/issues/32198,303527139,MDU6SXNzdWUzMDM1MjcxMzk=,32198,System tests - Preventing run multiple sessions for given test,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2018-03-08T15:45:48Z,2019-07-06T16:51:27Z,,NONE,,"### Steps to reproduce

Capybara uses default name for session as follows: `Capybara.session_name` = `:default`. This preventing Capybara to recognise multiple sessions and uses only first match.

```ruby
Capybara.session_name 
=> :default

ActionDispatch::SystemTestCase.driven_by :poltergeist

Capybara.session_name 
=> :default

ActionDispatch::SystemTestCase.driven_by :selenium, using: :firefox

Capybara.session_name 
=> :default
```

### Expected behavior

We would like to do things like this:

```ruby
  RSpec.configure do |config|
     config.around(:each) do |example|
        if example.metadata[:type] == :system 
         [:safari_mac_high_sierra, :firefox_mac_high_sierra, :chrome_mac_high_sierra, :chrome_ios_iphone_x].each do |driver|
             ActionDispatch::SystemTestCase.driven_by :selenium, using: driver
             example.run
         end
     else
       example.run
     end
  end
```
### Actual behaviour

Capybara session name should not always use `:default` as session name preventing sites use multiple combination per test suite.

### System configuration
**Rails version**:
5.1.4

**Ruby version**:
2.5.0p0
",https://api.github.com/repos/rails/rails/issues/32198/timeline,,pavel-jurasek,7910967,MDQ6VXNlcjc5MTA5Njc=,https://avatars.githubusercontent.com/u/7910967?v=4,,https://api.github.com/users/pavel-jurasek,https://github.com/pavel-jurasek,https://api.github.com/users/pavel-jurasek/followers,https://api.github.com/users/pavel-jurasek/following{/other_user},https://api.github.com/users/pavel-jurasek/gists{/gist_id},https://api.github.com/users/pavel-jurasek/starred{/owner}{/repo},https://api.github.com/users/pavel-jurasek/subscriptions,https://api.github.com/users/pavel-jurasek/orgs,https://api.github.com/users/pavel-jurasek/repos,https://api.github.com/users/pavel-jurasek/events{/privacy},https://api.github.com/users/pavel-jurasek/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32198/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
489,https://api.github.com/repos/rails/rails/issues/32140,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32140/labels{/name},https://api.github.com/repos/rails/rails/issues/32140/comments,https://api.github.com/repos/rails/rails/issues/32140/events,https://github.com/rails/rails/issues/32140,301142583,MDU6SXNzdWUzMDExNDI1ODM=,32140,Issues with Associations::Preloader used as a Public API,"[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,11,2018-02-28T18:59:33Z,2020-11-13T01:17:07Z,,NONE,,"Recently @eileencodes made me aware of this PullRequest https://github.com/rails/rails/pull/32136 and plans to possibly make `Preloader` a Public API.

We've been using `Associations:Preloader` at GitHub as part of our https://github.com/Shopify/graphql-batch setup to preload associations during GraphQL queries. Over the past month we've hit some pretty nasty issues with it. I believe these may have to be fixed before making the Preloader a public concern.

### Loading already loaded records

The main issue is this line: https://github.com/rails/rails/blob/master/activerecord/lib/active_record/associations/preloader.rb#L180

When preloading an association on a list of records, if this association is already loaded on the first record of the list, it is assumed that the whole list is loaded. In these cases, a `AlreadyLoaded` preloader is returned, and uses `association(name).target` to read the preloaded records.

In a public setting, I don't think we can make this assumption, in fact, using `preload` with a list of records might result in this scenario:

```ruby
a = Record.create!
b = Record.create!
c = Record.create!

a.some_association.create!

preloaders = ActiveRecord::Associations::Preloader.new.preload([a,b,c], [:some_association])

preloaders.first.preloaded_records
=> [Only the association for a is preloaded]
```

At GitHub we worked around this problem by always checking if the association was already loaded, before passing a record to `Preloader`, filtering them out if needed. That solved most issues until we hit issues that were out of our control.

Take through associations for example:
https://github.com/rails/rails/blob/master/activerecord/lib/active_record/associations/preloader/through_association.rb#L8-L14

If we take

```
has_many :patients, through: :appointments , source: :client
```

First, appointments are preloaded on patients. Then, `client` is preloaded on all patients. If the first appointment's client was already loaded, we'll get back only the client.

When returning the preloaded records, we'll try to get the target association on all records, but the whole tail of the list of records will be `nil` because they weren't actually loaded.

In certain versions of Rails, `association.reader` is used instead of `target` if the association is not loaded. This is almost worst because it will silently generate N+1's.

Another gotcha this behaviour introduces is that you cannot use `Preloader` with different types of records / associations.

For example, one issue we hit was that we were preloading an association on two different types of records at the same time:

```
Preloader.new.preload([doctor, patient, patient_b], [:appointment])
```

In our case, `appoitments` on one of the records was a `has_one through:`, and the other one was a `belongs to`. During the `has_one through` preloading logic, an association was loaded on the other kind of record. When it was time to load the second kind of record, since the association was already loaded for the first record, Preloader was skipping the whole list again.

If needed, I can provide failing tests for some of these tricky scenarios.

### Preloading different object_ids

Another smaller issue is that the preloader currently `uniq!` the records before preloading them. This means that passing multiple objects for the same record will result in only the first record being preloaded.

We work around that by deduping the records before passing them to Preloader, and we copy over the associations after.

### Takeaways

Currently, Rails assumes the preloader is ran in a certain context (its a private API right now after all). It breaks quickly when its used in other ways. It would be really awesome for us to make it a Public API, and it would be great to find a way around these gotchas!

cc @eileencodes @tenderlove",https://api.github.com/repos/rails/rails/issues/32140/timeline,,xuorig,1919498,MDQ6VXNlcjE5MTk0OTg=,https://avatars.githubusercontent.com/u/1919498?v=4,,https://api.github.com/users/xuorig,https://github.com/xuorig,https://api.github.com/users/xuorig/followers,https://api.github.com/users/xuorig/following{/other_user},https://api.github.com/users/xuorig/gists{/gist_id},https://api.github.com/users/xuorig/starred{/owner}{/repo},https://api.github.com/users/xuorig/subscriptions,https://api.github.com/users/xuorig/orgs,https://api.github.com/users/xuorig/repos,https://api.github.com/users/xuorig/events{/privacy},https://api.github.com/users/xuorig/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32140/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
490,https://api.github.com/repos/rails/rails/issues/32136,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32136/labels{/name},https://api.github.com/repos/rails/rails/issues/32136/comments,https://api.github.com/repos/rails/rails/issues/32136/events,https://github.com/rails/rails/pull/32136,300844176,MDExOlB1bGxSZXF1ZXN0MTcxODIzMjI0,32136,Add delayed preloading for arrays of records,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,12,2018-02-28T00:20:36Z,2021-01-14T17:00:58Z,,CONTRIBUTOR,,"### Summary

Adds method Relation#load_associations(arr, *args) which accepts an array
of records and args to preload. Useful for when a loaded list is filtered
in ruby to produce an Array and we want to preload the records in this Array.
Effectively exposes `Preloader.preload(records, associations, preload_scope = nil)`
without requiring people to know about a separate Preloader class.

### Todo
- [x] Documentation
- [x] CHANGELOG

cc/ @matthewd ",https://api.github.com/repos/rails/rails/issues/32136/timeline,,dinahshi,5495713,MDQ6VXNlcjU0OTU3MTM=,https://avatars.githubusercontent.com/u/5495713?v=4,,https://api.github.com/users/dinahshi,https://github.com/dinahshi,https://api.github.com/users/dinahshi/followers,https://api.github.com/users/dinahshi/following{/other_user},https://api.github.com/users/dinahshi/gists{/gist_id},https://api.github.com/users/dinahshi/starred{/owner}{/repo},https://api.github.com/users/dinahshi/subscriptions,https://api.github.com/users/dinahshi/orgs,https://api.github.com/users/dinahshi/repos,https://api.github.com/users/dinahshi/events{/privacy},https://api.github.com/users/dinahshi/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32136/reactions,6,6,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/32136,https://github.com/rails/rails/pull/32136,https://github.com/rails/rails/pull/32136.diff,https://github.com/rails/rails/pull/32136.patch,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
491,https://api.github.com/repos/rails/rails/issues/32135,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32135/labels{/name},https://api.github.com/repos/rails/rails/issues/32135/comments,https://api.github.com/repos/rails/rails/issues/32135/events,https://github.com/rails/rails/pull/32135,300822886,MDExOlB1bGxSZXF1ZXN0MTcxODA3MzYz,32135,Avoid explicit usage `Base.connections` as sub-classes may override,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'eileencodes', 'id': 1080678, 'node_id': 'MDQ6VXNlcjEwODA2Nzg=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1080678?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/eileencodes', 'html_url': 'https://github.com/eileencodes', 'followers_url': 'https://api.github.com/users/eileencodes/followers', 'following_url': 'https://api.github.com/users/eileencodes/following{/other_user}', 'gists_url': 'https://api.github.com/users/eileencodes/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/eileencodes/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/eileencodes/subscriptions', 'organizations_url': 'https://api.github.com/users/eileencodes/orgs', 'repos_url': 'https://api.github.com/users/eileencodes/repos', 'events_url': 'https://api.github.com/users/eileencodes/events{/privacy}', 'received_events_url': 'https://api.github.com/users/eileencodes/received_events', 'type': 'User', 'site_admin': False}]",,14,2018-02-27T22:47:05Z,2021-01-14T17:00:56Z,,CONTRIBUTOR,,"### Summary

In some multi-server setups, it's desirable to have multiple sets of
configurations. Unfortunately this code path makes the assumption that
`Base.configurations` is valid for the current class which isn't the case
if the class overrides `::configurations`.",https://api.github.com/repos/rails/rails/issues/32135/timeline,,ioquatix,30030,MDQ6VXNlcjMwMDMw,https://avatars.githubusercontent.com/u/30030?v=4,,https://api.github.com/users/ioquatix,https://github.com/ioquatix,https://api.github.com/users/ioquatix/followers,https://api.github.com/users/ioquatix/following{/other_user},https://api.github.com/users/ioquatix/gists{/gist_id},https://api.github.com/users/ioquatix/starred{/owner}{/repo},https://api.github.com/users/ioquatix/subscriptions,https://api.github.com/users/ioquatix/orgs,https://api.github.com/users/ioquatix/repos,https://api.github.com/users/ioquatix/events{/privacy},https://api.github.com/users/ioquatix/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32135/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/32135,https://github.com/rails/rails/pull/32135,https://github.com/rails/rails/pull/32135.diff,https://github.com/rails/rails/pull/32135.patch,,eileencodes,1080678.0,MDQ6VXNlcjEwODA2Nzg=,https://avatars.githubusercontent.com/u/1080678?v=4,,https://api.github.com/users/eileencodes,https://github.com/eileencodes,https://api.github.com/users/eileencodes/followers,https://api.github.com/users/eileencodes/following{/other_user},https://api.github.com/users/eileencodes/gists{/gist_id},https://api.github.com/users/eileencodes/starred{/owner}{/repo},https://api.github.com/users/eileencodes/subscriptions,https://api.github.com/users/eileencodes/orgs,https://api.github.com/users/eileencodes/repos,https://api.github.com/users/eileencodes/events{/privacy},https://api.github.com/users/eileencodes/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
492,https://api.github.com/repos/rails/rails/issues/32024,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/32024/labels{/name},https://api.github.com/repos/rails/rails/issues/32024/comments,https://api.github.com/repos/rails/rails/issues/32024/events,https://github.com/rails/rails/issues/32024,297920973,MDU6SXNzdWUyOTc5MjA5NzM=,32024,`build_association` on `belongs_to` does not add the builder to has_many association,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,13,2018-02-16T21:10:43Z,2020-05-08T18:27:41Z,,NONE,,"### Steps to reproduce

When `build_association` is called on a `belongs_to` relation, then the model does not get added to the inverse `has_many` relation. This behavior can also be observed when assigning a new record directly to the `belong_to` association.

```ruby
# frozen_string_literal: true

begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""

  git_source(:github) { |repo| ""https://github.com/#{repo}.git"" }

  # Activate the gem you are reporting the issue against.
  gem ""activerecord"", ""5.1.5""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# Ensure backward compatibility with Minitest 4
Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :posts, force: true do |t|
  end

  create_table :authors, force: true do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_many :authors

  validates :authors, length: { minimum: 1 }
end

class Author < ActiveRecord::Base
  belongs_to :post
end

class BugTest < Minitest::Test

  def test_build_association_adds_to_inverse
    author = Author.new

    post = author.build_post

    assert_equal 1, post.authors.length
    assert_equal author, post.authors.first
    assert_predicate author, :valid?
    assert_predicate post, :valid?
    assert author.save
  end

  def test_assigning_belongs_to_adds_to_inverse
    author = Author.new
    post = Post.new

    author.post = post

    assert_equal 1, post.authors.length
    assert_equal author, post.authors.first
    assert_predicate author, :valid?
    assert_predicate post, :valid?
    assert author.save
  end

end
```
 
### Expected behavior

I expect the `Post` model to know about the author, through which it was built. This would match the behavior observed, when used the other way round. (`post.authors.build` actually assigns the inverse `post` and `post = authors.build_post` results in `authors.post == post` being `true`) 

### Actual behavior

The `authors` relation is blank. Hence, the validations on the `Post` model are failing. Neither am I able to then save `Post` nor the `Author` model, without me explicitly adding the `Author` model to the `post.authors` relation.

### System configuration
**Rails version**:
5.1.5
**Ruby version**:
2.3.6",https://api.github.com/repos/rails/rails/issues/32024/timeline,,matthee,547653,MDQ6VXNlcjU0NzY1Mw==,https://avatars.githubusercontent.com/u/547653?v=4,,https://api.github.com/users/matthee,https://github.com/matthee,https://api.github.com/users/matthee/followers,https://api.github.com/users/matthee/following{/other_user},https://api.github.com/users/matthee/gists{/gist_id},https://api.github.com/users/matthee/starred{/owner}{/repo},https://api.github.com/users/matthee/subscriptions,https://api.github.com/users/matthee/orgs,https://api.github.com/users/matthee/repos,https://api.github.com/users/matthee/events{/privacy},https://api.github.com/users/matthee/received_events,User,False,https://api.github.com/repos/rails/rails/issues/32024/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
493,https://api.github.com/repos/rails/rails/issues/31985,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/31985/labels{/name},https://api.github.com/repos/rails/rails/issues/31985/comments,https://api.github.com/repos/rails/rails/issues/31985/events,https://github.com/rails/rails/issues/31985,296830494,MDU6SXNzdWUyOTY4MzA0OTQ=,31985,ActiveStorage: invalid Attachment when last step of direct upload fails,"[{'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 664533972, 'node_id': 'MDU6TGFiZWw2NjQ1MzM5NzI=', 'url': 'https://api.github.com/repos/rails/rails/labels/activestorage', 'name': 'activestorage', 'color': 'bfd4f2', 'default': False, 'description': None}]",open,False,,[],,12,2018-02-13T17:56:05Z,2022-01-14T14:27:59Z,,NONE,,"I am trying to handle the case where the last step of a direct upload fails (the `PATCH` call to my model), and I have noticed an odd behaviour. Here goes:

### Steps to reproduce
- Set up the `Profile` model with `has_one_attached :document`.
- Create an instance of `Profile` (referred to as `profile`)
- Use a direct upload form to attach a document to `profile` (controller and view code below)
- Everything works fine so far, I can see the image and its filename.
- Force a failure in the `PATCH` call to `/profile/document`: intentionally modify a validation in the Profile model so that any call to Profile#update fails
- Upload another document for the same Profile, and watch the `PATCH` fail.

### Expected behavior
When this last step fails, I'd expect the whole state of my app to go back to its state from before the beginning of the upload process (the `POST` call to `rails/active_storage/direct_uploads`).

I'd also expect the former file to still be there on the storage, and the new one to not be there.

### Actual behavior
The Attachment record for my Profile is still the same, but the original Blob was destroyed, and replaced by a new one (created by the first `POST` to `rails/active_storage/direct_uploads`). The Attachment points to the destroyed Blob.

`profile.document.attached?` returns `true`, but other methods, e.g. `filename` or `service_url` are undefined. This breaks my views: the if passes, the statements inside break.

S3/Disk contains the new file, and does not contain the former one.

The logs tell me that the first call from the client to `/rails/active_storage/direct_uploads` creates a Blob. Then, after the upload to S3 is done, the `PATCH` call to `/profile/document` destroys the former Attachment and creates a new one, but this is all rolled back when my validation fails. However, it also enqueues a job that purges the former Blob, instead of purging the newly created one.

From my understanding, what this job does should depend upon the success of the `PATCH` call. Is this an actual bug, or am I supposed to handle this manually? Or maybe there's just another way to write things and make it work automagically?

One workaround I found is to call purge or detach on the document when the update fails. From a user's point of view it removes the former document, which isn't so nice, but at least my views don't break. The Attachment is destroyed, the Blob remains, the former file is destroyed, the new one is stored. This fix is commented out in the code sample.

### System configuration
I get the bug on my local environment, both with S3 and Disk as targets.

**Rails version**:
Rails 5.2.0.rc1

**Ruby version**:
ruby 2.5.0p0 (2017-12-25 revision 61468) [x86_64-darwin17]

### Code samples
Adapted for better readability.
```
class ProfilesController < ApplicationController
  def update
    if current_user.profile.update(document_params)
      flash[:notice] = ""Your document was successfully uploaded""
    else
      # current_profile.reload.identity_document.purge # The fix
      flash[:alert] = ""Something went wrong.""
    end
    redirect_to my_form_url
  end

  private

  def document_params
    params.require(:profile).permit(:document)
  end
end
```

```
<% if @profile.document.attached? %>
    <%= @profile.document.filename %>
    <%= image_tag @profile.document %>
<% else %>
    No document yet
<% end %>

<%= form_for @profile do |f| %>
    <%= f.file_field :document, direct_upload: true %>
    <%= f.submit %>
<% end %>
```
Thanks in advance for your help!",https://api.github.com/repos/rails/rails/issues/31985/timeline,,SimonFrr,3263575,MDQ6VXNlcjMyNjM1NzU=,https://avatars.githubusercontent.com/u/3263575?v=4,,https://api.github.com/users/SimonFrr,https://github.com/SimonFrr,https://api.github.com/users/SimonFrr/followers,https://api.github.com/users/SimonFrr/following{/other_user},https://api.github.com/users/SimonFrr/gists{/gist_id},https://api.github.com/users/SimonFrr/starred{/owner}{/repo},https://api.github.com/users/SimonFrr/subscriptions,https://api.github.com/users/SimonFrr/orgs,https://api.github.com/users/SimonFrr/repos,https://api.github.com/users/SimonFrr/events{/privacy},https://api.github.com/users/SimonFrr/received_events,User,False,https://api.github.com/repos/rails/rails/issues/31985/reactions,12,12,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
494,https://api.github.com/repos/rails/rails/issues/31595,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/31595/labels{/name},https://api.github.com/repos/rails/rails/issues/31595/comments,https://api.github.com/repos/rails/rails/issues/31595/events,https://github.com/rails/rails/pull/31595,285164211,MDExOlB1bGxSZXF1ZXN0MTYwNTY2Nzcx,31595,Support multiple preview paths for mailers,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 1072773639, 'node_id': 'MDU6TGFiZWwxMDcyNzczNjM5', 'url': 'https://api.github.com/repos/rails/rails/labels/ready', 'name': 'ready', 'color': 'fef2c0', 'default': False, 'description': 'PRs ready to merge'}]",open,False,,"[{'login': 'kamipo', 'id': 12642, 'node_id': 'MDQ6VXNlcjEyNjQy', 'avatar_url': 'https://avatars.githubusercontent.com/u/12642?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kamipo', 'html_url': 'https://github.com/kamipo', 'followers_url': 'https://api.github.com/users/kamipo/followers', 'following_url': 'https://api.github.com/users/kamipo/following{/other_user}', 'gists_url': 'https://api.github.com/users/kamipo/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kamipo/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kamipo/subscriptions', 'organizations_url': 'https://api.github.com/users/kamipo/orgs', 'repos_url': 'https://api.github.com/users/kamipo/repos', 'events_url': 'https://api.github.com/users/kamipo/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kamipo/received_events', 'type': 'User', 'site_admin': False}]",,17,2017-12-29T22:32:11Z,2021-07-06T20:26:54Z,,CONTRIBUTOR,,"It should be great to see mailer previews from engines. This PR allows to do this.

Originated from a bit outdated https://github.com/rails/rails/pull/16836.
Notable changes compared to that PR:
- `config.action_mailer.preview_path` deprecating
- Engine initializer to automatically add mailer preview paths to the lookup path for mailer previews for the application

Thanks in advance.",https://api.github.com/repos/rails/rails/issues/31595/timeline,,fatkodima,5657035,MDQ6VXNlcjU2NTcwMzU=,https://avatars.githubusercontent.com/u/5657035?v=4,,https://api.github.com/users/fatkodima,https://github.com/fatkodima,https://api.github.com/users/fatkodima/followers,https://api.github.com/users/fatkodima/following{/other_user},https://api.github.com/users/fatkodima/gists{/gist_id},https://api.github.com/users/fatkodima/starred{/owner}{/repo},https://api.github.com/users/fatkodima/subscriptions,https://api.github.com/users/fatkodima/orgs,https://api.github.com/users/fatkodima/repos,https://api.github.com/users/fatkodima/events{/privacy},https://api.github.com/users/fatkodima/received_events,User,False,https://api.github.com/repos/rails/rails/issues/31595/reactions,6,3,0,0,0,0,3,0,0,False,https://api.github.com/repos/rails/rails/pulls/31595,https://github.com/rails/rails/pull/31595,https://github.com/rails/rails/pull/31595.diff,https://github.com/rails/rails/pull/31595.patch,,kamipo,12642.0,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
495,https://api.github.com/repos/rails/rails/issues/31445,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/31445/labels{/name},https://api.github.com/repos/rails/rails/issues/31445/comments,https://api.github.com/repos/rails/rails/issues/31445/events,https://github.com/rails/rails/issues/31445,282118583,MDU6SXNzdWUyODIxMTg1ODM=,31445,ActiveRecord 5.1 - #includes raises NoMethodError when case doesn't match on join columns,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,11,2017-12-14T14:27:15Z,2021-06-30T12:42:00Z,,NONE,,"### Steps to reproduce

(This is how my app is setup, there may be other configurations that produce the same error).

schema.rb:
```ruby
create_table ""activities""  do |t|
  t.string 'username'
end
create_table 'users', id: false do |t|
  t.string 'username', null: false
end
```

Models:
```ruby
class Activity < ApplicationRecord
  belongs_to :user, foreign_key: :username, optional: true
end
class User < ApplicationRecord
  self.primary_key = :username
  has_many :activities
end
```

Set the username on an activity to a username that doesn't exist in the users table.
Run: 
```ruby
Activity.all.includes(:user).to_a
```

(I realize this is a case of bad data consistency, but I'm dealing with data from other systems, and I don't want to lose data or generate artificial data.)


### Expected behavior

I should get an array of all Activities with all relevant users preloaded, and the activities that don't have a valid matching user should return `nil` when I call `activity.user`.
This is the same behavior you'd get if you didn't use includes, except the users would be preloaded.

### Actual behavior

NoMethodError: undefined method `association' for nil:NilClass

### System configuration
**Rails version**: 5.1.4

**Ruby version**: 2.4.1
",https://api.github.com/repos/rails/rails/issues/31445/timeline,,seandilda,6088679,MDQ6VXNlcjYwODg2Nzk=,https://avatars.githubusercontent.com/u/6088679?v=4,,https://api.github.com/users/seandilda,https://github.com/seandilda,https://api.github.com/users/seandilda/followers,https://api.github.com/users/seandilda/following{/other_user},https://api.github.com/users/seandilda/gists{/gist_id},https://api.github.com/users/seandilda/starred{/owner}{/repo},https://api.github.com/users/seandilda/subscriptions,https://api.github.com/users/seandilda/orgs,https://api.github.com/users/seandilda/repos,https://api.github.com/users/seandilda/events{/privacy},https://api.github.com/users/seandilda/received_events,User,False,https://api.github.com/repos/rails/rails/issues/31445/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
496,https://api.github.com/repos/rails/rails/issues/31431,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/31431/labels{/name},https://api.github.com/repos/rails/rails/issues/31431/comments,https://api.github.com/repos/rails/rails/issues/31431/events,https://github.com/rails/rails/issues/31431,281874899,MDU6SXNzdWUyODE4NzQ4OTk=,31431,ActiveRecord calling save on a parent with accepts_nested_attributes_for with before_destroy on child model can raise error,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2017-12-13T19:53:09Z,2020-03-27T19:39:38Z,,NONE,,"### Steps to reproduce
have a parent model with `accepts_nested_attributes_for :foos, allow_destroy: true`
have the child model add an error and return false in a `before_destroy` hook
mark the child with `_destroy` in a `fields_for`
save the form

### Expected behavior
Calling `save` on the parent should return false.

### Actual behavior
An unhandled exception is thrown `ActiveRecord::RecordNotDestroyed`

### System configuration
Rails version: 4.2.10
Ruby version: 2.4.1

Here is a link to sample project reproducing it, with instructions in the Readme.  Let me know if I can add any more useful info, thanks.
https://github.com/rschooley/rails_nested_sample",https://api.github.com/repos/rails/rails/issues/31431/timeline,,rschooley,473595,MDQ6VXNlcjQ3MzU5NQ==,https://avatars.githubusercontent.com/u/473595?v=4,,https://api.github.com/users/rschooley,https://github.com/rschooley,https://api.github.com/users/rschooley/followers,https://api.github.com/users/rschooley/following{/other_user},https://api.github.com/users/rschooley/gists{/gist_id},https://api.github.com/users/rschooley/starred{/owner}{/repo},https://api.github.com/users/rschooley/subscriptions,https://api.github.com/users/rschooley/orgs,https://api.github.com/users/rschooley/repos,https://api.github.com/users/rschooley/events{/privacy},https://api.github.com/users/rschooley/received_events,User,False,https://api.github.com/repos/rails/rails/issues/31431/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
497,https://api.github.com/repos/rails/rails/issues/31100,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/31100/labels{/name},https://api.github.com/repos/rails/rails/issues/31100/comments,https://api.github.com/repos/rails/rails/issues/31100/events,https://github.com/rails/rails/issues/31100,272487981,MDU6SXNzdWUyNzI0ODc5ODE=,31100,STI: class names as parameters for where,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,20,2017-11-09T09:09:51Z,2021-09-13T11:12:37Z,,NONE,,"### Steps to reproduce
While upgrading Rails to 5.1.4 I noticed the following behaviour: single class names are no longer accepted as parameters for where, but they are accepted when enclosed in an array. This makes it more difficult to use the inheritance column in queries. 

I hope the following examples show what I mean: 

```ruby
Animal.where(:type => Cat) # broken in rails 5.1.4
Animal.where(:type => ""Cat"") # works, but misses the check for existence of the class on autoload
Animal.where(:type => [Cat]) # works, but constructs a LIKE query
```

### Expected behavior
I expected the where to work with class names as parameters for the inheritance column like before. 

### Actual behavior
I get a `TypeError: can't cast Class` when executing the query.

### System configuration
**Rails version**: 5.1.4

**Ruby version**: 2.3.3
",https://api.github.com/repos/rails/rails/issues/31100/timeline,,skyfmmf,1775352,MDQ6VXNlcjE3NzUzNTI=,https://avatars.githubusercontent.com/u/1775352?v=4,,https://api.github.com/users/skyfmmf,https://github.com/skyfmmf,https://api.github.com/users/skyfmmf/followers,https://api.github.com/users/skyfmmf/following{/other_user},https://api.github.com/users/skyfmmf/gists{/gist_id},https://api.github.com/users/skyfmmf/starred{/owner}{/repo},https://api.github.com/users/skyfmmf/subscriptions,https://api.github.com/users/skyfmmf/orgs,https://api.github.com/users/skyfmmf/repos,https://api.github.com/users/skyfmmf/events{/privacy},https://api.github.com/users/skyfmmf/received_events,User,False,https://api.github.com/repos/rails/rails/issues/31100/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
498,https://api.github.com/repos/rails/rails/issues/31045,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/31045/labels{/name},https://api.github.com/repos/rails/rails/issues/31045/comments,https://api.github.com/repos/rails/rails/issues/31045/events,https://github.com/rails/rails/issues/31045,271112479,MDU6SXNzdWUyNzExMTI0Nzk=,31045,`try` doesn't work with `DelegateClass(x)`,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2017-11-03T20:39:59Z,2017-11-23T05:35:14Z,,NONE,,"`try` was patched to work with delegators in https://github.com/rails/rails/commit/af53280a4b5b3323ac87dc60deb2b1b781197b2b

It does work correctly with subclasses of `SimpleDelegator`, but not with subclasses of `DelegateClass(x)`, even though `DelegateClass(x)` has `ActiveSupport::Tryable` in its ancestors

### Reproduction Script

```ruby
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  git ""https://github.com/rails/rails.git"" do
    gem ""activesupport""
  end
end

require ""active_support/core_ext/object/try""
require ""minitest/autorun""

# Ensure backward compatibility with Minitest 4
Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

class Dog
  def bark
    :woof
  end
end

class DogDelegator < SimpleDelegator
  def bark
    :meow
  end
end

class DogDelegate < DelegateClass(Dog)
  def bark
    :meow
  end
end

class DelegatorTryTest < Minitest::Test
  def test_simple_delegator_uses_try_correctly
    delegator = DogDelegator.new(Dog.new)

    assert_includes delegator.class.ancestors, ActiveSupport::Tryable, ""the object is Tryable""

    assert_equal :meow, delegator.bark
    assert_equal :meow, delegator.try(:bark)
  end

  def test_delegate_class_uses_try_correctly
    delegate_instance = DogDelegate.new(Dog.new)

    assert_includes delegate_instance.class.ancestors, ActiveSupport::Tryable, ""the object is Tryable""

    assert_equal :meow, delegate_instance.bark
    # this is where it fails
    assert_equal :meow, delegate_instance.try(:bark)
  end
end

```

### System configuration

**Rails version**: master
**Ruby version**: MRI 2.3.3",https://api.github.com/repos/rails/rails/issues/31045/timeline,,danielma,993340,MDQ6VXNlcjk5MzM0MA==,https://avatars.githubusercontent.com/u/993340?v=4,,https://api.github.com/users/danielma,https://github.com/danielma,https://api.github.com/users/danielma/followers,https://api.github.com/users/danielma/following{/other_user},https://api.github.com/users/danielma/gists{/gist_id},https://api.github.com/users/danielma/starred{/owner}{/repo},https://api.github.com/users/danielma/subscriptions,https://api.github.com/users/danielma/orgs,https://api.github.com/users/danielma/repos,https://api.github.com/users/danielma/events{/privacy},https://api.github.com/users/danielma/received_events,User,False,https://api.github.com/repos/rails/rails/issues/31045/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
499,https://api.github.com/repos/rails/rails/issues/29374,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/29374/labels{/name},https://api.github.com/repos/rails/rails/issues/29374/comments,https://api.github.com/repos/rails/rails/issues/29374/events,https://github.com/rails/rails/issues/29374,233951414,MDU6SXNzdWUyMzM5NTE0MTQ=,29374,model w/o primary key defined as association beeing eager loaded is not populated,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2017-06-06T16:32:16Z,2021-12-15T01:36:02Z,,NONE,,"### Steps to reproduce
migration:

```
def up
    create_table :institution_hierarchies, id: false do |t|
      t.integer :parent_id, index: true
      t.integer :child_id, index: true
    end
    create table :clients do |t|
      t.integer :institution_id
    end
end

```
models:
```
class InstitutionHierarchy < ActiveRecord::Base
end
```
```
class Client < ActiveRecord::Base
   has_many :institution_hierarchies, foreign_key: :child_id,  primary_key: :institution_id
end
```

reproduce:
  ```
InstitutionHierarchy.create!({child_id: 2, parent_id: 1})
  Client.create!({institution_id: 2})
  puts Client.eager_load(:institution_hierarchies).first.institution_hierarchies.inspect
```

### Expected behavior
The Collection with a single object representing the previously inserted row should be printed

### Actual behavior
An empty collection is printed

### Solution
execute following migration:
```
def change
    add_column :institution_hierarchies, :id, :primary_key
end
```

then execute:

```
puts Client.eager_load(:institution_hierarchies).first.institution_hierarchies.inspect
```

Now the collection contains the desired Object.
I'm not sure if this is in fact a bug or if i'm just missing something, but i could not find any documentation exactly on that topic.

### System configuration
**Rails version**:  4.2.1

**Ruby version**:  2.2.3

**Database**: postgresql 9.5
",https://api.github.com/repos/rails/rails/issues/29374/timeline,,disorganizer23,21663186,MDQ6VXNlcjIxNjYzMTg2,https://avatars.githubusercontent.com/u/21663186?v=4,,https://api.github.com/users/disorganizer23,https://github.com/disorganizer23,https://api.github.com/users/disorganizer23/followers,https://api.github.com/users/disorganizer23/following{/other_user},https://api.github.com/users/disorganizer23/gists{/gist_id},https://api.github.com/users/disorganizer23/starred{/owner}{/repo},https://api.github.com/users/disorganizer23/subscriptions,https://api.github.com/users/disorganizer23/orgs,https://api.github.com/users/disorganizer23/repos,https://api.github.com/users/disorganizer23/events{/privacy},https://api.github.com/users/disorganizer23/received_events,User,False,https://api.github.com/repos/rails/rails/issues/29374/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
500,https://api.github.com/repos/rails/rails/issues/29368,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/29368/labels{/name},https://api.github.com/repos/rails/rails/issues/29368/comments,https://api.github.com/repos/rails/rails/issues/29368/events,https://github.com/rails/rails/pull/29368,233811314,MDExOlB1bGxSZXF1ZXN0MTI0MTMxNzIy,29368,Reject global csrf token if per form tokens are enabled,"[{'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}, {'id': 603319189, 'node_id': 'MDU6TGFiZWw2MDMzMTkxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/rails-ujs', 'name': 'rails-ujs', 'color': '5319e7', 'default': False, 'description': None}]",open,False,,"[{'login': 'pixeltrix', 'id': 6321, 'node_id': 'MDQ6VXNlcjYzMjE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pixeltrix', 'html_url': 'https://github.com/pixeltrix', 'followers_url': 'https://api.github.com/users/pixeltrix/followers', 'following_url': 'https://api.github.com/users/pixeltrix/following{/other_user}', 'gists_url': 'https://api.github.com/users/pixeltrix/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pixeltrix/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pixeltrix/subscriptions', 'organizations_url': 'https://api.github.com/users/pixeltrix/orgs', 'repos_url': 'https://api.github.com/users/pixeltrix/repos', 'events_url': 'https://api.github.com/users/pixeltrix/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pixeltrix/received_events', 'type': 'User', 'site_admin': False}]",,9,2017-06-06T08:08:58Z,2021-08-29T11:25:29Z,,CONTRIBUTOR,,"Currently global CSRF token can be used to override per-form CSRF token. This PR changes that. If per-form CSRF tokens are enabled, an actual per-form CSRF token has to be passed to avoid `InvalidAuthenticityToken`.",https://api.github.com/repos/rails/rails/issues/29368/timeline,,kv109,399968,MDQ6VXNlcjM5OTk2OA==,https://avatars.githubusercontent.com/u/399968?v=4,,https://api.github.com/users/kv109,https://github.com/kv109,https://api.github.com/users/kv109/followers,https://api.github.com/users/kv109/following{/other_user},https://api.github.com/users/kv109/gists{/gist_id},https://api.github.com/users/kv109/starred{/owner}{/repo},https://api.github.com/users/kv109/subscriptions,https://api.github.com/users/kv109/orgs,https://api.github.com/users/kv109/repos,https://api.github.com/users/kv109/events{/privacy},https://api.github.com/users/kv109/received_events,User,False,https://api.github.com/repos/rails/rails/issues/29368/reactions,1,1,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/29368,https://github.com/rails/rails/pull/29368,https://github.com/rails/rails/pull/29368.diff,https://github.com/rails/rails/pull/29368.patch,,pixeltrix,6321.0,MDQ6VXNlcjYzMjE=,https://avatars.githubusercontent.com/u/6321?v=4,,https://api.github.com/users/pixeltrix,https://github.com/pixeltrix,https://api.github.com/users/pixeltrix/followers,https://api.github.com/users/pixeltrix/following{/other_user},https://api.github.com/users/pixeltrix/gists{/gist_id},https://api.github.com/users/pixeltrix/starred{/owner}{/repo},https://api.github.com/users/pixeltrix/subscriptions,https://api.github.com/users/pixeltrix/orgs,https://api.github.com/users/pixeltrix/repos,https://api.github.com/users/pixeltrix/events{/privacy},https://api.github.com/users/pixeltrix/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
501,https://api.github.com/repos/rails/rails/issues/29210,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/29210/labels{/name},https://api.github.com/repos/rails/rails/issues/29210/comments,https://api.github.com/repos/rails/rails/issues/29210/events,https://github.com/rails/rails/issues/29210,231115422,MDU6SXNzdWUyMzExMTU0MjI=,29210,ActiveSupport::TimeZone.us_zones behavior changed between Rails 5.0.2 and 5.0.3,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}]",open,False,,"[{'login': 'pixeltrix', 'id': 6321, 'node_id': 'MDQ6VXNlcjYzMjE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pixeltrix', 'html_url': 'https://github.com/pixeltrix', 'followers_url': 'https://api.github.com/users/pixeltrix/followers', 'following_url': 'https://api.github.com/users/pixeltrix/following{/other_user}', 'gists_url': 'https://api.github.com/users/pixeltrix/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pixeltrix/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pixeltrix/subscriptions', 'organizations_url': 'https://api.github.com/users/pixeltrix/orgs', 'repos_url': 'https://api.github.com/users/pixeltrix/repos', 'events_url': 'https://api.github.com/users/pixeltrix/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pixeltrix/received_events', 'type': 'User', 'site_admin': False}]",,6,2017-05-24T17:30:30Z,2021-07-25T15:33:29Z,,NONE,,"### Steps to reproduce
1. Open a Rails console
2. Execute `ActiveSupport::TimeZone.us_zones`
3. Rails 5.0.2:
  ```
  irb(main):007:0> ActiveSupport::TimeZone.us_zones
[
    [0] #<ActiveSupport::TimeZone:0x0055c0da6952a8 @name=""Hawaii"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: Pacific/Honolulu>>,
    [1] #<ActiveSupport::TimeZone:0x0055c0d98606d8 @name=""Alaska"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Juneau>>,
    [2] #<ActiveSupport::TimeZone:0x0055c0da666598 @name=""Pacific Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Los_Angeles>>,
    [3] #<ActiveSupport::TimeZone:0x0055c0da660cb0 @name=""Arizona"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Phoenix>>,
    [4] #<ActiveSupport::TimeZone:0x0055c0da6460b8 @name=""Mountain Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Denver>>,
    [5] #<ActiveSupport::TimeZone:0x0055c0da60c5e8 @name=""Central Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Chicago>>,
    [6] #<ActiveSupport::TimeZone:0x0055c0d1e9b348 @name=""Eastern Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/New_York>>,
    [7] #<ActiveSupport::TimeZone:0x0055c0da5ff578 @name=""Indiana (East)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Indianapolis>>
]
  ```
4. Rails 5.0.3:
  ```
  irb(main):001:0> ActiveSupport::TimeZone.us_zones
[
    [ 0] #<ActiveSupport::TimeZone:0x005568a38f2828 @name=""America/Adak"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Adak>>,
    [ 1] #<ActiveSupport::TimeZone:0x005568a38f2800 @name=""Hawaii"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: Pacific/Honolulu>>,
    [ 2] #<ActiveSupport::TimeZone:0x005568a3683a60 @name=""Alaska"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Juneau>>,
    [ 3] #<ActiveSupport::TimeZone:0x005568a3683a88 @name=""America/Anchorage"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Anchorage>>,
    [ 4] #<ActiveSupport::TimeZone:0x005568a37492d8 @name=""America/Metlakatla"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Metlakatla>>,
    [ 5] #<ActiveSupport::TimeZone:0x005568a3871e08 @name=""America/Nome"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Nome>>,
    [ 6] #<ActiveSupport::TimeZone:0x005568a36fe530 @name=""America/Sitka"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Sitka>>,
    [ 7] #<ActiveSupport::TimeZone:0x005568a37a2d60 @name=""America/Yakutat"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Yakutat>>,
    [ 8] #<ActiveSupport::TimeZone:0x005568a353d390 @name=""Pacific Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Los_Angeles>>,
    [ 9] #<ActiveSupport::TimeZone:0x005568a3550f58 @name=""America/Boise"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Boise>>,
    [10] #<ActiveSupport::TimeZone:0x005568a3550f30 @name=""Arizona"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Phoenix>>,
    [11] #<ActiveSupport::TimeZone:0x005568a3493728 @name=""Mountain Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Denver>>,
    [12] #<ActiveSupport::TimeZone:0x005568a3235648 @name=""America/Indiana/Knox"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Knox>>,
    [13] #<ActiveSupport::TimeZone:0x005568a31adf68 @name=""America/Indiana/Tell_City"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Tell_City>>,
    [14] #<ActiveSupport::TimeZone:0x005568a32c6738 @name=""America/Menominee"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Menominee>>,
    [15] #<ActiveSupport::TimeZone:0x005568a3493750 @name=""America/North_Dakota/Beulah"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/North_Dakota/Beulah>>,
    [16] #<ActiveSupport::TimeZone:0x005568a3384da0 @name=""America/North_Dakota/Center"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/North_Dakota/Center>>,
    [17] #<ActiveSupport::TimeZone:0x005568a342b5d8 @name=""America/North_Dakota/New_Salem"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/North_Dakota/New_Salem>>,
    [18] #<ActiveSupport::TimeZone:0x005568a305a2b0 @name=""Central Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Chicago>>,
    [19] #<ActiveSupport::TimeZone:0x005568a2e0bc98 @name=""America/Detroit"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Detroit>>,
    [20] #<ActiveSupport::TimeZone:0x005568a2f9cbc0 @name=""America/Indiana/Marengo"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Marengo>>,
    [21] #<ActiveSupport::TimeZone:0x005568a30226d0 @name=""America/Indiana/Petersburg"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Petersburg>>,
    [22] #<ActiveSupport::TimeZone:0x005568a305a2d8 @name=""America/Indiana/Vevay"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Vevay>>,
    [23] #<ActiveSupport::TimeZone:0x005568a2f3e6b0 @name=""America/Indiana/Vincennes"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Vincennes>>,
    [24] #<ActiveSupport::TimeZone:0x005568a2f66e30 @name=""America/Indiana/Winamac"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Winamac>>,
    [25] #<ActiveSupport::TimeZone:0x005568a2e4dcd8 @name=""America/Kentucky/Louisville"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Kentucky/Louisville>>,
    [26] #<ActiveSupport::TimeZone:0x005568a2e9e840 @name=""America/Kentucky/Monticello"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Kentucky/Monticello>>,
    [27] #<ActiveSupport::TimeZone:0x005568a2d225c0 @name=""Eastern Time (US & Canada)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/New_York>>,
    [28] #<ActiveSupport::TimeZone:0x005568a2e9e7a0 @name=""Indiana (East)"", @utc_offset=nil, @tzinfo=#<TZInfo::DataTimezone: America/Indiana/Indianapolis>>
]
```

### Expected behavior
Keep behavior of public methods consistent between patch versions of release.  In fact, based on code I see in our app, the Rails 5.0.2 behavior has been consistent for several *major* versions of Rails.

### Actual behavior
The list of us_zones is larger in Rails 5.0.3

### System configuration
**Rails version**:
5.0.3
**Ruby version**:
2.3.1

### Note
This issue was filed as a result of discussion in separate issue starting here: https://github.com/rails/rails/issues/28431#issuecomment-303251396",https://api.github.com/repos/rails/rails/issues/29210/timeline,,BigGillyStyle,1938508,MDQ6VXNlcjE5Mzg1MDg=,https://avatars.githubusercontent.com/u/1938508?v=4,,https://api.github.com/users/BigGillyStyle,https://github.com/BigGillyStyle,https://api.github.com/users/BigGillyStyle/followers,https://api.github.com/users/BigGillyStyle/following{/other_user},https://api.github.com/users/BigGillyStyle/gists{/gist_id},https://api.github.com/users/BigGillyStyle/starred{/owner}{/repo},https://api.github.com/users/BigGillyStyle/subscriptions,https://api.github.com/users/BigGillyStyle/orgs,https://api.github.com/users/BigGillyStyle/repos,https://api.github.com/users/BigGillyStyle/events{/privacy},https://api.github.com/users/BigGillyStyle/received_events,User,False,https://api.github.com/repos/rails/rails/issues/29210/reactions,4,4,0,0,0,0,0,0,0,,,,,,,pixeltrix,6321.0,MDQ6VXNlcjYzMjE=,https://avatars.githubusercontent.com/u/6321?v=4,,https://api.github.com/users/pixeltrix,https://github.com/pixeltrix,https://api.github.com/users/pixeltrix/followers,https://api.github.com/users/pixeltrix/following{/other_user},https://api.github.com/users/pixeltrix/gists{/gist_id},https://api.github.com/users/pixeltrix/starred{/owner}{/repo},https://api.github.com/users/pixeltrix/subscriptions,https://api.github.com/users/pixeltrix/orgs,https://api.github.com/users/pixeltrix/repos,https://api.github.com/users/pixeltrix/events{/privacy},https://api.github.com/users/pixeltrix/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
502,https://api.github.com/repos/rails/rails/issues/29087,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/29087/labels{/name},https://api.github.com/repos/rails/rails/issues/29087/comments,https://api.github.com/repos/rails/rails/issues/29087/events,https://github.com/rails/rails/issues/29087,228661997,MDU6SXNzdWUyMjg2NjE5OTc=,29087,Special characters in app directory path causes 'rails server' to fail on Windows systems,[],open,False,,[],,7,2017-05-15T09:50:43Z,2022-03-21T05:59:11Z,,NONE,,"### Steps to reproduce

1. On Windows 10 system, create directory: `C:\Rails Server Test Ø`
2. Open command prompt, then navigate to `C:\Rails Server Test Ø`
3. From within `C:\Rails Server Test Ø`, run `rails new MyTestApp`
5. From within `C:\Rails Server Test Ø\MyTestApp`, run `rails server`
6. Notice error message: _C:/Rails Server Test ?/MyTestApp/Gemfile not found_
7. Rename directory `C:\Rails Server Test Ø` to `C:\Rails Server Test` (removing `Ø`)
8. Repeat step 4; notice `rails server` now works as expected

### Expected behavior
Rails server starts under localhost.

### Actual behavior
Rails server does not start and misleading error message occurs:
_C:/Rails Server Test ?/MyTestApp/Gemfile not found_

Error message is misleading, because `Gemfile` actually does exist within the working directory.

### System configuration
**Operating system**:
Windows 10 Enterprise (64-bit)

**Rails version**:
Rails 5.1.1

**Ruby version**:
ruby 2.3.3p222 (2016-11-21 revision 56859) [i386-mingw32]",https://api.github.com/repos/rails/rails/issues/29087/timeline,,leifericf,463422,MDQ6VXNlcjQ2MzQyMg==,https://avatars.githubusercontent.com/u/463422?v=4,,https://api.github.com/users/leifericf,https://github.com/leifericf,https://api.github.com/users/leifericf/followers,https://api.github.com/users/leifericf/following{/other_user},https://api.github.com/users/leifericf/gists{/gist_id},https://api.github.com/users/leifericf/starred{/owner}{/repo},https://api.github.com/users/leifericf/subscriptions,https://api.github.com/users/leifericf/orgs,https://api.github.com/users/leifericf/repos,https://api.github.com/users/leifericf/events{/privacy},https://api.github.com/users/leifericf/received_events,User,False,https://api.github.com/repos/rails/rails/issues/29087/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
503,https://api.github.com/repos/rails/rails/issues/29085,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/29085/labels{/name},https://api.github.com/repos/rails/rails/issues/29085/comments,https://api.github.com/repos/rails/rails/issues/29085/events,https://github.com/rails/rails/issues/29085,228621595,MDU6SXNzdWUyMjg2MjE1OTU=,29085,weird behavior of per_form_csrf_tokens,"[{'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,[],,4,2017-05-15T06:56:22Z,2018-09-25T23:38:55Z,,NONE,,"### Steps to reproduce
I am created a demo app for testing [here](https://github.com/apinrdw/test-csrf-token), and also override the `RequestForgeryProtection#valid_authenticity_token?` for logging.
- open http://localhost:3000/posts/new
- fill and submit the form  
- and see the console.

### Expected behavior
```
per_form_csrf_tokens: true
compare_with_real_token: false
valid_per_form_csrf_token?: true
```

### Actual behavior
```
per_form_csrf_tokens: true
compare_with_real_token: true
valid_per_form_csrf_token?: false
```

### System configuration
**Rails version**:
5.0.3
**Ruby version**:
2.4.1",https://api.github.com/repos/rails/rails/issues/29085/timeline,,apinrdw,4516973,MDQ6VXNlcjQ1MTY5NzM=,https://avatars.githubusercontent.com/u/4516973?v=4,,https://api.github.com/users/apinrdw,https://github.com/apinrdw,https://api.github.com/users/apinrdw/followers,https://api.github.com/users/apinrdw/following{/other_user},https://api.github.com/users/apinrdw/gists{/gist_id},https://api.github.com/users/apinrdw/starred{/owner}{/repo},https://api.github.com/users/apinrdw/subscriptions,https://api.github.com/users/apinrdw/orgs,https://api.github.com/users/apinrdw/repos,https://api.github.com/users/apinrdw/events{/privacy},https://api.github.com/users/apinrdw/received_events,User,False,https://api.github.com/repos/rails/rails/issues/29085/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
504,https://api.github.com/repos/rails/rails/issues/29078,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/29078/labels{/name},https://api.github.com/repos/rails/rails/issues/29078/comments,https://api.github.com/repos/rails/rails/issues/29078/events,https://github.com/rails/rails/issues/29078,228518116,MDU6SXNzdWUyMjg1MTgxMTY=,29078,Record not touched when removing associated has_many through,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,9,2017-05-14T04:38:20Z,2019-07-26T07:10:38Z,,CONTRIBUTOR,,"### Steps to reproduce
https://gist.github.com/thomasfedb/04ca6b5d476679e6550d4b849531cf42

```ruby
class Post < ActiveRecord::Base
  has_many :taggings
  has_many :tags, through: :taggings
end

class Tagging < ActiveRecord::Base
  belongs_to :post, touch: true
  belongs_to :tag
end

class Tag < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_has_many_through_touch
    post = Post.create!
    tag = Tag.create!

    updated_at_before_tag_added = post.updated_at
    post.update(tags: [tag])
    updated_at_after_tag_added = post.updated_at

    assert_equal 1, post.tags.count
    assert updated_at_before_tag_added < updated_at_after_tag_added

    updated_at_before_tag_removed = post.updated_at
    post.update(tags: [])
    updated_at_after_tag_removed = post.updated_at

    assert_equal 0, post.tags.count
    assert updated_at_before_tag_removed < updated_at_after_tag_removed,
      ""post is not touched""
  end
end
```

### Expected behavior
The post record should be touched both when the tag is added and when the tag is removed, as this results in a tagging being created and destroyed, which is configured with `touch: true`

### Actual behavior
The post record is touched when the tagging is created, but not when it is destroyed

### System configuration
**Rails version**: 5.1.1
**Ruby version**: 2.4.0
",https://api.github.com/repos/rails/rails/issues/29078/timeline,,thomasfedb,193831,MDQ6VXNlcjE5MzgzMQ==,https://avatars.githubusercontent.com/u/193831?v=4,,https://api.github.com/users/thomasfedb,https://github.com/thomasfedb,https://api.github.com/users/thomasfedb/followers,https://api.github.com/users/thomasfedb/following{/other_user},https://api.github.com/users/thomasfedb/gists{/gist_id},https://api.github.com/users/thomasfedb/starred{/owner}{/repo},https://api.github.com/users/thomasfedb/subscriptions,https://api.github.com/users/thomasfedb/orgs,https://api.github.com/users/thomasfedb/repos,https://api.github.com/users/thomasfedb/events{/privacy},https://api.github.com/users/thomasfedb/received_events,User,False,https://api.github.com/repos/rails/rails/issues/29078/reactions,8,8,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
505,https://api.github.com/repos/rails/rails/issues/29049,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/29049/labels{/name},https://api.github.com/repos/rails/rails/issues/29049/comments,https://api.github.com/repos/rails/rails/issues/29049/events,https://github.com/rails/rails/issues/29049,227997331,MDU6SXNzdWUyMjc5OTczMzE=,29049,db:structure:load broken on linux with a default postgres install,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}]",open,False,,[],,6,2017-05-11T13:47:40Z,2018-08-02T20:56:55Z,,NONE,,"### Steps to reproduce

RE [this PR](https://github.com/rails/rails/pull/24773)

* Have a database with installed extensions, like `plpgsql`
* Run a default linux postgres install - meaning, you access postgres as a non-superuser.
* Attempt to load a `db/structure.sql` file that includes pointless but super-user only functions like

```
COMMENT ON EXTENSION plpgsql IS 'PL/pgSQL procedural language';
```

This is especially an issue for projects where folks work in mixed environments, say osx homebrew postgres (whjch runs all databases as a superuser for ""convenience"", I suppose) and default linux postgres installs.

Ultimately the issue is osx postgres running as superuser and creating dump files in that context, but I don't think this is going to change any time soon.

It'd be ideal to at least be able to disable this behavior, as it is now I can't set up a project. I imagine this is going to happen for some production / CI environments as well. I don't think the correct solution is to tell linux users to access their rails databases as superusers, that's the equivalent of running your machine as root.

### Expected behavior
It should work with warnings as it did on previous versions of rails.

### Actual behavior
It fails with:
```
psql:/home/dcollispuro/code/work/addons.heroku.com/db/structure.sql:27: ERROR:  42501: must be owner of extension plpgsql
LOCATION:  aclcheck_error, aclchk.c:3367
Time: 0.211 ms
rake aborted!
failed to execute:
psql -v ON_ERROR_STOP=1 -q -f /home/dcollispuro/code/work/addons.heroku.com/db/structure.sql addons-development

Please check the output above for any errors and make sure that `psql` is installed in your PATH and has proper permissions.
```

### System configuration
**Rails version**: 5.1.0

**Ruby version**: 2.3.1p112
",https://api.github.com/repos/rails/rails/issues/29049/timeline,,djcp,3966,MDQ6VXNlcjM5NjY=,https://avatars.githubusercontent.com/u/3966?v=4,,https://api.github.com/users/djcp,https://github.com/djcp,https://api.github.com/users/djcp/followers,https://api.github.com/users/djcp/following{/other_user},https://api.github.com/users/djcp/gists{/gist_id},https://api.github.com/users/djcp/starred{/owner}{/repo},https://api.github.com/users/djcp/subscriptions,https://api.github.com/users/djcp/orgs,https://api.github.com/users/djcp/repos,https://api.github.com/users/djcp/events{/privacy},https://api.github.com/users/djcp/received_events,User,False,https://api.github.com/repos/rails/rails/issues/29049/reactions,16,16,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
506,https://api.github.com/repos/rails/rails/issues/28877,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/28877/labels{/name},https://api.github.com/repos/rails/rails/issues/28877/comments,https://api.github.com/repos/rails/rails/issues/28877/events,https://github.com/rails/rails/issues/28877,224221277,MDU6SXNzdWUyMjQyMjEyNzc=,28877,Setting datetime inside Time#use_zone does not work,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2017-04-25T17:54:59Z,2018-01-06T20:11:01Z,,NONE,,"### Steps to reproduce
```ruby
event = Event.new # start_at: datetime
Time.use_zone(""Sydney"") { event.start_at = ""2017-05-01 13:00"" }
event.start_at
event
```

### Expected behavior
> Mon, 01 May 2017 13:00:00 AEST +10:00
#<Event id: nil, name: nil, start_at: ""2017-05-01 03:00:00"", created_at: nil, updated_at: nil> 


### Actual behavior
> Mon, 01 May 2017 13:00:00 UTC +00:00
#<Event id: nil, name: nil, start_at: ""2017-05-01 13:00:00"", created_at: nil, updated_at: nil>

### System configuration
**Rails version**: Rails 5.0.2


**Ruby version**: ruby 2.3.0p0 (2015-12-25 revision 53290) [x86_64-linux]


**Postgresql version**: psql (PostgreSQL) 9.5.6

### Additional info

In my another project on ruby 2.3.0 and rails 4.2.6 it works fine.

```ruby
2.3.0 :001 > event = Event.new
 => #<Event id: nil, name: nil, start_at: nil, created_at: nil, updated_at: nil> 
2.3.0 :002 > Time.use_zone(""Sydney"") { event.start_at = ""2017-05-01 13:00"" }
 => ""2017-05-01 13:00"" 
2.3.0 :003 > event.start_at
 => Mon, 01 May 2017 13:00:00 AEST +10:00 
2.3.0 :004 > event
 => #<Event id: nil, name: nil, start_at: ""2017-05-01 03:00:00"", created_at: nil, updated_at: nil> 
2.3.0 :005 > 
```",https://api.github.com/repos/rails/rails/issues/28877/timeline,,wdruzkawiecki,12759448,MDQ6VXNlcjEyNzU5NDQ4,https://avatars.githubusercontent.com/u/12759448?v=4,,https://api.github.com/users/wdruzkawiecki,https://github.com/wdruzkawiecki,https://api.github.com/users/wdruzkawiecki/followers,https://api.github.com/users/wdruzkawiecki/following{/other_user},https://api.github.com/users/wdruzkawiecki/gists{/gist_id},https://api.github.com/users/wdruzkawiecki/starred{/owner}{/repo},https://api.github.com/users/wdruzkawiecki/subscriptions,https://api.github.com/users/wdruzkawiecki/orgs,https://api.github.com/users/wdruzkawiecki/repos,https://api.github.com/users/wdruzkawiecki/events{/privacy},https://api.github.com/users/wdruzkawiecki/received_events,User,False,https://api.github.com/repos/rails/rails/issues/28877/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
507,https://api.github.com/repos/rails/rails/issues/28798,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/28798/labels{/name},https://api.github.com/repos/rails/rails/issues/28798/comments,https://api.github.com/repos/rails/rails/issues/28798/events,https://github.com/rails/rails/issues/28798,222771208,MDU6SXNzdWUyMjI3NzEyMDg=,28798,"Postgresql float4 poor precision, extra_float_digits = 3","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 257468118, 'node_id': 'MDU6TGFiZWwyNTc0NjgxMTg=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20work', 'name': 'needs work', 'color': '000000', 'default': False, 'description': None}]",open,False,,"[{'login': 'sgrif', 'id': 1529387, 'node_id': 'MDQ6VXNlcjE1MjkzODc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1529387?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sgrif', 'html_url': 'https://github.com/sgrif', 'followers_url': 'https://api.github.com/users/sgrif/followers', 'following_url': 'https://api.github.com/users/sgrif/following{/other_user}', 'gists_url': 'https://api.github.com/users/sgrif/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sgrif/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sgrif/subscriptions', 'organizations_url': 'https://api.github.com/users/sgrif/orgs', 'repos_url': 'https://api.github.com/users/sgrif/repos', 'events_url': 'https://api.github.com/users/sgrif/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sgrif/received_events', 'type': 'User', 'site_admin': False}]",,12,2017-04-19T15:09:48Z,2019-03-19T21:13:55Z,,CONTRIBUTOR,,"### Steps to reproduce

Create a table with float4 column and insert some values, e.g.

```
> ue = GeoZone::UserEvent.create(user_id: 10, longitude: 1.123456789, latitude: 1.123456789, what: 'test')
=> #<GeoZone::UserEvent:0x0055959f1471b8
 id: 2,
 user_id: 10,
 latitude: 1.123456789,
 longitude: 1.123456789,
 active: true,
 poi_id: nil,
 deal_id: nil,
 category_id: nil,
 what: ""test"",
 locale: nil,
 created_at: 2017-04-19 15:06:20 UTC,
 parameters: nil>
[3] pry(main)> ue.reload
=> #<GeoZone::UserEvent:0x0055959f1471b8
 id: 2,
 user_id: 10,
 latitude: 1.12346,
 longitude: 1.12346,
 active: true,
 poi_id: nil,
 deal_id: nil,
 category_id: nil,
 what: ""test"",
 locale: nil,
 created_at: 2017-04-19 15:06:20 UTC,
 parameters: nil>
[5] pry(main)> ActiveRecord::Base.connection.execute('SET extra_float_digits = 3')
=> #<PG::Result:0x0055959f39eda8 status=PGRES_COMMAND_OK ntuples=0 nfields=0 cmd_tuples=0>
[6] pry(main)> ue.reload
=> #<GeoZone::UserEvent:0x0055959f1471b8
 id: 2,
 user_id: 10,
 latitude: 1.12345684,
 longitude: 1.12345684,
 active: true,
 poi_id: nil,
 deal_id: nil,
 category_id: nil,
 what: ""test"",
 locale: nil,
 created_at: 2017-04-19 15:06:20 UTC,
 parameters: nil>
[7] pry(main)> 
```

In the case of longitude, latitude, the difference can be 10m - 100m.

It seems like `extra_float_digits` only affects textual output. So does that mean ActiveRecord is not using the postgres binary protocol, and parsing text? That seems really odd.",https://api.github.com/repos/rails/rails/issues/28798/timeline,,ioquatix,30030,MDQ6VXNlcjMwMDMw,https://avatars.githubusercontent.com/u/30030?v=4,,https://api.github.com/users/ioquatix,https://github.com/ioquatix,https://api.github.com/users/ioquatix/followers,https://api.github.com/users/ioquatix/following{/other_user},https://api.github.com/users/ioquatix/gists{/gist_id},https://api.github.com/users/ioquatix/starred{/owner}{/repo},https://api.github.com/users/ioquatix/subscriptions,https://api.github.com/users/ioquatix/orgs,https://api.github.com/users/ioquatix/repos,https://api.github.com/users/ioquatix/events{/privacy},https://api.github.com/users/ioquatix/received_events,User,False,https://api.github.com/repos/rails/rails/issues/28798/reactions,0,0,0,0,0,0,0,0,0,,,,,,,sgrif,1529387.0,MDQ6VXNlcjE1MjkzODc=,https://avatars.githubusercontent.com/u/1529387?v=4,,https://api.github.com/users/sgrif,https://github.com/sgrif,https://api.github.com/users/sgrif/followers,https://api.github.com/users/sgrif/following{/other_user},https://api.github.com/users/sgrif/gists{/gist_id},https://api.github.com/users/sgrif/starred{/owner}{/repo},https://api.github.com/users/sgrif/subscriptions,https://api.github.com/users/sgrif/orgs,https://api.github.com/users/sgrif/repos,https://api.github.com/users/sgrif/events{/privacy},https://api.github.com/users/sgrif/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
508,https://api.github.com/repos/rails/rails/issues/28772,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/28772/labels{/name},https://api.github.com/repos/rails/rails/issues/28772/comments,https://api.github.com/repos/rails/rails/issues/28772/events,https://github.com/rails/rails/issues/28772,221969224,MDU6SXNzdWUyMjE5NjkyMjQ=,28772,Rails form validation errors not displayed for assocation foreign key field when only presence for the association itself is validated,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2017-04-15T19:56:28Z,2020-01-03T20:46:38Z,,CONTRIBUTOR,,"I stumbled upon the following quirk in Rails lately, and I discovered I am not the only one experiencing this nuisance. I will reuse some examples and text from the [iada.nl blog](http://iada.nl/blog/article/rails-tip-display-association-validation-errors-fields), of which the author discussed this issue at length before I even discovered it in the first place.

Say you have the following code contained in a form in a view:
```
<div class=""field"">
    <%= f.label :author %>:<br />
    <%= f.collection_select :author_id, Author.all, :id, :name %>
</div>
```

The object used in this form is a `Book` instance:
```ruby
class Book < ActiveRecord::Base
  belongs_to :author
  validates :author, presence: true
end
```
We check the presence of the author association here, rather than checking the presence of the foreign key (which is considered bad practice by the Rails community). If the `author_id` is not set in the form, the validation error is correctly added to the form itself, but not associated with the `author_id` field in the form. This is because the select field we created is for the `author_id` and not the `Author` association itself.

The cause of this problem is simple, Rails sets the error for the association name, while we are displaying a field for the foreign key column (the id of the associated model).

The solution would be simple, and involves modifying the existing `error_message` method in ActionView's `ActiveModelInstanceTag` [module](https://github.com/rails/rails/blob/master/actionview/lib/action_view/helpers/active_model_helper.rb#L34). The author of aforementioned blog already has devised an effective monkey patch which could be partially reused here.

If the Rails core team agrees with the mentioned approach, I'd like to submit a PR for this.

Possible caveats I can think of at this time if such behaviour would be activated in existing Rails projects:
1. We need to check if we are not showing duplicate error messages if someone validates the presence of both the association itself and the association's foreign key (although such practices should be discouraged, for example by displaying a warning message in the console).",https://api.github.com/repos/rails/rails/issues/28772/timeline,,edwardmp,1686739,MDQ6VXNlcjE2ODY3Mzk=,https://avatars.githubusercontent.com/u/1686739?v=4,,https://api.github.com/users/edwardmp,https://github.com/edwardmp,https://api.github.com/users/edwardmp/followers,https://api.github.com/users/edwardmp/following{/other_user},https://api.github.com/users/edwardmp/gists{/gist_id},https://api.github.com/users/edwardmp/starred{/owner}{/repo},https://api.github.com/users/edwardmp/subscriptions,https://api.github.com/users/edwardmp/orgs,https://api.github.com/users/edwardmp/repos,https://api.github.com/users/edwardmp/events{/privacy},https://api.github.com/users/edwardmp/received_events,User,False,https://api.github.com/repos/rails/rails/issues/28772/reactions,3,3,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
509,https://api.github.com/repos/rails/rails/issues/28438,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/28438/labels{/name},https://api.github.com/repos/rails/rails/issues/28438/comments,https://api.github.com/repos/rails/rails/issues/28438/events,https://github.com/rails/rails/issues/28438,214535202,MDU6SXNzdWUyMTQ1MzUyMDI=,28438,Query attribute methods behave the same as `present?` for all values except `0` in a number column,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,2,2017-03-15T21:42:49Z,2017-05-12T11:53:33Z,,NONE,,"### Steps to reproduce

Any model with a column with an `OID` that is a `number?` is sufficient, but I reproduce with `ActiveRecord::Type::Integer` below.

```ruby
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""
  gem ""rails"", ""4.2.6""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :people, force: true do |t|
    t.integer :age
  end
end

class Person < ActiveRecord::Base
end

class BugTest < Minitest::Test
  def test_query_attribute_method_for_number_column
    person = Person.create!

    person.age = rand(1..1000)
    assert_equal person.age?, person.age.present?

    person.age = 0
    assert_equal person.age?, person.age.present?
  end
end
```

### Expected behavior
Save [some reasonable heuristics in the situation where the attribute's type is unknown](https://github.com/rails/rails/blob/v4.2.6/activerecord/lib/active_record/attribute_methods/query.rb#L19-L24), I expect query attribute methods like `age?` to be a shorthand for `age.present?`. 

### Actual behavior
Looking at the underlying implementation in [`ActiveRecord::AttributeMethods::Query#query_attribute`](https://github.com/rails/rails/blob/v4.2.6/activerecord/lib/active_record/attribute_methods/query.rb#L10-L31), it seems this will be exactly the case for all values [except those that are `zero?` and whose type is `number?`](https://github.com/rails/rails/blob/v4.2.6/activerecord/lib/active_record/attribute_methods/query.rb#L25-L26) (e.g. `0` in a `ActiveRecord::Type::Integer` column as above).

### System configuration
**Rails version**: 4.2.6

**Ruby version**: 2.3.1
",https://api.github.com/repos/rails/rails/issues/28438/timeline,,alecdotninja,4643450,MDQ6VXNlcjQ2NDM0NTA=,https://avatars.githubusercontent.com/u/4643450?v=4,,https://api.github.com/users/alecdotninja,https://github.com/alecdotninja,https://api.github.com/users/alecdotninja/followers,https://api.github.com/users/alecdotninja/following{/other_user},https://api.github.com/users/alecdotninja/gists{/gist_id},https://api.github.com/users/alecdotninja/starred{/owner}{/repo},https://api.github.com/users/alecdotninja/subscriptions,https://api.github.com/users/alecdotninja/orgs,https://api.github.com/users/alecdotninja/repos,https://api.github.com/users/alecdotninja/events{/privacy},https://api.github.com/users/alecdotninja/received_events,User,False,https://api.github.com/repos/rails/rails/issues/28438/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
510,https://api.github.com/repos/rails/rails/issues/28416,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/28416/labels{/name},https://api.github.com/repos/rails/rails/issues/28416/comments,https://api.github.com/repos/rails/rails/issues/28416/events,https://github.com/rails/rails/pull/28416,214199816,MDExOlB1bGxSZXF1ZXN0MTEwNzEyNzQ4,28416,Deserialize a raw value from the database in `changed_in_place?` for `Mutable` helper,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}]",open,False,,[],,23,2017-03-14T20:40:58Z,2022-02-26T05:46:45Z,,MEMBER,,"Structured type values sometimes caused representation problems (keys
sort order, spaces, etc). A raw value from the database should be
deserialized (normalized) to prevent the problems.",https://api.github.com/repos/rails/rails/issues/28416/timeline,,kamipo,12642,MDQ6VXNlcjEyNjQy,https://avatars.githubusercontent.com/u/12642?v=4,,https://api.github.com/users/kamipo,https://github.com/kamipo,https://api.github.com/users/kamipo/followers,https://api.github.com/users/kamipo/following{/other_user},https://api.github.com/users/kamipo/gists{/gist_id},https://api.github.com/users/kamipo/starred{/owner}{/repo},https://api.github.com/users/kamipo/subscriptions,https://api.github.com/users/kamipo/orgs,https://api.github.com/users/kamipo/repos,https://api.github.com/users/kamipo/events{/privacy},https://api.github.com/users/kamipo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/28416/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/28416,https://github.com/rails/rails/pull/28416,https://github.com/rails/rails/pull/28416.diff,https://github.com/rails/rails/pull/28416.patch,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
511,https://api.github.com/repos/rails/rails/issues/28322,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/28322/labels{/name},https://api.github.com/repos/rails/rails/issues/28322/comments,https://api.github.com/repos/rails/rails/issues/28322/events,https://github.com/rails/rails/issues/28322,212301851,MDU6SXNzdWUyMTIzMDE4NTE=,28322,NilClass.to_query(key) does not round-trip with Rack::Utils.parse_nested_query,"[{'id': 107194, 'node_id': 'MDU6TGFiZWwxMDcxOTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/activesupport', 'name': 'activesupport', 'color': 'FC9300', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2017-03-07T01:21:20Z,2017-03-07T22:22:33Z,,CONTRIBUTOR,,"### Steps to reproduce

It should ideally be possible to round-trip from a `Hash` or `ActionController::Parameters` object to a query string and back. Currently, this does not work when the value is `nil`, in which case the value round-trips to `''` instead of `nil`.

See this gist: https://gist.github.com/md5/be5d072bb2c853baf2143dd5faba69cb

### Expected behavior
Having a `nil` value in the parameters hash should result in a key with no value in the query string.

### Actual behavior
Currently, a `nil` value results in the same query string as a blank string, namely `key=`.

### System configuration
**Rails version**: Any

**Ruby version**: Any
",https://api.github.com/repos/rails/rails/issues/28322/timeline,,md5,76367,MDQ6VXNlcjc2MzY3,https://avatars.githubusercontent.com/u/76367?v=4,,https://api.github.com/users/md5,https://github.com/md5,https://api.github.com/users/md5/followers,https://api.github.com/users/md5/following{/other_user},https://api.github.com/users/md5/gists{/gist_id},https://api.github.com/users/md5/starred{/owner}{/repo},https://api.github.com/users/md5/subscriptions,https://api.github.com/users/md5/orgs,https://api.github.com/users/md5/repos,https://api.github.com/users/md5/events{/privacy},https://api.github.com/users/md5/received_events,User,False,https://api.github.com/repos/rails/rails/issues/28322/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
512,https://api.github.com/repos/rails/rails/issues/28001,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/28001/labels{/name},https://api.github.com/repos/rails/rails/issues/28001/comments,https://api.github.com/repos/rails/rails/issues/28001/events,https://github.com/rails/rails/issues/28001,207587504,MDU6SXNzdWUyMDc1ODc1MDQ=,28001,Failed migration in a fresh database prevents subsequent `rails db:drop` from working,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,0,2017-02-14T17:47:22Z,2017-02-17T23:41:44Z,,CONTRIBUTOR,,"### Steps to reproduce

In a fresh Rails app, create a migration that succeeds and a later one that fails:

```ruby
# db/migrate/20170211175941_good_migration.rb
class GoodMigration < ActiveRecord::Migration[5.1]
  def change
  end
end
```

```ruby
# db/migrate/20170211175942_bad_migration.rb
class BadMigration < ActiveRecord::Migration[5.1]
  def change
    raise ""fail""
  end
end
```

Then create the database and run the migration with `rails db:create db:migrate`, which fails on the second migration:

```
$ RAILS_ENV=test bundle exec rails db:create db:migrate
Created database 'foo_test'
== 20170211175941 GoodMigration: migrating ====================================
== 20170211175941 GoodMigration: migrated (0.0000s) ===========================

== 20170211175942 BadMigration: migrating =====================================
rails aborted!
StandardError: An error has occurred, this and all later migrations canceled:

fail
...
```

Now if I want to drop the whole database to start over with `rails db:drop`, I can't:

```
$ VERBOSE=true RAILS_ENV=test bundle exec rails db:drop --trace
** Invoke db:drop (first_time)
** Invoke db:load_config (first_time)
** Execute db:load_config
** Invoke db:check_protected_environments (first_time)
** Invoke environment (first_time)
** Execute environment
** Invoke db:load_config 
** Execute db:check_protected_environments
rails aborted!
ActiveRecord::NoEnvironmentInSchemaError: 

Environment data not found in the schema. To resolve this issue, run: 

        bin/rails db:environment:set RAILS_ENV=test
...
```

(Here's a demo app with the above that reproduces the issue: https://github.com/abevoelker/rails5bug/tree/rails-db-drop-issue)

### Expected behavior
`rails db:drop` should succeed

### Actual behavior
`rails db:drop` fails. If I instead do `rails db:environment:set db:drop` it works, but coming from 4.2 it's not intuitive what is going on to cause this error. Apparently the underlying issue is that the new ""ar_internal_metadata"" table gets created during migrations, but not populated with any rows.

### System configuration
**Rails version**: edge (437020aa6dd4bae19706628daab6725fcb786a45), 5.0.1

**Ruby version**: 2.3.3
",https://api.github.com/repos/rails/rails/issues/28001/timeline,,abevoelker,153459,MDQ6VXNlcjE1MzQ1OQ==,https://avatars.githubusercontent.com/u/153459?v=4,,https://api.github.com/users/abevoelker,https://github.com/abevoelker,https://api.github.com/users/abevoelker/followers,https://api.github.com/users/abevoelker/following{/other_user},https://api.github.com/users/abevoelker/gists{/gist_id},https://api.github.com/users/abevoelker/starred{/owner}{/repo},https://api.github.com/users/abevoelker/subscriptions,https://api.github.com/users/abevoelker/orgs,https://api.github.com/users/abevoelker/repos,https://api.github.com/users/abevoelker/events{/privacy},https://api.github.com/users/abevoelker/received_events,User,False,https://api.github.com/repos/rails/rails/issues/28001/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
513,https://api.github.com/repos/rails/rails/issues/27659,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27659/labels{/name},https://api.github.com/repos/rails/rails/issues/27659/comments,https://api.github.com/repos/rails/rails/issues/27659/events,https://github.com/rails/rails/issues/27659,200438655,MDU6SXNzdWUyMDA0Mzg2NTU=,27659,ActionCable's SubscriptionAdpater for Redis does not reconnect after a connection loss.,"[{'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,"[{'login': 'jeremy', 'id': 199, 'node_id': 'MDQ6VXNlcjE5OQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/199?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jeremy', 'html_url': 'https://github.com/jeremy', 'followers_url': 'https://api.github.com/users/jeremy/followers', 'following_url': 'https://api.github.com/users/jeremy/following{/other_user}', 'gists_url': 'https://api.github.com/users/jeremy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jeremy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jeremy/subscriptions', 'organizations_url': 'https://api.github.com/users/jeremy/orgs', 'repos_url': 'https://api.github.com/users/jeremy/repos', 'events_url': 'https://api.github.com/users/jeremy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jeremy/received_events', 'type': 'User', 'site_admin': False}]",,19,2017-01-12T18:03:48Z,2021-10-10T07:44:53Z,,NONE,,"### Steps to reproduce

* Start rails server and let ActionCable establish a connection to Redis.
* Restart/Stop the Redis instance.

### Expected behavior

If the connection between ActionCable and Redis is interrupted or lost the server process tries to re-establish the connection, informs web socket connections about the disconnection (or re-establishes subscriptions) and does not abort.

### Actual behavior

If the connection between ActionCable and Redis is interrupted or lost the server [process is aborted](https://github.com/rails/rails/blob/master/actioncable/lib/action_cable/subscription_adapter/redis.rb#L143), without trying to re-establish the connection.

```
RoomChannel is transmitting the subscription confirmation
RoomChannel is streaming from room:123
Exiting
2.3.3/gems/redis-3.3.2/lib/redis/client.rb:257:in `rescue in io': Connection lost (ECONNRESET) (Redis::ConnectionError)
  gems/redis-3.3.2/lib/redis/client.rb:250:in `io'
  gems/redis-3.3.2/lib/redis/client.rb:261:in `read'
  gems/redis-3.3.2/lib/redis/client.rb:136:in `block (3 levels) in call_loop'
  gems/redis-3.3.2/lib/redis/client.rb:135:in `loop'
  gems/redis-3.3.2/lib/redis/client.rb:135:in `block (2 levels) in call_loop'
  gems/redis-3.3.2/lib/redis/client.rb:231:in `block (2 levels) in process'
  gems/redis-3.3.2/lib/redis/client.rb:367:in `ensure_connected'
  gems/redis-3.3.2/lib/redis/client.rb:221:in `block in process'
  gems/redis-3.3.2/lib/redis/client.rb:306:in `logging'
  gems/redis-3.3.2/lib/redis/client.rb:220:in `process'
  gems/redis-3.3.2/lib/redis/client.rb:134:in `block in call_loop'
  gems/redis-3.3.2/lib/redis/client.rb:280:in `with_socket_timeout'
  gems/redis-3.3.2/lib/redis/client.rb:133:in `call_loop'
  gems/redis-3.3.2/lib/redis/subscribe.rb:43:in `subscription'
  gems/redis-3.3.2/lib/redis/subscribe.rb:12:in `subscribe'
  gems/redis-3.3.2/lib/redis.rb:2765:in `_subscription'
  gems/redis-3.3.2/lib/redis.rb:2143:in `block in subscribe'
  gems/redis-3.3.2/lib/redis.rb:58:in `block in synchronize'
  from .rubies/ruby-2.3.3/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'
  gems/redis-3.3.2/lib/redis.rb:58:in `synchronize'
  gems/redis-3.3.2/lib/redis.rb:2142:in `subscribe'
  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:75:in `block in listen'
  gems/redis-3.3.2/lib/redis/client.rb:293:in `with_reconnect'
  gems/redis-3.3.2/lib/redis.rb:64:in `block in with_reconnect'
  gems/redis-3.3.2/lib/redis.rb:58:in `block in synchronize'
  from .rubies/ruby-2.3.3/lib/ruby/2.3.0/monitor.rb:214:in `mon_synchronize'
  gems/redis-3.3.2/lib/redis.rb:58:in `synchronize'
  gems/redis-3.3.2/lib/redis.rb:63:in `with_reconnect'
  gems/redis-3.3.2/lib/redis.rb:70:in `without_reconnect'
  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:72:in `listen'
  gems/actioncable-5.0.1/lib/action_cable/subscription_adapter/redis.rb:146:in `block in ensure_listener_running'
```

### Additional information

As soon as the redis instance is unavailable and redis-rb receives the EOF from reading the socket the [Listener](https://github.com/rails/rails/blob/master/actioncable/lib/action_cable/subscription_adapter/redis.rb#L71) aborts [as intended? here](https://github.com/rails/rails/blob/master/actioncable/lib/action_cable/subscription_adapter/redis.rb#L143).

The redis-rb client offers the option to specify `reconnect_attempts` during initialisation, but in case of a disconnection, after a successful one, [the client doesn't attempt a reconnection](https://github.com/redis/redis-rb/blob/master/lib/redis/client.rb#L371). Even if it did, it might be too aggressive to allow a re-establishment since there is no delay.

A work-around is something like:

        def listen_with_retry(conn)
          listen conn
        rescue ::Redis::ConnectionError, ::Redis::CannotConnectError => e
          ActionCable.server.connections.each(&:close)
          sleep 1
          retry
        end

### System configuration
**Rails version**: Rails 5.0.1

**Ruby version**: ruby 2.3.3p222
",https://api.github.com/repos/rails/rails/issues/27659/timeline,,wpp,942021,MDQ6VXNlcjk0MjAyMQ==,https://avatars.githubusercontent.com/u/942021?v=4,,https://api.github.com/users/wpp,https://github.com/wpp,https://api.github.com/users/wpp/followers,https://api.github.com/users/wpp/following{/other_user},https://api.github.com/users/wpp/gists{/gist_id},https://api.github.com/users/wpp/starred{/owner}{/repo},https://api.github.com/users/wpp/subscriptions,https://api.github.com/users/wpp/orgs,https://api.github.com/users/wpp/repos,https://api.github.com/users/wpp/events{/privacy},https://api.github.com/users/wpp/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27659/reactions,22,22,0,0,0,0,0,0,0,,,,,,,jeremy,199.0,MDQ6VXNlcjE5OQ==,https://avatars.githubusercontent.com/u/199?v=4,,https://api.github.com/users/jeremy,https://github.com/jeremy,https://api.github.com/users/jeremy/followers,https://api.github.com/users/jeremy/following{/other_user},https://api.github.com/users/jeremy/gists{/gist_id},https://api.github.com/users/jeremy/starred{/owner}{/repo},https://api.github.com/users/jeremy/subscriptions,https://api.github.com/users/jeremy/orgs,https://api.github.com/users/jeremy/repos,https://api.github.com/users/jeremy/events{/privacy},https://api.github.com/users/jeremy/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
514,https://api.github.com/repos/rails/rails/issues/27584,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27584/labels{/name},https://api.github.com/repos/rails/rails/issues/27584/comments,https://api.github.com/repos/rails/rails/issues/27584/events,https://github.com/rails/rails/issues/27584,199049983,MDU6SXNzdWUxOTkwNDk5ODM=,27584,cookies.delete broken for request type other than GET in controller tests,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'maclover7', 'id': 3020626, 'node_id': 'MDQ6VXNlcjMwMjA2MjY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3020626?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maclover7', 'html_url': 'https://github.com/maclover7', 'followers_url': 'https://api.github.com/users/maclover7/followers', 'following_url': 'https://api.github.com/users/maclover7/following{/other_user}', 'gists_url': 'https://api.github.com/users/maclover7/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maclover7/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maclover7/subscriptions', 'organizations_url': 'https://api.github.com/users/maclover7/orgs', 'repos_url': 'https://api.github.com/users/maclover7/repos', 'events_url': 'https://api.github.com/users/maclover7/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maclover7/received_events', 'type': 'User', 'site_admin': False}]",,3,2017-01-05T20:21:56Z,2017-06-27T03:49:15Z,,NONE,,"### Steps to reproduce
[Reproduction Script](https://gist.github.com/iamchucky/c0d6acb48befe9ac72c12e079739cb2e)

### Expected behavior
`cookies[""foo""]` in test cases should be `nil` after `cookies.delete` is called in controller

### Actual behavior
only GET request has the `cookies[""foo""]` deleted while other request types still has `cookies[""foo""]`

### System configuration
**Rails version**: 5.0.1, 5-0-stable
**Ruby version**: 2.3.1p112


Note that this is passing for Rails 4.2.7.1

I've noticed that https://github.com/rails/rails/commit/ae29142142324545a328948e059e8b8118fd7a33 has `cookies.update res.cookies` only for `get` but not for other request types, is that the root of the issue though?

This issue also seems to be related:
https://github.com/rspec/rspec-rails/issues/1574",https://api.github.com/repos/rails/rails/issues/27584/timeline,,iamchucky,466774,MDQ6VXNlcjQ2Njc3NA==,https://avatars.githubusercontent.com/u/466774?v=4,,https://api.github.com/users/iamchucky,https://github.com/iamchucky,https://api.github.com/users/iamchucky/followers,https://api.github.com/users/iamchucky/following{/other_user},https://api.github.com/users/iamchucky/gists{/gist_id},https://api.github.com/users/iamchucky/starred{/owner}{/repo},https://api.github.com/users/iamchucky/subscriptions,https://api.github.com/users/iamchucky/orgs,https://api.github.com/users/iamchucky/repos,https://api.github.com/users/iamchucky/events{/privacy},https://api.github.com/users/iamchucky/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27584/reactions,0,0,0,0,0,0,0,0,0,,,,,,,maclover7,3020626.0,MDQ6VXNlcjMwMjA2MjY=,https://avatars.githubusercontent.com/u/3020626?v=4,,https://api.github.com/users/maclover7,https://github.com/maclover7,https://api.github.com/users/maclover7/followers,https://api.github.com/users/maclover7/following{/other_user},https://api.github.com/users/maclover7/gists{/gist_id},https://api.github.com/users/maclover7/starred{/owner}{/repo},https://api.github.com/users/maclover7/subscriptions,https://api.github.com/users/maclover7/orgs,https://api.github.com/users/maclover7/repos,https://api.github.com/users/maclover7/events{/privacy},https://api.github.com/users/maclover7/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
515,https://api.github.com/repos/rails/rails/issues/27581,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27581/labels{/name},https://api.github.com/repos/rails/rails/issues/27581/comments,https://api.github.com/repos/rails/rails/issues/27581/events,https://github.com/rails/rails/issues/27581,198955439,MDU6SXNzdWUxOTg5NTU0Mzk=,27581,Deferred fixture enrolment causes over-eager connection,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}, {'login': 'arthurnn', 'id': 833383, 'node_id': 'MDQ6VXNlcjgzMzM4Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/833383?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/arthurnn', 'html_url': 'https://github.com/arthurnn', 'followers_url': 'https://api.github.com/users/arthurnn/followers', 'following_url': 'https://api.github.com/users/arthurnn/following{/other_user}', 'gists_url': 'https://api.github.com/users/arthurnn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/arthurnn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/arthurnn/subscriptions', 'organizations_url': 'https://api.github.com/users/arthurnn/orgs', 'repos_url': 'https://api.github.com/users/arthurnn/repos', 'events_url': 'https://api.github.com/users/arthurnn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/arthurnn/received_events', 'type': 'User', 'site_admin': True}]",,5,2017-01-05T13:26:42Z,2017-06-20T21:55:29Z,,MEMBER,,"#20818 aimed to ensure we consistently apply ~fixture~ transactions to all future connections, as well as the ones that already exist during test setup.

But it seems to conflate the creation of the pool and the creation of the actual connections, causing an immediate connection as soon as a pool is configured -- plus missing other connections that could be established.

Using some mechanism, like the notification, to notice when a new pool is configured is a good plan -- but the reaction should be to enlist said pool in *future* transaction management of its actual connections, as & when they get created and/or checked out.

I think we should likewise enlist the existing pools, instead of forcefully connecting them, too.

cc @rafaelfranca @arthurnn ",https://api.github.com/repos/rails/rails/issues/27581/timeline,,matthewd,1034,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,https://api.github.com/repos/rails/rails/issues/27581/reactions,0,0,0,0,0,0,0,0,0,,,,,,,rafaelfranca,47848.0,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
516,https://api.github.com/repos/rails/rails/issues/27570,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27570/labels{/name},https://api.github.com/repos/rails/rails/issues/27570/comments,https://api.github.com/repos/rails/rails/issues/27570/events,https://github.com/rails/rails/issues/27570,198724545,MDU6SXNzdWUxOTg3MjQ1NDU=,27570,ActiveRecord::Relation#cache_key returns same key for different records with hm:t association,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'sgrif', 'id': 1529387, 'node_id': 'MDQ6VXNlcjE1MjkzODc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1529387?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sgrif', 'html_url': 'https://github.com/sgrif', 'followers_url': 'https://api.github.com/users/sgrif/followers', 'following_url': 'https://api.github.com/users/sgrif/following{/other_user}', 'gists_url': 'https://api.github.com/users/sgrif/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sgrif/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sgrif/subscriptions', 'organizations_url': 'https://api.github.com/users/sgrif/orgs', 'repos_url': 'https://api.github.com/users/sgrif/repos', 'events_url': 'https://api.github.com/users/sgrif/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sgrif/received_events', 'type': 'User', 'site_admin': False}]",,1,2017-01-04T14:49:24Z,2017-05-15T13:28:52Z,,CONTRIBUTOR,,"`has_many :through` relations that return the same number of records and one common record with the max `updated_at` will generate the same `cache_key`. For example:

```ruby
class Access < ActiveRecord::Base; end
class Person < ActiveRecord::Base; end
class Bucket < ActiveRecord::Base
  has_many :people, through: :accesses
end
```

```ruby
>> bucket.people.map(&:name)
=> [""Victor Cooper"", ""Jared Davis""]

>> bucket.people.cache_key
=> ""people/query-2343a4c885c823c01ef9c2eb358b73eb-2-20161229150259317823""
```

Above, Victor Cooper has the max `updated_at` (`20161229150259317823`). If we remove Jared Davis and add a new person who's `updated_at` is less than Victor's, we'll get the same `cache_key`:

```ruby
>> bucket.reload.people.map(&:name)
=> [""Victor Cooper"", ""Amy Rivera""]

>> bucket.people.cache_key
=> ""people/query-2343a4c885c823c01ef9c2eb358b73eb-2-20161229150259317823""
```

This was introduced in https://github.com/rails/rails/pull/20884. /cc @afcapel @sgrif  ",https://api.github.com/repos/rails/rails/issues/27570/timeline,,javan,5355,MDQ6VXNlcjUzNTU=,https://avatars.githubusercontent.com/u/5355?v=4,,https://api.github.com/users/javan,https://github.com/javan,https://api.github.com/users/javan/followers,https://api.github.com/users/javan/following{/other_user},https://api.github.com/users/javan/gists{/gist_id},https://api.github.com/users/javan/starred{/owner}{/repo},https://api.github.com/users/javan/subscriptions,https://api.github.com/users/javan/orgs,https://api.github.com/users/javan/repos,https://api.github.com/users/javan/events{/privacy},https://api.github.com/users/javan/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27570/reactions,0,0,0,0,0,0,0,0,0,,,,,,,sgrif,1529387.0,MDQ6VXNlcjE1MjkzODc=,https://avatars.githubusercontent.com/u/1529387?v=4,,https://api.github.com/users/sgrif,https://github.com/sgrif,https://api.github.com/users/sgrif/followers,https://api.github.com/users/sgrif/following{/other_user},https://api.github.com/users/sgrif/gists{/gist_id},https://api.github.com/users/sgrif/starred{/owner}{/repo},https://api.github.com/users/sgrif/subscriptions,https://api.github.com/users/sgrif/orgs,https://api.github.com/users/sgrif/repos,https://api.github.com/users/sgrif/events{/privacy},https://api.github.com/users/sgrif/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
517,https://api.github.com/repos/rails/rails/issues/27426,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27426/labels{/name},https://api.github.com/repos/rails/rails/issues/27426/comments,https://api.github.com/repos/rails/rails/issues/27426/events,https://github.com/rails/rails/issues/27426,196990688,MDU6SXNzdWUxOTY5OTA2ODg=,27426,5.0.0.1 -> 5.0.1 breaks validates uniqueness with relation,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,8,2016-12-21T17:35:49Z,2019-09-29T20:52:18Z,,CONTRIBUTOR,,"this used to work ... 
```
validates :name, uniqueness: {scope: [:user]}
```

now needs to be:
```
validates :name, uniqueness: {scope: [:user_id]}
```

... either fix or warn loudly that relations are not supported",https://api.github.com/repos/rails/rails/issues/27426/timeline,,grosser,11367,MDQ6VXNlcjExMzY3,https://avatars.githubusercontent.com/u/11367?v=4,,https://api.github.com/users/grosser,https://github.com/grosser,https://api.github.com/users/grosser/followers,https://api.github.com/users/grosser/following{/other_user},https://api.github.com/users/grosser/gists{/gist_id},https://api.github.com/users/grosser/starred{/owner}{/repo},https://api.github.com/users/grosser/subscriptions,https://api.github.com/users/grosser/orgs,https://api.github.com/users/grosser/repos,https://api.github.com/users/grosser/events{/privacy},https://api.github.com/users/grosser/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27426/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
518,https://api.github.com/repos/rails/rails/issues/27364,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27364/labels{/name},https://api.github.com/repos/rails/rails/issues/27364/comments,https://api.github.com/repos/rails/rails/issues/27364/events,https://github.com/rails/rails/issues/27364,195682569,MDU6SXNzdWUxOTU2ODI1Njk=,27364,Nullify callback persists even as child class overrides association,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,4,2016-12-15T00:14:13Z,2017-08-07T02:08:02Z,,CONTRIBUTOR,,"### Steps to reproduce

```
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""
  gem ""activerecord"", ""5.0.0.1""
  gem ""sqlite3""
  gem 'pry'
  gem 'pry-byebug'
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# Ensure backward compatibility with Minitest 4
Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table ""houses"", force: :cascade do |t|
    t.integer  ""person_id""
    t.datetime ""created_at"", null: false
    t.datetime ""updated_at"", null: false
  end

  create_table ""people"", force: :cascade do |t|
    t.integer  ""parent_id""
    t.datetime ""created_at"", null: false
    t.datetime ""updated_at"", null: false
  end
end

class House < ActiveRecord::Base
  belongs_to :person
end

class Person < ActiveRecord::Base
  has_one :child, :foreign_key => 'parent_id', :foreign_type => 'Child'
  # Houses will continue to exist, but without their owners...
  has_many :houses, :dependent => :nullify
end

class Child < Person
  belongs_to :parent, :class_name => 'Person'
  # A child's house is their parent's house!
  has_many :houses, :through => :parent
end

class BugTest < Minitest::Test
  def setup
    @parent = Person.create(:houses => [House.create, House.create], :child => Child.create)
    @child = @parent.child

    assert_equal @parent.child, @child
    assert_equal @child.parent, @parent
    assert_equal @parent.houses.count, 2
  end

  def test_parentless_child_houses
    @parentless_child = Child.create

    assert_equal @parentless_child.houses.count, 0 # Passes
  end

  def test_child_houses_are_their_parents_houses
    assert_equal @parent.houses, @child.houses # Passes
  end

  def test_person_destroy
    assert @parent.destroy # Passes
  end

  def test_child_destroy
    assert @child.destroy # Fails!
  end
end
```

### Expected behavior

I should be able to destroy the child as the association I've specified does not attempt to nullify houses. 

### Actual behavior

```
Error: BugTest#test_child_destroy:
ActiveRecord::HasManyThroughCantAssociateThroughHasOneOrManyReflection:
Cannot modify association 'Child#houses' because the source reflection class
'House' is associated to 'Person' via :has_many.
```

### More notes

I've been digging in a bit trying to find the cause of this, but have started getting in over my head with callbacks. It appears on `child.destroy` that `_destroy_callbacks` from a `nullify` are indeed present (even though they shouldn't be), although the options within the reflection object doesn't seem to indicate that:

```
> Person.reflections['houses']
=> #<ActiveRecord::Reflection::HasManyReflection:0x007fc1703b2070
 @active_record=Person(id: integer, parent_id: integer, created_at: datetime, updated_at: datetime),
 @active_record_primary_key=""id"",
 @association_scope_cache={},
 @automatic_inverse_of=:person,
 @class_name=""House"",
 @constructable=true,
 @foreign_key=""person_id"",
 @foreign_type=""houses_type"",
 @inverse_of=
  #<ActiveRecord::Reflection::BelongsToReflection:0x007fc1703fa3e8
   @active_record=House(id: integer, person_id: integer, created_at: datetime, updated_at: datetime),
   @association_scope_cache={},
   @automatic_inverse_of=false,
   @class_name=""Person"",
   @constructable=true,
   @foreign_key=""person_id"",
   @foreign_type=""person_type"",
   @klass=Person(id: integer, parent_id: integer, created_at: datetime, updated_at: datetime),
   @name=:person,
   @options={},
   @plural_name=""people"",
   @scope=nil,
   @scope_lock=#<Thread::Mutex:0x007fc1703f9f60>,
   @type=nil>,
 @inverse_which_updates_counter_cache=nil,
 @klass=House(id: integer, person_id: integer, created_at: datetime, updated_at: datetime),
 @name=:houses,
 @options={:dependent=>:nullify},
 @plural_name=""houses"",
 @scope=nil,
 @scope_lock=#<Thread::Mutex:0x007fc1703b1d00>,
 @type=nil>

> Child.reflections['houses']
=> #<ActiveRecord::Reflection::ThroughReflection:0x007fc170388bd0
 @class_name=""House"",
 @delegate_reflection=
  #<ActiveRecord::Reflection::HasManyReflection:0x007fc170388888
   @active_record=Child(id: integer, parent_id: integer, created_at: datetime, updated_at: datetime),
   @association_scope_cache={},
   @automatic_inverse_of=false,
   @constructable=true,
   @foreign_type=""houses_type"",
   @klass=nil,
   @name=:houses,
   @options={:through=>:parent},
   @plural_name=""houses"",
   @scope=nil,
   @scope_lock=#<Thread::Mutex:0x007fc170388388>,
   @type=nil>,
 @klass=House(id: integer, person_id: integer, created_at: datetime, updated_at: datetime),
 @source_reflection_name=:houses>
```

### System configuration
**Rails version**: 5.0.0.1

**Ruby version**: 2.3.1

cc/ @matthewd @durandom",https://api.github.com/repos/rails/rails/issues/27364/timeline,,chrisarcand,2430490,MDQ6VXNlcjI0MzA0OTA=,https://avatars.githubusercontent.com/u/2430490?v=4,,https://api.github.com/users/chrisarcand,https://github.com/chrisarcand,https://api.github.com/users/chrisarcand/followers,https://api.github.com/users/chrisarcand/following{/other_user},https://api.github.com/users/chrisarcand/gists{/gist_id},https://api.github.com/users/chrisarcand/starred{/owner}{/repo},https://api.github.com/users/chrisarcand/subscriptions,https://api.github.com/users/chrisarcand/orgs,https://api.github.com/users/chrisarcand/repos,https://api.github.com/users/chrisarcand/events{/privacy},https://api.github.com/users/chrisarcand/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27364/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
519,https://api.github.com/repos/rails/rails/issues/27273,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27273/labels{/name},https://api.github.com/repos/rails/rails/issues/27273/comments,https://api.github.com/repos/rails/rails/issues/27273/events,https://github.com/rails/rails/issues/27273,193591919,MDU6SXNzdWUxOTM1OTE5MTk=,27273,Memory leak in development,"[{'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,"[{'login': 'kaspth', 'id': 350807, 'node_id': 'MDQ6VXNlcjM1MDgwNw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/350807?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/kaspth', 'html_url': 'https://github.com/kaspth', 'followers_url': 'https://api.github.com/users/kaspth/followers', 'following_url': 'https://api.github.com/users/kaspth/following{/other_user}', 'gists_url': 'https://api.github.com/users/kaspth/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/kaspth/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/kaspth/subscriptions', 'organizations_url': 'https://api.github.com/users/kaspth/orgs', 'repos_url': 'https://api.github.com/users/kaspth/repos', 'events_url': 'https://api.github.com/users/kaspth/events{/privacy}', 'received_events_url': 'https://api.github.com/users/kaspth/received_events', 'type': 'User', 'site_admin': False}]",,16,2016-12-05T19:45:08Z,2018-10-18T07:00:41Z,,CONTRIBUTOR,,"### Steps to reproduce

Add lines to `ApplicationController`:
```ruby
  after_action do
    logger.info 'Leaked: ' +
      view_paths.first.instance_variable_get(:@cache).instance_variable_get(:@data).size.to_s
  end
```

Refresh page few times. See the number is increasing.

It's related to #20384. Digests are cleared, but not cache objects. I haven't found easy way to clear all caches, as every controller seems to have its own.

### Expected behavior

Cache size should not be incremented infinitely.

### Actual behavior

It's incremented infinitely.

### System configuration
**Rails version**: 5.0.0.1

**Ruby version**: 2.3
",https://api.github.com/repos/rails/rails/issues/27273/timeline,,printercu,1144890,MDQ6VXNlcjExNDQ4OTA=,https://avatars.githubusercontent.com/u/1144890?v=4,,https://api.github.com/users/printercu,https://github.com/printercu,https://api.github.com/users/printercu/followers,https://api.github.com/users/printercu/following{/other_user},https://api.github.com/users/printercu/gists{/gist_id},https://api.github.com/users/printercu/starred{/owner}{/repo},https://api.github.com/users/printercu/subscriptions,https://api.github.com/users/printercu/orgs,https://api.github.com/users/printercu/repos,https://api.github.com/users/printercu/events{/privacy},https://api.github.com/users/printercu/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27273/reactions,1,1,0,0,0,0,0,0,0,,,,,,,kaspth,350807.0,MDQ6VXNlcjM1MDgwNw==,https://avatars.githubusercontent.com/u/350807?v=4,,https://api.github.com/users/kaspth,https://github.com/kaspth,https://api.github.com/users/kaspth/followers,https://api.github.com/users/kaspth/following{/other_user},https://api.github.com/users/kaspth/gists{/gist_id},https://api.github.com/users/kaspth/starred{/owner}{/repo},https://api.github.com/users/kaspth/subscriptions,https://api.github.com/users/kaspth/orgs,https://api.github.com/users/kaspth/repos,https://api.github.com/users/kaspth/events{/privacy},https://api.github.com/users/kaspth/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
520,https://api.github.com/repos/rails/rails/issues/27231,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27231/labels{/name},https://api.github.com/repos/rails/rails/issues/27231/comments,https://api.github.com/repos/rails/rails/issues/27231/events,https://github.com/rails/rails/issues/27231,192637500,MDU6SXNzdWUxOTI2Mzc1MDA=,27231,Dynamic :action segment deprecation forces application bloat after suggested workaround,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 35206628, 'node_id': 'MDU6TGFiZWwzNTIwNjYyOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/routing', 'name': 'routing', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,22,2016-11-30T18:05:28Z,2021-01-07T22:28:42Z,,CONTRIBUTOR,,"Though I understand, and agree with, the rationale behind the removal of the dynamic `:action` segment in https://github.com/rails/rails/pull/23980, the suggested workaround to whitelist each individual action is leading to application memory bloat.

With a simple rails runner:

|         | Memory         | Time         | `rails routes` entries |
|---------|----------------|--------------|---------------|
| Before   | 166_028_629 MB | 6.142s       | 656           |
| After  | 187_430_229 MB | 6.838s       | 3798          |
| Change | ~21 MB (+12.9%) | 0.7s (+11.3%) | 3142 (+479.0%)  |

If you want to see the workaround source, you can see it at https://github.com/ManageIQ/manageiq/pull/12895/commits/0f6fee967d71b5f41cfad011d6ada4b058b9517b  (In all fairness, the diff is backwards to the numbers above...we originally had one-route-per-whitelist-entry and are trying to move *towards* the dynamic `:action` with a Regexp whitelist in order to decrease our process memory.  It wasn't until I wrote the change to use the dynamic `:action` that I ran into this deprecation.)

---

### Memory analysis

Using the allocation tracer from [this gist](https://gist.github.com/jrafanie/9e1d3caeb29339f696b8b6f4eca9efda) (Thanks @jrafanie!), you can see that the majority of our boot time retained allocations are in action_dispatch/routing and action_dispatch/journey with a bonus ~53k strings from somewhere else (NOTE: These are the top 10 entries, but note that there are many more journey and routing lines after these)

Before (dynamic `:action`)

```
m:   4,001,968 | c:  34,507 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/routing/mapper.rb
m:   2,795,971 | c:  40,516 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/activesupport-5.0.0.1/lib/active_support/dependencies.rb
m:   1,590,197 | c:  19,996 | String
m:   1,050,224 | c:       1 | Thread
m:   1,031,028 | c:  13,000 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/mime-types-2.6.2/lib/mime/type.rb
m:     878,323 | c:   9,916 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/journey/scanner.rb
m:     795,753 | c:   1,373 | Regexp	/Users/jfrey/.gem/ruby/2.3.3/gems/activesupport-5.0.0.1/lib/active_support/dependencies.rb
m:     783,666 | c:   8,546 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/activesupport-5.0.0.1/lib/active_support/file_update_checker.rb
m:     724,594 | c:   6,196 | String	/Users/jfrey/.rubies/ruby-2.3.3/lib/ruby/2.3.0/racc/parser.rb
m:     716,112 | c:   3,642 | Hash	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/routing/mapper.rb
```

After (one-route-per-whitelist-entry)

```
m:   5,488,795 | c:  53,801 | String
m:   2,945,515 | c:  28,409 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/routing/mapper.rb
m:   2,128,864 | c:  12,364 | Hash	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/routing/mapper.rb
m:   2,116,517 | c:  34,803 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/activesupport-5.0.0.1/lib/active_support/dependencies.rb
m:   1,633,744 | c:  36,181 | Array	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/journey/visitors.rb
m:   1,312,363 | c:  24,171 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/journey/scanner.rb
m:   1,144,800 | c:   4,610 | Hash
m:   1,104,080 | c:  27,602 | ActionDispatch::Journey::Nodes::Cat	/Users/jfrey/.gem/ruby/2.3.3/gems/actionpack-5.0.0.1/lib/action_dispatch/journey/parser.rb
m:   1,050,224 | c:       1 | Thread
m:   1,031,028 | c:  13,000 | String	/Users/jfrey/.gem/ruby/2.3.3/gems/mime-types-2.6.2/lib/mime/type.rb
```

---

I think there are three ways forward with this, so I was hoping to discuss that here.

1. Instead of deprecating the `:action` segment entirely, only deprecate it if there isn't a qualifier (in our case, we have a Regex whitelist).  If a Regex isn't acceptable, perhaps create a specific ""whitelist"" constraint on the `:action` segment, and don't allow dynamic `:actions` without the whitelist constraint.
2. Figure out how we can reduce the memory overhead of the routing.  Additionally, we pay the penalty of setting up the routes even when we don't need them in console or runner, so perhaps we can dynamically resolve them when needed?
3. Just accept that my process will be ~10% heavier (please don't pick this one :smile: )

cc @pixeltrix @tenderlove @matthewd 
",https://api.github.com/repos/rails/rails/issues/27231/timeline,,Fryguy,52120,MDQ6VXNlcjUyMTIw,https://avatars.githubusercontent.com/u/52120?v=4,,https://api.github.com/users/Fryguy,https://github.com/Fryguy,https://api.github.com/users/Fryguy/followers,https://api.github.com/users/Fryguy/following{/other_user},https://api.github.com/users/Fryguy/gists{/gist_id},https://api.github.com/users/Fryguy/starred{/owner}{/repo},https://api.github.com/users/Fryguy/subscriptions,https://api.github.com/users/Fryguy/orgs,https://api.github.com/users/Fryguy/repos,https://api.github.com/users/Fryguy/events{/privacy},https://api.github.com/users/Fryguy/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27231/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
521,https://api.github.com/repos/rails/rails/issues/27214,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27214/labels{/name},https://api.github.com/repos/rails/rails/issues/27214/comments,https://api.github.com/repos/rails/rails/issues/27214/events,https://github.com/rails/rails/issues/27214,192369869,MDU6SXNzdWUxOTIzNjk4Njk=,27214,ActionCable Postgres adapter is ActiveRecord-specific,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,"[{'login': 'maclover7', 'id': 3020626, 'node_id': 'MDQ6VXNlcjMwMjA2MjY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3020626?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maclover7', 'html_url': 'https://github.com/maclover7', 'followers_url': 'https://api.github.com/users/maclover7/followers', 'following_url': 'https://api.github.com/users/maclover7/following{/other_user}', 'gists_url': 'https://api.github.com/users/maclover7/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maclover7/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maclover7/subscriptions', 'organizations_url': 'https://api.github.com/users/maclover7/orgs', 'repos_url': 'https://api.github.com/users/maclover7/repos', 'events_url': 'https://api.github.com/users/maclover7/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maclover7/received_events', 'type': 'User', 'site_admin': False}]",,5,2016-11-29T19:03:54Z,2016-11-29T20:11:37Z,,CONTRIBUTOR,,"### Steps to reproduce

1. Create a Rails app using Sequel and sequel-rails, without ActiveRecord
2. Attempt to use the ActionCable Postgres adapter
3. Watch it crash trying to autoload ActiveRecord

### Expected behavior

Ideally, this would support the most popular Postgres ORMs out of the box. Or at least the docs should mention that this only works with AR.

### Actual behavior

Exception trying to autoload ActiveRecord

### System configuration
**Rails version**: 5.0.0.1

**Ruby version**: 2.3.3

It was very easy to fork the Postgres ActionCable subscription adapter to work with Sequel. I only had to alter the `with_connection` method, which is even shorter with Sequel: https://gist.github.com/bgentry/5a4592dbbcc398c0ad651c53af7da51f#file-postgresql_sequel-rb-L35-L40

I'm not sure whether the right approach is to try to support this out-of-the-box, or at least to document that the adapter is AR-specific. Thoughts?

As a user I'd certainly prefer not to have to maintain a fork of the subscription adapter. But I can certainly see the argument for this not being Rails' problem. I suppose I really only need to monkey-patch or refine that one method, though, so not too bad either way.",https://api.github.com/repos/rails/rails/issues/27214/timeline,,bgentry,114033,MDQ6VXNlcjExNDAzMw==,https://avatars.githubusercontent.com/u/114033?v=4,,https://api.github.com/users/bgentry,https://github.com/bgentry,https://api.github.com/users/bgentry/followers,https://api.github.com/users/bgentry/following{/other_user},https://api.github.com/users/bgentry/gists{/gist_id},https://api.github.com/users/bgentry/starred{/owner}{/repo},https://api.github.com/users/bgentry/subscriptions,https://api.github.com/users/bgentry/orgs,https://api.github.com/users/bgentry/repos,https://api.github.com/users/bgentry/events{/privacy},https://api.github.com/users/bgentry/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27214/reactions,0,0,0,0,0,0,0,0,0,,,,,,,maclover7,3020626.0,MDQ6VXNlcjMwMjA2MjY=,https://avatars.githubusercontent.com/u/3020626?v=4,,https://api.github.com/users/maclover7,https://github.com/maclover7,https://api.github.com/users/maclover7/followers,https://api.github.com/users/maclover7/following{/other_user},https://api.github.com/users/maclover7/gists{/gist_id},https://api.github.com/users/maclover7/starred{/owner}{/repo},https://api.github.com/users/maclover7/subscriptions,https://api.github.com/users/maclover7/orgs,https://api.github.com/users/maclover7/repos,https://api.github.com/users/maclover7/events{/privacy},https://api.github.com/users/maclover7/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
522,https://api.github.com/repos/rails/rails/issues/27211,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/27211/labels{/name},https://api.github.com/repos/rails/rails/issues/27211/comments,https://api.github.com/repos/rails/rails/issues/27211/events,https://github.com/rails/rails/issues/27211,192343588,MDU6SXNzdWUxOTIzNDM1ODg=,27211,Including ActionView::Rendering in API controller without jbuilder breaks render :json,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,15,2016-11-29T17:14:26Z,2020-08-03T23:42:22Z,,NONE,,"Including `ActionView::Rendering` in a controller of an API-only application breaks `render :json`, resulting in an `ActionView::MissingTemplate` error.  This is similar to #25183, except that the error occurs **without** using jbuilder.

### Steps to reproduce

1. Use `rails new --api` to create a Rails app with jbuilder disabled by default.
2. Include `ActionView::Rendering` in a controller subclassed from `ActionController::API`, then `render :json`:

```
class TestController < ActionController::API
  include ActionView::Rendering

  def index
    render json: {page: ""Home""}
  end
end
```

[Full example failing test](https://gist.github.com/jpettettphaxio/303edc3639c0b0820a2fff40bf3b70e3
)

### Expected behavior
JSON response should be returned without error.  No template should be used.

### Actual behavior
`ActionView::MissingTemplate` is raised.

### System configuration
**Rails version**: 5.0.0.1 (used `rails new --api`)

**Ruby version**: 2.3.1
",https://api.github.com/repos/rails/rails/issues/27211/timeline,,jpettettphaxio,20097769,MDQ6VXNlcjIwMDk3NzY5,https://avatars.githubusercontent.com/u/20097769?v=4,,https://api.github.com/users/jpettettphaxio,https://github.com/jpettettphaxio,https://api.github.com/users/jpettettphaxio/followers,https://api.github.com/users/jpettettphaxio/following{/other_user},https://api.github.com/users/jpettettphaxio/gists{/gist_id},https://api.github.com/users/jpettettphaxio/starred{/owner}{/repo},https://api.github.com/users/jpettettphaxio/subscriptions,https://api.github.com/users/jpettettphaxio/orgs,https://api.github.com/users/jpettettphaxio/repos,https://api.github.com/users/jpettettphaxio/events{/privacy},https://api.github.com/users/jpettettphaxio/received_events,User,False,https://api.github.com/repos/rails/rails/issues/27211/reactions,9,9,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
523,https://api.github.com/repos/rails/rails/issues/26999,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26999/labels{/name},https://api.github.com/repos/rails/rails/issues/26999/comments,https://api.github.com/repos/rails/rails/issues/26999/events,https://github.com/rails/rails/issues/26999,188229942,MDU6SXNzdWUxODgyMjk5NDI=,26999,ActionCable streaming performance,"[{'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,7,2016-11-09T11:55:21Z,2018-10-08T17:41:02Z,,CONTRIBUTOR,,"The current implementation of streaming has a rather poor performance (of course, you've heard about [websocket shootout](https://hashrocket.com/blog/posts/websocket-shootout)).

One of the bottlenecks is the [callback hell](https://github.com/rails/rails/blob/9588a3d66d4ca6ba122d32417aa62680f441bf40/actioncable/lib/action_cable/channel/streams.rb#L120-L171). Instead of simply broadcasting messages to sockets we create a callback wrapped in a callback wrapped in another callback etc.
And we also decode and encode message again for every socket.

Here is the [benchmark](https://gist.github.com/palkan/3a77eabb7229d763a53d1d709b9d92e0) I wrote to measure the performance. The results are following:

```
# Very simple transmitter: just broadcast message as is (and adds identifier)
  SimpleSubscriberMap   239.738  (±21.3%) i/s -      1.120k in   5.003338s

# Simple transmitter with JSON round-trip
DecodingSubscriberMap   227.131  (±19.4%) i/s -      1.083k in   5.041594s

# Current ActionCable implementation
        SubscriberMap     9.040  (±11.1%) i/s -     45.000  in   5.028229s

```

Websocket Shootout benchmark also shows that callback-less version (using [this](https://gist.github.com/palkan/42891d59f17f2cf98a074a073a0dbf35) very simple patch) is performing much better (see [slides](https://speakerdeck.com/palkan/railsclub-moscow-2016-anycable#74)). 

So, I have a couple of proposals.

**Soft Proposal**

- do not create _useless_ callbacks when there are no user-specified handlers

- do not decode/encode messages for each socket

**Hard Proposal**

_Soft Proposal_ +  ...

- deprecate custom streaming callbacks, 'cause they influence broadcasting performance (and, IMO, they don't make any sense but provide overhead).

/cc @matthewd @maclover7 ",https://api.github.com/repos/rails/rails/issues/26999/timeline,,palkan,1516722,MDQ6VXNlcjE1MTY3MjI=,https://avatars.githubusercontent.com/u/1516722?v=4,,https://api.github.com/users/palkan,https://github.com/palkan,https://api.github.com/users/palkan/followers,https://api.github.com/users/palkan/following{/other_user},https://api.github.com/users/palkan/gists{/gist_id},https://api.github.com/users/palkan/starred{/owner}{/repo},https://api.github.com/users/palkan/subscriptions,https://api.github.com/users/palkan/orgs,https://api.github.com/users/palkan/repos,https://api.github.com/users/palkan/events{/privacy},https://api.github.com/users/palkan/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26999/reactions,12,12,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
524,https://api.github.com/repos/rails/rails/issues/26916,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26916/labels{/name},https://api.github.com/repos/rails/rails/issues/26916/comments,https://api.github.com/repos/rails/rails/issues/26916/events,https://github.com/rails/rails/issues/26916,185765476,MDU6SXNzdWUxODU3NjU0NzY=,26916,`deliver_later` raises unnecessarily due to overzealous mutation detection,"[{'id': 107188, 'node_id': 'MDU6TGFiZWwxMDcxODg=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionmailer', 'name': 'actionmailer', 'color': '8B00FC', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2016-10-27T19:59:05Z,2021-06-21T19:33:07Z,,CONTRIBUTOR,,"### Steps to reproduce

I maintain an Engine that can be used in Rails 3.2 or newer. When ActionJob was introduced, we added the following code to a controller to start delivering mail in the background where possible:

``` ruby
mail = ::ClearanceMailer.change_password(user)

  if mail.respond_to?(:deliver_later)
    mail.deliver_later
  else
    mail.deliver
  end
```
### Expected behavior

This code should properly detect if the mail object responds to `deliver_later` and do the right thing. This was previously the case.
### Actual behavior

The call to `respond_to?` mutates the `mail` object. The subsequent call to `deliver_later` then triggers an exception due to #24457.

It seems like we actually want ActionMailer objects to be immutable, but instead we try to mark mutations and are overzealous with the detection. The error message raised actually points to the uncertainty in the detection: ""you **may** have made local changes that would be silently lost"" (emphasis added).

It seems like a very helpful thing to try to catch, but I wonder if there's a more accurate way to catch it?
",https://api.github.com/repos/rails/rails/issues/26916/timeline,,derekprior,152152,MDQ6VXNlcjE1MjE1Mg==,https://avatars.githubusercontent.com/u/152152?v=4,,https://api.github.com/users/derekprior,https://github.com/derekprior,https://api.github.com/users/derekprior/followers,https://api.github.com/users/derekprior/following{/other_user},https://api.github.com/users/derekprior/gists{/gist_id},https://api.github.com/users/derekprior/starred{/owner}{/repo},https://api.github.com/users/derekprior/subscriptions,https://api.github.com/users/derekprior/orgs,https://api.github.com/users/derekprior/repos,https://api.github.com/users/derekprior/events{/privacy},https://api.github.com/users/derekprior/received_events,User,True,https://api.github.com/repos/rails/rails/issues/26916/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
525,https://api.github.com/repos/rails/rails/issues/26726,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26726/labels{/name},https://api.github.com/repos/rails/rails/issues/26726/comments,https://api.github.com/repos/rails/rails/issues/26726/events,https://github.com/rails/rails/issues/26726,181509062,MDU6SXNzdWUxODE1MDkwNjI=,26726,"When a parent model has `before/after_commit/rollback` hooks, changing child attributes with `accepts_nested_attributes_for` causes parent to not be touched","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'arthurnn', 'id': 833383, 'node_id': 'MDQ6VXNlcjgzMzM4Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/833383?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/arthurnn', 'html_url': 'https://github.com/arthurnn', 'followers_url': 'https://api.github.com/users/arthurnn/followers', 'following_url': 'https://api.github.com/users/arthurnn/following{/other_user}', 'gists_url': 'https://api.github.com/users/arthurnn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/arthurnn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/arthurnn/subscriptions', 'organizations_url': 'https://api.github.com/users/arthurnn/orgs', 'repos_url': 'https://api.github.com/users/arthurnn/repos', 'events_url': 'https://api.github.com/users/arthurnn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/arthurnn/received_events', 'type': 'User', 'site_admin': True}]",,10,2016-10-06T19:50:35Z,2020-05-19T02:01:28Z,,NONE,,"### Steps to reproduce

Comment out line 39 `after_commit { true }` to get all tests to pass:

``` ruby
begin
  require ""bundler/inline""
rescue LoadError => e
  $stderr.puts ""Bundler version 1.10 or later is required. Please update your Bundler""
  raise e
end

gemfile(true) do
  source ""https://rubygems.org""
  gem ""rails"", github: ""rails/rails""
  gem ""sqlite3""
end

require ""active_record""
require ""minitest/autorun""
require ""logger""

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users do |t|
    t.timestamps
  end

  create_table :posts do |t|
    t.references :user
    t.string :title
    t.timestamps
  end
end

class User < ActiveRecord::Base
  has_many :posts
  accepts_nested_attributes_for :posts

  # Comment out to get tests to pass:
  after_commit { true }
  # Any of the following cause the same issue:
  # after_rollback { true }
  # before_commit { true }
  # before_rollback { true }
end

class Post < ActiveRecord::Base
  belongs_to :user, :touch => true
end

class BugTest < Minitest::Test

  def setup
    User.destroy_all
    Post.destroy_all

    # create a user that was updated an hour ago
    user = User.create
    user.update_columns :created_at => 1.hour.ago, :updated_at => 1.hour.ago
  end

  def test_creating_post_via_has_many_helper_touches_user
    original_updated_at = User.first.updated_at
    User.first.posts.create! :title => 'Post title'

    refute_equal original_updated_at.to_i, User.first.updated_at.to_i
  end

  def test_creating_post_with_nested_attributes_touches_user
    original_updated_at = User.first.updated_at
    User.first.update! :posts_attributes => { '0' => { :title => 'Post title' } }

    refute_equal original_updated_at.to_i, User.first.updated_at.to_i
  end

end
```
### Expected behavior

Creating/updating/destroying a child that is set to touch the parent should do so via nested attributes whether or not the parent has a `before_commit`, `after_commit`, `before_rollback` or `after_rollback` hook set.
### Actual behavior

Creating a `before_commit`, `after_commit`, `before_rollback` or `after_rollback` hook causes nested attributes to NOT touch the parent, even though `:touch => true` is set.
### System configuration

**Rails version**:
5.0.0.1

**Ruby version**:
2.3.1
",https://api.github.com/repos/rails/rails/issues/26726/timeline,,cannikin,300,MDQ6VXNlcjMwMA==,https://avatars.githubusercontent.com/u/300?v=4,,https://api.github.com/users/cannikin,https://github.com/cannikin,https://api.github.com/users/cannikin/followers,https://api.github.com/users/cannikin/following{/other_user},https://api.github.com/users/cannikin/gists{/gist_id},https://api.github.com/users/cannikin/starred{/owner}{/repo},https://api.github.com/users/cannikin/subscriptions,https://api.github.com/users/cannikin/orgs,https://api.github.com/users/cannikin/repos,https://api.github.com/users/cannikin/events{/privacy},https://api.github.com/users/cannikin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26726/reactions,6,6,0,0,0,0,0,0,0,,,,,,,arthurnn,833383.0,MDQ6VXNlcjgzMzM4Mw==,https://avatars.githubusercontent.com/u/833383?v=4,,https://api.github.com/users/arthurnn,https://github.com/arthurnn,https://api.github.com/users/arthurnn/followers,https://api.github.com/users/arthurnn/following{/other_user},https://api.github.com/users/arthurnn/gists{/gist_id},https://api.github.com/users/arthurnn/starred{/owner}{/repo},https://api.github.com/users/arthurnn/subscriptions,https://api.github.com/users/arthurnn/orgs,https://api.github.com/users/arthurnn/repos,https://api.github.com/users/arthurnn/events{/privacy},https://api.github.com/users/arthurnn/received_events,User,True,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
526,https://api.github.com/repos/rails/rails/issues/26457,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26457/labels{/name},https://api.github.com/repos/rails/rails/issues/26457/comments,https://api.github.com/repos/rails/rails/issues/26457/events,https://github.com/rails/rails/issues/26457,176220804,MDU6SXNzdWUxNzYyMjA4MDQ=,26457,`rake test` on mountable engine `require` library twice.,"[{'id': 4782967, 'node_id': 'MDU6TGFiZWw0NzgyOTY3', 'url': 'https://api.github.com/repos/rails/rails/labels/engines', 'name': 'engines', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2016-09-11T05:04:40Z,2018-10-21T20:48:35Z,,NONE,,"### Steps to reproduce
1. Create a new rails mountable engine
2. Create a dummy scaffold, let say a post `rails g scaffold Post title:string description:string`
3. (optional) Put some `puts` statement in the `engine.rb` file to see when it is loaded.
4. Migrate then run `rake test` 
### Expected behavior

The engine should be loaded only once.
### Actual behavior

The `engine.rb` was loaded twice. Got some warnings that said  `warning: method redefined; discarding old test_engine_posts`. If I put a `puts` statement in `engine.rb`, it will be printed twice. This is a problem when having multiple other gems that is `require`d in `engine.rb`. In an application that I try to port to mountable engines, a bunch of ""method redefined"" warning appear. Additionally, some gem may not expect this behavior and could cause problems.
### System configuration

**Rails version**: 4.2.2, 4.2.7.1 and 5.0 

**Ruby version**: 2.1.4 and 2.2.2
",https://api.github.com/repos/rails/rails/issues/26457/timeline,,asdacap,1841324,MDQ6VXNlcjE4NDEzMjQ=,https://avatars.githubusercontent.com/u/1841324?v=4,,https://api.github.com/users/asdacap,https://github.com/asdacap,https://api.github.com/users/asdacap/followers,https://api.github.com/users/asdacap/following{/other_user},https://api.github.com/users/asdacap/gists{/gist_id},https://api.github.com/users/asdacap/starred{/owner}{/repo},https://api.github.com/users/asdacap/subscriptions,https://api.github.com/users/asdacap/orgs,https://api.github.com/users/asdacap/repos,https://api.github.com/users/asdacap/events{/privacy},https://api.github.com/users/asdacap/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26457/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
527,https://api.github.com/repos/rails/rails/issues/26420,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26420/labels{/name},https://api.github.com/repos/rails/rails/issues/26420/comments,https://api.github.com/repos/rails/rails/issues/26420/events,https://github.com/rails/rails/issues/26420,175459111,MDU6SXNzdWUxNzU0NTkxMTE=,26420,increment! method behavior differ Rails4 and Rails5,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2016-09-07T09:46:29Z,2017-03-07T22:32:54Z,,NONE,,"But different in Rails4 and Rails5, and Is not it a problem?
When Rails5, not created the record, I was a little confused.
## Rails4

``` ruby
gem ""activerecord"", ""< 5""
require ""active_record""
ActiveRecord::VERSION::STRING   # => ""4.2.6""
RUBY_VERSION                    # => ""2.3.1""
ActiveSupport::LogSubscriber.colorize_logging = false
ActiveRecord::Migration.verbose = false
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Schema.define do
  create_table :users do |t|
    t.integer :x
  end
end
class User < ActiveRecord::Base
end
ActiveRecord::Base.logger = ActiveSupport::Logger.new(STDOUT)
User.new.increment!(:x)         # => true
# >>    (0.0ms)  begin transaction
# >>   SQL (0.1ms)  INSERT INTO ""users"" (""x"") VALUES (?)  [[""x"", 1]]
# >>    (0.0ms)  commit transaction
```
## Rails5

``` ruby
require ""active_record""
ActiveRecord::VERSION::STRING   # => ""5.0.0.1""
RUBY_VERSION                    # => ""2.3.1""
ActiveSupport::LogSubscriber.colorize_logging = false
ActiveRecord::Migration.verbose = false
ActiveRecord::Base.establish_connection(adapter: ""sqlite3"", database: "":memory:"")
ActiveRecord::Schema.define do
  create_table :users do |t|
    t.integer :x
  end
end
class User < ActiveRecord::Base
end
ActiveRecord::Base.logger = ActiveSupport::Logger.new(STDOUT)
User.new.increment!(:x)         # => #<User id: nil, x: 1>
# >>   SQL (0.1ms)  UPDATE ""users"" SET ""x"" = COALESCE(""x"", 0) + 1 WHERE ""users"".""id"" IS NULL
```
",https://api.github.com/repos/rails/rails/issues/26420/timeline,,akicho8,808955,MDQ6VXNlcjgwODk1NQ==,https://avatars.githubusercontent.com/u/808955?v=4,,https://api.github.com/users/akicho8,https://github.com/akicho8,https://api.github.com/users/akicho8/followers,https://api.github.com/users/akicho8/following{/other_user},https://api.github.com/users/akicho8/gists{/gist_id},https://api.github.com/users/akicho8/starred{/owner}{/repo},https://api.github.com/users/akicho8/subscriptions,https://api.github.com/users/akicho8/orgs,https://api.github.com/users/akicho8/repos,https://api.github.com/users/akicho8/events{/privacy},https://api.github.com/users/akicho8/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26420/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
528,https://api.github.com/repos/rails/rails/issues/26366,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26366/labels{/name},https://api.github.com/repos/rails/rails/issues/26366/comments,https://api.github.com/repos/rails/rails/issues/26366/events,https://github.com/rails/rails/issues/26366,174726186,MDU6SXNzdWUxNzQ3MjYxODY=,26366,Default disable_with on submit_tag breaks the app if the user goes back,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2016-09-02T10:13:20Z,2021-09-07T17:21:35Z,,NONE,,"### Steps to reproduce
1. Add an `f.submit` to your app
2. Observe the default `data-disable-with` attribute
3. Submit the form
4. Hit the back button
### Expected behavior

The submit button should be enabled.
### Actual behavior

The submit button retains its `disabled` state due to the browser caching the state of the form.

This is a good thing in general – we want state to be retained as we want users to be able to edit their previous submission and resubmit. However with a disabled submit button the app is effectively broken from that point on until they know how to force a refresh (standard refresh doesn’t refresh form state) or can pop open web inspector and manually remove the disabled state.

While I can see the utility of this behaviour it’s absolutely user hostile to make it a default. I note that in the PR that added this (https://github.com/rails/rails/pull/21135) there wasn’t any discussion of the back button issue.
### System configuration

Rails 5.0.0.1
Ruby 2.3.0
",https://api.github.com/repos/rails/rails/issues/26366/timeline,,robinwhittleton,7414,MDQ6VXNlcjc0MTQ=,https://avatars.githubusercontent.com/u/7414?v=4,,https://api.github.com/users/robinwhittleton,https://github.com/robinwhittleton,https://api.github.com/users/robinwhittleton/followers,https://api.github.com/users/robinwhittleton/following{/other_user},https://api.github.com/users/robinwhittleton/gists{/gist_id},https://api.github.com/users/robinwhittleton/starred{/owner}{/repo},https://api.github.com/users/robinwhittleton/subscriptions,https://api.github.com/users/robinwhittleton/orgs,https://api.github.com/users/robinwhittleton/repos,https://api.github.com/users/robinwhittleton/events{/privacy},https://api.github.com/users/robinwhittleton/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26366/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
529,https://api.github.com/repos/rails/rails/issues/26309,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26309/labels{/name},https://api.github.com/repos/rails/rails/issues/26309/comments,https://api.github.com/repos/rails/rails/issues/26309/events,https://github.com/rails/rails/issues/26309,173673973,MDU6SXNzdWUxNzM2NzM5NzM=,26309,ActionDispatch does not understand :jsonapi mime type,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,9,2016-08-28T23:25:01Z,2016-09-26T22:15:58Z,,NONE,,"### Steps to reproduce

Any app, using rails generate new ""someapp"" --api + 
rails g scaffold ""somemodel""

w/ activemodel::serializers

attempting to back an application sending requests as ""application/vnd.api+json""- e.g. ember.js w/ JSONAPIAdapter for application adapter.
### Expected behavior

json format data in request bodies (PUT, PATCH, POST) should be exposed in standard controller ""params"".
### Actual behavior

None of the request-body data is deserialized into params.
### System configuration

rails 5.0.0.1
activepack 5.0.0.1
active_model_serializers 10.0.2
mime-types 3.1
mime-types-data 3.2016.0521

**Ruby version**:
ruby 2.3.0p0

Type ""application/vnd.api+json"" was relocated from "":json"" mime type to "":jsonapi"" type. This makes sense, as there's a lot of change from one to the other, but in actionpack/lib/action_dispatch/http/parameters.rb,  because the mime type is no longer a recognized type, the JSON within the request body is no longer exposed into the params hash.

Currently, all json-api compliant front-ends are broken as far as rails-api deserialization goes.
",https://api.github.com/repos/rails/rails/issues/26309/timeline,,Ikariusrb,15335953,MDQ6VXNlcjE1MzM1OTUz,https://avatars.githubusercontent.com/u/15335953?v=4,,https://api.github.com/users/Ikariusrb,https://github.com/Ikariusrb,https://api.github.com/users/Ikariusrb/followers,https://api.github.com/users/Ikariusrb/following{/other_user},https://api.github.com/users/Ikariusrb/gists{/gist_id},https://api.github.com/users/Ikariusrb/starred{/owner}{/repo},https://api.github.com/users/Ikariusrb/subscriptions,https://api.github.com/users/Ikariusrb/orgs,https://api.github.com/users/Ikariusrb/repos,https://api.github.com/users/Ikariusrb/events{/privacy},https://api.github.com/users/Ikariusrb/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26309/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
530,https://api.github.com/repos/rails/rails/issues/26303,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26303/labels{/name},https://api.github.com/repos/rails/rails/issues/26303/comments,https://api.github.com/repos/rails/rails/issues/26303/events,https://github.com/rails/rails/issues/26303,173621921,MDU6SXNzdWUxNzM2MjE5MjE=,26303,unable to re-insert middleware that was previously deleted with middleware.delete ,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,"[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}]",,15,2016-08-28T00:13:19Z,2021-07-02T19:56:43Z,,NONE,,"Occasionally there may be a need to change the order of the middleware stack. In Rails 4.2 I did this by deleting a given middleware and adding it back in the new desired location.  In Rails 5, it is not possible to add a previously deleted middleware, since the delete operations run after all other operations, regardless of the actual order the operations are specified. I believe this is an unintended consequence from #18994.
### Steps to reproduce
1. Delete a middleware: `config.middleware.delete SomeMiddleware`
2. Re-insert the middleware somewhere else: `config.middleware.use SomeMiddleware`
### Expected behavior

`SomeMiddleware` should be part of the middleware stack.
### Actual behavior

`SomeMiddleware` is not part of the middleware stack.
### System configuration

**Rails version**: 5.0.0.1

**Ruby version**: 2.2.5
",https://api.github.com/repos/rails/rails/issues/26303/timeline,,naw,8030877,MDQ6VXNlcjgwMzA4Nzc=,https://avatars.githubusercontent.com/u/8030877?v=4,,https://api.github.com/users/naw,https://github.com/naw,https://api.github.com/users/naw/followers,https://api.github.com/users/naw/following{/other_user},https://api.github.com/users/naw/gists{/gist_id},https://api.github.com/users/naw/starred{/owner}{/repo},https://api.github.com/users/naw/subscriptions,https://api.github.com/users/naw/orgs,https://api.github.com/users/naw/repos,https://api.github.com/users/naw/events{/privacy},https://api.github.com/users/naw/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26303/reactions,1,1,0,0,0,0,0,0,0,,,,,,,rafaelfranca,47848.0,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
531,https://api.github.com/repos/rails/rails/issues/26045,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26045/labels{/name},https://api.github.com/repos/rails/rails/issues/26045/comments,https://api.github.com/repos/rails/rails/issues/26045/events,https://github.com/rails/rails/issues/26045,169186088,MDU6SXNzdWUxNjkxODYwODg=,26045,Prevent jobs from being scheduled within transactions,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 123812746, 'node_id': 'MDU6TGFiZWwxMjM4MTI3NDY=', 'url': 'https://api.github.com/repos/rails/rails/labels/activejob', 'name': 'activejob', 'color': '5319e7', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,6,2016-08-03T17:21:16Z,2021-03-09T23:05:04Z,,MEMBER,,"This is a common source of job errors:

``` ruby
class Project < ApplicationRecord
  after_create -> { NotifyProjectParticipants.perform_later self }
end

class NotifyProjectParticipants < ApplicationJob
  def perform(project)
    # This will explode with a ActiveJob::DeserializationError,
    #  if the job runs before the INSERT transaction for the new project completes.
  end
end
```

It's insidious too. Because it'll often work in development, then fail in production, when your job queue is really fast, and your database might be bogged down.

The proper way is of course:

``` ruby
class Project < ApplicationRecord
  after_create_commit -> { NotifyProjectParticipants.perform_later self }
end
```

But that's easy to forget. So I suggest that we create a new default that disallow jobs from being scheduled within transactions. You should be able to turn that off, but it would be a better default, since it would catch this class for errors for more people before they deploy to production.
",https://api.github.com/repos/rails/rails/issues/26045/timeline,,dhh,2741,MDQ6VXNlcjI3NDE=,https://avatars.githubusercontent.com/u/2741?v=4,,https://api.github.com/users/dhh,https://github.com/dhh,https://api.github.com/users/dhh/followers,https://api.github.com/users/dhh/following{/other_user},https://api.github.com/users/dhh/gists{/gist_id},https://api.github.com/users/dhh/starred{/owner}{/repo},https://api.github.com/users/dhh/subscriptions,https://api.github.com/users/dhh/orgs,https://api.github.com/users/dhh/repos,https://api.github.com/users/dhh/events{/privacy},https://api.github.com/users/dhh/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26045/reactions,23,23,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
532,https://api.github.com/repos/rails/rails/issues/26040,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26040/labels{/name},https://api.github.com/repos/rails/rails/issues/26040/comments,https://api.github.com/repos/rails/rails/issues/26040/events,https://github.com/rails/rails/issues/26040,169128718,MDU6SXNzdWUxNjkxMjg3MTg=,26040,"When default_url_options is called within I18n.with_locale, locale is leaked to further url helpers","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 35206628, 'node_id': 'MDU6TGFiZWwzNTIwNjYyOA==', 'url': 'https://api.github.com/repos/rails/rails/labels/routing', 'name': 'routing', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2016-08-03T13:16:04Z,2020-01-14T10:45:41Z,,NONE,,"### Steps to reproduce

When `default_url_options` is implemented like in the documentation sample (http://edgeguides.rubyonrails.org/action_controller_overview.html#default-url-options). One might experience a hard to debug problem.

When calling a url helper while in a `I18n.with_locale` block, the `default_url_options`, is called at most once according to the documentation. This causes default_url_options being set with the locale from the block to be leaked outside the block, and any further called url helpers will have an unexpected default.

Such a problem could become unnoticed because an url helper could be called before this block, and only appear when url helpers called before `I18n.with_locale` are removed.

Test case gist:
https://gist.github.com/ybart/dc901bd1f9b0cb1e948d641f295542ce
### Expected behavior

locale in default_url_options should match current locale, or an exception should be thrown indicating this is not supported.
### Actual behavior

locale in default_url_options is the first called locale.
### System configuration

**Rails version**: 5.0.0

**Ruby version**: 2.3.1
",https://api.github.com/repos/rails/rails/issues/26040/timeline,,ybart,223016,MDQ6VXNlcjIyMzAxNg==,https://avatars.githubusercontent.com/u/223016?v=4,,https://api.github.com/users/ybart,https://github.com/ybart,https://api.github.com/users/ybart/followers,https://api.github.com/users/ybart/following{/other_user},https://api.github.com/users/ybart/gists{/gist_id},https://api.github.com/users/ybart/starred{/owner}{/repo},https://api.github.com/users/ybart/subscriptions,https://api.github.com/users/ybart/orgs,https://api.github.com/users/ybart/repos,https://api.github.com/users/ybart/events{/privacy},https://api.github.com/users/ybart/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26040/reactions,2,1,0,0,0,1,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
533,https://api.github.com/repos/rails/rails/issues/26006,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/26006/labels{/name},https://api.github.com/repos/rails/rails/issues/26006/comments,https://api.github.com/repos/rails/rails/issues/26006/events,https://github.com/rails/rails/issues/26006,168515149,MDU6SXNzdWUxNjg1MTUxNDk=,26006,Reordering issue in find_in_batches and find_each,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2016-07-31T12:14:58Z,2020-10-14T13:31:36Z,,NONE,,"### Steps to reproduce

User.order(:updated_at).find_in_batches(start: 2000, finish: 5000, batch_size: 500) { |batch| do_something }
### Expected behavior

The records must have been ordered by column 'updated_at'.

Expected Queries:

``` ruby
SELECT  `users`.* FROM `users` ORDER BY `users`.`updated_at` ASC LIMIT 500 OFFSET 2000
SELECT  `users`.* FROM `users` ORDER BY `users`.`updated_at` ASC LIMIT 500 OFFSET 2500
SELECT  `users`.* FROM `users` ORDER BY `users`.`updated_at` ASC LIMIT 500 OFFSET 3000
SELECT  `users`.* FROM `users` ORDER BY `users`.`updated_at` ASC LIMIT 500 OFFSET 3500
SELECT  `users`.* FROM `users` ORDER BY `users`.`updated_at` ASC LIMIT 500 OFFSET 4000
SELECT  `users`.* FROM `users` ORDER BY `users`.`updated_at` ASC LIMIT 500 OFFSET 4500
```
### Actual behavior

The records are always order by the primary key(id by default) no matter how user wants them to be ordered.

Queries:

``` ruby
SELECT  `users`.* FROM `users` WHERE (`users`.`id` >= 2000) AND (`users`.`id` <= 5000) ORDER BY `users`.`id` ASC LIMIT 500
SELECT  `users`.* FROM `users` WHERE (`users`.`id` >= 2000) AND (`users`.`id` <= 5000) AND (`users`.`id` > 2499) ORDER BY `users`.`id` ASC LIMIT 500
SELECT  `users`.* FROM `users` WHERE (`users`.`id` >= 2000) AND (`users`.`id` <= 5000) AND (`users`.`id` > 2999) ORDER BY `users`.`id` ASC LIMIT 500
SELECT  `users`.* FROM `users` WHERE (`users`.`id` >= 2000) AND (`users`.`id` <= 5000) AND (`users`.`id` > 3499) ORDER BY `users`.`id` ASC LIMIT 500
SELECT  `users`.* FROM `users` WHERE (`users`.`id` >= 2000) AND (`users`.`id` <= 5000) AND (`users`.`id` > 3999) ORDER BY `users`.`id` ASC LIMIT 500
SELECT  `users`.* FROM `users` WHERE (`users`.`id` >= 2000) AND (`users`.`id` <= 5000) AND (`users`.`id` > 4499) ORDER BY `users`.`id` ASC LIMIT 500
SELECT  `users`.* FROM `users` WHERE (`users`.`id` >= 2000) AND (`users`.`id` <= 5000) AND (`users`.`id` > 4999) ORDER BY `users`.`id` ASC LIMIT 500
```

Rails Version: `Rails 5.1.0.alpha`
Ruby Version: 2.2.3

I've customized the method `in_batches` which is called from both `find_in_batches` and `find_each` for now to solve my problem. 

Also I've attached a PR having the permanent fix for this issue. Please review it and let me know if any change is required.
",https://api.github.com/repos/rails/rails/issues/26006/timeline,,vinay-mittal,12937284,MDQ6VXNlcjEyOTM3Mjg0,https://avatars.githubusercontent.com/u/12937284?v=4,,https://api.github.com/users/vinay-mittal,https://github.com/vinay-mittal,https://api.github.com/users/vinay-mittal/followers,https://api.github.com/users/vinay-mittal/following{/other_user},https://api.github.com/users/vinay-mittal/gists{/gist_id},https://api.github.com/users/vinay-mittal/starred{/owner}{/repo},https://api.github.com/users/vinay-mittal/subscriptions,https://api.github.com/users/vinay-mittal/orgs,https://api.github.com/users/vinay-mittal/repos,https://api.github.com/users/vinay-mittal/events{/privacy},https://api.github.com/users/vinay-mittal/received_events,User,False,https://api.github.com/repos/rails/rails/issues/26006/reactions,8,8,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
534,https://api.github.com/repos/rails/rails/issues/25718,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/25718/labels{/name},https://api.github.com/repos/rails/rails/issues/25718/comments,https://api.github.com/repos/rails/rails/issues/25718/events,https://github.com/rails/rails/issues/25718,164095626,MDU6SXNzdWUxNjQwOTU2MjY=,25718,has_many :through **validate=>false** not being obeyed during association update,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,16,2016-07-06T14:53:47Z,2021-08-30T13:29:53Z,,NONE,,"### Steps to reproduce

Bug report script attached
### Expected behavior

As per docs, when setting the option has_many :validate => false, the associated objects will not be validated when saving the object.

4.1.2.11 :validate

If you set the :validate option to true, then associated objects will be validated whenever you save this object. By default, this is false: associated objects will not be validated when this object is saved.
### Actual behavior

When **updating** the association, using #role_ids=, the associated object is being validated.
### System configuration

**Rails version**: 5.0.0

**Ruby version**: 2.3.1

https://gist.github.com/marcalc/a370674c040bd2122da729b904557c08#file-bug-report-rb

```

begin
  require 'bundler/inline'
rescue LoadError => e
  $stderr.puts 'Bundler version 1.10 or later is required. Please update your Bundler'
  raise e
end

gemfile(true) do
  source 'https://rubygems.org'
  # Activate the gem you are reporting the issue against.
  gem 'activerecord', '5.0.0'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

# Ensure backward compatibility with Minitest 4
Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table ""roles"", force: :cascade do |t|
    t.string   ""name""
    t.datetime ""created_at"", null: false
    t.datetime ""updated_at"", null: false
  end

  create_table ""user_roles"", force: :cascade do |t|
    t.integer  ""user_id""
    t.integer  ""role_id""
    t.datetime ""created_at"", null: false
    t.datetime ""updated_at"", null: false
    t.index [""role_id""], name: ""index_user_roles_on_role_id""
    t.index [""user_id""], name: ""index_user_roles_on_user_id""
  end

  create_table ""users"", force: :cascade do |t|
    t.string   ""name""
    t.datetime ""created_at"", null: false
    t.datetime ""updated_at"", null: false
  end
end

class Role < ActiveRecord::Base
  validates_presence_of :name
end

class User < ActiveRecord::Base
  has_many :user_roles
  has_many :roles, through: :user_roles, validate: false
end

class UserRole < ActiveRecord::Base
  belongs_to :user
  belongs_to :role
end

class BugTest < Minitest::Test
  def test_association_stuff
    Role.new(name: nil).save(validate: false) # deliberately creating an invalid nameless role

    u = User.create!(role_ids: [""1""]) # OK
    u.update!(role_ids: nil) # OK
    u.update!(role_ids: [""1""]) # FAILS
  end
end

```
",https://api.github.com/repos/rails/rails/issues/25718/timeline,,marcalc,194899,MDQ6VXNlcjE5NDg5OQ==,https://avatars.githubusercontent.com/u/194899?v=4,,https://api.github.com/users/marcalc,https://github.com/marcalc,https://api.github.com/users/marcalc/followers,https://api.github.com/users/marcalc/following{/other_user},https://api.github.com/users/marcalc/gists{/gist_id},https://api.github.com/users/marcalc/starred{/owner}{/repo},https://api.github.com/users/marcalc/subscriptions,https://api.github.com/users/marcalc/orgs,https://api.github.com/users/marcalc/repos,https://api.github.com/users/marcalc/events{/privacy},https://api.github.com/users/marcalc/received_events,User,False,https://api.github.com/repos/rails/rails/issues/25718/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
535,https://api.github.com/repos/rails/rails/issues/25333,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/25333/labels{/name},https://api.github.com/repos/rails/rails/issues/25333/comments,https://api.github.com/repos/rails/rails/issues/25333/events,https://github.com/rails/rails/issues/25333,159325602,MDU6SXNzdWUxNTkzMjU2MDI=,25333,ActionCable: consider deferring `transmit`s until after `confirm_subscription`,"[{'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,13,2016-06-09T04:23:23Z,2021-10-06T14:24:53Z,,CONTRIBUTOR,,"### Steps to reproduce

Create an ActionCable channel that transmits data within `subscribed`, which seems like a reasonable place to send an initial payload upon subscription (e.g. if you're subscribing to a `TweetsChannel`, this could send the most recent 15 tweets).

```
class MyChannel < ApplicationCable::Channel
  def subscribed
    transmit({ foo: 123 })
  end
end
```
### Expected behavior

The `confirm_subscription` websocket event should arrive before the transmitted payload.
### Actual behavior

The payload is sent _before_ the `confirm_subscription` message is sent. Given that the above pattern feels very natural and correct, it seems like Rails should internally defer transmits until the `confirm_subscription` is sent since the present behavior is confusing and it complicates the logic on the client side of things (FYI I'm integrating with a JS app).
### System configuration

**Rails version**: 5.0.0.rc1

**Ruby version**: 2.3.0
",https://api.github.com/repos/rails/rails/issues/25333/timeline,,machty,81818,MDQ6VXNlcjgxODE4,https://avatars.githubusercontent.com/u/81818?v=4,,https://api.github.com/users/machty,https://github.com/machty,https://api.github.com/users/machty/followers,https://api.github.com/users/machty/following{/other_user},https://api.github.com/users/machty/gists{/gist_id},https://api.github.com/users/machty/starred{/owner}{/repo},https://api.github.com/users/machty/subscriptions,https://api.github.com/users/machty/orgs,https://api.github.com/users/machty/repos,https://api.github.com/users/machty/events{/privacy},https://api.github.com/users/machty/received_events,User,False,https://api.github.com/repos/rails/rails/issues/25333/reactions,9,9,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
536,https://api.github.com/repos/rails/rails/issues/25106,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/25106/labels{/name},https://api.github.com/repos/rails/rails/issues/25106/comments,https://api.github.com/repos/rails/rails/issues/25106/events,https://github.com/rails/rails/issues/25106,156129607,MDU6SXNzdWUxNTYxMjk2MDc=,25106,Setting self.response_body = nil no longer prevents DoubleRenderError,"[{'id': 107186, 'node_id': 'MDU6TGFiZWwxMDcxODY=', 'url': 'https://api.github.com/repos/rails/rails/labels/regression', 'name': 'regression', 'color': 'e10c02', 'default': False, 'description': None}, {'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,15,2016-05-22T01:17:53Z,2021-05-11T07:28:59Z,,CONTRIBUTOR,,"### Steps to reproduce

I am attempting to prevent a `AbstractController::DoubleRenderError` in a controller by setting `self.response_body = nil` before a second call to `render`.  The reason that multiple renders occur is that I have `after_action` callbacks that call `render` after the action itself has already rendered its response.

It is my understanding that `self.response_body = nil` should drop the previously-rendered body to allow a subsequent render call to succeed without causing a DoubleRenderError.

This works in **Rails 4.2.6** but it no longer appears prevent double rendering exceptions in Rails 5+ (including current master).

This simplified example shows a scenario that properly renders 'something else' in Rails 4.2.6 but fails in 5.0.0.rc1 (and master):

``` ruby
# Rails 4.2.6
def should_prevent_double_render
  render json: { foo: 'something' }
  self.response_body = nil
  performed? # => false
  render json: { foo: 'something else' }
end

# Rails 5.0.0.rc1
def should_prevent_double_render
  render json: { foo: 'something' }
  self.response_body = nil
  performed? # => [""{\""foo\"":\""something\""}""]
  render json: { foo: 'something else' }
  # ... AbstractController::DoubleRenderError is raised
end
```

Complete gist with tests replicating this issue is available here: https://gist.github.com/kdough/c797c25088331ffc275bb2aa6159bde9
### Expected behavior

Setting `self.response_body = nil` before a subsequent call to `render` should drop a previously-rendered response body.
### Actual behavior

As of **Rails 5+**, a `AbstractController::DoubleRenderError` exception is raised when a second call to `render` is made.  The previously-rendered content remains in the result of `performed?`

In **Rails 4.2.6**, the second call to `render` succeeds as expected.
### System configuration
- **Working Setup**:
  - **Rails version**:  4.2.6
  - **Ruby version**:  2.3.1p112
- **Broken Setup**:
  - **Rails version**:  5.0.0.rc1
  - **Ruby version**:  2.3.1p112
",https://api.github.com/repos/rails/rails/issues/25106/timeline,,kdough,15710,MDQ6VXNlcjE1NzEw,https://avatars.githubusercontent.com/u/15710?v=4,,https://api.github.com/users/kdough,https://github.com/kdough,https://api.github.com/users/kdough/followers,https://api.github.com/users/kdough/following{/other_user},https://api.github.com/users/kdough/gists{/gist_id},https://api.github.com/users/kdough/starred{/owner}{/repo},https://api.github.com/users/kdough/subscriptions,https://api.github.com/users/kdough/orgs,https://api.github.com/users/kdough/repos,https://api.github.com/users/kdough/events{/privacy},https://api.github.com/users/kdough/received_events,User,False,https://api.github.com/repos/rails/rails/issues/25106/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
537,https://api.github.com/repos/rails/rails/issues/25088,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/25088/labels{/name},https://api.github.com/repos/rails/rails/issues/25088/comments,https://api.github.com/repos/rails/rails/issues/25088/events,https://github.com/rails/rails/issues/25088,156017631,MDU6SXNzdWUxNTYwMTc2MzE=,25088,[ActionCable] No way to filter out any sensitive data which may be passed as an argument to the remote procedure over ws protocol..,"[{'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,[],,12,2016-05-20T17:57:07Z,2022-03-06T10:28:05Z,,NONE,,"### Steps to reproduce

Just followed the action cable demo from DHH on [rails homepage](http://rubyonrails.org/).

You would notice that whenever the RoomChannel#speak is invoked over websocket protocol, the server logs show the arguments which are passed.  

```
RoomChannel#speak({""message""=>""test""})
```

For HTTP requests, we have `filter_parameters` to filter out any sensitive data from the logs.
However, for these RPCs, I could not find any way to filter out any sensitive data which may be passed as an argument to the remote procedure.
### Expected behavior

I expected some mechanism to filter out logs for any arbitrary arguments which are passed over ws protocol.
### Actual behavior

I could not find a way to filter out logs for data transmitted over ws protocol.
**Please advise** if this behavior is on purpose.

Below is the related code which I am referring to

``` ruby
#actioncable-5.0.0.rc1/lib/action_cable/channel/base.rb
def dispatch_action(action, data)
  # What if we do not want this to be logged.
  logger.info action_signature(action, data)

  if method(action).arity == 1
    public_send action, data
  else
    public_send action
  end
end

def action_signature(action, data)
  ""#{self.class.name}##{action}"".tap do |signature|
    if (arguments = data.except('action')).any?
      signature << ""(#{arguments.inspect})""
    end
  end
end
```
### System configuration

**Rails version**: 5.0.0.rc1

**Ruby version**: ruby 2.2.4p230 (2015-12-16 revision 53155) [x86_64-linux]
",https://api.github.com/repos/rails/rails/issues/25088/timeline,,Anuragjain89,2606564,MDQ6VXNlcjI2MDY1NjQ=,https://avatars.githubusercontent.com/u/2606564?v=4,,https://api.github.com/users/Anuragjain89,https://github.com/Anuragjain89,https://api.github.com/users/Anuragjain89/followers,https://api.github.com/users/Anuragjain89/following{/other_user},https://api.github.com/users/Anuragjain89/gists{/gist_id},https://api.github.com/users/Anuragjain89/starred{/owner}{/repo},https://api.github.com/users/Anuragjain89/subscriptions,https://api.github.com/users/Anuragjain89/orgs,https://api.github.com/users/Anuragjain89/repos,https://api.github.com/users/Anuragjain89/events{/privacy},https://api.github.com/users/Anuragjain89/received_events,User,False,https://api.github.com/repos/rails/rails/issues/25088/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
538,https://api.github.com/repos/rails/rails/issues/24875,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24875/labels{/name},https://api.github.com/repos/rails/rails/issues/24875/comments,https://api.github.com/repos/rails/rails/issues/24875/events,https://github.com/rails/rails/issues/24875,153361847,MDU6SXNzdWUxNTMzNjE4NDc=,24875,Cable: Should error on double-subscribe,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 257468118, 'node_id': 'MDU6TGFiZWwyNTc0NjgxMTg=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20work', 'name': 'needs work', 'color': '000000', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,"[{'login': 'jeremy', 'id': 199, 'node_id': 'MDQ6VXNlcjE5OQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/199?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jeremy', 'html_url': 'https://github.com/jeremy', 'followers_url': 'https://api.github.com/users/jeremy/followers', 'following_url': 'https://api.github.com/users/jeremy/following{/other_user}', 'gists_url': 'https://api.github.com/users/jeremy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jeremy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jeremy/subscriptions', 'organizations_url': 'https://api.github.com/users/jeremy/orgs', 'repos_url': 'https://api.github.com/users/jeremy/repos', 'events_url': 'https://api.github.com/users/jeremy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jeremy/received_events', 'type': 'User', 'site_admin': False}]",,5,2016-05-06T01:41:55Z,2016-05-18T19:26:41Z,,MEMBER,,"When a client subscribes to a channel that it's already subscribed to, the server no-ops. Subscribe hooks and callbacks don't run.

When is this ever normal? The only case is if the client thinks it unsubscribed from a channel but the server didn't get the memo.

In these cases, we'd be better off treating a duplicate subscribe as an unsubscribe + subscribe from the server's perspective.

Pragmatically, we should gauge whether this is actually desirable behavior. It may be better for the server to error on a duplicate subscription attempt and delegate the decisionmaking about how to proceed back to the client.
",https://api.github.com/repos/rails/rails/issues/24875/timeline,,jeremy,199,MDQ6VXNlcjE5OQ==,https://avatars.githubusercontent.com/u/199?v=4,,https://api.github.com/users/jeremy,https://github.com/jeremy,https://api.github.com/users/jeremy/followers,https://api.github.com/users/jeremy/following{/other_user},https://api.github.com/users/jeremy/gists{/gist_id},https://api.github.com/users/jeremy/starred{/owner}{/repo},https://api.github.com/users/jeremy/subscriptions,https://api.github.com/users/jeremy/orgs,https://api.github.com/users/jeremy/repos,https://api.github.com/users/jeremy/events{/privacy},https://api.github.com/users/jeremy/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24875/reactions,0,0,0,0,0,0,0,0,0,,,,,,,jeremy,199.0,MDQ6VXNlcjE5OQ==,https://avatars.githubusercontent.com/u/199?v=4,,https://api.github.com/users/jeremy,https://github.com/jeremy,https://api.github.com/users/jeremy/followers,https://api.github.com/users/jeremy/following{/other_user},https://api.github.com/users/jeremy/gists{/gist_id},https://api.github.com/users/jeremy/starred{/owner}{/repo},https://api.github.com/users/jeremy/subscriptions,https://api.github.com/users/jeremy/orgs,https://api.github.com/users/jeremy/repos,https://api.github.com/users/jeremy/events{/privacy},https://api.github.com/users/jeremy/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
539,https://api.github.com/repos/rails/rails/issues/24874,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24874/labels{/name},https://api.github.com/repos/rails/rails/issues/24874/comments,https://api.github.com/repos/rails/rails/issues/24874/events,https://github.com/rails/rails/issues/24874,153361365,MDU6SXNzdWUxNTMzNjEzNjU=,24874,Cable: Robust unsubscribe,"[{'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 257468118, 'node_id': 'MDU6TGFiZWwyNTc0NjgxMTg=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20work', 'name': 'needs work', 'color': '000000', 'default': False, 'description': None}, {'id': 300028327, 'node_id': 'MDU6TGFiZWwzMDAwMjgzMjc=', 'url': 'https://api.github.com/repos/rails/rails/labels/actioncable', 'name': 'actioncable', 'color': 'bfdadc', 'default': False, 'description': None}]",open,False,,"[{'login': 'jeremy', 'id': 199, 'node_id': 'MDQ6VXNlcjE5OQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/199?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/jeremy', 'html_url': 'https://github.com/jeremy', 'followers_url': 'https://api.github.com/users/jeremy/followers', 'following_url': 'https://api.github.com/users/jeremy/following{/other_user}', 'gists_url': 'https://api.github.com/users/jeremy/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/jeremy/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/jeremy/subscriptions', 'organizations_url': 'https://api.github.com/users/jeremy/orgs', 'repos_url': 'https://api.github.com/users/jeremy/repos', 'events_url': 'https://api.github.com/users/jeremy/events{/privacy}', 'received_events_url': 'https://api.github.com/users/jeremy/received_events', 'type': 'User', 'site_admin': False}]",,8,2016-05-06T01:38:30Z,2018-10-03T16:20:10Z,,MEMBER,,"If an error occur for some reason while removing a subscription, the exception is swallowed and the connection may left in an inconsistent state, e.g. still be subscribed to the channel but no longer streaming.

`ActionCable::Connection::Subscriptions#remove_subscription` must give a much stronger guarantee that unsubscribing absolutely closes the channel and removes the subscription if errors occur.

Unsubscribing from a channel doesn't give any acknowledgement that it succeeded, either, so a client may think _it's_ disconnected when the server doesn't. If the client _resubscribes_, the server already has a live channel (possibly in an inconsistent state), so it _does nothing_.
",https://api.github.com/repos/rails/rails/issues/24874/timeline,,jeremy,199,MDQ6VXNlcjE5OQ==,https://avatars.githubusercontent.com/u/199?v=4,,https://api.github.com/users/jeremy,https://github.com/jeremy,https://api.github.com/users/jeremy/followers,https://api.github.com/users/jeremy/following{/other_user},https://api.github.com/users/jeremy/gists{/gist_id},https://api.github.com/users/jeremy/starred{/owner}{/repo},https://api.github.com/users/jeremy/subscriptions,https://api.github.com/users/jeremy/orgs,https://api.github.com/users/jeremy/repos,https://api.github.com/users/jeremy/events{/privacy},https://api.github.com/users/jeremy/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24874/reactions,0,0,0,0,0,0,0,0,0,,,,,,,jeremy,199.0,MDQ6VXNlcjE5OQ==,https://avatars.githubusercontent.com/u/199?v=4,,https://api.github.com/users/jeremy,https://github.com/jeremy,https://api.github.com/users/jeremy/followers,https://api.github.com/users/jeremy/following{/other_user},https://api.github.com/users/jeremy/gists{/gist_id},https://api.github.com/users/jeremy/starred{/owner}{/repo},https://api.github.com/users/jeremy/subscriptions,https://api.github.com/users/jeremy/orgs,https://api.github.com/users/jeremy/repos,https://api.github.com/users/jeremy/events{/privacy},https://api.github.com/users/jeremy/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
540,https://api.github.com/repos/rails/rails/issues/24778,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24778/labels{/name},https://api.github.com/repos/rails/rails/issues/24778/comments,https://api.github.com/repos/rails/rails/issues/24778/events,https://github.com/rails/rails/issues/24778,151732450,MDU6SXNzdWUxNTE3MzI0NTA=,24778,code in test_case messes up encoding of hashes in routes if that hash is set as a defaults option on the route.,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2016-04-28T20:12:56Z,2016-04-28T21:45:47Z,,CONTRIBUTOR,,"### Steps to reproduce

in routes.rb

``` ruby
  get '/reports/daily' => 'reports#custom', as: :daily_reports, defaults: {group_by: 'date', template_report: true, filters: { archived: true, show_notes: true }
```

in controller spec

``` ruby
        it 'should return filter[:organizations] as array' do
          get  :custom, {date: ""2013-05-01"", date_end: ""2013-05-03"",
                               filters: {
                                   show_notes: true,
                                   organizations: [@organization.id],
                                   projects: [@project_1.id],
                                   users: [@user.id]
                               } }
          expect(assigns(:filters)[:organizations]).to be_an Array
        end
```
### Expected behavior

The test to pass
### Actual behavior

The code blows up in our controller code when params[:filters][_anything_] is accessed..
Reason?  the params[:filters] is set to a string of ""show_notes=1&organization[0]=1&projects[0]=1&users[0]=1""
Why? Because of code in action_controller/test_case.rb runs the parameter through to_param if it seems to be a core param of the route. (which the ""defaults"" are being treated as such)
https://github.com/rails/rails/blob/4-2-stable/actionpack/lib/action_controller/test_case.rb#L227
### Additional notes

This did not occur with Rails 3.2.x but was introduced sometime during the 4.x development cycle.
the controller code works perfectly fine.. it is only the tests that blow up incorrectly.   So what we had to do to workaround this issue was remove the ""filters"" default from our routes and add extra logic in our controller to setup defaults based on routes. (which was not ideal)
### System configuration

**Rails version**:
4.2.5.1
**Ruby version**:
2.1.5
",https://api.github.com/repos/rails/rails/issues/24778/timeline,,urkle,101123,MDQ6VXNlcjEwMTEyMw==,https://avatars.githubusercontent.com/u/101123?v=4,,https://api.github.com/users/urkle,https://github.com/urkle,https://api.github.com/users/urkle/followers,https://api.github.com/users/urkle/following{/other_user},https://api.github.com/users/urkle/gists{/gist_id},https://api.github.com/users/urkle/starred{/owner}{/repo},https://api.github.com/users/urkle/subscriptions,https://api.github.com/users/urkle/orgs,https://api.github.com/users/urkle/repos,https://api.github.com/users/urkle/events{/privacy},https://api.github.com/users/urkle/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24778/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
541,https://api.github.com/repos/rails/rails/issues/24573,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24573/labels{/name},https://api.github.com/repos/rails/rails/issues/24573/comments,https://api.github.com/repos/rails/rails/issues/24573/events,https://github.com/rails/rails/issues/24573,148811257,MDU6SXNzdWUxNDg4MTEyNTc=,24573,ActionView 'form cannot contain nil' after rails 5 scaffold generation,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,14,2016-04-16T03:01:36Z,2018-01-19T14:33:13Z,,NONE,,"### Steps to reproduce

rails g scaffold user email:uniq password:digest
rails g scaffold image --api name:string version:string cost:float public:bool memory:integer
rails g scaffold container --api name:string image_id:integer user_id:integer memory:integer
### Expected behavior

Not error on image#new
### Actual behavior

```
_form.html.erb where line #1 raised:

First argument in form cannot contain nil or be empty
Extracted source (around line #1):

<%= form_for(container) do |f| %>
  <% if container.errors.any? %>
    <div id=""error_explanation"">
      <h2><%= pluralize(container.errors.count, ""error"") %> prohibited this container from being saved:</h2>

      <ul>

Trace of template inclusion: app/views/containers/new.html.erb
```
### System configuration

**Rails version**: Rails 5.0.0.beta3
**Ruby version**: 2.3.0p0
",https://api.github.com/repos/rails/rails/issues/24573/timeline,,kallisti5,100110,MDQ6VXNlcjEwMDExMA==,https://avatars.githubusercontent.com/u/100110?v=4,,https://api.github.com/users/kallisti5,https://github.com/kallisti5,https://api.github.com/users/kallisti5/followers,https://api.github.com/users/kallisti5/following{/other_user},https://api.github.com/users/kallisti5/gists{/gist_id},https://api.github.com/users/kallisti5/starred{/owner}{/repo},https://api.github.com/users/kallisti5/subscriptions,https://api.github.com/users/kallisti5/orgs,https://api.github.com/users/kallisti5/repos,https://api.github.com/users/kallisti5/events{/privacy},https://api.github.com/users/kallisti5/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24573/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,https://api.github.com/repos/rails/rails/milestones/53,https://github.com/rails/rails/milestone/53,https://api.github.com/repos/rails/rails/milestones/53/labels,1730927.0,MDk6TWlsZXN0b25lMTczMDkyNw==,53.0,5.0.x,,jeremy,199.0,MDQ6VXNlcjE5OQ==,https://avatars.githubusercontent.com/u/199?v=4,,https://api.github.com/users/jeremy,https://github.com/jeremy,https://api.github.com/users/jeremy/followers,https://api.github.com/users/jeremy/following{/other_user},https://api.github.com/users/jeremy/gists{/gist_id},https://api.github.com/users/jeremy/starred{/owner}{/repo},https://api.github.com/users/jeremy/subscriptions,https://api.github.com/users/jeremy/orgs,https://api.github.com/users/jeremy/repos,https://api.github.com/users/jeremy/events{/privacy},https://api.github.com/users/jeremy/received_events,User,False,1.0,61.0,closed,2016-04-26T02:02:53Z,2021-05-06T22:21:30Z,,2017-05-01T10:41:43Z
542,https://api.github.com/repos/rails/rails/issues/24528,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24528/labels{/name},https://api.github.com/repos/rails/rails/issues/24528/comments,https://api.github.com/repos/rails/rails/issues/24528/events,https://github.com/rails/rails/issues/24528,147871086,MDU6SXNzdWUxNDc4NzEwODY=,24528,ActiveRecord::Base.table_name_prefix / suffix schema dumper allows for conflicts with unprefixed tables,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2016-04-12T20:59:47Z,2016-04-13T20:49:36Z,,CONTRIBUTOR,,"### Steps to reproduce

When ActiveRecord::Base.table_name_prefix/suffix are used the schema dumper intentionally avoids printing the prefix and suffix in the schema dump. This means that if the database also includes tables of the same name sans prefix/suffix, there will be a conflict between them when attempting to set up the test database, etc.
### Expected behavior

Given a table ""accounts"" and a table ""my_app_accounts"", with a table_name_prefix of ""my_app_"", I expect the schema dumper to either:

1) Output the tables with non-conflicting naming, e.g. their actual table names, or with adjusted names + some option signifying the table is prefixed/suffixed and therefore enabling the full table name to be generated.
2) Not output the non-prefixed/suffixed table. This would be consistent with a general view of ActiveRecord prefixing that assumes only the prefixed/suffixed tables are relevant to ActiveRecord.

I tend to think that 2) is not a good assumption (as it's possible for other tables to be relied on indirectly, e.g. through explicit statements) so I propose some version of 1) be adopted.
### Actual behavior

Given a table ""accounts"" and a table ""my_app_accounts"", with a table_name_prefix of ""my_app_"", the schema dumper will output two tables named ""accounts"".
### System configuration

**Rails version**: 5.0.0.beta3

**Ruby version**: 2.3.0p0 (2015-12-25 revision 53290) [x86_64-darwin15]
",https://api.github.com/repos/rails/rails/issues/24528/timeline,,Empact,5470,MDQ6VXNlcjU0NzA=,https://avatars.githubusercontent.com/u/5470?v=4,,https://api.github.com/users/Empact,https://github.com/Empact,https://api.github.com/users/Empact/followers,https://api.github.com/users/Empact/following{/other_user},https://api.github.com/users/Empact/gists{/gist_id},https://api.github.com/users/Empact/starred{/owner}{/repo},https://api.github.com/users/Empact/subscriptions,https://api.github.com/users/Empact/orgs,https://api.github.com/users/Empact/repos,https://api.github.com/users/Empact/events{/privacy},https://api.github.com/users/Empact/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24528/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
543,https://api.github.com/repos/rails/rails/issues/24527,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24527/labels{/name},https://api.github.com/repos/rails/rails/issues/24527/comments,https://api.github.com/repos/rails/rails/issues/24527/events,https://github.com/rails/rails/issues/24527,147850982,MDU6SXNzdWUxNDc4NTA5ODI=,24527,has_many through validation error when foreign_key is specified,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2016-04-12T19:32:50Z,2016-05-03T19:24:37Z,,CONTRIBUTOR,,"### Steps to reproduce

[Gist](https://gist.github.com/dkniffin/e1645ab3f94dabeda7ad1096c96c8f07)

When I create some models with a `has_many :through` association, with a foreign_key, and I add validation on the join table, I get a validation failure. It appears to me that the issue is AR is trying to save the join model (ProductCategory) before the parent model (Product).

``` ruby
class Product < ActiveRecord::Base
  has_many :product_categories, foreign_key: :product_id
  has_many :categories, through: :product_categories
end

class Category < ActiveRecord::Base
  has_many :product_categories, dependent: :destroy
  has_many :products, through: :product_categories
end

class ProductCategory < ActiveRecord::Base
  belongs_to :product, foreign_key: 'product_id', inverse_of: :product_categories
  belongs_to :category, inverse_of: :product_categories

  validates :product, :category, presence: true
end
```

If it helps, I've also uploaded a bare-bones rails project that also reproduces the issue: https://github.com/dkniffin/rails_bug_has_many_through_with_foreign_key
### Expected behavior

The model should save succesfully.
### Actual behavior

It errors with ""Product categories is invalid""
### System configuration

**Rails version**:  Rails 4.2.6

**Ruby version**: ruby 2.2.3p173 (2015-08-18 revision 51636) [x86_64-darwin14]
",https://api.github.com/repos/rails/rails/issues/24527/timeline,,dkniffin,1680080,MDQ6VXNlcjE2ODAwODA=,https://avatars.githubusercontent.com/u/1680080?v=4,,https://api.github.com/users/dkniffin,https://github.com/dkniffin,https://api.github.com/users/dkniffin/followers,https://api.github.com/users/dkniffin/following{/other_user},https://api.github.com/users/dkniffin/gists{/gist_id},https://api.github.com/users/dkniffin/starred{/owner}{/repo},https://api.github.com/users/dkniffin/subscriptions,https://api.github.com/users/dkniffin/orgs,https://api.github.com/users/dkniffin/repos,https://api.github.com/users/dkniffin/events{/privacy},https://api.github.com/users/dkniffin/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24527/reactions,5,5,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
544,https://api.github.com/repos/rails/rails/issues/24390,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24390/labels{/name},https://api.github.com/repos/rails/rails/issues/24390/comments,https://api.github.com/repos/rails/rails/issues/24390/events,https://github.com/rails/rails/issues/24390,145144564,MDU6SXNzdWUxNDUxNDQ1NjQ=,24390,index_errors does not consider indexes of correct existing sub records,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,23,2016-04-01T10:29:10Z,2022-02-11T17:23:53Z,,NONE,,"### Steps to reproduce

Updating existing record with accept_nested_attributes_for with existing sub-records. (Order - Entries), with index_errors: true.
So, i have existing Order, with 2 existing entries, and try to update it with nested attributes
### Expected behavior

Same indexes all times
### Actual behavior

If im not changing entry_1, and change entry_2(with incorrect attributes) i got this response:

```
entries[0].title: ['some errors']
```

If im changing entry_1(correct attributes) and change entry_2(incorrect attributes) i got response

```
entries[1].title: ['some errors']
```
### System configuration

Rails 5.0.0.beta3
ruby 2.2.3
",https://api.github.com/repos/rails/rails/issues/24390/timeline,,justedd,8008554,MDQ6VXNlcjgwMDg1NTQ=,https://avatars.githubusercontent.com/u/8008554?v=4,,https://api.github.com/users/justedd,https://github.com/justedd,https://api.github.com/users/justedd/followers,https://api.github.com/users/justedd/following{/other_user},https://api.github.com/users/justedd/gists{/gist_id},https://api.github.com/users/justedd/starred{/owner}{/repo},https://api.github.com/users/justedd/subscriptions,https://api.github.com/users/justedd/orgs,https://api.github.com/users/justedd/repos,https://api.github.com/users/justedd/events{/privacy},https://api.github.com/users/justedd/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24390/reactions,3,3,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
545,https://api.github.com/repos/rails/rails/issues/24301,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/24301/labels{/name},https://api.github.com/repos/rails/rails/issues/24301/comments,https://api.github.com/repos/rails/rails/issues/24301/events,https://github.com/rails/rails/issues/24301,143275845,MDU6SXNzdWUxNDMyNzU4NDU=,24301,Rails ActiveRecord::RecordInvalid exception not raised in after_create of association,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,11,2016-03-24T15:22:21Z,2017-08-31T14:14:53Z,,NONE,,"### Steps to reproduce

I have 3 simple tables that are built with the following lines:

```
rails g model receipt
rails g model receipt_item receipt:references
rails g model transaction transacted_at:datetime
```

and the models look like this:

```
class Receipt < ActiveRecord::Base
  has_many :receipt_items
end

class ReceiptItem < ActiveRecord::Base
  after_create :create_transaction
  belongs_to :receipt
private
  def create_transaction
    Transaction.new.save!
  end
end

class Transaction < ActiveRecord::Base
  validates :transacted_at, :presence => true
end
```
### Expected behaviour

So every time a new ReceiptItem is created, it triggers the after_create callback to create a new Transaction object using save!. But because Transaction requires that the column transacted_at to be present, Transaction.new.save! should raise an ActiveRecord::RecordInvalid every time, I assumed.
### Actual behaviour

So then I created 3 tests:

```
test ""creating an invalid transaction"" do
    assert_raises ActiveRecord::RecordInvalid do
        Transaction.new.save!
    end
end

test ""creating invalid transaction in after_create"" do
    assert_raises ActiveRecord::RecordInvalid do
        ReceiptItem.new.save!
    end
end

test ""creating invalid transaction in after_create of associated model"" do
    assert_raises ActiveRecord::RecordInvalid do
        r = Receipt.new
        i = r.receipt_items.new
        r.save!
    end
end
```

The first two tests passed as expected. The third test, however, failed because the exception was never raised. As a matter of fact, if I add the following lines after the 'r.save!' line:

```
r.reload
p r
p r.receipt_items
```

I could see that the Receipt and the ReceiptItem have been created successfully.

```
#<Receipt id: 980190963, created_at: ""2016-03-24 14:39:43"", updated_at: ""2016-03-24 14:39:43"">
#<ActiveRecord::Associations::CollectionProxy [#<ReceiptItem id: 980190964, receipt_id: 980190963, created_at: ""2016-03-24 14:39:43"", updated_at: ""2016-03-24 14:39:43"">]>
```

Furthermore, if I replaced

`assert_raises ActiveRecord::RecordInvalid do`
with
`assert_difference ""Transaction.count"", +1 do`

The test also failed and I confirmed that the Receipt and the ReceiptItems were created but the Transaction wasn't. That means the creation of the Transaction failed, but was silently ignored, even though I used 'save!' as opposed to just 'save'.

Is this the intended behaviour, or is this a bug?
### System configuration

**Rails version**: Tried this in Rails 4.0.13 and 4.2.0

**Ruby version**: 2.1.2p95 and  2.0.0p353
",https://api.github.com/repos/rails/rails/issues/24301/timeline,,mountriv99,584545,MDQ6VXNlcjU4NDU0NQ==,https://avatars.githubusercontent.com/u/584545?v=4,,https://api.github.com/users/mountriv99,https://github.com/mountriv99,https://api.github.com/users/mountriv99/followers,https://api.github.com/users/mountriv99/following{/other_user},https://api.github.com/users/mountriv99/gists{/gist_id},https://api.github.com/users/mountriv99/starred{/owner}{/repo},https://api.github.com/users/mountriv99/subscriptions,https://api.github.com/users/mountriv99/orgs,https://api.github.com/users/mountriv99/repos,https://api.github.com/users/mountriv99/events{/privacy},https://api.github.com/users/mountriv99/received_events,User,False,https://api.github.com/repos/rails/rails/issues/24301/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
546,https://api.github.com/repos/rails/rails/issues/23977,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23977/labels{/name},https://api.github.com/repos/rails/rails/issues/23977/comments,https://api.github.com/repos/rails/rails/issues/23977/events,https://github.com/rails/rails/issues/23977,137455672,MDU6SXNzdWUxMzc0NTU2NzI=,23977,ActiveRecord::Associations::CollectionProxy#clear doesn't call remove callback with has many through,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2016-03-01T03:23:37Z,2021-08-10T11:05:23Z,,NONE,,"### Steps to reproduce

This test case is failed. Is it intended?

``` diff
diff --git a/activerecord/test/cases/associations/has_many_through_associations_test.rb b/activerecord/test/cases/associations/has_many_through_associations_test.rb
index bb8c9fa..a4ad266 100644
--- a/activerecord/test/cases/associations/has_many_through_associations_test.rb
+++ b/activerecord/test/cases/associations/has_many_through_associations_test.rb
@@ -724,6 +724,27 @@ class HasManyThroughAssociationsTest < ActiveRecord::TestCase
     ], log.last(4)
   end

+  def test_association_callback_clear
+    Post.reset_log
+    log = Post.log
+    post = posts(:thinking)
+    post.people.push(people(:david))
+    post.people_with_callbacks = []
+    assert_equal [
+      [:removed, :before, ""David""],
+      [:removed, :after, ""David""],
+    ], log.last(2)
+
+    Post.reset_log
+    log = Post.log
+    post.people.push(people(:david))
+    post.people_with_callbacks.clear
+    assert_equal [
+      [:removed, :before, ""David""],
+      [:removed, :after, ""David""],
+    ], log.last(2)
+  end
+
   def test_dynamic_find_should_respect_association_include
     # SQL error in sort clause if :include is not included
     # due to Unknown column 'comments.id'
```

```
% bundle exec ruby -I./activerecord/test activerecord/test/cases/associations/has_many_through_associations_test.rb -n /test_association_callback_clear/
Using sqlite3
Run options: -n /test_association_callback_clear/ --seed 18595

# Running:

F

Finished in 0.230421s, 4.3399 runs/s, 8.6797 assertions/s.

  1) Failure:
HasManyThroughAssociationsTest#test_association_callback_clear [activerecord/test/cases/associations/has_many_through_associations_test.rb:742]:
--- expected
+++ actual
@@ -1 +1 @@
-[[:removed, :before, ""David""], [:removed, :after, ""David""]]
+[]


1 runs, 2 assertions, 1 failures, 0 errors, 0 skips
```
### Expected behavior

I think after_removed should be fired.
### Actual behavior

before_removed and after_removed don't call.
### System configuration

**Rails version**:

rails 5.0.0.beta3

**Ruby version**:

```
% ruby -v
ruby 2.2.3p173 (2015-08-18 revision 51636) [x86_64-linux]
```
",https://api.github.com/repos/rails/rails/issues/23977/timeline,,authorNari,18746,MDQ6VXNlcjE4NzQ2,https://avatars.githubusercontent.com/u/18746?v=4,,https://api.github.com/users/authorNari,https://github.com/authorNari,https://api.github.com/users/authorNari/followers,https://api.github.com/users/authorNari/following{/other_user},https://api.github.com/users/authorNari/gists{/gist_id},https://api.github.com/users/authorNari/starred{/owner}{/repo},https://api.github.com/users/authorNari/subscriptions,https://api.github.com/users/authorNari/orgs,https://api.github.com/users/authorNari/repos,https://api.github.com/users/authorNari/events{/privacy},https://api.github.com/users/authorNari/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23977/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
547,https://api.github.com/repos/rails/rails/issues/23901,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23901/labels{/name},https://api.github.com/repos/rails/rails/issues/23901/comments,https://api.github.com/repos/rails/rails/issues/23901/events,https://github.com/rails/rails/issues/23901,136642806,MDU6SXNzdWUxMzY2NDI4MDY=,23901,Eager compute template digests in production,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,18,2016-02-26T09:30:38Z,2017-01-02T20:54:04Z,,MEMBER,,"Computing digests for templates at run-time risks burdening individual requests with that work, which may well take tens of milliseconds. We should have an option, and it should probably be default, to preload all template digests at server boot.
",https://api.github.com/repos/rails/rails/issues/23901/timeline,,dhh,2741,MDQ6VXNlcjI3NDE=,https://avatars.githubusercontent.com/u/2741?v=4,,https://api.github.com/users/dhh,https://github.com/dhh,https://api.github.com/users/dhh/followers,https://api.github.com/users/dhh/following{/other_user},https://api.github.com/users/dhh/gists{/gist_id},https://api.github.com/users/dhh/starred{/owner}{/repo},https://api.github.com/users/dhh/subscriptions,https://api.github.com/users/dhh/orgs,https://api.github.com/users/dhh/repos,https://api.github.com/users/dhh/events{/privacy},https://api.github.com/users/dhh/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23901/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
548,https://api.github.com/repos/rails/rails/issues/23856,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23856/labels{/name},https://api.github.com/repos/rails/rails/issues/23856/comments,https://api.github.com/repos/rails/rails/issues/23856/events,https://github.com/rails/rails/issues/23856,136115288,MDU6SXNzdWUxMzYxMTUyODg=,23856,What's the way forward for streaming and exceptions?,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'maclover7', 'id': 3020626, 'node_id': 'MDQ6VXNlcjMwMjA2MjY=', 'avatar_url': 'https://avatars.githubusercontent.com/u/3020626?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/maclover7', 'html_url': 'https://github.com/maclover7', 'followers_url': 'https://api.github.com/users/maclover7/followers', 'following_url': 'https://api.github.com/users/maclover7/following{/other_user}', 'gists_url': 'https://api.github.com/users/maclover7/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/maclover7/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/maclover7/subscriptions', 'organizations_url': 'https://api.github.com/users/maclover7/orgs', 'repos_url': 'https://api.github.com/users/maclover7/repos', 'events_url': 'https://api.github.com/users/maclover7/events{/privacy}', 'received_events_url': 'https://api.github.com/users/maclover7/received_events', 'type': 'User', 'site_admin': False}]",,9,2016-02-24T16:38:32Z,2017-07-01T09:16:17Z,,CONTRIBUTOR,,"Most exception notification gems, such as Sentry's `sentry-raven` or Honeybadger, hook into the ShowExceptions middlewares. [Here's where Honeybadger does it, for example](https://github.com/honeybadger-io/honeybadger-ruby/blob/349ff9319f5540b120463bedb40d612b60d7332d/lib/honeybadger/plugins/rails.rb#L70).

Setting `stream: true` to stream requests with `ActionController::Streaming` however means that these middlewares get bypassed when exceptions occur. [Here's what happens when an exception happens in a streaming template - we just log it and redirect to 500.html](https://github.com/rails/rails/blob/b6760d8f14af6b00250395f2c830b89e43621860/actionview/lib/action_view/renderer/streaming_template_renderer.rb#L32)

The comments mention this Exceptron thing, which was never merged. So what's the way forward here? Obviously re-using ShowExceptions makes no sense, but is there anything better we can do?

Happy to work on this with a PR once a decision is made.

Curious to hear if other exception notifiers have ever noticed this problem and what they've done about it. 
",https://api.github.com/repos/rails/rails/issues/23856/timeline,,nateberkopec,845662,MDQ6VXNlcjg0NTY2Mg==,https://avatars.githubusercontent.com/u/845662?v=4,,https://api.github.com/users/nateberkopec,https://github.com/nateberkopec,https://api.github.com/users/nateberkopec/followers,https://api.github.com/users/nateberkopec/following{/other_user},https://api.github.com/users/nateberkopec/gists{/gist_id},https://api.github.com/users/nateberkopec/starred{/owner}{/repo},https://api.github.com/users/nateberkopec/subscriptions,https://api.github.com/users/nateberkopec/orgs,https://api.github.com/users/nateberkopec/repos,https://api.github.com/users/nateberkopec/events{/privacy},https://api.github.com/users/nateberkopec/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23856/reactions,0,0,0,0,0,0,0,0,0,,,,,,,maclover7,3020626.0,MDQ6VXNlcjMwMjA2MjY=,https://avatars.githubusercontent.com/u/3020626?v=4,,https://api.github.com/users/maclover7,https://github.com/maclover7,https://api.github.com/users/maclover7/followers,https://api.github.com/users/maclover7/following{/other_user},https://api.github.com/users/maclover7/gists{/gist_id},https://api.github.com/users/maclover7/starred{/owner}{/repo},https://api.github.com/users/maclover7/subscriptions,https://api.github.com/users/maclover7/orgs,https://api.github.com/users/maclover7/repos,https://api.github.com/users/maclover7/events{/privacy},https://api.github.com/users/maclover7/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
549,https://api.github.com/repos/rails/rails/issues/23828,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23828/labels{/name},https://api.github.com/repos/rails/rails/issues/23828/comments,https://api.github.com/repos/rails/rails/issues/23828/events,https://github.com/rails/rails/issues/23828,135840906,MDU6SXNzdWUxMzU4NDA5MDY=,23828,ActionController::Streaming doesn't stream,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,21,2016-02-23T19:37:47Z,2021-05-22T01:28:04Z,,CONTRIBUTOR,,"`ActionController::Streaming` appears to not actually stream anything on Rails master. 

[Reproduction script here](https://gist.github.com/nateberkopec/bc671b0dcc07917099c4). Run it as a rack app with `puma config.ru`. 
### What I Expect

Viewing this page in the browser should immediately show ""Starting..."" and then ""1"", ""2"", ""3"" etc should appear gradually as the bytes are streamed to the browser.
### What Actually Happens

Nothing is displayed until the entire response has completed rendering. 

This can be confirmed in Chrome's net-internals tab. The request is sent at 3507 milliseconds, and even the _headers_ are not received until 9528 milliseconds.

<img width=""556"" alt=""screen shot 2016-02-23 at 2 32 22 pm"" src=""https://cloud.githubusercontent.com/assets/845662/13264046/5ef9f646-da3a-11e5-831b-a08a96f78308.png"">

![screen shot 2016-02-23 at 2 36 48 pm](https://cloud.githubusercontent.com/assets/845662/13264161/e587515e-da3a-11e5-97c2-36fc28d29c66.png)

I've tried a lot of different permutations of this. At first I thought maybe it was my webserver - nope, same behavior with Puma, Webrick and Unicorn (even with the fancy config or whatever you're supposed to use). Then I thought it was because Rails might be rendering the layout, then flushing, then rendering the view template, then flushing, then back to the layout before flushing again - but no combination of `sleep`s anywhere produced streaming output.
",https://api.github.com/repos/rails/rails/issues/23828/timeline,,nateberkopec,845662,MDQ6VXNlcjg0NTY2Mg==,https://avatars.githubusercontent.com/u/845662?v=4,,https://api.github.com/users/nateberkopec,https://github.com/nateberkopec,https://api.github.com/users/nateberkopec/followers,https://api.github.com/users/nateberkopec/following{/other_user},https://api.github.com/users/nateberkopec/gists{/gist_id},https://api.github.com/users/nateberkopec/starred{/owner}{/repo},https://api.github.com/users/nateberkopec/subscriptions,https://api.github.com/users/nateberkopec/orgs,https://api.github.com/users/nateberkopec/repos,https://api.github.com/users/nateberkopec/events{/privacy},https://api.github.com/users/nateberkopec/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23828/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
550,https://api.github.com/repos/rails/rails/issues/23820,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23820/labels{/name},https://api.github.com/repos/rails/rails/issues/23820/comments,https://api.github.com/repos/rails/rails/issues/23820/events,https://github.com/rails/rails/issues/23820,135610427,MDU6SXNzdWUxMzU2MTA0Mjc=,23820,Refactor `ActionView::TestCase` to use `ActionView::Base`,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,5,2016-02-23T02:29:53Z,2016-12-03T01:32:08Z,,MEMBER,,"Instead of using `ActionView::Base`, `ActionView::TestCase` has a giant `Behavior` module which contains some, but not all of `ActionView::Base`'s behavior. This is causing issues like #7218 to appear, because since AV::TestCase doesn't use the true AV::Base, some bugs (in this case, relating to the asset pipeline) are introduced. The long term fix for this is to do a large refactoring of AV::TestCase, and to change it to use AV::Base. I was going to take a look into doing this, but if anyone else would like to claim this, go right ahead. :)
",https://api.github.com/repos/rails/rails/issues/23820/timeline,,maclover7,3020626,MDQ6VXNlcjMwMjA2MjY=,https://avatars.githubusercontent.com/u/3020626?v=4,,https://api.github.com/users/maclover7,https://github.com/maclover7,https://api.github.com/users/maclover7/followers,https://api.github.com/users/maclover7/following{/other_user},https://api.github.com/users/maclover7/gists{/gist_id},https://api.github.com/users/maclover7/starred{/owner}{/repo},https://api.github.com/users/maclover7/subscriptions,https://api.github.com/users/maclover7/orgs,https://api.github.com/users/maclover7/repos,https://api.github.com/users/maclover7/events{/privacy},https://api.github.com/users/maclover7/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23820/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
551,https://api.github.com/repos/rails/rails/issues/23760,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23760/labels{/name},https://api.github.com/repos/rails/rails/issues/23760/comments,https://api.github.com/repos/rails/rails/issues/23760/events,https://github.com/rails/rails/issues/23760,134645727,MDU6SXNzdWUxMzQ2NDU3Mjc=,23760,Active Record Object Equality doesn't handle STI,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,7,2016-02-18T17:41:30Z,2018-09-13T14:09:25Z,,NONE,,"Based on the comments on the [definition](https://github.com/rails/rails/blob/master/activerecord/lib/active_record/core.rb#L405) of the ActiveRecord equality method, it seems like two ActiveRecord objects are considered equal if they point to the same record in the database.  The current implementation works great, as long as STI classes are not involved.  If you use STI, then the restriction that the objects be instances of the exact same class is too restrictive.  For example the following code causes serious problems:

``` ruby
class CommunicationSetting < ActiveRecord::Base
  has_many :filters
end

class Filter < ActiveRecord::Base
  belongs_to :communication_setting
end

class AppointmentResourceFilter < Filter
end

class AppointmentTypeFilter < Filter
end

c = CommunicationSetting.first
c.filters # => [#<AppointmentResourceFilter:0x007f9ac80d2c70 id: 1, type: ""AppointmentResourceFilter"">]

f1 = c.filters.first
f1 # => #<AppointmentResourceFilter:0x007f9ac80d2c70 id: 1, type: ""AppointmentResourceFilter"">

f2 = f1.becomes!(AppointmentTypeFilter)
f2 # => #<AppointmentTypeFilter:0x007f9ac804e560 id: 1, type: ""AppointmentTypeFilter"">

f1 == f2 # => false

c.filters = [f2]
```

Normally if you replace the association on an active record object it realizes if records are the same (based on having the same primary key) and then executes an update query.  If there are removed records, it deletes them and if there are new ones, it inserts them.  

However in this case it is very, very confused.  Because the `==` operator returns false, ActiveRecord thinks that the ""old"" record needs to be deleted.  Then it tries to save the new record, which reports that is has already been persisted because it was loaded from the database, so ActiveRecord tries to perform an update query, which doesn't work:

``` sql
DELETE FROM `filters` WHERE `filters`.`id` = 1
UPDATE `filters` SET `type` = 'AppointmentTypeFilter', `updated_at` = '2016-02-18 17:20:07' WHERE `filters`.`id` = 1
```

As you can see from the above, it deletes record 1 and then tries to update record 1, which now doesn't exist.  

I believe I have a solution (but I'm not an expert in the internals of ActiveRecord so I'm not sure, which is why this isn't a pull request).  Right now the implementation of `==` looks like this:

``` ruby
    def ==(comparison_object)
      super ||
        comparison_object.instance_of?(self.class) &&
        !id.nil? &&
        comparison_object.id == id
    end
```

You can see that the `instance_of?` check limits the objects to the same class.  I propose we change it to this:

``` ruby
  def ==(comparison_object)
    super ||
      comparison_object.is_a?(self.class.base_class) &&
        !id.nil? &&
        comparison_object.id == id
  end
```

`class.base_class` allows us to retrieve the base of the STI inheritance chain, `is_a?` instead of `instance_of?` will check for any compatible STI class instead of limiting it to the same exact class.  

What do you guys think?  If people think this is the right approach, I am happy to open a pull request. 
",https://api.github.com/repos/rails/rails/issues/23760/timeline,,CyborgMaster,1882579,MDQ6VXNlcjE4ODI1Nzk=,https://avatars.githubusercontent.com/u/1882579?v=4,,https://api.github.com/users/CyborgMaster,https://github.com/CyborgMaster,https://api.github.com/users/CyborgMaster/followers,https://api.github.com/users/CyborgMaster/following{/other_user},https://api.github.com/users/CyborgMaster/gists{/gist_id},https://api.github.com/users/CyborgMaster/starred{/owner}{/repo},https://api.github.com/users/CyborgMaster/subscriptions,https://api.github.com/users/CyborgMaster/orgs,https://api.github.com/users/CyborgMaster/repos,https://api.github.com/users/CyborgMaster/events{/privacy},https://api.github.com/users/CyborgMaster/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23760/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
552,https://api.github.com/repos/rails/rails/issues/23640,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23640/labels{/name},https://api.github.com/repos/rails/rails/issues/23640/comments,https://api.github.com/repos/rails/rails/issues/23640/events,https://github.com/rails/rails/issues/23640,133309604,MDU6SXNzdWUxMzMzMDk2MDQ=,23640,Strong parameters doesn't permit array of arrays (nested arrays),"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,28,2016-02-12T18:21:58Z,2021-04-29T19:26:07Z,,NONE,,"Hey guys,

When I tried to permit params that contains an Array of Array, `strong parameters permit` is ignoring the second Array and returning an empty Array.

Example:

> Controller

`params.permit(param1: [param2: [[[:attr, :op, :val]]]])`

> Sent Parameters

`""param1"": {""param2"": [[{""attr"": ""1"", ""op"": ""<"", ""val"": ""2""}]]}`

Rails will ignore the nested Arrays and will return only the 
`{param1: [] }`
",https://api.github.com/repos/rails/rails/issues/23640/timeline,,leonardoprg,1134099,MDQ6VXNlcjExMzQwOTk=,https://avatars.githubusercontent.com/u/1134099?v=4,,https://api.github.com/users/leonardoprg,https://github.com/leonardoprg,https://api.github.com/users/leonardoprg/followers,https://api.github.com/users/leonardoprg/following{/other_user},https://api.github.com/users/leonardoprg/gists{/gist_id},https://api.github.com/users/leonardoprg/starred{/owner}{/repo},https://api.github.com/users/leonardoprg/subscriptions,https://api.github.com/users/leonardoprg/orgs,https://api.github.com/users/leonardoprg/repos,https://api.github.com/users/leonardoprg/events{/privacy},https://api.github.com/users/leonardoprg/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23640/reactions,34,31,0,0,0,0,0,0,3,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
553,https://api.github.com/repos/rails/rails/issues/23536,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23536/labels{/name},https://api.github.com/repos/rails/rails/issues/23536/comments,https://api.github.com/repos/rails/rails/issues/23536/events,https://github.com/rails/rails/issues/23536,131931579,MDU6SXNzdWUxMzE5MzE1Nzk=,23536,Dependency Tracker finds dependencies in HTML tags and incorrectly in render calls,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,1,2016-02-07T03:42:33Z,2016-07-26T08:47:12Z,,CONTRIBUTOR,,"I'm not sure that this is technically a bug but it does list extra dependencies for templates that are not actually dependencies. This occurs because of how the dependency tracker looks for render calls in templates.

I ran into this bug when I was using a decorator object that defined `to_partial_path`. I had in my view a render call like this `<%= render MyDecorator.new(model_object) %>` and I also had calls to the cache helper in the same template. When the cache helper was getting the dependencies to use for digesting, I saw in the log `Couldn't find template for digesting: news/new`. I was able to track this down to how the dependency tracker finds render calls and then processes them. The relevant code is here [https://github.com/rails/rails/blob/v5.0.0.beta2/actionview/lib/action_view/dependency_tracker.rb#L118](https://github.com/rails/rails/blob/v5.0.0.beta2/actionview/lib/action_view/dependency_tracker.rb#L118).

I am also going to submit a pull request with a fix for this issue. I believe this issue #21951 is related and is also will be fixed by the pull request.

To reproduce this problem:
1. create a new rails project
2. create a controller with an action (name doesn't matter) and the corresponding view template
3. in the view template add the following erb:
   
   ``` erb
   <script>
     var render = document.getElementById('#render');
     render(data.autokinds);
   </script>
   
   <div id=""render"" data-auto_kinds=""value"">
     <h1>hello</h1>
   </div>
   
   <%= render ApplicationHelper::ClassWithPartialPath.new %>
   <%= render ClassWithPartialPath.new %>
   <%= render ApplicationHelper::employee %>
   ```
4. run `bundle exec rake cache_digests:dependencies TEMPLATE=that_template_name`

``` ruby
=> [
  ""autokinds/autokind"",
  ""static/ data-auto_kinds="", # static is the name of the controller I chose
  ""ApplicationHelpers/ApplicationHelper"",
  ""news/new""
]
```

After the fix, running the cache_digests command on the same template will produce:

``` ruby
=> [
  ""employees/employee""
]
```

This is matching the last render call, the scoped access of a record in the ApplicationHelper. I'm not sure that anyone actually uses that but it is a side-effect fix to prevent the 3rd dependency, ""ApplicationHelpers/ApplicationHelper"", from showing as a dependency.
",https://api.github.com/repos/rails/rails/issues/23536/timeline,,romaimperator,39470,MDQ6VXNlcjM5NDcw,https://avatars.githubusercontent.com/u/39470?v=4,,https://api.github.com/users/romaimperator,https://github.com/romaimperator,https://api.github.com/users/romaimperator/followers,https://api.github.com/users/romaimperator/following{/other_user},https://api.github.com/users/romaimperator/gists{/gist_id},https://api.github.com/users/romaimperator/starred{/owner}{/repo},https://api.github.com/users/romaimperator/subscriptions,https://api.github.com/users/romaimperator/orgs,https://api.github.com/users/romaimperator/repos,https://api.github.com/users/romaimperator/events{/privacy},https://api.github.com/users/romaimperator/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23536/reactions,2,1,0,0,0,0,1,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
554,https://api.github.com/repos/rails/rails/issues/23266,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23266/labels{/name},https://api.github.com/repos/rails/rails/issues/23266/comments,https://api.github.com/repos/rails/rails/issues/23266/events,https://github.com/rails/rails/issues/23266,128866309,MDU6SXNzdWUxMjg4NjYzMDk=,23266,Polymorphic has_one has_many issue,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2016-01-26T16:11:28Z,2020-02-20T10:46:38Z,,NONE,,"Hi,

Please see the following gist for details: https://gist.github.com/benliscio/9ad3fb597b04b2cb9f05

I'm not sure if the bug is:

1) `comment.subject_id` should update
2) `comment.subject_type` is not updating.

Thanks!
",https://api.github.com/repos/rails/rails/issues/23266/timeline,,benliscio,3613744,MDQ6VXNlcjM2MTM3NDQ=,https://avatars.githubusercontent.com/u/3613744?v=4,,https://api.github.com/users/benliscio,https://github.com/benliscio,https://api.github.com/users/benliscio/followers,https://api.github.com/users/benliscio/following{/other_user},https://api.github.com/users/benliscio/gists{/gist_id},https://api.github.com/users/benliscio/starred{/owner}{/repo},https://api.github.com/users/benliscio/subscriptions,https://api.github.com/users/benliscio/orgs,https://api.github.com/users/benliscio/repos,https://api.github.com/users/benliscio/events{/privacy},https://api.github.com/users/benliscio/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23266/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
555,https://api.github.com/repos/rails/rails/issues/23261,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23261/labels{/name},https://api.github.com/repos/rails/rails/issues/23261/comments,https://api.github.com/repos/rails/rails/issues/23261/events,https://github.com/rails/rails/issues/23261,128794692,MDU6SXNzdWUxMjg3OTQ2OTI=,23261,Cannot validate associated model on custom context,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2016-01-26T11:24:37Z,2018-12-07T14:35:47Z,,NONE,,"When we try to validate associated model with `validates_associated` on custom context, we get `true` on the first call of method `valid?(:my_context)` and get `false` on the second call method `valid?(:my_context)`.
If we place `accepts_nested_attributes_for` before validation validation works wrong, but if we place  `accepts_nested_attributes_for` after validation validation works good.

``` ruby
begin
  require 'bundler/inline'
rescue LoadError => e
  $stderr.puts 'Bundler version 1.10 or later is required. Please update your Bundler'
  raise e
end

gemfile(true) do
  source 'https://rubygems.org'
  gem 'activerecord', '4.2.5'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users, force: true do |t|
  end

  create_table :profiles, force: true do |t|
    t.integer :user_id
    t.string :info
  end
end

class User < ActiveRecord::Base
  has_one :profile

  accepts_nested_attributes_for :profile, allow_destroy: true

  validates_presence_of :profile, on: :my_context
  validates_associated :profile, on: :my_context
end

class Profile < ActiveRecord::Base
  belongs_to :user
  validates :info, presence: true, on: :my_context
end

class BugTest < Minitest::Test
  def test_context_validation_stuff
    user = User.create
    user.create_profile(info: nil)

    user = User.last

    assert !user.valid?(:my_context) #=> false
    assert !user.valid?(:my_context) #=> true
  end
end
```
",https://api.github.com/repos/rails/rails/issues/23261/timeline,,RagunovichVlad,6819728,MDQ6VXNlcjY4MTk3Mjg=,https://avatars.githubusercontent.com/u/6819728?v=4,,https://api.github.com/users/RagunovichVlad,https://github.com/RagunovichVlad,https://api.github.com/users/RagunovichVlad/followers,https://api.github.com/users/RagunovichVlad/following{/other_user},https://api.github.com/users/RagunovichVlad/gists{/gist_id},https://api.github.com/users/RagunovichVlad/starred{/owner}{/repo},https://api.github.com/users/RagunovichVlad/subscriptions,https://api.github.com/users/RagunovichVlad/orgs,https://api.github.com/users/RagunovichVlad/repos,https://api.github.com/users/RagunovichVlad/events{/privacy},https://api.github.com/users/RagunovichVlad/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23261/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
556,https://api.github.com/repos/rails/rails/issues/23091,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/23091/labels{/name},https://api.github.com/repos/rails/rails/issues/23091/comments,https://api.github.com/repos/rails/rails/issues/23091/events,https://github.com/rails/rails/issues/23091,127119821,MDU6SXNzdWUxMjcxMTk4MjE=,23091,"In date_select tags, :include_blank should not override :default","[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,2,2016-01-17T20:04:37Z,2016-01-26T03:56:06Z,,NONE,,"This is a long-standing issue, complained about in several other places, but for some reason never on rails directly. See [here](http://stackoverflow.com/a/17188437/4849325) and [here](https://github.com/plataformatec/simple_form/issues/425). 

It makes sense for include_blank and prompt to include an implicit default, but if default is set explicitly, :include_blank or :prompt should not override it. 
",https://api.github.com/repos/rails/rails/issues/23091/timeline,,jkopczyn,1253351,MDQ6VXNlcjEyNTMzNTE=,https://avatars.githubusercontent.com/u/1253351?v=4,,https://api.github.com/users/jkopczyn,https://github.com/jkopczyn,https://api.github.com/users/jkopczyn/followers,https://api.github.com/users/jkopczyn/following{/other_user},https://api.github.com/users/jkopczyn/gists{/gist_id},https://api.github.com/users/jkopczyn/starred{/owner}{/repo},https://api.github.com/users/jkopczyn/subscriptions,https://api.github.com/users/jkopczyn/orgs,https://api.github.com/users/jkopczyn/repos,https://api.github.com/users/jkopczyn/events{/privacy},https://api.github.com/users/jkopczyn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/23091/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
557,https://api.github.com/repos/rails/rails/issues/22563,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/22563/labels{/name},https://api.github.com/repos/rails/rails/issues/22563/comments,https://api.github.com/repos/rails/rails/issues/22563/events,https://github.com/rails/rails/issues/22563,121826583,MDU6SXNzdWUxMjE4MjY1ODM=,22563,#as_json omits output from relations following the usage of a config hash,"[{'id': 107190, 'node_id': 'MDU6TGFiZWwxMDcxOTA=', 'url': 'https://api.github.com/repos/rails/rails/labels/activemodel', 'name': 'activemodel', 'color': '00E5FF', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'chancancode', 'id': 55829, 'node_id': 'MDQ6VXNlcjU1ODI5', 'avatar_url': 'https://avatars.githubusercontent.com/u/55829?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/chancancode', 'html_url': 'https://github.com/chancancode', 'followers_url': 'https://api.github.com/users/chancancode/followers', 'following_url': 'https://api.github.com/users/chancancode/following{/other_user}', 'gists_url': 'https://api.github.com/users/chancancode/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/chancancode/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/chancancode/subscriptions', 'organizations_url': 'https://api.github.com/users/chancancode/orgs', 'repos_url': 'https://api.github.com/users/chancancode/repos', 'events_url': 'https://api.github.com/users/chancancode/events{/privacy}', 'received_events_url': 'https://api.github.com/users/chancancode/received_events', 'type': 'User', 'site_admin': False}]",,2,2015-12-12T02:17:36Z,2016-06-25T03:37:17Z,,NONE,,"https://github.com/rails/rails/blob/4-2-stable/activemodel/lib/active_model/serializers/json.rb#L88 eventually calls https://github.com/rails/rails/blob/4-2-stable/activemodel/lib/active_model/serialization.rb#L124, which exhibits an edge case when hashes are used to describe includes.

Example 1:

``` ruby
MyModel.first.as_json(include: [
    :tags,
    user: {
        only: [:first_name, :last_name]
    }, # BUG: rails doesn't return anything after the first hash config
    card: {
        only: [:name, :rp_name]
    }
])
```

In the above case, only data for `:tags` and `:user` associations are returned.

Example 2:

``` ruby
MyModel.first.as_json(include: [
    :tags,
    :user,
    card: {
        only: [:name, :rp_name]
    }
])
```

In this example, data for all three associations is returned (since the first hash config appears at the end.

Example 3:

``` ruby
MyModel.first.as_json(include: [
    tags: {}, # BUG: rails doesn't return anything after the first hash config
    user: {},
    card: {
        only: [:name, :rp_name]
    }
])
```

In this example, only data for the `:tags` association is returned.

Example 4:

``` ruby
MyModel.first.as_json(include: [
    :tags,
    :user,
    :card
])
```

Works as expected.

---

In all cases, behavior does not appear to change depending on whether or not `#includes` was called before `#as_json` was attempted.
",https://api.github.com/repos/rails/rails/issues/22563/timeline,,kenaniah,363800,MDQ6VXNlcjM2MzgwMA==,https://avatars.githubusercontent.com/u/363800?v=4,,https://api.github.com/users/kenaniah,https://github.com/kenaniah,https://api.github.com/users/kenaniah/followers,https://api.github.com/users/kenaniah/following{/other_user},https://api.github.com/users/kenaniah/gists{/gist_id},https://api.github.com/users/kenaniah/starred{/owner}{/repo},https://api.github.com/users/kenaniah/subscriptions,https://api.github.com/users/kenaniah/orgs,https://api.github.com/users/kenaniah/repos,https://api.github.com/users/kenaniah/events{/privacy},https://api.github.com/users/kenaniah/received_events,User,False,https://api.github.com/repos/rails/rails/issues/22563/reactions,0,0,0,0,0,0,0,0,0,,,,,,,chancancode,55829.0,MDQ6VXNlcjU1ODI5,https://avatars.githubusercontent.com/u/55829?v=4,,https://api.github.com/users/chancancode,https://github.com/chancancode,https://api.github.com/users/chancancode/followers,https://api.github.com/users/chancancode/following{/other_user},https://api.github.com/users/chancancode/gists{/gist_id},https://api.github.com/users/chancancode/starred{/owner}{/repo},https://api.github.com/users/chancancode/subscriptions,https://api.github.com/users/chancancode/orgs,https://api.github.com/users/chancancode/repos,https://api.github.com/users/chancancode/events{/privacy},https://api.github.com/users/chancancode/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
558,https://api.github.com/repos/rails/rails/issues/22473,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/22473/labels{/name},https://api.github.com/repos/rails/rails/issues/22473/comments,https://api.github.com/repos/rails/rails/issues/22473/events,https://github.com/rails/rails/pull/22473,120056885,MDExOlB1bGxSZXF1ZXN0NTI0Njg2OTc=,22473,Add support for relative paths in partial lookup,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 128692, 'node_id': 'MDU6TGFiZWwxMjg2OTI=', 'url': 'https://api.github.com/repos/rails/rails/labels/needs%20feedback', 'name': 'needs feedback', 'color': 'ededed', 'default': False, 'description': None}, {'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}]",open,False,,"[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}]",,28,2015-12-02T23:09:54Z,2022-03-07T07:29:28Z,,CONTRIBUTOR,,"This an pull request for issues discussed here #6478, #1143 

I will be happy to hear any feedback, as I'm not sure about correctness of the implementation
",https://api.github.com/repos/rails/rails/issues/22473/timeline,,TheSmartnik,8058230,MDQ6VXNlcjgwNTgyMzA=,https://avatars.githubusercontent.com/u/8058230?v=4,,https://api.github.com/users/TheSmartnik,https://github.com/TheSmartnik,https://api.github.com/users/TheSmartnik/followers,https://api.github.com/users/TheSmartnik/following{/other_user},https://api.github.com/users/TheSmartnik/gists{/gist_id},https://api.github.com/users/TheSmartnik/starred{/owner}{/repo},https://api.github.com/users/TheSmartnik/subscriptions,https://api.github.com/users/TheSmartnik/orgs,https://api.github.com/users/TheSmartnik/repos,https://api.github.com/users/TheSmartnik/events{/privacy},https://api.github.com/users/TheSmartnik/received_events,User,False,https://api.github.com/repos/rails/rails/issues/22473/reactions,28,0,0,0,0,0,28,0,0,False,https://api.github.com/repos/rails/rails/pulls/22473,https://github.com/rails/rails/pull/22473,https://github.com/rails/rails/pull/22473.diff,https://github.com/rails/rails/pull/22473.patch,,rafaelfranca,47848.0,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
559,https://api.github.com/repos/rails/rails/issues/22129,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/22129/labels{/name},https://api.github.com/repos/rails/rails/issues/22129/comments,https://api.github.com/repos/rails/rails/issues/22129/events,https://github.com/rails/rails/issues/22129,114345003,MDU6SXNzdWUxMTQzNDUwMDM=,22129,model.associations.reload.last is not deterministic,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'pixeltrix', 'id': 6321, 'node_id': 'MDQ6VXNlcjYzMjE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pixeltrix', 'html_url': 'https://github.com/pixeltrix', 'followers_url': 'https://api.github.com/users/pixeltrix/followers', 'following_url': 'https://api.github.com/users/pixeltrix/following{/other_user}', 'gists_url': 'https://api.github.com/users/pixeltrix/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pixeltrix/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pixeltrix/subscriptions', 'organizations_url': 'https://api.github.com/users/pixeltrix/orgs', 'repos_url': 'https://api.github.com/users/pixeltrix/repos', 'events_url': 'https://api.github.com/users/pixeltrix/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pixeltrix/received_events', 'type': 'User', 'site_admin': False}]",,5,2015-10-30T19:57:04Z,2016-07-14T01:08:33Z,,CONTRIBUTOR,,"`model.associations.last` and `model.associations.reload.last` behave differently; the former gets the last record deterministically by ordering by the primary key automatically, but the latter does not order at all. This is surprising and seems like a bug. Failing reproduction test case:

<details>
<summary>

test.rb</summary>



``` ruby
begin
  require 'bundler/inline'
rescue LoadError => e
  $stderr.puts 'Bundler version 1.10 or later is required. Please update your Bundler'
  raise e
end

gemfile(true) do
  source 'https://rubygems.org'
  gem 'rails', '4.2.4'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)
ActiveSupport::LogSubscriber.colorize_logging = false

ActiveRecord::Schema.define do
  create_table :posts, force: true  do |t|
  end

  create_table :comments, force: true  do |t|
    t.integer :post_id
  end
end

class Post < ActiveRecord::Base
  has_many :comments
end

class Comment < ActiveRecord::Base
  belongs_to :post
end

class BugTest < Minitest::Test
  def setup
    @post = Post.create!
    @original_logger = ActiveRecord::Base.logger
    @output = StringIO.new
    ActiveRecord::Base.logger = Logger.new(@output)
    ActiveRecord::Base.logger.datetime_format = ''
  end

  def teardown
    ActiveRecord::Base.logger = @original_logger
  end

  def test_reload_first
    @post.comments.first
    @post.comments.reload.first
    first, reload_first = @output.string.split(""\n"")
    assert_equal first, reload_first
  end

  def test_reload_last
    @post.comments.last
    @post.comments.reload.last
    last, reload_last = @output.string.split(""\n"")
    assert_equal last, reload_last
  end
end
```

</details>

<details>
<summary>

Test output</summary>



```
  1) Failure:
BugTest#test_reload_first [active_record_master.rb:57]:
--- expected
+++ actual
@@ -1 +1 @@
-""D, [#2266] DEBUG -- :   Comment Load (0.1ms)  SELECT  \""comments\"".* FROM \""comments\"" WHERE \""comments\"".\""post_id\"" = ?  ORDER BY \""comments\"".\""id\"" ASC LIMIT 1  [[\""post_id\"", 1]]""
+""D, [#2266] DEBUG -- :   Comment Load (0.1ms)  SELECT \""comments\"".* FROM \""comments\"" WHERE \""comments\"".\""post_id\"" = ?  [[\""post_id\"", 1]]""



  2) Failure:
BugTest#test_reload_last [active_record_master.rb:64]:
--- expected
+++ actual
@@ -1 +1 @@
-""D, [#2266] DEBUG -- :   Comment Load (0.1ms)  SELECT  \""comments\"".* FROM \""comments\"" WHERE \""comments\"".\""post_id\"" = ?  ORDER BY \""comments\"".\""id\"" DESC LIMIT 1  [[\""post_id\"", 2]]""
+""D, [#2266] DEBUG -- :   Comment Load (0.0ms)  SELECT \""comments\"".* FROM \""comments\"" WHERE \""comments\"".\""post_id\"" = ?  [[\""post_id\"", 2]]""
```

</details>
",https://api.github.com/repos/rails/rails/issues/22129/timeline,,aripollak,451345,MDQ6VXNlcjQ1MTM0NQ==,https://avatars.githubusercontent.com/u/451345?v=4,,https://api.github.com/users/aripollak,https://github.com/aripollak,https://api.github.com/users/aripollak/followers,https://api.github.com/users/aripollak/following{/other_user},https://api.github.com/users/aripollak/gists{/gist_id},https://api.github.com/users/aripollak/starred{/owner}{/repo},https://api.github.com/users/aripollak/subscriptions,https://api.github.com/users/aripollak/orgs,https://api.github.com/users/aripollak/repos,https://api.github.com/users/aripollak/events{/privacy},https://api.github.com/users/aripollak/received_events,User,False,https://api.github.com/repos/rails/rails/issues/22129/reactions,1,1,0,0,0,0,0,0,0,,,,,,,pixeltrix,6321.0,MDQ6VXNlcjYzMjE=,https://avatars.githubusercontent.com/u/6321?v=4,,https://api.github.com/users/pixeltrix,https://github.com/pixeltrix,https://api.github.com/users/pixeltrix/followers,https://api.github.com/users/pixeltrix/following{/other_user},https://api.github.com/users/pixeltrix/gists{/gist_id},https://api.github.com/users/pixeltrix/starred{/owner}{/repo},https://api.github.com/users/pixeltrix/subscriptions,https://api.github.com/users/pixeltrix/orgs,https://api.github.com/users/pixeltrix/repos,https://api.github.com/users/pixeltrix/events{/privacy},https://api.github.com/users/pixeltrix/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
560,https://api.github.com/repos/rails/rails/issues/21951,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21951/labels{/name},https://api.github.com/repos/rails/rails/issues/21951/comments,https://api.github.com/repos/rails/rails/issues/21951/events,https://github.com/rails/rails/issues/21951,111174649,MDU6SXNzdWUxMTExNzQ2NDk=,21951,Cache digest  bug?,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,3,2015-10-13T12:59:37Z,2016-02-07T03:59:57Z,,NONE,,"In my welcome/index.html.erb file, there are some lines:

&lt;script type=""text/javascript""&gt;
/*
$(document).ready(function(){
    $(""a.factory"").on(""ajax:success"",function(event,data){
        html=$(""#template"").render(data.auto_kinds);
        $($(this).parent()).children("".auto_kind_list"").html(html);
    });

});
*/
 &lt;/script&gt;

When I execute the below command:

$ rake cache_digests:nested_dependencies TEMPLATE=welcome/index
[
  ""auto_kinds/auto_kind""
]

If I remove the script code, I execute the command:

$ rake cache_digests:nested_dependencies TEMPLATE=welcome/index
[

]
",https://api.github.com/repos/rails/rails/issues/21951/timeline,,blackspace,307501,MDQ6VXNlcjMwNzUwMQ==,https://avatars.githubusercontent.com/u/307501?v=4,,https://api.github.com/users/blackspace,https://github.com/blackspace,https://api.github.com/users/blackspace/followers,https://api.github.com/users/blackspace/following{/other_user},https://api.github.com/users/blackspace/gists{/gist_id},https://api.github.com/users/blackspace/starred{/owner}{/repo},https://api.github.com/users/blackspace/subscriptions,https://api.github.com/users/blackspace/orgs,https://api.github.com/users/blackspace/repos,https://api.github.com/users/blackspace/events{/privacy},https://api.github.com/users/blackspace/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21951/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
561,https://api.github.com/repos/rails/rails/issues/21700,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21700/labels{/name},https://api.github.com/repos/rails/rails/issues/21700/comments,https://api.github.com/repos/rails/rails/issues/21700/events,https://github.com/rails/rails/issues/21700,107520997,MDU6SXNzdWUxMDc1MjA5OTc=,21700,Ruby process hangs when calling generator from after_bundle hook in Rails template,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,9,2015-09-21T14:08:37Z,2020-09-08T17:17:56Z,,NONE,,"If I do the following in a Rails template:

``` ruby
after_bundle do
  generate(:model, ""article title:string"")
end
```

And run it with

``` shell
$ rails new sandbox -m template.rb
```

The two ruby processes still hangs around afterwords. It crashes if I, for instance, run the template a second time unless I first force quit those two processes. For the record, I'm not trying to generate a model, but I'm trying to run a generator that comes from a gem that I'm adding in the template as well. 
",https://api.github.com/repos/rails/rails/issues/21700/timeline,,jensljungblad,271354,MDQ6VXNlcjI3MTM1NA==,https://avatars.githubusercontent.com/u/271354?v=4,,https://api.github.com/users/jensljungblad,https://github.com/jensljungblad,https://api.github.com/users/jensljungblad/followers,https://api.github.com/users/jensljungblad/following{/other_user},https://api.github.com/users/jensljungblad/gists{/gist_id},https://api.github.com/users/jensljungblad/starred{/owner}{/repo},https://api.github.com/users/jensljungblad/subscriptions,https://api.github.com/users/jensljungblad/orgs,https://api.github.com/users/jensljungblad/repos,https://api.github.com/users/jensljungblad/events{/privacy},https://api.github.com/users/jensljungblad/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21700/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
562,https://api.github.com/repos/rails/rails/issues/21574,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21574/labels{/name},https://api.github.com/repos/rails/rails/issues/21574/comments,https://api.github.com/repos/rails/rails/issues/21574/events,https://github.com/rails/rails/issues/21574,105774506,MDU6SXNzdWUxMDU3NzQ1MDY=,21574,"In Rails 4.2 passing ActionDispatch::Http::UploadedFile into a model's Hash serialized params raises ""IOError: uninitialized stream"" when trying to read the file.","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,4,2015-09-10T10:00:38Z,2017-10-03T12:11:46Z,,NONE,,"This is a bit of an obscure bug. It may not be worth really looking into but it used to work in Rails 4.1 so I decided to create a bug report for it.
### Why I am doing this

In my case I am passing uploaded files to a model in serialized parameters (Hash).
It is coming from a form (fields_for) which creates a hash with files.

I then have a before_save filter which uploads and converts the files from ActionDispatch::Http::UploadedFile objects into identifiers I can use later to retrieve the files.
### The bug

This worked fine in Rails 4.1 but in Rails 4.2 trying to run #read on the ActionDispatch::Http::UploadedFile object raises ""IOError: uninitialized stream""

I suspect it has to do with the way the serialize works now, it rebuilds the UploadedFile object but does not correctly initialize the stream. Using `File.open(file_from_params.tempfile.path).read` works.
### Reproducing

I created a basic repo to reproduce the error:
It takes the file in from nested params, passes it to the model (FileUpload.new) and then tries to render out the uploaded files length.

https://github.com/SixiS/http_upload_bug

With the Rails version set to 4.1.11 in the Gemfile the single test passes, with 4.2.4 it fails with the error mentioned above.

My first Rails bug report, sorry if something is wrong or if this is not the right place - just let me know and I'll fix it.
",https://api.github.com/repos/rails/rails/issues/21574/timeline,,SixiS,99471,MDQ6VXNlcjk5NDcx,https://avatars.githubusercontent.com/u/99471?v=4,,https://api.github.com/users/SixiS,https://github.com/SixiS,https://api.github.com/users/SixiS/followers,https://api.github.com/users/SixiS/following{/other_user},https://api.github.com/users/SixiS/gists{/gist_id},https://api.github.com/users/SixiS/starred{/owner}{/repo},https://api.github.com/users/SixiS/subscriptions,https://api.github.com/users/SixiS/orgs,https://api.github.com/users/SixiS/repos,https://api.github.com/users/SixiS/events{/privacy},https://api.github.com/users/SixiS/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21574/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
563,https://api.github.com/repos/rails/rails/issues/21307,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21307/labels{/name},https://api.github.com/repos/rails/rails/issues/21307/comments,https://api.github.com/repos/rails/rails/issues/21307/events,https://github.com/rails/rails/issues/21307,102087660,MDU6SXNzdWUxMDIwODc2NjA=,21307,create_join_table incorrectly prepends table_name_prefix to first table name before generating table name,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,7,2015-08-20T08:20:16Z,2016-07-26T06:20:23Z,,CONTRIBUTOR,,"In Ruby On Rails 4.2.3, the join_table name will be derived incorrectly. For example:

```
ActiveRecord::Base.table_name_prefix = 'test_'

create_join_table :actions, :scenarios
```

This will create a table named `scenarios_test_actions`. I debugged the code a bit and it seems the table_1 argument of create_join_table gets the prefixed name instead of later prepending it.
",https://api.github.com/repos/rails/rails/issues/21307/timeline,,frenkel,121169,MDQ6VXNlcjEyMTE2OQ==,https://avatars.githubusercontent.com/u/121169?v=4,,https://api.github.com/users/frenkel,https://github.com/frenkel,https://api.github.com/users/frenkel/followers,https://api.github.com/users/frenkel/following{/other_user},https://api.github.com/users/frenkel/gists{/gist_id},https://api.github.com/users/frenkel/starred{/owner}{/repo},https://api.github.com/users/frenkel/subscriptions,https://api.github.com/users/frenkel/orgs,https://api.github.com/users/frenkel/repos,https://api.github.com/users/frenkel/events{/privacy},https://api.github.com/users/frenkel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21307/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
564,https://api.github.com/repos/rails/rails/issues/21224,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21224/labels{/name},https://api.github.com/repos/rails/rails/issues/21224/comments,https://api.github.com/repos/rails/rails/issues/21224/events,https://github.com/rails/rails/issues/21224,100804947,MDU6SXNzdWUxMDA4MDQ5NDc=,21224,Escaped entities in requests are not properly decoded,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2015-08-13T15:56:03Z,2016-03-11T18:53:24Z,,NONE,,"Reproduced here: https://gist.github.com/stevenkaras/042ca66a61b3aea40a83

The problem is that some clients will escape more entities than they need to, and routing will fail to unescape them. I've observed this in several cases where automated crawlers will escape the at symbol ""@"" to ""%40"". A workaround is to do the following:

``` ruby
get ':at:user_name', to: ""test#foobar"", constraints: { at: /@|%40/ }, defaults: { at: ""@"" }
```

Despite these being horribly misconfigured clients that shouldn't be escaping the @ in the path, they are, and there is no way to directly match against an escaped sequence in Rails' router (`get '%40:user_name'` would match a literal '%2540foobar', but not '%40foobar') without using the workaround above.
",https://api.github.com/repos/rails/rails/issues/21224/timeline,,stevenkaras,322377,MDQ6VXNlcjMyMjM3Nw==,https://avatars.githubusercontent.com/u/322377?v=4,,https://api.github.com/users/stevenkaras,https://github.com/stevenkaras,https://api.github.com/users/stevenkaras/followers,https://api.github.com/users/stevenkaras/following{/other_user},https://api.github.com/users/stevenkaras/gists{/gist_id},https://api.github.com/users/stevenkaras/starred{/owner}{/repo},https://api.github.com/users/stevenkaras/subscriptions,https://api.github.com/users/stevenkaras/orgs,https://api.github.com/users/stevenkaras/repos,https://api.github.com/users/stevenkaras/events{/privacy},https://api.github.com/users/stevenkaras/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21224/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
565,https://api.github.com/repos/rails/rails/issues/21209,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21209/labels{/name},https://api.github.com/repos/rails/rails/issues/21209/comments,https://api.github.com/repos/rails/rails/issues/21209/events,https://github.com/rails/rails/issues/21209,100537761,MDU6SXNzdWUxMDA1Mzc3NjE=,21209,Threading error when using `ActiveRecord with_connection do` & ActionController::Live,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,8,2015-08-12T12:59:53Z,2016-07-22T10:55:24Z,,NONE,,"Source: http://stackoverflow.com/questions/31535545/threading-error-when-using-activerecord-with-connection-do-puma , https://github.com/puma/puma/issues/758

**Summary:**  When using Puma and running long-running connections I am consistently receiving errors related to ActiveRecord connections crossing threads. This manifests itself in message like `message type 0x## arrived from server while idle` and a locked (crashed) server.

*\* Edit: *\* Added OS X and Rainbows to applicable versions

What isn't clear is what conditions could cause the connection to be crossed between threads, i.e. am I, or is Puma, doing something wrong and needs correcting, or is the connection_pool getting confused. If you think this is better placed somewhere else then please let me know. I'm trying to do leg work on this but pretty much out of ideas!

---

The set up:
- Ubuntu 15 / OS X Yosemite
- PostgreSQL (9.4) / MySQL (`mysqld 5.6.25-0ubuntu0.15.04.1`)
- Ruby - MRI `2.2.2p95 (2015-04-13 revision 50295) [x86_64-linux]` / Rubinius `rbx-2.5.8`
- Rails (`4.2.3`, `4.2.1`)
- Puma (`2.12.2`, `2.11`) / Rainbows
- pg (`pg-0.18.2`) / mysql2

Note, not all combinations of the above versions have been tried. First listed version is what I'm currently testing against.
- `rails new issue-test`
- Add a route `get 'events' => 'streaming#events'`
- Add a controller `streaming_controller.rb`
- Set up database stuff (`pool: 2`, but seen with different pool sizes)

Code:

```
class StreamingController < ApplicationController

  include ActionController::Live

  def events
    begin
      response.headers[""Content-Type""] = ""text/event-stream""
      sse = SSE.new(response.stream)
      sse.write( {:data => 'starting'} , {:event => :version_heartbeat})
      ActiveRecord::Base.connection_pool.release_connection
      while true do
        ActiveRecord::Base.connection_pool.with_connection do |conn|
          ActiveRecord::Base.connection.query_cache.clear
          logger.info 'START'
          conn.execute 'SELECT pg_sleep(3)'
          logger.info 'FINISH'
          sse.write( {:data => 'continuing'}, {:event => :version_heartbeat})
          sleep 0.5
         end
      end
    rescue IOError
    rescue ClientDisconnected
    ensure
      logger.info 'Ensuring event stream is closed'
      sse.close
    end
    render nothing: true
  end
end
```

Puma configuration:

```
workers 1
threads 2, 2
#...
bind ""tcp://0.0.0.0:9292""

#...
activate_control_app

on_worker_boot do
  require ""active_record""
  ActiveRecord::Base.connection.disconnect! rescue ActiveRecord::ConnectionNotEstablished
  ActiveRecord::Base.establish_connection(YAML.load_file(""#{app_dir}/config/database.yml"")[rails_env])
end
```
- Run the server `puma -e production -C path/to/puma/config/production.rb`

Test script:

```
#!/bin/bash

timeout 30 curl -vS http://0.0.0.0/events &
timeout 5 curl -vS http://0.0.0.0/events &
timeout 30 curl -vS http://0.0.0.0/events
```

This reasonably consistently results in a complete lock of the application server (in PostgreSQL, see notes). The scary message comes from `libpq`:

```
message type 0x44 arrived from server while idle
message type 0x43 arrived from server while idle
message type 0x5a arrived from server while idle
message type 0x54 arrived from server while idle
```

In the 'real-world' I have quite a few extra elements and the issue presents itself at random. My research indicates that this message comes from `libpq` and is subtext for _'communication problem, possibly using connection in different threads'_. Finally, while writing this up, I had the server lock up without a single message in any log.

---

I don't see the issue happen if I change the controller block to look like:

```
begin
  #...
  while true do
    t = Thread.new do #<<<<<<<<<<<<<<<<<
        ActiveRecord::Base.connection_pool.with_connection do |conn|
            #...
        end
     end
     t.join #<<<<<<<<<<<<<<<<<
  end
  #...
rescue IOError
#...
```

But I don't know whether this has actually solved the problem or just made it extremely unlikely. Nor can I really fathom why this would make a difference.

---

**MySQL**

If running MySQL, the message is a bit different, and the application recovers (though I'm not sure if it is then in some undefined state):

```
F, [2015-07-30T14:12:07.078215 #15606] FATAL -- : 
ActiveRecord::StatementInvalid (Mysql2::Error: This connection is in use by: #<Thread:0x007f563b2faa88@/home/dev/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/gems/actionpack-4.2.3/lib/action_controller/metal/live.rb:269 sleep>: SELECT  `tasks`.* FROM `tasks`  ORDER BY `tasks`.`id` ASC LIMIT 1):
```
",https://api.github.com/repos/rails/rails/issues/21209/timeline,,duttski,1206402,MDQ6VXNlcjEyMDY0MDI=,https://avatars.githubusercontent.com/u/1206402?v=4,,https://api.github.com/users/duttski,https://github.com/duttski,https://api.github.com/users/duttski/followers,https://api.github.com/users/duttski/following{/other_user},https://api.github.com/users/duttski/gists{/gist_id},https://api.github.com/users/duttski/starred{/owner}{/repo},https://api.github.com/users/duttski/subscriptions,https://api.github.com/users/duttski/orgs,https://api.github.com/users/duttski/repos,https://api.github.com/users/duttski/events{/privacy},https://api.github.com/users/duttski/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21209/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
566,https://api.github.com/repos/rails/rails/issues/21064,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21064/labels{/name},https://api.github.com/repos/rails/rails/issues/21064/comments,https://api.github.com/repos/rails/rails/issues/21064/events,https://github.com/rails/rails/issues/21064,98061072,MDU6SXNzdWU5ODA2MTA3Mg==,21064,"Unnecessary/faulty downcase on record inside has_one, has_many restrict_with_error control structure","[{'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'arthurnn', 'id': 833383, 'node_id': 'MDQ6VXNlcjgzMzM4Mw==', 'avatar_url': 'https://avatars.githubusercontent.com/u/833383?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/arthurnn', 'html_url': 'https://github.com/arthurnn', 'followers_url': 'https://api.github.com/users/arthurnn/followers', 'following_url': 'https://api.github.com/users/arthurnn/following{/other_user}', 'gists_url': 'https://api.github.com/users/arthurnn/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/arthurnn/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/arthurnn/subscriptions', 'organizations_url': 'https://api.github.com/users/arthurnn/orgs', 'repos_url': 'https://api.github.com/users/arthurnn/repos', 'events_url': 'https://api.github.com/users/arthurnn/events{/privacy}', 'received_events_url': 'https://api.github.com/users/arthurnn/received_events', 'type': 'User', 'site_admin': True}]",,5,2015-07-30T00:59:25Z,2018-12-06T12:38:08Z,,CONTRIBUTOR,,"Inside the [has_one_association.rb](https://github.com/rails/rails/blob/master/activerecord/lib/active_record/associations/has_one_association.rb#L14) and [has_many_association.rb](https://github.com/rails/rails/blob/master/activerecord/lib/active_record/associations/has_many_association.rb#L18) occurs a seemingly unnecessary (also untested) downcasing on the associated class' `human_attribute_name`:

``` ruby
record = klass.human_attribute_name(reflection.name).downcase
```

This leads to undesired and strange looking error messages for `restrict_with_error` dependencies for class names which should not be downcased. 

Here is one example out of a Rails 4.2.3 application, which is localized with [Rails-i18N](https://github.com/svenfuchs/rails-i18n) (screenshot shows German language and text says ""Record can't be deleted, as dependent buildings exist"":

![screen shot 2015-07-30 at 2 47 00](https://cloud.githubusercontent.com/assets/3188392/8973470/47248dac-3665-11e5-8fde-f225fabd6299.png)

I've fixed it in my local copy of Rails, and the result is a correct spelled error message without downcasing:

![screen shot 2015-07-30 at 2 45 11](https://cloud.githubusercontent.com/assets/3188392/8973531/f4f2cad4-3665-11e5-9c4a-16265539e917.png)

I can of course provide a PR if necessary.
",https://api.github.com/repos/rails/rails/issues/21064/timeline,,cseelus,3188392,MDQ6VXNlcjMxODgzOTI=,https://avatars.githubusercontent.com/u/3188392?v=4,,https://api.github.com/users/cseelus,https://github.com/cseelus,https://api.github.com/users/cseelus/followers,https://api.github.com/users/cseelus/following{/other_user},https://api.github.com/users/cseelus/gists{/gist_id},https://api.github.com/users/cseelus/starred{/owner}{/repo},https://api.github.com/users/cseelus/subscriptions,https://api.github.com/users/cseelus/orgs,https://api.github.com/users/cseelus/repos,https://api.github.com/users/cseelus/events{/privacy},https://api.github.com/users/cseelus/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21064/reactions,0,0,0,0,0,0,0,0,0,,,,,,,arthurnn,833383.0,MDQ6VXNlcjgzMzM4Mw==,https://avatars.githubusercontent.com/u/833383?v=4,,https://api.github.com/users/arthurnn,https://github.com/arthurnn,https://api.github.com/users/arthurnn/followers,https://api.github.com/users/arthurnn/following{/other_user},https://api.github.com/users/arthurnn/gists{/gist_id},https://api.github.com/users/arthurnn/starred{/owner}{/repo},https://api.github.com/users/arthurnn/subscriptions,https://api.github.com/users/arthurnn/orgs,https://api.github.com/users/arthurnn/repos,https://api.github.com/users/arthurnn/events{/privacy},https://api.github.com/users/arthurnn/received_events,User,True,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
567,https://api.github.com/repos/rails/rails/issues/21058,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21058/labels{/name},https://api.github.com/repos/rails/rails/issues/21058/comments,https://api.github.com/repos/rails/rails/issues/21058/events,https://github.com/rails/rails/issues/21058,97982630,MDU6SXNzdWU5Nzk4MjYzMA==,21058,Autosaving associations ignores validate: false,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,4,2015-07-29T17:05:58Z,2018-10-22T10:12:37Z,,NONE,,"Assume I have the following code:

``` ruby
class Parent < ActiveRecord::Base
  has_many :children
end

class Child < ActiveRecord::Base
  belongs_to :parent
  validates_presence_of :name
end

parent = Parent.new(...)
child = parent.children.build(...)
parent.save(validate: false)
```

In this case `validate: false` only skips the validation for `parent` but still runs the validations on `child`. When any validation on `child` fails, only `parent` gets saved into the database while `child` gets thrown away.

**Edit:** tested with Rails 4.2.1 and 4.2.3
**Edit 2:** Together with the bug I mentioned in the comments of #20676 (scoped uniqueness validator doesn't get parent's id), this results in some very strange behavior.
",https://api.github.com/repos/rails/rails/issues/21058/timeline,,dfyx,458055,MDQ6VXNlcjQ1ODA1NQ==,https://avatars.githubusercontent.com/u/458055?v=4,,https://api.github.com/users/dfyx,https://github.com/dfyx,https://api.github.com/users/dfyx/followers,https://api.github.com/users/dfyx/following{/other_user},https://api.github.com/users/dfyx/gists{/gist_id},https://api.github.com/users/dfyx/starred{/owner}{/repo},https://api.github.com/users/dfyx/subscriptions,https://api.github.com/users/dfyx/orgs,https://api.github.com/users/dfyx/repos,https://api.github.com/users/dfyx/events{/privacy},https://api.github.com/users/dfyx/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21058/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
568,https://api.github.com/repos/rails/rails/issues/21045,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/21045/labels{/name},https://api.github.com/repos/rails/rails/issues/21045/comments,https://api.github.com/repos/rails/rails/issues/21045/events,https://github.com/rails/rails/pull/21045,97612173,MDExOlB1bGxSZXF1ZXN0NDA5NzQ0MzE=,21045,Add parameter filter capability for redirect locations,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 91966972, 'node_id': 'MDU6TGFiZWw5MTk2Njk3Mg==', 'url': 'https://api.github.com/repos/rails/rails/labels/security', 'name': 'security', 'color': 'D94A4A', 'default': False, 'description': None}]",open,False,,"[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}]",,10,2015-07-28T04:30:44Z,2021-06-30T02:14:11Z,,MEMBER,,"This is a follow up of #14055 taking in consideration @jeremy's comments.

It uses the `config.parameter_filter` to match what needs to be filtered. The result would be like this:

```
Redirected to http://secret.foo.bar?username=roque&password=[FILTERED]
```

By security default, if no filter is provided, it ~~filters all parameters~~ does not filter any parameter.

/cc @trevorturk

UPDATE: changed the default behavior.
",https://api.github.com/repos/rails/rails/issues/21045/timeline,,repinel,1685896,MDQ6VXNlcjE2ODU4OTY=,https://avatars.githubusercontent.com/u/1685896?v=4,,https://api.github.com/users/repinel,https://github.com/repinel,https://api.github.com/users/repinel/followers,https://api.github.com/users/repinel/following{/other_user},https://api.github.com/users/repinel/gists{/gist_id},https://api.github.com/users/repinel/starred{/owner}{/repo},https://api.github.com/users/repinel/subscriptions,https://api.github.com/users/repinel/orgs,https://api.github.com/users/repinel/repos,https://api.github.com/users/repinel/events{/privacy},https://api.github.com/users/repinel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/21045/reactions,0,0,0,0,0,0,0,0,0,False,https://api.github.com/repos/rails/rails/pulls/21045,https://github.com/rails/rails/pull/21045,https://github.com/rails/rails/pull/21045.diff,https://github.com/rails/rails/pull/21045.patch,,rafaelfranca,47848.0,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
569,https://api.github.com/repos/rails/rails/issues/20954,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/20954/labels{/name},https://api.github.com/repos/rails/rails/issues/20954/comments,https://api.github.com/repos/rails/rails/issues/20954/events,https://github.com/rails/rails/issues/20954,96084106,MDU6SXNzdWU5NjA4NDEwNg==,20954,ActiveRecord has_many association with dependent: :delete_all is cached when destroy is cancelled,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,6,2015-07-20T15:03:56Z,2017-09-01T16:33:54Z,,NONE,,"When a has_many association is configured with dependent delete_all, there is a bug in the way the association is cached following a delete call on the owner.

The following gist shows a simple failing case.

The expected behaviour is that if destroy fails, and rolls back the transaction (therefore rolling back the DELETE ALL) the association is not cached as empty. 

https://gist.github.com/exciton/f75f658b8ac5471abb07#file-delete_all_cached_bug
",https://api.github.com/repos/rails/rails/issues/20954/timeline,,exciton,1518068,MDQ6VXNlcjE1MTgwNjg=,https://avatars.githubusercontent.com/u/1518068?v=4,,https://api.github.com/users/exciton,https://github.com/exciton,https://api.github.com/users/exciton/followers,https://api.github.com/users/exciton/following{/other_user},https://api.github.com/users/exciton/gists{/gist_id},https://api.github.com/users/exciton/starred{/owner}{/repo},https://api.github.com/users/exciton/subscriptions,https://api.github.com/users/exciton/orgs,https://api.github.com/users/exciton/repos,https://api.github.com/users/exciton/events{/privacy},https://api.github.com/users/exciton/received_events,User,False,https://api.github.com/repos/rails/rails/issues/20954/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
570,https://api.github.com/repos/rails/rails/issues/20911,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/20911/labels{/name},https://api.github.com/repos/rails/rails/issues/20911/comments,https://api.github.com/repos/rails/rails/issues/20911/events,https://github.com/rails/rails/issues/20911,95611204,MDU6SXNzdWU5NTYxMTIwNA==,20911,after_commit order inconsistent with other callbacks ,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,16,2015-07-17T08:20:12Z,2022-01-25T19:42:55Z,,NONE,,"It seems that the commit callbacks (defined in https://github.com/rails/rails/blob/master/activerecord/lib/active_record/transactions.rb#L230) is defined differently from the rest of the callbacks (defined in https://github.com/rails/rails/blob/master/activemodel/lib/active_model/callbacks.rb#L103).

I experienced this difference in the order `after_commit` is executed. It seems that `after_*` callbacks are executed in reverse order, and `after_commit` doesn't handle this:

``` ruby
class M < ActiveRecord::Base
  before_create :a
  before_create :b
  after_create :c
  after_create :d
  after_commit :e
  after_commit :f

  def a; puts 'a'; end
  def b; puts 'b'; end
  def c; puts 'c'; end
  def d; puts 'd'; end
  def e; puts 'e'; end
  def f; puts 'f'; end
end

M._create_callbacks.select { |c| c.kind == :before }.map(&:filter)
=> [:a, :b]
M._create_callbacks.select { |c| c.kind == :after }.map(&:filter)
=> [:d, :c] # Weird behavior in after_* callbacks
M._commit_callbacks.select { |c| c.kind == :after }.map(&:filter)
=> [:e, :f]

M.create
=> a
=> b
=> c
=> d
=> f # The result of after_commit not handling the weird behavior
=> e
```

`after_*` callbacks add a default (actually, they override) `prepend: true` to the options to resolve this (see here https://github.com/rails/rails/blob/master/activemodel/lib/active_model/callbacks.rb#L139), while `after_commit` doesn't, thus the inconsistency.

The culprit seems to be the reverse execution in `after_*` callbacks and not really `after_commit`, I would say the code in `after_*` is just a patch to solve this. This patch actually prevents using the `:prepend` option in the `after_*` callbacks.

I would also change the definition of the transactions callbacks to use the same logic of the rest of the callbacks to prevent inconsistencies in the future.
",https://api.github.com/repos/rails/rails/issues/20911/timeline,,odedniv,894198,MDQ6VXNlcjg5NDE5OA==,https://avatars.githubusercontent.com/u/894198?v=4,,https://api.github.com/users/odedniv,https://github.com/odedniv,https://api.github.com/users/odedniv/followers,https://api.github.com/users/odedniv/following{/other_user},https://api.github.com/users/odedniv/gists{/gist_id},https://api.github.com/users/odedniv/starred{/owner}{/repo},https://api.github.com/users/odedniv/subscriptions,https://api.github.com/users/odedniv/orgs,https://api.github.com/users/odedniv/repos,https://api.github.com/users/odedniv/events{/privacy},https://api.github.com/users/odedniv/received_events,User,False,https://api.github.com/repos/rails/rails/issues/20911/reactions,8,8,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
571,https://api.github.com/repos/rails/rails/issues/20738,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/20738/labels{/name},https://api.github.com/repos/rails/rails/issues/20738/comments,https://api.github.com/repos/rails/rails/issues/20738/events,https://github.com/rails/rails/issues/20738,91937808,MDU6SXNzdWU5MTkzNzgwOA==,20738,Engine path helpers don't always return URLs that match routes,"[{'id': 4782967, 'node_id': 'MDU6TGFiZWw0NzgyOTY3', 'url': 'https://api.github.com/repos/rails/rails/labels/engines', 'name': 'engines', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2015-06-29T23:54:28Z,2017-02-07T19:55:21Z,,NONE,,"We have a web app that we recently converted to Rails v4.2.1 from v4.0.10.  As a result, we are having an issue where an engine that is mounted in the app isn't returning the correct URLs when the user navigates to a deeper level of the route hierarchy.

For example, there's a logout_path method that should return `/outpost/logout`.  Outpost being the name of our engine.  This works correctly when the user visits `/outpost`.

When the user visits a deeper path, say `/outpost/news_stories`, logout path instead returns `/logout` with no prefix.  This fails because our routes don't actually resolve to that path.  The same thing also seems to happen for root_path, which ends up returning ""/"" in the same circumstance.  

I've been trying to solve this issue for a long time but to no real avail.  So far, I've come across two work-arounds:
- Instead of `outpost.logout_path`, using `outpost.logout_path(script_name: 'outpost')`.  
- Monkeypatching actionpack/lib/action_dispatch/url_for.rb to ignore the same_origin and request.script_name and just use `env[""ROUTES_#{_routes.object_id}_SCRIPT_NAME""]`.

Both of those are non-solutions, IMO.

Since I am not terribly familiar with the internals of Rails, I am having difficulty easily tracking down why this happens or if this is even expected behavior(it doesn't seem like it from the docs, unless I am mistaken).  

The issue can be reproduced with this example app:
https://github.com/Ravenstine/engine-routes-problem-example

The engine it uses is called Outpost:
https://github.com/SCPR/outpost

Just `bundle install`, create/migrate the database, `rake db:seed`, and run the server. (I'm sure you know the drill anyway)

The sessions in the app don't really work, but I'm a bit rushed for time at the moment.  Though it does indeed reproduce the problem I describe.

When a user attempts to view a resources page, such as ""/outpost/news_stories"", without a session, the expected behavior is the user being redirected to ""/outpost/login"".  Instead of being redirected to ""/outpost/login"", the user is redirected to ""/login"", which fails because there is no route for it.
",https://api.github.com/repos/rails/rails/issues/20738/timeline,,Ravenstine,5193330,MDQ6VXNlcjUxOTMzMzA=,https://avatars.githubusercontent.com/u/5193330?v=4,,https://api.github.com/users/Ravenstine,https://github.com/Ravenstine,https://api.github.com/users/Ravenstine/followers,https://api.github.com/users/Ravenstine/following{/other_user},https://api.github.com/users/Ravenstine/gists{/gist_id},https://api.github.com/users/Ravenstine/starred{/owner}{/repo},https://api.github.com/users/Ravenstine/subscriptions,https://api.github.com/users/Ravenstine/orgs,https://api.github.com/users/Ravenstine/repos,https://api.github.com/users/Ravenstine/events{/privacy},https://api.github.com/users/Ravenstine/received_events,User,False,https://api.github.com/repos/rails/rails/issues/20738/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
572,https://api.github.com/repos/rails/rails/issues/20678,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/20678/labels{/name},https://api.github.com/repos/rails/rails/issues/20678/comments,https://api.github.com/repos/rails/rails/issues/20678/events,https://github.com/rails/rails/issues/20678,90504701,MDU6SXNzdWU5MDUwNDcwMQ==,20678,Subclass misses association defined on parent,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,7,2015-06-23T22:23:40Z,2016-05-12T14:43:39Z,,MEMBER,,"If an association is defined on the superclass _after_ a subclass has been given an association of its own, the subclass will have the association methods present, but calling them will raise AssociationNotFoundError.

https://gist.github.com/matthewd/8b88b7356d4076fe6a10
",https://api.github.com/repos/rails/rails/issues/20678/timeline,,matthewd,1034,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,https://api.github.com/repos/rails/rails/issues/20678/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
573,https://api.github.com/repos/rails/rails/issues/20676,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/20676/labels{/name},https://api.github.com/repos/rails/rails/issues/20676/comments,https://api.github.com/repos/rails/rails/issues/20676/events,https://github.com/rails/rails/issues/20676,90486873,MDU6SXNzdWU5MDQ4Njg3Mw==,20676,accepts_nested_attributes_for breaks the uniqueness with scope validation,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,71,2015-06-23T20:46:13Z,2022-03-15T13:59:37Z,,NONE,,"Hi All,
I think for the following configuration  accepts_nested_attributes_for + validation seems to be broken!!
Rails 4.2.1
Ruby 2.1.3

```
class Country < ActiveRecord::Base
  has_many :cities, dependent: :destroy
  accepts_nested_attributes_for :cities
end

class City < ActiveRecord::Base
  belongs_to :country
  validates :language , uniqueness: { scope: :country_id }
end

country = Country.new(description:'abc', language: 'en-US', cities:[City.new(language: 'en-US', text: 'abc'), City.new(language: 'en-US', text: 'abc')])
country.save!
```

works!!

```
c1 = City.new(language: 'en-US', text: 'abc', country_id: 1)
c1.save!

c2 = City.new(language: 'en-US', text: 'xyz', country_id: 1)
c2.save! #does not work

```

Here is executable report https://gist.github.com/spurnaye/0ab33d62dc1f12751ee0
Appreciate efforts on this!
",https://api.github.com/repos/rails/rails/issues/20676/timeline,,spurnaye,87462,MDQ6VXNlcjg3NDYy,https://avatars.githubusercontent.com/u/87462?v=4,,https://api.github.com/users/spurnaye,https://github.com/spurnaye,https://api.github.com/users/spurnaye/followers,https://api.github.com/users/spurnaye/following{/other_user},https://api.github.com/users/spurnaye/gists{/gist_id},https://api.github.com/users/spurnaye/starred{/owner}{/repo},https://api.github.com/users/spurnaye/subscriptions,https://api.github.com/users/spurnaye/orgs,https://api.github.com/users/spurnaye/repos,https://api.github.com/users/spurnaye/events{/privacy},https://api.github.com/users/spurnaye/received_events,User,False,https://api.github.com/repos/rails/rails/issues/20676/reactions,49,46,0,0,0,0,0,3,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
574,https://api.github.com/repos/rails/rails/issues/20133,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/20133/labels{/name},https://api.github.com/repos/rails/rails/issues/20133/comments,https://api.github.com/repos/rails/rails/issues/20133/events,https://github.com/rails/rails/issues/20133,75798228,MDU6SXNzdWU3NTc5ODIyOA==,20133,Do not use BASE58 for has_secure_token,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'matthewd', 'id': 1034, 'node_id': 'MDQ6VXNlcjEwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthewd', 'html_url': 'https://github.com/matthewd', 'followers_url': 'https://api.github.com/users/matthewd/followers', 'following_url': 'https://api.github.com/users/matthewd/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthewd/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthewd/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthewd/subscriptions', 'organizations_url': 'https://api.github.com/users/matthewd/orgs', 'repos_url': 'https://api.github.com/users/matthewd/repos', 'events_url': 'https://api.github.com/users/matthewd/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthewd/received_events', 'type': 'User', 'site_admin': True}]",,13,2015-05-13T01:03:30Z,2020-04-06T17:57:55Z,,CONTRIBUTOR,,"With this commit https://github.com/rails/rails/commit/47316feee0f061f80e26c51fb0d41f537407ab9c , `SecureRandom.hex` is replaced with `SecureRandom.base58` but I'd point out problems with it.
- By default, MySQL uses case-insensitive collation like `utf8_general_ci`. Which means, `4kUgL2pdQMSCQtjE` and `4KUGL2PDQMSCQTJE` are considered **the same token** even with a unique index.
  - Which not only means that added entropy by case-sensitivity is useless (it is now equivalent to base35), but that could potentially bring in an attack vector.
  - If we want to support any case-sensitive encodings (base58, base62, etc.), we need to specify `t.column  :token, 'VARCHAR(24) CHARACTER SET utf8 COLLATE utf8_bin'` in migrations, which I don't think is realistic.
- Base58 works best when it is a ""public"" address that can be read by human and orally spelled. I don't think secure_token is or should be. If the goal is to make the best use of string length, there are less controversial options like Base62 or Base64, but I don't think Base58 makes sense.

I would revert to `SecureRandom.hex` for compatibility with MySQL.

Let me know if I should create a PR for this.
",https://api.github.com/repos/rails/rails/issues/20133/timeline,,kenn,10350,MDQ6VXNlcjEwMzUw,https://avatars.githubusercontent.com/u/10350?v=4,,https://api.github.com/users/kenn,https://github.com/kenn,https://api.github.com/users/kenn/followers,https://api.github.com/users/kenn/following{/other_user},https://api.github.com/users/kenn/gists{/gist_id},https://api.github.com/users/kenn/starred{/owner}{/repo},https://api.github.com/users/kenn/subscriptions,https://api.github.com/users/kenn/orgs,https://api.github.com/users/kenn/repos,https://api.github.com/users/kenn/events{/privacy},https://api.github.com/users/kenn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/20133/reactions,3,3,0,0,0,0,0,0,0,,,,,,,matthewd,1034.0,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
575,https://api.github.com/repos/rails/rails/issues/19873,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/19873/labels{/name},https://api.github.com/repos/rails/rails/issues/19873/comments,https://api.github.com/repos/rails/rails/issues/19873/events,https://github.com/rails/rails/issues/19873,70385194,MDU6SXNzdWU3MDM4NTE5NA==,19873,Please do check if group value is not empty,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,18,2015-04-23T11:25:36Z,2015-12-23T16:54:07Z,,NONE,,"If somehow query method group is being called with nil param this value goes to group_values and then sql built with ActiveRecord::Calculations.execute_grouped_calculation breaks up

check code like this: Model.group('id').group(nil).count

quick fix is

(""#{field} AS #{aliaz}"" if field and aliaz) in ActiveRecord::Calculations line 312 
",https://api.github.com/repos/rails/rails/issues/19873/timeline,,parol-peter,11058548,MDQ6VXNlcjExMDU4NTQ4,https://avatars.githubusercontent.com/u/11058548?v=4,,https://api.github.com/users/parol-peter,https://github.com/parol-peter,https://api.github.com/users/parol-peter/followers,https://api.github.com/users/parol-peter/following{/other_user},https://api.github.com/users/parol-peter/gists{/gist_id},https://api.github.com/users/parol-peter/starred{/owner}{/repo},https://api.github.com/users/parol-peter/subscriptions,https://api.github.com/users/parol-peter/orgs,https://api.github.com/users/parol-peter/repos,https://api.github.com/users/parol-peter/events{/privacy},https://api.github.com/users/parol-peter/received_events,User,False,https://api.github.com/repos/rails/rails/issues/19873/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
576,https://api.github.com/repos/rails/rails/issues/19863,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/19863/labels{/name},https://api.github.com/repos/rails/rails/issues/19863/comments,https://api.github.com/repos/rails/rails/issues/19863/events,https://github.com/rails/rails/issues/19863,70231462,MDU6SXNzdWU3MDIzMTQ2Mg==,19863,Weird handling of nested association error messages when assigned to :base attribute,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 41328116, 'node_id': 'MDU6TGFiZWw0MTMyODExNg==', 'url': 'https://api.github.com/repos/rails/rails/labels/attached%20PR', 'name': 'attached PR', 'color': '006b75', 'default': False, 'description': None}]",open,False,,[],,8,2015-04-22T20:50:41Z,2018-12-14T00:13:53Z,,NONE,,"Typically when an error is assigned to the :base attribute the message will not be prepended with the humanized class name. In the case of associations where a child class assigns an error to :base and the parent attempts to save the item the child item will instead return the error in the format: ""{Child class} base {message}"".

Contrived Example

``` ruby
class Container < ActiveRecord::Base
  has_many :items
  accepts_nested_attributes_for :items
end

class Item < ActiveRecord::Base
  belongs_to :containers

  validate do |item|
    item.errors.add(:base, 'An item must have a name.') unless item.name?
  end
end

c = Container.new(name: 'Magic Box')
c.items << Item.new
c.save
c.errors
c.errors.full_messages
```

Output

``` text
irb(main):016:0> c = Container.new(name: 'Magic Box')
=> #<Container id: nil, name: ""Magic Box"", created_at: nil, updated_at: nil>
irb(main):017:0> c.items << Item.new
=> #<ActiveRecord::Associations::CollectionProxy [#<Item id: nil, name: nil, created_at: nil, updated_at: nil, container_id: nil>]>
irb(main):018:0> c.save
   (0.1ms)  begin transaction
   (0.1ms)  rollback transaction
=> false
irb(main):019:0> c.errors
=> #<ActiveModel::Errors:0x0000010b019aa8 @base=#<Container id: nil, name: ""Magic Box"", created_at: nil, updated_at: nil>, @messages={:""items.base""=>[""An item must have a name.""]}>
irb(main):020:0> c.errors.full_messages
=> [""Items base An item must have a name.""]
irb(main):021:0> 
```

I believe this can be corrected by a small change to ActiveRecord::AutosaveAssociation::association_valid?:

``` ruby
attribute = ""#{reflection.name}.#{attribute}""
```

becomes

``` ruby
attribute = ""#{reflection.name}.#{attribute}"" unless attribute == :base
```

Though I'm not sure whether there would be unanticipated effects from this change or whether the existing behavior is intended for some reason.
",https://api.github.com/repos/rails/rails/issues/19863/timeline,,ramsdenct,4220511,MDQ6VXNlcjQyMjA1MTE=,https://avatars.githubusercontent.com/u/4220511?v=4,,https://api.github.com/users/ramsdenct,https://github.com/ramsdenct,https://api.github.com/users/ramsdenct/followers,https://api.github.com/users/ramsdenct/following{/other_user},https://api.github.com/users/ramsdenct/gists{/gist_id},https://api.github.com/users/ramsdenct/starred{/owner}{/repo},https://api.github.com/users/ramsdenct/subscriptions,https://api.github.com/users/ramsdenct/orgs,https://api.github.com/users/ramsdenct/repos,https://api.github.com/users/ramsdenct/events{/privacy},https://api.github.com/users/ramsdenct/received_events,User,False,https://api.github.com/repos/rails/rails/issues/19863/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
577,https://api.github.com/repos/rails/rails/issues/19614,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/19614/labels{/name},https://api.github.com/repos/rails/rails/issues/19614/comments,https://api.github.com/repos/rails/rails/issues/19614/events,https://github.com/rails/rails/issues/19614,65746883,MDU6SXNzdWU2NTc0Njg4Mw==,19614,Inverse association is not being set before after_create,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,4,2015-04-01T18:16:55Z,2016-01-22T08:00:09Z,,NONE,,"In some cases, explicitly specifying an inverse relationship causes associations to be missing in `after_create` callbacks.  Take the following example:

``` ruby
class User < ActiveRecord::Base
end

class AdminUser < User
  has_one :profile, foreign_key: :user_id, inverse_of: :user
end

class Profile < ActiveRecord::Base
  belongs_to :user, inverse_of: :profile, class_name: AdminUser
  after_create :do_some_post_processing

  cattr_accessor :instance_for_testing

  def do_some_post_processing
    self.class.instance_for_testing = self.user.profile
  end
end
```

The following test will fail:

``` ruby
  test ""inverse relationship works as expected"" do
    user = AdminUser.create!
    user.profile = Profile.new
    assert_equal user.profile, Profile.instance_for_testing
  end
```

because `user.profile` is `nil` when `do_some_post_processing` is called.  **But,** if we remove `inverse_of: :user` from AdminUser and remove `inverse_of: :profile, class_name: AdminUser` from Profile, then the test will pass.

This looks somewhat similar to #9157, but the corresponding PR does not resolve this issue.  Confirmed the behavior on Rails 4.0.13 and 4.2.1.
",https://api.github.com/repos/rails/rails/issues/19614/timeline,,afn,2779422,MDQ6VXNlcjI3Nzk0MjI=,https://avatars.githubusercontent.com/u/2779422?v=4,,https://api.github.com/users/afn,https://github.com/afn,https://api.github.com/users/afn/followers,https://api.github.com/users/afn/following{/other_user},https://api.github.com/users/afn/gists{/gist_id},https://api.github.com/users/afn/starred{/owner}{/repo},https://api.github.com/users/afn/subscriptions,https://api.github.com/users/afn/orgs,https://api.github.com/users/afn/repos,https://api.github.com/users/afn/events{/privacy},https://api.github.com/users/afn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/19614/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
578,https://api.github.com/repos/rails/rails/issues/19548,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/19548/labels{/name},https://api.github.com/repos/rails/rails/issues/19548/comments,https://api.github.com/repos/rails/rails/issues/19548/events,https://github.com/rails/rails/issues/19548,64759550,MDU6SXNzdWU2NDc1OTU1MA==,19548,Possible circular references bug,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,14,2015-03-27T13:11:05Z,2021-07-12T19:41:50Z,,NONE,,"UPDATE: Code to reproduce the problem is in comments

I have a Rails project with the following models:

```
account
username
user
address
```

With the following associations:

```
class Account < ActiveRecord::Base
  has_many :users, :inverse_of => :account
  has_many :addresses, :inverse_of => :account
  has_many :usernames, :inverse_of => :account

  accepts_nested_attributes_for :usernames
  accepts_nested_attributes_for :users
  accepts_nested_attributes_for :addresses
end

class Username < ActiveRecord::Base
  belongs_to :account
end

class User < ActiveRecord::Base
  belongs_to :account
  belongs_to :username
end

class Address < ActiveRecord::Base
  belongs_to :account
end
```

I build a new account:

```
account = Account.new(params.require(:account).permit(
    usernames_attributes: [:username], 
    users_attributes: [:password, :firstname, :lastname, :phone, :mobile, :fax],
    addresses_attributes: [:address_line_1, :address_line_2, :city, :zipcode, :state, :country]))
```

which validates and **saves** fine under Rails 4.2.0, however with Rails 4.2.1 I get the following error returned from PostgreSQL:

```
 ActiveRecord::StatementInvalid:
   PG::NotNullViolation: ERROR:  null value in column ""account_id"" violates not-null constraint
```

The error is on the `username` model when trying to save it. Seems like the reference to the `account` is missing when saving.
",https://api.github.com/repos/rails/rails/issues/19548/timeline,,nesrual,726682,MDQ6VXNlcjcyNjY4Mg==,https://avatars.githubusercontent.com/u/726682?v=4,,https://api.github.com/users/nesrual,https://github.com/nesrual,https://api.github.com/users/nesrual/followers,https://api.github.com/users/nesrual/following{/other_user},https://api.github.com/users/nesrual/gists{/gist_id},https://api.github.com/users/nesrual/starred{/owner}{/repo},https://api.github.com/users/nesrual/subscriptions,https://api.github.com/users/nesrual/orgs,https://api.github.com/users/nesrual/repos,https://api.github.com/users/nesrual/events{/privacy},https://api.github.com/users/nesrual/received_events,User,False,https://api.github.com/repos/rails/rails/issues/19548/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
579,https://api.github.com/repos/rails/rails/issues/19517,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/19517/labels{/name},https://api.github.com/repos/rails/rails/issues/19517/comments,https://api.github.com/repos/rails/rails/issues/19517/events,https://github.com/rails/rails/issues/19517,64327658,MDU6SXNzdWU2NDMyNzY1OA==,19517,Invalid objects pass validations when using validates_associated but correctly fail when validated directly,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,3,2015-03-25T17:33:46Z,2015-08-11T07:42:09Z,,NONE,,"Parent model is `Competitor`

``` ruby
has_many :players, class_name: 'Competitor::Player'
validates_associated :players
```

Child model is `Competitor::Player`

``` ruby
belongs_to :competitor
validate :one_per_playable
```

Given an array of user_ids to compare against `[1, 2, 3]` and a new player with the `user_id` of 2:

``` ruby
player = Competitor::Player.new(user_id: 2, ...)
player.valid?
# => false
```

When saving the model via nested attributes under the same conditions:

``` ruby
competitor.players.build(user_id: 2, ...)
competitor.valid?
# => true
competitor.players.last.valid?
# => true
```
",https://api.github.com/repos/rails/rails/issues/19517/timeline,,davidpaulhunt,6889054,MDQ6VXNlcjY4ODkwNTQ=,https://avatars.githubusercontent.com/u/6889054?v=4,,https://api.github.com/users/davidpaulhunt,https://github.com/davidpaulhunt,https://api.github.com/users/davidpaulhunt/followers,https://api.github.com/users/davidpaulhunt/following{/other_user},https://api.github.com/users/davidpaulhunt/gists{/gist_id},https://api.github.com/users/davidpaulhunt/starred{/owner}{/repo},https://api.github.com/users/davidpaulhunt/subscriptions,https://api.github.com/users/davidpaulhunt/orgs,https://api.github.com/users/davidpaulhunt/repos,https://api.github.com/users/davidpaulhunt/events{/privacy},https://api.github.com/users/davidpaulhunt/received_events,User,False,https://api.github.com/repos/rails/rails/issues/19517/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
580,https://api.github.com/repos/rails/rails/issues/19318,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/19318/labels{/name},https://api.github.com/repos/rails/rails/issues/19318/comments,https://api.github.com/repos/rails/rails/issues/19318/events,https://github.com/rails/rails/issues/19318,61031158,MDU6SXNzdWU2MTAzMTE1OA==,19318,AR attribute lookup performed incorrectly if records are instantiated from cache,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2015-03-13T10:24:56Z,2015-08-25T05:55:32Z,,NONE,,"Background: A table named **people** with columns **format** and **name**, along with a corresponding ActiveRecord model and a sample row in the table.

STR:
1) Open up rails console and execute `Rails.cache.fetch('whatever') { Person.all.load }`. This will return all people and generate the cache entry.
2) Quit and open rails console again
3) Execute `Rails.cache.fetch('whatever') { Person.all.load }[0].name`. You will get the sample name back
4) Execute `Rails.cache.fetch('whatever') { Person.all.load }[0].format`. You will get **NoMethodError: private method `format' called for ...**
5) If you then execute `Person.new`, step 4 will work as expected
This is probably related to the fact that `format` is a method in `Kernel`, so I suppose something goes wrong with the AR lookup chain
",https://api.github.com/repos/rails/rails/issues/19318/timeline,,enthrops,3745935,MDQ6VXNlcjM3NDU5MzU=,https://avatars.githubusercontent.com/u/3745935?v=4,,https://api.github.com/users/enthrops,https://github.com/enthrops,https://api.github.com/users/enthrops/followers,https://api.github.com/users/enthrops/following{/other_user},https://api.github.com/users/enthrops/gists{/gist_id},https://api.github.com/users/enthrops/starred{/owner}{/repo},https://api.github.com/users/enthrops/subscriptions,https://api.github.com/users/enthrops/orgs,https://api.github.com/users/enthrops/repos,https://api.github.com/users/enthrops/events{/privacy},https://api.github.com/users/enthrops/received_events,User,False,https://api.github.com/repos/rails/rails/issues/19318/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
581,https://api.github.com/repos/rails/rails/issues/19084,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/19084/labels{/name},https://api.github.com/repos/rails/rails/issues/19084/comments,https://api.github.com/repos/rails/rails/issues/19084/events,https://github.com/rails/rails/issues/19084,59001146,MDU6SXNzdWU1OTAwMTE0Ng==,19084,"Thread bug with Rails::Engine mounted routes, undefined method `url_options'","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 4782967, 'node_id': 'MDU6TGFiZWw0NzgyOTY3', 'url': 'https://api.github.com/repos/rails/rails/labels/engines', 'name': 'engines', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,21,2015-02-26T01:15:31Z,2016-02-05T11:49:28Z,,CONTRIBUTOR,,"This issue occurs randomly in production, as it's a multi-threading problem. This is very related to https://github.com/puma/puma/issues/647, and the underlying MRI bug https://bugs.ruby-lang.org/issues/10871.

I'm using a mounted engine, rails_admin, and I get the following exception frequently in one of my views, in which I have `rails_admin.show_path(model_name: 'dummy', id: 123)`.

```
ActionView::Template::Error: undefined method `url_options' for #<Module:0x007f432e67dc20>
action_dispatch/routing/route_set.rb:271:in `call'
    controller_options = t.url_options
  action_dispatch/routing/route_set.rb:222:in `call'
    super
  action_dispatch/routing/route_set.rb:334:in `block (2 levels) in define_url_helper'
    helper.call self, args, options
  action_dispatch/routing/mapper.rb:637:in `block (2 levels) in define_generate_prefix'
    _routes.url_helpers.send(""#{name}_path"", prefix_options)
  action_dispatch/routing/route_set.rb:775:in `url_for'
    script_name = find_script_name options
  action_dispatch/routing/route_set.rb:279:in `call'
    t._routes.url_for(hash, route_name, url_strategy)
  action_dispatch/routing/route_set.rb:222:in `call'
    super
  action_dispatch/routing/route_set.rb:334:in `block (2 levels) in define_url_helper'
    helper.call self, args, options
...
```

I have isolated the problem with a reproducible test script and example output here:
https://gist.github.com/sbull/78eb41fdfd0460f5ce80#file-route_helpers_debug-rb

I am able to work around thread problems with the use of Rails.application.routes.url_helpers in other contexts in my app, but I haven't yet found a way to workaround this problem with routes for mounted engines. Hopefully there's a way for these mounted url helpers to work around the underlying bug in MRI.

/cc @evanphx, /cc @tenderlove (due to involvement in previous issue)
",https://api.github.com/repos/rails/rails/issues/19084/timeline,,sbull,1115369,MDQ6VXNlcjExMTUzNjk=,https://avatars.githubusercontent.com/u/1115369?v=4,,https://api.github.com/users/sbull,https://github.com/sbull,https://api.github.com/users/sbull/followers,https://api.github.com/users/sbull/following{/other_user},https://api.github.com/users/sbull/gists{/gist_id},https://api.github.com/users/sbull/starred{/owner}{/repo},https://api.github.com/users/sbull/subscriptions,https://api.github.com/users/sbull/orgs,https://api.github.com/users/sbull/repos,https://api.github.com/users/sbull/events{/privacy},https://api.github.com/users/sbull/received_events,User,False,https://api.github.com/repos/rails/rails/issues/19084/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
582,https://api.github.com/repos/rails/rails/issues/18818,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/18818/labels{/name},https://api.github.com/repos/rails/rails/issues/18818/comments,https://api.github.com/repos/rails/rails/issues/18818/events,https://github.com/rails/rails/issues/18818,56625554,MDU6SXNzdWU1NjYyNTU1NA==,18818,Allow variants to be set through the URL,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,13,2015-02-05T04:15:45Z,2021-09-03T20:07:17Z,,MEMBER,,"Accessing http://example.com/posts.html+partial should set both `format: :html` and `variant: :partial` automatically. This will make it easier to supply multiple variants of the same format without needing before filters to determine the variant.
",https://api.github.com/repos/rails/rails/issues/18818/timeline,,dhh,2741,MDQ6VXNlcjI3NDE=,https://avatars.githubusercontent.com/u/2741?v=4,,https://api.github.com/users/dhh,https://github.com/dhh,https://api.github.com/users/dhh/followers,https://api.github.com/users/dhh/following{/other_user},https://api.github.com/users/dhh/gists{/gist_id},https://api.github.com/users/dhh/starred{/owner}{/repo},https://api.github.com/users/dhh/subscriptions,https://api.github.com/users/dhh/orgs,https://api.github.com/users/dhh/repos,https://api.github.com/users/dhh/events{/privacy},https://api.github.com/users/dhh/received_events,User,False,https://api.github.com/repos/rails/rails/issues/18818/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
583,https://api.github.com/repos/rails/rails/issues/18667,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/18667/labels{/name},https://api.github.com/repos/rails/rails/issues/18667/comments,https://api.github.com/repos/rails/rails/issues/18667/events,https://github.com/rails/rails/issues/18667,55346371,MDU6SXNzdWU1NTM0NjM3MQ==,18667,self-referential templates blow up rake task but not server,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,11,2015-01-23T23:25:43Z,2015-06-26T03:50:34Z,,CONTRIBUTOR,,"I have two partials which refer to one another. When I calculate nested dependencies in the console like so:

``` ruby
finder = ApplicationController.new.lookup_context
ActionView::Digestor.new(name: ""posts/show"", finder: finder).nested_dependencies
```

or via the rake task like so:

``` console
rake cache_digests:nested_dependencies TEMPLATE=posts/show
```

I get a short list of initial dependencies, and then this in an infinite loop, until the ruby stack is full (I have some debug code outputting which template is being loaded):

```
...
>>>>>>> users/foo
>>>>>>> users/bar
>>>>>>> users/baz
>>>>>>> users/bip
>>>>>>> users/foo
>>>>>>> users/bar
>>>>>>> users/baz
>>>>>>> users/bip
SystemStackError: stack level too deep
```

However, when I run the app server and request the template, things run just fine, no infinite loops.

Here are my settings in all of the above cases:

``` ruby
config.action_controller.perform_caching = true
config.cache_store = :file_store, Rails.root.to_s + '/tmp/cache/stuff'
ActionView::Base.cache_template_loading = true
```

The code indicates that it does have recursive reference protection: https://github.com/rails/rails/blob/v4.1.8/actionview/lib/action_view/digestor.rb#L35

I'm not really groking that code. It seems like the recursive reference protection is working in the server environment but not in console or the rake task.

(also a SO question http://stackoverflow.com/questions/28018187)
",https://api.github.com/repos/rails/rails/issues/18667/timeline,,jjb,6097,MDQ6VXNlcjYwOTc=,https://avatars.githubusercontent.com/u/6097?v=4,,https://api.github.com/users/jjb,https://github.com/jjb,https://api.github.com/users/jjb/followers,https://api.github.com/users/jjb/following{/other_user},https://api.github.com/users/jjb/gists{/gist_id},https://api.github.com/users/jjb/starred{/owner}{/repo},https://api.github.com/users/jjb/subscriptions,https://api.github.com/users/jjb/orgs,https://api.github.com/users/jjb/repos,https://api.github.com/users/jjb/events{/privacy},https://api.github.com/users/jjb/received_events,User,False,https://api.github.com/repos/rails/rails/issues/18667/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
584,https://api.github.com/repos/rails/rails/issues/18073,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/18073/labels{/name},https://api.github.com/repos/rails/rails/issues/18073/comments,https://api.github.com/repos/rails/rails/issues/18073/events,https://github.com/rails/rails/issues/18073,52267998,MDU6SXNzdWU1MjI2Nzk5OA==,18073,"""rails generate plugin gems/engine --full"" fails at vendor_app test/dummy","[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2014-12-17T17:31:19Z,2016-03-07T10:59:45Z,,NONE,,"# inside a new rails named ""app""

$ rails generate plugin gems/engine --full
      create
      create  README.rdoc
...
  vendor_app  test/dummy
Invalid application name app, constant App is already in use. Please choose another application name.
",https://api.github.com/repos/rails/rails/issues/18073/timeline,,sanderhahn,775103,MDQ6VXNlcjc3NTEwMw==,https://avatars.githubusercontent.com/u/775103?v=4,,https://api.github.com/users/sanderhahn,https://github.com/sanderhahn,https://api.github.com/users/sanderhahn/followers,https://api.github.com/users/sanderhahn/following{/other_user},https://api.github.com/users/sanderhahn/gists{/gist_id},https://api.github.com/users/sanderhahn/starred{/owner}{/repo},https://api.github.com/users/sanderhahn/subscriptions,https://api.github.com/users/sanderhahn/orgs,https://api.github.com/users/sanderhahn/repos,https://api.github.com/users/sanderhahn/events{/privacy},https://api.github.com/users/sanderhahn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/18073/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
585,https://api.github.com/repos/rails/rails/issues/17887,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17887/labels{/name},https://api.github.com/repos/rails/rails/issues/17887/comments,https://api.github.com/repos/rails/rails/issues/17887/events,https://github.com/rails/rails/issues/17887,50714366,MDU6SXNzdWU1MDcxNDM2Ng==,17887,Wrong instance object passed to lambda on has_one :through,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,7,2014-12-02T20:27:25Z,2016-04-07T16:57:39Z,,NONE,,"UPDATE: Checked against latest master (April 2016). Still an issue. Updated bug template and output below. Also simplified the issue to 3 classes with associations.

See the active_record_master.rb test below for details. You have a has_many :through and a lambda (class A.) Another object attempts to access that relationship through another has_many (class C.)

The result is an instance of class B getting passed into the lambda.

The _expected_ result would be an instance of _class A_ getting passed into the lambda.

**active_record_master.rb**

``` ruby
begin
  require 'bundler/inline'
rescue LoadError => e
  $stderr.puts 'Bundler version 1.10 or later is required. Please update your Bundler'
  raise e
end

gemfile(true) do
  source 'https://rubygems.org'
  gem 'rails', github: 'rails/rails'
  gem 'arel', github: 'rails/arel'
  gem 'sqlite3'
end

require 'active_record'
require 'minitest/autorun'
require 'logger'

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :as do |t|
    t.integer :b_id
    t.string :a_value
  end

  create_table :bs do |t|
    t.string :b_value
  end

  create_table :cs do |t|
    t.integer :a_id
    t.string :c_value
  end
end

class A < ActiveRecord::Base
  belongs_to :b
  has_one :c, ->(a) { where(c_value: a.a_value) }
end

class B < ActiveRecord::Base
  has_one :a
  has_one :c, through: :a
end

class C < ActiveRecord::Base
  belongs_to :a
end


class BugTest < Minitest::Test
  def test_has_many_through_proc
    b = B.create!
    a = A.create!(b: b)

    assert_equal a.c, b.c
  end
end
```

**output**

```
  1) Error:
BugTest#test_has_many_through_proc:
NoMethodError: undefined method `a_value' for #<B id: 1, b_value: nil>
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activemodel/lib/active_model/attribute_methods.rb:433:in `method_missing'
    active_record_master.rb:41:in `block in <class:A>'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:162:in `instance_exec'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:162:in `eval_scope'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:140:in `block (2 levels) in add_constraints'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:139:in `each'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:139:in `block in add_constraints'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:127:in `loop'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:127:in `add_constraints'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:28:in `scope'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association_scope.rb:5:in `scope'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association.rb:97:in `association_scope'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association.rb:86:in `scope'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/singular_association.rb:48:in `get_records'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/singular_association.rb:63:in `find_target'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association.rb:138:in `load_target'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/association.rb:53:in `reload'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/singular_association.rb:15:in `reader'
    /Users/haruska/.rbenv/versions/2.2.2/lib/ruby/gems/2.2.0/bundler/gems/rails-4440df10a051/activerecord/lib/active_record/associations/builder/association.rb:111:in `c'
    active_record_master.rb:60:in `test_has_many_through_proc'
```
",https://api.github.com/repos/rails/rails/issues/17887/timeline,,haruska,2803,MDQ6VXNlcjI4MDM=,https://avatars.githubusercontent.com/u/2803?v=4,,https://api.github.com/users/haruska,https://github.com/haruska,https://api.github.com/users/haruska/followers,https://api.github.com/users/haruska/following{/other_user},https://api.github.com/users/haruska/gists{/gist_id},https://api.github.com/users/haruska/starred{/owner}{/repo},https://api.github.com/users/haruska/subscriptions,https://api.github.com/users/haruska/orgs,https://api.github.com/users/haruska/repos,https://api.github.com/users/haruska/events{/privacy},https://api.github.com/users/haruska/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17887/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
586,https://api.github.com/repos/rails/rails/issues/17706,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17706/labels{/name},https://api.github.com/repos/rails/rails/issues/17706/comments,https://api.github.com/repos/rails/rails/issues/17706/events,https://github.com/rails/rails/issues/17706,49742287,MDU6SXNzdWU0OTc0MjI4Nw==,17706,Activerecord DISTINCT ON for json data type in postgresql,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 70310659, 'node_id': 'MDU6TGFiZWw3MDMxMDY1OQ==', 'url': 'https://api.github.com/repos/rails/rails/labels/PostgreSQL', 'name': 'PostgreSQL', 'color': 'fbca04', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'matthewd', 'id': 1034, 'node_id': 'MDQ6VXNlcjEwMzQ=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1034?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/matthewd', 'html_url': 'https://github.com/matthewd', 'followers_url': 'https://api.github.com/users/matthewd/followers', 'following_url': 'https://api.github.com/users/matthewd/following{/other_user}', 'gists_url': 'https://api.github.com/users/matthewd/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/matthewd/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/matthewd/subscriptions', 'organizations_url': 'https://api.github.com/users/matthewd/orgs', 'repos_url': 'https://api.github.com/users/matthewd/repos', 'events_url': 'https://api.github.com/users/matthewd/events{/privacy}', 'received_events_url': 'https://api.github.com/users/matthewd/received_events', 'type': 'User', 'site_admin': True}]",,18,2014-11-21T20:05:24Z,2022-02-17T15:37:12Z,,NONE,,"When a field on postgres is json type, and you make a call to uniq or distinct, the query generates SELECT DISTINCT <sql expression> but in order to work with json type on postgres it should be SELECT DISTINCT ON (<sql expression>), Also you can check more details [here](http://stackoverflow.com/questions/23509740/distinct-on-postgresql-json-data-column)
",https://api.github.com/repos/rails/rails/issues/17706/timeline,,3zcurdia,214138,MDQ6VXNlcjIxNDEzOA==,https://avatars.githubusercontent.com/u/214138?v=4,,https://api.github.com/users/3zcurdia,https://github.com/3zcurdia,https://api.github.com/users/3zcurdia/followers,https://api.github.com/users/3zcurdia/following{/other_user},https://api.github.com/users/3zcurdia/gists{/gist_id},https://api.github.com/users/3zcurdia/starred{/owner}{/repo},https://api.github.com/users/3zcurdia/subscriptions,https://api.github.com/users/3zcurdia/orgs,https://api.github.com/users/3zcurdia/repos,https://api.github.com/users/3zcurdia/events{/privacy},https://api.github.com/users/3zcurdia/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17706/reactions,0,0,0,0,0,0,0,0,0,,,,,,,matthewd,1034.0,MDQ6VXNlcjEwMzQ=,https://avatars.githubusercontent.com/u/1034?v=4,,https://api.github.com/users/matthewd,https://github.com/matthewd,https://api.github.com/users/matthewd/followers,https://api.github.com/users/matthewd/following{/other_user},https://api.github.com/users/matthewd/gists{/gist_id},https://api.github.com/users/matthewd/starred{/owner}{/repo},https://api.github.com/users/matthewd/subscriptions,https://api.github.com/users/matthewd/orgs,https://api.github.com/users/matthewd/repos,https://api.github.com/users/matthewd/events{/privacy},https://api.github.com/users/matthewd/received_events,User,True,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
587,https://api.github.com/repos/rails/rails/issues/17621,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17621/labels{/name},https://api.github.com/repos/rails/rails/issues/17621/comments,https://api.github.com/repos/rails/rails/issues/17621/events,https://github.com/rails/rails/issues/17621,48807669,MDU6SXNzdWU0ODgwNzY2OQ==,17621,AR is erroneously validating existing records on a has_many :through,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,12,2014-11-14T16:17:16Z,2020-07-30T12:56:29Z,,CONTRIBUTOR,,"Its Friday, so entirely possible I just need a drink and some sleep. But after upgrading a legacy app to the latest and greatest, I've started to see unexpected validations when creating new records with existing associations on a `has_many :through`.

See attached gist: https://gist.github.com/uberllama/1d0323438700d4f23bbb

I have a Conversation class, which has many `:users` through `:conversation_users`. When a user creates a new Conversation, they specify which Users they want to include in the Conversation. This boils down to:

``` ruby
class Conversation < ActiveRecord::Base
  has_many :conversation_users
  has_many :users, through: :conversation_users
end

class ConversationUser < ActiveRecord::Base
  belongs_to :conversation
  belongs_to :user
end

class User < ActiveRecord::Base
  has_many :conversation_users
  has_many :conversations, through: :conversation_users
  validates :name, presence: true
end

conversation = Conversation.new(user_ids: [1,2,3])
conversation.save
```

When calling `save` on the new Conversation instance, AR is validating the associated Users even though they are existing, non-dirty objects. This results in huge amounts of unnecessary weight on every Conversation save. It should not be the responsibility of a model to validate its associated objects unless those objects are being created or modified along with the parent model.

What am I missing? 
",https://api.github.com/repos/rails/rails/issues/17621/timeline,,uberllama,109640,MDQ6VXNlcjEwOTY0MA==,https://avatars.githubusercontent.com/u/109640?v=4,,https://api.github.com/users/uberllama,https://github.com/uberllama,https://api.github.com/users/uberllama/followers,https://api.github.com/users/uberllama/following{/other_user},https://api.github.com/users/uberllama/gists{/gist_id},https://api.github.com/users/uberllama/starred{/owner}{/repo},https://api.github.com/users/uberllama/subscriptions,https://api.github.com/users/uberllama/orgs,https://api.github.com/users/uberllama/repos,https://api.github.com/users/uberllama/events{/privacy},https://api.github.com/users/uberllama/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17621/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
588,https://api.github.com/repos/rails/rails/issues/17599,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17599/labels{/name},https://api.github.com/repos/rails/rails/issues/17599/comments,https://api.github.com/repos/rails/rails/issues/17599/events,https://github.com/rails/rails/issues/17599,48559831,MDU6SXNzdWU0ODU1OTgzMQ==,17599,Two association records created for has_many through,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,15,2014-11-12T20:42:49Z,2019-12-21T10:34:43Z,,NONE,,"I'd like to revisit issue #3798.  In this issue, @rafaelfranca offers the following recommendation

> I don't think this is an issue. Associations defines callbacks. Callback order is important since they are executed in the correct order. That said you should not place callbacks before the associations. This is even [documented](https://github.com/rails/rails/blob/31bfcdc77ca0d8cec9b5fe513bdc6f05814dd4f1/activerecord/lib/active_record/associations.rb#L1222-1227)

I believe I have come up with an example where the callback is defined after the associations as Rafael recommends, but the problem is still occurring.  In this case, is there a valid workaround, or is this buggy behavior?

``` ruby
class Audit < ActiveRecord::Base
end
class AuditAssignment < ActiveRecord::Base
  belongs_to :audit
  belongs_to :item, polymorphic: true
end
class Group < ActiveRecord::Base
  has_many :roles
  has_many :users, through: :roles
end
class Role < ActiveRecord::Base
  belongs_to :user
  belongs_to :group

  after_create :audit_creation
  def audit_creation
    a = Audit.new(message: ""User added to group"")
    self.user.audits << a
  end
end
class User < ActiveRecord::Base
  has_many :roles
  has_many :groups, through: :roles
  has_many :audits, through: :audit_assignments
  has_many :audit_assignments, -> {where(item_type: 'User')}, foreign_key: :item_id
end
```

Given this model, the following test will fail:

``` ruby
test ""creates only one audit assignment"" do
    g = Group.create(name: ""Administrators"")
    u = User.new(name: ""Admin"", groups: [g])
    u.save
    assert AuditAssignment.count == 1
  end
```

Notice the after_create hook of AuditAssignment is placed after all associations in that class.

I have reproduced the problem in a [minimal Rails project](https://github.com/daveroberts/double_user_group), based on 4.1.7, that has a single failing test.
",https://api.github.com/repos/rails/rails/issues/17599/timeline,,daveroberts,42104,MDQ6VXNlcjQyMTA0,https://avatars.githubusercontent.com/u/42104?v=4,,https://api.github.com/users/daveroberts,https://github.com/daveroberts,https://api.github.com/users/daveroberts/followers,https://api.github.com/users/daveroberts/following{/other_user},https://api.github.com/users/daveroberts/gists{/gist_id},https://api.github.com/users/daveroberts/starred{/owner}{/repo},https://api.github.com/users/daveroberts/subscriptions,https://api.github.com/users/daveroberts/orgs,https://api.github.com/users/daveroberts/repos,https://api.github.com/users/daveroberts/events{/privacy},https://api.github.com/users/daveroberts/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17599/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
589,https://api.github.com/repos/rails/rails/issues/17565,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17565/labels{/name},https://api.github.com/repos/rails/rails/issues/17565/comments,https://api.github.com/repos/rails/rails/issues/17565/events,https://github.com/rails/rails/issues/17565,48206484,MDU6SXNzdWU0ODIwNjQ4NA==,17565,ActionView Erubis rendering is ten times slower than plain Erubis,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'rafaelfranca', 'id': 47848, 'node_id': 'MDQ6VXNlcjQ3ODQ4', 'avatar_url': 'https://avatars.githubusercontent.com/u/47848?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/rafaelfranca', 'html_url': 'https://github.com/rafaelfranca', 'followers_url': 'https://api.github.com/users/rafaelfranca/followers', 'following_url': 'https://api.github.com/users/rafaelfranca/following{/other_user}', 'gists_url': 'https://api.github.com/users/rafaelfranca/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/rafaelfranca/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/rafaelfranca/subscriptions', 'organizations_url': 'https://api.github.com/users/rafaelfranca/orgs', 'repos_url': 'https://api.github.com/users/rafaelfranca/repos', 'events_url': 'https://api.github.com/users/rafaelfranca/events{/privacy}', 'received_events_url': 'https://api.github.com/users/rafaelfranca/received_events', 'type': 'User', 'site_admin': False}]",,10,2014-11-09T16:58:41Z,2016-01-27T15:32:24Z,,NONE,,"Hello all,

I wanted to know what is the overhead of ActionView and modified slim's benchmarks. See the results below.

```
1000 Iterations
Rehearsal ----------------------------------------------------------------
(1) erb                        0.010000   0.000000   0.010000 (  0.017649)
(1) erubis                     0.020000   0.000000   0.020000 (  0.015099)
(1) fast erubis                0.020000   0.000000   0.020000 (  0.014776)
(1) rails erubis               0.010000   0.000000   0.010000 (  0.015612)
(1) actionview locals erubis   0.170000   0.010000   0.180000 (  0.168290)
(1) actionview vars erubis     0.150000   0.000000   0.150000 (  0.155732)
(1) temple erb                 0.020000   0.000000   0.020000 (  0.023802)
(1) slim pretty                0.040000   0.000000   0.040000 (  0.040340)
(1) slim ugly                  0.020000   0.000000   0.020000 (  0.019859)
(1) haml pretty                0.100000   0.000000   0.100000 (  0.095830)
(1) haml ugly                  0.080000   0.000000   0.080000 (  0.084720)
(2) erb                        0.030000   0.000000   0.030000 (  0.029845)
(2) erubis                     0.020000   0.000000   0.020000 (  0.025605)
(2) temple erb                 0.030000   0.000000   0.030000 (  0.027858)
(2) slim pretty                0.050000   0.000000   0.050000 (  0.046810)
(2) slim ugly                  0.030000   0.000000   0.030000 (  0.025806)
(2) haml pretty                0.100000   0.000000   0.100000 (  0.100112)
(2) haml ugly                  0.080000   0.000000   0.080000 (  0.088057)
------------------------------------------------------- total: 0.990000sec
```

To reproduce checkout https://github.com/brauliobo/slim and run `TASK=bench bundle exec rake bench iterations=1000`
",https://api.github.com/repos/rails/rails/issues/17565/timeline,,brauliobo,41740,MDQ6VXNlcjQxNzQw,https://avatars.githubusercontent.com/u/41740?v=4,,https://api.github.com/users/brauliobo,https://github.com/brauliobo,https://api.github.com/users/brauliobo/followers,https://api.github.com/users/brauliobo/following{/other_user},https://api.github.com/users/brauliobo/gists{/gist_id},https://api.github.com/users/brauliobo/starred{/owner}{/repo},https://api.github.com/users/brauliobo/subscriptions,https://api.github.com/users/brauliobo/orgs,https://api.github.com/users/brauliobo/repos,https://api.github.com/users/brauliobo/events{/privacy},https://api.github.com/users/brauliobo/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17565/reactions,0,0,0,0,0,0,0,0,0,,,,,,,rafaelfranca,47848.0,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
590,https://api.github.com/repos/rails/rails/issues/17466,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17466/labels{/name},https://api.github.com/repos/rails/rails/issues/17466/comments,https://api.github.com/repos/rails/rails/issues/17466/events,https://github.com/rails/rails/issues/17466,47445319,MDU6SXNzdWU0NzQ0NTMxOQ==,17466,autosave on has_many relation doesn't save updated collection objects all the time,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'sgrif', 'id': 1529387, 'node_id': 'MDQ6VXNlcjE1MjkzODc=', 'avatar_url': 'https://avatars.githubusercontent.com/u/1529387?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/sgrif', 'html_url': 'https://github.com/sgrif', 'followers_url': 'https://api.github.com/users/sgrif/followers', 'following_url': 'https://api.github.com/users/sgrif/following{/other_user}', 'gists_url': 'https://api.github.com/users/sgrif/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/sgrif/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/sgrif/subscriptions', 'organizations_url': 'https://api.github.com/users/sgrif/orgs', 'repos_url': 'https://api.github.com/users/sgrif/repos', 'events_url': 'https://api.github.com/users/sgrif/events{/privacy}', 'received_events_url': 'https://api.github.com/users/sgrif/received_events', 'type': 'User', 'site_admin': False}]",,24,2014-10-31T21:14:29Z,2020-03-13T20:27:04Z,,NONE,,"I am using Rails 3.2.17

When the objects in a collection are updated and the parent object is saved it works when the objects in the relationship are updated via the relationship. If the children objects are retrieved using the find methods and then updated and assigned back to the relation, the parent doesn’t save the updated children.

e.g.
 We have a customer object which is the parent and it has many orders.

has_many   :orders, :autosave => true

This scenario works
 customer = Customer.find(some_id)
 customer.orders.each do |o|
    o.status = “completed""
 end
 customer.save!

But if we build the orders by fetching the records individually using the find AR methods and update them
then set the collection to the new update collection, by saving the parent the children don't get updated.

e.g.
  customer = Customer.find(some_id)
  orders = Orders.find_all_by_customer_id(customer.id)
  orders.each do |o|
    o.status = “completed""
  end
  customer.orders = orders
  customer.save!
",https://api.github.com/repos/rails/rails/issues/17466/timeline,,mkanoor,6452699,MDQ6VXNlcjY0NTI2OTk=,https://avatars.githubusercontent.com/u/6452699?v=4,,https://api.github.com/users/mkanoor,https://github.com/mkanoor,https://api.github.com/users/mkanoor/followers,https://api.github.com/users/mkanoor/following{/other_user},https://api.github.com/users/mkanoor/gists{/gist_id},https://api.github.com/users/mkanoor/starred{/owner}{/repo},https://api.github.com/users/mkanoor/subscriptions,https://api.github.com/users/mkanoor/orgs,https://api.github.com/users/mkanoor/repos,https://api.github.com/users/mkanoor/events{/privacy},https://api.github.com/users/mkanoor/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17466/reactions,1,1,0,0,0,0,0,0,0,,,,,,,sgrif,1529387.0,MDQ6VXNlcjE1MjkzODc=,https://avatars.githubusercontent.com/u/1529387?v=4,,https://api.github.com/users/sgrif,https://github.com/sgrif,https://api.github.com/users/sgrif/followers,https://api.github.com/users/sgrif/following{/other_user},https://api.github.com/users/sgrif/gists{/gist_id},https://api.github.com/users/sgrif/starred{/owner}{/repo},https://api.github.com/users/sgrif/subscriptions,https://api.github.com/users/sgrif/orgs,https://api.github.com/users/sgrif/repos,https://api.github.com/users/sgrif/events{/privacy},https://api.github.com/users/sgrif/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
591,https://api.github.com/repos/rails/rails/issues/17325,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17325/labels{/name},https://api.github.com/repos/rails/rails/issues/17325/comments,https://api.github.com/repos/rails/rails/issues/17325/events,https://github.com/rails/rails/issues/17325,46212066,MDU6SXNzdWU0NjIxMjA2Ng==,17325,Building a has_one association fails on save if target has a validation on foreign_key ,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,15,2014-10-19T17:58:52Z,2021-07-12T18:47:33Z,,CONTRIBUTOR,,"Hello,

_A gist for the busy can be found [here](https://gist.github.com/why-el/5010105c9c2b74a3d1db)_

Assuming the following: 

```
class Post < ActiveRecord::Base
  has_one :comment
end

class Comment < ActiveRecord::Base
  validates_presence_of :post_id
  belongs_to :post
end
```

This script:

```
    post = Post.create!
    post.comment = Comment.create!({post_id: post.id})
    post.build_comment
```

will fail because `build` is trying to delete the original comment, but that one can't
be deleted because there is a validation on `post_id`. 

This is because prior to deleting, the foreign key of the target association is set to nil and a save operation is performed on the target. I am not sure why this is done. Per my use case, I no longer need the associated target prior to building a new one, and therefore a destroy call should succeed without the need to save, ideally, but not setting the `foreign_key` to `nil` will also work. 

Furthermore, this could be (accidentally, I should say) mitigated by passing a `dependent: :destroy` to the `Post` model. In other words, this: 

```
class Post < ActiveRecord::Base
  has_one :comment, dependent: :destroy
end
```

will make the build operation successful. There is nothing in the semantics of `dependent: :destroy` that should affect a target association without affecting the owner, but in this case it does. 

The issue is with this particular [method](https://github.com/rails/rails/blob/master/activerecord/lib/active_record/associations/has_one_association.rb#L92), which is called prior to a saving the target association (in our case, the comment instance).

I can submit a PR if this is a clear issue for everyone. 
",https://api.github.com/repos/rails/rails/issues/17325/timeline,,why-el,1326771,MDQ6VXNlcjEzMjY3NzE=,https://avatars.githubusercontent.com/u/1326771?v=4,,https://api.github.com/users/why-el,https://github.com/why-el,https://api.github.com/users/why-el/followers,https://api.github.com/users/why-el/following{/other_user},https://api.github.com/users/why-el/gists{/gist_id},https://api.github.com/users/why-el/starred{/owner}{/repo},https://api.github.com/users/why-el/subscriptions,https://api.github.com/users/why-el/orgs,https://api.github.com/users/why-el/repos,https://api.github.com/users/why-el/events{/privacy},https://api.github.com/users/why-el/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17325/reactions,4,4,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
592,https://api.github.com/repos/rails/rails/issues/17225,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17225/labels{/name},https://api.github.com/repos/rails/rails/issues/17225/comments,https://api.github.com/repos/rails/rails/issues/17225/events,https://github.com/rails/rails/issues/17225,45446129,MDU6SXNzdWU0NTQ0NjEyOQ==,17225,:multiple option turns email_field name into an array,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,5,2014-10-10T04:54:28Z,2019-07-01T22:19:05Z,,CONTRIBUTOR,,"``` ruby
def tag_name(multiple = false)
  ""#{@object_name}[#{sanitized_method_name}]#{""[]"" if multiple}""
end
```

This makes no sense. `:multiple` does not mean there will be many input fields with the same name, which would justify an array, but that the single input filed can hold a comma separated list of values.
",https://api.github.com/repos/rails/rails/issues/17225/timeline,,bughit,895588,MDQ6VXNlcjg5NTU4OA==,https://avatars.githubusercontent.com/u/895588?v=4,,https://api.github.com/users/bughit,https://github.com/bughit,https://api.github.com/users/bughit/followers,https://api.github.com/users/bughit/following{/other_user},https://api.github.com/users/bughit/gists{/gist_id},https://api.github.com/users/bughit/starred{/owner}{/repo},https://api.github.com/users/bughit/subscriptions,https://api.github.com/users/bughit/orgs,https://api.github.com/users/bughit/repos,https://api.github.com/users/bughit/events{/privacy},https://api.github.com/users/bughit/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17225/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
593,https://api.github.com/repos/rails/rails/issues/17091,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/17091/labels{/name},https://api.github.com/repos/rails/rails/issues/17091/comments,https://api.github.com/repos/rails/rails/issues/17091/events,https://github.com/rails/rails/issues/17091,44245616,MDU6SXNzdWU0NDI0NTYxNg==,17091,NoMethodError - undefined method `build' on ActiveRecord::PredicateBuilder (Class),"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,54,2014-09-28T23:41:23Z,2021-07-12T19:43:50Z,,CONTRIBUTOR,,"ActveRecord bug, or rubinius bug?

I'm using rbx with Puma, so there are threads involved.

```
ArgumentError - A copy of ActiveRecord::PredicateBuilder has been removed from the module tree but is still active!:
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activesupport-4.1.5/lib/active_support/dependencies.rb:465:in `load_missing_constant'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activesupport-4.1.5/lib/active_support/dependencies.rb:180:in `const_missing'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:113:in `__script__'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:2:in `__script__'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:1:in `__script__'
        kernel/common/code_loader.rb:243:in `require'
        kernel/common/autoload.rb:55:in `resolve'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/query_methods.rb:569:in `where!'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/query_methods.rb:559:in `where'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/finder_methods.rb:81:in `find_by'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/querying.rb:7:in `find_by'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/dynamic_matchers.rb:70:in `find_by_id'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/dynamic_matchers.rb:24:in `find_by_id (method_missing)'
```

Later:

```
NameError - uninitialized constant ActiveRecord::PredicateBuilder::RelationHandler:
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:113:in `__script__'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:2:in `__script__'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:1:in `__script__'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/query_methods.rb:569:in `where!'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/query_methods.rb:0:in `where'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/finder_methods.rb:81:in `find_by'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/querying.rb:7:in `find_by'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/dynamic_matchers.rb:70:in `find_by_id'
```

Later and then continuously:

```
NoMethodError - undefined method `build' on ActiveRecord::PredicateBuilder (Class):
        kernel/delta/kernel.rb:78:in `build (method_missing)'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:66:in `expand'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:43:in `build_from_hash'
        kernel/common/hash.rb:342:in `each'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/predicate_builder.rb:21:in `build_from_hash'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/query_methods.rb:950:in `build_where'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/query_methods.rb:572:in `where!'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/query_methods.rb:559:in `where'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/relation/finder_methods.rb:81:in `find_by'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/querying.rb:7:in `find_by'
        /home/ghazel/.rvm/gems/rbx-2.2.10/gems/activerecord-4.1.5/lib/active_record/dynamic_matchers.rb:70:in `find_by_id'
```
",https://api.github.com/repos/rails/rails/issues/17091/timeline,,ghazel,31402,MDQ6VXNlcjMxNDAy,https://avatars.githubusercontent.com/u/31402?v=4,,https://api.github.com/users/ghazel,https://github.com/ghazel,https://api.github.com/users/ghazel/followers,https://api.github.com/users/ghazel/following{/other_user},https://api.github.com/users/ghazel/gists{/gist_id},https://api.github.com/users/ghazel/starred{/owner}{/repo},https://api.github.com/users/ghazel/subscriptions,https://api.github.com/users/ghazel/orgs,https://api.github.com/users/ghazel/repos,https://api.github.com/users/ghazel/events{/privacy},https://api.github.com/users/ghazel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/17091/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
594,https://api.github.com/repos/rails/rails/issues/16823,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/16823/labels{/name},https://api.github.com/repos/rails/rails/issues/16823/comments,https://api.github.com/repos/rails/rails/issues/16823/events,https://github.com/rails/rails/issues/16823,42096780,MDU6SXNzdWU0MjA5Njc4MA==,16823,Fix the callback order problem with associations,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,5,2014-09-05T22:17:25Z,2015-06-25T21:55:07Z,,MEMBER,,"This is related to: https://github.com/rails/rails/issues/3798

Associations code in Active Record use callbacks to implement some behaviours like the autosave and the dependent options. Depending on how users use callbacks in their models the order of the callbacks definition and the association definition can give them surprising results like records being created twice.

Some things we can do:

1) Improve the documentation about this problem
2) Warn users about existence of callbacks defined before the association definition
3) Stop of relying in callbacks to implement association behaviour
4) Define an internal set of callbacks

More suggestions are welcome.

cc @matthewd 
",https://api.github.com/repos/rails/rails/issues/16823/timeline,,rafaelfranca,47848,MDQ6VXNlcjQ3ODQ4,https://avatars.githubusercontent.com/u/47848?v=4,,https://api.github.com/users/rafaelfranca,https://github.com/rafaelfranca,https://api.github.com/users/rafaelfranca/followers,https://api.github.com/users/rafaelfranca/following{/other_user},https://api.github.com/users/rafaelfranca/gists{/gist_id},https://api.github.com/users/rafaelfranca/starred{/owner}{/repo},https://api.github.com/users/rafaelfranca/subscriptions,https://api.github.com/users/rafaelfranca/orgs,https://api.github.com/users/rafaelfranca/repos,https://api.github.com/users/rafaelfranca/events{/privacy},https://api.github.com/users/rafaelfranca/received_events,User,False,https://api.github.com/repos/rails/rails/issues/16823/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
595,https://api.github.com/repos/rails/rails/issues/16452,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/16452/labels{/name},https://api.github.com/repos/rails/rails/issues/16452/comments,https://api.github.com/repos/rails/rails/issues/16452/events,https://github.com/rails/rails/issues/16452,39913607,MDU6SXNzdWUzOTkxMzYwNw==,16452,ActiveRecord relation with an aliased model doesn't work,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,5,2014-08-10T18:35:37Z,2021-07-12T17:44:16Z,,NONE,,"Gist with working test code: https://gist.github.com/haggen/58b5c6daab243f002b54

The code is pretty obvious, but anyway, consider two models `Post` and `User`.

`Post` belongs to an `author` which corresponds to a user instance, but instead of using the option `class_name` I tried to put an alias like this `Author = User` and saved it to `author.rb` inside my models directory.

Everything works fine except for the relation. It always returns `uninitialized constant Post::Author`. Even when I declared a constant `Author` **inside** `Post` model. (which can be seen in code above)

The trace ended here:
https://github.com/rails/rails/blob/master/activerecord/lib/active_record/inheritance.rb#L142

My point is, it may not even work afterall, but throwing `uninitialized constant` is very misleading.
",https://api.github.com/repos/rails/rails/issues/16452/timeline,,haggen,270076,MDQ6VXNlcjI3MDA3Ng==,https://avatars.githubusercontent.com/u/270076?v=4,,https://api.github.com/users/haggen,https://github.com/haggen,https://api.github.com/users/haggen/followers,https://api.github.com/users/haggen/following{/other_user},https://api.github.com/users/haggen/gists{/gist_id},https://api.github.com/users/haggen/starred{/owner}{/repo},https://api.github.com/users/haggen/subscriptions,https://api.github.com/users/haggen/orgs,https://api.github.com/users/haggen/repos,https://api.github.com/users/haggen/events{/privacy},https://api.github.com/users/haggen/received_events,User,False,https://api.github.com/repos/rails/rails/issues/16452/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
596,https://api.github.com/repos/rails/rails/issues/15854,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/15854/labels{/name},https://api.github.com/repos/rails/rails/issues/15854/comments,https://api.github.com/repos/rails/rails/issues/15854/events,https://github.com/rails/rails/issues/15854,36237097,MDU6SXNzdWUzNjIzNzA5Nw==,15854,"Eager loading associations that use limit, group, and offset produces incorrect results","[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,16,2014-06-22T04:04:53Z,2020-11-19T10:16:19Z,,CONTRIBUTOR,,"Eager loading any of the following associations will products incorrect results:

```
class Blog < ActiveRecord::Base
  has_many :limited_posts, -> { order(:id).limit(2) }, class_name: 'Post'
  has_many :grouped_posts, -> { group(:blog_id) }, class_name: 'Post'
  has_many :offset_posts, -> { offset(2) }, class_name: 'Post'
end
```

Test case can be found in https://gist.github.com/jturkel/1e6355e8de2bf9953945.

Probably best to just disallow eager loading in these cases.
",https://api.github.com/repos/rails/rails/issues/15854/timeline,,jturkel,2598096,MDQ6VXNlcjI1OTgwOTY=,https://avatars.githubusercontent.com/u/2598096?v=4,,https://api.github.com/users/jturkel,https://github.com/jturkel,https://api.github.com/users/jturkel/followers,https://api.github.com/users/jturkel/following{/other_user},https://api.github.com/users/jturkel/gists{/gist_id},https://api.github.com/users/jturkel/starred{/owner}{/repo},https://api.github.com/users/jturkel/subscriptions,https://api.github.com/users/jturkel/orgs,https://api.github.com/users/jturkel/repos,https://api.github.com/users/jturkel/events{/privacy},https://api.github.com/users/jturkel/received_events,User,False,https://api.github.com/repos/rails/rails/issues/15854/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
597,https://api.github.com/repos/rails/rails/issues/15589,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/15589/labels{/name},https://api.github.com/repos/rails/rails/issues/15589/comments,https://api.github.com/repos/rails/rails/issues/15589/events,https://github.com/rails/rails/issues/15589,35289791,MDU6SXNzdWUzNTI4OTc5MQ==,15589,assert_recognizes and assert_routing don't take route constraints into account,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,14,2014-06-09T14:39:03Z,2017-07-10T17:29:12Z,,NONE,,"Hello,

I'm in process of migration of my app from Rails 3.2 to 4.1. I just hit an issue in my tests where application works fine with my routes but assert_recognizes does not.

Here are my routes and snippet of test:

<pre>
  put 'scheduled_jobs/:id/unlock' =>   'scheduled_jobs#unlock',       as: :unlock_scheduled_job
  get 'scheduled_jobs/queue_status' => 'scheduled_jobs#queue_status', as: :queue_status,         constraints: {:ip => /^127\.\d+\.\d+\.\d+$/}
  get 'scheduled_jobs/dequeue' =>      'scheduled_jobs#dequeue',      as: :dequeue,              constraints: {:ip => /^127\.\d+\.\d+\.\d+$/}

  resources :scheduled_jobs, only: [:show, :index, :destroy]
</pre>


Test:

<pre>
assert_recognizes({:controller => 'scheduled_jobs', :action => 'queue_status'},
                      {:path => ""/scheduled_jobs/queue_status"", :method => :get}, {}, 'Routing to ScheduledJobs#queue_status is not recognized')
</pre>


Error message:

<pre>
Routing to ScheduledJobs#queue_status is not recognized
The recognized options <{""action""=>""show"", ""controller""=>""scheduled_jobs"", ""id""=>""queue_status""}> did not match <{""controller""=>""scheduled_jobs"", ""action""=>""queue_status""}>, difference:.
--- expected
+++ actual
@@ -1 +1 @@
-{""controller""=>""scheduled_jobs"", ""action""=>""queue_status""}
+{""action""=>""show"", ""controller""=>""scheduled_jobs"", ""id""=>""queue_status""}
</pre>


Best regards,
Boris
",https://api.github.com/repos/rails/rails/issues/15589/timeline,,bmironov,171609,MDQ6VXNlcjE3MTYwOQ==,https://avatars.githubusercontent.com/u/171609?v=4,,https://api.github.com/users/bmironov,https://github.com/bmironov,https://api.github.com/users/bmironov/followers,https://api.github.com/users/bmironov/following{/other_user},https://api.github.com/users/bmironov/gists{/gist_id},https://api.github.com/users/bmironov/starred{/owner}{/repo},https://api.github.com/users/bmironov/subscriptions,https://api.github.com/users/bmironov/orgs,https://api.github.com/users/bmironov/repos,https://api.github.com/users/bmironov/events{/privacy},https://api.github.com/users/bmironov/received_events,User,False,https://api.github.com/repos/rails/rails/issues/15589/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
598,https://api.github.com/repos/rails/rails/issues/15470,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/15470/labels{/name},https://api.github.com/repos/rails/rails/issues/15470/comments,https://api.github.com/repos/rails/rails/issues/15470/events,https://github.com/rails/rails/issues/15470,34788767,MDU6SXNzdWUzNDc4ODc2Nw==,15470,Setting config.log_formatter results in console not matching log files.,"[{'id': 107195, 'node_id': 'MDU6TGFiZWwxMDcxOTU=', 'url': 'https://api.github.com/repos/rails/rails/labels/railties', 'name': 'railties', 'color': '8BE06E', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,10,2014-06-02T16:24:57Z,2021-07-11T20:18:00Z,,CONTRIBUTOR,,"I've defined this custom formatter:

```
class GeneralFormatter < Logger::Formatter
  def call(severity, time, program_name, message)
    puts ""Checkpoint 1""
    ""Checkpoint 2\n""
  end
end
```

and enabled it with `config.log_formatter = GeneralFormatter.new`

But when I run `Rails.logger.warn(""Checkpoint 0"")` in the Rails console I see:

```
Checkpoint 0
Checkpoint 1
```

as opposed to the expected:

```
Checkpoint 1
Checkpoint 2
```

While the actual log file is just:

```
Checkpoint 2
```

It looks like the issue is that when the STDOUT logger and formatter are set (https://github.com/rails/rails/blob/master/railties/lib/rails/commands/server.rb#L142), the `console` variable's formatter is somehow not getting set to the correct formatter, though offhand I can't see how that would happen.
",https://api.github.com/repos/rails/rails/issues/15470/timeline,,JacobEvelyn,1114569,MDQ6VXNlcjExMTQ1Njk=,https://avatars.githubusercontent.com/u/1114569?v=4,,https://api.github.com/users/JacobEvelyn,https://github.com/JacobEvelyn,https://api.github.com/users/JacobEvelyn/followers,https://api.github.com/users/JacobEvelyn/following{/other_user},https://api.github.com/users/JacobEvelyn/gists{/gist_id},https://api.github.com/users/JacobEvelyn/starred{/owner}{/repo},https://api.github.com/users/JacobEvelyn/subscriptions,https://api.github.com/users/JacobEvelyn/orgs,https://api.github.com/users/JacobEvelyn/repos,https://api.github.com/users/JacobEvelyn/events{/privacy},https://api.github.com/users/JacobEvelyn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/15470/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
599,https://api.github.com/repos/rails/rails/issues/15097,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/15097/labels{/name},https://api.github.com/repos/rails/rails/issues/15097/comments,https://api.github.com/repos/rails/rails/issues/15097/events,https://github.com/rails/rails/issues/15097,33442709,MDU6SXNzdWUzMzQ0MjcwOQ==,15097,Undocumented behaviour in `_path` helpers,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 150377, 'node_id': 'MDU6TGFiZWwxNTAzNzc=', 'url': 'https://api.github.com/repos/rails/rails/labels/docs', 'name': 'docs', 'color': '02d7e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,8,2014-05-13T21:51:48Z,2021-07-13T10:33:54Z,,NONE,,"> When generating a new URL, missing values may be filled in from the current request’s parameters.

This seems to have last appeared in the Rails 2 documentation, for [`ActionController::Base#url_for`](http://apidock.com/rails/v2.3.8/ActionController/Base/url_for).

`url_for` has since been extensively refactored and scattered into many different versions, and none of those versions mention anything like this in their documentation. Nor is this described in the Rails Guides (at least as far as I can find).

[Here is a gist](https://gist.github.com/gadtfly/0f0ad0a5145a3aaadaaf) lightly sketching out the now-undocumented implicit behaviour (which still works as of Rails 4.1.1).

Considering how easily this can be invoked (omitting arguments from a `_path` helper), by a noob or otherwise, it probably warrants some explanation (and might even be considered a feature, and debatably consistent with other rails idioms).
",https://api.github.com/repos/rails/rails/issues/15097/timeline,,gadtfly,2624505,MDQ6VXNlcjI2MjQ1MDU=,https://avatars.githubusercontent.com/u/2624505?v=4,,https://api.github.com/users/gadtfly,https://github.com/gadtfly,https://api.github.com/users/gadtfly/followers,https://api.github.com/users/gadtfly/following{/other_user},https://api.github.com/users/gadtfly/gists{/gist_id},https://api.github.com/users/gadtfly/starred{/owner}{/repo},https://api.github.com/users/gadtfly/subscriptions,https://api.github.com/users/gadtfly/orgs,https://api.github.com/users/gadtfly/repos,https://api.github.com/users/gadtfly/events{/privacy},https://api.github.com/users/gadtfly/received_events,User,False,https://api.github.com/repos/rails/rails/issues/15097/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
600,https://api.github.com/repos/rails/rails/issues/15079,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/15079/labels{/name},https://api.github.com/repos/rails/rails/issues/15079/comments,https://api.github.com/repos/rails/rails/issues/15079/events,https://github.com/rails/rails/issues/15079,33355990,MDU6SXNzdWUzMzM1NTk5MA==,15079,JSON requests with Chunked encoding are not handled correctly,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,10,2014-05-12T23:15:04Z,2015-06-10T20:00:29Z,,CONTRIBUTOR,,"(Continuation of #7556, since that ticket became confusing.)

On Rails 4.1.1 (and current master), posting a JSON body with chunked transfer encoding, the body is ignored and no params are accessible in the controller.

Here is a repro: https://github.com/xaviershay/chunked_repro (see README)
Here is a proof-of-concept fix: https://github.com/xaviershay/rails/tree/chunked-fix

If the fix is directionally correct, I can try to clean it up into a PR.
",https://api.github.com/repos/rails/rails/issues/15079/timeline,,xaviershay,1714,MDQ6VXNlcjE3MTQ=,https://avatars.githubusercontent.com/u/1714?v=4,,https://api.github.com/users/xaviershay,https://github.com/xaviershay,https://api.github.com/users/xaviershay/followers,https://api.github.com/users/xaviershay/following{/other_user},https://api.github.com/users/xaviershay/gists{/gist_id},https://api.github.com/users/xaviershay/starred{/owner}{/repo},https://api.github.com/users/xaviershay/subscriptions,https://api.github.com/users/xaviershay/orgs,https://api.github.com/users/xaviershay/repos,https://api.github.com/users/xaviershay/events{/privacy},https://api.github.com/users/xaviershay/received_events,User,False,https://api.github.com/repos/rails/rails/issues/15079/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
601,https://api.github.com/repos/rails/rails/issues/14991,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/14991/labels{/name},https://api.github.com/repos/rails/rails/issues/14991/comments,https://api.github.com/repos/rails/rails/issues/14991/events,https://github.com/rails/rails/issues/14991,32887554,MDU6SXNzdWUzMjg4NzU1NA==,14991,Rails 4: Cache Digests not resolving a render layout: do block,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,8,2014-05-06T12:24:26Z,2016-04-29T09:31:07Z,,NONE,,"Rails 4 Cache Digests is not resolving dependancies properly, in this specific case. I am using a render block to share html layouts (such as runner modules that use the same classes, different titles, and so on)

It does calculate the hash, but it is still looking for files that don't exist -- and it does not digest the parent layout.

the block:

```
=render layout: 'shared/runner_module', locals: {title: title} do
    <..... html ....>
```

If I remove the block, the notifications below do not occur. While I doubt we'd ever actually change the parent html, it would still cause a problem until the cache drops.

Notifications in log:

```
Couldn't find template for digesting: layouts/layout.html.haml
```
",https://api.github.com/repos/rails/rails/issues/14991/timeline,,spodlecki,1273570,MDQ6VXNlcjEyNzM1NzA=,https://avatars.githubusercontent.com/u/1273570?v=4,,https://api.github.com/users/spodlecki,https://github.com/spodlecki,https://api.github.com/users/spodlecki/followers,https://api.github.com/users/spodlecki/following{/other_user},https://api.github.com/users/spodlecki/gists{/gist_id},https://api.github.com/users/spodlecki/starred{/owner}{/repo},https://api.github.com/users/spodlecki/subscriptions,https://api.github.com/users/spodlecki/orgs,https://api.github.com/users/spodlecki/repos,https://api.github.com/users/spodlecki/events{/privacy},https://api.github.com/users/spodlecki/received_events,User,False,https://api.github.com/repos/rails/rails/issues/14991/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
602,https://api.github.com/repos/rails/rails/issues/14698,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/14698/labels{/name},https://api.github.com/repos/rails/rails/issues/14698/comments,https://api.github.com/repos/rails/rails/issues/14698/events,https://github.com/rails/rails/issues/14698,31298080,MDU6SXNzdWUzMTI5ODA4MA==,14698,Explicit transactions not rolling back when validation fails on nested attributes,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,"[{'login': 'chancancode', 'id': 55829, 'node_id': 'MDQ6VXNlcjU1ODI5', 'avatar_url': 'https://avatars.githubusercontent.com/u/55829?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/chancancode', 'html_url': 'https://github.com/chancancode', 'followers_url': 'https://api.github.com/users/chancancode/followers', 'following_url': 'https://api.github.com/users/chancancode/following{/other_user}', 'gists_url': 'https://api.github.com/users/chancancode/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/chancancode/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/chancancode/subscriptions', 'organizations_url': 'https://api.github.com/users/chancancode/orgs', 'repos_url': 'https://api.github.com/users/chancancode/repos', 'events_url': 'https://api.github.com/users/chancancode/events{/privacy}', 'received_events_url': 'https://api.github.com/users/chancancode/received_events', 'type': 'User', 'site_admin': False}]",,14,2014-04-11T02:30:50Z,2020-06-02T11:02:25Z,,CONTRIBUTOR,,"In certain situations, when a validation fails on a model referenced in nested attributes, when the update attributes is executed inside an explicit transaction, the transaction is not rolled back, and the database is left in a state that's different than it was before the transaction.

Example:

In the controller: 

``` ruby
    User.transaction do
      user.update(email: nil, user_setting_attributes: {favourite_color: 'red'})
    end
```

Note that `user.update!` does _not_ cause the issue.

The models:

``` ruby
class User < ActiveRecord::Base
  has_one :user_setting
  accepts_nested_attributes_for :user_setting
  validates_presence_of :email
end

class UserSetting < ActiveRecord::Base
  belongs_to :user
end
```

A complete file that shows a case that causes, and some cases that are similar but don't cause the issue:

``` ruby
unless File.exist?('Gemfile')
  File.write('Gemfile', <<-GEMFILE)
source 'https://rubygems.org'
gem 'activerecord', '4.1.0'
gem 'sqlite3'
GEMFILE

  system 'bundle'
end

require 'bundler'
Bundler.setup(:default)

# Activate the gem you are reporting the issue against.
require 'active_record'
require 'minitest/autorun'
require 'logger'

# Ensure backward compatibility with Minitest 4
Minitest::Test = MiniTest::Unit::TestCase unless defined?(Minitest::Test)

# This connection will do for database-independent bug reports.
ActiveRecord::Base.establish_connection(adapter: 'sqlite3', database: ':memory:')
ActiveRecord::Base.logger = Logger.new(STDOUT)

ActiveRecord::Schema.define do
  create_table :users do |t|
    t.string :email
  end

  create_table :user_settings do |t|
    t.integer :user_id
    t.string :favourite_color
  end
end

class User < ActiveRecord::Base
  has_one :user_setting
  accepts_nested_attributes_for :user_setting
  validates_presence_of :email
end

class UserSetting < ActiveRecord::Base
  belongs_to :user
end

class BugTest < Minitest::Test
  def test_update_without_transaction
    user = User.create!(email: 'godfrey@example.com', user_setting_attributes: {favourite_color: 'orange'})
    assert_equal 'orange', user.user_setting.favourite_color

    assert ! user.update(email: nil, user_setting_attributes: {favourite_color: 'red'})

    user.reload

    assert user.user_setting.present?
    assert_equal 'orange', user.user_setting.favourite_color
  end

  def test_update_with_transaction
    user = User.create!(email: 'godfrey@example.com', user_setting_attributes: {favourite_color: 'orange'})
    assert_equal 'orange', user.user_setting.favourite_color

    User.transaction do
      assert ! user.update(email: nil, user_setting_attributes: {favourite_color: 'red'})
    end

    user.reload

    assert user.user_setting.present?
    assert_equal 'orange', user.user_setting.favourite_color
  end

  def test_update_without_transaction!
    user = User.create!(email: 'godfrey@example.com', user_setting_attributes: {favourite_color: 'orange'})
    assert_equal 'orange', user.user_setting.favourite_color

    assert_raises(ActiveRecord::RecordInvalid) do
      user.update!(email: nil, user_setting_attributes: {favourite_color: 'red'})
    end

    user.reload

    assert user.user_setting.present?
    assert_equal 'orange', user.user_setting.favourite_color
  end

  def test_update_with_transaction!
    user = User.create!(email: 'godfrey@example.com', user_setting_attributes: {favourite_color: 'orange'})
    assert_equal 'orange', user.user_setting.favourite_color

    assert_raises(ActiveRecord::RecordInvalid) do
      User.transaction do
        assert ! user.update!(email: nil, user_setting_attributes: {favourite_color: 'red'})
      end
    end

    user.reload

    assert user.user_setting.present?
    assert_equal 'orange', user.user_setting.favourite_color
  end
end
```

If the above is in a file called `repro.rb`, then:

``` sh
ruby repro.rb
```

should produce output ending in:

```
4 runs, 15 assertions, 1 failures, 0 errors, 0 skips
```

The issues has been observed in 4.1 master and 4.0 master. I haven't yet checked how far back it might go.

The issue was shown to my by @chancancode . I'm documenting the issue here without much further research yet because I didn't want it to get dropped.
",https://api.github.com/repos/rails/rails/issues/14698/timeline,,lcreid,1613872,MDQ6VXNlcjE2MTM4NzI=,https://avatars.githubusercontent.com/u/1613872?v=4,,https://api.github.com/users/lcreid,https://github.com/lcreid,https://api.github.com/users/lcreid/followers,https://api.github.com/users/lcreid/following{/other_user},https://api.github.com/users/lcreid/gists{/gist_id},https://api.github.com/users/lcreid/starred{/owner}{/repo},https://api.github.com/users/lcreid/subscriptions,https://api.github.com/users/lcreid/orgs,https://api.github.com/users/lcreid/repos,https://api.github.com/users/lcreid/events{/privacy},https://api.github.com/users/lcreid/received_events,User,False,https://api.github.com/repos/rails/rails/issues/14698/reactions,3,3,0,0,0,0,0,0,0,,,,,,,chancancode,55829.0,MDQ6VXNlcjU1ODI5,https://avatars.githubusercontent.com/u/55829?v=4,,https://api.github.com/users/chancancode,https://github.com/chancancode,https://api.github.com/users/chancancode/followers,https://api.github.com/users/chancancode/following{/other_user},https://api.github.com/users/chancancode/gists{/gist_id},https://api.github.com/users/chancancode/starred{/owner}{/repo},https://api.github.com/users/chancancode/subscriptions,https://api.github.com/users/chancancode/orgs,https://api.github.com/users/chancancode/repos,https://api.github.com/users/chancancode/events{/privacy},https://api.github.com/users/chancancode/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
603,https://api.github.com/repos/rails/rails/issues/14567,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/14567/labels{/name},https://api.github.com/repos/rails/rails/issues/14567/comments,https://api.github.com/repos/rails/rails/issues/14567/events,https://github.com/rails/rails/issues/14567,30688803,MDU6SXNzdWUzMDY4ODgwMw==,14567,"Error is rescued in routes if controller doesn't exist, and masked as a RoutingError","[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,5,2014-04-02T13:48:43Z,2015-01-02T15:58:49Z,,NONE,,"Hello,
I discovered this 'problem' (in apostrophes as it might not be a problem from your perspective) by chance and is as follows:

If you are defining a route with a bad controller name (maybe misspelled), the error is rescued and raised again as a `RoutingError`. Sometimes as I see the error is silenced completely but I don't know the exact internals.
It all happens here: https://github.com/rails/rails/blob/master/actionpack/lib/action_dispatch/routing/route_set.rb#L68

I personally consider this as a real error, something that I should have seen reported by airbrake. While it can be considered a routing error, I would like it to be a distinction between stuff entered randomly by users in the addressbar, and how that stuff maps afterwards to controllers and actions.
I don't understand why they both get put in this pool of Routing Errors
",https://api.github.com/repos/rails/rails/issues/14567/timeline,,dragosmiron,353922,MDQ6VXNlcjM1MzkyMg==,https://avatars.githubusercontent.com/u/353922?v=4,,https://api.github.com/users/dragosmiron,https://github.com/dragosmiron,https://api.github.com/users/dragosmiron/followers,https://api.github.com/users/dragosmiron/following{/other_user},https://api.github.com/users/dragosmiron/gists{/gist_id},https://api.github.com/users/dragosmiron/starred{/owner}{/repo},https://api.github.com/users/dragosmiron/subscriptions,https://api.github.com/users/dragosmiron/orgs,https://api.github.com/users/dragosmiron/repos,https://api.github.com/users/dragosmiron/events{/privacy},https://api.github.com/users/dragosmiron/received_events,User,False,https://api.github.com/repos/rails/rails/issues/14567/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
604,https://api.github.com/repos/rails/rails/issues/14358,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/14358/labels{/name},https://api.github.com/repos/rails/rails/issues/14358/comments,https://api.github.com/repos/rails/rails/issues/14358/events,https://github.com/rails/rails/issues/14358,29257069,MDU6SXNzdWUyOTI1NzA2OQ==,14358,Rack::ETag middleware doesn't play nice with Live streaming when commit! is called before write,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,[],,44,2014-03-12T12:03:50Z,2020-11-13T15:12:54Z,,CONTRIBUTOR,,"This is similar to https://github.com/rails/rails/pull/9713, except that that code doesn't fix the issue I'm experiencing.

Currently that middleware will only skip the body digest (and not call body.each) if `Cache-Control` header is set to `no-cache`:

https://github.com/rack/rack/blob/master/lib/rack/etag.rb#L56

So, unless you set that header explicitly in the controller's action streaming won't work out of the box. I spent several hours yesterday digging in several gem sources (railties, actionpack, active_support, rack) to find out what was preventing streaming from working in my application, so I would appreciate if Rails could make this work transparently if possible.

My first proposal is for Rails to automatically add `Cache-Control: no-cache` on the first commit! call to the response object, so that ETag will skip the digest. This should work since the action will wait for the first commit before returning to the dispatch method.

If that's not possible for some reason, then it would be great if we could flag actions which are supposed to be used with live streaming. Something like:

``` ruby
def my_action
 # this would set the Cache-Control header and do whatever else is needed to make streaming just work.
  enable_streaming!
  # ...
end
```
",https://api.github.com/repos/rails/rails/issues/14358/timeline,,rosenfeld,32246,MDQ6VXNlcjMyMjQ2,https://avatars.githubusercontent.com/u/32246?v=4,,https://api.github.com/users/rosenfeld,https://github.com/rosenfeld,https://api.github.com/users/rosenfeld/followers,https://api.github.com/users/rosenfeld/following{/other_user},https://api.github.com/users/rosenfeld/gists{/gist_id},https://api.github.com/users/rosenfeld/starred{/owner}{/repo},https://api.github.com/users/rosenfeld/subscriptions,https://api.github.com/users/rosenfeld/orgs,https://api.github.com/users/rosenfeld/repos,https://api.github.com/users/rosenfeld/events{/privacy},https://api.github.com/users/rosenfeld/received_events,User,False,https://api.github.com/repos/rails/rails/issues/14358/reactions,1,1,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
605,https://api.github.com/repos/rails/rails/issues/13873,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/13873/labels{/name},https://api.github.com/repos/rails/rails/issues/13873/comments,https://api.github.com/repos/rails/rails/issues/13873/events,https://github.com/rails/rails/issues/13873,26532806,MDU6SXNzdWUyNjUzMjgwNg==,13873,rails on live stream seems to expires with error on server,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,9,2014-01-29T16:29:44Z,2021-05-18T03:01:34Z,,NONE,,"ive rescue_from right at the very top of application_controller,
and i'am still getting this error when my browser session expired after long inactivity.
it does not occur if i clear my browser cache.
the exception is handled properly if my browser cache is cleared by force.

``` ruby
rescue_from CanCan::AccessDenied do |exception|
    ....
end

#and this before action is below rescue:
before_action :invalidate_simultaneous_user_session, :unless => Proc.new {|c| c.controller_name == 'sessions' }
include ActionController::Live
```

error:

```
NoMethodError (undefined method `call' for nil:NilClass):
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/actionpack-4.0.2/lib/action_controller/metal/live.rb:67:in `call_on_error'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/actionpack-4.0.2/lib/action_controller/metal/live.rb:137:in `rescue in block in process'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/actionpack-4.0.2/lib/action_controller/metal/live.rb:146:in `block in process'



ArgumentError (uncaught throw :warden):
  /home/mysite/vendor/bundle/ruby/2.0.0/bundler/gems/devise-6d2992189cee/lib/devise/hooks/timeoutable.rb:21:in `throw'
  /home/mysite/vendor/bundle/ruby/2.0.0/bundler/gems/devise-6d2992189cee/lib/devise/hooks/timeoutable.rb:21:in `block in <top (required)>'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/hooks.rb:14:in `call'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/hooks.rb:14:in `block in _run_callbacks'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/hooks.rb:9:in `each'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/hooks.rb:9:in `_run_callbacks'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/manager.rb:53:in `_run_callbacks'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/proxy.rb:179:in `set_user'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/proxy.rb:217:in `user'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/proxy.rb:318:in `_perform_authentication'
  /home/mysite/vendor/bundle/ruby/2.0.0/gems/warden-1.2.3/lib/warden/proxy.rb:104:in `authenticate'
  /home/mysite/vendor/bundle/ruby/2.0.0/bundler/gems/devise-6d2992189cee/lib/devise/controllers/helpers.rb:58:in `current_user'
  /home/mysite/app/controllers/application_controller.rb:97:in `invalidate_simultaneous_user_session'
```
",https://api.github.com/repos/rails/rails/issues/13873/timeline,,u007,388813,MDQ6VXNlcjM4ODgxMw==,https://avatars.githubusercontent.com/u/388813?v=4,,https://api.github.com/users/u007,https://github.com/u007,https://api.github.com/users/u007/followers,https://api.github.com/users/u007/following{/other_user},https://api.github.com/users/u007/gists{/gist_id},https://api.github.com/users/u007/starred{/owner}{/repo},https://api.github.com/users/u007/subscriptions,https://api.github.com/users/u007/orgs,https://api.github.com/users/u007/repos,https://api.github.com/users/u007/events{/privacy},https://api.github.com/users/u007/received_events,User,False,https://api.github.com/repos/rails/rails/issues/13873/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
606,https://api.github.com/repos/rails/rails/issues/13496,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/13496/labels{/name},https://api.github.com/repos/rails/rails/issues/13496/comments,https://api.github.com/repos/rails/rails/issues/13496/events,https://github.com/rails/rails/issues/13496,24793701,MDU6SXNzdWUyNDc5MzcwMQ==,13496,update_all behavior is different between mysql and the other databases ,"[{'id': 107191, 'node_id': 'MDU6TGFiZWwxMDcxOTE=', 'url': 'https://api.github.com/repos/rails/rails/labels/activerecord', 'name': 'activerecord', 'color': '0b02e1', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,17,2013-12-26T17:13:49Z,2019-01-22T15:35:59Z,,NONE,,"I'm trying to copy one column from one table to another. It does not work with Postgresql.

I'm not sure if this is a bug or if this works by luck in MySQL but here is my case:

I execute

```
ModelA.join(:modelB).update_all('modelA.column = modelB.column')
```

That fails with:

```
ActiveRecord::StatementInvalid: PG::UndefinedTable: ERROR:  missing FROM-clause entry for table ""modelBs""
LINE 1: ..."" SET modelAs.column = modelBs...
                                                         ^
UPDATE ""modelAs"" SET modelAs.column = modelBs.column WHERE ""modelAs"".""id"" IN (
  SELECT ""modelAs"".""id"" FROM ""modelAs"" INNER JOIN ""modelBs"" ON ""modelBs"".""id"" = ""modelAs"".""modelB_id""
)
```

It succeeds with MySQL, the following SQL query being generated:

```
UPDATE ""modelAs"" INNER JOIN ""modelBs"" ON ""modelBs"".""id"" = ""modelAs"".""modelB_id"" SET modelAs.column = modelBs.column
```

Thanks to `AbstractMysqlAdapter` redefining `join_for_update` from the `DatabaseStatements` module.

For this to work with Postgresql, we would need to generate:

```
UPDATE ""modelAs"" SET modelAs.column = modelBs.column FROM ModelAs, ModelBs WHERE modelBs"".""id"" = ""modelAs"".""modelB_id""
```
",https://api.github.com/repos/rails/rails/issues/13496/timeline,,such,1303925,MDQ6VXNlcjEzMDM5MjU=,https://avatars.githubusercontent.com/u/1303925?v=4,,https://api.github.com/users/such,https://github.com/such,https://api.github.com/users/such/followers,https://api.github.com/users/such/following{/other_user},https://api.github.com/users/such/gists{/gist_id},https://api.github.com/users/such/starred{/owner}{/repo},https://api.github.com/users/such/subscriptions,https://api.github.com/users/such/orgs,https://api.github.com/users/such/repos,https://api.github.com/users/such/events{/privacy},https://api.github.com/users/such/received_events,User,False,https://api.github.com/repos/rails/rails/issues/13496/reactions,2,2,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
607,https://api.github.com/repos/rails/rails/issues/12940,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/12940/labels{/name},https://api.github.com/repos/rails/rails/issues/12940/comments,https://api.github.com/repos/rails/rails/issues/12940/events,https://github.com/rails/rails/issues/12940,22851567,MDU6SXNzdWUyMjg1MTU2Nw==,12940,Railties::Engine.isolate_namespace leaks host application's url_helpers into action_methods for that engine's controllers.,"[{'id': 4782967, 'node_id': 'MDU6TGFiZWw0NzgyOTY3', 'url': 'https://api.github.com/repos/rails/rails/labels/engines', 'name': 'engines', 'color': 'e102d8', 'default': False, 'description': None}, {'id': 126910270, 'node_id': 'MDU6TGFiZWwxMjY5MTAyNzA=', 'url': 'https://api.github.com/repos/rails/rails/labels/With%20reproduction%20steps', 'name': 'With reproduction steps', 'color': '009800', 'default': False, 'description': None}]",open,False,,[],,8,2013-11-18T17:04:55Z,2021-07-13T07:34:40Z,,NONE,,"I am not 100% sure if this is a bug or a feature I am misunderstanding but it seems inconsistent, especially since routes that are defined _after_ mounting the Engine does not add those helpers to the action_methods.

Steps to reproduce:
- Create a new mountable Engine: `rails plugin new Example --mountable`
- Remove the `isolate_namespace` call from the `lib/example/engine.rb` file. This is done so we can test the order in which events occur - it will be called later on.
- Navigate to the `test/dummy` directory
- `rails c`

``` ruby
class Example::SomeController < Example::ApplicationController; end
# this controller has no methods yet - action_methods should be an empty set
Example::SomeController.action_methods
=> #<Set: {}> 

Example::Engine.isolate_namespace Example
=> #<Proc:0x00000001574508@...gems/railties-4.0.1/lib/rails/engine.rb:394 (lambda)> 

class Example::SomeController2 < Example::ApplicationController; end
=> nil 

# I expect this controller's action_methods to also be an empty Set, but...
Example::SomeController2.action_methods
=> #<Set: {""rails_info_properties_path"", ""rails_info_properties_url"", ""rails_info_routes_path"", ""rails_info_routes_url"",  ...
```

Is this a bug? If so, does anyone have a handle on how I can help fixing it?
",https://api.github.com/repos/rails/rails/issues/12940/timeline,,ReneB,207323,MDQ6VXNlcjIwNzMyMw==,https://avatars.githubusercontent.com/u/207323?v=4,,https://api.github.com/users/ReneB,https://github.com/ReneB,https://api.github.com/users/ReneB/followers,https://api.github.com/users/ReneB/following{/other_user},https://api.github.com/users/ReneB/gists{/gist_id},https://api.github.com/users/ReneB/starred{/owner}{/repo},https://api.github.com/users/ReneB/subscriptions,https://api.github.com/users/ReneB/orgs,https://api.github.com/users/ReneB/repos,https://api.github.com/users/ReneB/events{/privacy},https://api.github.com/users/ReneB/received_events,User,False,https://api.github.com/repos/rails/rails/issues/12940/reactions,0,0,0,0,0,0,0,0,0,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
608,https://api.github.com/repos/rails/rails/issues/8679,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/8679/labels{/name},https://api.github.com/repos/rails/rails/issues/8679/comments,https://api.github.com/repos/rails/rails/issues/8679/events,https://github.com/rails/rails/issues/8679,9606495,MDU6SXNzdWU5NjA2NDk1,8679,assert_recognizes don't aware of constraints,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'pixeltrix', 'id': 6321, 'node_id': 'MDQ6VXNlcjYzMjE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pixeltrix', 'html_url': 'https://github.com/pixeltrix', 'followers_url': 'https://api.github.com/users/pixeltrix/followers', 'following_url': 'https://api.github.com/users/pixeltrix/following{/other_user}', 'gists_url': 'https://api.github.com/users/pixeltrix/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pixeltrix/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pixeltrix/subscriptions', 'organizations_url': 'https://api.github.com/users/pixeltrix/orgs', 'repos_url': 'https://api.github.com/users/pixeltrix/repos', 'events_url': 'https://api.github.com/users/pixeltrix/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pixeltrix/received_events', 'type': 'User', 'site_admin': False}]",,12,2013-01-01T22:48:56Z,2020-11-22T01:03:01Z,,NONE,,"I notice in the method recognized_request_for used in assert_recognizes that it's not aware of the constraints of a route, so will always trigger an RoutingError exception.

https://github.com/rails/rails/blob/v3.2.9.rc3/actionpack/lib/action_dispatch/testing/assertions/routing.rb#L210
",https://api.github.com/repos/rails/rails/issues/8679/timeline,,mmontossi,1836781,MDQ6VXNlcjE4MzY3ODE=,https://avatars.githubusercontent.com/u/1836781?v=4,,https://api.github.com/users/mmontossi,https://github.com/mmontossi,https://api.github.com/users/mmontossi/followers,https://api.github.com/users/mmontossi/following{/other_user},https://api.github.com/users/mmontossi/gists{/gist_id},https://api.github.com/users/mmontossi/starred{/owner}{/repo},https://api.github.com/users/mmontossi/subscriptions,https://api.github.com/users/mmontossi/orgs,https://api.github.com/users/mmontossi/repos,https://api.github.com/users/mmontossi/events{/privacy},https://api.github.com/users/mmontossi/received_events,User,False,https://api.github.com/repos/rails/rails/issues/8679/reactions,0,0,0,0,0,0,0,0,0,,,,,,,pixeltrix,6321.0,MDQ6VXNlcjYzMjE=,https://avatars.githubusercontent.com/u/6321?v=4,,https://api.github.com/users/pixeltrix,https://github.com/pixeltrix,https://api.github.com/users/pixeltrix/followers,https://api.github.com/users/pixeltrix/following{/other_user},https://api.github.com/users/pixeltrix/gists{/gist_id},https://api.github.com/users/pixeltrix/starred{/owner}{/repo},https://api.github.com/users/pixeltrix/subscriptions,https://api.github.com/users/pixeltrix/orgs,https://api.github.com/users/pixeltrix/repos,https://api.github.com/users/pixeltrix/events{/privacy},https://api.github.com/users/pixeltrix/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
609,https://api.github.com/repos/rails/rails/issues/7218,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/7218/labels{/name},https://api.github.com/repos/rails/rails/issues/7218/comments,https://api.github.com/repos/rails/rails/issues/7218/events,https://github.com/rails/rails/issues/7218,5954214,MDU6SXNzdWU1OTU0MjE0,7218,image_tag in ActionView::TestCase not respecting asset pipeline,"[{'id': 3666649, 'node_id': 'MDU6TGFiZWwzNjY2NjQ5', 'url': 'https://api.github.com/repos/rails/rails/labels/actionview', 'name': 'actionview', 'color': 'd7e102', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'guilleiguaran', 'id': 160941, 'node_id': 'MDQ6VXNlcjE2MDk0MQ==', 'avatar_url': 'https://avatars.githubusercontent.com/u/160941?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/guilleiguaran', 'html_url': 'https://github.com/guilleiguaran', 'followers_url': 'https://api.github.com/users/guilleiguaran/followers', 'following_url': 'https://api.github.com/users/guilleiguaran/following{/other_user}', 'gists_url': 'https://api.github.com/users/guilleiguaran/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/guilleiguaran/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/guilleiguaran/subscriptions', 'organizations_url': 'https://api.github.com/users/guilleiguaran/orgs', 'repos_url': 'https://api.github.com/users/guilleiguaran/repos', 'events_url': 'https://api.github.com/users/guilleiguaran/events{/privacy}', 'received_events_url': 'https://api.github.com/users/guilleiguaran/received_events', 'type': 'User', 'site_admin': False}]",,20,2012-07-31T21:30:49Z,2019-01-19T04:39:32Z,,NONE,,"While testing helper methods that use image_tag

``` ruby
module SomeHelper
  def using_image_tag
    image_tag(""rails.png"")
  end
end
```

the helper returns the image path starting with '/images' even though the asset pipeline is turned on

``` ruby
require 'test_helper'

class SomeHelperTest < ActionView::TestCase
  test ""should resolve src to /assets/rails.png"" do
    assert_equal ""<img alt=\""Rails\"" src=\""/assets/rails.png\"" />"", using_image_tag
  end
end
```

giving

``` output
  1) Failure:
test_should_resolve_src_to_/assets/rails.png(SomeHelperTest) [/Users/manda/projects/demo/test/unit/helpers/some_helper_test.rb:5]:
<""<img alt=\""Rails\"" src=\""/assets/rails.png\"" />""> expected but was
<""<img alt=\""Rails\"" src=\""/images/rails.png\"" />"">.
```

a repo with new app showing the problem, just run rake test: git://github.com/Mandaryn/action_view_test_case_problem_with_image_tag_and_asset_pipeline.git
",https://api.github.com/repos/rails/rails/issues/7218/timeline,,Mandaryn,71698,MDQ6VXNlcjcxNjk4,https://avatars.githubusercontent.com/u/71698?v=4,,https://api.github.com/users/Mandaryn,https://github.com/Mandaryn,https://api.github.com/users/Mandaryn/followers,https://api.github.com/users/Mandaryn/following{/other_user},https://api.github.com/users/Mandaryn/gists{/gist_id},https://api.github.com/users/Mandaryn/starred{/owner}{/repo},https://api.github.com/users/Mandaryn/subscriptions,https://api.github.com/users/Mandaryn/orgs,https://api.github.com/users/Mandaryn/repos,https://api.github.com/users/Mandaryn/events{/privacy},https://api.github.com/users/Mandaryn/received_events,User,False,https://api.github.com/repos/rails/rails/issues/7218/reactions,0,0,0,0,0,0,0,0,0,,,,,,,guilleiguaran,160941.0,MDQ6VXNlcjE2MDk0MQ==,https://avatars.githubusercontent.com/u/160941?v=4,,https://api.github.com/users/guilleiguaran,https://github.com/guilleiguaran,https://api.github.com/users/guilleiguaran/followers,https://api.github.com/users/guilleiguaran/following{/other_user},https://api.github.com/users/guilleiguaran/gists{/gist_id},https://api.github.com/users/guilleiguaran/starred{/owner}{/repo},https://api.github.com/users/guilleiguaran/subscriptions,https://api.github.com/users/guilleiguaran/orgs,https://api.github.com/users/guilleiguaran/repos,https://api.github.com/users/guilleiguaran/events{/privacy},https://api.github.com/users/guilleiguaran/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
610,https://api.github.com/repos/rails/rails/issues/7047,https://api.github.com/repos/rails/rails,https://api.github.com/repos/rails/rails/issues/7047/labels{/name},https://api.github.com/repos/rails/rails/issues/7047/comments,https://api.github.com/repos/rails/rails/issues/7047/events,https://github.com/rails/rails/issues/7047,5610876,MDU6SXNzdWU1NjEwODc2,7047,Optional parameters in routes,"[{'id': 107189, 'node_id': 'MDU6TGFiZWwxMDcxODk=', 'url': 'https://api.github.com/repos/rails/rails/labels/actionpack', 'name': 'actionpack', 'color': 'FFF700', 'default': False, 'description': None}, {'id': 149514554, 'node_id': 'MDU6TGFiZWwxNDk1MTQ1NTQ=', 'url': 'https://api.github.com/repos/rails/rails/labels/pinned', 'name': 'pinned', 'color': 'f7c6c7', 'default': False, 'description': None}]",open,False,,"[{'login': 'pixeltrix', 'id': 6321, 'node_id': 'MDQ6VXNlcjYzMjE=', 'avatar_url': 'https://avatars.githubusercontent.com/u/6321?v=4', 'gravatar_id': '', 'url': 'https://api.github.com/users/pixeltrix', 'html_url': 'https://github.com/pixeltrix', 'followers_url': 'https://api.github.com/users/pixeltrix/followers', 'following_url': 'https://api.github.com/users/pixeltrix/following{/other_user}', 'gists_url': 'https://api.github.com/users/pixeltrix/gists{/gist_id}', 'starred_url': 'https://api.github.com/users/pixeltrix/starred{/owner}{/repo}', 'subscriptions_url': 'https://api.github.com/users/pixeltrix/subscriptions', 'organizations_url': 'https://api.github.com/users/pixeltrix/orgs', 'repos_url': 'https://api.github.com/users/pixeltrix/repos', 'events_url': 'https://api.github.com/users/pixeltrix/events{/privacy}', 'received_events_url': 'https://api.github.com/users/pixeltrix/received_events', 'type': 'User', 'site_admin': False}]",,25,2012-07-13T18:30:14Z,2020-11-03T03:46:56Z,,NONE,,"Hello, sorry for Bad English.
Today i updated from 3.1.3 to 3.2.6 and found that my routes doesn't work correct. I'm absolutely sure that it's because of update. But i'm not sure that this is documented feature.

my route looks like

```
  resources :searches do 
    match '(/:catalog_number(/:manufacturer(/:replacements)))' => ""searches#index"", :on => :collection, :as => :search, :via => :get
  end
```

and I call it so

```
<%= link_to 'Посмотреть аналоги всех найденных номеров', search_searches_path(params[:catalog_number], nil, ""1""), :remote => true, :class => 'ajax-search' %>
```

to get url's that's i need
.../searches/catalog_number/manufacturer/1
.../searches/catalog_number/manufacturer/
.../searches/catalog_number?replacements=1

for now it's always looks like if i add nil to :manufacturer parameter
.../searches/catalog_number

I can write more cleanly examples but especially copy-paste to reproduce error.
",https://api.github.com/repos/rails/rails/issues/7047/timeline,,woto,146704,MDQ6VXNlcjE0NjcwNA==,https://avatars.githubusercontent.com/u/146704?v=4,,https://api.github.com/users/woto,https://github.com/woto,https://api.github.com/users/woto/followers,https://api.github.com/users/woto/following{/other_user},https://api.github.com/users/woto/gists{/gist_id},https://api.github.com/users/woto/starred{/owner}{/repo},https://api.github.com/users/woto/subscriptions,https://api.github.com/users/woto/orgs,https://api.github.com/users/woto/repos,https://api.github.com/users/woto/events{/privacy},https://api.github.com/users/woto/received_events,User,False,https://api.github.com/repos/rails/rails/issues/7047/reactions,2,1,0,0,0,0,0,1,0,,,,,,,pixeltrix,6321.0,MDQ6VXNlcjYzMjE=,https://avatars.githubusercontent.com/u/6321?v=4,,https://api.github.com/users/pixeltrix,https://github.com/pixeltrix,https://api.github.com/users/pixeltrix/followers,https://api.github.com/users/pixeltrix/following{/other_user},https://api.github.com/users/pixeltrix/gists{/gist_id},https://api.github.com/users/pixeltrix/starred{/owner}{/repo},https://api.github.com/users/pixeltrix/subscriptions,https://api.github.com/users/pixeltrix/orgs,https://api.github.com/users/pixeltrix/repos,https://api.github.com/users/pixeltrix/events{/privacy},https://api.github.com/users/pixeltrix/received_events,User,False,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
